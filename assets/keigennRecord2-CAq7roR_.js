import{_ as e,e as t}from"./shared-common-k1r32zW0.js";import{h as a,g as n,a as o,e as s,b as i,c as l,n as r,t as c,f as d,d as u,y as m,z as f,F as p,G as v,r as g,cO as b,x as h,dx as y,w as k,dz as w,b2 as $,D as j,s as N,u as R,J as I,o as C,j as _,l as D,p as x,v as E,i as A,bW as T,b9 as S,ch as M,cj as z}from"./vendor-vue-i6lpFrx4.js";import{ac as F,U as K,ad as L,r as H,s as O,ae as G,u as P,w as W,a9 as J,f as B,$ as Z,Z as U,l as V,af as q,ag as X,t as Y,ah as Q,ai as ee,aj as te,ak as ae,A as ne,al as oe,a7 as se}from"./shared-core-BeQvS1-r.js";import{t as ie,J as le,aC as re,b as ce,a as de,E as ue,aD as me,w as fe,aE as pe,g as ve,aF as ge,aG as be,n as he}from"./vendor-element-plus-DxZgBX3C.js";import{N as ye,a as ke,l as we}from"./cactbot-CO6bDcKj.js";const $e={class:"amount"},je={class:"row-info"},Ne=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:g,shield:b,source:h,type:y}=t.row,k=Math.round(v*+b/100),w=Math.round(g/v*100),$=t.row.reduction,j=(a&&Math.round((a+k)/(1-$))||0).toLocaleString(),N=a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString(),R=y,I=F(t.row);return(e,t)=>{const a=ie,v=le;return o(),n(v,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:s(()=>[i("span",$e,[i("span",{class:f(d(R))},[i("span",{class:f({lethal:d(I)})},c(d(N)),3)],2)])]),default:s(()=>[i("ul",je,[i("li",null,c(e.$t("keigennRecord.source"))+": "+c(d(h)),1),i("li",null,c(e.$t("keigennRecord.playerShield"))+": "+c(d(b))+"%",1),i("li",null,c(e.$t("keigennRecord.playerHp"))+": "+c(d(w))+"%",1),d($)<1&&"dot"!==d(y)?(o(),l(p,{key:0},[u(a),i("li",null,c(e.$t("keigennRecord.reductionRate"))+": "+c((100*d($)).toFixed(3))+"% ",1),i("li",null,[m(c(e.$t("keigennRecord.originalDamage"))+": ",1),i("span",{class:f(d(R))},c(d(j)),3)])],64)):r("",!0)])]),_:1})}}}),[["__scopeId","data-v-8b91d23d"]]),Re={class:"subtitle"},Ie={class:"skill-grid"},Ce=["title"],_e=["src"],De={class:"skill-text"},xe={class:"subtitle"},Ee={class:"skill-grid"},Ae=["title"],Te=["src"],Se={key:2,class:"no-data"},Me=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=v(()=>b(t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[])),m=v(()=>b(t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>K.enumSortMethod(e.ownerJob,t.ownerJob))??[]));function f(e){const t=K.jobEnumToJob(e);return K.jobToFullName(t).simple2||""}const h={modifiers:[{name:"preventOverflow",options:{padding:24}}]};return(e,t)=>{const v=ce,b=ie,y=le;return o(),n(y,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover",transition:"none","show-after":0,"hide-after":0,"popper-options":h},{reference:s(()=>[u(v,{class:"view-icon"},{default:s(()=>[u(d(re))]),_:1})]),default:s(()=>[d(a).length>0?(o(),l(p,{key:0},[i("div",Re,c(e.$t("keigennRecord.coolingDown")),1),i("div",Ie,[(o(!0),l(p,null,g(d(a),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${f(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,_e),t[0]||(t[0]=i("div",{class:"skill-overlay"},null,-1)),i("span",De,c(e.recastLeft),1)],8,Ce)]))),128))])],64)):r("",!0),d(m).length>0?(o(),l(p,{key:1},[d(a).length>0?(o(),n(b,{key:0})):r("",!0),i("div",xe,c(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),i("div",Ee,[(o(!0),l(p,null,g(d(m),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${f(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Te)],8,Ae)]))),128))])],64)):r("",!0),0===d(a).length&&0===d(m).length?(o(),l("div",Se,c(e.$t("keigennRecord.noData")),1)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-d1f9fd8f"]]),ze={key:0},Fe={key:1,class:"status-container"},Ke=["title","data-duration","data-sourcePov"],Le=["src","alt"],He={class:"flags"},Oe=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=L(),n=a.userOptions,s=a.icon4k;return(e,a)=>"dot"===t.row.type?(o(),l("div",ze,c(e.$t("keigennRecord.noSupport")),1)):(o(),l("div",Fe,[(o(!0),l(p,null,g(t.row.keigenns,(e,r)=>(o(),l("span",{key:r},[i("span",{class:"status",title:`${d(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[i("img",{class:f(`statusIcon ${d(G)(e,t.row.type)}`),src:d(O)(`/i/${e.fullIcon}${d(s)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>d(H)&&d(H)(...e))},null,42,Le)],8,Ke)]))),128)),i("span",He,c("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),Ge={class:"target"},Pe=["src","alt"],We={key:1,class:"alt-text"},Je={key:3,class:"has-duplicate"},Be=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=L(),n=h(!1);function s(e){n.value=!0;e.target.style.display="none"}const i=v(()=>!n.value&&"icon"===(a.userOptions.targetType??"icon")),u=F(t.row);return(e,n)=>{return o(),l("div",Ge,[d(i)?(o(),l("img",{key:0,class:f(`${d(a).isBrowser?"browser":"act"} jobIcon cj${d(a).userOptions.iconType} ${d(u)?"lethal-icon":""}`),src:(m=t.row.jobIcon,p=d(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${p}/${m.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:s},null,42,Pe)):(o(),l("span",We,c(t.row.job),1)),d(u)?(o(),l("span",{key:2,class:f(`lethal-emoji ${d(a).isBrowser?"browser":"act"} emoji-cj${d(a).userOptions.iconType}`)}," ðŸ’€ ",2)):r("",!0),t.row.hasDuplicate?(o(),l("span",Je,c(d(a).formatterName(t.row.target)),1)):r("",!0)]);var m,p}}}),[["__scopeId","data-v-60253f4d"]]),Ze=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=P(),a=e,m=L(),f=m.userOptions,p=y("contextMenu"),g=h(""),b=h("");k(()=>a.rows,e=>{0===e.length&&(g.value="",b.value="")},{immediate:!0});const R=h(!1),I=h(0),C=h(0),_=h(null);w(p,()=>{R.value=!1});const D=t("keigennRecord.cancelFilter"),x=v(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey])));return[{label:D,value:""},...e.map(e=>({label:e,value:e}))]}),E=v(()=>{const e=Array.from(new Map(a.rows.map(e=>[e.target,e])).values());return[{label:D,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,t)=>K.enumSortMethod(e.job,t.job))});function A(){if(_.value){const e=_.value[a.actionKey];g.value===e?g.value="":g.value=e,R.value=!1}}function T(){if(_.value){const e=_.value.target;b.value===e?b.value="":b.value=e,R.value=!1}}const S=v(()=>a.rows.filter(e=>{const t=!g.value||g.value===D||e[a.actionKey]===g.value,n=!b.value||b.value===D||e.target===b.value;return t&&n})),M=new Map;function z(e){const t=Math.round(100*e)/100;if(M.has(t))return M.get(t);const a=[88,88,88],n=[50,250,200],o=Math.min(1,t/.5),s=Math.min(9,Math.floor(10*o))/9,i=Math.pow(s,.8),l=a[0]+(n[0]-a[0])*i,r=a[1]+(n[1]-a[1])*i,c=a[2]+(n[2]-a[2])*i,d=`rgba(${Math.round(l)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return M.set(t,d),d}const F=$([{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>j("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>j("div",{class:"header-filter"},[j(de,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>g.value=e===D?"":e},()=>x.value.map(e=>j(ue,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>j("span",e[a.actionKey]??"")},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>j("div",{class:"header-filter"},[j(de,{size:"small",modelValue:b.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{b.value=e===D?"":e}},()=>E.value.map(e=>j(ue,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>j(Be,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>j(Ne,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>j("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>j("span",{class:"col-reduction-number",style:{color:z(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>j(Oe,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>j("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},j("div",{style:{position:"absolute",right:"0px",zIndex:5}},j(Me,{row:e})))}]);let H=null;const O=v(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:n,job:o,keigenns:s,time:i,type:l,effect:r,currentHp:c,maxHp:d,shield:u,reduction:m}=e,p="damage done"===r?"":`,${t(`keigennRecord.${r}`)}`,v=`${i} ${o} ${a} ${n.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*m).toFixed(0)}%):${0===s.length&&""===p?t("keigennRecord.none"):s.map(e=>f.statusCN?e.name:e.effect).join(",")+p} ${t("keigennRecord.hp")}}:${c}(${Math.round(c/d*100)}%)+${t("keigennRecord.shield")}:${Math.round(d*+u/100)}(${u}%)`;W(v).then(()=>{H?.close(),H=ve.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>ve.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{const a=t;_.value=e,I.value=a.clientX,C.value=a.clientY,R.value=!0}}));return(a,f)=>{const v=fe,h=pe,y=me;return o(),n(y,{style:{height:"100%",width:"100%"}},{default:s(({height:n,width:f})=>[u(h,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:d(F),data:S.value,width:f,height:n,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":O.value},{empty:s(()=>[u(v,{description:d(m).isBrowser?a.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["columns","data","width","height","row-event-handlers"]),d(R)?(o(),l("div",{key:0,ref_key:"contextMenu",ref:p,class:"context-menu",style:N({top:`${d(C)}px`,left:`${d(I)}px`})},[i("ul",null,[i("li",{onClick:A},c(d(g)===(d(_)?.[e.actionKey]??"")?d(t)("keigennRecord.filter.action_cancel",{actionName:d(_)?.[e.actionKey]??d(t)("keigennRecord.this_skill")}):d(t)("keigennRecord.filter.action_only",{actionName:d(_)?.[e.actionKey]??d(t)("keigennRecord.this_skill")})),1),i("li",{onClick:T},c(d(b)===d(_)?.target?d(t)("keigennRecord.filter.target_cancel",{jobName:d(_)?.job??d(t)("keigennRecord.this_job")}):d(t)("keigennRecord.filter.target_only",{jobName:d(_)?.job??d(t)("keigennRecord.this_job")})),1)])],4)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-c1ed0eeb"]]),Ue={class:"header-select"},Ve={style:{height:"100%"}},qe={key:0,class:"testLog"},Xe=e(a({__name:"keigennRecord2",setup(e){const a=B();P();const c=L(),y=c.userOptions;c.checkIsBrowser();const k=h(y.minimize),w=v(()=>y.actionCN?"actionCN":"action"),j=h(!1),F=R("keigenn-record-2-pov-id",""),H=R("keigenn-record-2-party-list",[]),O=R("keigenn-record-2-job-map",{}),G=R("keigenn-record-2-party-event-party",[]);let W=0;const ie=h(0),le=$([{zoneName:"",duration:"00:00",table:I([]),key:"init",timestamp:-1}]),re={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ye.ability(),statusEffectExplicit:ye.statusEffectExplicit(),gainsEffect:ye.gainsEffect(),losesEffect:ye.losesEffect(),changeZone:ye.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:ye.addedCombatant(),removingCombatant:ye.removingCombatant(),networkDoT:ye.networkDoT()},ce=h(0),me=R("souma-keigenn-record-2-zone-name",""),fe=R("souma-keigenn-record-2-rsv-data",{}),pe={},ve={friendly:{},enemy:{}},$e=J.filter(e=>1===e.line||2===e.line);let je={};const Ne=Z("keigenn-record-2");function Re(){j.value=!0,ce.value=0,je={},ie.value=0,le.value.length=0,le.value.push({zoneName:"",duration:"00:00",table:I([]),key:"init",timestamp:-1}),M(le)}function Ie(){j.value=!1,Se()}function Ce(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!re.gainsEffect.exec(e))return;const t=a[we.GainsEffect.fields.effectId],n=a[we.GainsEffect.fields.effect],o=a[we.GainsEffect.fields.target],s=a[we.GainsEffect.fields.targetId],i=Number.parseInt(a[we.GainsEffect.fields.count],16);let l=ee(t);if(!l){const e=s.startsWith("1")&&te.get(Number.parseInt(t,16).toString())||s.startsWith("4")&&ae.get(Number.parseInt(t,16).toString());if(!e)return;const a=ne(e.icon),n=i>1?oe(a,i):a;l={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[we.GainsEffect.fields.duration],c=a[we.GainsEffect.fields.source],d=a[we.GainsEffect.fields.sourceId],u=new Date(a[we.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:l.name,type:l.type,count:i,effect:n,effectId:t,source:c,sourceId:d,target:o,targetId:s,expirationTimestamp:u,performance:l.performance,fullIcon:l.fullIcon,isPov:F.value===d};s.startsWith("1")&&l.isFriendly?(void 0===ve.friendly[s]&&(ve.friendly[s]={}),ve.friendly[s][t]=m):s.startsWith("4")&&!l.isFriendly&&(void 0===ve.enemy[o]&&(ve.enemy[o]={}),ve.enemy[o][t]=m)}break;case"30":{const e=a[we.LosesEffect.fields.target],t=a[we.LosesEffect.fields.targetId],n=a[we.LosesEffect.fields.effectId];t.startsWith("1")?ve.friendly[t]&&Reflect.deleteProperty(ve.friendly[t],n):ve.enemy[e]&&Reflect.deleteProperty(ve.enemy[e],n)}break;case"21":case"22":{if(0===ce.value)return;const e=a[we.Ability.fields.sourceId]??"???",t=a[we.Ability.fields.id]??"???",n=new Date(a[we.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),o=O.value[e]?.level??999;$e.find(e=>q(e.id,o)===a)&&(je[e]||(je[e]={}),je[e][a]=n)}const o=X(a);if(o.isAttack&&o.amount>=0){const s=a[we.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!s.startsWith("1"))return;if(s!==F.value&&!H.value.includes(s)&&!G.value.find(e=>e.id===s))return;const i=a[we.Ability.fields.ability],l=i.match(/^_rsv_(?<id>\d+)_/);let r=i;if(l){const e=Number(l.groups?.id);r=fe.value[e]??i.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(r=r.replace(/unknown_.*/,"æ”»å‡»"),!1===y.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(r))return;const c=Y(Number.parseInt(t,16)),d=c&&""!==c?c:r,u=Number(a[we.Ability.fields.targetCurrentHp]),m=Number(a[we.Ability.fields.targetMaxHp]),f=a[we.Ability.fields.source]??"???",p=a[we.Ability.fields.target]??"???",{effect:v,type:g}=Q(o.flags),b=Me(0===ce.value?0:n-ce.value),{job:h,hasDuplicate:k}=_e(s),w=h,$=K.jobToFullName(K.jobEnumToJob(w)).simple2,j=K.jobEnumToIcon(w),N=Object.values(ve.friendly[s]??[]).concat(Object.values(ve.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),R=pe[s]??"0",I=o.amount;let C=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of N)"absorbed"!==a.type&&(t*=a.performance[g]??1);C=1-t*e}Ee({key:(W++).toString(),time:b,id:t,action:r,actionCN:d,source:f,target:p,targetId:s,job:$,jobIcon:j,jobEnum:w,hasDuplicate:k,amount:I,keigenns:N,currentHp:u,maxHp:m,effect:v,type:g,shield:R,povId:F.value,reduction:C,keySkills:Te(n)}),le.value[0].duration=Me(new Date(a[we.Ability.fields.timestamp]).getTime()-ce.value)}}break;case"34":{const t=re.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(pe[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[we.InCombat.fields.inACTCombat],t="1"===a[we.InCombat.fields.inGameCombat],n=new Date(a[we.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[we.InCombat.fields.timestamp];if(ce.value>0)return;return 0!==le.value[0].table.length&&(le.value.unshift({zoneName:"",duration:"00:00",table:I([]),key:e,timestamp:n}),M(le)),ce.value=n,le.value[0].zoneName=me.value,le.value[0].timestamp=n,le.value[0].key=e,void(ie.value=0)}if(!e&&!t)return void Ae(n)}break;case"01":{const e=parseInt(a[we.ChangeZone.fields.id],16);if(me.value=a[we.ChangeZone.fields.name],U[e]?.name){const t=V(U[e]?.name);t&&"Unknown"!==t&&(me.value=t)}Ae(new Date(a[we.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=re.partyList.exec(e);t&&(H.value=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":F.value=a[we.ChangedPlayer.fields.id];break;case"03":if("00"!==a[we.AddedCombatant.fields.job]){const e=a[we.AddedCombatant.fields.job],t=a[we.AddedCombatant.fields.name],n=new Date(a[we.AddedCombatant.fields.timestamp]).getTime(),o=parseInt(a[we.AddedCombatant.fields.level],16);O.value[a[we.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:o}}break;case"04":Reflect.deleteProperty(O.value,a[we.RemovedCombatant.fields.id]);break;case"262":{const t=re.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[we.RSVData.fields.value];e&&n&&(fe.value[Number(e)]=n)}}break;case"37":if(!y.parseDoT)return;{const e=a[we.NetworkDoT.fields.which],t=a[we.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==F.value&&!H.value.includes(t)&&!G.value.find(e=>e.id===t))return;const n=a[we.NetworkDoT.fields.name],o=a[we.NetworkDoT.fields.damage],s=Number.parseInt(o,16),i=new Date(a[we.Ability.fields.timestamp]??"???").getTime(),l=Number(a[we.NetworkDoT.fields.currentHp]),r=Number(a[we.NetworkDoT.fields.maxHp]),c=Me(0===ce.value?0:i-ce.value),{job:d,hasDuplicate:u}=_e(t),m=d,f=K.jobToFullName(K.jobEnumToJob(m)).simple2,p=K.jobEnumToIcon(m);Ee({key:(W++).toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:n,targetId:t,job:f,jobIcon:p,jobEnum:m,hasDuplicate:u,amount:s,keigenns:[],currentHp:l,maxHp:r,effect:"damage done",type:"dot",shield:pe[t]??"0",povId:F.value,reduction:0,keySkills:[]})}}}function _e(e){const t=O.value[e],a=G.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,o=n===t?Object.entries(O.value).some(([t,a])=>t!==e&&a.job===n?.job&&H.value.includes(t)):G.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:o}}let De=[],xe=null;function Ee(e){De.push(b(e)),null===xe&&(xe=requestAnimationFrame(()=>{le.value[0].table.unshift(...De.reverse()),De=[],xe=null}))}function Ae(e){0!==ce.value&&(le.value[0].duration=Me(e-ce.value),le.value[0]=b(le.value[0]),ce.value=0,ve.friendly={},ve.enemy={},je={},Se())}function Te(e){const t=[],a=new Set;G.value.forEach(e=>a.add(e.id)),H.value.forEach(e=>a.add(e)),F.value&&a.add(F.value);const n=[];for(const s of a){const e=G.value.find(e=>e.id===s);if(e){n.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const t=O.value[s];t&&n.push({id:s,job:t.job,name:t.name??"Unknown",level:t.level})}const o=new Map;n.forEach(e=>{o.set(e.job,(o.get(e.job)||0)+1)});for(const s of n){const a=s.level||999,n=(o.get(s.job)||0)>1;for(const o of $e)if(o.job.includes(s.job)&&o.minLevel<=a){const i=q(o.id,a),l=q(o.recast1000ms,a),r=je[s.id]?.[i]??0;let c=!0,d=0;if(r>0){const t=e-r,a=1e3*l;t<a&&(c=!1,d=Math.ceil((a-t)/1e3))}t.push({id:i,name:Y(i)||"Unknown",icon:se(i),recast1000ms:l,recastLeft:d,ready:c,ownerId:s.id,ownerName:s.name,ownerJob:s.job,hasDuplicate:n})}}return t}async function Se(){if(j.value)return;const e=le.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?z(e.table):[];return{...z(e),table:t}});await Ne.replaceAll(e)}function Me(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function ze(){k.value=!k.value}function Fe(){le.value.unshift({zoneName:"",duration:"00:00",table:I([]),key:"test",timestamp:Date.now()}),M(le),ie.value=0}function Ke(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return C(()=>{const e=_({storageKey:"keigenn-record-2-theme"}),t=D(e);!1===e.value&&t();for(const a in O.value){const e=O.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(O.value,a)}!async function(){ie.value=0;try{const e=await Ne.getAll();e.length&&(le.value.length=0,le.value.push(...e.filter(e=>e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp).reverse()),0===le.value.length&&le.value.push({zoneName:"",duration:"00:00",table:S([]),key:"init",timestamp:-1}))}catch(e){throw le.value.length=0,e}}(),ke("LogLine",e=>{Ce(e.rawLine)}),ke("PartyChanged",e=>{G.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),ke("ChangePrimaryPlayer",e=>{F.value=Number(e.charID).toString(16).toUpperCase()}),ke("CombatData",e=>{if(!(ce.value>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(me.value=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==le.value[0].table.length&&(le.value.unshift({zoneName:"",duration:"00:00",table:I([]),key:String(n),timestamp:n}),M(le)),le.value[0].zoneName=me.value,ce.value=n,le.value[0].timestamp=n,le.value[0].key=String(n),ie.value=0}})}),(e,v)=>{const b=ue,h=de,$=he,j=Ze,R=t;return o(),l(p,null,[i("div",{class:"wrapper",style:N({"--scale":d(y).scale,"--opacity":d(y).opacity}),onContextmenu:v[1]||(v[1]=T(()=>{},["prevent"]))},[i("header",null,[i("div",Ue,[x(u(h,{modelValue:d(ie),"onUpdate:modelValue":v[0]||(v[0]=e=>A(ie)?ie.value=e:null),size:"small",class:f(["combat-select",d(c).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:s(()=>[(o(!0),l(p,null,g(d(le).length,e=>(o(),n(b,{key:`${d(le)[e-1].key}-${d(le)[e-1].duration}-${d(le)[e-1].zoneName}`,value:e-1,label:`${d(le)[e-1].zoneName}${""===d(le)[e-1].zoneName?"":` - [${d(le)[e-1].duration}] ${Ke(d(le)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[E,!d(k)]])]),d(c).isBrowser?r("",!0):(o(),n($,{key:0,class:f(["minimize",d(k)?"in-minimize":"not-minimize"]),icon:d(k)?d(ge):d(be),circle:"",style:N({opacity:d(k)?.5:1}),onClick:ze},null,8,["class","icon","style"]))]),x(i("main",Ve,[u(j,{rows:d(le)[d(ie)].table,"action-key":d(w)},null,8,["rows","action-key"])],512),[[E,!d(k)]])],36),d(c).isBrowser||d(a)?(o(),l("div",qe,[d(a)?(o(),n($,{key:0,onClick:Fe},{default:s(()=>[...v[2]||(v[2]=[m(" æµ‹è¯• ",-1)])]),_:1})):r("",!0),u(R,{"m-1":"",onBeforeHandle:Re,onAfterHandle:Ie,onHandleLine:Ce})])):r("",!0)],64)}}}),[["__scopeId","data-v-4d7f76ce"]]);export{Xe as default};
