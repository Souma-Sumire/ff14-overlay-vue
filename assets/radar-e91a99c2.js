import{_ as e}from"./ActWrapper-5069e8c1.js";import{V as a}from"./element-plus-901ad096.js";import{k as l,r as t,aY as o,c as n,J as s,L as i,x as r,y as u,o as v,q as c,z as h,l as f,B as d,u as g,E as m,U as p,H as w,G as P}from"./vue-49c48d91.js";import{u as y}from"./useZone-1661c0fc.js";import{N as T,a as b,r as x,c as M}from"./cactbot-49e370f3.js";import{_ as k}from"./_plugin-vue_export-helper-6a8c15be.js";import"./useDev-861d544b.js";import"./useDemo-86956ef5.js";import"./vendor-979eac9e.js";import"./res-zoneInfo-5ea06bcd.js";const I={class:"radar-container"},S={class:"radar-wrapper"},j={key:0},_=["disabled"],C=["disabled"],N={class:"target-header"},L={key:0,class:"target-name"},D={class:"radar-canvas-container"},W=["width","height"],Y=k(l({__name:"radar",setup(l){const k=t(""),Y=t([]),X=t(0),z=t(""),E=t([]),H={echo:T.echo({line:"find\\s*(?<target>.+)"})},R=o("canvas");let O=null;const $=t(window.devicePixelRatio||1),A=t(Math.min(window.innerWidth,window.innerHeight)-80),B=n(()=>A.value/2-20),{zoneType:q}=y(),F=t("single"),G="#0f0",J="#060",Q="#0f0",U="#ff0",V="#f00",Z="#fff",K="#fff",ee=18,ae=3,le=2,te=6,oe=n(()=>A.value/2),ne=n(()=>A.value/2);function se(e,a,l){const t=e.PosX-a.PosX,o=e.PosY-a.PosY;let n=oe.value+t/l,s=ne.value+o/l;const i=Math.hypot(n-oe.value,s-ne.value);if(i>B.value){const e=B.value/i;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}return{px:n,py:s}}async function ie(){const e=await M({call:"getCombatants"});E.value=e.combatants??[]}async function re(){await ie(),"Pvp"!==q.value&&k.value&&z.value?("*"===k.value?function(){if(F.value="all",!O)throw new Error("canvas context is null");const e=E.value.find(e=>e.Name===z.value),a=E.value.filter(e=>e.Name!==z.value&&e.ID);if(!e)return;O.clearRect(0,0,A.value,A.value),O.strokeStyle=G,O.lineWidth=1,O.beginPath(),O.arc(oe.value,ne.value,B.value,0,2*Math.PI),O.stroke(),O.strokeStyle=J,O.beginPath(),O.moveTo(oe.value-B.value,ne.value),O.lineTo(oe.value+B.value,ne.value),O.moveTo(oe.value,ne.value-B.value),O.lineTo(oe.value,ne.value+B.value),O.stroke();const l=new Map;for(const i of a)l.set(i.ID.toString(),se(i,e,1));for(const i of a){const e=l.get(i.ID.toString());e&&(O.strokeStyle=V,O.lineWidth=le,O.beginPath(),O.moveTo(oe.value,ne.value),O.lineTo(e.px,e.py),O.stroke())}for(const i of a){const e=l.get(i.ID.toString());e&&(O.fillStyle=U,O.beginPath(),O.arc(e.px,e.py,ae,0,2*Math.PI),O.fill())}for(const i of a){const e=l.get(i.ID.toString());if(!e)continue;const a=i.Name??"",t=O.measureText(a).width;O.shadowColor="black",O.shadowBlur=1,O.shadowOffsetX=1,O.shadowOffsetY=1,O.fillStyle=K,O.font="8px Arial",O.fillText(a,e.px-t/2,e.py-ae-3),O.shadowColor="transparent",O.shadowBlur=0,O.shadowOffsetX=0,O.shadowOffsetY=0}const t=-(e.Heading??0)+Math.PI;O.save(),O.translate(oe.value,ne.value),O.rotate(t),O.fillStyle=Q;const o=ee,n=o/3,s=-.2*o;O.beginPath(),O.moveTo(0,-o/2+s),O.lineTo(-n,o/2+s),O.lineTo(n,o/2+s),O.closePath(),O.fill(),O.restore()}():function(){if(F.value="single",!O)throw new Error("canvas context is null");const e=Y.value[X.value],a=E.value.find(e=>e.Name===z.value);if(!e)return void O.clearRect(0,0,A.value,A.value);if(!a)return;O.clearRect(0,0,A.value,A.value),O.strokeStyle=G,O.lineWidth=1,O.beginPath(),O.arc(oe.value,ne.value,B.value,0,2*Math.PI),O.stroke(),O.strokeStyle=J,O.beginPath(),O.moveTo(oe.value-B.value,ne.value),O.lineTo(oe.value+B.value,ne.value),O.moveTo(oe.value,ne.value-B.value),O.lineTo(oe.value,ne.value+B.value),O.stroke();const l=e.PosX-a.PosX,t=e.PosY-a.PosY,o=Math.sqrt(l*l+t*t);let n=oe.value+l/.5,s=ne.value+t/.5;const i=Math.hypot(n-oe.value,s-ne.value);if(i>B.value){const e=B.value/i;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}O.strokeStyle=V,O.lineWidth=le,O.beginPath(),O.moveTo(oe.value,ne.value),O.lineTo(n,s),O.stroke(),O.fillStyle=U,O.beginPath(),O.arc(n,s,ae,0,2*Math.PI),O.fill();const r=-(a.Heading??0)+Math.PI;O.save(),O.translate(oe.value,ne.value),O.rotate(r),O.fillStyle=Q;const u=ee,v=u/3,c=-.2*u;O.beginPath(),O.moveTo(0,-u/2+c),O.lineTo(-v,u/2+c),O.lineTo(v,u/2+c),O.closePath(),O.fill(),O.restore();const h=Math.atan2(s-ne.value,n-oe.value);O.fillStyle=V,O.beginPath(),O.moveTo(n,s),O.lineTo(n-te*Math.cos(h-Math.PI/6),s-te*Math.sin(h-Math.PI/6)),O.lineTo(n-te*Math.cos(h+Math.PI/6),s-te*Math.sin(h+Math.PI/6)),O.closePath(),O.fill(),O.fillStyle=Z,O.font="10px Arial",O.fillText(`${o.toFixed(1)}y`,n+5,s-5)}(),setTimeout(re,100)):k.value=""}const ue=e=>{if("00"===e.line[0]){const a=H.echo.exec(e.rawLine);a?.groups?.target&&(k.value=a.groups.target,ie().then(()=>{!function(){if(!k.value)return Y.value=[],void(X.value=0);const e=E.value.filter(e=>e.Name&&e.Name.includes(k.value));Y.value=e,X.value=0}(),re()}))}},ve=e=>{z.value=e.charName};function ce(){A.value=Math.min(window.innerWidth,window.innerHeight)-80,$.value=window.devicePixelRatio||1,O&&(O.setTransform(1,0,0,1,0,0),O.scale($.value,$.value))}return s(()=>{O=R.value?.getContext("2d")??null,O&&O.scale($.value,$.value),b("LogLine",ue),b("ChangePrimaryPlayer",ve),window.addEventListener("resize",ce)}),i(()=>{x("LogLine",ue),x("ChangePrimaryPlayer",ve),window.removeEventListener("resize",ce)}),(l,t)=>{const o=a,n=e;return v(),r(n,null,{readme:u(()=>[P(o,{class:"el-alert-info",type:"info",closable:!1,"show-icon":"",title:"宏命令：/e find 目标名称",description:"名称允许部分匹配。若输入*可查看所有目标"})]),default:u(()=>[c("div",I,[h(c("div",S,[g(Y).length>1?(v(),f("div",j,[c("button",{class:"nav-arrow left-arrow",disabled:g(Y).length<=1,"aria-label":"上一目标",onClick:t[0]||(t[0]=e=>X.value=(g(X)-1+g(Y).length)%g(Y).length)}," ← ",8,_),c("span",null," （"+m(g(X)+1)+" / "+m(g(Y).length)+"） ",1),c("button",{class:"nav-arrow right-arrow",disabled:g(Y).length<=1,"aria-label":"下一目标",onClick:t[1]||(t[1]=e=>X.value=(g(X)+1)%g(Y).length)}," → ",8,C)])):d("",!0),c("div",N,["single"===g(F)?(v(),f("span",L,m(g(Y)[g(X)]?.Name??`【未找到${g(k)}】`),1)):d("",!0),c("button",{class:"cancel-btn",onClick:t[2]||(t[2]=e=>{k.value="",Y.value=[]})}," 取消 ")]),c("div",D,[c("canvas",{ref_key:"canvas",ref:R,class:"radar-canvas",width:g(A)*g($),height:g(A)*g($),style:p({width:`${g(A)}px`,height:`${g(A)}px`})},null,12,W)])],512),[[w,g(k)]])])]),_:1})}}}),[["__scopeId","data-v-98e25c02"]]);export{Y as default};
