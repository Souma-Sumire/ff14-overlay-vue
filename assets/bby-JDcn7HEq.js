import{_ as e,c as a}from"./shared-common-Cq8ZvUJj.js";import{d as s,c as l,a as n,z as t,b as o,t as r,F as i,n as u,x as d,G as c,o as m,j as v,l as y,B as p,h as b,g as h,f as g,y as f,r as k,bW as w,cj as j}from"./vendor-vue-lrbWrvEl.js";import{h as x,a1 as C,f as I,U as N,as as $}from"./shared-core-BmMhxsPZ.js";import{a as T,r as A,c as L}from"./cactbot-CmNinDrW.js";import{_ as B}from"./vendor-element-plus-BMs_zvkp.js";const E={class:"user-header"},D={class:"user-info"},M={class:"user-name"},F={key:0,class:"status-badge pre",title:"尚未查询"},S={key:0,class:"status-badge",title:"正在使用 BBY"},z={key:1,class:"status-badge unused",title:"未使用 BBY"},_={class:"user-meta"},q={key:0,class:"user-job"},P={key:1,class:"user-world"},W=e(s({__name:"UserCard",props:{user:{},blurMode:{type:Boolean}},setup:e=>(a,s)=>(n(),l("div",{class:t(["user-card",{"not-responded":e.user.isQueried&&!e.user.hasResponded,"pre-query":!e.user.isQueried,"blur-mode":e.blurMode}])},[o("div",E,[o("div",D,[o("div",M,[o("span",{class:t({"blurred-text":e.blurMode})},r(e.user.name),3),e.user.isQueried?(n(),l(i,{key:1},[e.user.hasResponded?(n(),l("span",S,"BBY")):(n(),l("span",z,"未使用"))],64)):(n(),l("span",F,"尚未查询"))]),o("div",_,[e.user.job?(n(),l("span",q,r(e.user.job),1)):u("",!0),e.user.world?(n(),l("span",P,r(e.user.world),1)):u("",!0)])])])],2))}),[["__scopeId","data-v-f30da14a"]]),U={class:"advwm-container"},Y={class:"header"},O={class:"query-methods"},J={class:"query-item"},Q=["disabled"],R={class:"users-section"},H={class:"users-header-row"},X={key:0,class:"status-hint"},Z={class:"using-count"},G={class:"last-query-time"},K={class:"users-list"},V={key:0,class:"empty-state"},ee={key:1,class:"debug-section"},ae={style:{"margin-bottom":"16px"}},se={key:2,class:"history-section"},le={class:"history-header"},ne={class:"history-list"},te={class:"snapshot-header"},oe={class:"snapshot-time"},re={key:0,class:"snapshot-query-time"},ie={class:"snapshot-members"},ue={class:"member-name"},de={key:0,class:"member-world"},ce={class:"member-job"},me=e(s({__name:"bby",setup(e){const s=I();x({addWsParam:!0,allowClose:!1});const E=["A","B","C","D","One","Two","Three","Four"],D={floorMarker:/^(?<timestamp>.{14}) WaymarkMarker (?<type>1C):(?<operation>[^:]*):(?<waymark>[^:]*):(?<id>[^:]*):(?<name>[^:]*):(?<x>[^:]*):(?<y>[^:]*):(?<z>[^:]*)(?:$|:)/},M=d([]),F=d([]),S=d(""),z=d(!1),_=d({}),q=d({}),P=d(null),me=c(()=>F.value.filter(e=>e).length),ve=d(!1);function ye(){ve.value=!ve.value}const pe=C("bby"),be=d([]);async function he(){const e=be.value.map(e=>j(e));await pe.replaceAll(e)}async function ge(){be.value=[],await pe.clear()}const fe=d(null),ke=c(()=>F.value.map(e=>{if(!e)return null;const a=M.value.find(a=>a.id===e.id),s=N.jobToFullName(N.jobEnumToJob(e.job)).cn||"",l=!!P.value;return a?{...a,hasResponded:!0,isQueried:l}:{id:e.id,name:e.name,job:s,world:e.world,flags:0,waymarkIndex:-1,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!1,isInitiator:!1,hasResponded:!1,isQueried:l}}).filter(e=>null!==e));function we(e){const a=e-Math.floor(e);return Math.round(100*(a-.01))}const je=(...e)=>z.value&&void 0,xe=(...e)=>z.value&&void 0,Ce=(...e)=>z.value&&void 0;function Ie(e){return e.endsWith("1")}const Ne=e=>{for(const a of e.detail.logs){const e=D.floorMarker.exec(a);if(e?.groups){const{operation:a,waymark:s,id:l,x:n,y:t,z:o}=e.groups,r=Number.parseInt(s||"0");if(xe(`[LogEvent] 捕获标点变更: ${a} waymarkIdx:${r} waymarkName:${E[r]} (x:${n}, y:${t}, z:${o})`),!Number.isNaN(r)&&r>=0&&r<=7&&("Add"===a||"Change"===a?q.value[r]={x:Number.parseFloat(n||"0"),y:Number.parseFloat(t||"0"),z:Number.parseFloat(o||"0"),active:!0}:"Delete"===a&&q.value[r]&&(q.value[r].active=!1)),!a||"Add"!==a&&"Change"!==a)continue;if(!(s&&l&&n&&t&&o)){Ce("[LogEvent] 标点数据缺失:",{operation:a,waymark:s,id:l,x:n,y:t,z:o});continue}const i=Number.parseFloat(n||"0"),u=Number.parseFloat(t||"0"),d=Number.parseFloat(o||"0");if(Number.isNaN(r)||r<0||r>7)continue;if(Math.abs(i)>1e4||Math.abs(u)>1e4)continue;const c=we(d),m=Ie(n),v=Ie(t);if(m&&v){xe(`[LogEvent] 检测到特征信号 (WaymarkIdx: ${r}, Flags: 0x${c.toString(16)})`);if(!!(8&c)&&0===r){xe("[LogEvent] 忽略匿名查询广播");continue}const e=F.value[r];if(!e){Ce(`[LogEvent] 索引 ${r} 对应的是空槽位`);continue}const a=N.jobToFullName(N.jobEnumToJob(e.job)).cn||"";xe(`[LogEvent] 解析成员: ${e.name} (${a})`);$e({id:e.id,name:e.name||"未知",job:a,flags:c,waymarkIndex:r,isAnonymous:!!(1&c),isIdHidden:!!(2&c),isWaymarkEnabled:!!(4&c),isInitiator:!!(8&c),world:e.world})}else je(`[LogEvent] 坐标特征不符 (X:${n}, Y:${t})`)}}};function $e(e){if(e.id===S.value&&e.isInitiator)return;const a=M.value.findIndex(a=>a.id===e.id);a>=0?(xe(`[User] 更新用户信息: ${e.name}`),M.value[a]=e):e.isInitiator&&e.id!==S.value?(xe(`[User] 检测到来自 ${e.name} 的被动查询，清空当前列表`),M.value.length>0&&(xe("[User] 存档当前列表到历史记录"),be.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:P.value,members:[...M.value]}),he()),P.value=(new Date).toLocaleTimeString(),M.value=[e]):(xe(`[User] 新增响应者: ${e.name}`),M.value.push(e)),xe("当前响应者列表:",M.value)}const Te=e=>{const a=[];if(e.party&&Array.isArray(e.party))for(const n of e.party)n.id&&n.inParty&&a.push({id:n.id.toUpperCase(),hexId:Number.parseInt(n.id,16),name:n.name||"",job:n.job||0,level:n.level||0,world:$[n.worldId]||""});const s=[...a].sort((e,a)=>e.hexId-a.hexId),l=Array.from({length:8}).fill(null);for(let n=0;n<8;n++){const e=(n+3)%8;e<s.length&&(l[n]=s[e]||null)}F.value=l,xe(l)};function Ae(){const e="A",a=q.value[0]||{x:0,y:0,z:0},s=0===a.x&&0===a.y&&0===a.z;let l=Math.round(10*a.x)/10;l+=l>=0?.01:-.01;let n=Math.round(10*a.y)/10;n+=n>=0?.01:-.01;let t=Math.floor(a.z+.01);t+=.16;const o={Local:!1,[e]:{X:l,Y:t,Z:n,Active:!0}};xe(`[Ask] 计算坐标(索引 0): X=${l}, Y=${t}, Z=${n}`),function(e){xe("调用鲶鱼精邮差:",JSON.stringify(e)),L({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({...e,LocalOnly:!1})})}(o),M.value.length>0&&(be.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:P.value,members:[...M.value]}),he()),P.value=(new Date).toLocaleTimeString(),M.value=[],B.closeAll(),B.info({message:"正在获取信号...",position:"top-left",customClass:"bby-mini-notify",showClose:!1}),fe.value&&clearTimeout(fe.value),fe.value=setTimeout(()=>{s&&(xe("清理所有标点"),L({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({LocalOnly:!1,A:{},B:{},C:{},D:{},One:{},Two:{},Three:{},Four:{}})})),fe.value=null,B.closeAll(),M.value.length>0?B.success({message:`发现 ${M.value.length} 名 BBY 成员`,position:"top-left",customClass:"bby-mini-notify",showClose:!1}):B.warning({message:"未发现 BBY 成员",position:"top-left",customClass:"bby-mini-notify",showClose:!1})},1e3)}const Le=e=>{const a=e.charID.toString(16).toUpperCase();S.value!==a&&(S.value=a,xe(`我的 ID 已更新: ${a}`))};function Be(){const e=["地平关","迷雾湿地","拉诺西亚","紫水栈桥","幻影群岛"],a=["鸣神小吉","猫三水","苏摩","艾露恩","莉莉丝","阿尔法","欧米茄","泰坦","利维亚桑","希瓦"],s=[];for(let n=0;n<8;n++)s.push({id:(1e3+n).toString(16).toUpperCase(),hexId:1e3+n,name:a[n%a.length],job:1+n%38,level:100,world:e[n%e.length]});F.value=s;const l=[];s.forEach((e,a)=>{Math.random()>.4&&l.push({id:e.id,name:e.name,job:N.jobToFullName(N.jobEnumToJob(e.job)).cn||"冒险者",flags:0,waymarkIndex:a,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!0,isInitiator:!1,world:e.world})}),P.value=(new Date).toLocaleTimeString(),M.value=l}return m(()=>{!async function(){try{const e=await pe.getAll();e&&e.length>0&&(be.value=e.sort((e,a)=>a.key.localeCompare(e.key)))}catch(e){}}(),T("onLogEvent",Ne),T("PartyChanged",Te),T("ChangePrimaryPlayer",Le);const e=v({storageKey:"bby-theme"}),a=y(e);!1===e.value&&a()}),p(()=>{A("onLogEvent",Ne),A("PartyChanged",Te),A("ChangePrimaryPlayer",Le)}),(e,d)=>{const c=a;return n(),b(c,null,{default:h(()=>[o("div",U,[o("div",Y,[d[2]||(d[2]=o("h2",null,"小队里谁在使用BBY",-1)),o("div",O,[o("div",J,[o("button",{class:t(["ask-btn",{searching:!!fe.value}]),disabled:!!fe.value,onClick:Ae},r(fe.value?"正在查询...":"主动查询"),11,Q),g(s)?(n(),l("button",{key:0,class:"ask-btn fake-test-btn",onClick:Be}," 生成测试数据 ")):u("",!0),d[0]||(d[0]=o("span",{class:"item-desc"},[f(" 通过场地标点通信，需要使用鲶鱼精邮差（你和对方都要）并处于可以标点的同一地图中"),o("br")],-1))]),d[1]||(d[1]=o("div",{class:"query-item passive"},[o("span",{class:"passive-title"},"被动接收"),o("span",{class:"item-desc"},"当队伍内其他玩家发起查询时，此处也会同步显示结果。")],-1))])]),o("div",R,[o("div",H,[o("h3",null,"当前小队 ("+r(ke.value.length)+")",1),P.value?(n(),l(i,{key:1},[o("span",Z,"发现使用中: "+r(M.value.length),1),o("span",G,"最后查询: "+r(P.value),1)],64)):(n(),l("span",X,"尚未进行查询"))]),o("div",K,[(n(!0),l(i,null,k(ke.value,e=>(n(),b(W,{key:e.id,user:e,"blur-mode":ve.value,onContextmenu:w(ye,["prevent"])},null,8,["user","blur-mode"]))),128))])]),0===ke.value.length?(n(),l("div",V,[...d[3]||(d[3]=[o("p",null,"等待小队数据...",-1)])])):u("",!0),z.value?(n(),l("div",ee,[d[11]||(d[11]=o("h3",null,"调试信息",-1)),o("div",ae,[d[4]||(d[4]=o("strong",null,"用户总数:",-1)),f(" "+r(M.value.length),1),d[5]||(d[5]=o("br",null,null,-1)),d[6]||(d[6]=o("strong",null,"应答者数:",-1)),f(" "+r(ke.value.length),1),d[7]||(d[7]=o("br",null,null,-1)),d[8]||(d[8]=o("strong",null,"小队成员数:",-1)),f(" "+r(me.value),1)]),o("details",null,[d[9]||(d[9]=o("summary",null,"用户列表详情",-1)),o("pre",null,r(M.value),1)]),o("details",null,[d[10]||(d[10]=o("summary",null,"标点解析详情",-1)),o("pre",null,r(_.value),1)])])):u("",!0),be.value.length>0?(n(),l("div",se,[o("div",le,[o("h3",null,"历史记录 ("+r(be.value.length)+")",1),o("button",{class:"clear-history-btn",onClick:ge}," 清空历史 ")]),o("div",ne,[(n(!0),l(i,null,k(be.value,(e,a)=>(n(),l("div",{key:a,class:"history-item"},[o("div",te,[o("div",oe," 存档时间: "+r(e.timestamp),1),e.queryTime?(n(),l("div",re," 查询时间: "+r(e.queryTime),1)):u("",!0)]),o("div",ie,[(n(!0),l(i,null,k(e.members,e=>(n(),l("div",{key:e.id,class:"history-member-tag"},[o("span",ue,r(e.name),1),e.world?(n(),l("span",de,r(e.world),1)):u("",!0),o("span",ce,r(e.job),1)]))),128))])]))),128))])])):u("",!0)])]),_:1})}}}),[["__scopeId","data-v-e3ac403a"]]);export{me as default};
