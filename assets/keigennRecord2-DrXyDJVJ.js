import{_ as e,e as t}from"./shared-common-BKuSzJeA.js";import{h as a,g as n,a as o,e as s,b as i,c as l,n as r,t as c,f as u,d,y as m,z as p,F as f,G as v,r as g,cO as y,x as b,dx as h,w as k,dz as w,b2 as j,D as $,s as I,u as R,cj as N,b9 as C,o as D,j as _,l as E,p as x,v as A,i as M,bW as S,J as T,ch as L}from"./vendor-vue-i6lpFrx4.js";import{ac as z,U as F,ad as K,r as P,s as H,ae as O,u as G,w as W,a9 as B,f as J,$ as Z,af as U,a7 as V,t as q,Z as X,l as Y,ag as Q,ah as ee,ai as te,aj as ae,ak as ne,A as oe,al as se}from"./shared-core-wtLCg29f.js";import{t as ie,J as le,aC as re,b as ce,a as ue,E as de,aD as me,w as pe,aE as fe,g as ve,aF as ge,aG as ye,n as be}from"./vendor-element-plus-DxZgBX3C.js";import{N as he,a as ke,l as we}from"./cactbot-DtpbXwrG.js";const je={class:"amount"},$e={class:"row-info"},Ie=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:g,shield:y,source:b,type:h}=t.row,k=Math.round(v*+y/100),w=Math.round(g/v*100),j=t.row.reduction,$=(a&&Math.round((a+k)/(1-j))||0).toLocaleString(),I=a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString(),R=h,N=z(t.row);return(e,t)=>{const a=ie,v=le;return o(),n(v,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:s(()=>[i("span",je,[i("span",{class:p(u(R))},[i("span",{class:p({lethal:u(N)})},c(u(I)),3)],2)])]),default:s(()=>[i("ul",$e,[i("li",null,c(e.$t("keigennRecord.source"))+": "+c(u(b)),1),i("li",null,c(e.$t("keigennRecord.playerShield"))+": "+c(u(y))+"%",1),i("li",null,c(e.$t("keigennRecord.playerHp"))+": "+c(u(w))+"%",1),u(j)<1&&"dot"!==u(h)?(o(),l(f,{key:0},[d(a),i("li",null,c(e.$t("keigennRecord.reductionRate"))+": "+c((100*u(j)).toFixed(3))+"% ",1),i("li",null,[m(c(e.$t("keigennRecord.originalDamage"))+": ",1),i("span",{class:p(u(R))},c(u($)),3)])],64)):r("",!0)])]),_:1})}}}),[["__scopeId","data-v-8b91d23d"]]),Re={class:"subtitle"},Ne={class:"skill-grid"},Ce=["title"],De=["src"],_e={class:"skill-text"},Ee={class:"subtitle"},xe={class:"skill-grid"},Ae=["title"],Me=["src"],Se={key:2,class:"no-data"},Te=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=v(()=>y(t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[])),m=v(()=>y(t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>F.enumSortMethod(e.ownerJob,t.ownerJob))??[]));function p(e){const t=F.jobEnumToJob(e);return F.jobToFullName(t).simple2||""}const b={modifiers:[{name:"preventOverflow",options:{padding:24}}]};return(e,t)=>{const v=ce,y=ie,h=le;return o(),n(h,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover",transition:"none","show-after":0,"hide-after":0,"popper-options":b},{reference:s(()=>[d(v,{class:"view-icon"},{default:s(()=>[d(u(re))]),_:1})]),default:s(()=>[u(a).length>0?(o(),l(f,{key:0},[i("div",Re,c(e.$t("keigennRecord.coolingDown")),1),i("div",Ne,[(o(!0),l(f,null,g(u(a),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,De),t[0]||(t[0]=i("div",{class:"skill-overlay"},null,-1)),i("span",_e,c(e.recastLeft),1)],8,Ce)]))),128))])],64)):r("",!0),u(m).length>0?(o(),l(f,{key:1},[u(a).length>0?(o(),n(y,{key:0})):r("",!0),i("div",Ee,c(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),i("div",xe,[(o(!0),l(f,null,g(u(m),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Me)],8,Ae)]))),128))])],64)):r("",!0),0===u(a).length&&0===u(m).length?(o(),l("div",Se,c(e.$t("keigennRecord.noData")),1)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-d1f9fd8f"]]),Le={key:0},ze={key:1,class:"status-container"},Fe=["title","data-duration","data-sourcePov"],Ke=["src","alt"],Pe={class:"flags"},He=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=K(),n=a.userOptions,s=a.icon4k;return(e,a)=>"dot"===t.row.type?(o(),l("div",Le,c(e.$t("keigennRecord.noSupport")),1)):(o(),l("div",ze,[(o(!0),l(f,null,g(t.row.keigenns,(e,r)=>(o(),l("span",{key:r},[i("span",{class:"status",title:`${u(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[i("img",{class:p(`statusIcon ${u(O)(e,t.row.type)}`),src:u(H)(`/i/${e.fullIcon}${u(s)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>u(P)&&u(P)(...e))},null,42,Ke)],8,Fe)]))),128)),i("span",Pe,c("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),Oe={class:"target"},Ge=["src","alt"],We={key:1,class:"alt-text"},Be={key:3,class:"has-duplicate"},Je=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=K(),n=b(!1);function s(e){n.value=!0;e.target.style.display="none"}const i=v(()=>!n.value&&"icon"===(a.userOptions.targetType??"icon")),d=z(t.row);return(e,n)=>{return o(),l("div",Oe,[u(i)?(o(),l("img",{key:0,class:p(`${u(a).isBrowser?"browser":"act"} jobIcon cj${u(a).userOptions.iconType} ${u(d)?"lethal-icon":""}`),src:(m=t.row.jobIcon,f=u(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${f}/${m.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:s},null,42,Ge)):(o(),l("span",We,c(t.row.job),1)),u(d)?(o(),l("span",{key:2,class:p(`lethal-emoji ${u(a).isBrowser?"browser":"act"} emoji-cj${u(a).userOptions.iconType}`)}," ðŸ’€ ",2)):r("",!0),t.row.hasDuplicate?(o(),l("span",Be,c(u(a).formatterName(t.row.target)),1)):r("",!0)]);var m,f}}}),[["__scopeId","data-v-60253f4d"]]),Ze=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=G(),a=e,m=K(),p=m.userOptions,f=h("contextMenu"),g=b(""),y=b("");k(()=>a.rows,e=>{0===e.length&&(g.value="",y.value="")},{immediate:!0});const R=b(!1),N=b(0),C=b(0),D=b(null);w(f,()=>{R.value=!1});const _=t("keigennRecord.cancelFilter"),E=v(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey])));return[{label:_,value:""},...e.map(e=>({label:e,value:e}))]}),x=v(()=>{const e=Array.from(new Map(a.rows.map(e=>[e.target,e])).values());return[{label:_,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,t)=>F.enumSortMethod(e.job,t.job))});function A(){if(D.value){const e=D.value[a.actionKey];g.value===e?g.value="":g.value=e,R.value=!1}}function M(){if(D.value){const e=D.value.target;y.value===e?y.value="":y.value=e,R.value=!1}}const S=v(()=>a.rows.filter(e=>{const t=!g.value||g.value===_||e[a.actionKey]===g.value,n=!y.value||y.value===_||e.target===y.value;return t&&n})),T=new Map;function L(e){const t=Math.round(100*e)/100;if(T.has(t))return T.get(t);const a=[88,88,88],n=[50,250,200],o=Math.min(1,t/.5),s=Math.min(9,Math.floor(10*o))/9,i=Math.pow(s,.8),l=a[0]+(n[0]-a[0])*i,r=a[1]+(n[1]-a[1])*i,c=a[2]+(n[2]-a[2])*i,u=`rgba(${Math.round(l)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return T.set(t,u),u}const z=j([{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>$("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(ue,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>g.value=e===_?"":e},()=>E.value.map(e=>$(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$("span",e[a.actionKey]??"")},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(ue,{size:"small",modelValue:y.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{y.value=e===_?"":e}},()=>x.value.map(e=>$(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$(Je,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>$(Ie,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>$("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>$("span",{class:"col-reduction-number",style:{color:L(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>$(He,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>$("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},$("div",{style:{position:"absolute",right:"0px",zIndex:5}},$(Te,{row:e})))}]);let P=null;const H=v(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:n,job:o,keigenns:s,time:i,type:l,effect:r,currentHp:c,maxHp:u,shield:d,reduction:m}=e,f="damage done"===r?"":`,${t(`keigennRecord.${r}`)}`,v=`${i} ${o} ${a} ${n.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*m).toFixed(0)}%):${0===s.length&&""===f?t("keigennRecord.none"):s.map(e=>p.statusCN?e.name:e.effect).join(",")+f} ${t("keigennRecord.hp")}}:${c}(${Math.round(c/u*100)}%)+${t("keigennRecord.shield")}:${Math.round(u*+d/100)}(${d}%)`;W(v).then(()=>{P?.close(),P=ve.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>ve.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{const a=t;D.value=e,N.value=a.clientX,C.value=a.clientY,R.value=!0}}));return(a,p)=>{const v=pe,b=fe,h=me;return o(),n(h,{style:{height:"100%",width:"100%"}},{default:s(({height:n,width:p})=>[d(b,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:u(z),data:S.value,width:p,height:n,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":H.value},{empty:s(()=>[d(v,{description:u(m).isBrowser?a.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["columns","data","width","height","row-event-handlers"]),u(R)?(o(),l("div",{key:0,ref_key:"contextMenu",ref:f,class:"context-menu",style:I({top:`${u(C)}px`,left:`${u(N)}px`})},[i("ul",null,[i("li",{onClick:A},c(u(g)===(u(D)?.[e.actionKey]??"")?u(t)("keigennRecord.filter.action_cancel",{actionName:u(D)?.[e.actionKey]??u(t)("keigennRecord.this_skill")}):u(t)("keigennRecord.filter.action_only",{actionName:u(D)?.[e.actionKey]??u(t)("keigennRecord.this_skill")})),1),i("li",{onClick:M},c(u(y)===u(D)?.target?u(t)("keigennRecord.filter.target_cancel",{jobName:u(D)?.job??u(t)("keigennRecord.this_job")}):u(t)("keigennRecord.filter.target_only",{jobName:u(D)?.job??u(t)("keigennRecord.this_job")})),1)])],4)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-c1ed0eeb"]]),Ue={class:"header-select"},Ve={style:{height:"100%"}},qe={key:0,class:"testLog"},Xe=e(a({__name:"keigennRecord2",setup(e){const a=J();G();const c=K(),h=c.userOptions;c.checkIsBrowser();const w=b(h.minimize),$=v(()=>h.actionCN?"actionCN":"action"),z=b(!1),P=R("keigenn-record-2-pov-id",""),H=R("keigenn-record-2-party-list",[]),O=R("keigenn-record-2-job-map",{}),W=R("keigenn-record-2-party-event-party",[]),ie=R("souma-keigenn-record-2-rsv-data",{}),le={povId:N(P.value),partyLogList:N(H.value),entitiesMap:N(O.value),partyEventParty:N(W.value),rsvData:N(ie.value)};function re(e,t){k(t,t=>{le[e]=N(t)},{flush:"sync"})}re("povId",P),re("partyLogList",H),re("entitiesMap",O),re("partyEventParty",W),re("rsvData",ie);let ce=0;const me=b(0),pe=j([{zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}]),fe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:he.ability(),statusEffectExplicit:he.statusEffectExplicit(),gainsEffect:he.gainsEffect(),losesEffect:he.losesEffect(),changeZone:he.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:he.addedCombatant(),removingCombatant:he.removingCombatant(),networkDoT:he.networkDoT()},ve=b(0),je=R("souma-keigenn-record-2-zone-name",""),$e={},Ie={friendly:{},enemy:{}},Re=B.filter(e=>1===e.line||2===e.line);let Ne={};const Ce=Z("keigenn-record-2"),De=new Map;function _e(){z.value=!0,ve.value=0,Ne={},me.value=0,pe.value.length=0,pe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1})}async function Ee(){z.value=!1,null!==Te&&(cancelAnimationFrame(Te),Te=null,Se.length>0&&(pe.value[0].table.unshift(...Se.reverse()),Se=[])),await Pe(),L(pe)}function xe(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!fe.gainsEffect.exec(e))return;const t=a[we.GainsEffect.fields.effectId],n=a[we.GainsEffect.fields.effect],o=a[we.GainsEffect.fields.target],s=a[we.GainsEffect.fields.targetId],i=Number.parseInt(a[we.GainsEffect.fields.count],16);let l=te(t);if(!l){const e=s.startsWith("1")&&ae.get(Number.parseInt(t,16).toString())||s.startsWith("4")&&ne.get(Number.parseInt(t,16).toString());if(!e)return;const a=oe(e.icon),n=i>1?se(a,i):a;l={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[we.GainsEffect.fields.duration],c=a[we.GainsEffect.fields.source],u=a[we.GainsEffect.fields.sourceId],d=new Date(a[we.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:l.name,type:l.type,count:i,effect:n,effectId:t,source:c,sourceId:u,target:o,targetId:s,expirationTimestamp:d,performance:l.performance,fullIcon:l.fullIcon,isPov:le.povId===u};s.startsWith("1")&&l.isFriendly?(void 0===Ie.friendly[s]&&(Ie.friendly[s]={}),Ie.friendly[s][t]=m):s.startsWith("4")&&!l.isFriendly&&(void 0===Ie.enemy[o]&&(Ie.enemy[o]={}),Ie.enemy[o][t]=m)}break;case"30":{const e=a[we.LosesEffect.fields.target],t=a[we.LosesEffect.fields.targetId],n=a[we.LosesEffect.fields.effectId];t.startsWith("1")?Ie.friendly[t]&&Reflect.deleteProperty(Ie.friendly[t],n):Ie.enemy[e]&&Reflect.deleteProperty(Ie.enemy[e],n)}break;case"21":case"22":{if(0===ve.value)return;const e=a[we.Ability.fields.sourceId]??"???",t=a[we.Ability.fields.id]??"???",n=new Date(a[we.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),o=function(e){let t=De.get(e);if(!t){t=new Map;for(const a of Re){if(a.minLevel>e)continue;const n=U(a.id,e);t.set(n,a)}De.set(e,t)}return t}(le.entitiesMap[e]?.level??999);o.get(a)&&(Ne[e]||(Ne[e]={}),Ne[e][a]=n)}const o=Q(a);if(o.isAttack&&o.amount>=0){const s=a[we.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!s.startsWith("1"))return;if(s!==le.povId&&!le.partyLogList.includes(s)&&!le.partyEventParty.find(e=>e.id===s))return;const i=a[we.Ability.fields.ability],l=i.match(/^_rsv_(?<id>\d+)_/);let r=i;if(l){const e=Number(l.groups?.id);r=le.rsvData[e]??i.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(r=r.replace(/unknown_.*/,"æ”»å‡»"),!1===h.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(r))return;const c=q(Number.parseInt(t,16)),u=c&&""!==c?c:r,d=Number(a[we.Ability.fields.targetCurrentHp]),m=Number(a[we.Ability.fields.targetMaxHp]),p=a[we.Ability.fields.source]??"???",f=a[we.Ability.fields.target]??"???",{effect:v,type:g}=ee(o.flags),y=He(0===ve.value?0:n-ve.value),{jobEnum:b,job:k,jobIcon:w,hasDuplicate:j}=Me(s),$=Object.values(Ie.friendly[s]??[]).concat(Object.values(Ie.enemy[p]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),I=$e[s]??"0",R=o.amount;let N=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of $)"absorbed"!==a.type&&(t*=a.performance[g]??1);N=1-t*e}Le({key:(ce++).toString(),time:y,id:t,action:r,actionCN:u,source:p,target:f,targetId:s,job:k,jobIcon:w,jobEnum:b,hasDuplicate:j,amount:R,keigenns:$,currentHp:d,maxHp:m,effect:v,type:g,shield:I,povId:le.povId,reduction:N,keySkills:Ke(n)}),pe.value[0].duration=He(new Date(a[we.Ability.fields.timestamp]).getTime()-ve.value)}}break;case"34":{const t=fe.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&($e[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[we.InCombat.fields.inACTCombat],t="1"===a[we.InCombat.fields.inGameCombat],n=new Date(a[we.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[we.InCombat.fields.timestamp];if(ve.value>0)return;return 0===pe.value[0].table.length&&0===Se.length||(null!==Te&&(cancelAnimationFrame(Te),Te=null),Se.length>0&&(pe.value[0].table.unshift(...Se.reverse()),Se=[]),pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:e,timestamp:n}),L(pe)),ve.value=n,pe.value[0].zoneName=je.value,pe.value[0].timestamp=n,pe.value[0].key=e,void(me.value=0)}if(!e&&!t)return void ze(n)}break;case"01":{const e=parseInt(a[we.ChangeZone.fields.id],16);if(je.value=a[we.ChangeZone.fields.name],X[e]?.name){const t=Y(X[e]?.name);t&&"Unknown"!==t&&(je.value=t)}ze(new Date(a[we.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=fe.partyList.exec(e);t&&(H.value=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":P.value=a[we.ChangedPlayer.fields.id];break;case"03":if("00"!==a[we.AddedCombatant.fields.job]){const e=a[we.AddedCombatant.fields.job],t=a[we.AddedCombatant.fields.name],n=new Date(a[we.AddedCombatant.fields.timestamp]).getTime(),o=parseInt(a[we.AddedCombatant.fields.level],16);O.value[a[we.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:o}}break;case"04":Reflect.deleteProperty(O.value,a[we.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ie.friendly,a[we.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ie.enemy,a[we.RemovedCombatant.fields.id]);break;case"262":{const t=fe.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[we.RSVData.fields.value];e&&n&&(ie.value[Number(e)]=n)}}break;case"37":if(!h.parseDoT)return;{const e=a[we.NetworkDoT.fields.which],t=a[we.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==le.povId&&!le.partyLogList.includes(t)&&!le.partyEventParty.find(e=>e.id===t))return;const n=a[we.NetworkDoT.fields.name],o=a[we.NetworkDoT.fields.damage],s=Number.parseInt(o,16),i=new Date(a[we.Ability.fields.timestamp]??"???").getTime(),l=Number(a[we.NetworkDoT.fields.currentHp]),r=Number(a[we.NetworkDoT.fields.maxHp]),c=He(0===ve.value?0:i-ve.value),{jobEnum:u,job:d,jobIcon:m,hasDuplicate:p}=Me(t);Le({key:(ce++).toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:n,targetId:t,job:d,jobIcon:m,jobEnum:u,hasDuplicate:p,amount:s,keigenns:[],currentHp:l,maxHp:r,effect:"damage done",type:"dot",shield:$e[t]??"0",povId:le.povId,reduction:0,keySkills:[]})}}}const Ae=new Map;function Me(e){const t=Ae.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=O.value[e],a=W.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,o=n===t?Object.entries(O.value).some(([t,a])=>t!==e&&a.job===n?.job&&H.value.includes(t)):W.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:o}}(e),o=a,s={jobEnum:o,job:F.jobToFullName(F.jobEnumToJob(o)).simple2,jobIcon:F.jobEnumToIcon(o),hasDuplicate:n};return Ae.set(e,s),s}let Se=[],Te=null;function Le(e){Se.push(y(e)),null===Te&&(Te=requestAnimationFrame(()=>{pe.value[0].table.unshift(...Se.reverse()),Se=[],Te=null}))}function ze(e){0!==ve.value&&(pe.value[0].duration=He(e-ve.value),pe.value[0]=y(pe.value[0]),ve.value=0,Ie.friendly={},Ie.enemy={},Ne={},Ae.clear(),Pe())}const Fe=v(()=>{const e=new Set;W.value.forEach(t=>e.add(t.id)),H.value.forEach(t=>e.add(t)),P.value&&e.add(P.value);const t=[];for(const n of e){const e=W.value.find(e=>e.id===n);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const a=O.value[n];a&&t.push({id:n,job:a.job,name:a.name??"Unknown",level:a.level})}const a=new Map;return t.forEach(e=>{a.set(e.job,(a.get(e.job)||0)+1)}),t.flatMap(e=>{const t=e.level||999,n=(a.get(e.job)||0)>1;return Re.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const o=U(a.id,t),s=U(a.recast1000ms,t);return{id:o,name:q(o)||"Unknown",icon:V(o),recast1000ms:s,ownerId:e.id,ownerName:e.name,ownerJob:e.job,hasDuplicate:n}})})});function Ke(e){return Fe.value.map(t=>{const a=Ne[t.ownerId]?.[t.id]??0;let n=!0,o=0;if(a>0){const s=e-a,i=1e3*t.recast1000ms;s<i&&(n=!1,o=Math.ceil((i-s)/1e3))}return{...t,recastLeft:o,ready:n}})}async function Pe(){if(z.value)return;const e=pe.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?N(e.table):[];return{...N(e),table:t}});await Ce.replaceAll(e)}function He(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Oe(){w.value=!w.value}function Ge(){pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:"test",timestamp:Date.now()}),L(pe),me.value=0}function We(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return D(()=>{const e=_({storageKey:"keigenn-record-2-theme"}),t=E(e);!1===e.value&&t();for(const a in O.value){const e=O.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(O.value,a)}!async function(){me.value=0;try{const e=await Ce.getAll();if(e.length){pe.value.length=0;const t=e.filter(e=>e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp).reverse().map(e=>({...e,table:T(Array.isArray(e.table)?[...e.table]:[])}));pe.value.push(...t),0===pe.value.length&&pe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}),L(pe)}}catch(e){throw pe.value.length=0,e}}(),ke("LogLine",e=>{xe(e.rawLine)}),ke("PartyChanged",e=>{W.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),ke("ChangePrimaryPlayer",e=>{P.value=Number(e.charID).toString(16).toUpperCase()}),ke("CombatData",e=>{if(!(ve.value>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(je.value=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==pe.value[0].table.length&&(pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:String(n),timestamp:n}),L(pe)),pe.value[0].zoneName=je.value,ve.value=n,pe.value[0].timestamp=n,pe.value[0].key=String(n),me.value=0}})}),(e,v)=>{const y=de,b=ue,k=be,j=Ze,R=t;return o(),l(f,null,[i("div",{class:"wrapper",style:I({"--scale":u(h).scale,"--opacity":u(h).opacity}),onContextmenu:v[1]||(v[1]=S(()=>{},["prevent"]))},[i("header",null,[i("div",Ue,[x(d(b,{modelValue:u(me),"onUpdate:modelValue":v[0]||(v[0]=e=>M(me)?me.value=e:null),size:"small",class:p(["combat-select",u(c).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:s(()=>[(o(!0),l(f,null,g(u(pe).length,e=>(o(),n(y,{key:`${u(pe)[e-1].key}-${u(pe)[e-1].duration}-${u(pe)[e-1].zoneName}`,value:e-1,label:`${u(pe)[e-1].zoneName}${""===u(pe)[e-1].zoneName?"":` - [${u(pe)[e-1].duration}] ${We(u(pe)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[A,!u(w)]])]),u(c).isBrowser?r("",!0):(o(),n(k,{key:0,class:p(["minimize",u(w)?"in-minimize":"not-minimize"]),icon:u(w)?u(ge):u(ye),circle:"",style:I({opacity:u(w)?.5:1}),onClick:Oe},null,8,["class","icon","style"]))]),x(i("main",Ve,[d(j,{rows:u(pe)[u(me)].table,"action-key":u($)},null,8,["rows","action-key"])],512),[[A,!u(w)]])],36),u(c).isBrowser||u(a)?(o(),l("div",qe,[u(a)?(o(),n(k,{key:0,onClick:Ge},{default:s(()=>[...v[2]||(v[2]=[m(" æµ‹è¯• ",-1)])]),_:1})):r("",!0),d(R,{"m-1":"",onBeforeHandle:_e,onAfterHandle:Ee,onHandleLine:xe})])):r("",!0)],64)}}}),[["__scopeId","data-v-79f413c6"]]);export{Xe as default};
