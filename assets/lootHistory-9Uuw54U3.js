import{_ as e,a as l}from"./shared-common-oDeuwpoM.js";import{h as a,G as t,c as s,n,a as i,s as o,z as r,t as u,d as c,b as d,j as v,f as p,x as m,b6 as y,w as f,g,e as h,y as b,F as k,r as w,bW as _,o as S,B as V,bR as x,cM as C,bQ as $}from"./vendor-vue-i6lpFrx4.js";import{H as O,I as B,J as E,K as D,L as R,N as M,O as T,P as z,Q as P,R as U,S as L,T as N,W as j,X as W,Y as A,_ as I,$ as F,a0 as J,a1 as Y,a2 as H,a3 as K,a4 as X,a5 as q,a6 as G}from"./shared-core-CDdSgUpa.js";import{b as Q,a5 as Z,n as ee,a6 as le,a7 as ae,a8 as te,a9 as se,J as ne,aa as ie,ab as oe,d as re,ac as ue,ad as ce,h as de,ae as ve,af as pe,X as me,I as ye,ag as fe,g as ge,f as he,k as be,ah as ke,q as we,ai as _e,C as Se,aj as Ve,ak as xe,al as Ce,am as $e,M as Oe,N as Be,D as Ee,an as De,ao as Re,ap as Me,a as Te,E as ze,L as Pe,aq as Ue,ar as Le,as as Ne,F as je,G as We,l as Ae,at as Ie,au as Fe,av as Je,aw as Ye,ax as He,ay as Ke,U as Xe,S as qe,az as Ge}from"./vendor-element-plus-lMYbWyTR.js";import{u as Qe,s as Ze,i as el,a as ll,b as al,c as tl,d as sl,e as nl,f as il,g as ol,h as rl,j as ul}from"./vendor-echarts-DDdnl7Zy.js";import"./cactbot-C9BOJncy.js";function cl(e){return new Worker("/ff14-overlay-vue/assets/logParser-WvXw0JKp.js",{name:e?.name})}const dl=a({__name:"RoleBadge",props:{role:{},large:{type:Boolean}},setup(e){const l=e,a=t(()=>O(l.role)),c=t(()=>l.role?B(l.role):"");return(l,t)=>e.role?(i(),s("span",{key:0,class:r(["role-badge",{"badge-large":e.large}]),style:o({backgroundColor:a.value})},u(c.value),7)):n("",!0)}}),vl=e(dl,[["__scopeId","data-v-7ea46d60"]]),pl=a({__name:"PlayerDisplay",props:{name:{},role:{},showOnlyRole:{type:Boolean},nameClass:{}},setup:e=>(l,a)=>(i(),s("div",{class:r(["player-display",{"is-large":e.showOnlyRole}])},[c(vl,{role:e.role,large:e.showOnlyRole,class:"role-icon"},null,8,["role","large"]),e.showOnlyRole&&e.role?n("",!0):(i(),s("span",{key:0,class:r(["player-name-text",e.nameClass])},u(e.name),3))],2))}),ml=e(pl,[["__scopeId","data-v-a4b6322e"]]),yl=["title"],fl={class:"mr-content"},gl={key:0,class:"mr-val"},hl=a({__name:"LootPlayerRoll",props:{roll:{},isWinner:{type:Boolean},showOnlyRole:{type:Boolean},getPlayerRole:{type:Function}},setup(e){const l=e,a=t(()=>l.getPlayerRole(l.roll.player)),o=t(()=>`type-${l.roll.type}`),v=t(()=>E(l.roll.type)),p=t(()=>{const e=D(l.roll.type);return`${l.roll.player} ${e} ${l.roll.value??""}`}),m=t(()=>"assign"!==l.roll.type&&"direct"!==l.roll.type),y=t(()=>"assign"===l.roll.type||"direct"===l.roll.type);return(l,t)=>(i(),s("div",{class:r(["mini-roll",[o.value,{"winner-badge":e.isWinner}]]),title:p.value},[c(ml,{name:e.roll.player,role:a.value,"show-only-role":e.showOnlyRole,class:"mr-display"},null,8,["name","role","show-only-role"]),d("div",fl,[d("span",{class:r(["mr-type",[o.value,{"type-full-width":y.value}]])},u(v.value),3),m.value?(i(),s("span",gl,u(null!==e.roll.value?e.roll.value:"-"),1)):n("",!0)])],10,yl))}}),bl=e(hl,[["__scopeId","data-v-15e83138"]]),kl={class:"sort-segmented"},wl=a({__name:"LootSortSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function t(e){a("update:modelValue",e)}return(l,a)=>(i(),s("div",kl,[d("div",{class:r(["segment-item",{"is-active":"part"===e.modelValue}]),onClick:a[0]||(a[0]=e=>t("part"))}," 按装备部位顺序 ",2),d("div",{class:r(["segment-item",{"is-active":"drop"===e.modelValue}]),onClick:a[1]||(a[1]=e=>t("drop"))}," 按零式掉落顺序 ",2)]))}}),_l=e(wl,[["__scopeId","data-v-87e751bc"]]),Sl={class:"chart-container"},Vl={class:"chart-body"},xl=a({__name:"ChartPlayerDistribution",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});Qe([el,ll,al,tl,sl,nl]);const a=e,n=t(()=>{const e=a.playerVisibility,t=new Map;a.players.forEach(e=>t.set(e,0)),a.records.forEach(e=>{const l=a.getActualPlayer?a.getActualPlayer(e.player):e.player;t.has(l)&&t.set(l,(t.get(l)||0)+1)});const s=a.players.map(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;return{name:e,value:t.get(e)||0,role:l?B(l):""}}),n=s.map(e=>e.name),i=s.map(e=>e.value),o=new Map;return a.players.forEach(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;l&&o.set(e,l)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0],a=l.name,t=o.get(a);return`${t?`[${t}] `:""}${a}<br/>获取数量: <b>${l.value}</b>`}},grid:{left:10,right:20,bottom:10,top:"10%",containLabel:!0},xAxis:{type:"category",data:n,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=o.get(e);return M(e,l,a.playerVisibility)},rich:R(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",minInterval:1,splitLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"获取数量",type:"bar",barWidth:"50%",data:i,itemStyle:{color:e=>{const l=e.name,a=o.get(l);return O(a)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",color:l.value?"#f1f5f9":"#1e293b"}}]}});return(e,a)=>(i(),s("div",Sl,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"获取数量统计")],-1)),d("div",Vl,[c(p(Ze),{class:"echarts-instance",option:n.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),Cl=e(xl,[["__scopeId","data-v-80024e6a"]]),$l={class:"chart-container"},Ol={class:"chart-body"},Bl=a({__name:"ChartRollLuck",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});Qe([el,ll,il,al,tl,sl,nl,ol]);const a=e,n=t(()=>{const e=a.playerVisibility,t=new Map;a.players.forEach(e=>t.set(e,[])),a.records.forEach(e=>{e.rolls.forEach(e=>{if(("need"===e.type||"greed"===e.type)&&null!==e.value){const l=a.getActualPlayer?a.getActualPlayer(e.player):e.player;t.has(l)&&t.get(l).push(e.value)}})});const s=a.players.map(e=>{const l=t.get(e)||[],s=l.length,n=l.reduce((e,l)=>e+l,0),i=s>0?n/s:0,o=s>0?Math.max(...l):0,r=s>0?Math.min(...l):0,u=a.getPlayerRole?a.getPlayerRole(e):void 0;return{name:e,value:i,min:r,max:o,count:s,role:u||"",formattedRole:u?B(u):""}}),n=s.map(e=>e.name),i=s.map(e=>e.value),o=new Map,r=new Map;return s.forEach(e=>{o.set(e.name,e.formattedRole),r.set(e.name,e)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0].name,a=r.get(l);if(!a)return"";let t=`${a.formattedRole?`[${a.formattedRole}] `:""}<b>${l}</b><br/>`;return 0===a.count?t+='<span style="color:#999">无数据</span>':(t+=`平均点数: <b>${a.value.toFixed(1)}</b><br/>`,t+=`最高点数: ${a.max}<br/>`,t+=`最低点数: ${a.min}<br/>`,t+=`Roll点次数: ${a.count}`),t}},grid:{left:10,right:20,bottom:10,top:"15%",containLabel:!0},xAxis:{type:"category",data:n,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=r.get(e)?.role;return M(e,l,a.playerVisibility)},rich:R(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",min:0,max:100,name:"平均点数",splitLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"平均Roll点",type:"bar",barWidth:"50%",data:i,itemStyle:{color:e=>{const l=r.get(e.name);return O(l?.role)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",formatter:e=>e.value>0?e.value.toFixed(1):"",color:l.value?"#f1f5f9":"#1e293b"},markLine:{data:[{type:"average",name:"平均"}],symbol:"none",lineStyle:{color:l.value?"rgba(255,255,255,0.4)":"#999",type:"dashed"},label:{position:"start",formatter:"{b}",color:l.value?"#94a3b8":"#64748b",padding:[0,8,0,0]}}}]}});return(e,a)=>(i(),s("div",$l,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"Roll 点运气统计")],-1)),d("div",Ol,[c(p(Ze),{class:"echarts-instance",option:n.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),El=e(Bl,[["__scopeId","data-v-e15ca5e6"]]),Dl={class:"chart-container"},Rl=a({__name:"ChartWeeklyTrend",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});Qe([el,rl,al,tl,ul,nl]);const a=e,n=t(()=>a.syncStartDate?T(new Date(a.syncStartDate)):null);const r=m(400),u=t(()=>{const e=new Map,l=new Map;a.records.forEach(t=>{const{label:s,sortKey:i}=function(e){const l=a.recordWeekCorrections?.[e.key]||0,{label:t}=z(e.timestamp,l),{label:s,index:i}=P(t,n.value);return{label:a.syncStartDate?`第 ${i} 周`:t,fullLabel:s,sortKey:i}}(t);e.set(s,i);const o=a.getActualPlayer?a.getActualPlayer(t.player):t.player;if(!a.players.includes(o))return;l.has(s)||l.set(s,new Map);const r=l.get(s);r.has(o)||r.set(o,{count:0,items:[]});const u=r.get(o);u.count++,u.items.push(t.item)});const t=Array.from(e.entries()).sort((e,l)=>e[1]-l[1]).map(e=>e[0]),s=[...a.players],i=[];t.forEach((e,a)=>{s.forEach((t,s)=>{const n=l.get(e)?.get(t),o=n?n.count:0;i.push({value:[s,a,o],items:n?n.items:[]})})});const o=40*t.length+120,r=Math.max(300,o);return{xData:s,sortedWeeks:t,seriesData:i,height:r}});y(()=>{r.value=u.value.height});const f=t(()=>{const e=a.playerVisibility,{xData:t,sortedWeeks:s,seriesData:n}=u.value,i=new Map;return a.players.forEach(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;l&&i.set(e,B(l))}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{position:"top",formatter:e=>{const l=e.data,a=l.value[2],n=t[l.value[0]],o=s[l.value[1]],r=n?i.get(n):void 0;return`<b>${o}</b><br/>\n                <b>${r?`[${r}]`:""} ${n}</b><br/>\n                获取数量: ${a}<br/>\n                <hr style="margin:4px 0;opacity:0.3"/>\n                ${l.items&&l.items.length>0?l.items.map(e=>`• ${e}`).join("<br/>"):'<span style="color:#94a3b8;font-style:italic">无掉落</span>'}`}},grid:{top:40,bottom:10,left:10,right:10,containLabel:!0},xAxis:{position:"bottom",type:"category",data:t,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;return M(e,l,a.playerVisibility)},rich:R(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"}},yAxis:{type:"category",data:s,inverse:!1,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:12,color:l.value?"#e2e8f0":"#64748b"}},visualMap:{min:0,max:8,calculable:!1,orient:"horizontal",right:0,top:0,itemWidth:15,itemHeight:15,type:"piecewise",pieces:[{value:0,color:l.value?"#1b1c26":"#f8fafc",label:"无"},{value:1,color:l.value?"#450a0a":"#fff7ed",label:"1"},{value:2,color:l.value?"#7f1d1d":"#ffedd5",label:"2"},{value:3,color:l.value?"#b91c1c":"#fed7aa",label:"3"},{value:4,color:l.value?"#c2410c":"#fdba74",label:"4"},{value:5,color:l.value?"#ea580c":"#f97316",label:"5"},{value:6,color:l.value?"#f97316":"#ea580c",label:"6"},{value:7,color:l.value?"#facc15":"#c2410c",label:"7"},{min:8,color:l.value?"#fef08a":"#9a3412",label:"8+"}],textStyle:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"每周获取",type:"heatmap",data:n,label:{show:!0,formatter:e=>e.value[2]>0?e.value[2]:"",color:"inherit"},itemStyle:{borderRadius:4,borderColor:l.value?"#252632":"#fff",borderWidth:2},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.4)"}}}]}});return(e,a)=>(i(),s("div",Dl,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"每周获取热力图")],-1)),d("div",{class:"chart-body",style:o({height:r.value+"px"})},[c(p(Ze),{class:"echarts-instance",option:f.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])],4)]))}}),Ml=e(Rl,[["__scopeId","data-v-649f36cb"]]),Tl={class:"stats-panel"},zl={class:"charts-grid"},Pl=a({__name:"LootStatisticsPanel",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup:e=>(l,a)=>(i(),s("div",Tl,[d("div",zl,[c(Cl,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(El,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(Ml,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"record-week-corrections":e.recordWeekCorrections,"sync-start-date":e.syncStartDate,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","record-week-corrections","sync-start-date","player-visibility"])])]))}),Ul=e(Pl,[["__scopeId","data-v-82f4fe50"]]),Ll={class:"filter-segmented"},Nl=a({__name:"LootDisplayFilterSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function t(e){a("update:modelValue",e)}return(l,a)=>(i(),s("div",Ll,[d("div",{class:r(["segment-item",{"is-active":"obtained"===e.modelValue}]),onClick:a[0]||(a[0]=e=>t("obtained"))}," 已获得 ",2),d("div",{class:r(["segment-item",{"is-active":"needed"===e.modelValue}]),onClick:a[1]||(a[1]=e=>t("needed"))}," 尚未获得 ",2),d("div",{class:r(["segment-item",{"is-active":"all"===e.modelValue}]),onClick:a[2]||(a[2]=e=>t("all"))}," 全部显示 ",2)]))}}),jl=e(Nl,[["__scopeId","data-v-f07e22be"]]),Wl={class:"bis-allocator"},Al={class:"bis-toolbar"},Il={key:0,class:"dot-warn"},Fl={key:0,style:{"font-size":"12px",color:"#909399","margin-left":"4px"}},Jl={key:0,class:"bis-view-panel"},Yl={class:"table-container"},Hl={class:"bis-table"},Kl=["rowspan"],Xl={class:"sticky-col col-item row-header"},ql={class:"cell-status-container"},Gl={class:"status-main"},Ql={key:0,class:"status-meta"},Zl={key:1,class:"bis-onboarding"},ea={class:"onboarding-card"},la={class:"icon-circle"},aa={class:"bis-config-panel-container"},ta={class:"bis-config-header-row"},sa={class:"bis-storage-info"},na={class:"planned-weeks-config"},ia={key:0,class:"validation-alerts"},oa={class:"alert-msg"},ra={class:"table-scroll-wrapper"},ua={class:"bis-table config-table"},ca={class:"vert-header"},da={class:"header-action-area"},va={key:0,class:"incomplete-label"},pa={class:"preset-apply-zone"},ma={class:"preset-item-content"},ya={class:"preset-item-content"},fa=["onClick"],ga={class:"expand-action"},ha={class:"preset-item-content"},ba={class:"sticky-col row-header"},ka={key:0,class:"split-cell"},wa=["onClick"],_a=["onClick"],Sa={key:1,class:"count-cell"},Va={class:"count-wrapper"},xa={class:"dialog-footer"},Ca={class:"footer-left"},$a={class:"footer-right"},Oa={class:"config-status-msg"},Ba={key:0},Ea={key:0,class:"import-empty-msg"},Da={key:1,class:"import-diff-container"},Ra={class:"import-summary"},Ma={class:"diff-header"},Ta={key:0,class:"diff-tag"},za={key:1,class:"diff-tag update"},Pa={class:"diff-items"},Ua={class:"diff-label"},La={class:"diff-values"},Na={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},ja={key:0,class:"import-diff-container"},Wa={class:"import-summary"},Aa={class:"diff-card"},Ia={class:"diff-header"},Fa={key:0,class:"diff-tag"},Ja={key:1,class:"diff-tag update"},Ya={class:"diff-items"},Ha={class:"diff-label"},Ka={class:"diff-values"},Xa={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},qa=e(a({__name:"BisAllocator",props:{players:{},records:{},modelValue:{},getPlayerRole:{type:Function},getActualPlayer:{type:Function},showOnlyRole:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:l}){function a(e){const l=[];return e.forEach(e=>{const a=[],t=[];ke.value.forEach(l=>{if(V.value.has(l))return;let s=v.getPlayerRole?.(l)||l;s=s.replace(/^LEFT:/,"").trim();const n=K(l,e);"need"===n?a.push(s):"greed"===n&&t.push(s)});let s="";s=a.length>0?a.join("、"):t.length>0?t.join("、"):"随便ROLL",l.push(`/p ${e.name}：${s}`)}),l}function o(e){const l=new Date,t=v.records&&0!==v.records.length?F(v.records.map(e=>e.timestamp)):1,s=`${l.getMonth()+1}月${l.getDate()}日`;let n="",i="";if("all"===e){const e=[`/p <第${t}周分配优先级> ${s}`];q.value.forEach(l=>{e.push(...a(l.rows))}),n=e.join("\n"),i="已复制全层宏 (共"+e.length+"行)"}else{const l=[`/p <第${t}周${e.name}分配优先级> ${s}`];l.push(...a(e.rows)),n=l.join("\n"),i=`已复制 ${e.name} 分配宏`}n&&navigator.clipboard.writeText(n).then(()=>{ge.success(i)}).catch(()=>{ge.error("复制失败")})}const v=e,y=l,S=m(!1),V=m(new Set),x=m({playerBis:{},plannedWeeks:8});function C(e){if(!v.getPlayerRole)return e;const l=v.getPlayerRole(e);return!l||l.startsWith("LEFT:")||l.startsWith("SUB:")?e:l}function $(){let e=ke.value.map(e=>{const l=v.getPlayerRole?.(e)||"Unknown",a=C(e),t=L.map(e=>{const l=x.value.playerBis[a]?.[e.id];return"toggle"===e.type?"raid"===l?"1":"0":"number"==typeof l&&l>0?"1":"0"}).join("");return`${e}:${l}:${parseInt(t,2).toString(36)}`}).join(";");navigator.clipboard.writeText(e).then(()=>{ge.success("BIS 设置已复制到剪贴板")})}function O(){he.prompt("请粘贴 BIS 设置字符串","导入 BIS 设置",{confirmButtonText:"下一步",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"在此粘贴...",customClass:"bis-import-message-box",inputValidator:e=>{if(!e)return"内容不能为空";const l=e.trim().split(";").filter(e=>e.trim());if(0===l.length)return"格式错误：无法识别有效的分隔符";let a=0;for(const t of l){if(t.startsWith("weeks:"))continue;const e=t.split(":");if(3!==e.length)return`数据格式错误："${t.slice(0,10)}..."`;const[l,,s]=e;if(!s||!/^[0-9a-z]+$/i.test(s))return`数据校验失败：玩家 "${l||"未知"}" 的设置已损坏`;l&&ke.value.includes(l)&&a++}return 0!==a||"未找到匹配当前团队的有效设置数据"}}).then(({value:e})=>{e&&function(e){try{const l=e.trim();if(!l)throw new Error("输入内容为空");const a=l.split(";").filter(e=>e.trim());if(0===a.length)throw new Error("无效的格式");const t=[];if(P.value=void 0,a.forEach(e=>{if(e.startsWith("weeks:")){const l=parseInt(e.split(":")[1]||"0");return void(isNaN(l)||(P.value=l))}const l=e.split(":");if(l.length<3)return;const a=l[0],s=l[1],n=l[2];if(!a||!n||!ke.value.includes(a))return;const i=v.getPlayerRole?.(a);if(i&&s&&"Unknown"!==s&&i!==s)return;const o=n.length===L.length&&/^[012]+$/.test(n)?n:parseInt(n,36).toString(2).padStart(L.length,"0"),r={};let u=!0;if(L.forEach((e,l)=>{const a=o[l];a?"toggle"===e.type?r[e.id]="1"===a?"raid":"tome":r[e.id]="1"===a?1:0:u=!1}),!u)return;const c=C(a),d=c&&x.value.playerBis[c]||{},p=[];let m=!1;L.forEach(e=>{const l=d[e.id],a=r[e.id],t=M(e,l),s=M(e,a);t!==s&&(m=!0,p.push({label:e.name,oldVal:t,newVal:s}))}),m&&t.push({name:a,role:i||s||"Unknown",isNew:0===Object.keys(d).length,changes:p,newConfig:r})}),0===t.length)return void ge.info("未检测到有效的设置变更，或玩家信息不匹配。");D.value=t,B.value=!0}catch(l){ge.error(l.message||"解析失败")}}(e)}).catch(()=>{})}const B=m(!1),E=m(!1),D=m([]),R=m(null);function M(e,l){return"toggle"===e.type?"raid"===l?"零式":"tome"===l?"点数":"未设置":(l||1).toString()}function T(e){return"零式"===e?"is-raid":"点数"===e?"is-tome":""}function z(){!function(){const e={...x.value.playerBis};D.value.forEach(l=>{const a=C(l.name);e[a]={...e[a],...l.newConfig}}),x.value.playerBis=e,void 0!==P.value&&(x.value.plannedWeeks=P.value);B.value=!1,ge.success(`成功更新 ${D.value.length} 位玩家设置`)}()}const P=m(void 0);function J(e,l,a){const t=C(e);x.value.playerBis[t]||(x.value.playerBis[t]={});x.value.playerBis[t][l]===a?delete x.value.playerBis[t][l]:x.value.playerBis[t][l]=a}function Y(){if(!R.value?.diff)return;const{player:e,preset:l,diff:a}=R.value,t=C(e);x.value.playerBis[t]||(x.value.playerBis[t]={}),Object.assign(x.value.playerBis[t],a.newConfig),E.value=!1,R.value=null,ge.success(`已应用预设: ${l.name} (${e})`)}function H(e,l){if(!v.records)return 0;const a=l.keywords.replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);return 0===a.length?0:v.records.filter(l=>(v.getActualPlayer?v.getActualPlayer(l.player):l.player)===e&&a.some(e=>l.item.includes(e))).length}function K(e,l){if("count"===l.type){const a=Oe(e,l.id);return 0===a?"greed":H(e,l)>=a?"pass":"need"}return function(e,l){return H(e,l)>0}(e,l)?"pass":"raid"===Ce(e,l.id)?"need":"greed"}function X(e,l){const a=K(e,l);return xe[a]?.text||""}const q=t(()=>U.map(e=>{const l=e.items.map(e=>L.find(l=>l.id===e)).filter(e=>!!e);return{name:e.name,rows:l}})),G=t(()=>{const e=N;return[...L].sort((l,a)=>{const t=e.indexOf(l.keywords),s=e.indexOf(a.keywords);return-1===t&&-1===s?0:-1===t?1:-1===s?-1:t-s})});function be(e){if(!v.getPlayerRole)return!1;const l=v.getPlayerRole(e);return!!l&&(!l.startsWith("LEFT:")&&!l.startsWith("SUB:"))}const ke=t(()=>v.players.filter(be)),we=m(new Set);function _e(e){const l=v.getPlayerRole?.(e),a=I(l);return a.recommended.length>0||a.others.length>0}const Se=t(()=>{for(const e of j)if(!W(x.value,e))return!1;return!0});f(()=>v.modelValue,e=>{if(e)if(function(e){if(!e||"object"!=typeof e||!e.playerBis)return!1;const l=Object.keys(e.playerBis)[0];return!!l&&Array.isArray(e.playerBis[l])}(e)){const l={playerBis:{}},a=JSON.parse(JSON.stringify(e));Object.keys(a.playerBis).forEach(e=>{l.playerBis[e]={};const t=a.playerBis[e];t&&t.forEach(a=>{l.playerBis[e]&&(l.playerBis[e][a]="raid")})}),x.value=l}else{const l=e;JSON.stringify(l)!==JSON.stringify(x.value)&&(x.value={...l,plannedWeeks:l.plannedWeeks??8})}},{immediate:!0,deep:!0});const Ve=t(()=>j.filter(e=>!W(x.value,e)).length);f(x,e=>{JSON.stringify(e)!==JSON.stringify(v.modelValue)&&y("update:modelValue",e)},{deep:!0});const xe={pass:{text:"放弃",class:"status-pass"},need:{text:"需求",class:"status-need"},greed:{text:"贪婪",class:"status-greed-tome"}};function Ce(e,l){return x.value.playerBis[C(e)]?.[l]}function $e(e,l){return"tome"===Ce(e,l)}function Oe(e,l){const a=Ce(e,l);return"number"==typeof a?a:["tome","solvent"].includes(l)?0:1}function Be(e,l){const a=K(e,l),t=xe[a]?.class||"";return V.value.has(e)?`${t} is-excluded`:t}const Ee=A,De=t(()=>{const e=[],l=x.value.plannedWeeks||8;return[{id:"coating",name:"硬化药"},{id:"twine",name:"强化纤维"},{id:"tome",name:"神典石"},{id:"solvent",name:"强化药"}].forEach(a=>{let t=0;ke.value.forEach(e=>{t+=Oe(e,a.id)}),t>l&&e.push({id:a.id,type:"warning",message:`${a.name}: 总需求(${t}) 大于 计划周数(${l})，这是不可能的分配。`})}),e});return(l,a)=>{const t=Q,m=ee,y=te,f=se,P=le,U=ne,N=re,j=de,A=me,F=ye;return i(),s("div",Wl,[d("div",Al,[c(m,{size:"small",type:"primary",plain:"",onClick:a[0]||(a[0]=e=>S.value=!0),class:"setup-trigger-btn"},{default:h(()=>[c(t,{style:{"margin-right":"4px"}},{default:h(()=>[c(p(Z))]),_:1}),a[9]||(a[9]=d("span",null,"设置 BIS",-1)),Se.value?n("",!0):(i(),s("span",Il))]),_:1}),Se.value?(i(),g(P,{key:0,trigger:"click",onCommand:o},{dropdown:h(()=>[c(f,null,{default:h(()=>[c(y,{command:"all"},{default:h(()=>[...a[11]||(a[11]=[b(" 全层 ",-1)])]),_:1}),(i(!0),s(k,null,w(q.value,e=>(i(),g(y,{key:e.name,command:e,divided:""},{default:h(()=>[b(u(e.name),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:h(()=>[c(m,{size:"small"},{default:h(()=>[a[10]||(a[10]=b(" 复制分配宏",-1)),c(t,{class:"el-icon--right"},{default:h(()=>[c(p(ae))]),_:1})]),_:1})]),_:1})):n("",!0),Se.value?(i(),g(U,{key:1,placement:"top",title:"分配宏生成规则",width:320,trigger:"hover"},{reference:h(()=>[c(t,{class:"macro-help-icon"},{default:h(()=>[c(p(ie))]),_:1})]),default:h(()=>[a[12]||(a[12]=d("div",{class:"macro-help-content"},[d("div",{class:"intro"},"生成可以直接在游戏内发送的分配宏（/p）。"),d("div",{class:"rule-item"},[d("strong",null,"1. 优先需求"),d("span",null,"仅显示BIS设为“零式”且尚未获得的玩家。")]),d("div",{class:"rule-item"},[d("strong",null,"2. 次选贪婪"),d("span",null,"若无需求者，显示其余尚未获得的玩家。")]),d("div",{class:"rule-item"},[d("strong",null,"3. 兜底机制"),d("span",null,"若全员不需要，显示“随便ROLL”。")])],-1))]),_:1})):n("",!0),Se.value?(i(),g(P,{key:2,trigger:"click","hide-on-click":!1,"max-height":"400px"},{dropdown:h(()=>[c(f,null,{default:h(()=>[(i(!0),s(k,null,w(ke.value,e=>(i(),g(y,{key:e},{default:h(()=>[c(N,{"model-value":V.value.has(e),onChange:l=>{return a=e,void(V.value.has(a)?V.value.delete(a):V.value.add(a));var a},size:"small",style:{width:"100%"}},{default:h(()=>[b(u(v.getPlayerRole?.(e)||e)+" ",1),V.value.has(e)?(i(),s("span",Fl,"(请假)")):n("",!0)]),_:2},1032,["model-value","onChange"])]),_:2},1024))),128))]),_:1})]),default:h(()=>[c(m,{size:"small",type:"warning",plain:"",style:{"margin-left":"12px"}},{default:h(()=>[c(t,{style:{"margin-right":"4px"}},{default:h(()=>[c(p(oe))]),_:1}),a[13]||(a[13]=b(" 设置请假 ",-1))]),_:1})]),_:1})):n("",!0)]),Se.value?(i(),s("div",Jl,[d("div",Yl,[d("table",Hl,[d("thead",null,[d("tr",null,[a[14]||(a[14]=d("th",{class:"sticky-col col-layer",style:{"z-index":"30"}},null,-1)),a[15]||(a[15]=d("th",{class:"sticky-col col-item",style:{"z-index":"30"}}," 装备 \\ 玩家 ",-1)),(i(!0),s(k,null,w(ke.value,l=>(i(),s("th",{key:l,class:r({"is-excluded":V.value.has(l)})},[c(ml,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"])],2))),128))])]),d("tbody",null,[(i(!0),s(k,null,w(q.value,e=>(i(),s(k,{key:e.name},[(i(!0),s(k,null,w(e.rows,(l,a)=>(i(),s("tr",{key:l.id,class:r({"is-layer-end":a===e.rows.length-1})},[0===a?(i(),s("td",{key:0,rowspan:e.rows.length,class:"sticky-col col-layer layer-cell"},u(e.name),9,Kl)):n("",!0),d("td",Xl,u(l.name),1),(i(!0),s(k,null,w(ke.value,e=>(i(),s("td",{key:e,class:r(Be(e,l))},[d("div",ql,[d("span",Gl,u(X(e,l)),1),"count"===l.type&&Oe(e,l.id)>1?(i(),s("span",Ql," ("+u(H(e,l))+"/"+u(Oe(e,l.id))+") ",1)):n("",!0)])],2))),128))],2))),128))],64))),128))])])])])):(i(),s("div",Zl,[d("div",ea,[d("div",la,[c(t,null,{default:h(()=>[c(p(ue))]),_:1})]),a[17]||(a[17]=d("h3",null,"开启 BIS 分配",-1)),a[18]||(a[18]=d("p",null,"尚未设置团队成员的 BIS，无法生成分配推荐。",-1)),c(m,{type:"primary",size:"large",onClick:a[1]||(a[1]=e=>S.value=!0)},{default:h(()=>[...a[16]||(a[16]=[b(" 立即开始设置 ",-1)])]),_:1})])])),c(F,{modelValue:S.value,"onUpdate:modelValue":a[4]||(a[4]=e=>S.value=e),width:"auto","append-to-body":"",class:"bis-config-dialog","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",xa,[d("div",Ca,[c(A,null,{default:h(()=>[c(m,{size:"small",onClick:$},{default:h(()=>[...a[26]||(a[26]=[b("导出 BIS 设置",-1)])]),_:1}),c(m,{size:"small",onClick:O},{default:h(()=>[...a[27]||(a[27]=[b("导入 BIS 设置",-1)])]),_:1})]),_:1})]),d("div",$a,[d("div",Oa,[Ve.value>0?(i(),s("span",Ba," 还剩 "+u(Ve.value)+" 个职位的 BIS 尚未填完 ",1)):n("",!0)]),c(m,{type:"primary",size:"small",onClick:a[3]||(a[3]=e=>S.value=!1)},{default:h(()=>[...a[28]||(a[28]=[b(" 完成并关闭 ",-1)])]),_:1})])])]),default:h(()=>[d("div",aa,[d("div",ta,[d("div",sa,[c(t,null,{default:h(()=>[c(p(ce))]),_:1}),a[19]||(a[19]=d("span",null,"提示：此 BIS 设置跟随职位（MT/ST等），不跟随具体玩家。",-1))]),d("div",na,[a[20]||(a[20]=d("span",{class:"label"},"你们计划清几周CD：",-1)),c(j,{modelValue:x.value.plannedWeeks,"onUpdate:modelValue":a[2]||(a[2]=e=>x.value.plannedWeeks=e),min:1,max:16,size:"small","controls-position":"right",class:"weeks-stepper"},null,8,["modelValue"])])]),De.value.length>0?(i(),s("div",ia,[(i(!0),s(k,null,w(De.value,e=>(i(),s("div",{key:e.id,class:r(["validation-alert",e.type])},[c(t,{class:"alert-icon"},{default:h(()=>["info"===e.type?(i(),g(p(ce),{key:0})):(i(),g(p(ve),{key:1}))]),_:2},1024),d("span",oa,u(e.message),1)],2))),128))])):n("",!0),d("div",ra,[d("table",ua,[d("thead",null,[d("tr",null,[a[25]||(a[25]=d("th",{class:"sticky-col"},"装备 \\ 玩家",-1)),(i(!0),s(k,null,w(ke.value,l=>(i(),s("th",{key:l,class:r([{"header-incomplete":!p(W)(x.value,C(l))},{"is-excluded":V.value.has(l)},p(Ee)(e.getPlayerRole?.(l))])},[d("div",ca,[c(ml,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),d("div",da,[p(W)(x.value,C(l))?n("",!0):(i(),s("span",va,"未填写")),d("div",pa,[_e(l)?(i(),g(P,{key:0,trigger:"click",onCommand:e=>function(e,l){const a=C(e),t=x.value.playerBis[a]||{},s={...l.config},n=[];if(L.forEach(e=>{const l=t[e.id],a=s[e.id],i=M(e,l),o=M(e,a);i!==o&&n.push({label:e.name,oldVal:i,newVal:o})}),0===n.length)return void ge.info("当前设置与预设相同，无需更改");const i={name:e,role:v.getPlayerRole?.(e)||"Unknown",isNew:0===Object.keys(t).length,changes:n,newConfig:s};R.value={player:e,preset:l,diff:i},E.value=!0}(l,e),onVisibleChange:e=>!e&&we.value.delete(l),"popper-class":"bis-preset-popper"},{dropdown:h(()=>[c(f,{class:"bis-preset-dropdown"},{default:h(()=>[(i(!0),s(k,null,w(p(I)(e.getPlayerRole?.(l)).recommended,e=>(i(),g(y,{key:e.name,command:e},{default:h(()=>[d("div",ma,[c(t,null,{default:h(()=>[c(p(pe))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command"]))),128)),0===p(I)(e.getPlayerRole?.(l)).recommended.length?(i(!0),s(k,{key:0},w(p(I)(e.getPlayerRole?.(l)).others,e=>(i(),g(y,{key:e.name,command:e},{default:h(()=>[d("div",ya,[c(t,null,{default:h(()=>[c(p(pe))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command"]))),128)):p(I)(e.getPlayerRole?.(l)).others.length>0?(i(),s(k,{key:1},[we.value.has(l)?(i(!0),s(k,{key:1},w(p(I)(e.getPlayerRole?.(l)).others,(e,l)=>(i(),g(y,{key:e.name,command:e,divided:0===l},{default:h(()=>[d("div",ha,[c(t,null,{default:h(()=>[c(p(pe))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command","divided"]))),128)):(i(),s("div",{key:0,class:"preset-expand-divider",onClick:_(e=>we.value.add(l),["stop"])},[a[23]||(a[23]=d("div",{class:"divider-line"},null,-1)),d("div",ga,[a[22]||(a[22]=d("span",null,"更多同职能预设",-1)),c(t,null,{default:h(()=>[c(p(ae))]),_:1})]),a[24]||(a[24]=d("div",{class:"divider-line"},null,-1))],8,fa))],64)):n("",!0)]),_:2},1024)]),default:h(()=>[c(m,{size:"small",class:"preset-btn"},{default:h(()=>[c(t,{class:"magic-icon"},{default:h(()=>[c(p(pe))]),_:1}),a[21]||(a[21]=d("span",null,"一键预设",-1))]),_:1})]),_:2},1032,["onCommand","onVisibleChange"])):n("",!0)])])])],2))),128))])]),d("tbody",null,[(i(!0),s(k,null,w(G.value,e=>(i(),s("tr",{key:e.id},[d("td",ba,u(e.name),1),(i(!0),s(k,null,w(ke.value,l=>{return i(),s("td",{key:l,class:"split-cell-container"},["toggle"===e.type?(i(),s("div",ka,[d("div",{class:r(["half-cell left-raid",{active:(a=l,t=e.id,"raid"===Ce(a,t))}]),onClick:a=>J(l,e.id,"raid")}," 零式 ",10,wa),d("div",{class:r(["half-cell right-tome",{active:$e(l,e.id)}]),onClick:a=>J(l,e.id,"tome")}," 点数 ",10,_a)])):(i(),s("div",Sa,[d("div",Va,[c(j,{"model-value":Oe(l,e.id),min:0,max:8,size:"small","controls-position":"right","onUpdate:modelValue":a=>function(e,l,a){const t=C(e);x.value.playerBis[t]||(x.value.playerBis[t]={}),x.value.playerBis[t][l]=a}(l,e.id,a||0),class:"mini-stepper"},null,8,["model-value","onUpdate:modelValue"])])]))]);var a,t}),128))]))),128))])])])])]),_:1},8,["modelValue"]),c(F,{modelValue:B.value,"onUpdate:modelValue":a[6]||(a[6]=e=>B.value=e),title:"确认导入 BIS 设置",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",Na,[c(m,{onClick:a[5]||(a[5]=e=>B.value=!1)},{default:h(()=>[...a[29]||(a[29]=[b("取消",-1)])]),_:1}),c(m,{type:"primary",onClick:z,disabled:0===D.value.length},{default:h(()=>[...a[30]||(a[30]=[b(" 确认应用 ",-1)])]),_:1},8,["disabled"])])]),default:h(()=>[0===D.value.length?(i(),s("div",Ea," 没有检测到有效的变更数据。 ")):(i(),s("div",Da,[d("p",Ra," 检测到 "+u(D.value.length)+" 位玩家的设置变更。 ",1),(i(!0),s(k,null,w(D.value,e=>(i(),s("div",{key:e.name,class:"diff-card"},[d("div",Ma,[c(ml,{name:e.name,role:e.role,"show-only-role":!1},null,8,["name","role"]),e.isNew?(i(),s("span",Ta,"新设置")):(i(),s("span",za,"更新"))]),d("div",Pa,[(i(!0),s(k,null,w(e.changes,(e,l)=>(i(),s("div",{key:l,class:"diff-row"},[d("span",Ua,u(e.label),1),d("div",La,[d("span",{class:r(["val old",T(e.oldVal)])},u(e.oldVal),3),c(t,null,{default:h(()=>[c(p(fe))]),_:1}),d("span",{class:r(["val new",T(e.newVal)])},u(e.newVal),3)])]))),128))])]))),128))]))]),_:1},8,["modelValue"]),c(F,{modelValue:E.value,"onUpdate:modelValue":a[8]||(a[8]=e=>E.value=e),title:"确认预设变更",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",Xa,[c(m,{onClick:a[7]||(a[7]=e=>E.value=!1)},{default:h(()=>[...a[31]||(a[31]=[b("取消",-1)])]),_:1}),c(m,{type:"primary",onClick:Y},{default:h(()=>[...a[32]||(a[32]=[b(" 确认应用 ",-1)])]),_:1})])]),default:h(()=>[R.value?.diff?(i(),s("div",ja,[d("p",Wa," 应用 ["+u(R.value.preset.name)+"] 将会产生以下变更： ",1),d("div",Aa,[d("div",Ia,[c(ml,{name:R.value.diff.name,role:R.value.diff.role,"show-only-role":!1},null,8,["name","role"]),R.value.diff.isNew?(i(),s("span",Fa,"新设置")):(i(),s("span",Ja,"更新"))]),d("div",Ya,[(i(!0),s(k,null,w(R.value.diff.changes,(e,l)=>(i(),s("div",{key:l,class:"diff-row"},[d("span",Ha,u(e.label),1),d("div",Ka,[d("span",{class:r(["val old",T(e.oldVal)])},u(e.oldVal),3),c(t,null,{default:h(()=>[c(p(fe))]),_:1}),d("span",{class:r(["val new",T(e.newVal)])},u(e.newVal),3)])]))),128))])])])):n("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-d9b1a72f"]]),Ga={class:"summary-item-right"},Qa={key:0,class:"random-weapon-tag"},Za={key:0,class:"bis-tag"},et={key:1,class:"non-bis-tag"},lt={key:2,class:"layer-tag"},at=e(a({__name:"SummaryItemTags",props:{item:{}},setup:e=>(l,a)=>(i(),s("div",Ga,[e.item.isRandomWeapon?(i(),s("span",Qa,"随武")):(i(),s(k,{key:1},[e.item.isBis?(i(),s("span",Za,"毕业")):!1===e.item.isBis?(i(),s("span",et,"副职")):n("",!0)],64)),e.item.layerName?(i(),s("span",lt,u(e.item.layerName),1)):n("",!0),d("span",{class:r(["count-badge",e.item.count>1?"count-many":0===e.item.count?"count-none":"count-single"])}," x"+u(e.item.count),3)]))}),[["__scopeId","data-v-10461ea9"]]),tt={key:0,class:"initial-loading"},st={class:"theme-toggle-fixed"},nt={key:0,class:"loading-overlay"},it={class:"loading-card-wide"},ot={class:"loading-header"},rt={class:"loading-title"},ut={class:"parsing-lists"},ct={class:"list-col"},dt={class:"list-head"},vt={class:"list-body"},pt={class:"file-info-left"},mt=["title"],yt={class:"file-size"},ft={class:"list-col"},gt={class:"list-head"},ht={class:"list-body"},bt={class:"file-info-left"},kt=["title"],wt={class:"file-size"},_t={key:0,class:"more-hint"},St={key:0,class:"app-main",style:{"padding-top":"10px"}},Vt={class:"control-bar",style:{position:"relative"}},xt={class:"path-toolbar"},Ct={key:0,class:"dot-warn"},$t={class:"guide-content-popover"},Ot={class:"guide-section"},Bt={class:"guide-section"},Et={class:"guide-section"},Dt={class:"guide-section"},Rt={class:"filter-panel"},Mt={class:"filter-section"},Tt={class:"sec-header"},zt={class:"sec-title-group"},Pt={class:"title-main"},Ut={key:0,class:"dot-warn"},Lt={class:"role-settings-content-popover"},Nt={class:"role-grid"},jt={class:"role-setup-label"},Wt={class:"special-role-section"},At={class:"special-role-group"},It={class:"special-list"},Ft={key:0,class:"special-item"},Jt={class:"special-role-group"},Yt={class:"special-list"},Ht={key:0,class:"special-item"},Kt={class:"switch-box"},Xt={class:"switch-container",style:{display:"inline-flex","align-items":"center",gap:"6px"}},qt={key:0,class:"header-sep"},Gt={key:1,class:"switch-box"},Qt={class:"acts"},Zt={class:"popover-form"},es={class:"merge-selector-box"},ls={class:"selector-tags"},as={key:0,class:"merge-actions"},ts={key:0,class:"suggestion-box"},ss={class:"suggest-items"},ns={class:"conf-text"},is={key:1,class:"mapping-box"},os={class:"mapping-list"},rs={class:"sec-body",style:{position:"relative"}},us={key:0,class:"section-mask"},cs={class:"filter-section"},ds={class:"sec-header"},vs={class:"sec-title-group"},ps={class:"title-main"},ms={class:"switch-box"},ys={class:"filter-popover"},fs={class:"sec-body",style:{position:"relative"}},gs={key:0,class:"section-mask"},hs={class:"main-viewport",style:{position:"relative"}},bs={class:"list-container-el"},ks={class:"col-week"},ws={class:"col-time"},_s={class:"time-date"},Ss={class:"col-item"},Vs={class:"item-text"},xs={key:1,class:"no-winner"},Cs={class:"col-rolls"},$s={class:"pagination-box"},Os={class:"tabs-sort-control"},Bs={class:"summary-grid has-sort-control"},Es={class:"summary-header"},Ds=["title"],Rs={class:"tabs-sort-control"},Ms={class:"summary-grid slot-grid has-sort-control"},Ts={class:"summary-header"},zs={class:"s-right-group"},Ps={class:"tabs-sort-control"},Us={class:"week-content-wrapper"},Ls={class:"summary-header"},Ns={class:"week-list-body"},js=["onContextmenu","onClick"],Ws={class:"week-row-aside"},As={class:"week-row-main"},Is={class:"week-item-name"},Fs={key:1,class:"week-list-divider"},Js={key:0,class:"custom-context-menu"},Ys={class:"menu-info-header"},Hs={class:"action-label"},Ks={style:{display:"flex","align-items":"center",gap:"4px"}},Xs={key:0,class:"dot-warn",style:{margin:"0"}},qs={key:1,class:"empty-placeholder"},Gs={class:"empty-icon"},Qs={class:"empty-hint"},Zs={key:1,class:"empty-container"},en={class:"empty-placeholder compact-guide"},ln={key:0,class:"empty-guide-main",style:{position:"relative"}},an={class:"empty-info-side"},tn={class:"empty-hint"},sn={class:"empty-desc"},nn={class:"empty-highlight"},on={class:"setup-form"},rn={class:"setup-row"},un={class:"setup-row"},cn={class:"empty-hint",style:{"margin-top":"24px"}},dn={key:2,class:"ready-state-container",style:{position:"relative",width:"100%",display:"flex","flex-direction":"column","align-items":"center"}},vn={class:"empty-title"},pn={class:"empty-desc"},mn={class:"empty-hint"},yn={class:"export-selection-list"},fn={class:"dialog-footer"},gn={key:0,class:"import-preview-box"},hn={class:"import-selection-list"},bn={key:0,class:"import-not-found-hint"},kn={key:1,class:"import-identical-hint"},wn={key:0,class:"import-not-found-hint"},_n={key:1,class:"import-identical-hint"},Sn={key:0,class:"import-not-found-hint"},Vn={key:1,class:"import-identical-hint"},xn={key:0,class:"import-not-found-hint"},Cn={key:1,class:"import-identical-hint"},$n={key:0,class:"import-warning-info"},On={key:1,class:"import-success-info"},Bn={class:"dialog-footer"},En={class:"dialog-footer"},Dn="需在左上方“固定队 - 职位设置”中完成所有职位后方可开启",Rn=e(a({__name:"lootHistory",setup(e){const a="2026-01-06T16:00",v="总冠军",y=J("loot-history-records"),O=J("loot-history-config"),B=J("loot-history-handle"),E=m(!0),D=m(!1),R=m(0),M=m([]),A=m([]),I=m([]),F=m(new Set),ue=m(new Set),de=m({}),pe=m("summary"),me=m(null),fe=m(!1),Qe=m(!1),Ze=m(!1),el=m({loot:!0,bis:!0,roles:!0,mapping:!0}),ll=m({loot:!0,bis:!0,roles:!0,mapping:!0}),al=m({loot:!0,bis:!0,roles:!0,mapping:!0}),tl=m(null),sl=m({timestamp:"",item:"",player:""}),nl=m(!1),il=m({}),ol=m({}),rl=m({playerBis:{}}),ul=m("part"),dl=m("part"),pl=m("drop"),yl=m("part"),fl=m({});function gl(e){return fl.value&&fl.value[e]||e}const hl=m([]);function kl(){2===hl.value.length&&(Vl(hl.value[0],hl.value[1]),hl.value=[])}const wl=m("obtained"),Sl=m("obtained");function Vl(e,l){e&&l&&(fl.value={...fl.value,[e]:l})}const xl=m(1),Cl=m(""),$l=m(""),Ol=m(!1),Bl=m({}),El=m(a),Dl=m(null),Rl=m(!1),Ml=m(!1),Tl=m(!1),zl=["御敌","制敌","精准","治愈","强攻","强袭","游击","咏咒"].join("|"),Pl=new RegExp(`(${v}武器箱|${v}(?!${zl})|规格神典石|强化药|硬化药|强化纤维|神典石)`),Ll=new RegExp(`(?<series>.+)(${zl}).+`),Nl=m(!1),Wl=m(!1),Al=m(!1),Il=m(!0),Fl=m({cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]}),Jl=m({});f([de,il,Cl,Bl,El,Dl,pe,Rl,rl,fl,Jl,Nl,Wl,Al,Fl,Tl,ol,ul,dl,pl,yl,ue,Il,wl],async()=>{await O.set({key:"itemVisibility",value:JSON.parse(JSON.stringify(de.value))}),await O.set({key:"playerVisibility",value:JSON.parse(JSON.stringify(il.value))}),await O.set({key:"weekCorrections",value:JSON.parse(JSON.stringify(ol.value))}),await O.set({key:"logPath",value:Cl.value}),await O.set({key:"processedFiles",value:JSON.parse(JSON.stringify(Bl.value))}),await O.set({key:"syncStartDate",value:El.value}),await O.set({key:"syncEndDate",value:Dl.value}),await O.set({key:"viewMode",value:pe.value}),await O.set({key:"isRaidFilterActive",value:Rl.value}),await O.set({key:"bisConfig",value:JSON.parse(JSON.stringify(rl.value))}),await O.set({key:"hideUnselectedItems",value:Wl.value}),await O.set({key:"hideUnselectedPlayers",value:Al.value}),await O.set({key:"playerMapping",value:JSON.parse(JSON.stringify(fl.value))}),await O.set({key:"playerRoles",value:JSON.parse(JSON.stringify(Jl.value))}),await O.set({key:"showOnlyRole",value:Nl.value}),await O.set({key:"isOnlyRaidMembersActive",value:Tl.value}),await O.set({key:"systemFilterSettings",value:JSON.parse(JSON.stringify(Fl.value))}),await O.set({key:"summarySortMode",value:ul.value}),await O.set({key:"slotSortMode",value:dl.value}),await O.set({key:"weekSortMode",value:pl.value}),await O.set({key:"bisSortMode",value:yl.value}),await O.set({key:"playerSummaryFilterMode",value:wl.value}),await O.set({key:"slotSummaryFilterMode",value:Sl.value}),await O.set({key:"blacklistedKeys",value:Array.from(ue.value)})},{deep:!0}),f([El,Dl],()=>{E.value||(Ml.value=!0)}),S(async()=>{E.value=!0;try{const e=await y.getAll();let l=!1;const a=e.map(e=>{const a=Y(e.item),t=H(e.player),s=e.rolls.map(e=>({...e,player:H(e.player)}));return(a!==e.item||t!==e.player||JSON.stringify(s)!==JSON.stringify(e.rolls))&&(l=!0),{...e,item:a,player:t,rolls:s,timestamp:new Date(e.timestamp)}});l&&await y.bulkSet(JSON.parse(JSON.stringify(a))),I.value=a,a.forEach(e=>F.value.add(e.key));(await O.getAll()).forEach(e=>{"itemVisibility"===e.key&&(de.value=e.value),"playerVisibility"===e.key&&(il.value=e.value),"logPath"===e.key&&(Cl.value=e.value),"processedFiles"===e.key&&(Bl.value=e.value||{}),"weekCorrections"===e.key&&(ol.value=e.value||{}),"syncStartDate"===e.key&&e.value&&(El.value=e.value),"syncEndDate"===e.key&&(Dl.value=e.value||null),"viewMode"!==e.key||"list"!==e.value&&"summary"!==e.value&&"slot"!==e.value&&"week"!==e.value&&"chart"!==e.value&&"bis"!==e.value||(pe.value=e.value),"hideUnselectedItems"===e.key&&(Wl.value=!!e.value),"hideUnselectedPlayers"===e.key&&(Al.value=!!e.value),"playerMapping"===e.key&&(fl.value=e.value||{}),"playerRoles"===e.key&&(Jl.value=e.value||{}),"showOnlyRole"===e.key&&(Nl.value=!!e.value),"systemFilterSettings"===e.key&&e.value&&(Fl.value={...Fl.value,...e.value}),"isRaidFilterActive"===e.key&&(Rl.value=!!e.value),"isOnlyRaidMembersActive"===e.key&&(Tl.value=!!e.value),"summarySortMode"===e.key&&(ul.value=e.value||"part"),"slotSortMode"===e.key&&(dl.value=e.value||"part"),"weekSortMode"===e.key&&(pl.value=e.value||"drop"),"bisSortMode"===e.key&&(yl.value=e.value||"part"),"blacklistedKeys"===e.key&&(ue.value=new Set(e.value||[])),"bisConfig"===e.key&&(rl.value=e.value||{playerBis:{}}),"playerSummaryFilterMode"===e.key&&(wl.value=e.value||"obtained"),"slotSummaryFilterMode"===e.key&&(Sl.value=e.value||"obtained")});const t=await B.get("current-log-dir");if(t&&t.handle){me.value=t.handle,$l.value=t.handle.name;"granted"!==await t.handle.queryPermission({mode:"read"})&&(Cl.value="未授权，请点击同步按钮")}window.addEventListener("paste",Zl),document.body.addEventListener("dragover",Xl),document.body.addEventListener("dragleave",ql),document.body.addEventListener("drop",Gl),window.addEventListener("click",ea),oa.value||"list"===pe.value||(pe.value="list")}catch(e){}finally{E.value=!1}});const Yl=m(!1),Hl=m(!1);let Kl=null;function Xl(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer?.types.includes("Files")&&(Yl.value=!0,Kl&&(clearTimeout(Kl),Kl=null))}function ql(e){e.preventDefault(),Kl&&clearTimeout(Kl),Kl=setTimeout(()=>{Yl.value=!1,Hl.value=!1},100)}function Gl(e){if(e.preventDefault(),e.stopPropagation(),Yl.value=!1,Hl.value=!1,Kl&&(clearTimeout(Kl),Kl=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Jn(l)}}function Ql(e){if(e.preventDefault(),e.stopPropagation(),Yl.value=!1,Hl.value=!1,Kl&&(clearTimeout(Kl),Kl=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Jn(l)}}async function Zl(e){const l=e.clipboardData?.getData("text");if(l)try{if(!l.trim().startsWith("{"))return;const a=JSON.parse(l);a.r&&Array.isArray(a.r)&&(e.preventDefault(),await In(a))}catch(a){}}function ea(){Ma.value=!1}V(()=>{window.removeEventListener("paste",Zl),document.body.removeEventListener("dragover",Xl),document.body.removeEventListener("dragleave",ql),document.body.removeEventListener("drop",Gl),window.removeEventListener("click",ea)});const la=t(()=>{const e=new Map;return I.value.forEach(l=>{const a=new Set([l.player,...l.rolls.map(e=>e.player)]);a.forEach(l=>{e.has(l)||e.set(l,new Set);const t=e.get(l);a.forEach(e=>{e!==l&&t.add(e)})})}),e}),aa=t(()=>{const e=[],l=Array.from(la.value.keys());for(let a=0;a<l.length;a++)for(let t=a+1;t<l.length;t++){const s=l[a],n=l[t];if(gl(s)===gl(n))continue;const i=la.value.get(s),o=la.value.get(n);if(i.size<3||o.size<3)continue;const r=new Set([...i].filter(e=>o.has(e))),u=new Set([...i,...o]),c=r.size/u.size;c>.9&&e.push({from:s,to:n,confidence:Math.round(100*c)})}return e.sort((e,l)=>l.confidence-e.confidence).slice(0,5)}),ta=t(()=>{const e={};return I.value.forEach(l=>{const a=gl(l.player);e[a]=(e[a]||0)+1}),e}),sa=t(()=>{const e=new Set;return I.value.forEach(l=>{e.add(gl(l.player)),l.rolls.forEach(l=>e.add(gl(l.player)))}),Object.values(Jl.value).forEach(l=>{l&&e.add(gl(l))}),Array.from(e).sort((e,l)=>Qa(e,l,ta.value))}),na=t(()=>{const e=new Set;return I.value.forEach(l=>{if(Pl.test(l.item))return;const a=l.item.match(Ll);a?.groups?.series&&e.add(a.groups.series)}),Array.from(e).sort()}),ia=t(()=>new Set(Object.values(Jl.value))),oa=t(()=>j.every(e=>!!Jl.value[e])),ra=t(()=>!!oa.value&&j.every(e=>W(rl.value,e))),ua=t(()=>{const e=new Set;I.value.forEach(l=>{e.add(gl(l.player))});const l=new Set;I.value.forEach(e=>{l.add(e.player),e.rolls.forEach(e=>l.add(e.player))});const a=new Set(Object.keys(fl.value));return Array.from(l).filter(e=>{if(a.has(e))return!1;return Ha(gl(e))}).sort()}),ca=t(()=>{let e=da.value;"needed"===wl.value&&(e=e.filter(e=>{const l=Rn(e);return l&&!l.startsWith("LEFT:")&&!l.startsWith("SUB:")}));const l=wa.value,a={};return e.forEach(e=>{a[e]=Object.values(l[e]||{}).reduce((e,l)=>e+l,0)}),[...e].sort((e,l)=>Qa(e,l,a))}),da=t(()=>{let e=sa.value;return Al.value&&(e=e.filter(e=>Ha(e))),Il.value&&(e=e.filter(e=>wa.value[e]&&Object.keys(wa.value[e]).length>0)),e}),va=t(()=>sa.value.filter(e=>wa.value[e]&&Object.keys(wa.value[e]).length>0)),pa=t(()=>Il.value?va.value:sa.value),ma=t(()=>Wl.value?ya.value.filter(Ya):ya.value),ya=t(()=>{const e=new Set(I.value.filter(e=>!Ja(e.item)).map(e=>e.item));return Array.from(e).sort((e,l)=>{const a=ga(e),t=ga(l);return a!==t?a-t:e.localeCompare(l)})});f([Rl,ya],([e])=>{e?(!function(){const e={};ya.value.forEach(l=>{e[l]=Pl.test(l)}),de.value=e,0===ba.value&&(l=!0,sa.value.forEach(e=>il.value[e]=l));var l}(),Wl.value=!0):Wl.value=!1},{immediate:!0}),f([Tl,Jl,sa],()=>{if(Tl.value){const e={};sa.value.forEach(l=>{e[l]=!!Rn(l)}),il.value=e,Al.value=!0}else Al.value=!1},{deep:!0,immediate:!0}),f(oa,e=>{!e&&Tl.value&&(Tl.value=!1),e||(pe.value="list")});const fa=N;function ga(e,l="part"){const a=("part"===l?N:K).findIndex(l=>e.includes(l)||l.includes(e));return-1!==a?a:Pl.test(e)?50:100}const ha=t(()=>ya.value.filter(e=>Ya(e)).length),ba=t(()=>sa.value.filter(e=>Ha(e)).length),ka=t(()=>I.value.filter(e=>{if(Ja(e.item))return!1;if(!1===il.value[gl(e.player)])return!1;if(!1===de.value[e.item])return!1;const l=e.timestamp.getTime();return!(l<new Date(El.value).getTime())&&!(Dl.value&&l>new Date(Dl.value).getTime())}).sort((e,l)=>l.timestamp.getTime()-e.timestamp.getTime())),wa=t(()=>{const e={};return ka.value.forEach(l=>{const a=gl(l.player),t=l.item;e[a]||(e[a]={}),e[a][t]||(e[a][t]=0),e[a][t]++}),e});const _a=t(()=>{const e={};return fa.forEach(l=>{e[l]={}}),ka.value.forEach(l=>{let a=(t=l.item,fa.find(e=>t.includes(e))||"其他");var t;"其他"===a&&(a=l.item),e[a]||(e[a]={});const s=e[a],n=gl(l.player);s[n]||(s[n]=0),s[n]++}),e}),Sa=t(()=>{const e=Sl.value;return[...("part"===dl.value?N:K).filter(l=>{if("all"===e)return!0;if(_a.value[l]&&Object.keys(_a.value[l]).length>0)return!0;if("needed"===e){const e=L.find(e=>e.name===l||e.keywords===l);if(!e)return!1;return Object.keys(Jl.value).filter(e=>!e.startsWith("LEFT:")&&!e.startsWith("SUB:")).some(l=>{const a=Jl.value[l];if(!a)return!1;const t=wa.value[a]||{};return X(e,t)<Xa(e,a)})}return!1}),...Object.keys(_a.value).filter(e=>!N.includes(e)&&!K.includes(e)).filter(e=>Object.keys(_a.value[e]||{}).length>0).sort((e,l)=>{const a=e=>Object.values(_a.value[e]||{}).reduce((e,l)=>e+l,0),t=a(e),s=a(l);return t!==s?s-t:e.localeCompare(l)})]});const Va=t(()=>T(new Date(El.value)));function xa(e){const{label:l}=P(e,Va.value);return l}const Ca=t(()=>{const e={};ka.value.forEach(l=>{const a=function(e){const l=ol.value[e.key]||0;return z(e.timestamp,l).label}(l);e[a]||(e[a]={});const t=gl(l.player);e[a][t]||(e[a][t]=[]),e[a][t].push(l)});for(const l in e)for(const a in e[l]){const t=e[l][a];t&&t.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime())}return e}),$a=t(()=>{const e=new Set,l={};ka.value.forEach(e=>{const{label:a}=z(e.timestamp);l[a]||(l[a]=[]),l[a].push(e)});for(const a in l){const t=l[a],s={};t.forEach(e=>{s[e.item]||(s[e.item]=[]),s[e.item].push(e)});const n=[];for(const e in s){const l=s[e];if(l.length>1){l.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime());for(let e=0;e<l.length-1;e++){const a=l[e];l[e+1].timestamp.getTime()-a.timestamp.getTime()>3e5&&n.push(a.timestamp.getTime())}}}t.forEach(l=>{if(!Pl.test(l.item))return;const a=l.timestamp,t=a.getDay(),s=a.getHours();if(2!==t)return;if(s<16||s>=19)return;const i=l.timestamp.getTime();n.some(e=>Math.abs(i-e)<=3e5)&&e.add(l.key)})}return e}),Oa=t(()=>Object.keys(Ca.value).sort().reverse());function Ba(e){const l=Ca.value[e];if(!l)return[];const a=[];return Object.values(l).forEach(e=>{a.push(...e)}),a.sort((e,l)=>{const a=ga(e.item,pl.value),t=ga(l.item,pl.value);if(a!==t)return a-t;const s=Qa(e.player,l.player);return 0!==s?s:e.timestamp.getTime()-l.timestamp.getTime()})}function Ea(e){const l=ga(e,pl.value);return"drop"===pl.value?l<=3?1:l<=8?2:l<=12?3:4:0===l?1:l<=5?2:l<=9?3:4}function Da(e,l){if(l>=e.length-1)return!1;const a=e[l],t=e[l+1];if(!a||!t)return!1;return Ea(a.item)!==Ea(t.item)}const Ra=m(null),Ma=m(!1),Ta=m({x:0,y:0}),za={getBoundingClientRect:()=>({width:0,height:0,top:Ta.value.y,bottom:Ta.value.y,left:Ta.value.x,right:Ta.value.x})};function Pa(e,l){e.preventDefault(),e.stopPropagation(),Ra.value=l,Ta.value={x:e.clientX,y:e.clientY},Ma.value=!0}function Ua(){Ra.value&&function(e){const l=ol.value[e.key]||0,a={...ol.value};l<0?delete a[e.key]:a[e.key]=-1,ol.value=a}(Ra.value),Ma.value=!1}const La=t(()=>{const e=50*(xl.value-1);return ka.value.slice(e,e+50)});function Na(){de.value={},il.value={},Rl.value=!1,El.value=Va.value?.toISOString().slice(0,16)||a,Dl.value=null}async function ja(){try{const e=window.showDirectoryPicker;if(!e)return void he.alert("你的浏览器不支持此功能","错误",{confirmButtonText:"确定",type:"error"});const l=await e();l&&(await y.clear(),await O.set({key:"processedFiles",value:{}}),Bl.value={},ol.value={},I.value=[],F.value.clear(),de.value={},il.value={},await B.set({key:"current-log-dir",handle:l}),me.value=l,Cl.value=l.name,$l.value=l.name,nl.value=!0)}catch(e){e.name}}async function Wa(e,l=!1){try{const a=I.value.findIndex(l=>l.key===e.key);-1!==a&&I.value.splice(a,1),await y.remove(e.key),F.value.delete(e.key),ue.value.add(e.key),l||ge.success("记录已永久删除")}catch(a){l||ge.error("删除失败")}}async function Aa(){nl.value=!1,await Ia()}async function Ia(){if(Ol.value||!me.value)return;Ml.value=!1;const e=me.value;if("granted"!==await e.queryPermission({mode:"read"})){if("granted"!==await e.requestPermission({mode:"read"}))return}Ol.value=!0,D.value=!0,R.value=0;try{const l=function(){const e=new Date;return`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}`}(),a=new Date(El.value).getTime(),t=Dl.value?new Date(Dl.value).getTime():1/0,s=[],n=0===F.value.size,i=new Set(F.value),o=[],r=new Set,u=new Set;for await(const v of e.values())if("file"===v.kind&&v.name.toLowerCase().endsWith(".log")){const e=v.name,n=await v.getFile();if(n.size<10)continue;if(e.includes(l)){s.push({handle:v,name:e,size:n.size});continue}const i=e.match(/_(\d{8})(?:\.|_)/);if(i&&i[1]){const e=`${i[1].slice(0,4)}-${i[1].slice(4,6)}-${i[1].slice(6,8)} 00:00:00`,l=new Date(e).getTime();if(l+864e5<a)continue;if(l>t)continue}else if(n.lastModified<a||n.lastModified>t)continue;!Bl.value[e]&&Date.now()-n.lastModified<5184e6&&s.push({handle:v,name:e,size:n.size})}if(0===s.length)return Ol.value=!1,void(D.value=!1);s.sort((e,l)=>e.name.localeCompare(l.name));const c=10;M.value=[],A.value=s.map(e=>({name:e.name,size:e.size}));let d=0;for(let e=0;e<s.length;e+=c){const a=s.slice(e,e+c).map(async e=>{const a=await e.handle.getFile(),t=await a.text(),{records:n,players:c,items:v}=await Fa(t);for(const l of n)i.has(l.key)||ue.value.has(l.key)||(i.add(l.key),o.push(l));c.forEach(e=>r.add(e)),v.forEach(e=>u.add(e)),e.name.includes(l)||(Bl.value[e.name]={size:a.size,mtime:a.lastModified}),d++,R.value=Math.round(d/s.length*100),M.value.push({name:e.name,size:e.size}),M.value.sort((e,l)=>e.name.localeCompare(l.name)),A.value=A.value.filter(l=>l.name!==e.name)});await Promise.all(a),await new Promise(e=>setTimeout(e,0))}if(o.length>0){await y.bulkSet(JSON.parse(JSON.stringify(o))),I.value.push(...o),F.value=i,Tn(o,"sync");let e=!1;const l={...de.value},a={...il.value};if(u.forEach(a=>{void 0===l[a]&&(l[a]=!0,e=!0)}),r.forEach(l=>{void 0===a[l]&&(a[l]=!0,e=!0)}),e&&(de.value=l,il.value=a),n||ge.success({message:`同步完成，新增 ${o.length} 条记录`,showClose:!0}),n){new Set(I.value.filter(e=>Pl.test(e.item)).map(e=>e.item)).size>=12&&(Rl.value=!0),oa.value||ge.warning({message:"解析成功，请先在「固定队 - 职位设置」中完成所有职位的设置，以开启更多功能。",duration:1e4,showClose:!0})}}Cl.value=me.value.name}catch(l){}finally{Ol.value=!1,D.value=!1,R.value=0}}function Fa(e){return new Promise((l,a)=>{const t=new cl;t.onmessage=e=>{l(e.data),t.terminate()},t.onerror=e=>{a(e),t.terminate()},t.postMessage(e)})}function Ja(e){if(Fl.value.cards&&e.startsWith("九宫幻卡"))return!0;if(Fl.value.materia&&e.includes("魔晶石"))return!0;if(Fl.value.music&&(e.startsWith("管弦乐琴乐谱")||e.startsWith("陈旧的乐谱")))return!0;if(Fl.value.book&&e.endsWith("断章"))return!0;if(Fl.value.totem&&e.endsWith("图腾"))return!0;if(Fl.value.other&&e.includes("经验值"))return!0;if(!Pl.test(e)){const l=e.match(Ll);if(l?.groups?.series&&Fl.value.maskedSeries?.includes(l.groups.series))return!0}return!1}function Ya(e){return Rl.value?Pl.test(e):!1!==de.value[e]}function Ha(e){return!1!==il.value[e]}function Ka(e,l){e.ctrlKey?zn(l):e.altKey?Kn("item",l):Rl.value||function(e){const l=!1!==de.value[e];de.value[e]=!l}(l)}function Xa(e,l){const a=Rn(l)||l,t=(rl.value.playerBis||{})[a]||{};if("count"===e.type&&0===t[e.id])return 0;if(q(e,t))return"count"===e.type?t[e.id]||0:1;const s="toggle"===e.type&&"weapon"!==e.id,n="twine"===e.id||"coating"===e.id||"solvent"===e.id||"tome"===e.id;return s||n?1:0}function Ga(e,l){if(!e)return;if(Object.entries(Jl.value).some(([a,t])=>a.startsWith(l+":")&&t===e))return;let a=1,t=`${l}:${a}`;for(;Jl.value[t];)a++,t=`${l}:${a}`;Jl.value[t]=e}function Qa(e,l,a){const t=Rn(e),s=Rn(l),n=e=>e?j.includes(e)?j.indexOf(e):e.startsWith("SUB:")?100:e.startsWith("LEFT:")?200:500:999,i=n(t),o=n(s);if(i!==o)return i-o;const r=a||ta.value,u=r[e]||0,c=r[l]||0;return u!==c?c-u:e.localeCompare(l)}function Za(e,l){const a=Sl.value,t=L.find(e=>e.name===l||e.keywords===l);if(!t)return Object.keys(e||{}).sort((l,a)=>Qa(l,a,e||{}));const s=Object.entries(Jl.value).filter(([e,l])=>l&&!e.startsWith("LEFT:")).map(([e,l])=>l),n=Array.from(new Set([...Object.keys(e||{}),...s])),i=[];return n.forEach(l=>{const n=Rn(l),o=n?.startsWith("LEFT:")||n?.startsWith("SUB:");if("needed"===a&&o)return;const r=e?.[l]||0,u=Xa(t,l);"all"===a?(r>0||s.includes(l))&&i.push(l):"obtained"===a?r>0&&i.push(l):"needed"===a&&!o&&r<u&&i.push(l)}),i.sort((l,a)=>Qa(l,a,e||{}))}function et(e,l,a){const t=L.find(e=>e.name===l||e.keywords===l);if(!t){const e=l.startsWith(v)&&Pl.test(l);return{count:a,isRandomWeapon:e,layerName:e?"4层":void 0}}const s=Rn(e);if(!(s&&j.includes(s)))return{count:a,layerName:U.find(e=>e.items.includes(t.id))?.name};const n=(rl.value.playerBis||{})[s]||{},i=void 0!==n[t.id],o=Xa(t,e),r=q(t,n),u=U.find(e=>e.items.includes(t.id));return{count:a,isBis:i?r:void 0,isBisFalse:!r&&o>0,layerName:u?.name}}function lt(e){const l=wa.value[e]||{},a={},t=new Set;L.forEach(e=>{a[e.id]=0,Object.entries(l).forEach(([l,s])=>{const n=s||0;l.includes(e.keywords)&&(a[e.id]=(a[e.id]||0)+n,t.add(l))})});const s=[],n=Rn(e),i=n&&j.includes(n),o=(rl.value?.playerBis||{})[n||e]||{};L.forEach(l=>{const t=a[l.id],n=Xa(l,e);let r=!1;const u=t||0;if(("all"===wl.value||u>0||"needed"===wl.value&&u<n)&&(r=!0),r){const e=U.find(e=>e.items.includes(l.id));s.push({name:l.keywords||l.name,count:u,isBis:i&&void 0!==o[l.id]?n>0:void 0,id:l.id,layerName:e?e.name:void 0})}});const r=W(rl.value,Rn(e)||e);Object.entries(l).forEach(([e,l])=>{if(!t.has(e)){const a=e.startsWith(v)&&Pl.test(e);s.push({name:e,count:l,isRandomWeapon:a,isBis:(a||!i||!r)&&void 0,layerName:a?"4层":void 0})}});const u=ul.value;return s.sort((e,l)=>{const a=ga(e.id&&L.find(l=>l.id===e.id)?.keywords||e.name,u),t=ga(l.id&&L.find(e=>e.id===l.id)?.keywords||l.name,u);return a!==t?a-t:e.name.localeCompare(l.name)}),"obtained"===wl.value?s.filter(e=>e.count>0):"needed"===wl.value?s.filter(e=>0===e.count):s}function Rn(e){for(const[l,a]of Object.entries(Jl.value))if(a===e)return l}function Mn(e,l){var a;e.ctrlKey?zn(l):e.altKey?Kn("player",l):Tl.value||(a=l,il.value[a]=!(!1!==il.value[a]))}async function Tn(e,l){const a=function(e){const l=I.value.filter(e=>e.isManual);if(0===l.length)return[];const a=[],t=new Map;return e.forEach(e=>{if(e.isManual)return;const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`;t.has(l)||t.set(l,new Set),t.get(l).add(gl(e.player))}),l.forEach(e=>{const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`,s=t.get(l);s&&s.has(gl(e.player))&&a.push(e)}),a}(e);if(0===a.length)return;const t="sync"===l?"同步的日志":"导入的数据";try{await he.confirm(`在${t}中发现了 ${a.length} 条与现有手动记录重合的数据（同日期、同玩家、同物品）。<br/><br/>是否删除这些手动记录，以真实的解析数据为准？`,"发现重复记录",{confirmButtonText:"删除手动记录",cancelButtonText:"全部保留",type:"info",dangerouslyUseHTMLString:!0});for(const e of a)await Wa(e,!0);ge.success(`已清理 ${a.length} 条手动记录`)}catch{}}async function zn(e){try{await navigator.clipboard.writeText(e),ge.success({message:`已复制: ${e}`,duration:1500,showClose:!0})}catch(l){ge.error({message:"复制失败",showClose:!0})}}function Pn(){sl.value={timestamp:(new Date).toISOString(),item:"",player:""},fe.value=!0}function Un(e,l){l(Array.from(ya.value).filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}function Ln(e,l){l(sa.value.filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}async function Nn(){const e=sl.value.item.trim(),l=sl.value.player.trim();if(!sl.value.timestamp||!e||!l)return void ge.error("请填写完整信息");const a=!ya.value.includes(e),t=!sa.value.includes(l);if(a||t){let s="";s=a&&t?`物品 "<b>${e}</b>" 和 玩家 "<b>${l}</b>" 都是第一次出现。`:a?`物品 "<b>${e}</b>" 是第一次出现。`:`玩家 "<b>${l}</b>" 是第一次出现。`;try{await he.confirm(`${s}<br/><br/>确定要以此名称创建记录吗？请检查是否有错别字。`,"发现新条目",{confirmButtonText:"确定创建",cancelButtonText:"返回修改",type:"warning",dangerouslyUseHTMLString:!0})}catch{return}}const s=new Date(sl.value.timestamp),n={key:`manual-${s.getTime()}-${Math.random().toString(36).slice(2)}`,timestamp:s,item:e,player:l,rolls:[],isManual:!0};await y.set(JSON.parse(JSON.stringify(n))),void 0===de.value[n.item]&&(de.value[n.item]=!0),void 0===il.value[gl(n.player)]&&(il.value[gl(n.player)]=!0),I.value=[...I.value,n],fe.value=!1,ge.success({message:`已添加: ${n.item} - ${n.player}`,showClose:!0})}const jn=m(null);function Wn(e){"clear"===e?he.confirm('确定清空所有掉落记录？此操作不可恢复。<br/><small style="color: #64748b">注意：此操作仅清空<b>掉落历史</b>。您的 BIS 配置、固定队角色设置及人员映射将全部保留。</small>',"警告",{confirmButtonText:"确定清空",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0}).then(()=>{!async function(){await y.clear(),I.value=[],F.value.clear(),Bl.value={},ol.value={},ge.success({message:"数据库已清空",showClose:!0})}()}).catch(()=>{}):"export"===e?Qe.value=!0:"import"===e?jn.value?.click():"manual"===e&&Pn()}async function An(){try{const e=new Set,l=new Set;let a=Date.now();I.value.forEach(t=>{e.add(t.item),l.add(t.player);const s=t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp;s<a&&(a=s),t.rolls&&t.rolls.forEach(e=>l.add(e.player))});const t=Array.from(e),s=Array.from(l),n=new Map(t.map((e,l)=>[e,l])),i=new Map(s.map((e,l)=>[e,l])),o=new Map(["need","greed","assign","direct","manual"].map((e,l)=>[e,l])),r={v:4,base:a,dicts:{i:t,p:s},r:el.value.loot?I.value.map(e=>{const l=[(e.timestamp instanceof Date?e.timestamp.getTime():e.timestamp)-a,n.get(e.item),i.get(e.player),e.key];return e.rolls&&e.rolls.length>0?(l.push(e.rolls.length),e.rolls.forEach(e=>{l.push(i.get(e.player)),l.push(e.value),l.push(o.get(e.type)??0)})):l.push(0),l}):[]},u={};el.value.mapping&&(u.map=fl.value),el.value.roles&&(u.roles=Jl.value),el.value.bis&&(u.bisConfig=rl.value),u.filter=Fl.value,u.raidActive=Tl.value,u.weekCorrections=ol.value,r.c=u;const c=new Blob([JSON.stringify(r)],{type:"application/json"}),d=URL.createObjectURL(c),v=document.createElement("a");v.href=d,v.download=`ff14_loot_backup_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(d),Qe.value=!1,ge.success({message:"数据已导出",showClose:!0})}catch(e){ge.error({message:"导出失败",showClose:!0})}}async function In(e){try{if(!e.r||!Array.isArray(e.r))return void ge.error({message:"无效的备份文件格式",showClose:!0});const l=!!e.r?.length,a=!!(e.c?.bisConfig||e.bisConfig||e.c?.bis),t=!!e.c?.roles&&Object.keys(e.c.roles).length>0,s=!!e.c?.map&&Object.keys(e.c.map).length>0,n=!rl.value||!rl.value.playerBis||0===Object.keys(rl.value.playerBis).length,i=0===Object.keys(Jl.value).length,o=0===Object.keys(fl.value).length;let r=0;if(l){const l=new Set(I.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(I.value.map(e=>e.key)),t=e.base||0,s=e.dicts?.i||[],n=e.dicts?.p||[];for(const i of e.r){const e=t+i[0],o=s[i[1]],u=n[i[2]],c=i[3];if(!o||!u)continue;const d=c&&"string"==typeof c?c:`${e}_${o}_${u}`;if(a.has(d)||ue.value.has(d))continue;const v=`${e}|${o}|${u}`;l.has(v)||r++}}const u=e.c?.bisConfig||e.bisConfig||e.c?.bis;al.value={loot:l&&r>0,bis:a&&JSON.stringify(rl.value?.playerBis||{})!==JSON.stringify(u?.playerBis||u||{}),roles:t&&JSON.stringify(Jl.value)!==JSON.stringify(e.c.roles),mapping:s&&JSON.stringify(fl.value)!==JSON.stringify(e.c.map)},ll.value={loot:al.value.loot,bis:a&&n&&al.value.bis,roles:t&&i&&al.value.roles,mapping:s&&o&&al.value.mapping},tl.value=e,Ze.value=!0}catch(l){ge.error({message:"解析出错",showClose:!0})}}async function Fn(){const e=tl.value;if(e)try{const l=ge({message:"正在导入数据...",duration:0,type:"info",showClose:!0});if(e.c){if(ll.value.mapping&&e.c.map&&(fl.value={...fl.value,...e.c.map}),ll.value.roles&&e.c.roles&&(Jl.value={...Jl.value,...e.c.roles}),ll.value.bis){const l=e.c.bisConfig||e.bisConfig;l&&(rl.value=l)}e.c.filter&&(Fl.value={...Fl.value,...e.c.filter}),void 0!==e.c.raidActive&&(Tl.value=e.c.raidActive),e.c.weekCorrections&&(ol.value={...ol.value,...e.c.weekCorrections})}if(ll.value.loot&&e.r&&e.r.length>0){const l=new Set(I.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(I.value.map(e=>e.key)),t=[],s=e.base||0,n=e.dicts?.i||[],i=e.dicts?.p||[],o=["need","greed","assign","direct","manual"];for(const r of e.r){const e=s+r[0],u=n[r[1]],c=i[r[2]],d=r[3],v=r[4],p=[];if(v>0){let e=5;for(let l=0;l<v&&!(e+2>=r.length);l++)p.push({player:i[r[e]],value:r[e+1],type:o[r[e+2]]||"need"}),e+=3}if(!u||!c)continue;const m=d&&"string"==typeof d?d:`${e}_${u}_${c}_${Math.random().toString(36).slice(2)}`;if(a.has(m)||ue.value.has(m))continue;const y=`${e}|${u}|${c}`;l.has(y)||(t.push({key:m,timestamp:new Date(e),item:u,player:c,rolls:p,source:"import",id:""}),l.add(y),a.add(m))}t.length>0&&(await y.bulkSet(JSON.parse(JSON.stringify(t))),I.value=[...I.value,...t].sort((e,l)=>new Date(l.timestamp).getTime()-new Date(e.timestamp).getTime()),F.value=new Set(I.value.map(e=>e.key)),Tn(t,"import"),ge.success({message:`成功导入 ${t.length} 条新记录`,showClose:!0}))}l.close(),Ze.value=!1,tl.value=null}catch(l){ge.error({message:"导入失败",showClose:!0})}}function Jn(e){const l=new FileReader;l.onload=async e=>{try{const l=JSON.parse(e.target?.result);await In(l)}catch(l){ge.error({message:"文件解析失败",showClose:!0})}},l.readAsText(e)}function Yn(e){const l=e.target;l.files&&0!==l.files.length&&(Jn(l.files[0]),l.value="")}const Hn=m(null);function Kn(e,l){const a="item"===e,t=a?de:il,s=a?ya:sa;if(Hn.value?.type===e&&Hn.value.key===l)return t.value={...Hn.value.snapshot},Hn.value=null,void ge.info({message:"已恢复到独显前的状态",duration:2e3,showClose:!0});let n=t.value;Hn.value?.type===e&&(n=Hn.value.snapshot),Hn.value={type:e,key:l,snapshot:JSON.parse(JSON.stringify(n))};const i={};s.value.forEach(e=>{i[e]=e===l}),t.value=i,ge.success({message:`仅显示: ${l} (再次 Alt+点击 恢复)`,duration:2e3})}function Xn(e){const l=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${e.getFullYear()}/${l}/${a} ${t}:${s}`}function qn(e){return 0===e?"0 MB":(e/1048576).toFixed(2)+" MB"}function Gn(e){const l=e.rolls.find(l=>l.player===e.player);if(l)return l;if(e.player){const l=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:e.player,type:l,value:null}}return null}return(e,t)=>{const v=l,m=Q,y=ee,f=ke,S=te,V=se,O=le,B=ne,T=we,z=Ue,P=Le,U=We,L=Ae,N=je,W=Ie,F=Ne,J=_e;return i(),s("div",{class:r(["app-container",{"is-onboarding":!me.value||nl.value||0===I.value.length}])},[c(x,{name:"fade"},{default:h(()=>[E.value?(i(),s("div",tt,[...t[58]||(t[58]=[d("div",{class:"loading-card"},[d("div",{class:"spinner-large"}),d("div",{class:"loading-title"},"正在准备数据..."),d("p",{class:"loading-subtitle"},"初次加载可能需要一些时间")],-1)])])):n("",!0)]),_:1}),d("div",st,[c(v,{"storage-key":"loot-history-theme"})]),E.value?n("",!0):(i(),s(k,{key:0},[c(x,{name:"fade"},{default:h(()=>[D.value?(i(),s("div",nt,[d("div",it,[d("div",ot,[t[59]||(t[59]=d("div",{class:"spinner-small"},null,-1)),d("span",rt,"解析中... "+u(R.value)+"%",1)]),d("div",ut,[d("div",ct,[d("div",dt," 已完成 ("+u(M.value.length)+") ",1),d("div",vt,[c(C,{name:"list"},{default:h(()=>[(i(!0),s(k,null,w(M.value,e=>(i(),s("div",{key:e.name,class:"file-item done"},[d("div",pt,[c(m,null,{default:h(()=>[c(p(Se))]),_:1}),d("span",{class:"file-name",title:e.name},u(e.name),9,mt)]),d("span",yt,u(qn(e.size)),1)]))),128))]),_:1})])]),t[60]||(t[60]=d("div",{class:"list-divider"},null,-1)),d("div",ft,[d("div",gt," 待处理 ("+u(A.value.length)+") ",1),d("div",ht,[(i(!0),s(k,null,w(A.value.slice(0,50),e=>(i(),s("div",{key:e.name,class:"file-item pending"},[d("div",bt,[c(m,null,{default:h(()=>[c(p(Ve))]),_:1}),d("span",{class:"file-name",title:e.name},u(e.name),9,kt)]),d("span",wt,u(qn(e.size)),1)]))),128)),A.value.length>50?(i(),s("div",_t," ...还有 "+u(A.value.length-50)+" 个文件 ",1)):n("",!0)])])])])])):n("",!0)]),_:1}),I.value.length>0?(i(),s("main",St,[d("div",Vt,[Yl.value?(i(),s("div",{key:0,class:r(["drag-guide-zone",{"is-active":Hl.value}]),onDrop:_(Ql,["stop","prevent"]),onDragover:t[0]||(t[0]=_(()=>{},["prevent"])),onDragenter:t[1]||(t[1]=e=>Hl.value=!0),onDragleave:t[2]||(t[2]=e=>Hl.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(xe))]),_:1}),t[61]||(t[61]=d("span",null,"释放文件以导入备份",-1))],34)):n("",!0),d("div",xt,[c(y,{type:Ml.value?"warning":"primary",size:"small",loading:Ol.value,onClick:Ia},{default:h(()=>[b(u(Ol.value?"同步中":Ml.value?"需要同步":"立即同步")+" ",1),Ml.value?(i(),s("span",Ct)):n("",!0)]),_:1},8,["type","loading"]),c(f,{modelValue:El.value,"onUpdate:modelValue":t[3]||(t[3]=e=>El.value=e),type:"datetime",size:"small",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1,class:"date-picker-el"},null,8,["modelValue"]),t[77]||(t[77]=d("span",{class:"range-sep"},"-",-1)),c(f,{modelValue:Dl.value,"onUpdate:modelValue":t[4]||(t[4]=e=>Dl.value=e),type:"datetime",size:"small",placeholder:"截止时间(可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:"",class:"date-picker-el"},null,8,["modelValue"]),c(y,{onClick:ja,plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Ce))]),_:1}),t[62]||(t[62]=d("span",null,"日志目录",-1))]),_:1}),t[78]||(t[78]=d("div",{class:"v-divider"},null,-1)),c(y,{onClick:Pn,plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p($e))]),_:1}),t[63]||(t[63]=d("span",null,"手动添加",-1))]),_:1}),c(O,{trigger:"click",onCommand:Wn},{dropdown:h(()=>[c(V,null,{default:h(()=>[c(S,{command:"import"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Oe))]),_:1}),t[65]||(t[65]=b("导入备份 (JSON) ",-1))]),_:1}),c(S,{command:"export"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Be))]),_:1}),t[66]||(t[66]=b("导出备份 (JSON) ",-1))]),_:1}),c(S,{command:"clear",divided:"",style:{color:"#f56c6c"}},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Ee))]),_:1}),t[67]||(t[67]=b("清空数据库 ",-1))]),_:1})]),_:1})]),default:h(()=>[c(y,{plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Z))]),_:1}),t[64]||(t[64]=d("span",null,"数据管理",-1)),c(m,{class:"el-icon--right"},{default:h(()=>[c(p(ae))]),_:1})]),_:1})]),_:1}),t[79]||(t[79]=d("div",{class:"v-divider"},null,-1)),c(B,{placement:"bottom-end",width:480,trigger:"click","popper-class":"guide-popover-popper"},{reference:h(()=>[c(y,{plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(ie))]),_:1}),t[68]||(t[68]=d("span",null,"使用指南",-1))]),_:1})]),default:h(()=>[d("div",$t,[d("section",Ot,[d("h4",null,[c(m,null,{default:h(()=>[c(p(ce))]),_:1}),t[69]||(t[69]=b(" 这是什么？ ",-1))]),t[70]||(t[70]=d("p",null,[b(" 这是一个专门为 FFXIV 固定队设计的"),d("strong",null,"掉落历史统计"),b("与 "),d("strong",null,"BIS 分配管理"),b("工具。它能自动从你的 ACT 日志中记录战利品信息，并以此为基础提供自动化的分配建议与数据分析。 ")],-1))]),d("section",Bt,[d("h4",null,[c(m,null,{default:h(()=>[c(p(De))]),_:1}),t[71]||(t[71]=b(" 注意事项 ",-1))]),t[72]||(t[72]=d("div",{class:"warning-box"},[d("ul",null,[d("li",null,[d("strong",null,"保持 ACT 运行："),b("且未勾选“隐藏聊天日志(隐私保护)”。 ")]),d("li",null,[d("strong",null,"请勿提前退本："),b(" 一定要等装备分完了再退本！以保证日志完整。 ")])])],-1))]),d("section",Et,[d("h4",null,[c(m,null,{default:h(()=>[c(p(Re))]),_:1}),t[73]||(t[73]=b(" 快速上手 ",-1))]),t[74]||(t[74]=d("ol",null,[d("li",null,[d("strong",null,"配置人员："),b(" 在左上方“固定队 - 职位设置”中绑定队员 ID。 ")]),d("li",null,[d("strong",null,"BIS 规划："),b(" 切换至“BIS分配”页签，录入全队成员的毕业装备需求。 ")]),d("li",null,[d("strong",null,"一键分配："),b(" 副本结束后，可参考“BIS分配”页签的建议进行分配。 ")])],-1))]),d("section",Dt,[d("h4",null,[c(m,null,{default:h(()=>[c(p(Me))]),_:1}),t[75]||(t[75]=b(" 漏了记录怎么办？ ",-1))]),t[76]||(t[76]=d("p",null,[b(" 如果因意外（如掉线、忘开 ACT 等）漏掉记录，请点击主界面右上角的“"),d("strong",null,"手动添加"),b("”补全。手动添加的记录也会参与 BIS 统计与分配计算。 ")],-1))])])]),_:1})])]),d("div",Rt,[d("div",Mt,[d("div",Tt,[d("div",zt,[d("span",Pt,"👥 玩家 ("+u(ba.value)+")",1),t[85]||(t[85]=d("div",{class:"header-sep"},null,-1)),c(B,{placement:"bottom",width:360,trigger:"click","popper-class":"role-settings-popper"},{reference:h(()=>[c(y,{size:"small",class:"soft-action-btn primary"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(oe))]),_:1}),t[80]||(t[80]=d("span",null,"固定队 - 职位设置",-1)),oa.value?n("",!0):(i(),s("span",Ut))]),_:1})]),default:h(()=>[d("div",Lt,[d("div",Nt,[(i(!0),s(k,null,w(p(j),e=>(i(),s("div",{key:e,class:"role-setup-item"},[d("div",jt,[c(vl,{role:e},null,8,["role"])]),c(p(Te),{modelValue:Jl.value[e],"onUpdate:modelValue":l=>Jl.value[e]=l,placeholder:"选择/输入玩家",filterable:"","allow-create":"","default-first-option":"",clearable:"",size:"small",style:{flex:"1"},teleported:!1},{default:h(()=>[(i(!0),s(k,null,w(pa.value.filter(l=>l===Jl.value[e]||!ia.value.has(l)),e=>(i(),g(p(ze),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128))]),t[83]||(t[83]=d("div",{class:"role-divider"},"特殊分组",-1)),d("div",Wt,[d("div",At,[t[81]||(t[81]=d("div",{class:"group-title"},"临时替补",-1)),d("div",It,[(i(!0),s(k,null,w(Jl.value,(e,l)=>(i(),s(k,{key:l},[l.startsWith("SUB:")?(i(),s("div",Ft,[c(p(Pe),{closable:"",onClose:e=>delete Jl.value[l]},{default:h(()=>[b(u(e),1)]),_:2},1032,["onClose"])])):n("",!0)],64))),128)),c(p(Te),{placeholder:"添加/输入替补",filterable:"","allow-create":"","default-first-option":"",size:"small",onChange:t[5]||(t[5]=e=>Ga(e,"SUB")),value:"",style:{width:"120px"},teleported:!1},{default:h(()=>[(i(!0),s(k,null,w(pa.value.filter(e=>!ia.value.has(e)),e=>(i(),g(p(ze),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])]),d("div",Jt,[t[82]||(t[82]=d("div",{class:"group-title"},"已离队",-1)),d("div",Yt,[(i(!0),s(k,null,w(Jl.value,(e,l)=>(i(),s(k,{key:l},[l.startsWith("LEFT:")?(i(),s("div",Ht,[c(p(Pe),{closable:"",onClose:e=>delete Jl.value[l]},{default:h(()=>[b(u(e),1)]),_:2},1032,["onClose"])])):n("",!0)],64))),128)),c(p(Te),{placeholder:"添加/输入离队",filterable:"","allow-create":"","default-first-option":"",size:"small",onChange:t[6]||(t[6]=e=>Ga(e,"LEFT")),value:"",style:{width:"120px"},teleported:!1},{default:h(()=>[(i(!0),s(k,null,w(pa.value.filter(e=>!ia.value.has(e)),e=>(i(),g(p(ze),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])])])])]),_:1}),t[86]||(t[86]=d("div",{class:"header-sep"},null,-1)),c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[d("label",Kt,[c(p(be),{modelValue:Nl.value,"onUpdate:modelValue":t[7]||(t[7]=e=>Nl.value=e),disabled:!oa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6","--el-switch-off-color":"#cbd5e1"}},null,8,["modelValue","disabled"]),d("span",{class:"switch-label",style:o({opacity:oa.value?1:.5})},"只显示职位",4)])]),_:1},8,["disabled"]),t[87]||(t[87]=d("div",{class:"header-sep"},null,-1)),c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[d("div",Xt,[c(p(be),{modelValue:Tl.value,"onUpdate:modelValue":t[8]||(t[8]=e=>Tl.value=e),disabled:!oa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue","disabled"]),d("span",{class:"switch-label",style:o({opacity:oa.value?1:.5,fontSize:"12px"})}," 只看固定队 ",4)])]),_:1},8,["disabled"]),Tl.value?n("",!0):(i(),s("div",qt)),Tl.value?n("",!0):(i(),s("label",Gt,[c(p(be),{modelValue:Il.value,"onUpdate:modelValue":t[9]||(t[9]=e=>Il.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),t[84]||(t[84]=d("span",{class:"switch-label"},"隐藏无记录玩家",-1))]))]),d("div",Qt,[c(B,{placement:"bottom",width:320,trigger:"click"},{reference:h(()=>[c(y,{size:"small",class:"soft-action-btn"},{default:h(()=>[...t[88]||(t[88]=[b("合并大小号",-1)])]),_:1})]),default:h(()=>[d("div",Zt,[d("div",es,[t[89]||(t[89]=d("div",{class:"selector-title"},"选择两个玩家进行合并：",-1)),d("div",ls,[(i(!0),s(k,null,w(ua.value,e=>(i(),g(z,{key:e,checked:hl.value.includes(e),onChange:l=>function(e){hl.value.includes(e)?hl.value=hl.value.filter(l=>l!==e):(hl.value.length>=2&&hl.value.shift(),hl.value.push(e))}(e)},{default:h(()=>[b(u(e),1)]),_:2},1032,["checked","onChange"]))),128))]),2===hl.value.length?(i(),s("div",as,[c(y,{type:"primary",size:"small",onClick:kl,style:{width:"100%"}},{default:h(()=>[b(" 确认合并: "+u(hl.value[0])+" -> "+u(hl.value[1]),1)]),_:1})])):n("",!0)]),aa.value.length>0?(i(),s("div",ts,[t[90]||(t[90]=d("div",{class:"suggest-title"}," 💡 发现疑似换号 (>90% 重合)： ",-1)),d("div",ss,[(i(!0),s(k,null,w(aa.value,e=>(i(),g(y,{key:e.from+e.to,size:"small",plain:"",class:"suggest-btn",onClick:l=>Vl(e.from,e.to)},{default:h(()=>[b(u(e.from)+" → "+u(e.to)+" ",1),d("span",ns,"("+u(e.confidence)+"%)",1)]),_:2},1032,["onClick"]))),128))])])):n("",!0),Object.keys(fl.value).length>0?(i(),s("div",is,[t[91]||(t[91]=d("div",{class:"selector-title"},"当前合并映射:",-1)),d("div",os,[(i(!0),s(k,null,w(fl.value,(e,l)=>(i(),g(p(Pe),{key:l,closable:"",size:"small",type:"info",onClose:e=>function(e){const l={...fl.value};delete l[e],fl.value=l}(l)},{default:h(()=>[b(u(l)+" → "+u(e),1)]),_:2},1032,["onClose"]))),128))])])):n("",!0)])]),_:1}),t[92]||(t[92]=d("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示",-1))])]),d("div",rs,[Tl.value?(i(),s("div",us)):n("",!0),(i(!0),s(k,null,w(da.value,e=>(i(),g(z,{key:e,checked:Ha(e),class:r([{"readonly-tag":Tl.value},"mini-tag-el player-tag"]),onClick:_(l=>Mn(l,e),["stop"])},{default:h(()=>[c(ml,{name:e,role:Rn(e),"show-only-role":Nl.value},null,8,["name","role","show-only-role"])]),_:2},1032,["checked","class","onClick"]))),128))])]),d("div",cs,[d("div",ds,[d("div",vs,[d("span",ps,"📦 物品 ("+u(ha.value)+")",1),d("label",ms,[c(p(be),{modelValue:Rl.value,"onUpdate:modelValue":t[10]||(t[10]=e=>Rl.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),t[93]||(t[93]=d("span",{class:"switch-label"},"只看零式掉落",-1))]),t[97]||(t[97]=d("div",{class:"header-sep"},null,-1)),c(B,{placement:"bottom-start",width:220,trigger:"click"},{reference:h(()=>[c(y,{size:"small",class:"soft-action-btn primary"},{default:h(()=>[c(m,{style:{"margin-right":"4px"}},{default:h(()=>[c(p(Z))]),_:1}),t[94]||(t[94]=b(" 杂物屏蔽设置 ",-1))]),_:1})]),default:h(()=>[d("div",ys,[t[96]||(t[96]=d("div",{class:"pop-title"},"屏蔽杂物 (非零式模式下生效)",-1)),d("div",{class:"filter-list",style:o({opacity:Rl.value?.5:1,pointerEvents:Rl.value?"none":"auto"})},[c(p(re),{modelValue:Fl.value.cards,"onUpdate:modelValue":t[11]||(t[11]=e=>Fl.value.cards=e),label:"九宫幻卡",size:"small"},null,8,["modelValue"]),c(p(re),{modelValue:Fl.value.materia,"onUpdate:modelValue":t[12]||(t[12]=e=>Fl.value.materia=e),label:"魔晶石",size:"small"},null,8,["modelValue"]),c(p(re),{modelValue:Fl.value.music,"onUpdate:modelValue":t[13]||(t[13]=e=>Fl.value.music=e),label:"乐谱",size:"small"},null,8,["modelValue"]),c(p(re),{modelValue:Fl.value.book,"onUpdate:modelValue":t[14]||(t[14]=e=>Fl.value.book=e),label:"零式断章",size:"small"},null,8,["modelValue"]),c(p(re),{modelValue:Fl.value.totem,"onUpdate:modelValue":t[15]||(t[15]=e=>Fl.value.totem=e),label:"极神图腾",size:"small"},null,8,["modelValue"]),c(p(re),{modelValue:Fl.value.other,"onUpdate:modelValue":t[16]||(t[16]=e=>Fl.value.other=e),label:"经验值/金币",size:"small"},null,8,["modelValue"]),na.value.length>0?(i(),s(k,{key:0},[t[95]||(t[95]=d("div",{class:"pop-title",style:{margin:"8px 0 4px","padding-top":"8px"}}," 屏蔽装备系列 ",-1)),c(P,{modelValue:Fl.value.maskedSeries,"onUpdate:modelValue":t[17]||(t[17]=e=>Fl.value.maskedSeries=e),style:{display:"flex","flex-direction":"column",gap:"4px"}},{default:h(()=>[(i(!0),s(k,null,w(na.value,e=>(i(),g(p(re),{key:e,label:e,size:"small"},{default:h(()=>[b(u(e)+"系列 ",1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])],64)):n("",!0)],4)])]),_:1})]),t[98]||(t[98]=d("div",{class:"acts"},[d("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示")],-1))]),d("div",fs,[Rl.value?(i(),s("div",gs)):n("",!0),(i(!0),s(k,null,w(ma.value,e=>(i(),g(z,{key:e,checked:Ya(e),class:r([{"readonly-tag":Rl.value},"mini-tag-el item-tag"]),onClick:_(l=>Ka(l,e),["stop"])},{default:h(()=>[b(u(e),1)]),_:2},1032,["checked","class","onClick"]))),128))])])]),d("div",hs,[ka.value.length>0?(i(),g(J,{key:0,modelValue:pe.value,"onUpdate:modelValue":t[28]||(t[28]=e=>pe.value=e),class:"mode-tabs-el",type:"card"},{default:h(()=>[c(F,{label:"详细记录",name:"list"},{default:h(()=>[d("div",bs,[c(N,{data:La.value,style:{width:"100%"},class:"loot-record-table","cell-class-name":"loot-cell"},{default:h(()=>[c(U,{label:"周",width:"60",align:"center"},{default:h(e=>[d("div",ks," W"+u(p(G)(e.row.timestamp,a)),1)]),_:1}),c(U,{label:"时间",width:"140"},{default:h(e=>[d("div",ws,[d("span",_s,u(Xn(e.row.timestamp)),1)])]),_:1}),c(U,{label:"物品",width:"300"},{default:h(e=>[d("div",Ss,[d("span",Vs,u(e.row.item),1)])]),_:1}),c(U,{label:"获得者",width:"200"},{default:h(e=>[Gn(e.row)?(i(),g(bl,{key:0,roll:Gn(e.row),"is-winner":"","show-only-role":Nl.value,"get-player-role":Rn},null,8,["roll","show-only-role"])):(i(),s("div",xs,"未分配"))]),_:1}),c(U,{label:"其他 Roll 点记录"},{default:h(e=>{return[d("div",Cs,[(i(!0),s(k,null,w((l=e.row,l.rolls.filter(e=>e.player!==l.player).sort((e,l)=>{const a={need:0,greed:1},t=a[e.type]??3,s=a[l.type]??3;return t!==s?t-s:(l.value||0)-(e.value||0)})),e=>(i(),g(bl,{key:e.player,roll:e,"show-only-role":Nl.value,"get-player-role":Rn},null,8,["roll","show-only-role"]))),128))])];var l}),_:1}),c(U,{label:"操作",width:"60",align:"center"},{default:h(e=>[c(L,{title:"确定永久删除吗？","confirm-button-text":"删除","cancel-button-text":"取消",onConfirm:l=>Wa(e.row)},{reference:h(()=>[c(y,{type:"danger",icon:p(Ee),size:"small",circle:"",plain:""},null,8,["icon"])]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"]),d("div",$s,[c(W,{"current-page":xl.value,"onUpdate:currentPage":t[18]||(t[18]=e=>xl.value=e),"page-size":50,layout:"total, prev, pager, next",total:ka.value.length,small:""},null,8,["current-page","total"])])])]),_:1}),c(F,{name:"summary",disabled:!oa.value},{label:h(()=>[c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[...t[99]||(t[99]=[d("span",null,"按玩家",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",Os,[c(_l,{modelValue:ul.value,"onUpdate:modelValue":t[19]||(t[19]=e=>ul.value=e)},null,8,["modelValue"]),t[100]||(t[100]=d("div",{class:"v-divider-mini"},null,-1)),c(jl,{modelValue:wl.value,"onUpdate:modelValue":t[20]||(t[20]=e=>wl.value=e)},null,8,["modelValue"])]),d("div",Bs,[(i(!0),s(k,null,w(ca.value,e=>(i(),s("div",{key:e,class:"summary-card"},[d("div",Es,[c(ml,{name:e,role:Rn(e),"show-only-role":Nl.value},null,8,["name","role","show-only-role"])]),d("div",null,[(i(!0),s(k,null,w(lt(e),e=>(i(),s("div",{key:e.name,class:r(["summary-item",{"is-not-obtained":0===e.count}])},[d("span",{class:"s-name",title:e.name},u(e.name),9,Ds),c(at,{item:e},null,8,["item"])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(F,{name:"slot",disabled:!oa.value},{label:h(()=>[c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[...t[101]||(t[101]=[d("span",null,"按部位",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",Rs,[c(_l,{modelValue:dl.value,"onUpdate:modelValue":t[21]||(t[21]=e=>dl.value=e)},null,8,["modelValue"]),t[102]||(t[102]=d("div",{class:"v-divider-mini"},null,-1)),c(jl,{modelValue:Sl.value,"onUpdate:modelValue":t[22]||(t[22]=e=>Sl.value=e)},null,8,["modelValue"])]),d("div",Ms,[(i(!0),s(k,null,w(Sa.value,e=>(i(),s("div",{key:e,class:"summary-card"},[d("div",Ts,u(e),1),d("div",null,[(i(!0),s(k,null,w(Za(_a.value[e]||{},e),l=>(i(),s("div",{key:l,class:r(["summary-item",{"is-not-obtained":0===(_a.value[e]?.[l]||0)}])},[c(ml,{class:"s-name",name:l,role:Rn(l),"show-only-role":Nl.value},null,8,["name","role","show-only-role"]),d("div",zs,[c(at,{item:et(l,e,_a.value[e]?.[l]||0)},null,8,["item"])])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(F,{name:"week",disabled:!oa.value},{label:h(()=>[c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[...t[103]||(t[103]=[d("span",null,"按CD周",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",Ps,[c(_l,{modelValue:pl.value,"onUpdate:modelValue":t[23]||(t[23]=e=>pl.value=e)},null,8,["modelValue"])]),d("div",Us,[d("div",{class:r(["summary-grid has-sort-control",{"is-compact-role":Nl.value}])},[(i(!0),s(k,null,w(Oa.value,e=>(i(),s("div",{key:e,class:"summary-card",onContextmenu:t[24]||(t[24]=_(()=>{},["prevent"]))},[d("div",Ls,u(xa(e)),1),d("div",Ns,[(i(!0),s(k,null,w([Ba(e)],l=>(i(),s("div",{key:l.length+e},[(i(!0),s(k,null,w(l,(e,a)=>(i(),s(k,{key:e.key},[(i(),g(T,{key:0,disabled:!$a.value.has(e.key)||void 0!==ol.value[e.key],content:"可能归属周错误（通常发生在周二压线进本）。点击可选择将其归入上一周。",placement:"top"},{default:h(()=>[d("div",{class:r(["summary-item week-record-row",{"is-corrected":ol.value[e.key],"is-suspicious":$a.value.has(e.key)&&!ol.value[e.key]}]),onContextmenu:_(l=>Pa(l,e),["prevent"]),onClick:_(l=>Pa(l,e),["stop"])},[d("div",Ws,[c(ml,{name:e.player,role:Rn(e.player),"show-only-role":Nl.value,"name-class":"week-player-name"},null,8,["name","role","show-only-role"])]),d("div",As,[d("span",Is,u(e.item),1),$a.value.has(e.key)&&!ol.value[e.key]?(i(),g(m,{key:0,class:"row-status-icon is-warning"},{default:h(()=>[c(p(ve))]),_:1})):n("",!0),ol.value[e.key]?(i(),g(m,{key:1,class:"row-status-icon is-info"},{default:h(()=>[c(p(Ve))]),_:1})):n("",!0)])],42,js)]),_:2},1032,["disabled"])),Da(l,a)?(i(),s("div",Fs)):n("",!0)],64))),128))]))),128))])],32))),128))],2)]),c(B,{visible:Ma.value,"onUpdate:visible":t[25]||(t[25]=e=>Ma.value=e),"virtual-ref":za,"virtual-triggering":"","popper-class":"context-menu-popper",width:180,"show-arrow":!1,placement:"bottom-start"},{default:h(()=>[Ra.value?(i(),s("div",Js,[d("div",Ys,[c(m,null,{default:h(()=>[c(p(Fe))]),_:1}),d("span",null,u(Xn(Ra.value.timestamp)),1)]),t[104]||(t[104]=d("div",{class:"menu-divider"},null,-1)),d("div",{class:"menu-action-item",onClick:Ua},[c(m,{class:"action-arrow"},{default:h(()=>[(i(),g($(ol.value[Ra.value.key]?p(Je):p(Ye))))]),_:1}),d("span",Hs,u(ol.value[Ra.value.key]?"归回原始周":"归入上一周"),1)])])):n("",!0)]),_:1},8,["visible"])]),_:1},8,["disabled"]),c(F,{name:"chart",disabled:!oa.value,lazy:""},{label:h(()=>[c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[...t[105]||(t[105]=[d("span",null,"图表分析",-1)])]),_:1},8,["disabled"])]),default:h(()=>[c(Ul,{records:ka.value,players:da.value,"get-actual-player":gl,"get-player-role":Rn,"record-week-corrections":ol.value,"sync-start-date":El.value,"player-visibility":Nl.value?"role":"all"},null,8,["records","players","record-week-corrections","sync-start-date","player-visibility"])]),_:1},8,["disabled"]),c(F,{name:"bis",disabled:!oa.value},{label:h(()=>[c(T,{disabled:oa.value,content:Dn,placement:"top"},{default:h(()=>[d("div",Ks,[t[106]||(t[106]=d("span",null,"BIS分配",-1)),oa.value&&!ra.value?(i(),s("span",Xs)):n("",!0)])]),_:1},8,["disabled"])]),default:h(()=>[c(qa,{modelValue:rl.value,"onUpdate:modelValue":t[26]||(t[26]=e=>rl.value=e),sortMode:yl.value,"onUpdate:sortMode":t[27]||(t[27]=e=>yl.value=e),players:da.value,records:ka.value,"get-player-role":Rn,"get-actual-player":gl,"show-only-role":Nl.value},null,8,["modelValue","sortMode","players","records","show-only-role"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):(i(),s("div",qs,[d("div",Gs,[c(m,null,{default:h(()=>[c(p(He))]),_:1})]),t[108]||(t[108]=d("div",{class:"empty-title"},"未发现匹配记录",-1)),t[109]||(t[109]=d("p",{class:"empty-desc"},[b(" 当前筛选条件过于严格，数据库中有数据但未能匹配。"),d("br"),b(" 请尝试"),d("span",{class:"empty-highlight"},"清除筛选条件"),b("或调整时间范围。 ")],-1)),d("div",Qs,[c(y,{type:"info",plain:"",onClick:Na},{default:h(()=>[...t[107]||(t[107]=[b("显示所有掉落",-1)])]),_:1})])]))])])):(i(),s("div",Zs,[d("div",en,[me.value?nl.value?(i(),s(k,{key:1},[t[123]||(t[123]=d("div",{class:"empty-title"},"设置同步范围",-1)),d("p",sn,[t[116]||(t[116]=b(" 已关联目录：",-1)),d("span",nn,u(me.value.name),1),t[117]||(t[117]=d("br",null,null,-1)),t[118]||(t[118]=b(" 请指定你想要同步的历史记录起始时间。 ",-1))]),d("div",on,[d("div",rn,[t[119]||(t[119]=d("span",{class:"setup-label"},"起始时间:",-1)),c(f,{modelValue:El.value,"onUpdate:modelValue":t[33]||(t[33]=e=>El.value=e),type:"datetime",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1},null,8,["modelValue"])]),d("div",un,[t[120]||(t[120]=d("span",{class:"setup-label"},"截止时间:",-1)),c(f,{modelValue:Dl.value,"onUpdate:modelValue":t[34]||(t[34]=e=>Dl.value=e),type:"datetime",placeholder:"现在 (可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm"},null,8,["modelValue"])])]),d("div",cn,[c(y,{onClick:t[35]||(t[35]=e=>me.value=null),plain:"",size:"large"},{default:h(()=>[...t[121]||(t[121]=[b("返回重选",-1)])]),_:1}),c(y,{type:"primary",size:"large",onClick:Aa},{default:h(()=>[...t[122]||(t[122]=[b(" 开始解析并导入 ",-1)])]),_:1})])],64)):(i(),s("div",dn,[Yl.value?(i(),s("div",{key:0,class:r(["setup-drag-zone",{"is-active":Hl.value}]),onDrop:_(Ql,["stop","prevent"]),onDragover:t[36]||(t[36]=_(()=>{},["prevent"])),onDragenter:t[37]||(t[37]=e=>Hl.value=!0),onDragleave:t[38]||(t[38]=e=>Hl.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(xe))]),_:1}),t[124]||(t[124]=d("span",null,"释放文件以导入备份",-1))],34)):n("",!0),d("div",vn,u(Ol.value?"正在同步数据":"准备就绪"),1),d("p",pn,u(Ol.value?"正在处理日志文件，请稍候。":"数据库当前为空。你可以开始解析数据，或从备份文件恢复。"),1),d("div",mn,[Ol.value?n("",!0):(i(),g(y,{key:0,onClick:Ia,type:"primary",size:"large"},{default:h(()=>[...t[125]||(t[125]=[b("开始解析数据",-1)])]),_:1})),Ol.value?n("",!0):(i(),g(y,{key:1,onClick:t[39]||(t[39]=e=>jn.value?.click()),plain:"",size:"large"},{default:h(()=>[...t[126]||(t[126]=[b("导入备份数据",-1)])]),_:1})),Ol.value?n("",!0):(i(),g(y,{key:2,onClick:t[40]||(t[40]=e=>nl.value=!0),plain:"",size:"large"},{default:h(()=>[...t[127]||(t[127]=[b("调整时间范围",-1)])]),_:1}))])])):(i(),s("div",ln,[Yl.value?(i(),s("div",{key:0,class:r(["setup-drag-zone",{"is-active":Hl.value}]),onDrop:_(Ql,["stop","prevent"]),onDragover:t[29]||(t[29]=_(()=>{},["prevent"])),onDragenter:t[30]||(t[30]=e=>Hl.value=!0),onDragleave:t[31]||(t[31]=e=>Hl.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(xe))]),_:1}),t[110]||(t[110]=d("span",null,"释放文件以导入备份",-1))],34)):n("",!0),d("div",an,[t[113]||(t[113]=d("div",{class:"empty-title"},"欢迎使用 Loot History",-1)),t[114]||(t[114]=d("p",{class:"empty-desc"},[b(" 选择你的"),d("span",{class:"empty-highlight"},"FFXIV 日志文件夹"),b("，开始记录掉落。 ")],-1)),d("div",tn,[c(y,{type:"primary",size:"large",onClick:ja},{default:h(()=>[...t[111]||(t[111]=[b(" 选择日志目录 ",-1)])]),_:1}),c(y,{type:"info",plain:"",size:"large",onClick:t[32]||(t[32]=e=>jn.value?.click())},{default:h(()=>[...t[112]||(t[112]=[b(" 导入备份数据 ",-1)])]),_:1})])]),t[115]||(t[115]=d("div",{class:"guide-img-box"},[d("img",{src:"/ff14-overlay-vue/assets/lootHistoryGuide-CNWHhK0O.jpg",alt:"Guide",class:"guide-img"})],-1))]))])])),c(p(ye),{modelValue:Qe.value,"onUpdate:modelValue":t[46]||(t[46]=e=>Qe.value=e),title:"选择导出内容",width:"360px","append-to-body":""},{footer:h(()=>[d("span",fn,[c(y,{onClick:t[45]||(t[45]=e=>Qe.value=!1)},{default:h(()=>[...t[131]||(t[131]=[b("取消",-1)])]),_:1}),c(y,{type:"primary",onClick:An},{default:h(()=>[...t[132]||(t[132]=[b("立即导出",-1)])]),_:1})])]),default:h(()=>[d("div",yn,[c(p(re),{modelValue:el.value.loot,"onUpdate:modelValue":t[41]||(t[41]=e=>el.value.loot=e)},{default:h(()=>[b("掉落记录 ("+u(I.value.length)+")",1)]),_:1},8,["modelValue"]),c(p(re),{modelValue:el.value.bis,"onUpdate:modelValue":t[42]||(t[42]=e=>el.value.bis=e)},{default:h(()=>[...t[128]||(t[128]=[b("BIS 分配配置",-1)])]),_:1},8,["modelValue"]),c(p(re),{modelValue:el.value.roles,"onUpdate:modelValue":t[43]||(t[43]=e=>el.value.roles=e)},{default:h(()=>[...t[129]||(t[129]=[b("固定队职位设置",-1)])]),_:1},8,["modelValue"]),c(p(re),{modelValue:el.value.mapping,"onUpdate:modelValue":t[44]||(t[44]=e=>el.value.mapping=e)},{default:h(()=>[...t[130]||(t[130]=[b("人员合并/映射项",-1)])]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"]),c(p(ye),{modelValue:Ze.value,"onUpdate:modelValue":t[52]||(t[52]=e=>Ze.value=e),title:"选择导入内容",width:"400px","append-to-body":""},{footer:h(()=>[d("span",Bn,[c(y,{onClick:t[51]||(t[51]=e=>Ze.value=!1)},{default:h(()=>[...t[139]||(t[139]=[b("取消",-1)])]),_:1}),c(y,{type:"primary",onClick:Fn},{default:h(()=>[...t[140]||(t[140]=[b("确认导入",-1)])]),_:1})])]),default:h(()=>[tl.value?(i(),s("div",gn,[t[138]||(t[138]=d("p",{class:"import-hint-text"},"发现备份文件，请选择要导入的部分：",-1)),d("div",hn,[c(p(re),{modelValue:ll.value.loot,"onUpdate:modelValue":t[47]||(t[47]=e=>ll.value.loot=e),disabled:!tl.value.r?.length},{default:h(()=>[b(" 掉落记录 ("+u(tl.value.r?.length||0)+" 条) ",1),tl.value.r?.length?al.value.loot?n("",!0):(i(),s("span",kn,"(与现有记录一致)")):(i(),s("span",bn,"- 备份文件中未发现记录"))]),_:1},8,["modelValue","disabled"]),c(p(re),{modelValue:ll.value.bis,"onUpdate:modelValue":t[48]||(t[48]=e=>ll.value.bis=e),disabled:!tl.value.bisConfig&&!tl.value.c?.bisConfig&&!tl.value.c?.bis},{default:h(()=>[t[133]||(t[133]=b(" BIS 分配配置 ",-1)),tl.value.bisConfig||tl.value.c?.bisConfig||tl.value.c?.bis?al.value.bis?n("",!0):(i(),s("span",_n,"(与现有配置一致)")):(i(),s("span",wn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(re),{modelValue:ll.value.roles,"onUpdate:modelValue":t[49]||(t[49]=e=>ll.value.roles=e),disabled:!tl.value.c?.roles},{default:h(()=>[t[134]||(t[134]=b(" 固定队职位设置 ",-1)),tl.value.c?.roles?al.value.roles?n("",!0):(i(),s("span",Vn,"(与现有设置一致)")):(i(),s("span",Sn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(re),{modelValue:ll.value.mapping,"onUpdate:modelValue":t[50]||(t[50]=e=>ll.value.mapping=e),disabled:!tl.value.c?.map},{default:h(()=>[t[135]||(t[135]=b(" 人员合并/映射项 ",-1)),tl.value.c?.map?al.value.mapping?n("",!0):(i(),s("span",Cn,"(与现有记录一致)")):(i(),s("span",xn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"])]),ll.value.bis&&al.value.bis||ll.value.roles&&al.value.roles||ll.value.mapping&&al.value.mapping?(i(),s("div",$n,[c(m,null,{default:h(()=>[c(p(ve))]),_:1}),t[136]||(t[136]=d("span",null,"职位与 BIS 设置导入后将覆盖当前配置",-1))])):!(ll.value.bis||ll.value.roles||ll.value.mapping)||al.value.bis||al.value.roles||al.value.mapping?n("",!0):(i(),s("div",On,[c(m,null,{default:h(()=>[c(p(Ke))]),_:1}),t[137]||(t[137]=d("span",null,"所选配置项已与本地同步，无需重复导入",-1))]))])):n("",!0)]),_:1},8,["modelValue"]),c(p(ye),{modelValue:fe.value,"onUpdate:modelValue":t[57]||(t[57]=e=>fe.value=e),title:"手动添加记录",width:"400px","append-to-body":""},{footer:h(()=>[d("span",En,[c(y,{onClick:t[56]||(t[56]=e=>fe.value=!1)},{default:h(()=>[...t[141]||(t[141]=[b("取消",-1)])]),_:1}),c(y,{type:"primary",onClick:Nn},{default:h(()=>[...t[142]||(t[142]=[b("确定添加",-1)])]),_:1})])]),default:h(()=>[c(p(Xe),{"label-width":"80px"},{default:h(()=>[c(p(qe),{label:"时间"},{default:h(()=>[c(f,{modelValue:sl.value.timestamp,"onUpdate:modelValue":t[53]||(t[53]=e=>sl.value.timestamp=e),type:"datetime",placeholder:"选择获得时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(p(qe),{label:"物品"},{default:h(()=>[c(p(Ge),{modelValue:sl.value.item,"onUpdate:modelValue":t[54]||(t[54]=e=>sl.value.item=e),"fetch-suggestions":Un,placeholder:"请输入物品名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(p(qe),{label:"获得者"},{default:h(()=>[c(p(Ge),{modelValue:sl.value.player,"onUpdate:modelValue":t[55]||(t[55]=e=>sl.value.player=e),"fetch-suggestions":Ln,placeholder:"请输入玩家名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)),d("input",{ref_key:"importInputRef",ref:jn,type:"file",accept:".json",style:{display:"none"},onChange:Yn},null,544)],2)}}}),[["__scopeId","data-v-69714f75"]]);export{Rn as default};
