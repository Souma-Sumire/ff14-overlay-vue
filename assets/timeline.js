import{_ as e}from"./ActWrapper.js";import{u as t,p as i,_ as o}from"./TimelineShow.js";import{d as n,a as l,r as a,c as s,o as c,E as m,g as r,j as u,n as d,f as p,e as f,B as g,i as y,u as v,F as T,k as b,q as h,h as j,t as k,S as C,H as w}from"./index.js";import{u as x}from"./useDev.js";import{t as A}from"./tts.js";import{c as _,a as S}from"./overlay_plugin_api.js";import{u as O}from"./index2.js";import{_ as B}from"./_plugin-vue_export-helper.js";import"./el-card.js";import"./useDemo.js";import"./status.js";import"./regexes.js";import"./util.js";import"./chineseToIcon.js";import"./xivapi.js";const E={id:"wrapper"},I={key:0,class:"optionalTimelines"},V=["onClick"],D={key:7,style:{color:"white","background-color":"black"}},L=B(n({__name:"timeline",setup(n){const B=t(),L=l({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),N=a(0),z=a(0-B.configValues.preBattle),F=a(0);let $=!1;const q=O("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),G=x(),P=s(()=>L.loadedTimeline.filter(e=>e.sync)),H=s(()=>L.loadedTimeline.filter(e=>e.tts));function M(){W(),L.loadedTimeline.length=0,L.optionalTimeline.length=0;const e=B.getTimeline(q.value);1===e.length?R(e[0]):e.length>1&&(L.optionalTimeline=e,R(e[0]))}async function R(e,t=!0){L.selectedOptionalTimeline=e,t&&W(),$=!1,e?.timeline&&(L.loadedTimeline=await i(e.timeline),L.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{$=!0},1e3)}function W(){N.value=0,z.value=0-B.configValues.preBattle,F.value=0;for(const e of L.loadedTimeline)e.alertAlready=!1;for(const e of P.value)e.syncAlready=!1}function Z(e,t=!0){t&&($=!1,setTimeout(()=>{$=!0},1e3)),z.value=0,F.value=0,N.value=(new Date).getTime()+1e3*e,H.value.forEach(e=>{e.alertAlready=!1}),J()}function J(){if(0===N.value)return;z.value=((new Date).getTime()-N.value+F.value)/1e3;const e=H.value.find(e=>!e.alertAlready&&e.time-B.configValues.ttsAdvance<=z.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;($||t)&&A(e)}(e.tts)),requestAnimationFrame(J)}function K(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)Z(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))W();else{const e=P.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&z.value>=e.time-e.windowBefore&&z.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,Q(e.jump||e.time))}}}function Q(e){0===N.value&&Z(0,!1),F.value+=1e3*(e-z.value),H.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}c(()=>{S("onLogEvent",K),S("onPlayerChangedEvent",U),S("ChangeZone",X),S("BroadcastMessage",te),S("onInCombatChangedEvent",ie),B.loadTimelineSettings(),m({message:`${B.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),M(),ee("hello")});const U=e=>{q.value.jobs[0]!==e.detail.job&&(q.value.jobs[0]=e.detail.job,M())},X=e=>{q.value.zoneId=String(e.zoneID),M()};function Y(){m.closeAll(),m({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){_({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>B.jobList.indexOf(e)-B.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");B.allTimelines=t.allTimelines,B.configValues=t.configValues,B.showStyle=t.showStyle,B.saveTimelineSettings(),m.closeAll(),m({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),M(),ee("success")}"get"===e.msg.type&&ee("post",B.$state)}};function ie(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===N.value?Z(0):e.detail.inGameCombat||e.detail.inACTCombat||W()}return(t,i)=>{const n=C,l=o,a=e;return d(),r(a,null,{default:u(()=>[p("div",E,[v(L).optionalTimeline.length&&v(z)<=-v(B).configValues.preBattle?(d(),f("ul",I,[i[5]||(i[5]=p("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(d(!0),f(T,null,b(v(L).optionalTimeline,(e,t)=>(d(),f("li",{key:t,class:h(v(L).selectedOptionalTimeline===e?"active":""),onClick:t=>{R(e)}},[j(k(e.name)+" ",1),v(L).selectedOptionalTimeline===e?(d(),r(n,{key:0},{default:u(()=>[y(v(w))]),_:1})):g("",!0)],10,V))),128))])):g("",!0),y(l,{config:v(B).configValues,lines:v(L).loadedTimeline,runtime:v(z),"show-style":v(B).showStyle},null,8,["config","lines","runtime","show-style"]),v(G)?(d(),f("button",{key:1,onClick:i[0]||(i[0]=e=>Z(30))}," 开始从-30 ")):g("",!0),v(G)?(d(),f("button",{key:2,onClick:i[1]||(i[1]=e=>Z(0))}," 开始从0 ")):g("",!0),v(G)?(d(),f("button",{key:3,onClick:i[2]||(i[2]=e=>W())}," 团灭 ")):g("",!0),v(G)?(d(),f("button",{key:4,onClick:i[3]||(i[3]=e=>{Q(1e3)})}," 跳转1000测试 ")):g("",!0),v(G)?(d(),f("button",{key:5,onClick:i[4]||(i[4]=e=>v(A)("今天天气真不错"))}," TTS测试 ")):g("",!0),v(G)?(d(),f("button",{key:6,onClick:Y}," 弹窗测试 ")):g("",!0),v(G)?(d(),f("span",D,k(v(z)),1)):g("",!0)])]),_:1})}}}),[["__scopeId","data-v-4043b642"]]);export{L as default};
