import{d as be,p as D,K as Ie,r as Ge,o as F,e as Z,a as e,w as o,y as h,R as Xe,u as n,c as A,a0 as G,A as W,$ as J,x as _,F as Y,M as se,U as j,ah as ye,O as ke,ai as Ye,aj as et,C as Be,ak as Ne,al as tt,D as nt,am as Ae,ag as ze,ae as Ue,af as De,an as ot,a1 as je,H as he,I as ve,ac as Oe,Y as lt,q as Le,ad as Pe,ao as Me,ap as Re,B as it,aq as st,Z as xe,b as at,X as rt,t as ct,v as dt,ar as de,n as M,as as Ce,at as ut,a3 as mt,a2 as pt,au as ft,G as _t,av as gt,a4 as yt,a5 as wt}from"./vendor-2a442634.js";import{u as Te,_ as qe,p as bt}from"./TimelineShow-be73e25e.js";import{U as ie}from"./util-831b56e7.js";import{g as ht}from"./actionChinese-a0bab8f1.js";import{g as vt,h as Tt}from"./xivapi-a5c0f7f0.js";import{_ as Fe}from"./_plugin-vue_export-helper-c27b6911.js";import{a as Ft,c as St}from"./overlay_plugin_api-409cb9ea.js";import{z as we}from"./zoneInfo-6eb69bef.js";import{r as Vt}from"./index-dbf3418c.js";import{u as $t,c as Ee}from"./useWebSocket-bb99524d.js";import"./actWS-e2500b62.js";const s=new Map;s.set(26155,{type:"cast",window:[999,999]});s.set(28027,{type:"cast",window:[999,999]});s.set(26340,{type:"cast",window:[999,999]});s.set(25533,{type:"begincast",window:[60,60]});s.set(26376,{type:"cast",window:[999,999]});s.set(26814,{type:"begincast",window:[999,999]});s.set(25313,{type:"begincast",window:[200,200]});s.set(27526,{type:"begincast",window:[999,999]});s.set(26215,{type:"cast",window:[500,30]});s.set(29050,{type:"begincast",window:[200,30]});s.set(29156,{type:"cast",window:[20,20]});s.set(27973,{type:"cast",window:[20,20]});s.set(27937,{type:"begincast",window:[20,20]});s.set(28059,{type:"begincast",window:[20,20]});s.set(28060,{type:"begincast",window:[20,20]});s.set(28061,{type:"begincast",window:[20,20]});s.set(27956,{type:"begincast",window:[20,20]});s.set(27957,{type:"begincast",window:[20,20]});s.set(27952,{type:"begincast",window:[30,30]});s.set(27969,{type:"begincast",window:[20,20]});s.set(27971,{type:"begincast",window:[20,20]});s.set(27939,{type:"begincast",window:[20,20]});s.set(27966,{type:"begincast",window:[20,20]});s.set(25316,{type:"begincast",window:[999,999]});s.set(25544,{type:"begincast",window:[10,10]});s.set(26379,{type:"begincast",window:[10,10]});s.set(31552,{type:"begincast",window:[30,30]});s.set(31573,{type:"begincast",window:[30,30]});s.set(31573,{type:"begincast",window:[30,30]});s.set(31617,{type:"begincast",window:[8,8]});s.set(31624,{type:"begincast",window:[30,30]});s.set(31649,{type:"begincast",window:[30,30]});s.set(18864,{type:"cast",window:[10,2.5],once:!0});s.set(18480,{type:"cast",window:[200,60],once:!0});s.set(18516,{type:"cast",window:[250,65],once:!0});s.set(18522,{type:"begincast",window:[500,500],once:!0});s.set(18552,{type:"begincast",window:[67,67],once:!0});s.set(18553,{type:"cast",window:[67,67],once:!0});s.set(19083,{type:"cast",window:[900,0],once:!0});s.set(40191,{type:"begincast",window:[200,20],once:!0});s.set(40265,{type:"begincast",window:[500,20],once:!0});s.set(40246,{type:"begincast",window:[999,30],once:!0});s.set(40306,{type:"begincast",window:[30,30],once:!0});function xt(S){for(const L of S){const w=s.get(L.actionId);(w==null?void 0:w.type)===L.type&&(L.window=w==null?void 0:w.window),L.syncOnce=!!(w!=null&&w.once)}return S}const Ct=S=>(he("data-v-4c94d6f7"),S=S(),ve(),S),Et={class:"query-results"},It={class:"ability-filter-container"},kt={key:0,class:"loading-abilities"},Bt=Ct(()=>_("span",null,"正在加载技能列表...",-1)),Nt=["src","alt","onerror"],At=be({__name:"FflogsImport",props:{filters:{}},emits:["newTimeline","showFFlogsToggle","clearCurrentlyTimeline","updateFilters"],setup(S,{emit:L}){const w=S,u=L,T=new RegExp("(?<=^|\\/)(?<code>\\w{16,})[#?]fight=(?<fight>\\d+|last)"),K={begincast:"14",cast:"1[56]"},k=D("查询"),N=D(""),z=D(!1),d=D(!1),C=D(0),U=D(!1),t=Ie({});E();const B=Te();async function ee(I){var v,$,m;d.value=!0,E(),k.value="正在查询...";const a=I.match(T);if(!B.settings.api){j.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方<strong>填写 V1 客户名称并点击确认</strong>后，获取你的 V1 客户端密钥</a>'}),k.value="查询",d.value=!1;return}if(!a){j.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),k.value="查询",d.value=!1;return}t.code=((v=a.groups)==null?void 0:v.code)??"";try{const p=await ye.get(`https://cn.fflogs.com/v1/report/fights/${t.code}?api_key=${B.settings.api}`);t.bossIDs=p.data.enemies.filter(y=>y.type==="Boss").map(y=>y.id),t.fightIndex=((($=a==null?void 0:a.groups)==null?void 0:$.fight)==="last"?p.data.fights.length:Number.parseInt(((m=a==null?void 0:a.groups)==null?void 0:m.fight)??"0"))-1;const V=p.data.fights[t.fightIndex];t.zoneID=V.zoneID,t.start=V.start_time,t.end=V.end_time,t.friendlies=p.data.friendlies.filter(y=>y.icon!=="LimitBreak"&&y.fights.find(oe=>oe.id===t.fightIndex+1)),k.value="查询",t.abilityFilterEvents.length=0,t.abilityFilterCandidate.length=0,d.value=!1,C.value=1}catch(p){j.alert(`
  <h3 style="margin-bottom: 10px;">可能的原因：</h3>
  <ul style="padding-left: 20px; margin-bottom: 10px;">
    <li> <strong>90%概率</strong>：你没有<strong style="color: red;">先起名</strong>再获取 V1 客户端密钥</li>
    <li> <strong>5%概率</strong>：该战斗记录是私人或匿名模式</li>
    <li> <strong>5%概率</strong>：网络异常</li>
  </ul>
<p class="error-details"><strong>错误：</strong>${p}</p>
`,"请求失败",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),k.value="查询",d.value=!1}}async function X(I){d.value=!0,C.value=2,t.player=I;try{await te(),t.abilityFilterCandidate=t.abilityFilterEvents.reduce((a,v)=>(v.sourceIsFriendly&&!a.find($=>$.actionId===v.actionId)&&a.push(v),a),[]),d.value=!1}catch(a){j.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${a}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),d.value=!1}}async function te(){var $,m;U.value=!1;const I=[];t.abilityFilterEvents.length=0;async function a(p){var V;try{const y=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${t.code}?start=${p}&end=${t.end}&hostility=0&sourceid=${(V=t.player)==null?void 0:V.id}&api_key=${B.settings.api}`);I.push(...y.data.events),y.data.nextPageTimestamp&&y.data.nextPageTimestamp>0&&y.data.nextPageTimestamp<t.end&&await a(y.data.nextPageTimestamp)}catch(y){j.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${y}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function v(p,V){if(V>=0)try{const y=await ye.get(`https://cn.fflogs.com/v1/report/events/casts/${t.code}?start=${p}&end=${t.end}&hostility=1&sourceid=${t.bossIDs[V]}&api_key=${B.settings.api}`);I.push(...y.data.events),y.data.nextPageTimestamp&&y.data.nextPageTimestamp>0&&y.data.nextPageTimestamp<t.end&&await v(y.data.nextPageTimestamp,V),V<t.bossIDs.length-1&&await v(p,V+1)}catch(y){j.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${y}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}await Promise.all([a(t.start),v(t.start,0)]);for(const p of I)p.type==="begincast"&&p.sourceIsFriendly||t.abilityFilterEvents.push({time:Number(((p.timestamp-t.start)/1e3).toFixed(1)),type:p.type,actionName:ht(p.ability.guid)??p.ability.name,actionId:p.ability.guid,sourceIsFriendly:p.sourceIsFriendly,url:(($=p==null?void 0:p.ability)==null?void 0:$.abilityIcon.replace("-","/").replace(".png",""))??"000000/000405",window:void 0});(m=t.player)!=null&&m.icon&&w.filters[t.player.icon]&&(t.abilityFilterSelected=w.filters[t.player.icon]),U.value=!0}function ne(){var I,a,v,$;d.value=!0,C.value=3,(I=t.player)!=null&&I.icon&&u("updateFilters",(a=t.player)==null?void 0:a.icon,JSON.parse(JSON.stringify(t.abilityFilterSelected))),t.abilityFilterEvents=t.abilityFilterEvents.filter(m=>m.sourceIsFriendly&&t.abilityFilterSelected.includes(m.actionId)||!m.sourceIsFriendly).sort((m,p)=>m.time-p.time),t.abilityFilterEvents=xt(t.abilityFilterEvents),t.abilityFilterEventsAfterFilterRawTimeline=t.abilityFilterEvents.map(m=>m.sourceIsFriendly?`${m.time} "<${m.actionName}>~"${z.value?` tts "${m.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(m.actionName)||m.type==="cast"&&m.window===void 0?`# ${m.time} "${m.actionName}"`:`${m.time} "${m.actionName}" sync /^.{14} \\w+ ${K[m.type]}:4.{7}:[^:]+:${m.actionId.toString(16).toUpperCase()}:/${m.window?` window ${m.window.join(",")}`:""}`).join(`
`),u("newTimeline",`导入${(v=t.player)==null?void 0:v.name}`,{zoneId:t.zoneID.toString(),jobs:[(($=t.player)==null?void 0:$.icon)??"NONE"]},t.abilityFilterEventsAfterFilterRawTimeline,`${t.code}#fight=${t.fightIndex+1}`),E(),u("showFFlogsToggle"),setTimeout(()=>{C.value=0},500),d.value=!1}function E(){t.code="",t.fightIndex=0,t.start=0,t.end=0,t.friendlies=[],t.abilityFilterEvents=[],t.abilityFilterCandidate=[],t.abilityFilterSelected=[],t.abilityFilterEventsAfterFilterRawTimeline="",t.player=void 0,t.zoneID=0,t.bossIDs=[]}function O(){window.open("https://cn.fflogs.com/profile","_blank")}return(I,a)=>{const v=ke,$=Ye,m=et,p=Be,V=Ne,y=tt,oe=nt,me=Ae,le=ze,Q=Ue,pe=De,fe=Ge("Loading"),r=ot,l=Oe,f=je;return F(),Z(Y,null,[e(v,{"position-absolute":"","z-999":"",style:Xe(n(C)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"",class:"guide",onClick:a[0]||(a[0]=i=>C.value--)},{default:o(()=>[h(" 上一步 ")]),_:1},8,["style"]),e(m,{active:n(C),class:"steps-guide","align-center":""},{default:o(()=>[e($,{title:"输入链接"}),e($,{title:"选择玩家"}),e($,{title:"过滤技能"}),e($,{title:"生成时间轴"})]),_:1},8,["active"]),n(C)===0?(F(),A(le,{key:0,class:"input-section"},{default:o(()=>[e(me,{"label-width":"150px",class:"fflogs-form"},{default:o(()=>[e(V,{label:"FF Logs 战斗链接"},{default:o(()=>[e(p,{modelValue:n(N),"onUpdate:modelValue":a[1]||(a[1]=i=>G(N)?N.value=i:null),placeholder:"https://www.fflogs.com/reports/AAAaAaAAaa1aA1aA?fight=1",autocomplete:"on"},null,8,["modelValue"])]),_:1}),e(V,{label:"FF logs V1 Key"},{default:o(()=>[e(p,{modelValue:n(B).settings.api,"onUpdate:modelValue":a[2]||(a[2]=i=>n(B).settings.api=i),placeholder:"在 FF Logs 个人设置页面获取 V1 API Key",type:"password"},{append:o(()=>[e(y,{content:"点击前往 FF Logs 个人设置页面，在最下方填写 V1客户名称 并点击确认后，再获取你的 V1 客户端密钥",placement:"top",effect:"light"},{default:o(()=>[e(v,{type:"primary",link:"",onClick:O},{default:o(()=>[h(" 如何获取 ")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(V,{label:"使用 TTS"},{default:o(()=>[e(oe,{modelValue:n(z),"onUpdate:modelValue":a[3]||(a[3]=i=>G(z)?z.value=i:null)},null,8,["modelValue"])]),_:1}),e(V,null,{default:o(()=>[e(v,{disabled:n(k)==="正在查询...",type:"primary",onClick:a[4]||(a[4]=i=>ee(n(N)))},{default:o(()=>[h(W(n(k)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):J("",!0),_("div",Et,[n(C)===1?(F(),A(le,{key:0,class:"player-selection"},{default:o(()=>[e(pe,{data:n(t).friendlies.filter(i=>!["NPC"].includes(i.icon)),stripe:"",border:"",class:"friendlies-table"},{default:o(()=>[e(Q,{prop:"name",label:"玩家名称"}),e(Q,{label:"职业"},{default:o(({row:i})=>[h(W(n(ie).nameToFullName(n(ie).jobEnumToJob(n(ie).iconToJobEnum(i.icon))).cn),1)]),_:1}),e(Q,{label:"选定",width:"100",align:"center"},{default:o(i=>[e(v,{type:"primary",size:"small",onClick:b=>X(i.row)},{default:o(()=>[h(" 选择 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):J("",!0),n(C)===2?(F(),A(le,{key:1,class:"ability-filter"},{default:o(()=>[_("div",It,[n(U)?J("",!0):(F(),Z("div",kt,[e(r,{class:"is-loading"},{default:o(()=>[e(fe)]),_:1}),Bt])),n(U)?(F(),A(f,{key:1,modelValue:n(t).abilityFilterSelected,"onUpdate:modelValue":a[5]||(a[5]=i=>n(t).abilityFilterSelected=i),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:o(()=>[(F(!0),Z(Y,null,se(n(t).abilityFilterCandidate,i=>(F(),A(l,{key:i.actionId,value:i.actionId,label:i.actionName,class:"ability-filter-option"},{default:o(()=>[_("img",{src:n(vt)(`/i/${i.url}.png`),class:"ability-filter-icon",alt:i.actionName,onerror:n(Tt)},null,8,Nt),_("span",null,W(i.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])):J("",!0),n(U)?(F(),A(v,{key:2,type:"success",class:"filter-confirm-btn",disabled:!n(U),onClick:ne},{default:o(()=>[h(W("生成时间轴"))]),_:1},8,["disabled"])):J("",!0)])]),_:1})):J("",!0)])],64)}}});const zt=Fe(At,[["__scopeId","data-v-4c94d6f7"]]),ue=S=>(he("data-v-52d0d6b5"),S=S(),ve(),S),Ut=ue(()=>_("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)),Dt=ue(()=>_("h3",{class:"form-section-title"}," 参数 ",-1)),jt=ue(()=>_("h3",{class:"form-section-title"}," 样式 ",-1)),Ot=ue(()=>_("h3",{class:"form-section-title"}," 测试用例 ",-1)),Lt=be({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(S,{emit:L}){const w=S,u=L,T=Te();lt(()=>{T.saveTimelineSettings()});const K=Le({get:()=>w.modelValue,set:z=>u("update:modelValue",z)}),k=D(-15),N=D([{time:-15,action:"<圣光幕帘>~",show:!0},{time:-2,action:"<圣灵>~",show:!0},{time:0,action:"战斗开始！",show:!0},{time:3,action:"<挑衅>~",show:!0},{time:5,action:"<神圣领域>~",show:!0}]);return(z,d)=>{const C=it,U=Ne,t=st,B=Pe,ee=Me,X=qe,te=Ae,ne=Re;return F(),A(ne,{modelValue:n(K),"onUpdate:modelValue":d[1]||(d[1]=E=>G(K)?K.value=E:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:o(()=>[Ut]),default:o(()=>[e(te,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:o(()=>[Dt,e(B,{gutter:20},{default:o(()=>[(F(!0),Z(Y,null,se(n(T).configValues,(E,O,I)=>(F(),A(t,{key:I,span:12},{default:o(()=>[e(U,{label:n(T).configTranslate[O]},{default:o(()=>[e(C,{modelValue:n(T).configValues[O],"onUpdate:modelValue":a=>n(T).configValues[O]=a,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),jt,e(B,{gutter:20},{default:o(()=>[(F(!0),Z(Y,null,se(n(T).showStyle,(E,O,I)=>(F(),A(t,{key:I,span:12},{default:o(()=>[e(U,{label:n(T).showStyleTranslate[O]},{default:o(()=>[e(C,{modelValue:n(T).showStyle[O],"onUpdate:modelValue":a=>n(T).showStyle[O]=a,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),Ot,e(B,{gutter:20},{default:o(()=>[e(ee,{modelValue:n(k),"onUpdate:modelValue":d[0]||(d[0]=E=>G(k)?k.value=E:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),e(X,{config:n(T).configValues,lines:n(N),runtime:n(k),"show-style":n(T).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});const Pt=Fe(Lt,[["__scopeId","data-v-52d0d6b5"]]),H=S=>(he("data-v-5e27f294"),S=S(),ve(),S),Mt={class:"alerts-container"},Rt={class:"slider-demo-block"},qt=H(()=>_("span",null,"模拟时间：",-1)),Jt={class:"timeline-info-config"},Ht=H(()=>_("span",null,"显示名称：",-1)),Kt={class:"timeline-info-config"},Qt=H(()=>_("span",null,"限定地图：",-1)),Wt={class:"timeline-info-config"},Zt=H(()=>_("span",null,"限定职业：",-1)),Gt={class:"timeline-info-config"},Xt=H(()=>_("span",null,"战斗来源：",-1)),Yt={class:"timeline-info-config"},en=H(()=>_("span",null,"创建时间：",-1)),tn={style:{flex:"1"}},nn={style:{"max-height":"353px"}},on={class:"timeline-timeline-view"},ln=H(()=>_("br",null,null,-1)),sn=H(()=>_("br",null,null,-1)),an=be({__name:"timelineSettings",setup(S){const{wsConnected:L}=$t({allowClose:!0,addWsParam:!0}),w=D(0),u=Te(),T=xe(u,"allTimelines"),K=xe(u,"filters"),k=[{id:"0",name:"任意"}],N=D(!1),z=D(!1),d=Ie({timeline:{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}),C=D([]);let U=null,t=!1;E();async function B(){C.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],C.value=await bt(d.timeline.timeline)}ee();function ee(){var r,l,f;for(const i in we)if(Object.prototype.hasOwnProperty.call(we,i)){const b=we[i];switch(b.contentType){case 4:case 5:case 28:k.push({id:i,name:((r=b.name)==null?void 0:r.cn)??((l=b.name)==null?void 0:l.ja)??((f=b.name)==null?void 0:f.ja)??i})}}v(),u.sortTimelines()}function X(r,l={}){St({call:"broadcast",source:"soumaTimelineSettings",msg:{type:r,data:l}})}function te(){N.value=!0,E()}function ne(){const r="https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8";window.open(r,"_blank")}function E(){w.value=-30,d.timeline={name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}function O(){d.timeline=u.allTimelines[u.newTimeline()],B()}function I(r){window.scrollTo({top:0,behavior:"smooth"}),d.timeline=r,B()}function a(r){j.confirm(`确定要删除「${r.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{E(),T.value.splice(T.value.findIndex(l=>l===r),1)}).catch(()=>{})}function v(){u.loadTimelineSettings()}function $(r){const l=JSON.stringify(r),f=JSON.parse(l);for(const q of f)q.timeline=q.timeline.replace(/^#.*\n/gm,"");const i=JSON.stringify(f),b=de.compressToBase64(l),g=de.compressToBase64(i),x=b.length,R=g.length;if(x===R){Ee(b).then(()=>{M({message:"数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})});return}const _e=((x-R)/x*100).toFixed(2);j.confirm(`
     1. 完整版本（包含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${x} 字节<br>
     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>
     2. 优化版本（不含注释）<br>
     &nbsp;&nbsp;&nbsp;- 大小：${R} 字节<br>
     &nbsp;&nbsp;&nbsp;- 节省 ${_e}% 的空间<br>
     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:q=>{(q==="cancel"||q==="confirm")&&Ee(q==="confirm"?g:b).then(()=>{M({message:"压缩数据复制成功，已写入剪切板。",type:"success",duration:2e3})}).catch(()=>{M({message:"复制失败，请手动复制！",type:"error",duration:3e3})})}})}function m(){j.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:r=>{if(!r)return"请输入导出的字符串";const l=r.split(`
`).filter(i=>i.trim()!=="");let f=[];for(const i of l){let b;try{b=JSON.parse(i)}catch{try{const g=de.decompressFromBase64(i);b=JSON.parse(g)}catch{return`无法解析输入的数据：${i}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(b))return`导入的数据格式不正确：${i}`;f=f.concat(b)}return f.length===0?"导入的数据不包含任何时间轴。":!0},inputErrorMessage:"无效的输入"}).then(({value:r})=>{const l=r.split(`
`).filter(g=>g.trim()!=="");let f=[];for(const g of l){let x;try{x=JSON.parse(g)}catch{const R=de.decompressFromBase64(g);x=JSON.parse(R)}f=f.concat(x)}const i=f.length,b=f.map(g=>`「${g.name}」`).join(", ");j({title:"确认",message:`导入 ${i} 个时间轴：
${b}
？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:g=>{g==="cancel"?j.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:x})=>{x==="我确认"&&p(f,!0)}).catch(()=>{}):g==="confirm"&&p(f,!1)}})}).catch(()=>{})}function p(r,l){l&&(u.allTimelines.length=0),u.allTimelines.push(...r),u.sortTimelines();for(const g of u.allTimelines)g.condition.jobs===void 0&&(g.condition.jobs=[g.condition.job]);if(E(),l){M({type:"success",message:"覆盖成功！",duration:2e3});return}const f=[],i=new Set;for(const g of u.allTimelines){const x=JSON.stringify({name:g.name,condition:g.condition,timeline:g.timeline,codeFight:g.codeFight,create:g.create});i.has(x)||(i.add(x),f.push(g))}const b=u.allTimelines.length-f.length;u.allTimelines=f,M({message:`追加成功！共导入 ${r.length} 个时间轴${b>0?`，但其中 ${b} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}const V=Le(()=>`${(w.value<0?"-":"")+(Array(2).join("0")+(Math.floor(w.value/60)+(w.value<0?1:0))).slice(-2)}:${(Array(2).join("0")+Math.floor(w.value%60)).slice(-2)}`);function y(){d.timeline.timeline=d.timeline.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(r,l)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(r.toString())?Ce.duration(`00:${r.toString()}`).as("seconds").toString():Ce.utc(Number.parseFloat(r.toString())*1e3).format("mm:ss.S"))}function oe(){const r=Vt.resolve({path:"/timelineHelp"}).href;window.open(r,"_blank")}function me(r){u.configValues=r.configValues,u.showStyle=r.showStyle}const le=r=>{if(r.source==="soumaTimeline"&&r.msg.type==="post"){t=!1,U.close();const l=r.msg.data;for(const f of l.allTimelines)f.condition.jobs===void 0&&(f.condition.jobs=[f.condition.job]),f.condition.jobs.sort((i,b)=>u.jobList.indexOf(i)-u.jobList.indexOf(b)),Reflect.deleteProperty(f.condition,"job");u.allTimelines=l.allTimelines,u.configValues=l.configValues,u.showStyle=l.showStyle,M.closeAll(),M({message:"数据获取成功",type:"success",duration:3e3})}};function Q(){t=!0,U=ut.service({lock:!0,text:"正在请求数据，请确保 ACT 与悬浮窗已开启...，若 10 秒内仍未获取到数据，请检查 ACT 状态，且确认 timeline 悬浮窗已开启，或刷新页面重连。",background:"rgba(0, 0, 0, 0.7)"}),X("get"),setTimeout(()=>{t&&(M.info("重新尝试获取数据..."),Q())},5e3)}function pe(){j.confirm("你确定要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{X("post",u.$state)})}function fe(){E(),Q()}return at(()=>{Ft("BroadcastMessage",le);const r=rt(L,l=>{l&&(u.allTimelines.length===0&&Q(),r())})}),(r,l)=>{const f=Pt,i=ke,b=mt,g=pt,x=Pe,R=ft,_e=_t,q=zt,Se=Re,Je=Me,ae=Be,Ve=Oe,$e=je,He=qe,ge=ze,re=Ue,Ke=De,Qe=gt,We=yt,Ze=wt;return F(),A(Ze,{class:"container"},{default:o(()=>[e(f,{modelValue:n(z),"onUpdate:modelValue":l[0]||(l[0]=c=>G(z)?z.value=c:null),onSave:me},null,8,["modelValue"]),e(_e,{class:"flex-header"},{default:o(()=>[e(x,{justify:"space-between",align:"middle","m-b-2":""},{default:o(()=>[e(g,{wrap:"",size:10},{default:o(()=>[e(b,null,{default:o(()=>[e(i,{type:"primary",size:"small",onClick:te},{default:o(()=>[h(" 从 FFlogs 生成 ")]),_:1}),e(i,{type:"primary",size:"small",onClick:ne},{default:o(()=>[h(" 从 在线文档 获取 ")]),_:1}),e(i,{type:"primary",size:"small",onClick:O},{default:o(()=>[h(" 手动编写 ")]),_:1})]),_:1}),e(b,null,{default:o(()=>[e(i,{size:"small",onClick:m},{default:o(()=>[h(" 导入字符串 ")]),_:1}),e(i,{size:"small",class:"export",onClick:l[1]||(l[1]=c=>$(n(T)))},{default:o(()=>[h(" 导出全部 ")]),_:1})]),_:1}),e(i,{size:"small",onClick:oe},{default:o(()=>[h(" 时间轴语法 ")]),_:1}),e(i,{type:"success",size:"small",onClick:pe},{default:o(()=>[h(" 应用 ")]),_:1})]),_:1}),e(g,null,{default:o(()=>[e(i,{color:"#a0d911",style:{color:"white"},size:"small",onClick:fe},{default:o(()=>[h(" 恢复至之前的时间轴 ")]),_:1}),e(i,{color:"#626aef",style:{color:"white"},size:"small",onClick:l[2]||(l[2]=c=>z.value=!0)},{default:o(()=>[h(" 设置 ")]),_:1})]),_:1})]),_:1}),_("div",Mt,[e(R,{title:"编辑完成后，需手动点击「应用」按钮","show-icon":"",type:"info",closable:!1,class:"alert-item"}),e(R,{title:"当你误操作或数据与 ACT 悬浮窗中的数据不符，且尚未点击「应用」时，可点击「恢复至之前的时间轴」，则会恢复到当前 ACT 悬浮窗中保存的数据","show-icon":"",type:"warning",closable:!1,class:"alert-item"})])]),_:1}),e(We,null,{default:o(()=>[e(Se,{modelValue:n(N),"onUpdate:modelValue":l[4]||(l[4]=c=>G(N)?N.value=c:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>N.value=!1},{default:o(()=>[e(q,{filters:n(K),onClearCurrentlyTimeline:E,onShowFFlogsToggle:l[3]||(l[3]=()=>N.value=!1),onNewTimeline:n(u).newTimeline,onUpdateFilters:n(u).updateFilters},null,8,["filters","onNewTimeline","onUpdateFilters"])]),_:1},8,["modelValue","before-close"]),ct(e(ge,null,{default:o(()=>[_("div",Rt,[qt,e(Je,{modelValue:n(w),"onUpdate:modelValue":l[5]||(l[5]=c=>G(w)?w.value=c:null),min:-30,max:1500,step:.1,"show-input":""},null,8,["modelValue"]),_("div",null,W(n(V)),1)]),e(x,{class:"timeline-info"},{default:o(()=>[_("div",null,[_("p",Jt,[Ht,e(ae,{modelValue:n(d).timeline.name,"onUpdate:modelValue":l[6]||(l[6]=c=>n(d).timeline.name=c),class:"timeline-info-name"},null,8,["modelValue"])]),_("p",Kt,[Qt,e($e,{modelValue:n(d).timeline.condition.zoneId,"onUpdate:modelValue":l[7]||(l[7]=c=>n(d).timeline.condition.zoneId=c),filterable:""},{default:o(()=>[(F(),Z(Y,null,se(k,c=>e(Ve,{key:c.id,label:c.name,value:c.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_("p",Wt,[Zt,e($e,{modelValue:n(d).timeline.condition.jobs,"onUpdate:modelValue":l[8]||(l[8]=c=>n(d).timeline.condition.jobs=c),multiple:"",required:"",placeholder:"职业","collapse-tags":"","collapse-tags-tooltip":""},{default:o(()=>[(F(!0),Z(Y,null,se(n(u).jobList,c=>{var P;return F(),A(Ve,{key:c,label:(((P=n(ie).nameToFullName(c))==null?void 0:P.cn)??c).replace("冒险者","全部职业"),value:c},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])]),_("p",Gt,[Xt,e(ae,{modelValue:n(d).timeline.codeFight,"onUpdate:modelValue":l[9]||(l[9]=c=>n(d).timeline.codeFight=c),disabled:""},null,8,["modelValue"])]),_("p",Yt,[en,e(ae,{modelValue:n(d).timeline.create,"onUpdate:modelValue":l[10]||(l[10]=c=>n(d).timeline.create=c),disabled:""},null,8,["modelValue"])]),e(x,{"m-b-10px":""},{default:o(()=>[e(i,{span:12,class:"export",onClick:l[11]||(l[11]=c=>$([n(d).timeline]))},{default:o(()=>[h(" 单独导出 ")]),_:1}),e(i,{type:"primary",span:12,onClick:l[12]||(l[12]=c=>y())},{default:o(()=>[h(" 切换时间 ")]),_:1})]),_:1}),e(x,null,{default:o(()=>[e(i,{span:24,onClick:l[13]||(l[13]=c=>E())},{default:o(()=>[h(" 隐藏编辑界面 ")]),_:1})]),_:1})]),_("div",tn,[e(ae,{modelValue:n(d).timeline.timeline,"onUpdate:modelValue":l[14]||(l[14]=c=>n(d).timeline.timeline=c),class:"timeline-timeline-raw",type:"textarea",rows:12,wrap:"off",placeholder:"请键入时间轴文本",style:{"max-width":"569px"},onChange:l[15]||(l[15]=c=>B())},null,8,["modelValue"])]),_("div",nn,[_("div",on,[e(He,{config:n(u).configValues,lines:n(C),runtime:n(w),"show-style":n(u).showStyle},null,8,["config","lines","runtime","show-style"])])])]),_:1}),ln]),_:1},512),[[dt,n(d).timeline.create!=="空"]]),sn,n(T).length>0?(F(),A(ge,{key:0},{default:o(()=>[e(Ke,{data:n(T),style:{width:"100%"},stripe:""},{default:o(()=>[e(re,{prop:"name",label:"名称"}),e(re,{prop:"conditon",label:"地图",sortable:""},{default:o(c=>{var P;return[h(W((P=k.find(ce=>ce.id===c.row.condition.zoneId))==null?void 0:P.name),1)]}),_:1}),e(re,{prop:"conditon",label:"职业"},{default:o(c=>[h(W(c.row.condition.jobs.map(P=>{var ce;return((ce=n(ie).nameToFullName(P.toUpperCase()))==null?void 0:ce.cn)??P}).join("、").replace("冒险者","全部职业")),1)]),_:1}),e(re,{fixed:"right",label:"操作",width:"150"},{default:o(c=>[e(i,{type:"primary",size:"small",onClick:P=>I(c.row)},{default:o(()=>[h(" 编辑 ")]),_:2},1032,["onClick"]),e(i,{type:"danger",size:"small",onClick:P=>a(c.row)},{default:o(()=>[h(" 删除 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):J("",!0),n(T).length===0?(F(),A(ge,{key:1},{default:o(()=>[e(Qe,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):J("",!0)]),_:1})]),_:1})}}});const bn=Fe(an,[["__scopeId","data-v-5e27f294"]]);export{bn as default};
