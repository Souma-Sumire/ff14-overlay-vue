import{_ as e}from"./ActWrapper-6c4cf913.js";import{u as t,p as i,_ as o}from"./TimelineShow-bde8f448.js";import"./index-5bc95ff7.js";import{b as n,I as l,y as a}from"./element-plus-cb4c922a.js";import{u as s}from"./useDev-cab88d81.js";import{t as c}from"./tts-5e313398.js";import{c as m,a as r}from"./overlay_plugin_api-974cdd44.js";import{u}from"./index-c9f4301b.js";import{t as d,V as p,r as f,c as g,e as y,D as v,E as T,x as b,A as j,v as h,H as k,M as x,u as C,L as w,aa as A,G as _,J as I,K as O}from"./vue-vendor-6f37fd53.js";import{_ as S}from"./_plugin-vue_export-helper-6a8c15be.js";/* empty css                */import"./useDemo-dea69d31.js";import"./status-9bc9036c.js";import"./regexes-da03e94d.js";import"./util-3591e9ca.js";import"./chineseToIcon-e0fcd48d.js";import"./xivapi-72ab0990.js";const V={id:"wrapper"},D={key:0,class:"optionalTimelines"},E=["onClick"],B={key:7,style:{color:"white","background-color":"black"}},L=S(d({__name:"timeline",setup(d){const S=t(),L=p({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),N=f(0),z=f(0-S.configValues.preBattle),G=f(0);let $=!1;const F=u("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),J=s(),K=g(()=>L.loadedTimeline.filter(e=>e.sync)),M=g(()=>L.loadedTimeline.filter(e=>e.tts));function P(){H(),L.loadedTimeline.length=0,L.optionalTimeline.length=0;const e=S.getTimeline(F.value);1===e.length?q(e[0]):e.length>1&&(L.optionalTimeline=e,q(e[0]))}async function q(e,t=!0){L.selectedOptionalTimeline=e,t&&H(),$=!1,e?.timeline&&(L.loadedTimeline=await i(e.timeline),L.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{$=!0},1e3)}function H(){N.value=0,z.value=0-S.configValues.preBattle,G.value=0;for(const e of L.loadedTimeline)e.alertAlready=!1;for(const e of K.value)e.syncAlready=!1}function Q(e,t=!0){t&&($=!1,setTimeout(()=>{$=!0},1e3)),z.value=0,G.value=0,N.value=(new Date).getTime()+1e3*e,M.value.forEach(e=>{e.alertAlready=!1}),R()}function R(){if(0===N.value)return;z.value=((new Date).getTime()-N.value+G.value)/1e3;const e=M.value.find(e=>!e.alertAlready&&e.time-S.configValues.ttsAdvance<=z.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;($||t)&&c(e)}(e.tts)),requestAnimationFrame(R)}function W(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)Q(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))H();else{const e=K.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&z.value>=e.time-e.windowBefore&&z.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,Z(e.jump||e.time))}}}function Z(e){0===N.value&&Q(0,!1),G.value+=1e3*(e-z.value),M.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}y(()=>{r("onLogEvent",W),r("onPlayerChangedEvent",U),r("ChangeZone",X),r("BroadcastMessage",te),r("onInCombatChangedEvent",ie),S.loadTimelineSettings(),n({message:`${S.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),P(),ee("hello")});const U=e=>{F.value.jobs[0]!==e.detail.job&&(F.value.jobs[0]=e.detail.job,P())},X=e=>{F.value.zoneId=String(e.zoneID),P()};function Y(){n.closeAll(),n({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){m({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>S.jobList.indexOf(e)-S.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");S.allTimelines=t.allTimelines,S.configValues=t.configValues,S.showStyle=t.showStyle,S.saveTimelineSettings(),n.closeAll(),n({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),P(),ee("success")}"get"===e.msg.type&&ee("post",S.$state)}};function ie(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===N.value?Q(0):e.detail.inGameCombat||e.detail.inACTCombat||H()}return(t,i)=>{const n=l,s=o,m=e;return b(),v(m,null,{default:T(()=>[j("div",V,[C(L).optionalTimeline.length&&C(z)<=-C(S).configValues.preBattle?(b(),h("ul",D,[i[5]||(i[5]=j("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(b(!0),h(w,null,A(C(L).optionalTimeline,(e,t)=>(b(),h("li",{key:t,class:_(C(L).selectedOptionalTimeline===e?"active":""),onClick:t=>{q(e)}},[I(O(e.name)+" ",1),C(L).selectedOptionalTimeline===e?(b(),v(n,{key:0},{default:T(()=>[x(C(a))]),_:1})):k("",!0)],10,E))),128))])):k("",!0),x(s,{config:C(S).configValues,lines:C(L).loadedTimeline,runtime:C(z),"show-style":C(S).showStyle},null,8,["config","lines","runtime","show-style"]),C(J)?(b(),h("button",{key:1,onClick:i[0]||(i[0]=e=>Q(30))}," 开始从-30 ")):k("",!0),C(J)?(b(),h("button",{key:2,onClick:i[1]||(i[1]=e=>Q(0))}," 开始从0 ")):k("",!0),C(J)?(b(),h("button",{key:3,onClick:i[2]||(i[2]=e=>H())}," 团灭 ")):k("",!0),C(J)?(b(),h("button",{key:4,onClick:i[3]||(i[3]=e=>{Z(1e3)})}," 跳转1000测试 ")):k("",!0),C(J)?(b(),h("button",{key:5,onClick:i[4]||(i[4]=e=>C(c)("今天天气真不错"))}," TTS测试 ")):k("",!0),C(J)?(b(),h("button",{key:6,onClick:Y}," 弹窗测试 ")):k("",!0),C(J)?(b(),h("span",B,O(C(z)),1)):k("",!0)])]),_:1})}}}),[["__scopeId","data-v-4043b642"]]);export{L as default};
