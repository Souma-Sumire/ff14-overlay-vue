import{_ as e}from"./ActWrapper-C629LfT2.js";import{u as t,p as o,_ as i}from"./TimelineShow-DdbjHt3k.js";import{d as n,f as l,r as a,g as s,h as c,E as m,j as r,w as u,o as d,a as p,c as f,B as g,b as y,u as v,F as T,l as b,q as h,e as j,t as k,T as w,H as C}from"./index-BtmHwF1M.js";import{u as x}from"./useDev-NzU47f4H.js";import{t as A}from"./tts-BkZGqxam.js";import{c as _,a as O}from"./overlay_plugin_api-DHbPkDtN.js";import{u as S}from"./index-t8RvCCCJ.js";import{_ as E}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./el-card-CreDxL7d.js";import"./useDemo-B70g8ZN8.js";import"./status-VujwLG_3.js";import"./regexes-BKeG-dSP.js";import"./util-BOtaAWHW.js";import"./chineseToIcon-xFdmTerz.js";import"./xivapi-a6oZXlzI.js";const I={id:"wrapper"},B={key:0,class:"optionalTimelines"},D=["onClick"],V={key:7,style:{color:"white","background-color":"black"}},z=E(n({__name:"timeline",setup(n){const E=t(),z=l({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),L=a(0),N=a(0-E.configValues.preBattle),F=a(0);let G=!1;const H=S("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),$=x(),q=s(()=>z.loadedTimeline.filter(e=>e.sync)),P=s(()=>z.loadedTimeline.filter(e=>e.tts));function J(){R(),z.loadedTimeline.length=0,z.optionalTimeline.length=0;const e=E.getTimeline(H.value);1===e.length?M(e[0]):e.length>1&&(z.optionalTimeline=e,M(e[0]))}async function M(e,t=!0){z.selectedOptionalTimeline=e,t&&R(),G=!1,e?.timeline&&(z.loadedTimeline=await o(e.timeline),z.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{G=!0},1e3)}function R(){L.value=0,N.value=0-E.configValues.preBattle,F.value=0;for(const e of z.loadedTimeline)e.alertAlready=!1;for(const e of q.value)e.syncAlready=!1}function W(e,t=!0){t&&(G=!1,setTimeout(()=>{G=!0},1e3)),N.value=0,F.value=0,L.value=(new Date).getTime()+1e3*e,P.value.forEach(e=>{e.alertAlready=!1}),Y()}function Y(){if(0===L.value)return;N.value=((new Date).getTime()-L.value+F.value)/1e3;const e=P.value.find(e=>!e.alertAlready&&e.time-E.configValues.ttsAdvance<=N.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;(G||t)&&A(e)}(e.tts)),requestAnimationFrame(Y)}function Z(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)W(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:400000(?:0F|10|03)/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))R();else{const e=q.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&N.value>=e.time-e.windowBefore&&N.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,K(e.jump||e.time))}}}function K(e){0===L.value&&W(0,!1),F.value+=1e3*(e-N.value),P.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}c(()=>{O("onLogEvent",Z),O("onPlayerChangedEvent",Q),O("ChangeZone",U),O("BroadcastMessage",te),O("onInCombatChangedEvent",oe),E.loadTimelineSettings(),m({message:`${E.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),J(),ee("hello")});const Q=e=>{H.value.jobs[0]!==e.detail.job&&(H.value.jobs[0]=e.detail.job,J())},U=e=>{H.value.zoneId=String(e.zoneID),J()};function X(){m.closeAll(),m({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){_({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>E.jobList.indexOf(e)-E.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");E.allTimelines=t.allTimelines,E.configValues=t.configValues,E.showStyle=t.showStyle,E.saveTimelineSettings(),m.closeAll(),m({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),J(),ee("success")}"get"===e.msg.type&&ee("post",E.$state)}};function oe(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===L.value?W(0):e.detail.inGameCombat||e.detail.inACTCombat||R()}return(t,o)=>{const n=w,l=i,a=e;return d(),r(a,null,{default:u(()=>[p("div",I,[v(z).optionalTimeline.length&&v(N)<=-v(E).configValues.preBattle?(d(),f("ul",B,[o[5]||(o[5]=p("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(d(!0),f(T,null,b(v(z).optionalTimeline,(e,t)=>(d(),f("li",{key:t,class:h(v(z).selectedOptionalTimeline===e?"active":""),onClick:t=>{M(e)}},[j(k(e.name)+" ",1),v(z).selectedOptionalTimeline===e?(d(),r(n,{key:0},{default:u(()=>[y(v(C))]),_:1})):g("",!0)],10,D))),128))])):g("",!0),y(l,{config:v(E).configValues,lines:v(z).loadedTimeline,runtime:v(N),"show-style":v(E).showStyle},null,8,["config","lines","runtime","show-style"]),v($)?(d(),f("button",{key:1,onClick:o[0]||(o[0]=e=>W(30))}," 开始从-30 ")):g("",!0),v($)?(d(),f("button",{key:2,onClick:o[1]||(o[1]=e=>W(0))}," 开始从0 ")):g("",!0),v($)?(d(),f("button",{key:3,onClick:o[2]||(o[2]=e=>R())}," 团灭 ")):g("",!0),v($)?(d(),f("button",{key:4,onClick:o[3]||(o[3]=e=>{K(1e3)})}," 跳转1000测试 ")):g("",!0),v($)?(d(),f("button",{key:5,onClick:o[4]||(o[4]=e=>v(A)("今天天气真不错"))}," TTS测试 ")):g("",!0),v($)?(d(),f("button",{key:6,onClick:X}," 弹窗测试 ")):g("",!0),v($)?(d(),f("span",V,k(v(N)),1)):g("",!0)])]),_:1})}}}),[["__scopeId","data-v-68379865"]]);export{z as default};
