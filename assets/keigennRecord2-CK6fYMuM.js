import{_ as e,e as t}from"./shared-common-BkdhSTGj.js";import{d as a,dx as n,x as s,w as o,I as l,o as i,b7 as r,dz as c,G as d,D as u,c as m,b as p,e as f,g,a as v,n as h,f as y,s as b,t as k,i as w,F as I,y as C,z as j,r as S,h as N,b9 as R,j as D,l as E,p as T,v as A,bW as $,cj as x,cO as _,ch as L,b8 as M}from"./vendor-vue-MSvGQJWD.js";import{u as P,af as O,s as H,y as F,U as V,ad as z,q as J,f as K,a1 as B,Z as G,l as W,ag as Z,v as U,ah as Y,ai as q,aj as X,ak as Q,B as ee,al as te,am as ae,a8 as ne,an as se,t as oe}from"./shared-core-BcyVo5ua.js";import{E as le,a as ie,aG as re,aH as ce,w as de,J as ue,t as me,g as pe,aI as fe,aJ as ge,n as ve}from"./vendor-element-plus-CsMNiL2J.js";import{N as he,a as ye,l as be}from"./cactbot-DtpbXwrG.js";const ke={class:"table-wrapper"},we={key:0,class:"row-info"},Ie={class:"info-line"},Ce={class:"info-line"},je={class:"info-line"},Se={class:"info-line"},Ne={class:"info-line"},Re={key:1,class:"skill-popover-content"},De={class:"subtitle"},Ee={class:"skill-grid"},Te={key:0,class:"skill-divider"},Ae={class:"skill-wrapper"},$e=["title"],xe=["src"],_e={class:"skill-text"},Le={key:0,class:"skill-charges"},Me={class:"subtitle"},Pe={class:"skill-grid"},Oe={key:0,class:"skill-divider"},He={class:"skill-wrapper"},Fe=["title"],Ve=["src"],ze={key:0,class:"skill-charges"},Je={key:2,class:"no-data"},Ke={key:2,class:"death-recap-popover"},Be={class:"recap-header"},Ge={class:"align-right"},We={class:"time"},Ze={class:"ability-cell"},Ue={class:"ability-content"},Ye=["src"],qe=["title"],Xe={class:"status-cell"},Qe={class:"status-content"},et=["title","data-duration"],tt=["src"],at=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e,{expose:t}){const{t:a}=P(),R=e,D=O(),E=D.userOptions,T=n("contextMenu"),A=s(""),$=s("");o(()=>R.rows,e=>{0===e.length&&(A.value="",$.value="")},{immediate:!0});const x=s(!1),_=s(0),L=s(0),M=s(null),z=s(null),J=s({getBoundingClientRect:()=>({top:0,left:0,bottom:0,right:0,width:0,height:0})}),K=s(null),B=s(!1),G=s("top"),W=l([]);function Z(e,t,a){B.value&&z.value?.key===e.key&&K.value===t||(K.value=t,"skills"===t?G.value="left":"death-recap"===t?(G.value="auto",function(e){const t=e.targetId,a=e.timestamp,n=a-2e4,s=[],o=R.rows.indexOf(e);if(-1===o)return;for(let i=o;i>=0;i--){const e=R.rows[i];if(e)if(e.timestamp<=a&&e.timestamp>=n)e.targetId===t&&s.push(e);else if(e.timestamp<n&&"push"===D.userOptions.order)break}for(let i=o+1;i<R.rows.length;i++){const e=R.rows[i];if(e)if(e.timestamp<=a&&e.timestamp>=n)e.targetId===t&&s.push(e);else if(e.timestamp<n&&"unshift"===D.userOptions.order)break}const l=Array.from(new Set(s)).sort((e,t)=>t.timestamp-e.timestamp);W.value=l.map(e=>{const t="heal"===e.effect,n="death"===e.type,s=!t&&e.amount>0&&!n;let o="",l="";t?(o="+",l="is-heal"):s&&(o="-",l="is-damage");const i=e.amount>0||t?o+e.preCalculated.amountDisplay:e.preCalculated.amountDisplay;return{key:e.key,timeStr:((e.timestamp-a)/1e3).toFixed(1).replace("-0.0","0.0")+"s",amountStr:i,amountClass:l,actionCN:e.actionCN,isDeath:n,iconSrc:"",keigenns:e.preCalculated.keigenns}})}(e)):G.value="right",z.value=e,J.value=a.currentTarget,B.value=!0)}const U={x:0,y:0},Y=e=>{U.x=e.clientX,U.y=e.clientY};let q=0;const X=e=>{x.value&&(x.value=!1);const t=e.target;t?.closest(".keigenn-global-popover")||(cancelAnimationFrame(q),q=requestAnimationFrame(()=>{((e,t)=>{const a=document.elementFromPoint(e,t),n=a?.closest("[data-row-key][data-hover-mode]");if(n){const e=n.dataset.rowKey,t=n.dataset.hoverMode,a=ve.value.find(t=>t.key===e);if(a)return void Z(a,t,{currentTarget:n})}B.value=!1})(U.x,U.y)}))},Q=n("tableContainer");i(()=>{Q.value?.addEventListener("wheel",X,{passive:!0}),window.addEventListener("mousemove",Y,{passive:!0})}),r(()=>{Q.value?.removeEventListener("wheel",X),window.removeEventListener("mousemove",Y)}),c(T,()=>{x.value=!1});const ee=a("keigennRecord.cancelFilter"),te=d(()=>{const e=R.rows.filter(e=>D.debugShowHeals||"heal"!==e.effect),t=Array.from(new Set(e.map(e=>e[R.actionKey]))).filter(e=>null!=e);return[{label:ee,value:""},...t.map(e=>({label:e,value:e}))]}),ae=d(()=>{const e=R.rows.filter(e=>D.debugShowHeals||"heal"!==e.effect),t=Array.from(new Map(e.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:ee,value:"",job:-1},...t.map(e=>({label:e.job,fullLabel:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>V.enumSortMethod(e.job,t.job))});function ne(){if(M.value){const e=M.value[R.actionKey];A.value===e?A.value="":A.value=e,x.value=!1}}function se(){if(M.value){const e=M.value.targetId;$.value===e?$.value="":$.value=e,x.value=!1}}const oe=(e,t="")=>u("div",{class:["header-static",t]},e),fe=()=>u("div"),ge=e=>u("div",{class:"header-filter"},[u(le,{size:"small",modelValue:e.modelValue,placeholder:e.placeholder,clearable:!1,style:`width:${e.width}`,teleported:!0,popperClass:"keigenn-header-select-popper",onChange:e.onUpdate},()=>e.options.map(e=>u(ie,{key:e.value,label:e.label,value:e.value},{default:()=>e.fullLabel||e.label})))]),ve=d(()=>{const e=R.rows.filter(e=>D.debugShowHeals||"heal"!==e.effect);return A.value&&A.value!==ee||$.value&&$.value!==ee?e.filter(e=>{const t=!A.value||A.value===ee||e[R.actionKey]===A.value,a=!$.value||$.value===ee||e.targetId===$.value;return t&&a}):e}),he=({rowData:e})=>"death"===e.type?"row-death":"",ye=[{key:"time",title:a("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>oe(a("keigennRecord.time"),"header-time")},{key:"action",title:a("keigennRecord.action"),dataKey:R.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>u(ge,{modelValue:A.value,options:te.value,placeholder:a("keigennRecord.action"),width:"4.5em",onUpdate:e=>A.value=e===ee?"":e}),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source;return u("div",{class:"death-message-left"},[u("span","ðŸ’€ "),u("span",{class:"death-target-name"},e.target),u("span",t?[u("span"," å›  "),u("span",{class:"death-terrain"},"åœ°å½¢æ€"),u("span"," å€’ä¸‹äº†ï¼")]:[u("span"," è¢« "),u("span",{class:"death-source-name"},e.source),u("span"," åšæŽ‰äº†ï¼")]),u("span",{class:"death-recap-inline","data-row-key":e.key,"data-hover-mode":"death-recap",onMouseenter:t=>{Z(e,"death-recap",t)}}," [æ­»äº¡å›žæ”¾]")])}return u("span",e[R.actionKey]??"")}},{key:"target",title:a("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>u(ge,{modelValue:$.value,options:ae.value,placeholder:a("keigennRecord.target"),width:"4.7em",onUpdate:e=>$.value=e===ee?"":e}),cellRenderer:({rowData:e})=>"death"===e.type?fe():u("div",{class:"target"},[e.preCalculated.jobIconSrc?u("img",{class:[D.isBrowser?"browser":"act","jobIcon",`cj${D.userOptions.iconType}`],src:e.preCalculated.jobIconSrc,alt:e.jobIcon,onError:e=>{e.target.style.display="none"}}):u("span",{class:"alt-text"},e.job),e.hasDuplicate?u("span",{class:"has-duplicate"},D.formatterName(e.target)):void 0])},{key:"amount",title:a("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",headerCellRenderer:()=>oe(a("keigennRecord.amount")),cellRenderer:({rowData:e})=>"death"===e.type?fe():u("span",{class:"amount","data-row-key":e.key,"data-hover-mode":"amount",onMouseenter:t=>Z(e,"amount",t)},[u("span",{class:e.preCalculated.damageTypeClass},e.preCalculated.amountDisplay)])},{key:"reduction",title:a("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>oe(a("keigennRecord.reduction"),"header-reduction"),cellRenderer:({rowData:e})=>"death"===e.type?fe():u("span",{class:"col-reduction-number",style:{color:e.preCalculated.reductionColor}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:a("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",headerCellRenderer:()=>oe(a("keigennRecord.keigenns")),cellRenderer:({rowData:e})=>"death"===e.type?fe():u("div",{class:"status-container"},[...e.preCalculated.keigenns.map(e=>u("span",{class:"status-wrapper"},[u("span",{class:"status",title:e.title,"data-duration":e.duration,"data-sourcePov":e.isPov},[u("img",{class:["statusIcon",e.usefulClass],src:e.src,alt:e.effect,onError:H})])])),u("span",{class:"flags"},"damage done"===e.effect||"heal"===e.type?"":a(`keigennRecord.${e.effect}`))])},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>u("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:10}},"death"===e.type?void 0:u("div",{class:"view-icon","data-row-key":e.key,"data-hover-mode":"skills",onMouseenter:t=>Z(e,"skills",t)},[u("div",{class:"dots"},[u("i"),u("i"),u("i")])]))}];let be=null;const at={onClick:({rowData:e})=>{if("death"===e.type)return;const{actionCN:t,amount:n,job:s,keigenns:o,time:l,type:i,effect:r,currentHp:c,maxHp:d,shield:u,reduction:m}=e,p="damage done"===r?"":`,${a(`keigennRecord.${r}`)}`,f=`${l} ${s} ${t} ${n.toLocaleString()}(${a(`keigennRecord.${i}`)}) ${a("keigennRecord.reduction")}(${(100*m).toFixed(0)}%):${0===o.length&&""===p?a("keigennRecord.none"):o.map(e=>E.statusCN?e.name:e.effect).join(",")+p} ${a("keigennRecord.hp")}}:${c}(${Math.round(c/d*100)}%)+${a("keigennRecord.shield")}:${Math.round(d*+u/100)}(${u}%)`;F(f).then(()=>{be?.close(),be=pe.success({message:a("keigennRecord.copySuccess"),duration:800})}).catch(()=>pe.error(a("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const a=t;M.value=e,_.value=a.clientX,L.value=a.clientY,x.value=!0}},nt=s(null);return t({scrollToBottom:function(){nt.value&&nt.value.scrollToRow(ve.value.length-1)}}),(t,n)=>{const s=de,o=ce,l=me,i=ue,r=re;return v(),m("div",{ref_key:"tableContainer",ref:Q,class:"table-container"},[p("div",ke,[f(r,{style:{height:"100%",width:"100%"}},{default:g(({height:r,width:c})=>[f(o,{ref_key:"tableV2Ref",ref:nt,"header-class":"keigenn-table-header",class:"keigenn-table performance-table",columns:ye,data:ve.value,width:c,height:r,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":at,"row-class":he,"overscan-row-count":2},{empty:g(()=>[f(s,{description:y(D).isBrowser?t.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["data","width","height"]),y(x)?(v(),m("div",{key:0,ref_key:"contextMenu",ref:T,class:"context-menu",style:b({top:`${y(L)}px`,left:`${y(_)}px`})},[p("ul",null,[p("li",{onClick:ne},k(y(A)===(y(M)?.[e.actionKey]??"")?y(a)("keigennRecord.filter.action_cancel",{actionName:y(M)?.[e.actionKey]??y(a)("keigennRecord.this_skill")}):y(a)("keigennRecord.filter.action_only",{actionName:y(M)?.[e.actionKey]??y(a)("keigennRecord.this_skill")})),1),p("li",{onClick:se},k(y($)===y(M)?.targetId?y(a)("keigennRecord.filter.target_cancel",{jobName:y(M)?.job??y(a)("keigennRecord.this_job")}):y(a)("keigennRecord.filter.target_only",{jobName:y(M)?.job??y(a)("keigennRecord.this_job")})),1)])],4)):h("",!0),f(i,{visible:y(B),"onUpdate:visible":n[0]||(n[0]=e=>w(B)?B.value=e:null),"virtual-ref":y(J),"virtual-triggering":"","popper-class":"keigenn-global-popover",transition:"none","show-after":0,"hide-after":0,offset:6,enterable:!0,teleported:!0,placement:"top",width:"auto","fallback-placements":["top-end","top-start","bottom","bottom-end","bottom-start"]},{default:g(()=>[y(z)&&"amount"===y(K)?(v(),m("div",we,[p("div",Ie,k(y(a)("keigennRecord.source"))+": "+k(y(z).source),1),p("div",Ce,k(y(a)("keigennRecord.playerShield"))+": "+k(y(z).shield)+"%",1),p("div",je,k(y(a)("keigennRecord.playerHp"))+": "+k(y(z).currentHp.toLocaleString())+"("+k(y(z).preCalculated.hpPercent)+"%)",1),y(z).reduction<1&&"dot"!==y(z).type?(v(),m(I,{key:0},[n[1]||(n[1]=p("div",{class:"info-divider"},null,-1)),p("div",Se,k(y(a)("keigennRecord.reductionRate"))+": "+k((100*y(z).reduction).toFixed(2))+"%",1),p("div",Ne,[C(k(y(a)("keigennRecord.originalDamage"))+": ",1),p("span",{class:j(y(z).preCalculated.damageTypeClass)},k(y(z).preCalculated.originalDamageDisplay),3)])],64)):h("",!0)])):y(z)&&"skills"===y(K)?(v(),m("div",Re,[y(z).preCalculated.coolingDownSkills.length>0?(v(),m(I,{key:0},[p("div",De,k(y(a)("keigennRecord.coolingDown")),1),p("div",Ee,[(v(!0),m(I,null,S(y(z).preCalculated.coolingDownSkills,(e,t)=>(v(),m(I,{key:`${e.id}-${e.ownerId}`},[t>0&&"solo"===e.scope&&"party"===y(z).preCalculated.coolingDownSkills[t-1].scope?(v(),m("div",Te)):h("",!0),p("div",Ae,[p("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[p("img",{src:e.icon,class:"skill-icon"},null,8,xe),n[2]||(n[2]=p("div",{class:"skill-overlay"},null,-1)),p("span",_e,k(e.recastLeft),1),e.maxCharges&&e.maxCharges>1?(v(),m("span",Le,k(e.chargesReady),1)):h("",!0)],8,$e)])],64))),128))])],64)):h("",!0),y(z).preCalculated.readySkills.length>0?(v(),m(I,{key:1},[y(z).preCalculated.coolingDownSkills.length>0?(v(),N(l,{key:0})):h("",!0),p("div",Me,k(y(a)("keigennRecord.ready")||"å¯ç”¨"),1),p("div",Pe,[(v(!0),m(I,null,S(y(z).preCalculated.readySkills,(e,t)=>(v(),m(I,{key:`${e.id}-${e.ownerId}`},[t>0&&"solo"===e.scope&&"party"===y(z).preCalculated.readySkills[t-1].scope?(v(),m("div",Oe)):h("",!0),p("div",He,[p("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[p("img",{src:e.icon,class:"skill-icon"},null,8,Ve),e.maxCharges&&e.maxCharges>1?(v(),m("span",ze,k(e.chargesReady),1)):h("",!0)],8,Fe)])],64))),128))])],64)):h("",!0),0===y(z).preCalculated.coolingDownSkills.length&&0===y(z).preCalculated.readySkills.length?(v(),m("div",Je,k(y(a)("keigennRecord.noData")),1)):h("",!0)])):y(z)&&"death-recap"===y(K)?(v(),m("div",Ke,[p("div",Be,[p("span",null,k(y(a)("keigennRecord.time")),1),p("span",Ge,k(y(a)("keigennRecord.amount")),1),p("span",null,k(y(a)("keigennRecord.action")),1),p("span",null,k(y(a)("keigennRecord.keigenns")),1)]),(v(!0),m(I,null,S(y(W),e=>(v(),m("div",{key:e.key,class:j(["recap-row",{"is-death":e.isDeath}])},[p("span",We,k(e.timeStr),1),p("span",{class:j(["amount-cell align-right",e.amountClass])},k(e.amountStr),3),p("div",Ze,[p("div",Ue,[e.iconSrc?(v(),m("img",{key:0,src:e.iconSrc,class:"ability-icon"},null,8,Ye)):h("",!0),p("span",{class:"ability-name",title:e.actionCN},k(e.actionCN),9,qe)])]),p("div",Xe,[p("div",Qe,[(v(!0),m(I,null,S(e.keigenns,(e,t)=>(v(),m("div",{key:t,class:"status-wrapper"},[p("div",{class:j(["status",{"is-pov":e.isPov}]),title:e.title,"data-duration":e.duration},[p("img",{src:e.src,class:j(["status-icon",e.usefulClass])},null,10,tt)],10,et)]))),128))])])],2))),128))])):h("",!0)]),_:1},8,["visible","virtual-ref"])]),_:1})])],512)}}}),[["__scopeId","data-v-19e836e8"]]),nt="solo",st=[...z.filter(e=>1===e.line||2===e.line).map(({tts:e,duration:t,key:a,line:n,...s})=>({...s,scope:"party"})),{id:7531,recast1000ms:90,job:[1,3,19,21,32,37],minLevel:8,scope:nt},{id:"(lv) => lv>=92 ? 36920 : 17",recast1000ms:120,job:[19],minLevel:38,scope:nt},{id:"(lv) => lv>=92 ? 36923 : 44",recast1000ms:120,job:[21],minLevel:38,scope:nt},{id:"(lv) => lv>=92 ? 36927 : 3636",recast1000ms:120,job:[32],minLevel:38,scope:nt},{id:"(lv) => lv>=92 ? 36935 : 16148",recast1000ms:120,job:[37],minLevel:38,scope:nt},{id:22,recast1000ms:90,job:[19],minLevel:52,scope:nt},{id:40,recast1000ms:90,job:[21],minLevel:30,scope:nt},{id:3552,recast1000ms:60,job:[21],minLevel:58,scope:nt},{id:3634,recast1000ms:60,job:[32],minLevel:45,scope:nt},{id:25754,recast1000ms:30,job:[32],minLevel:82,scope:nt,maxCharges:2},{id:7393,recast1000ms:15,job:[32],minLevel:70,scope:nt},{id:7541,recast1000ms:120,job:[2,4,5,20,22,23,29,30,31,34,38,39,41],minLevel:1,scope:nt},{id:7542,recast1000ms:90,job:[2,20,4,22,29,30,34,39,41],minLevel:12,scope:nt},{id:16010,recast1000ms:30,job:[38],minLevel:10,scope:nt,maxCharges:3}],ot={class:"header-select"},lt={style:{height:"100%"}},it={key:0,class:"testLog"},rt="v20260131",ct=e(a({__name:"keigennRecord2",setup(e){const a=K(),n=O(),o=n.userOptions;n.checkIsBrowser();const c="push"===o.order,d=s(o.minimize),u=o.actionCN?"actionCN":"action",k=s(!1),w={POV_ID:"keigenn-record-2-pov-id",PARTY_LIST:"keigenn-record-2-party-list",ENTITIES_MAP:"keigenn-record-2-job-map",PARTY_EVENT:"keigenn-record-2-party-event-party",RSV_DATA:"souma-keigenn-record-2-rsv-data",ZONE_NAME:"souma-keigenn-record-2-zone-name",VERSION:"keigenn-record-2-data-version"};let P=!1;let H="",F=[],z={},re=[],ce={},de=0,ue="",me=0;const pe=s(0),ke=l([{zoneName:"",duration:"00:00",table:R([]),key:"init",timestamp:-1}]),we={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:he.ability(),statusEffectExplicit:he.statusEffectExplicit(),gainsEffect:he.gainsEffect(),losesEffect:he.losesEffect(),death:he.wasDefeated(),changeZone:he.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:he.addedCombatant(),removingCombatant:he.removingCombatant(),networkDoT:he.networkDoT()};let Ie={},Ce={friendly:{},enemy:{}},je={},Se=new Map;const Ne=st,Re=B("keigenn-record-2");function De(){k.value=!0,de=0,je={},pe.value=0,ke.value.length=0,ke.value.push({zoneName:"",duration:"00:00",table:R([]),key:"init",timestamp:-1}),Ie={},Ce={friendly:{},enemy:{}},z={},re=[],F=[],H="",me=0,Te.clear(),Me(),Se.clear(),ce={}}async function Ee(){k.value=!1,null!==He&&(cancelAnimationFrame(He),He=null,Oe.length>0&&(c?(ke.value[0].table.push(...Oe),M(()=>Fe.value?.scrollToBottom())):ke.value[0].table.unshift(...Oe.reverse()),Oe=[])),await Ke(),L(ke)}const Te=new Map;const Ae=n.icon4k;function $e(e){const t=function(e){const t=Math.round(100*e)/100;if(Te.has(t))return Te.get(t);const a=[88,88,88],n=[50,250,200],s=Math.min(1,t/.5),o=Math.min(9,Math.floor(10*s))/9,l=Math.pow(o,.8),i=a[0]+(n[0]-a[0])*l,r=a[1]+(n[1]-a[1])*l,c=a[2]+(n[2]-a[2])*l,d=`rgba(${Math.round(i)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return Te.set(t,d),d}(e.reduction),a=e.amount>999999?`${(e.amount/1e4).toFixed(0)}ä¸‡`:e.amount.toLocaleString(),n=((e,t)=>`https://souma.diemoe.net/resources/img/cj${t}/${e.replaceAll(/([A-Z])/g," $1").trim()}.png`)(e.jobIcon,o.iconType),{amount:s,maxHp:l,currentHp:i,shield:r,type:c,reduction:d}=e,u=Math.round(l*+r/100),m=Math.round(i/l*100),p=(s&&Math.round((s+u)/(1-d))||0).toLocaleString();return{...e,preCalculated:{reductionColor:t,amountDisplay:a,damageTypeClass:"heal"===e.effect?"is-heal":c,jobIconSrc:n,keigenns:e.keigenns.map(e=>({src:oe(`/i/${e.fullIcon}${Ae}.png`),usefulClass:se(e,c),title:`${o.statusCN?e.name:e.effect}(${e.source})`,duration:e.remainingDuration??"",isPov:e.isPov,effect:e.effect})),originalDamageDisplay:p,hpPercent:m,coolingDownSkills:e.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.scope!==t.scope?"party"===e.scope?-1:1:e.id!==t.id?e.id-t.id:e.recastLeft-t.recastLeft)??[],readySkills:e.keySkills?.filter(e=>e.ready).sort((e,t)=>e.scope!==t.scope?"party"===e.scope?-1:1:e.id!==t.id?e.id-t.id:V.enumSortMethod(e.ownerJob,t.ownerJob))??[]}}}function xe(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!we.gainsEffect.exec(e))return;const t=a[be.GainsEffect.fields.effectId],n=a[be.GainsEffect.fields.effect],s=a[be.GainsEffect.fields.target],o=a[be.GainsEffect.fields.targetId],l=Number.parseInt(a[be.GainsEffect.fields.count],16);let i=q(t);if(!i){const e=o.startsWith("1")&&X.get(Number.parseInt(t,16).toString())||o.startsWith("4")&&Q.get(Number.parseInt(t,16).toString());if(!e)return;const a=ee(e.icon),n=l>1?te(a,l):a;i={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[be.GainsEffect.fields.duration],c=a[be.GainsEffect.fields.source],d=a[be.GainsEffect.fields.sourceId],u=new Date(a[be.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:i.name,type:i.type,count:l,effect:n,effectId:t,source:c,sourceId:d,target:s,targetId:o,expirationTimestamp:u,performance:i.performance,fullIcon:i.fullIcon,isPov:H===d};o.startsWith("1")&&i.isFriendly?(void 0===Ce.friendly[o]&&(Ce.friendly[o]={}),Ce.friendly[o][t]=m):o.startsWith("4")&&!i.isFriendly&&(void 0===Ce.enemy[s]&&(Ce.enemy[s]={}),Ce.enemy[s][t]=m)}break;case"30":{const e=a[be.LosesEffect.fields.target],t=a[be.LosesEffect.fields.targetId],n=a[be.LosesEffect.fields.effectId];t.startsWith("1")?Ce.friendly[t]&&Reflect.deleteProperty(Ce.friendly[t],n):Ce.enemy[e]&&Reflect.deleteProperty(Ce.enemy[e],n)}break;case"21":case"22":{if(0===de)return;const e=a[be.Ability.fields.sourceId]??"???",t=a[be.Ability.fields.id]??"???",n=new Date(a[be.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),s=function(e){let t=Se.get(e);if(!t){t=new Map;for(const a of Ne){if(a.minLevel>e)continue;const n=ae(a.id,e);t.set(n,a)}Se.set(e,t)}return t}(z[e]?.level??999),o=s.get(a);if(o){je[e]||(je[e]={}),je[e][a]||(je[e][a]=[]);const t=je[e][a];t.push(n);const s=o.maxCharges||1;t.length>s&&t.shift()}}const s=Z(a),l=a[be.Ability.fields.targetId]??"???",i=s.isHeal&&s.amount>0&&l.startsWith("1"),r=s.isAttack&&s.amount>=0&&e.startsWith("4")&&l.startsWith("1");if(i||r){if(l!==H&&!F.includes(l)&&!re.find(e=>e.id===l))return;const e=a[be.Ability.fields.ability],r=e.match(/^_rsv_(?<id>\d+)_/);let c=e;if(r){const t=Number(r.groups?.id);c=ce[t]??e.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===o.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=U(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(a[be.Ability.fields.targetCurrentHp]),p=Number(a[be.Ability.fields.targetMaxHp]),f=a[be.Ability.fields.source]??"???",g=a[be.Ability.fields.target]??"???",{effect:v,type:h}=Y(s.flags),y=Be(0===de?0:n-de),{jobEnum:b,job:k,jobIcon:w,hasDuplicate:I}=Pe(l),C=Object.values(Ce.friendly[l]??[]).concat(Object.values(Ce.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),j=Ie[l]??"0",S=s.amount;let N=0;if(!i&&"instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of C)"absorbed"!==a.type&&(t*=a.performance[h]??1);N=1-t*e}Ve($e({key:(me++).toString(),time:y,timestamp:n,id:t,action:c,actionCN:u,source:f,target:g,targetId:l,job:k,jobIcon:w,jobEnum:b,hasDuplicate:I,amount:S,keigenns:C,currentHp:m,maxHp:p,effect:v,type:h,shield:j,povId:H,reduction:N,keySkills:Je(n,l)})),ke.value[0].duration=Be(new Date(a[be.Ability.fields.timestamp]).getTime()-de)}}break;case"25":{const t=we.death.exec(e);if(!t||!t.groups)return;const a=t.groups.targetId,n=t.groups.target,s=t.groups.sourceId,o="E0000000"===s?"åœ°å½¢æ€":t.groups.source,l=t.groups.timestamp;if(0===de)return;if(a!==H&&!F.includes(a)&&!re.find(e=>e.id===a))return;const i=new Date(l).getTime(),r=Be(i-de),{jobEnum:c,job:d,jobIcon:u,hasDuplicate:m}=Pe(a);Ve($e({key:(me++).toString(),time:r,timestamp:i,id:"",action:"Death",actionCN:"E0000000"===s?"åœ°å½¢æ€":"æ­»äº¡",source:o,target:n,targetId:a,job:d,jobIcon:u,jobEnum:c,hasDuplicate:m,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:H,reduction:0,keySkills:Je(i,a)}))}break;case"38":{const t=we.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Ie[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[be.InCombat.fields.inACTCombat],t="1"===a[be.InCombat.fields.inGameCombat],n=new Date(a[be.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[be.InCombat.fields.timestamp];if(de>0)return;return 0===ke.value[0].table.length&&0===Oe.length||(null!==He&&(cancelAnimationFrame(He),He=null),Oe.length>0&&(c?ke.value[0].table.push(...Oe):ke.value[0].table.unshift(...Oe.reverse()),Oe=[]),ke.value.unshift({zoneName:"",duration:"00:00",table:R([]),key:e,timestamp:n}),L(ke)),de=n,ke.value[0].zoneName=ue,ke.value[0].timestamp=n,ke.value[0].key=e,void(pe.value=0)}if(!e&&!t)return void ze(n)}break;case"01":{const e=parseInt(a[be.ChangeZone.fields.id],16);if(ue=a[be.ChangeZone.fields.name],G[e]?.name){const t=W(G[e]?.name);t&&"Unknown"!==t&&(ue=t)}ze(new Date(a[be.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=we.partyList.exec(e);t&&(F=(t.groups?.list?.split("|")??[]).filter(Boolean),Me())}break;case"02":H=a[be.ChangedPlayer.fields.id],Me();break;case"03":if("00"!==a[be.AddedCombatant.fields.job]){const e=a[be.AddedCombatant.fields.job],t=a[be.AddedCombatant.fields.name],n=new Date(a[be.AddedCombatant.fields.timestamp]).getTime(),s=parseInt(a[be.AddedCombatant.fields.level],16);z[a[be.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:s},Me()}break;case"04":Reflect.deleteProperty(z,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ce.friendly,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ce.enemy,a[be.RemovedCombatant.fields.id]),Me();break;case"262":{const t=we.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[be.RSVData.fields.value];e&&n&&(ce[Number(e)]=n)}}break;case"24":{const e=a[be.NetworkDoT.fields.which],t=a[be.NetworkDoT.fields.effectId],n=parseInt(t,16),s="HoT"===e&&2718===n;if(!s&&!o.parseDoT)return;const l=a[be.NetworkDoT.fields.id];if("DoT"!==e&&"HoT"!==e||l.startsWith("4")||l!==H&&!F.includes(l)&&!re.find(e=>e.id===l))return;const i=a[be.NetworkDoT.fields.name],r=a[be.NetworkDoT.fields.damage],c=Number.parseInt(r,16);let d=e;s&&(d=o.actionCN?"å°å®‡å®™":"Microcosmos");const u=new Date(a[be.Ability.fields.timestamp]??"???").getTime(),m=Number(a[be.NetworkDoT.fields.currentHp]),p=Number(a[be.NetworkDoT.fields.maxHp]),f=Be(0===de?0:u-de),{jobEnum:g,job:v,jobIcon:h,hasDuplicate:y}=Pe(l);Ve($e({key:(me++).toString(),time:f,timestamp:u,id:"",action:d,actionCN:d,source:"",target:i,targetId:l,job:v,jobIcon:h,jobEnum:g,hasDuplicate:y,amount:c,keigenns:[],currentHp:m,maxHp:p,effect:s?"heal":"damage done",type:s?"heal":"dot",shield:Ie[l]??"0",povId:H,reduction:0,keySkills:[]}))}}}const _e=new Map;let Le=null;function Me(){_e.clear(),Le=null}function Pe(e){const t=_e.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=z[e],a=re.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,s=n===t?Object.entries(z).some(([t,a])=>t!==e&&a.job===n?.job&&F.includes(t)):re.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:s}}(e),s=a,o={jobEnum:s,job:V.jobToFullName(V.jobEnumToJob(s)).simple2,jobIcon:V.jobEnumToIcon(s),hasDuplicate:n};return _e.set(e,o),o}let Oe=[],He=null;const Fe=s(null);function Ve(e){Oe.push(_(e)),null===He&&(He=requestAnimationFrame(()=>{c?(ke.value[0].table.push(...Oe),k.value||M(()=>Fe.value?.scrollToBottom())):ke.value[0].table.unshift(...Oe.reverse()),Oe=[],He=null}))}function ze(e){0!==de&&(ke.value[0].duration=Be(e-de),ke.value[0]=_(ke.value[0]),de=0,Ce.friendly={},Ce.enemy={},je={},Me(),Ke())}function Je(e,t){if(!Le){const e=new Set;re.forEach(t=>e.add(t.id)),F.forEach(t=>e.add(t)),H&&e.add(H);const t=[];for(const a of e){const e=re.find(e=>e.id===a);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const n=z[a];n&&t.push({id:a,job:n.job,name:n.name??"Unknown",level:n.level})}Le=t.flatMap(e=>{const t=e.level||999;return Ne.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const n=ae(a.id,t),s=ae(a.recast1000ms,t);return{id:n,name:U(n)||"Unknown",icon:ne(n),recast1000ms:s,ownerId:e.id,ownerName:e.name,ownerJob:e.job,ownerJobName:V.jobToFullName(V.jobEnumToJob(e.job)).simple2,maxCharges:a.maxCharges||1,scope:a.scope}})})}return Le?Le.filter(e=>"party"===e.scope||e.ownerId===t).map(t=>{const a=je[t.ownerId]?.[t.id]??[],n=t.maxCharges||1,s=1e3*t.recast1000ms,o=new Array(n).fill(0);for(let e=0;e<a.length;e++){const t=a[e],n=e>0?o[e-1]:0;o[e]=Math.max(t,n)+s}let l=n-a.length,i=0;for(let c=0;c<a.length;c++){if(!(e>=o[c])){i=Math.ceil((o[c]-e)/1e3);break}l++}const r=l>0;return{...t,recastLeft:i,ready:r,chargesReady:l}}):[]}async function Ke(){if(k.value)return;const e=ke.value.filter(e=>"init"!==e.key&&e.timestamp>0&&e.table.length>0).map(e=>{const t=Array.isArray(e.table)?x(e.table):[];return{...x(e),table:t}});await Re.replaceAll(e)}function Be(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Ge(){d.value=!d.value}function We(){"init"!==ke.value[0]?.key&&void 0!==ke.value[0]||(ke.value.unshift({zoneName:"",duration:"00:00",table:R([]),key:"test",timestamp:Date.now()}),L(ke),pe.value=0),Ve($e({key:(me++).toString(),time:Be(Date.now()-(de||Date.now())),timestamp:Date.now(),id:"unknown",action:"test",actionCN:"æµ‹è¯•æŠ€èƒ½",source:"çŽ¯å¢ƒä¼¤å®³",target:"æµ‹è¯•è§’è‰²",targetId:"test-id",job:"æµ‹è¯•èŒä¸š",jobIcon:V.jobEnumToIcon(19),jobEnum:19,hasDuplicate:!1,amount:12345,keigenns:[],currentHp:5e4,maxHp:1e5,effect:"damage done",type:"physics",shield:"10",povId:"test-id",reduction:.1,keySkills:[]}))}function Ze(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return i(()=>{J(),function(){try{if(localStorage.getItem(w.VERSION)!==rt)return Object.values(w).forEach(e=>{e!==w.VERSION&&localStorage.removeItem(e)}),localStorage.setItem(w.VERSION,rt),void(P=!0);const e=localStorage.getItem(w.POV_ID);e&&(H=e);const t=localStorage.getItem(w.PARTY_LIST);t&&(F=JSON.parse(t));const a=localStorage.getItem(w.ENTITIES_MAP);a&&(z=JSON.parse(a));const n=localStorage.getItem(w.PARTY_EVENT);n&&(re=JSON.parse(n));const s=localStorage.getItem(w.RSV_DATA);s&&(ce=JSON.parse(s));const o=localStorage.getItem(w.ZONE_NAME);o&&(ue=o)}catch(e){}}();const e=D({storageKey:"keigenn-record-2-theme"}),t=E(e);!1===e.value&&t();for(const a in z){const e=z[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(z,a)}!async function(){pe.value=0;try{if(P)await Re.replaceAll([]),ke.value.length=0;else{const e=await Re.getAll();if(e.length){ke.value.length=0;let t=e.filter(e=>n.isBrowser||e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp);c||(t=t.reverse());const a=t.map(e=>({...e,table:R(Array.isArray(e.table)?e.table.map(e=>_(e)):[])}));ke.value.push(...a)}}0===ke.value.length&&ke.value.push({zoneName:"",duration:"00:00",table:R([]),key:"init",timestamp:-1}),L(ke)}catch(e){throw ke.value.length=0,e}}(),ye("LogLine",e=>{xe(e.rawLine)}),ye("PartyChanged",e=>{re=e.party.map(e=>({...e,timestamp:Date.now()})),Me()}),ye("ChangePrimaryPlayer",e=>{H=Number(e.charID).toString(16).toUpperCase(),Me()}),ye("CombatData",e=>{if(!(de>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(ue=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==ke.value[0].table.length&&(ke.value.unshift({zoneName:"",duration:"00:00",table:R([]),key:String(n),timestamp:n}),L(ke)),ke.value[0].zoneName=ue,de=n,ke.value[0].timestamp=n,ke.value[0].key=String(n),pe.value=0}})}),r(()=>{!function(){try{localStorage.setItem(w.POV_ID,H),localStorage.setItem(w.PARTY_LIST,JSON.stringify(F)),localStorage.setItem(w.ENTITIES_MAP,JSON.stringify(z)),localStorage.setItem(w.PARTY_EVENT,JSON.stringify(re)),localStorage.setItem(w.RSV_DATA,JSON.stringify(ce)),localStorage.setItem(w.ZONE_NAME,ue)}catch(e){}}(),Ke()}),(e,s)=>{const l=ie,i=le,r=ve,c=at,k=t;return v(),m(I,null,[p("div",{class:"wrapper",style:b({"--scale":y(o).scale,"--opacity":y(o).opacity}),onContextmenu:s[1]||(s[1]=$(()=>{},["prevent"]))},[p("header",null,[p("div",ot,[T(f(i,{modelValue:pe.value,"onUpdate:modelValue":s[0]||(s[0]=e=>pe.value=e),size:"small",class:j(["combat-select",y(n).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:g(()=>[(v(!0),m(I,null,S(ke.value.length,e=>(v(),N(l,{key:`${ke.value[e-1].key}-${ke.value[e-1].duration}-${ke.value[e-1].zoneName}`,value:e-1,label:`${ke.value[e-1].zoneName}${""===ke.value[e-1].zoneName?"":` - [${ke.value[e-1].duration}] ${Ze(ke.value[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[A,!d.value]])]),y(n).isBrowser?h("",!0):(v(),N(r,{key:0,class:j(["minimize",d.value?"in-minimize":"not-minimize"]),icon:d.value?y(fe):y(ge),circle:"",style:b({opacity:d.value?.5:1}),onClick:Ge},null,8,["class","icon","style"]))]),T(p("main",lt,[f(c,{ref_key:"tableRef",ref:Fe,rows:ke.value[pe.value].table,"action-key":y(u)},null,8,["rows","action-key"])],512),[[A,!d.value]])],36),y(n).isBrowser||y(a)?(v(),m("div",it,[y(a)?(v(),N(r,{key:0,onClick:We},{default:g(()=>[...s[2]||(s[2]=[C(" æµ‹è¯• ",-1)])]),_:1})):h("",!0),f(k,{"m-1":"",onBeforeHandle:De,onAfterHandle:Ee,onHandleLine:xe})])):h("",!0)],64)}}}),[["__scopeId","data-v-1314bbce"]]);export{ct as default};
