import{g as e,a,b as t,h as l,i as n,j as o,f as s,p as i,k as c,l as r,m as d,n as u,o as m,q as p,c as y,r as f,s as h,t as b,u as x,v as _,w as k,x as g,y as z,d as w,A as v}from"./element-plus-901ad096.js";import{_ as C}from"./ThemeToggle-fb2e4d42.js";import{aR as T,aP as Z,aS as P,a8 as M,r as N,k as A,K as E,l as V,o as I,F as O,ae as D,U as S,A as j,E as B,c as J,J as U,v as X,z as Y,H as W,u as $,x as R,y as F,G as H,q as L,D as q,B as G}from"./vue-49c48d91.js";import{c as K}from"./clipboard-e5e2548c.js";import{a as Q,b as ee}from"./cactbot-49e370f3.js";import{d as ae,g as te}from"./res-macro-d468e41b.js";import{z as le}from"./res-zoneInfo-5ea06bcd.js";import{d as ne,a as oe,b as se,c as ie}from"./postNamazu-85d59aec.js";import{u as ce}from"./useWebSocket-e966ffb8.js";import"./vendor-979eac9e.js";import"./_plugin-vue_export-helper-6a8c15be.js";let re=0;const de=Z("macro-slot-index",5);Q("PartyChanged",e=>{re=e.party.length});const[ue,me]=P(!0);function pe(e){let a=e;return a=a.replaceAll(/\n{2,}/g,"\n"),a=a.replaceAll(/^\s+/gm,""),a=a.replaceAll(/ /g," "),a}function ye(e,t){"p"===t&&0===re&&se("/e 单人时无法发送小队宏<se.3>");const l=e.replaceAll(/^\s*\/[pe]\s/gm,"").split("\n").map(e=>({c:"DoTextCommand",p:`/${t} ${e}`,d:125}));ie(l),a.success("已发送")}const fe=T("macro",{state:()=>({data:Z("my-macros",ae),selectZone:Z("my-zone",N("1226")),zoneNow:Z("my-zone-now",N("1226")),fastEntrance:[{text:"极泽莱妮娅",value:"1271"},{text:"M5S",value:"1257"},{text:"M6S",value:"1259"},{text:"M7S",value:"1261"},{text:"M8S",value:"1263"},{text:"绝伊甸",value:"1238"},{text:"灭暗云",value:"1241"}],show:ue,toggleShow:me}),getters:{defaultX:e=>le[Number(e.selectZone)]?.offsetX??0,defaultY:e=>le[Number(e.selectZone)]?.offsetY??0,blankWaymark:e=>{const a=le[Number(e.selectZone)]?.offsetX??0,t=le[Number(e.selectZone)]?.offsetY??0;return{A:{X:-a,Y:0,Z:-t,Active:!1},B:{X:-a,Y:0,Z:-t,Active:!1},C:{X:-a,Y:0,Z:-t,Active:!1},D:{X:-a,Y:0,Z:-t,Active:!1},One:{X:-a,Y:0,Z:-t,Active:!1},Two:{X:-a,Y:0,Z:-t,Active:!1},Three:{X:-a,Y:0,Z:-t,Active:!1},Four:{X:-a,Y:0,Z:-t,Active:!1}}}},actions:{editMacroMacro(e){e.Editable=!0,e.Text=pe(e.Text)},submitMacroMacro(e){Reflect.deleteProperty(e,"Editable"),e.Text=pe(e.Text)},editMacroPlace(e){e.Editable=!0},submitMacroPlace(e){Reflect.deleteProperty(e,"Editable")},newMacro(e){const a=Number(this.selectZone);void 0===this.data.zoneId[a]&&(this.data.zoneId[a]=[]),this.data.zoneId[a]&&this.data.zoneId[a].push({Name:"New Macro",Text:e??"",Editable:!0,Deletability:!0})},newPlace(e){const a=Number(this.selectZone);void 0===this.data.zoneId[a]&&(this.data.zoneId[a]=[]),this.data.zoneId[a]&&this.data.zoneId[a].push({Name:e?.Name??"New WayMark",Editable:!0,Deletability:!0,Place:structuredClone(Object.assign(this.blankWaymark,e))})},async importPPJSON(){e.prompt("输入PPJSON","Import PPJSON",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^(\{.*\})$/,inputErrorMessage:"无效的格式"}).then(async({value:e})=>{const t=Object.assign(this.blankWaymark,function(e){try{return JSON.parse(e)}catch(a){try{const a=e.replace(/,(\s*[}\]])/g,"$1");return JSON.parse(a)}catch(t){throw new Error("无法解析 JSON 数据")}}}(e));this.newPlace(t),a.success("导入成功")})},deleteMacro(a){if("Text"in a&&(a?.Text??"").length<=5||"Place"in a&&!1===a.Place.A.Active&&!1===a.Place.B.Active&&!1===a.Place.C.Active&&!1===a.Place.D.Active&&!1===a.Place.One.Active&&!1===a.Place.Two.Active&&!1===a.Place.Three.Active&&!1===a.Place.Four.Active){const e=this.data.zoneId[this.selectZone].indexOf(a);e>-1&&this.data.zoneId[this.selectZone].splice(e,1)}else e.confirm("确定要删除吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{const e=this.data.zoneId[this.selectZone].indexOf(a);e>-1&&this.data.zoneId[this.selectZone].splice(e,1)}).catch(()=>{})},exportWaymarksJson(e){const t=JSON.parse(JSON.stringify(e.Place));t.MapID=te(Number(this.selectZone)),t.Name=e.Name,K(JSON.stringify({Name:t.Name,MapID:t.MapID,A:t.A,B:t.B,C:t.C,D:t.D,One:t.One,Two:t.Two,Three:t.Three,Four:t.Four})),a.success("已复制到剪贴板")},sendMacroParty(a){e.confirm("确定要发送到队伍频道吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ye(a,"p")}).catch(()=>{})},sendMacroEcho(e){ye(e,"e")},doLocalWayMark(e){oe(e,!0),a.success("已尝试本地标点")},doPartyWayMark(e){oe(e,!1),a.success("已尝试公开标点")},doSlotWayMark(l){e({title:"选择插槽",message:()=>M(t,{modelValue:de.value,min:1,max:30,size:"large","onUpdate:modelValue":e=>{de.value=e}}),showCancelButton:!0,confirmButtonText:"确定",cancelButtonText:"取消"}).then(()=>{ne(Number(this.selectZone),l,de.value),a.success(`已尝试写入至插槽${de.value}`)}).catch(()=>{})},positioning(){this.selectZone=this.zoneNow},handleChangeZone(e){this.selectZone=e.zoneID.toString(),this.zoneNow=e.zoneID.toString(),function(e){for(const a in le){const t=le[a];for(const l in t.name){const n=t.name[l];if(n?.toUpperCase()===e.toUpperCase()||n===e.replaceAll(/[()]/g,""))return a}}}(e.zoneName)},resetZone(){e.confirm("确定要重置当前地图的所有标点吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{this.data.zoneId[this.selectZone].length=0,this.data.zoneId[this.selectZone].push(...JSON.parse(JSON.stringify(ae.zoneId[this.selectZone]))),a.success("重置成功")}).catch(()=>{})},resetAllData(){e.confirm("要重置所有数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{e.confirm("你确定吗？","警告",{confirmButtonText:"确定！",cancelButtonText:"取消",type:"warning"}).then(()=>{this.data=JSON.parse(JSON.stringify(ae)),a.success("重置成功")})}).catch(()=>{})}}}),he=180,be=A({__name:"MarksDiv",props:{macro:{type:Object,required:!0}},setup(e){const a=e,t=fe(),l={x:100,y:100},n=["A","B","C","D","1","2","3","4"];function o(e){return{left:`${Math.min(he,Math.max(0,3*(e.X-l.x)+90))}px`,top:`${Math.min(he,Math.max(0,3*(e.Z-l.y)+90))}px`}}return E(()=>a.macro.Place,()=>{const e={x:0,y:0,count:0};for(const t in a.macro.Place){const l=a.macro.Place[t];!0===l.Active&&(e.x+=Number(l.X),e.y+=Number(l.Z),e.count++)}0===e.count?(l.x=-t.defaultX,l.y=-t.defaultY):(l.x=e.x/e.count,l.y=e.y/e.count)},{immediate:!0}),(e,t)=>(I(),V("div",{style:S([{position:"relative","background-color":"rgba(214, 199, 148, 1)"},{height:"180px",width:"180px",fontSize:"19px"}])},[(I(!0),V(O,null,D(a.macro.Place,(e,a,t)=>(I(),V("span",{key:t,class:j(`markIcon markIcon${a}`),style:S(o(e))},B(e.Active?n[t]:""),7))),128))],4))}}),xe=["innerHTML"],_e={key:0},ke={key:0},ge={key:1},ze={class:"menu"},we=A({__name:"zoneMacro",setup(e){const a=fe();Z("zoneMacroHideOnStartup",N(!1)).value&&(a.show=!1),ce({allowClose:!0,addWsParam:!0});const T=[{type:ee.UltimateRaids,label:"绝境战"},{type:ee.OccultCrescent,label:"新月岛"},{type:ee.ChaoticAllianceRaid,label:"诛灭战"},{type:ee.Raids,label:"大型任务"},{type:ee.Dungeons,label:"四人副本"},{type:ee.Trials,label:"讨伐任务"},{type:ee.VCDungeonFinder,label:"多变迷宫"},{type:ee.DeepDungeons,label:"深层迷宫"},{type:ee.DisciplesOfTheLand,label:"采集/垂钓"},{type:ee.Eureka,label:"尤雷卡"}],P=T.map(e=>e.type),M=J(()=>{const e={};return Object.entries(le).map(([e,a])=>({id:e,...a})).sort((e,a)=>e.exVersion!==a.exVersion?e.exVersion-a.exVersion:e.contentType===ee.Raids&&a.contentType===ee.Raids&&a.name.ja&&e.name.ja?e.name.ja.localeCompare(a.name.ja):Number(e.id)-Number(a.id)).filter(e=>!e.name.en.startsWith("(")&&e.contentType&&P.includes(e.contentType)||a.selectZone===e.id).forEach(a=>{const t=T.find(e=>e.type===a.contentType)?.label??"临时";void 0===e[t]&&(e[t]=[]),e[t].push({value:a.id,label:a.name?.cn??`${a.name.en} / ${a.name.ja}`})}),Object.entries(e).map(([e,a])=>({label:e,options:a})).sort((e,a)=>{const t=T.findIndex(a=>a.label===e.label),l=T.findIndex(e=>e.label===a.label);return(-1===t?999:t)-(-1===l?999:l)})});return U(()=>{Q("ChangeZone",a.handleChangeZone),E(X(a,"selectZone"),()=>{const e=(a.data.zoneId[a.selectZone]?.map(e=>{const{Editable:a,...t}=e;return t})||ae.zoneId[a.selectZone]||[]).filter(e=>e.Deletability),t=ae.zoneId[a.selectZone]??[];a.data.zoneId[a.selectZone]=[...t,...e]},{immediate:!0})}),(e,T)=>{const Z=s,P=d,N=r,A=c,E=o,j=u,J=n,U=y,X=f,K=w,Q=z,ee=t,ae=g,te=be,le=p,ne=m,oe=C,se=l;return Y((I(),R(se,{class:"elcontainer"},{default:F(()=>[H(J,{flex:"~ wrap",height:"auto",class:"elheader"},{default:F(()=>[H(E,null,{default:F(()=>[H(Z,{type:"primary",size:"small",icon:$(i),onClick:T[0]||(T[0]=e=>$(a).positioning())},null,8,["icon"]),H(A,{modelValue:$(a).selectZone,"onUpdate:modelValue":T[1]||(T[1]=e=>$(a).selectZone=e),size:"small",filterable:"","m-3px":"",style:{width:"16rem"}},{default:F(()=>[(I(!0),V(O,null,D($(M),e=>(I(),R(N,{key:e.label,label:e.label},{default:F(()=>[(I(!0),V(O,null,D(e.options,e=>(I(),R(P,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1}),H(E,null,{default:F(()=>[H(j,{flex:"~ ! wrap"},{default:F(()=>[(I(!0),V(O,null,D($(a).fastEntrance,(e,t)=>(I(),R(Z,{key:t,bg:"",plain:"",color:"rgb(24,34,44)",size:"small",onClick:t=>$(a).selectZone=e.value},{default:F(()=>[q(B(e.text),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})]),_:1}),H(ne,{style:{padding:"0.25rem",margin:"0"}},{default:F(()=>[H(E,{wrap:"",alignment:"flex-start",style:{"font-size":"12px"}},{default:F(()=>[(I(!0),V(O,null,D($(a).data.zoneId[$(a).selectZone],(e,t)=>(I(),R(le,{key:t,shadow:"hover",class:"main-box-card"},{default:F(()=>[Y(L("p",{"m-b-2":"","m-t-2":"","font-bold":"",innerHTML:e.Name},null,8,xe),[[W,!e.Editable]]),Y(H(U,{modelValue:e.Name,"onUpdate:modelValue":a=>e.Name=a,size:"small",placeholder:"宏标题"},null,8,["modelValue","onUpdate:modelValue"]),[[W,e.Editable]]),"Text"in e?(I(),V("div",_e,[e.Editable?G("",!0):(I(),V("article",ke,[(I(!0),V(O,null,D(e.Text?.split("\n"),(e,a)=>(I(),V("div",{key:a,class:"macroText"},B(e),1))),128))])),Y(H(U,{modelValue:e.Text,"onUpdate:modelValue":a=>e.Text=a,type:"textarea",size:"small",placeholder:"宏文本",wrap:"off",autosize:{minRows:3},style:{width:"450px"}},null,8,["modelValue","onUpdate:modelValue"]),[[W,e.Editable]]),e.Editable?G("",!0):(I(),R(X,{key:1,class:"buttonArea",style:S({maxHeight:e.Editable?"100px":null,opacity:e.Editable?1:null})},{default:F(()=>[e.Deletability?(I(),R(Z,{key:0,icon:$(h),size:"small",onClick:t=>$(a).editMacroMacro(e)},null,8,["icon","onClick"])):G("",!0),H(Z,{icon:$(b),type:"info",size:"small",onClick:t=>$(a).sendMacroEcho(e.Text)},{default:F(()=>T[7]||(T[7]=[q(" 默语 ",-1)])),_:2,__:[7]},1032,["icon","onClick"]),H(Z,{icon:$(x),type:"primary",size:"small",onClick:t=>$(a).sendMacroParty(e.Text)},{default:F(()=>T[8]||(T[8]=[q(" 小队 ",-1)])),_:2,__:[8]},1032,["icon","onClick"])]),_:2},1032,["style"])),e.Editable?(I(),R(X,{key:2,class:"buttonAreaEditing"},{default:F(()=>[H(Z,{type:"success",size:"small",icon:$(_),onClick:t=>$(a).submitMacroMacro(e)},{default:F(()=>T[9]||(T[9]=[q(" 完成 ",-1)])),_:2,__:[9]},1032,["icon","onClick"]),e.Deletability?(I(),R(Z,{key:0,type:"danger",size:"small",icon:$(k),onClick:t=>$(a).deleteMacro(e)},{default:F(()=>T[10]||(T[10]=[q(" 删除 ",-1)])),_:2,__:[10]},1032,["icon","onClick"])):G("",!0)]),_:2},1024)):G("",!0)])):G("",!0),"Place"in e?(I(),V("div",ge,[Y(H(E,null,{default:F(()=>[H(ae,{data:Object.entries(e.Place).filter(e=>["A","B","C","D","One","Two","Three","Four"].includes(e[0])),border:"",size:"small"},{default:F(()=>[H(Q,{align:"center",label:"启用",width:"50"},{default:F(e=>[H(K,{modelValue:e.row[1].Active,"onUpdate:modelValue":a=>e.row[1].Active=a,size:"small",style:{"--el-switch-on-color":"#13ce66"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),H(Q,{align:"center",label:"标记",width:"50"},{default:F(e=>[L("span",null,B(e.row[0]),1)]),_:1}),H(Q,{align:"center",label:"X（左右）",width:"140"},{default:F(a=>[Y(L("span",null,B(a.row.X),513),[[W,!e.Editable]]),Y(H(ee,{modelValue:a.row[1].X,"onUpdate:modelValue":e=>a.row[1].X=e,step:.1,precision:2,"controls-position":"right",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),[[W,e.Editable]])]),_:2},1024),H(Q,{align:"center",label:"Z（上下）",width:"140"},{default:F(a=>[Y(L("span",null,B(a.row.Z),513),[[W,!e.Editable]]),Y(H(ee,{modelValue:a.row[1].Z,"onUpdate:modelValue":e=>a.row[1].Z=e,step:.1,precision:2,"controls-position":"right",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),[[W,e.Editable]])]),_:2},1024),H(Q,{align:"center",label:"Y（高度）",width:"140"},{default:F(a=>[Y(L("span",null,B(a.row.Y),513),[[W,!e.Editable]]),Y(H(ee,{modelValue:a.row[1].Y,"onUpdate:modelValue":e=>a.row[1].Y=e,step:.1,precision:2,"controls-position":"right",size:"small"},null,8,["modelValue","onUpdate:modelValue"]),[[W,e.Editable]])]),_:2},1024)]),_:2},1032,["data"])]),_:2},1536),[[W,e.Editable]]),H(E,null,{default:F(()=>[H(te,{macro:e},null,8,["macro"])]),_:2},1024),e.Editable?G("",!0):(I(),R(X,{key:0,class:"buttonArea",style:S({maxHeight:e.Editable?"100px":null,opacity:e.Editable?1:null})},{default:F(()=>[H(Z,{type:"primary",size:"small",onClick:t=>$(a).doLocalWayMark(e.Place)},{default:F(()=>T[11]||(T[11]=[q(" 本地 ",-1)])),_:2,__:[11]},1032,["onClick"]),H(Z,{type:"primary",size:"small",onClick:t=>$(a).doPartyWayMark(e.Place)},{default:F(()=>T[12]||(T[12]=[q(" 公开 ",-1)])),_:2,__:[12]},1032,["onClick"]),H(Z,{icon:$(v),size:"small",class:"export",onClick:t=>$(a).exportWaymarksJson(e)},{default:F(()=>T[13]||(T[13]=[q(" 复制 ",-1)])),_:2,__:[13]},1032,["icon","onClick"]),e.Deletability?(I(),R(Z,{key:0,icon:$(h),size:"small",onClick:t=>$(a).editMacroPlace(e)},null,8,["icon","onClick"])):G("",!0)]),_:2},1032,["style"])),e.Editable?(I(),R(X,{key:1,class:"buttonAreaEditing"},{default:F(()=>[H(Z,{type:"success",size:"small",icon:$(_),onClick:t=>$(a).submitMacroPlace(e)},{default:F(()=>T[14]||(T[14]=[q(" 完成 ",-1)])),_:2,__:[14]},1032,["icon","onClick"]),e.Deletability?(I(),R(Z,{key:0,type:"danger",size:"small",icon:$(k),onClick:t=>$(a).deleteMacro(e)},{default:F(()=>T[15]||(T[15]=[q(" 删除 ",-1)])),_:2,__:[15]},1032,["icon","onClick"])):G("",!0)]),_:2},1024)):G("",!0)])):G("",!0)]),_:2},1024))),128))]),_:1})]),_:1}),L("div",ze,[H(oe,{"storage-key":"zone-macro-theme"}),H(Z,{type:"success",size:"small","w-20":"",onClick:T[2]||(T[2]=e=>$(a).newMacro())},{default:F(()=>T[16]||(T[16]=[q(" 新增宏 ",-1)])),_:1,__:[16]}),H(Z,{type:"success",size:"small","w-20":"",color:"#3375b9",onClick:T[3]||(T[3]=e=>$(a).newPlace())},{default:F(()=>T[17]||(T[17]=[q(" 新增标点 ",-1)])),_:1,__:[17]}),H(Z,{size:"small","w-20":"",color:"#BA5783",onClick:T[4]||(T[4]=e=>$(a).importPPJSON())},{default:F(()=>T[18]||(T[18]=[q(" 导入PP ",-1)])),_:1,__:[18]}),H(Z,{type:"warning",size:"small","w-20":"",onClick:T[5]||(T[5]=e=>$(a).resetZone())},{default:F(()=>T[19]||(T[19]=[q(" 恢复本图 ",-1)])),_:1,__:[19]}),H(Z,{type:"danger",size:"small","w-20":"",onClick:T[6]||(T[6]=e=>$(a).resetAllData())},{default:F(()=>T[20]||(T[20]=[q(" 恢复全部 ",-1)])),_:1,__:[20]})])]),_:1},512)),[[W,$(a).show]])}}});export{we as default};
