import{_ as e}from"./ActWrapper-693a4c4c.js";import{t,r as a,f as n,P as r,D as o,x as s,E as i,F as l,A as m,O as u,u as c}from"./vue-vendor-3ae2ccec.js";import{U as p,i as d}from"./util-c5e2dd68.js";import{N as f}from"./netregexes-ed180b06.js";import{a as v,r as b,c as g}from"./overlay_plugin_api-974cdd44.js";import{c as h}from"./index-c6b82793.js";import{_ as w}from"./_plugin-vue_export-helper-6a8c15be.js";import"./index-59b8e199.js";import"./element-plus-1c4f27f5.js";/* empty css                */import"./useDevMode-8c677e90.js";import"./regexes-da03e94d.js";const y=w(t({__name:"enmity",setup(t){let w=0;const y=a([]),C=h("hash"),j=a(!1),T=[d.Paladin,d.Warrior,d.DarkKnight,d.Gunbreaker],I=[2843,3124,743,1833];let P,_;const x={countdown:f.countdown(),countdownCancel:f.countdownCancel(),wipe:f.network6d({command:["40000010","4000000F"]}),inCombat:f.inCombat()};async function L(){const e=(await g({call:"getCombatants"})).combatants.filter(e=>y.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===w)?.Job;if(void 0===t)return D(),j.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!T.includes(t))return D(),j.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>I.includes(e.BuffID))),partyCombatState:e}}function k(){D(),P=setInterval(()=>{L().then(({enmityTanks:e})=>{0!==e.length?j.value=!1:j.value=!0}).catch(()=>{j.value=!1})},500)}function D(){_&&clearTimeout(_),P&&clearInterval(P)}function E(e){g({call:"cactbotSay",text:e})}const J=e=>{const t=x.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)k(),_=setTimeout(()=>{L().then(({enmityTanks:e})=>{2===e.length&&E("双T都开盾了"),0===e.length&&E("没人开盾")}).catch(()=>{j.value=!1})},1e3*(Number.parseInt(t)-10));else if(x.countdownCancel.test(e.rawLine))D(),j.value=!1;else if(x.wipe.test(e.rawLine))D(),j.value=!1;else if(x.inCombat.test(e.rawLine)){if("false"===C.stRemind)return;const{inACTCombat:t,inGameCombat:a}=x.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===a&&(k(),_=setTimeout(()=>{L().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>p.isTankJob(p.jobEnumToJob(e.Job))).length&&1===e.length&&e[0].ID!==w&&E("ST开盾")}).catch(()=>{j.value=!1})},2e4))}},S=e=>{y.value=e.party},A=e=>{w=e.charID};return n(()=>{v("LogLine",J),v("PartyChanged",S),v("ChangePrimaryPlayer",A)}),r(()=>{P&&clearInterval(P),_&&clearTimeout(_),b("LogLine",J),b("PartyChanged",S),b("ChangePrimaryPlayer",A)}),(t,a)=>{const n=e;return s(),o(n,null,{default:i(()=>[l(m("strong",null,"没人开盾",512),[[u,c(j)]])]),_:1})}}}),[["__scopeId","data-v-b416a4dd"]]);export{y as default};
