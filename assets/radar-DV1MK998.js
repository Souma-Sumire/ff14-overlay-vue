import{c as e,_ as a}from"./shared-common-oFS__kwq.js";import{h as l,x as t,dx as n,G as o,o as s,B as r,g as i,e as u,a as v,b as c,p as h,c as d,n as f,f as g,t as m,s as w,v as P,d as p}from"./vendor-vue-i6lpFrx4.js";import{E as y}from"./shared-core-BJk7hyv6.js";import{N as T,a as b,r as x,c as M}from"./cactbot-C9BOJncy.js";import{a2 as k}from"./vendor-element-plus-B-u_I_lk.js";const S={class:"radar-container"},I={class:"radar-wrapper"},N={key:0},C=["disabled","aria-label"],$=["disabled","aria-label"],L={class:"target-header"},_={key:0,class:"target-name"},D={class:"radar-canvas-container"},W=["width","height"],X=a(l({__name:"radar",setup(a){const l=t(""),X=t([]),Y=t(0),j=t(""),E=t([]),R={echo:T.echo({line:"find\\s*(?<target>.+)"})},B=n("canvas");let H=null;const O=t(window.devicePixelRatio||1),z=t(Math.min(window.innerWidth,window.innerHeight)-80),A=o(()=>z.value/2-20),{zoneType:F}=y(),q=t("single"),G="#0f0",J="#060",K="#0f0",Q="#ff0",U="#f00",V="#fff",Z="#fff",ee=18,ae=3,le=2,te=6,ne=o(()=>z.value/2),oe=o(()=>z.value/2);function se(e,a,l){const t=e.PosX-a.PosX,n=e.PosY-a.PosY;let o=ne.value+t/l,s=oe.value+n/l;const r=Math.hypot(o-ne.value,s-oe.value);if(r>A.value){const e=A.value/r;o=ne.value+(o-ne.value)*e,s=oe.value+(s-oe.value)*e}return{px:o,py:s}}async function re(){const e=await M({call:"getCombatants"});E.value=e.combatants??[]}async function ie(){await re(),function(){if(!l.value)return X.value=[],void(Y.value=0);const e=E.value.filter(e=>e.Name&&e.Name.includes(l.value));X.value=e}(),"Pvp"!==F.value&&l.value&&j.value?("*"===l.value?function(){if(q.value="all",!H)throw new Error("canvas context is null");const e=E.value.find(e=>e.Name===j.value),a=E.value.filter(e=>e.Name!==j.value&&e.ID);if(!e)return;H.clearRect(0,0,z.value,z.value),H.strokeStyle=G,H.lineWidth=1,H.beginPath(),H.arc(ne.value,oe.value,A.value,0,2*Math.PI),H.stroke(),H.strokeStyle=J,H.beginPath(),H.moveTo(ne.value-A.value,oe.value),H.lineTo(ne.value+A.value,oe.value),H.moveTo(ne.value,oe.value-A.value),H.lineTo(ne.value,oe.value+A.value),H.stroke();const l=new Map;for(const r of a)l.set(r.ID.toString(),se(r,e,1));for(const r of a){const e=l.get(r.ID.toString());e&&(H.strokeStyle=U,H.lineWidth=le,H.beginPath(),H.moveTo(ne.value,oe.value),H.lineTo(e.px,e.py),H.stroke())}for(const r of a){const e=l.get(r.ID.toString());e&&(H.fillStyle=Q,H.beginPath(),H.arc(e.px,e.py,ae,0,2*Math.PI),H.fill())}for(const r of a){const e=l.get(r.ID.toString());if(!e)continue;const a=r.Name??"",t=H.measureText(a).width;H.shadowColor="black",H.shadowBlur=1,H.shadowOffsetX=1,H.shadowOffsetY=1,H.fillStyle=Z,H.font="8px Arial",H.fillText(a,e.px-t/2,e.py-ae-3),H.shadowColor="transparent",H.shadowBlur=0,H.shadowOffsetX=0,H.shadowOffsetY=0}const t=-(e.Heading??0)+Math.PI;H.save(),H.translate(ne.value,oe.value),H.rotate(t),H.fillStyle=K;const n=ee,o=n/3,s=-.2*n;H.beginPath(),H.moveTo(0,-n/2+s),H.lineTo(-o,n/2+s),H.lineTo(o,n/2+s),H.closePath(),H.fill(),H.restore()}():function(){if(q.value="single",!H)throw new Error("canvas context is null");const e=X.value[Y.value],a=E.value.find(e=>e.Name===j.value);if(!e)return void H.clearRect(0,0,z.value,z.value);if(!a)return;H.clearRect(0,0,z.value,z.value),H.strokeStyle=G,H.lineWidth=1,H.beginPath(),H.arc(ne.value,oe.value,A.value,0,2*Math.PI),H.stroke(),H.strokeStyle=J,H.beginPath(),H.moveTo(ne.value-A.value,oe.value),H.lineTo(ne.value+A.value,oe.value),H.moveTo(ne.value,oe.value-A.value),H.lineTo(ne.value,oe.value+A.value),H.stroke();const l=e.PosX-a.PosX,t=e.PosY-a.PosY,n=Math.sqrt(l*l+t*t);let o=ne.value+l/.5,s=oe.value+t/.5;const r=Math.hypot(o-ne.value,s-oe.value);if(r>A.value){const e=A.value/r;o=ne.value+(o-ne.value)*e,s=oe.value+(s-oe.value)*e}H.strokeStyle=U,H.lineWidth=le,H.beginPath(),H.moveTo(ne.value,oe.value),H.lineTo(o,s),H.stroke(),H.fillStyle=Q,H.beginPath(),H.arc(o,s,ae,0,2*Math.PI),H.fill();const i=-(a.Heading??0)+Math.PI;H.save(),H.translate(ne.value,oe.value),H.rotate(i),H.fillStyle=K;const u=ee,v=u/3,c=-.2*u;H.beginPath(),H.moveTo(0,-u/2+c),H.lineTo(-v,u/2+c),H.lineTo(v,u/2+c),H.closePath(),H.fill(),H.restore();const h=Math.atan2(s-oe.value,o-ne.value);H.fillStyle=U,H.beginPath(),H.moveTo(o,s),H.lineTo(o-te*Math.cos(h-Math.PI/6),s-te*Math.sin(h-Math.PI/6)),H.lineTo(o-te*Math.cos(h+Math.PI/6),s-te*Math.sin(h+Math.PI/6)),H.closePath(),H.fill(),H.fillStyle=V,H.font="10px Arial",H.fillText(`${n.toFixed(1)}y`,o+5,s-5)}(),setTimeout(ie,100)):l.value=""}const ue=e=>{if("00"===e.line[0]){const a=R.echo.exec(e.rawLine);a?.groups?.target&&(l.value=a.groups.target,Y.value=0,re().then(()=>{ie()}))}},ve=e=>{j.value=e.charName};function ce(){z.value=Math.min(window.innerWidth,window.innerHeight)-80,O.value=window.devicePixelRatio||1,H&&(H.setTransform(1,0,0,1,0,0),H.scale(O.value,O.value))}return s(()=>{H=B.value?.getContext("2d")??null,H&&H.scale(O.value,O.value),b("LogLine",ue),b("ChangePrimaryPlayer",ve),window.addEventListener("resize",ce)}),r(()=>{x("LogLine",ue),x("ChangePrimaryPlayer",ve),window.removeEventListener("resize",ce)}),(a,t)=>{const n=k,o=e;return v(),i(o,null,{readme:u(()=>[p(n,{class:"el-alert-info",type:"info",closable:!1,"show-icon":"",title:a.$t("radar.radarTitle"),description:a.$t("radar.radarDesc")},null,8,["title","description"])]),default:u(()=>[c("div",S,[h(c("div",I,[g(X).length>1?(v(),d("div",N,[c("button",{class:"nav-arrow left-arrow",disabled:g(X).length<=1,"aria-label":a.$t("radar.prevTarget"),onClick:t[0]||(t[0]=e=>Y.value=(g(Y)-1+g(X).length)%g(X).length)}," ← ",8,C),c("span",null," （"+m(g(Y)+1)+" / "+m(g(X).length)+"） ",1),c("button",{class:"nav-arrow right-arrow",disabled:g(X).length<=1,"aria-label":a.$t("radar.nextTarget"),onClick:t[1]||(t[1]=e=>Y.value=(g(Y)+1)%g(X).length)}," → ",8,$)])):f("",!0),c("div",L,["single"===g(q)?(v(),d("span",_,m(g(X)[g(Y)]?.Name??a.$t("radar.targetNotFound",{targetName:g(l)})),1)):f("",!0),c("button",{class:"cancel-btn",onClick:t[2]||(t[2]=()=>{l.value="",X.value=[]})},m(a.$t("radar.cancelBtn")),1)]),c("div",D,[c("canvas",{ref_key:"canvas",ref:B,class:"radar-canvas",width:g(z)*g(O),height:g(z)*g(O),style:w({width:`${g(z)}px`,height:`${g(z)}px`})},null,12,W)])],512),[[P,g(l)]])])]),_:1})}}}),[["__scopeId","data-v-0a260a2f"]]);export{X as default};
