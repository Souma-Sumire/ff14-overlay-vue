import"./index-B_ZfYjEn.js";/* empty css                  *//* empty css                  *//* empty css                */import{au as a,t,v as e,x as s,L as r,a9 as o,u as n,S as i,G as l,A as c,d,H as u,J as h,K as p,f as m,M as g,E as y}from"./vue-vendor-wZ_5aAzA.js";import{U as f}from"./util-DL4pAhxD.js";import{d as I,s as b,p as D,b as _,h as j}from"./xivapi-Ec95Svg1.js";import{c as w,a as T}from"./overlay_plugin_api-DU1DlPio.js";import{_ as P}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{k as v,q as C,B as k,h as $}from"./element-plus-8--zztY3.js";const x=new URLSearchParams(window.location.href.split("?")[1]),A=["tank","healer","dps","crafter","gatherer","none"],L=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],M=a("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(x.get("duration")||15)}}),getters:{partyDataFormatted:a=>a.partyData.sort(((a,t)=>A.indexOf(f.jobToRole(f.jobEnumToJob(a.job)))-A.indexOf(f.jobToRole(f.jobEnumToJob(t.job))))),focusTargetCastArr:a=>a.castData.filter((t=>t.casterId===a.focusTargetId))},actions:{testAction(){const a=L[Math.floor(Math.random()*L.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,a)},testParty(a){this.handlePartyChanged({party:a?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(a,t,e,s,r,o){if(0===this.partyData.length&&s===this.playerId||this.partyData.length>0&&s===this.focusTargetId){let n=r,i="action",l=!1;if(e.startsWith("item_"))return;e.startsWith("mount_")&&(n=Number.parseInt(e.replace(/^.+_/,""),16),n>983040&&(n=Number.parseInt(n.toString().slice(-5),10),l=!0),i=e.replace(/_.+$/,""));const c=`${a}-${t}-${s}-${r}`,d={casterId:s,time:a,expirationTime:Date.now()+1e3*this.config.duration,logLine:t,src:"",class:"",key:c},u=I.get(n);if(u&&(d.src=`//${u.Host}${u.Icon}`),this.castData.push(d),14===t&&o&&setTimeout((()=>{this.castData=this.castData.filter((a=>(null==a?void 0:a.key)!==c))}),1e3*o-500),e.startsWith("unknown_"))d.src=`${b.first}/i/000000/000405.png`,d.class="action action-category-0";else if(n<1e5){const a=u||await D(i,n,["ID","Icon","ActionCategoryTargetID"]);3===a.ID&&(a.Icon="/i/000000/000104.png"),u||(d.src=await _((null==a?void 0:a.Icon)??"",l)),"action"===i?d.class=`action action-category-${null==a?void 0:a.ActionCategoryTargetID}`:"mount"===i&&(d.class="mount")}}},handleChangePrimaryPlayer(a){this.playerId=a.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(a){"20"===a.line[0]?this.pushAction(Date.now(),14,a.line[5],a.line[2],Number.parseInt(a.line[4],16),Number(a.line[8])):("21"===a.line[0]||"22"===a.line[0]&&"0"===a.line[45])&&this.pushAction(Date.now(),15,a.line[5],a.line[2],Number.parseInt(a.line[4],16))},handlePartyChanged(a){if(a.party.length>0){this.partyData=a.party.filter((a=>a.inParty)).map((a=>({...a,src:""})));for(const a in this.castData)Object.prototype.hasOwnProperty.call(this.castData,a)&&(this.partyData.find((t=>t.id===a))||Reflect.deleteProperty(this.castData,a));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(a){a===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=a,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(x.get("syncFocusWS")||"")&&w({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter((a=>a.expirationTime>Date.now()))}}}),N={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},E=["data-casterId"],O=["src"],S=P(t({__name:"Main",setup(a){const t=new URLSearchParams(window.location.href.split("?")[1]),d=M(),u=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(t.get("displayAA")??""));return(a,t)=>(s(),e("div",N,[(s(!0),e(r,null,o(n(d).castData.filter((a=>a.key)),(a=>(s(),e("div",{key:a.key,"data-casterId":a.casterId,class:l(`images ${a.class} logLine${a.logLine} displayAA${n(u)}`),style:i(`--animeDuration: ${n(d).config.duration}s;`)},[c("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy",onError:t[0]||(t[0]=(...a)=>n(j)&&n(j)(...a))},null,40,O),t[1]||(t[1]=c("img",{class:"frame",loading:"lazy"},null,-1))],14,E)))),128))]))}}),[["__scopeId","data-v-67c0fa3f"]]),U={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},F=["onClick"],R={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},z=["src","onerror"],H=P(t({__name:"Header",setup(a){const t=new URLSearchParams(window.location.href.split("?")[1]);function i(a){const t=f.jobEnumToJob(a);return`https://souma.diemoe.net/resources/img/cj2/${f.nameToFullName(t).en}.png`}const m=M();d((()=>{for(const a of m.partyData)a.src=i(a.job)}));const g=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(t.get("showHeader")||"true");return(a,t)=>n(g)&&n(m).partyData.length>1?(s(),e("div",U,[(s(!0),e(r,null,o(n(m).partyDataFormatted,((a,t)=>(s(),e("button",{key:t,class:l(["job-lists",n(m).focusTargetId===a.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:t=>n(m).handleClickChangeTarget(a.id)},[c("div",R,[c("img",{src:a.src,style:{height:"1.25em"},loading:"lazy",onerror:n(j)},null,8,z),h(" "+p(n(f).nameToFullName(n(f).jobEnumToJob(a.job)).simple2),1)])],10,F)))),128))])):u("",!0)}}),[["__scopeId","data-v-ee5ecbae"]]),J={class:"common-layout"},W={key:0},B=P(t({__name:"castingMonitor",setup(a){const t=M(),r=location.href.includes("localhost");return m((()=>{T("ChangePrimaryPlayer",t.handleChangePrimaryPlayer),T("LogLine",t.handleLogLine),T("PartyChanged",t.handlePartyChanged),T("BroadcastMessage",(a=>{"castMonitorOverlay"===a.source&&(t.focusTargetId=a.msg.targetId)}))})),setInterval((()=>{t.cleanUpExpired()}),1e3),(a,o)=>{const i=H,l=v,c=S,d=C,p=k,m=$;return s(),e("div",J,[g(p,{"items-center":""},{default:y((()=>[g(l,{class:"header-layout"},{default:y((()=>[g(i)])),_:1}),g(d,null,{default:y((()=>[g(c)])),_:1})])),_:1}),n(r)?(s(),e("footer",W,[g(m,{onClick:o[0]||(o[0]=a=>n(t).testParty(!0))},{default:y((()=>o[3]||(o[3]=[h(" 虚假小队 ")]))),_:1,__:[3]}),g(m,{onClick:o[1]||(o[1]=a=>n(t).testParty(!1))},{default:y((()=>o[4]||(o[4]=[h(" 单人 ")]))),_:1,__:[4]}),g(m,{onClick:o[2]||(o[2]=a=>n(t).testAction())},{default:y((()=>o[5]||(o[5]=[h(" Action ")]))),_:1,__:[5]})])):u("",!0)])}}}),[["__scopeId","data-v-bdd5a33a"]]);export{B as default};
