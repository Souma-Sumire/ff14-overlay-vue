import{c as e,a as t,b as a,_ as o}from"./shared-common-1fsdULpF.js";import{o as n,bC as s,r as l,B as c,a5 as r,v as i,J as d,dz as u,ac as p,t as m,K as b,u as h,H as f,R as w,M as g,Z as v,I as y,Y as C,X as P,c as S}from"./vendor-vue-iK2zA9mI.js";import{u as V,G as _,I as R,h as E}from"./shared-core-DqyA8e41.js";import{N as U,a as k,r as N,k as D,l as O}from"./cactbot-Bq2Gp82n.js";import{a as T,a7 as z,f as x,v as A,V as B,T as L,j as I,n as W,t as j,a8 as M,a9 as Y,k as Z,G as q,H as F,b as G,g as $}from"./vendor-element-plus-Crd81rYT.js";const H={class:"mini-mode"},K={class:"zone-info"},J={class:"zone-name-wrapper"},X={class:"zone-name"},Q={class:"rules-status"},ee=["title"],te=["title"],ae=["title"],oe=["title"],ne=["title"],se={key:1,class:"obs-status-text"},le={class:"card-header"},ce={class:"header-actions"},re={key:1,class:"connected-layout"},ie={class:"card-header"},de={class:"status-info"},ue={class:"button-container"},pe={class:"card-header"},me={class:"header-actions"},be={class:"profile-info"},he={class:"append-content-toggle"},fe={class:"card-header"},we={key:0,class:"current-type"},ge=o(n({__name:"obs2",setup(o){const{t:n}=V(),{zoneType:ge}=_(),ve=s("obs-zone-name",""),ye=s("obs-user-config",{host:4455,password:"",path:"",fileName:"%CCYY-%MM-%DD %hh-%mm-%ss",appendContentName:!0},localStorage,{mergeDefaults:!0}),Ce=s("obs-user-content-setting",[]),Pe=E(),Se=l(1),Ve=s("obs-has-used-before",!1),_e=l(Ve.value),Re={inCombat:U.inCombat(),countdown:U.countdown(),countdownCancel:U.countdownCancel(),wipe:D.wipe},Ee={enter:!1,countdown:!0,countdownCancel:!0,combatStart:!0,combatEnd:!0,wipe:!0,partyLength:1,customPath:""},Ue={enter:!1,countdown:!1,countdownCancel:!1,combatStart:!1,combatEnd:!1,wipe:!1,partyLength:1,customPath:""};const ke=new class{ws;status;connectingPromise=null;handleConnectionError=()=>{Oe("OBS connection error"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleConnectionClosed=()=>{Oe("OBS connection closed"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleRecordStateChanged=e=>{this.status.connected=!0,this.status.recording="OBS_WEBSOCKET_OUTPUT_STARTED"===e.outputState,this.status.outputActive=e.outputActive,this.status.outputPath=e.outputPath||""};constructor(){this.ws=new u,this.status=p({connecting:!1,connected:!1,recording:!1,outputActive:!1,outputPath:""}),this.ws.on("ConnectionClosed",this.handleConnectionClosed),this.ws.on("ConnectionError",this.handleConnectionError),this.ws.on("RecordStateChanged",this.handleRecordStateChanged)}async connect(){return this.status.connected?Promise.resolve():(this.connectingPromise||(this.connectingPromise=(async()=>{if(Oe("Connecting to OBS"),ye.value.host){this.status.connecting=!0;try{await this.ws.connect(`ws://127.0.0.1:${ye.value.host}`,ye.value.password),Oe("Connected to OBS");const e=await this.ws.call("GetRecordStatus");if(this.status.recording=e.outputActive,this.status.outputActive=e.outputActive,this.status.connected=!0,!ye.value.path){const e=await this.ws.call("GetRecordDirectory");e.recordDirectory&&(ye.value.path=e.recordDirectory,Ce.value.forEach(t=>{""===t.customPath&&(t.customPath=e.recordDirectory)}))}ye.value.fileName||(ye.value.fileName="%CCYY-%MM-%DD %hh-%mm-%ss"),Ve.value=!0}catch(e){Oe("OBS connection failed",e),T({type:"error",message:n("obs2.connection failed"),duration:1e3})}finally{this.status.connecting=!1,this.connectingPromise=null}}else T({type:"error",message:n("obs2.host required"),duration:1e3})})()),this.connectingPromise)}disconnect(){Oe("Disconnecting from OBS"),this.ws.disconnect()}async startRecord(){Oe("Starting recording"),await this.setProfileParameter("start"),this.ws.call("StartRecord")}async stopRecord(){return Oe("Stopping recording"),await this.setProfileParameter("stop"),this.ws.call("StopRecord")}async splitRecord(){Oe("Splitting recording"),await this.setProfileParameter("split"),await this.ws.call("StopRecord"),setTimeout(()=>{this.startRecord()},1e3)}async setProfileParameter(e){const t=[{requestType:"SetProfileParameter",requestData:{parameterCategory:"AdvOut",parameterName:"RecFilePath",parameterValue:"stop"===e?ye.value.path:Ce.value.find(e=>e.type===ge.value)?.customPath||ye.value.path}},{requestType:"SetProfileParameter",requestData:{parameterCategory:"Output",parameterName:"FilenameFormatting",parameterValue:"stop"===e?ye.value.fileName:ye.value.fileName+(ye.value.appendContentName?` - ${ve.value}`:"")}}];return this.ws.callBatch(t)}},Ne=e=>{Oe("ChangeZone:",e),ve.value=e.zoneName,Te("enter")},De=e=>{const t=e.rawLine;for(const a in Re){if(Re[a].exec(t)){const e=t.split("|");switch(a){case"inCombat":{const t="1"===e[O.InCombat.fields.inACTCombat],a="1"===e[O.InCombat.fields.inGameCombat];if(t&&a)return void Te("combatStart");if(!t&&!a)return void Te("combatEnd");break}case"countdown":Te("countdown");break;case"countdownCancel":Te("countdownCancel");break;case"wipe":Te("wipe")}}}};function Oe(...e){Pe.value}function Te(e){Oe();const t=Ce.value.find(e=>e.type===ge.value);if(!t)throw new Error(`Rule not found for zone type:${ge.value}`);if(!1===t.enter&&"enter"===e&&ke.status.recording)ke.stopRecord();else if(t[e])switch(Oe(ge.value),e){case"enter":case"countdown":case"combatStart":if(Se.value<t.partyLength)return;if(!ke.status.connected)return void ke.connect()?.then(()=>{ke.status.connected&&ke.startRecord()});if(!1===ke.status.recording)return void ke.startRecord();!0===ke.status.recording&&"combatStart"!==e&&ke.splitRecord();break;case"countdownCancel":case"combatEnd":case"wipe":ke.status.recording&&ke.stopRecord()}else Oe()}const ze=e=>{Oe(),Se.value=e.party.length||1};c(()=>{ke.connect(),k("ChangeZone",Ne),k("LogLine",De),k("PartyChanged",ze),function(){const e=["Savage","Extreme","Ultimate","Chaotic","OccultCrescent","DeepDungeonExtras","Default"];if(0===Ce.value.length){Ce.value=[...e.map(e=>({type:e,...Ee})),...R.filter(t=>!e.includes(t)).map(e=>({type:e,...Ue}))];const t=Ce.value.find(e=>"OccultCrescent"===e.type);t&&(t.partyLength=40)}else{Ce.value=Ce.value.filter(e=>R.includes(e.type));const t=R.filter(e=>!Ce.value.some(t=>t.type===e)&&"Default"!==e).map(t=>e.includes(t)?{type:t,...Ee}:{type:t,...Ue});Ce.value.push(...t)}Ce.value.sort((e,t)=>R.indexOf(e.type)-R.indexOf(t.type)),Ce.value=Ce.value.map(t=>({...e.includes(t.type)?Ee:Ue,...t})),ye.value.path&&Ce.value.forEach(e=>{""===e.customPath&&(e.customPath=ye.value.path)})}()}),r(()=>{ke.disconnect(),N("ChangeZone",Ne),N("LogLine",De)});const xe=S(()=>Ce.value.find(e=>e.type===ge.value));function Ae({row:e}){return e.type===ge.value?"current-zone-row":""}return(o,s)=>{const l=z,c=t,r=a,u=I,p=L,S=W,V=B,_=j,R=x,E=Y,U=M,k=Z,N=F,D=G,O=$,T=q,Se=A,Ve=e;return m(),i(Ve,null,{default:d(()=>[b("div",H,[h(ke).status.connected?(m(),f(w,{key:0},[b("div",{class:g(["recording-dot",{"is-recording":h(ke).status.recording}])},null,2),b("div",K,[b("div",J,[b("div",X,v(h(ve)||h(n)("obs2.Unknown")),1)])]),b("div",Q,[b("span",{class:g(["rule-item",{active:h(xe)?.enter}]),title:h(n)("obs2.Enter Zone")},v(h(n)("obs2.EnterShort")),11,ee),b("span",{class:g(["rule-item",{active:h(xe)?.countdown}]),title:h(n)("obs2.CountDown")},v(h(n)("obs2.CountdownShort")),11,te),b("span",{class:g(["rule-item",{active:h(xe)?.combatStart}]),title:h(n)("obs2.CombatStart")},v(h(n)("obs2.CombatStartShort")),11,ae),b("span",{class:g(["rule-item",{active:h(xe)?.combatEnd}]),title:h(n)("obs2.CombatEnd")},v(h(n)("obs2.CombatEndShort")),11,oe),b("span",{class:g(["rule-item",{active:h(xe)?.wipe}]),title:h(n)("obs2.Wipe")},v(h(n)("obs2.WipeShort")),11,ne)])],64)):(m(),f("div",se,v(h(n)("obs2.OBS Not Connected")),1)),b("button",{class:"settings-btn",onClick:s[0]||(s[0]=e=>_e.value=!h(_e))},v(h(_e)?"⚙":"－"),1)]),h(_e)?P("",!0):(m(),f(w,{key:0},[y(l,{title:h(n)("obs2.size warning"),type:"warning",center:"","show-icon":"",closable:!1,class:"window-size-warning"},null,8,["title"]),y(R,{class:"obs-container"},{default:d(()=>[y(Se,null,{default:d(()=>[h(ke).status.connected?(m(),f("div",re,[h(Pe)?(m(),i(R,{key:0,class:"status-card"},{header:d(()=>[b("div",ie,[b("span",null,v(h(n)("obs2.Connection Status")),1),y(S,{type:"danger",size:"small",class:"disconnect-button",onClick:s[4]||(s[4]=e=>h(ke).disconnect())},{default:d(()=>[C(v(h(n)("obs2.Disconnect")),1)]),_:1})])]),default:d(()=>[b("div",de,[y(U,{direction:"vertical",column:1,border:""},{default:d(()=>[y(E,{label:h(n)("obs2.Recording")},{default:d(()=>[C(v(h(ke).status.recording?h(n)("obs2.Yes"):h(n)("obs2.No")),1)]),_:1},8,["label"]),y(E,{label:h(n)("obs2.Output Path")},{default:d(()=>[C(v(h(ke).status.outputPath||h(n)("obs2.None")),1)]),_:1},8,["label"])]),_:1})]),b("div",ue,[y(S,{disabled:!h(ke).status.connected||h(ke).status.recording,type:"primary",onClick:s[5]||(s[5]=e=>h(ke).startRecord())},{default:d(()=>[C(v(h(n)("obs2.Start Record")),1)]),_:1},8,["disabled"]),y(S,{disabled:!h(ke).status.connected||!h(ke).status.recording,type:"danger",onClick:s[6]||(s[6]=e=>h(ke).stopRecord())},{default:d(()=>[C(v(h(n)("obs2.Stop Record")),1)]),_:1},8,["disabled"]),y(S,{disabled:!h(ke).status.connected||!h(ke).status.recording,type:"warning",onClick:s[7]||(s[7]=e=>h(ke).splitRecord())},{default:d(()=>[C(v(h(n)("obs2.Split Record")),1)]),_:1},8,["disabled"]),y(S,{type:"primary",onClick:s[8]||(s[8]=e=>h(ke).setProfileParameter("stop"))},{default:d(()=>[C(v(h(n)("obs2.Set Recording Name")),1)]),_:1})])]),_:1})):P("",!0),y(R,{class:"profile-card"},{header:d(()=>[b("div",pe,[b("span",null,v(h(n)("obs2.Recording Profile")),1),b("div",me,[y(c,{"storage-key":"obs-2-theme"}),y(r)])])]),default:d(()=>[b("div",be,[y(V,{"label-position":"top",class:"content-form profile-form-grid"},{default:d(()=>[y(p,{label:h(n)("obs2.Record Default Path")},{default:d(()=>[y(u,{modelValue:h(ye).path,"onUpdate:modelValue":s[9]||(s[9]=e=>h(ye).path=e),placeholder:h(n)("obs2.recordPathPlaceholder")},null,8,["modelValue","placeholder"]),y(l,{description:h(n)("obs2.filePathExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),y(p,{label:h(n)("obs2.Record File Name"),class:"filename-item"},{default:d(()=>[y(u,{modelValue:h(ye).fileName,"onUpdate:modelValue":s[10]||(s[10]=e=>h(ye).fileName=e),placeholder:h(n)("obs2.recordFileNamePlaceholder")},null,8,["modelValue","placeholder"]),y(l,{description:h(n)("obs2.fileNameExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),y(p,{class:"append-item"},{default:d(()=>[b("div",he,[b("span",null,v(h(n)("obs2.Append Content Name")),1),y(k,{modelValue:h(ye).appendContentName,"onUpdate:modelValue":s[11]||(s[11]=e=>h(ye).appendContentName=e)},null,8,["modelValue"])])]),_:1})]),_:1})])]),_:1}),y(l,{class:"instruction-alert",type:"info",description:h(n)("obs2.IMETutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(R,{class:"table-card"},{header:d(()=>[b("div",fe,[b("span",null,v(h(n)("obs2.User Content Settings")),1)])]),default:d(()=>[y(T,{data:h(Ce),border:!0,stripe:"","row-class-name":Ae},{default:d(()=>[y(N,{prop:"type",label:h(n)("obs2.Type"),width:"100",fixed:"",align:"center"},{default:d(e=>[h(ge)===e.row.type?(m(),f("span",we,[C(v(h(n)("obs2.Current")),1),s[12]||(s[12]=b("br",null,null,-1))])):P("",!0),b("span",null,v(e.row.type?h(n)(`obs2.${e.row.type}`):""),1)]),_:1},8,["label"]),y(N,{label:h(n)("obs2.Start When"),align:"center"},{default:d(()=>[y(N,{label:h(n)("obs2.When Party"),align:"center",width:"70"},{default:d(e=>[y(D,{modelValue:e.row.partyLength,"onUpdate:modelValue":t=>e.row.partyLength=t,min:1,max:48,style:{width:"40px"},size:"small",controls:!1},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"enter",label:h(n)("obs2.Enter Zone"),align:"center",width:"50"},{default:d(e=>[y(O,{modelValue:e.row.enter,"onUpdate:modelValue":t=>e.row.enter=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"countdown",label:h(n)("obs2.CountDown"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.countdown,"onUpdate:modelValue":t=>e.row.countdown=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"combatStart",label:h(n)("obs2.CombatStart"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.combatStart,"onUpdate:modelValue":t=>e.row.combatStart=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),y(N,{label:h(n)("obs2.End When"),align:"center"},{default:d(()=>[y(N,{prop:"combatEnd",label:h(n)("obs2.CombatEnd"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.combatEnd,"onUpdate:modelValue":t=>e.row.combatEnd=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"wipe",label:h(n)("obs2.Wipe"),align:"center",width:"50"},{default:d(e=>[y(O,{modelValue:e.row.wipe,"onUpdate:modelValue":t=>e.row.wipe=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"countdown",label:h(n)("obs2.CountDownCancel"),align:"center",width:"60"},{default:d(e=>[y(O,{modelValue:e.row.countdownCancel,"onUpdate:modelValue":t=>e.row.countdownCancel=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),y(N,{label:h(n)("obs2.Custom Path"),align:"left","min-width":"200"},{default:d(e=>[y(u,{modelValue:e.row.customPath,"onUpdate:modelValue":t=>e.row.customPath=t,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})])):(m(),i(R,{key:0,class:"connection-card"},{header:d(()=>[b("div",le,[b("span",null,v(h(n)("obs2.Connect to OBS")),1),b("div",ce,[y(c,{"storage-key":"obs-2-theme"}),y(r)])])]),default:d(()=>[y(V,{"label-position":"top",class:"connection-form"},{default:d(()=>[y(p,{label:h(n)("obs2.Port")},{default:d(()=>[y(u,{modelValue:h(ye).host,"onUpdate:modelValue":s[1]||(s[1]=e=>h(ye).host=e),placeholder:h(n)("obs2.portPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),y(p,{label:h(n)("obs2.Password")},{default:d(()=>[y(u,{modelValue:h(ye).password,"onUpdate:modelValue":s[2]||(s[2]=e=>h(ye).password=e),placeholder:h(n)("obs2.passwordPlaceholder"),type:"password"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),y(p,null,{default:d(()=>[y(S,{type:"primary",class:"connect-button",loading:h(ke).status.connecting,disabled:h(ke).status.connecting||!h(ye).host,onClick:s[3]||(s[3]=e=>h(ke).connect())},{default:d(()=>[C(v(h(ke).status.connecting?h(n)("obs2.Connecting"):h(n)("obs2.Connect")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),y(_,null,{default:d(()=>[C(v(h(n)("obs2.Instructions")),1)]),_:1}),y(l,{class:"instruction-alert",type:"info",description:h(n)("obs2.obsTutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(l,{class:"instruction-alert",type:"info",description:h(n)("obs2.inputTutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(l,{class:"instruction-alert",type:"info",description:h(n)("obs2.firewallTutorial"),closable:!1,"show-icon":""},null,8,["description"])]),_:1}))]),_:1})]),_:1})],64))]),_:1})}}}),[["__scopeId","data-v-4fb1f575"]]);export{ge as default};
