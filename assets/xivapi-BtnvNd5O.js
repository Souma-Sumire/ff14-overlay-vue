import{U as t}from"./util-DL4pAhxD.js";const e=new URLSearchParams(window.location.href.split("?")[1]).get("api"),n="cafemaker.wakingsands.com",o="xivapi.com",r=new Map,a={first:`https://${"xivapi"===(null==e?void 0:e.toLowerCase())?o:n}`,second:`https://${"xivapi"===(null==e?void 0:e.toLowerCase())?n:o}`},s={get random(){return Math.floor(864e5*Math.random()*11)+216e7}},c=new Map(Object.entries({"任务指令":"/i/000000/000123.png","冲刺":"/i/000000/000104.png","坐骑":"/i/000000/000118.png","攻击":"/i/000000/000101.png","腐秽大地":"/i/003000/003090.png"})),i="souma-action-cache",p=JSON.parse(localStorage.getItem(i)||"[]"),u=Date.now(),g=p.filter(((t,e)=>t.expirationTime>=u&&e<1e3));localStorage.setItem(i,JSON.stringify(g));const l=/(\d{6})\/(\d{6})\.png$/;async function m(t,e,n=["ID","Icon","ActionCategoryTargetID"]){if(r.has(e))return r.get(e);const o=function(t,e,n){const o=`${a.first}/${t}/${e}?columns=${n.join(",")}`;return[o,o.replace(a.first,a.second)]}(t,e,n);try{const t=await I(o,{mode:"cors"});return r.set(e,t),t}catch(s){return Promise.resolve({ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"})}}async function f(t,e=!1){return`${a.first}${t}`.replace(l,((t,n,o)=>`${n}/${e?"hq/":""}${o}.png`))}function d(e){const n=t.jobEnumToJob(e),o=t.nameToFullName(n);return`${a.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function w(t){return f((await m("action",t,["Icon"])).Icon)}async function h(t){const e=c.get(t);if(e)return{ActionCategoryTargetID:0,ID:0,Icon:e};const o=p.find((e=>e.name===t));if(null==o?void 0:o.action)return o.action;try{const e=(await I([`https://${n}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).Results[0];if(e){const n=Date.now()+s.random,o={name:t,action:e,expirationTime:n};return p.push(o),localStorage.setItem(i,JSON.stringify(p)),e}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(r){throw new Error("Failed to retrieve action data")}}async function $(t,e){let n;const o=new Promise(((t,o)=>{n=setTimeout((()=>{o(new Error("Promise timed out"))}),e)}));return Promise.race([t,o]).finally((()=>{clearTimeout(n)}))}async function I(t,e){const n=Object.assign({cache:"force-cache"},e);for(const o of t)try{const t=await $(fetch(o,n),3e3);if(t.ok){const e=await t.json(),n=new URL(o).host;return{...e,Host:n}}}catch{}throw new Error("All fetch attempts failed.")}const y=new Map;function v(t){return y.has(t)?y.get(t):`${a.first}${t}`}function D(t){var e;const n=t.target,o=null==(e=n.src.match(new RegExp("(?<=\\.\\w+)\\/.+$")))?void 0:e[0];o&&""!==n.src&&(/pictomancer\.png$/.test(n.src)?n.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(n.src)?n.src="//souma.diemoe.net/resources/img/viper.png":n.src.includes(a.first)?n.src=n.src.replace(a.first,a.second):n.src="",y.set(o,n.src))}export{h as a,f as b,w as c,r as d,d as e,v as g,D as h,m as p,a as s};
