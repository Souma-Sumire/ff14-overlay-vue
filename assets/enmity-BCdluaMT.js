import{_ as e}from"./ActWrapper-B1PpXsLK.js";import{d as t,r as n,aH as a,i as o,bk as r,k as i,w as s,o as m,l as u,v as l,u as c,a as d}from"./index-7lbPytPI.js";import{t as p}from"./tts-BkZGqxam.js";import{U as f}from"./util-BGyYb48-.js";import{N as w}from"./netregexes-vajTpmRp.js";import{a as b,r as v,c as g}from"./overlay_plugin_api-DHbPkDtN.js";import{_ as h}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./el-card-BmCIgkMI.js";import"./useDev-CojQ6TAh.js";import"./useDemo-DjXawXjP.js";import"./regexes-CQgF4nC9.js";const T=h(t({__name:"enmity",setup(t){let h=0;const T=n([]),y=a("hash"),C=n(!1),j=[f.iconToJobEnum("Paladin"),f.iconToJobEnum("Warrior"),f.iconToJobEnum("DarkKnight"),f.iconToJobEnum("Gunbreaker")],I=[2843,3124,743,1833];let _,k;const P={countdown:w.countdown(),countdownCancel:w.countdownCancel(),wipe:w.network6d({command:["40000010","4000000F"]}),inCombat:w.inCombat()};async function L(){const e=(await g({call:"getCombatants"})).combatants.filter(e=>T.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===h)?.Job;if(void 0===t)return E(),C.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!j.includes(t))return E(),C.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>I.includes(e.BuffID))),partyCombatState:e}}function D(){E(),_=window.setInterval(()=>{L().then(({enmityTanks:e})=>{0!==e.length?C.value=!1:C.value=!0}).catch(()=>{C.value=!1})},500)}function E(){k&&clearTimeout(k),_&&clearInterval(_)}const J=e=>{const t=P.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)D(),k=window.setTimeout(()=>{L().then(({enmityTanks:e})=>{2===e.length&&p("双T都开盾了"),0===e.length&&p("没人开盾")}).catch(()=>{C.value=!1})},1e3*(Number.parseInt(t)-10));else if(P.countdownCancel.test(e.rawLine))E(),C.value=!1;else if(P.wipe.test(e.rawLine))E(),C.value=!1;else if(P.inCombat.test(e.rawLine)){if("false"===y.stRemind)return;const{inACTCombat:t,inGameCombat:n}=P.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===n&&(D(),k=window.setTimeout(()=>{L().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>f.isTankJob(f.jobEnumToJob(e.Job))).length&&1===e.length&&e[0]?.ID!==h&&p("ST开盾")}).catch(()=>{C.value=!1})},2e4))}},x=e=>{T.value=e.party},A=e=>{h=e.charID};return o(()=>{b("LogLine",J),b("PartyChanged",x),b("ChangePrimaryPlayer",A)}),r(()=>{_&&clearInterval(_),k&&clearTimeout(k),v("LogLine",J),v("PartyChanged",x),v("ChangePrimaryPlayer",A)}),(t,n)=>{const a=e;return m(),i(a,null,{default:s(()=>[u(d("strong",null,"没人开盾",512),[[l,c(C)]])]),_:1})}}}),[["__scopeId","data-v-55dd9f0d"]]);export{T as default};
