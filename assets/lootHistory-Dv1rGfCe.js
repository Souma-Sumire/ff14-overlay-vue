import{_ as e,a as l}from"./shared-common-BdSdGmdv.js";import{o as a,t,H as s,L as o,M as n,Z as i,X as r,c as u,I as c,A as d,K as v,J as p,u as m,v as y,Y as f,R as g,am as h,a9 as k,r as b,bH as w,G as _,B as C,D as V,a5 as S,$ as x,V as E,_ as $,al as B,O as T,ba as O,W as R}from"./vendor-vue-GqahCgpc.js";import{e as D,a5 as z,n as M,a6 as U,a7 as P,a8 as L,a9 as A,J as j,aa as W,ab as N,ac as F,D as I,q as Y,ad as J,ae as H,b as K,af as q,ag as X,X as G,I as Q,ah as Z,a as ee,E as le,k as ae,ai as te,aj as se,C as oe,ak as ne,al as ie,am as re,M as ue,N as ce,an as de,ao as ve,ap as pe,aq as me,c as ye,d as fe,L as ge,ar as he,K as ke,as as be,g as we,at as _e,au as Ce,F as Ve,G as Se,av as xe,y as Ee,l as $e,aw as Be,ax as Te,ay as Oe,az as Re,aA as De,U as ze,S as Me,aB as Ue,j as Pe}from"./vendor-element-plus-DIlhOlLn.js";import{I as Le,J as Ae,K as je,L as We,N as Ne,R as Fe,O as Ie,P as Ye,Q as Je,S as He,T as Ke,W as qe,X as Xe,Y as Ge,$ as Qe,a0 as Ze,a1 as el,a2 as ll,a3 as al,a4 as tl,a5 as sl,a6 as ol,a7 as nl}from"./shared-core-CcY-Sor_.js";import{u as il,s as rl,i as ul,a as cl,b as dl,c as vl,d as pl,e as ml,f as yl,g as fl,h as gl,j as hl}from"./vendor-echarts-x3EN9-bk.js";import"./cactbot-CmNinDrW.js";const kl=e(a({__name:"RoleBadge",props:{role:{},large:{type:Boolean}},setup(e){const l=e,a=u(()=>Le(l.role)),c=u(()=>l.role?Ae(l.role):"");return(l,u)=>e.role?(t(),s("span",{key:0,class:n(["role-badge",{"badge-large":e.large}]),style:o({backgroundColor:a.value})},i(c.value),7)):r("",!0)}}),[["__scopeId","data-v-c41a273e"]]),bl=e(a({__name:"PlayerDisplay",props:{name:{},role:{},showOnlyRole:{type:Boolean},nameClass:{}},setup:e=>(l,a)=>(t(),s("div",{class:n(["player-display",{"is-large":e.showOnlyRole}])},[c(kl,{role:e.role,large:e.showOnlyRole,class:"role-icon"},null,8,["role","large"]),e.showOnlyRole&&e.role?r("",!0):(t(),s("span",{key:0,class:n(["player-name-text",e.nameClass])},i(e.name),3))],2))}),[["__scopeId","data-v-d997b569"]]),wl={class:"bis-allocator"},_l={class:"bis-toolbar"},Cl={key:0,class:"dot-warn"},Vl={key:0,class:"bis-view-panel"},Sl={class:"table-container"},xl={class:"bis-table"},El={class:"premium-header-player"},$l=["onClick"],Bl={key:0},Tl=["rowspan"],Ol={class:"sticky-col col-item row-header"},Rl={class:"equip-cell-content"},Dl={class:"tooltip-title"},zl={class:"tooltip-player-list"},Ml=["onClick"],Ul={class:"player-option-item"},Pl={key:0,class:"tooltip-divider"},Ll=["onClick"],Al={class:"cell-status-container"},jl={class:"status-main"},Wl={key:0,class:"status-meta"},Nl={key:1,class:"bis-onboarding"},Fl={class:"onboarding-card"},Il={class:"icon-circle"},Yl={class:"bis-config-panel-container"},Jl={class:"bis-config-header-row"},Hl={class:"bis-storage-info"},Kl={class:"planned-weeks-config"},ql={key:0,class:"validation-alerts"},Xl={class:"alert-msg"},Gl={class:"table-scroll-wrapper"},Ql={class:"bis-table config-table"},Zl={class:"vert-header"},ea={class:"header-action-area"},la={key:0,class:"incomplete-label"},aa={class:"preset-apply-zone"},ta=["title"],sa={key:2},oa={class:"preset-item-content"},na={class:"preset-item-content"},ia=["onClick"],ra={class:"expand-action"},ua={class:"preset-item-content"},ca={class:"sticky-col row-header"},da={key:0,class:"split-cell"},va=["onClick"],pa=["onClick"],ma={key:1,class:"count-cell"},ya={class:"count-wrapper"},fa={class:"dialog-footer"},ga={class:"footer-left"},ha={class:"footer-right"},ka={class:"config-status-msg"},ba={key:0},wa={key:0,class:"import-empty-msg"},_a={key:1,class:"import-diff-container"},Ca={class:"import-summary"},Va={class:"diff-header"},Sa={key:0,class:"diff-tag"},xa={key:1,class:"diff-tag update"},Ea={class:"diff-items"},$a={class:"diff-label"},Ba={class:"diff-values"},Ta={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},Oa={key:0,class:"import-diff-container"},Ra={class:"import-summary"},Da={class:"diff-card"},za={class:"diff-header"},Ma={key:0,class:"diff-tag"},Ua={key:1,class:"diff-tag update"},Pa={class:"diff-items"},La={class:"diff-label"},Aa={class:"diff-values"},ja={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},Wa=e(a({__name:"BisAllocator",props:{players:{},records:{},modelValue:{},getPlayerRole:{type:Function},getActualPlayer:{type:Function},showOnlyRole:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:l}){const a=e,o=l,w=b({}),_=b(!1),C=b(new Set),V=b({}),S=b({playerBis:{},plannedWeeks:8}),x=b(!1),E=b(!1),$=b([]),B=b(null),T=b(void 0),O={pass:{text:"放弃",class:"status-pass"},need:{text:"需求",class:"status-need"},greed:{text:"贪婪",class:"status-greed-tome"},assigned:{text:"分配",class:"status-assigned"}},R=u(()=>Je.map(e=>{const l=e.items.map(e=>Ie.find(l=>l.id===e)).filter(e=>!!e);return{name:e.name,rows:l}})),ae=u(()=>{const e=He;return[...Ie].sort((l,a)=>{const t=e.indexOf(l.keywords),s=e.indexOf(a.keywords);return-1===t&&-1===s?0:-1===t?1:-1===s?-1:t-s})}),te=u(()=>a.players.filter(Ve)),se=b(new Set),oe=u(()=>{for(const e of Fe)if(!je(S.value,e))return!1;return!0}),ne=u(()=>Fe.filter(e=>!je(S.value,e)).length),ie=u(()=>{const e=[],l=S.value.plannedWeeks||8;return[{id:"coating",name:"硬化药"},{id:"twine",name:"强化纤维"},{id:"tome",name:"神典石"},{id:"solvent",name:"强化药"}].forEach(a=>{let t=0;te.value.forEach(e=>{t+=Be(e,a.id)}),t>l&&e.push({id:a.id,type:"warning",message:`${a.name}: 总需求(${t}) 大于 计划周数(${l})，这是不可能的分配。`})}),e});function re(e){const l=[];return e.forEach(e=>{const t=[],s=[];if(V.value[e.id]){const t=V.value[e.id];let s=a.getPlayerRole?.(t)||t;return s=s.replace(/^LEFT:/,"").trim(),void l.push(`/p ${e.name}：${s} (队长分配)`)}te.value.forEach(l=>{if(C.value.has(l))return;let o=a.getPlayerRole?.(l)||l;o=o.replace(/^LEFT:/,"").trim();const n=we(l,e);"need"===n?t.push(o):"greed"===n&&s.push(o)});let o="";o=t.length>0?t.join("、"):s.length>0?s.join("、"):"随便ROLL",l.push(`/p ${e.name}：${o}`)}),l}function ue(e){const l=new Date,t=a.records&&0!==a.records.length?Ye(a.records.map(e=>e.timestamp)):1,s=`${l.getMonth()+1}月${l.getDate()}日`;let o="",n="";if("all"===e){const e=[`/p <第${t}周分配优先级> ${s}`];R.value.forEach(l=>{e.push(...re(l.rows))}),o=e.join("\n"),n=`已复制全层宏 (共${e.length}行)`}else{const l=[`/p <第${t}周${e.name}分配优先级> ${s}`];l.push(...re(e.rows)),o=l.join("\n"),n=`已复制 ${e.name} 分配宏`}o&&navigator.clipboard.writeText(o).then(()=>{ee.success(n)}).catch(()=>{ee.error("复制失败")})}function ce(e){return Object.values(V.value).includes(e)}function de(e){if(!a.getPlayerRole)return e;const l=a.getPlayerRole(e);return!l||l.startsWith("LEFT:")||l.startsWith("SUB:")?e:l}function ve(){const e=Fe.filter(e=>!!S.value.playerBis[e]).map(e=>{const l=Ie.map(l=>{const a=S.value.playerBis[e]?.[l.id];return"toggle"===l.type?"raid"===a?"1":"0":"number"==typeof a&&a>0?"1":"0"}).join(""),a=Number.parseInt(l,2).toString(36);return`${e}:${a}`}).join(";");navigator.clipboard.writeText(e).then(()=>{ee.success("BIS 设置已复制到剪贴板")})}function pe(){le.prompt("请粘贴 BIS 设置字符串","导入 BIS 设置",{confirmButtonText:"下一步",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"在此粘贴...",customClass:"bis-import-message-box",inputValidator:e=>{if(!e)return"内容不能为空";const l=e.trim().split(";").filter(e=>e.trim());if(0===l.length)return"格式错误：无法识别有效的分隔符";let a=0;for(const t of l){if(t.startsWith("weeks:"))continue;const e=t.split(":");if(2!==e.length)return`数据格式错误："${t.slice(0,10)}..."`;const[l,s]=e;if(!s||!/^[0-9a-z]+$/i.test(s))return`数据校验失败：职位 "${l||"未知"}" 的设置已损坏`;Fe.includes(l)&&a++}return 0!==a||"未找到匹配当前团队的有效设置数据"}}).then(({value:e})=>{e&&function(e){try{const l=e.trim();if(!l)throw new Error("输入内容为空");const t=l.split(";").filter(e=>e.trim());if(0===t.length)throw new Error("无效的格式");const s=[];if(T.value=void 0,t.forEach(e=>{if(e.startsWith("weeks:")){const l=Number.parseInt(e.split(":")[1]||"0");return void(Number.isNaN(l)||(T.value=l))}const l=e.split(":");if(2!==l.length)return;const t=l[0],o=l[1];if(!t||!o||!Fe.includes(t))return;const n=te.value.filter(e=>a.getPlayerRole?.(e)===t)[0]||t,i=Number.parseInt(o,36).toString(2).padStart(Ie.length,"0"),r={};Ie.forEach((e,l)=>{const a=i[l];"toggle"===e.type?r[e.id]="1"===a?"raid":"tome":r[e.id]="1"===a?1:0});const u=S.value.playerBis[t]||{},c=[];let d=!1;Ie.forEach(e=>{const l=u[e.id],a=r[e.id],t=me(e,l),s=me(e,a);t!==s&&(d=!0,c.push({label:e.name,oldVal:t,newVal:s}))}),d&&s.push({name:n,role:t,isNew:0===Object.keys(u).length,changes:c,newConfig:r})}),0===s.length)return void ee.info("未检测到有效的设置变更。");$.value=s,x.value=!0}catch(l){ee.error(l.message||"解析失败")}}(e)}).catch(()=>{})}function me(e,l){return"toggle"===e.type?"raid"===l?"零式":"tome"===l?"点数":"未设置":(l||1).toString()}function ye(e){return"零式"===e?"is-raid":"点数"===e?"is-tome":""}function fe(){!function(){const e={...S.value.playerBis};$.value.forEach(l=>{e[l.role]={...e[l.role],...l.newConfig}}),S.value.playerBis=e,void 0!==T.value&&(S.value.plannedWeeks=T.value);x.value=!1,ee.success(`成功更新 ${$.value.length} 个职位的配置`)}()}function ge(e,l,a){const t=de(e);S.value.playerBis[t]||(S.value.playerBis[t]={});S.value.playerBis[t][l]===a?delete S.value.playerBis[t][l]:S.value.playerBis[t][l]=a}function he(){if(!B.value?.diff)return;const{player:e,preset:l,diff:a}=B.value,t=de(e);S.value.playerBis[t]||(S.value.playerBis[t]={}),Object.assign(S.value.playerBis[t],a.newConfig),E.value=!1,B.value=null,ee.success(`已应用预设: ${l.name} (${e})`)}function ke(e,l){if(!a.records)return 0;const t=l.keywords.replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);return 0===t.length?0:a.records.filter(l=>(a.getActualPlayer?a.getActualPlayer(l.player):l.player)===e&&t.some(e=>l.item.includes(e))).length}function be(e,l){return ke(e,l)>0}function we(e,l){const a=V.value[l.id];if(a)return a===e?"assigned":"pass";if("count"===l.type){const a=Be(e,l.id);return 0===a?"greed":ke(e,l)>=a?"pass":"need"}return be(e,l)?"pass":"raid"===Ee(e,l.id)?"need":"greed"}function _e(e,l){if("count"===l.type){const a=Be(e,l.id);return 0===a?"greed":ke(e,l)>=a?"pass":"need"}return be(e,l)?"pass":"raid"===Ee(e,l.id)?"need":"greed"}function Ce(e,l){const a=we(e,l);return O[a]?.text||""}function Ve(e){if(!a.getPlayerRole)return!1;const l=a.getPlayerRole(e);return!!l&&(!l.startsWith("LEFT:")&&!l.startsWith("SUB:"))}function Se(e){const l=a.getPlayerRole?.(e);if(!l)return null;const t=de(e),s=S.value.playerBis[t];if(!s||0===Object.keys(s).length)return null;const{recommended:o,others:n}=Ne(l),i=[...o,...n];for(const a of i){let e=!0;for(const l of Object.keys(a.config))if(s[l]!==a.config[l]){e=!1;break}if(e)return a.name}return null}function xe(e){const l=a.getPlayerRole?.(e),t=Ne(l);return t.recommended.length>0||t.others.length>0}function Ee(e,l){return S.value.playerBis[de(e)]?.[l]}function $e(e,l){return"tome"===Ee(e,l)}function Be(e,l){const a=Ee(e,l);return"number"==typeof a?a:["tome","solvent"].includes(l)?0:1}function Te(e,l){const a=we(e,l),t=O[a]?.class||"";return C.value.has(e)?`${t} is-excluded`:t}d(()=>a.modelValue,e=>{if(e)if(function(e){if(!e||"object"!=typeof e||!e.playerBis)return!1;const l=Object.keys(e.playerBis)[0];return!!l&&Array.isArray(e.playerBis[l])}(e)){const l={playerBis:{}},a=JSON.parse(JSON.stringify(e));Object.keys(a.playerBis).forEach(e=>{l.playerBis[e]={};const t=a.playerBis[e];t&&t.forEach(a=>{l.playerBis[e]&&(l.playerBis[e][a]="raid")})}),S.value=l}else{const l=e;JSON.stringify(l)!==JSON.stringify(S.value)&&(S.value={...l,plannedWeeks:l.plannedWeeks??8})}},{immediate:!0,deep:!0}),d(S,e=>{JSON.stringify(e)!==JSON.stringify(a.modelValue)&&o("update:modelValue",e)},{deep:!0});const Oe=We;return(l,o)=>{const u=D,d=M,b=L,T=A,le=U,re=j,be=Y,we=K,Ve=G,Re=Q;return t(),s("div",wl,[v("div",_l,[c(d,{size:"small",type:"primary",plain:"",class:"setup-trigger-btn",onClick:o[0]||(o[0]=e=>_.value=!0)},{default:p(()=>[c(u,{style:{"margin-right":"4px"}},{default:p(()=>[c(m(z))]),_:1}),o[9]||(o[9]=v("span",null,"设置 BIS",-1)),oe.value?r("",!0):(t(),s("span",Cl))]),_:1}),oe.value?(t(),y(le,{key:0,trigger:"click",onCommand:ue},{dropdown:p(()=>[c(T,null,{default:p(()=>[c(b,{command:"all"},{default:p(()=>[...o[11]||(o[11]=[f(" 全层 ",-1)])]),_:1}),(t(!0),s(g,null,h(R.value,e=>(t(),y(b,{key:e.name,command:e,divided:""},{default:p(()=>[f(i(e.name),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:p(()=>[c(d,{size:"small"},{default:p(()=>[o[10]||(o[10]=f(" 复制分配宏",-1)),c(u,{class:"el-icon--right"},{default:p(()=>[c(m(P))]),_:1})]),_:1})]),_:1})):r("",!0),oe.value?(t(),y(re,{key:1,placement:"top",title:"分配宏生成规则",width:320,trigger:"hover"},{reference:p(()=>[c(u,{class:"macro-help-icon"},{default:p(()=>[c(m(W))]),_:1})]),default:p(()=>[o[12]||(o[12]=v("div",{class:"macro-help-content"},[v("div",{class:"intro"}," 生成可以直接在游戏内发送的分配宏（/p）。 "),v("div",{class:"rule-item"},[v("strong",null,"1. 优先需求"),v("span",null,"仅显示BIS设为“零式”且尚未获得的玩家。")]),v("div",{class:"rule-item"},[v("strong",null,"2. 次选贪婪"),v("span",null,"若无需求者，显示其余尚未获得的玩家。")]),v("div",{class:"rule-item"},[v("strong",null,"3. 兜底机制"),v("span",null,"若全员不需要，显示“随便ROLL”。")])],-1))]),_:1})):r("",!0)]),oe.value?(t(),s("div",Vl,[v("div",Sl,[v("table",xl,[v("thead",null,[v("tr",null,[o[14]||(o[14]=v("th",{class:"sticky-col col-layer",style:{"z-index":"30"}},null,-1)),o[15]||(o[15]=v("th",{class:"sticky-col col-item",style:{"z-index":"30"}}," 装备 \\ 玩家 ",-1)),(t(!0),s(g,null,h(te.value,l=>(t(),s("th",{key:l,class:n({"is-excluded":C.value.has(l)})},[v("div",El,[c(bl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),v("div",{class:n(["leave-tag-trigger",{"is-away":C.value.has(l),"is-disabled":ce(l)}]),onClick:k(e=>{return ce(l)?null:(a=l,void(C.value.has(a)?C.value.delete(a):C.value.add(a)));var a},["stop"])},[C.value.has(l)?(t(),s("span",Bl,"已请假")):(t(),s(g,{key:1},[c(u,{style:{"margin-right":"2px"}},{default:p(()=>[c(m(N))]),_:1}),o[13]||(o[13]=v("span",null,"请假",-1))],64))],10,$l)])],2))),128))])]),v("tbody",null,[(t(!0),s(g,null,h(R.value,l=>(t(),s(g,{key:l.name},[(t(!0),s(g,null,h(l.rows,(d,y)=>(t(),s("tr",{key:d.id,class:n({"is-layer-end":y===l.rows.length-1})},[0===y?(t(),s("td",{key:0,rowspan:l.rows.length,class:"sticky-col col-layer layer-cell"},i(l.name),9,Tl)):r("",!0),v("td",Ol,[v("div",Rl,[v("span",null,i(d.name),1),c(be,{visible:w.value[d.id],"onUpdate:visible":e=>w.value[d.id]=e,placement:"right",trigger:"click","popper-class":"captain-player-tooltip-new",effect:"dark",offset:15,"hide-after":0},{content:p(()=>[v("div",Dl,[o[16]||(o[16]=f(" 将 ",-1)),v("span",null,i(d.name),1),o[17]||(o[17]=f(" 分配给 ",-1))]),v("div",zl,[(t(!0),s(g,null,h(te.value,l=>(t(),s("div",{key:l,class:n(["tooltip-player-item",{"is-disabled":C.value.has(l),"is-active":V.value[d.id]===l}]),onClick:e=>!C.value.has(l)&&(V.value[d.id]=l)},[v("div",Ul,[c(bl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),v("span",{class:n(["mini-status-tag",[_e(l,d)]])},i(O[_e(l,d)].text),3)])],10,Ml))),128)),V.value[d.id]?(t(),s("div",Pl)):r("",!0),V.value[d.id]?(t(),s("div",{key:1,class:"tooltip-player-item clear-btn",onClick:e=>V.value[d.id]=""},[c(u,null,{default:p(()=>[c(m(I))]),_:1}),o[18]||(o[18]=v("span",null,"取消分配",-1))],8,Ll)):r("",!0)])]),default:p(()=>[v("div",{class:n(["assign-tag-trigger",{"is-active":V.value[d.id],"is-open":w.value[d.id]}])},[V.value[d.id]?(t(),s(g,{key:0},[c(bl,{name:V.value[d.id],role:a.getPlayerRole?.(V.value[d.id]),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),o[19]||(o[19]=v("span",{class:"p-status"},"已分配",-1))],64)):(t(),s(g,{key:1},[c(u,{style:{"margin-right":"2px"}},{default:p(()=>[c(m(F))]),_:1}),o[20]||(o[20]=v("span",null,"分配",-1))],64))],2)]),_:2},1032,["visible","onUpdate:visible"])])]),(t(!0),s(g,null,h(te.value,e=>(t(),s("td",{key:e,class:n(Te(e,d))},[v("div",Al,[v("span",jl,i(Ce(e,d)),1),"count"===d.type&&Be(e,d.id)>1?(t(),s("span",Wl," ("+i(ke(e,d))+"/"+i(Be(e,d.id))+") ",1)):r("",!0)])],2))),128))],2))),128))],64))),128))])])])])):(t(),s("div",Nl,[v("div",Fl,[v("div",Il,[c(u,null,{default:p(()=>[c(m(J))]),_:1})]),o[22]||(o[22]=v("h3",null,"开启 BIS 分配",-1)),o[23]||(o[23]=v("p",null,"尚未设置团队成员的 BIS，无法生成分配推荐。",-1)),c(d,{type:"primary",size:"large",onClick:o[1]||(o[1]=e=>_.value=!0)},{default:p(()=>[...o[21]||(o[21]=[f(" 立即开始设置 ",-1)])]),_:1})])])),c(Re,{modelValue:_.value,"onUpdate:modelValue":o[4]||(o[4]=e=>_.value=e),width:"auto","append-to-body":"",class:"bis-config-dialog","destroy-on-close":"","align-center":""},{footer:p(()=>[v("div",fa,[v("div",ga,[c(Ve,null,{default:p(()=>[c(d,{size:"small",onClick:ve},{default:p(()=>[...o[30]||(o[30]=[f(" 导出 BIS 设置 ",-1)])]),_:1}),c(d,{size:"small",onClick:pe},{default:p(()=>[...o[31]||(o[31]=[f(" 导入 BIS 设置 ",-1)])]),_:1})]),_:1})]),v("div",ha,[v("div",ka,[ne.value>0?(t(),s("span",ba," 还剩 "+i(ne.value)+" 个职位的 BIS 尚未填完 ",1)):r("",!0)]),c(d,{type:"primary",size:"small",onClick:o[3]||(o[3]=e=>_.value=!1)},{default:p(()=>[...o[32]||(o[32]=[f(" 完成并关闭 ",-1)])]),_:1})])])]),default:p(()=>[v("div",Yl,[v("div",Jl,[v("div",Hl,[c(u,null,{default:p(()=>[c(m(H))]),_:1}),o[24]||(o[24]=v("span",null,"提示：此 BIS 设置跟随职位（MT/ST等），不跟随具体玩家。",-1))]),v("div",Kl,[o[25]||(o[25]=v("span",{class:"label"},"你们计划清几周CD：",-1)),c(we,{modelValue:S.value.plannedWeeks,"onUpdate:modelValue":o[2]||(o[2]=e=>S.value.plannedWeeks=e),min:1,max:16,size:"small","controls-position":"right",class:"weeks-stepper"},null,8,["modelValue"])])]),ie.value.length>0?(t(),s("div",ql,[(t(!0),s(g,null,h(ie.value,e=>(t(),s("div",{key:e.id,class:n(["validation-alert",[e.type]])},[c(u,{class:"alert-icon"},{default:p(()=>["info"===e.type?(t(),y(m(H),{key:0})):(t(),y(m(q),{key:1}))]),_:2},1024),v("span",Xl,i(e.message),1)],2))),128))])):r("",!0),v("div",Gl,[v("table",Ql,[v("thead",null,[v("tr",null,[o[29]||(o[29]=v("th",{class:"sticky-col"}," 装备 \\ 玩家 ",-1)),(t(!0),s(g,null,h(te.value,l=>(t(),s("th",{key:l,class:n([{"header-incomplete":!m(je)(S.value,de(l))},{"is-excluded":C.value.has(l)},m(Oe)(e.getPlayerRole?.(l))])},[v("div",Zl,[c(bl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),v("div",ea,[m(je)(S.value,de(l))?r("",!0):(t(),s("span",la,"未填写")),v("div",aa,[xe(l)?(t(),y(le,{key:0,trigger:"click","popper-class":"bis-preset-popper",onCommand:e=>function(e,l){const t=de(e),s=S.value.playerBis[t]||{},o={...l.config},n=[];if(Ie.forEach(e=>{const l=s[e.id],a=o[e.id],t=me(e,l),i=me(e,a);t!==i&&n.push({label:e.name,oldVal:t,newVal:i})}),0===n.length)return void ee.info("当前设置与预设相同，无需更改");const i={name:e,role:a.getPlayerRole?.(e)||"Unknown",isNew:0===Object.keys(s).length,changes:n,newConfig:o};B.value={player:e,preset:l,diff:i},E.value=!0}(l,e),onVisibleChange:e=>!e&&se.value.delete(l)},{dropdown:p(()=>[c(T,{class:"bis-preset-dropdown"},{default:p(()=>[(t(!0),s(g,null,h(m(Ne)(e.getPlayerRole?.(l)).recommended,e=>(t(),y(b,{key:e.name,command:e},{default:p(()=>[v("div",oa,[c(u,null,{default:p(()=>[c(m(X))]),_:1}),v("span",null,i(e.name),1)])]),_:2},1032,["command"]))),128)),0===m(Ne)(e.getPlayerRole?.(l)).recommended.length?(t(!0),s(g,{key:0},h(m(Ne)(e.getPlayerRole?.(l)).others,e=>(t(),y(b,{key:e.name,command:e},{default:p(()=>[v("div",na,[c(u,null,{default:p(()=>[c(m(X))]),_:1}),v("span",null,i(e.name),1)])]),_:2},1032,["command"]))),128)):m(Ne)(e.getPlayerRole?.(l)).others.length>0?(t(),s(g,{key:1},[se.value.has(l)?(t(!0),s(g,{key:1},h(m(Ne)(e.getPlayerRole?.(l)).others,(e,l)=>(t(),y(b,{key:e.name,command:e,divided:0===l},{default:p(()=>[v("div",ua,[c(u,null,{default:p(()=>[c(m(X))]),_:1}),v("span",null,i(e.name),1)])]),_:2},1032,["command","divided"]))),128)):(t(),s("div",{key:0,class:"preset-expand-divider",onClick:k(e=>se.value.add(l),["stop"])},[o[27]||(o[27]=v("div",{class:"divider-line"},null,-1)),v("div",ra,[o[26]||(o[26]=v("span",null,"更多同职能预设",-1)),c(u,null,{default:p(()=>[c(m(P))]),_:1})]),o[28]||(o[28]=v("div",{class:"divider-line"},null,-1))],8,ia))],64)):r("",!0)]),_:2},1024)]),default:p(()=>[c(d,{size:"small",class:n(["preset-btn",{"is-matched":Se(l)}])},{default:p(()=>[Se(l)?r("",!0):(t(),y(u,{key:0,class:"magic-icon"},{default:p(()=>[c(m(X))]),_:1})),Se(l)?(t(),s("span",{key:1,class:"matched-name-inline",title:Se(l)??""},i(Se(l)),9,ta)):(t(),s("span",sa,"一键预设"))]),_:2},1032,["class"])]),_:2},1032,["onCommand","onVisibleChange"])):r("",!0)])])])],2))),128))])]),v("tbody",null,[(t(!0),s(g,null,h(ae.value,e=>(t(),s("tr",{key:e.id},[v("td",ca,i(e.name),1),(t(!0),s(g,null,h(te.value,l=>{return t(),s("td",{key:l,class:"split-cell-container"},["toggle"===e.type?(t(),s("div",da,[v("div",{class:n(["half-cell left-raid",{active:(a=l,o=e.id,"raid"===Ee(a,o))}]),onClick:a=>ge(l,e.id,"raid")}," 零式 ",10,va),v("div",{class:n(["half-cell right-tome",{active:$e(l,e.id)}]),onClick:a=>ge(l,e.id,"tome")}," 点数 ",10,pa)])):(t(),s("div",ma,[v("div",ya,[c(we,{"model-value":Be(l,e.id),min:0,max:8,size:"small","controls-position":"right",class:"mini-stepper","onUpdate:modelValue":a=>function(e,l,a){const t=de(e);S.value.playerBis[t]||(S.value.playerBis[t]={}),S.value.playerBis[t][l]=a}(l,e.id,a||0)},null,8,["model-value","onUpdate:modelValue"])])]))]);var a,o}),128))]))),128))])])])])]),_:1},8,["modelValue"]),c(Re,{modelValue:x.value,"onUpdate:modelValue":o[6]||(o[6]=e=>x.value=e),title:"确认导入 BIS 设置",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:p(()=>[v("div",Ta,[c(d,{onClick:o[5]||(o[5]=e=>x.value=!1)},{default:p(()=>[...o[33]||(o[33]=[f(" 取消 ",-1)])]),_:1}),c(d,{type:"primary",disabled:0===$.value.length,onClick:fe},{default:p(()=>[...o[34]||(o[34]=[f(" 确认应用 ",-1)])]),_:1},8,["disabled"])])]),default:p(()=>[0===$.value.length?(t(),s("div",wa," 没有检测到有效的变更数据。 ")):(t(),s("div",_a,[v("p",Ca," 检测到 "+i($.value.length)+" 位玩家的设置变更。 ",1),(t(!0),s(g,null,h($.value,l=>(t(),s("div",{key:l.name,class:"diff-card"},[v("div",Va,[c(bl,{name:l.name,role:l.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),l.isNew?(t(),s("span",Sa,"新设置")):(t(),s("span",xa,"更新"))]),v("div",Ea,[(t(!0),s(g,null,h(l.changes,(e,l)=>(t(),s("div",{key:l,class:"diff-row"},[v("span",$a,i(e.label),1),v("div",Ba,[v("span",{class:n(["val old",ye(e.oldVal)])},i(e.oldVal),3),c(u,null,{default:p(()=>[c(m(Z))]),_:1}),v("span",{class:n(["val new",ye(e.newVal)])},i(e.newVal),3)])]))),128))])]))),128))]))]),_:1},8,["modelValue"]),c(Re,{modelValue:E.value,"onUpdate:modelValue":o[8]||(o[8]=e=>E.value=e),title:"确认预设变更",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:p(()=>[v("div",ja,[c(d,{onClick:o[7]||(o[7]=e=>E.value=!1)},{default:p(()=>[...o[35]||(o[35]=[f(" 取消 ",-1)])]),_:1}),c(d,{type:"primary",onClick:he},{default:p(()=>[...o[36]||(o[36]=[f(" 确认应用 ",-1)])]),_:1})])]),default:p(()=>[B.value?.diff?(t(),s("div",Oa,[v("p",Ra," 应用 ["+i(B.value.preset.name)+"] 将会产生以下变更： ",1),v("div",Da,[v("div",za,[c(bl,{name:B.value.diff.name,role:B.value.diff.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),B.value.diff.isNew?(t(),s("span",Ma,"新设置")):(t(),s("span",Ua,"更新"))]),v("div",Pa,[(t(!0),s(g,null,h(B.value.diff.changes,(e,l)=>(t(),s("div",{key:l,class:"diff-row"},[v("span",La,i(e.label),1),v("div",Aa,[v("span",{class:n(["val old",ye(e.oldVal)])},i(e.oldVal),3),c(u,null,{default:p(()=>[c(m(Z))]),_:1}),v("span",{class:n(["val new",ye(e.newVal)])},i(e.newVal),3)])]))),128))])])])):r("",!0)]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-bb560faa"]]),Na={class:"chart-container"},Fa={class:"chart-body"},Ia=e(a({__name:"ChartPlayerDistribution",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=e,a=w({storageKey:"loot-history-theme"});il([ul,cl,dl,vl,pl,ml]);const o=u(()=>{const e=l.playerVisibility,t=new Map;l.players.forEach(e=>t.set(e,0)),l.records.forEach(e=>{const a=l.getActualPlayer?l.getActualPlayer(e.player):e.player;t.has(a)&&t.set(a,(t.get(a)||0)+1)});const s=l.players.map(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;return{name:e,value:t.get(e)||0,role:a?Ae(a):""}}),o=s.map(e=>e.name),n=s.map(e=>e.value),i=new Map;return l.players.forEach(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;a&&i.set(e,a)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0],a=l.name,t=i.get(a);return`${t?`[${t}] `:""}${a}<br/>获取数量: <b>${l.value}</b>`}},grid:{left:"2%",right:"2%",bottom:"10%",top:"10%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=i.get(e);return qe(e,a,l.playerVisibility)},rich:Ke(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",minInterval:1,splitLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"获取数量",type:"bar",barWidth:"50%",data:n,itemStyle:{color:e=>{const l=e.name,a=i.get(l);return Le(a)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",color:a.value?"#f1f5f9":"#1e293b"}}]}});return(e,l)=>(t(),s("div",Na,[l[0]||(l[0]=v("div",{class:"chart-header"},[v("div",{class:"chart-title"}," 获取数量统计 ")],-1)),v("div",Fa,[c(m(rl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:m(a)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),[["__scopeId","data-v-028ae238"]]),Ya={class:"chart-container"},Ja={class:"chart-body"},Ha=e(a({__name:"ChartRollLuck",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=e,a=w({storageKey:"loot-history-theme"});il([ul,cl,yl,dl,vl,pl,ml,fl]);const o=u(()=>{const e=l.playerVisibility,t=new Map;l.players.forEach(e=>t.set(e,[])),l.records.forEach(e=>{e.rolls.forEach(e=>{if(("need"===e.type||"greed"===e.type)&&null!==e.value){const a=l.getActualPlayer?l.getActualPlayer(e.player):e.player;t.has(a)&&t.get(a).push(e.value)}})});const s=l.players.map(e=>{const a=t.get(e)||[],s=a.length,o=a.reduce((e,l)=>e+l,0),n=s>0?o/s:0,i=s>0?Math.max(...a):0,r=s>0?Math.min(...a):0,u=l.getPlayerRole?l.getPlayerRole(e):void 0;return{name:e,value:n,min:r,max:i,count:s,role:u||"",formattedRole:u?Ae(u):""}}),o=s.map(e=>e.name),n=s.map(e=>e.value),i=new Map,r=new Map;return s.forEach(e=>{i.set(e.name,e.formattedRole),r.set(e.name,e)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0].name,a=r.get(l);if(!a)return"";let t=`${a.formattedRole?`[${a.formattedRole}] `:""}<b>${l}</b><br/>`;return 0===a.count?t+='<span style="color:#999">无数据</span>':(t+=`平均点数: <b>${a.value.toFixed(1)}</b><br/>`,t+=`最高点数: ${a.max}<br/>`,t+=`最低点数: ${a.min}<br/>`,t+=`Roll点次数: ${a.count}`),t}},grid:{left:"2%",right:"2%",bottom:"10%",top:"15%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=r.get(e)?.role;return qe(e,a,l.playerVisibility)},rich:Ke(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",min:0,max:100,name:"平均点数",splitLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"平均Roll点",type:"bar",barWidth:"50%",data:n,itemStyle:{color:e=>{const l=r.get(e.name);return Le(l?.role)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",formatter:e=>e.value>0?e.value.toFixed(1):"",color:a.value?"#f1f5f9":"#1e293b"},markLine:{data:[{type:"average",name:"平均"}],symbol:"none",lineStyle:{color:a.value?"rgba(255,255,255,0.4)":"#999",type:"dashed"},label:{position:"start",formatter:"{b}",color:a.value?"#94a3b8":"#64748b",padding:[0,8,0,0]}}}]}});return(e,l)=>(t(),s("div",Ya,[l[0]||(l[0]=v("div",{class:"chart-header"},[v("div",{class:"chart-title"}," Roll 点运气统计 ")],-1)),v("div",Ja,[c(m(rl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:m(a)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),[["__scopeId","data-v-45e92bca"]]),Ka={class:"chart-container"},qa=e(a({__name:"ChartWeeklyTrend",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup(e){const l=e,a=w({storageKey:"loot-history-theme"});il([ul,gl,dl,vl,hl,ml]);const n=u(()=>l.syncStartDate?Qe(new Date(l.syncStartDate)):null);const i=b(400),r=u(()=>{const e=new Map,a=new Map;l.records.forEach(t=>{const{label:s,sortKey:o}=function(e){const a=l.recordWeekCorrections?.[e.key]||0,{label:t}=Xe(e.timestamp,a),{label:s,index:o}=Ge(t,n.value);return{label:l.syncStartDate?`第 ${o} 周`:t,fullLabel:s,sortKey:o}}(t);e.set(s,o);const i=l.getActualPlayer?l.getActualPlayer(t.player):t.player;if(!l.players.includes(i))return;a.has(s)||a.set(s,new Map);const r=a.get(s);r.has(i)||r.set(i,{count:0,items:[]});const u=r.get(i);u.count++,u.items.push(t.item)});const t=Array.from(e.entries()).sort((e,l)=>e[1]-l[1]).map(e=>e[0]),s=[...l.players],o=[];t.forEach((e,l)=>{s.forEach((t,s)=>{const n=a.get(e)?.get(t),i=n?n.count:0;o.push({value:[s,l,i],items:n?n.items:[]})})});const i=40*t.length+120,r=Math.max(300,i);return{xData:s,sortedWeeks:t,seriesData:o,height:r}});_(()=>{i.value=r.value.height});const d=u(()=>{const e=l.playerVisibility,{xData:t,sortedWeeks:s,seriesData:o}=r.value,n=new Map;return l.players.forEach(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;a&&n.set(e,Ae(a))}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{position:"top",formatter:e=>{const l=e.data,a=l.value[2],o=t[l.value[0]],i=s[l.value[1]],r=o?n.get(o):void 0;return`<b>${i}</b><br/>\n                <b>${r?`[${r}]`:""} ${o}</b><br/>\n                获取数量: ${a}<br/>\n                <hr style="margin:4px 0;opacity:0.3"/>\n                ${l.items&&l.items.length>0?l.items.map(e=>`• ${e}`).join("<br/>"):'<span style="color:#94a3b8;font-style:italic">无掉落</span>'}`}},grid:{top:40,bottom:"2%",left:"2%",right:"2%"},xAxis:{position:"bottom",type:"category",data:t,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;return qe(e,a,l.playerVisibility)},rich:Ke(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"}},yAxis:{type:"category",data:s,inverse:!1,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:12,color:a.value?"#e2e8f0":"#64748b"}},visualMap:{min:0,max:8,calculable:!1,orient:"horizontal",right:0,top:0,itemWidth:15,itemHeight:15,type:"piecewise",pieces:[{value:0,color:a.value?"#1b1c26":"#f8fafc",label:"无"},{value:1,color:a.value?"#450a0a":"#fff7ed",label:"1"},{value:2,color:a.value?"#7f1d1d":"#ffedd5",label:"2"},{value:3,color:a.value?"#b91c1c":"#fed7aa",label:"3"},{value:4,color:a.value?"#c2410c":"#fdba74",label:"4"},{value:5,color:a.value?"#ea580c":"#f97316",label:"5"},{value:6,color:a.value?"#f97316":"#ea580c",label:"6"},{value:7,color:a.value?"#facc15":"#c2410c",label:"7"},{min:8,color:a.value?"#fef08a":"#9a3412",label:"8+"}],textStyle:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"每周获取",type:"heatmap",data:o,label:{show:!0,formatter:e=>e.value[2]>0?e.value[2]:"",color:"inherit"},itemStyle:{borderRadius:4,borderColor:a.value?"#252632":"#fff",borderWidth:2},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.4)"}}}]}});return(e,l)=>(t(),s("div",Ka,[l[0]||(l[0]=v("div",{class:"chart-header"},[v("div",{class:"chart-title"}," 每周获取热力图 ")],-1)),v("div",{class:"chart-body",style:o({height:`${i.value}px`})},[c(m(rl),{class:"echarts-instance",option:d.value,"update-options":{notMerge:!0},theme:m(a)?"dark":"",autoresize:""},null,8,["option","theme"])],4)]))}}),[["__scopeId","data-v-82fa3cc7"]]),Xa={class:"stats-panel"},Ga={class:"charts-grid"},Qa=e(a({__name:"LootStatisticsPanel",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup:e=>(l,a)=>(t(),s("div",Xa,[v("div",Ga,[c(Ia,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(Ha,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(qa,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"record-week-corrections":e.recordWeekCorrections,"sync-start-date":e.syncStartDate,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","record-week-corrections","sync-start-date","player-visibility"])])]))}),[["__scopeId","data-v-4166085a"]]),Za={class:"filter-segmented"},et=e(a({__name:"LootDisplayFilterSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function o(e){a("update:modelValue",e)}return(l,a)=>(t(),s("div",Za,[v("div",{class:n(["segment-item",{"is-active":"obtained"===e.modelValue}]),onClick:a[0]||(a[0]=e=>o("obtained"))}," 已获得 ",2),v("div",{class:n(["segment-item",{"is-active":"needed"===e.modelValue}]),onClick:a[1]||(a[1]=e=>o("needed"))}," 尚未获得 ",2),v("div",{class:n(["segment-item",{"is-active":"all"===e.modelValue}]),onClick:a[2]||(a[2]=e=>o("all"))}," 全部显示 ",2)]))}}),[["__scopeId","data-v-349b7683"]]),lt={class:"mr-content"},at={key:0,class:"mr-val"},tt=e(a({__name:"LootPlayerRoll",props:{roll:{},isWinner:{type:Boolean},showOnlyRole:{type:Boolean},getPlayerRole:{type:Function}},setup(e){const l=e,a=u(()=>l.getPlayerRole(l.roll.player)),o=u(()=>`type-${l.roll.type}`),d=u(()=>Ze(l.roll.type)),p=u(()=>"assign"!==l.roll.type&&"direct"!==l.roll.type),m=u(()=>"assign"===l.roll.type||"direct"===l.roll.type||"replace"===l.roll.type);return(l,u)=>(t(),s("div",{class:n(["mini-roll",[o.value,{"winner-badge":e.isWinner}]])},[c(bl,{name:e.roll.player,role:a.value,"show-only-role":e.showOnlyRole,class:"mr-display"},null,8,["name","role","show-only-role"]),v("div",lt,[v("span",{class:n(["mr-type",[o.value,{"type-full-width":m.value}]])},i(d.value),3),p.value&&"replace"!==e.roll.type?(t(),s("span",at,i(null!==e.roll.value?e.roll.value:"-"),1)):r("",!0)])],2))}}),[["__scopeId","data-v-a077e4c2"]]),st={class:"sort-segmented"},ot=e(a({__name:"LootSortSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function o(e){a("update:modelValue",e)}return(l,a)=>(t(),s("div",st,[v("div",{class:n(["segment-item",{"is-active":"part"===e.modelValue}]),onClick:a[0]||(a[0]=e=>o("part"))}," 按装备部位顺序 ",2),v("div",{class:n(["segment-item",{"is-active":"drop"===e.modelValue}]),onClick:a[1]||(a[1]=e=>o("drop"))}," 按零式掉落顺序 ",2)]))}}),[["__scopeId","data-v-65a13aa0"]]),nt={class:"summary-item-right"},it={key:0,class:"random-weapon-tag"},rt={key:0,class:"bis-tag"},ut={key:1,class:"non-bis-tag"},ct={key:2,class:"layer-tag"},dt=e(a({__name:"SummaryItemTags",props:{item:{}},setup:e=>(l,a)=>(t(),s("div",nt,[e.item.isRandomWeapon?(t(),s("span",it,"随武")):(t(),s(g,{key:1},[e.item.isBis?(t(),s("span",rt,"毕业")):!1===e.item.isBis?(t(),s("span",ut,"副职")):r("",!0)],64)),e.item.layerName?(t(),s("span",ct,i(e.item.layerName),1)):r("",!0),v("span",{class:n(["count-badge",[e.item.count>1?"count-many":0===e.item.count?"count-none":"count-single"]])}," x"+i(e.item.count),3)]))}),[["__scopeId","data-v-4f4332d7"]]);function vt(e){return new Worker("/ff14-overlay-vue/assets/logParser-yrLuWaSY.js",{name:e?.name})}const pt={key:0,class:"initial-loading"},mt={class:"skeleton-layout"},yt={class:"skeleton-page-main"},ft={class:"skeleton-content-grid"},gt={class:"theme-toggle-fixed"},ht={key:0,class:"loading-overlay"},kt={class:"loading-card-wide"},bt={class:"loading-header"},wt={class:"loading-title"},_t={class:"parsing-lists"},Ct={class:"list-col"},Vt={class:"list-head"},St={class:"list-body"},xt={class:"file-info-left"},Et=["title"],$t={class:"file-size"},Bt={class:"list-col"},Tt={class:"list-head"},Ot={class:"list-body"},Rt={class:"file-info-left"},Dt=["title"],zt={class:"file-size"},Mt={key:0,class:"more-hint"},Ut={key:0,class:"app-main",style:{"padding-top":"10px"}},Pt={class:"control-bar",style:{position:"relative"}},Lt={class:"path-toolbar"},At={key:0,class:"dot-warn"},jt={class:"sync-status-container"},Wt={class:"sync-hint-text is-success success-hint"},Nt={class:"guide-content-popover"},Ft={class:"guide-section"},It={class:"guide-section"},Yt={class:"guide-section"},Jt={class:"guide-section"},Ht={class:"filter-panel"},Kt={class:"filter-section"},qt={class:"sec-header"},Xt={class:"sec-title-group"},Gt={class:"title-main"},Qt={key:0,class:"dot-warn"},Zt={class:"role-settings-content-popover"},es={class:"role-grid"},ls={class:"role-setup-label"},as={class:"special-role-section"},ts={class:"special-role-group"},ss={class:"special-list"},os={key:0,class:"special-item"},ns={class:"special-role-group"},is={class:"special-list"},rs={key:0,class:"special-item"},us={class:"switch-box"},cs={class:"switch-container",style:{display:"inline-flex","align-items":"center",gap:"6px"}},ds={key:0,class:"header-sep"},vs={key:1,class:"switch-box"},ps={class:"acts"},ms={class:"popover-form"},ys={class:"merge-selector-box"},fs={class:"merge-guide-desc"},gs={class:"procedure-steps-compact"},hs={class:"selector-tags"},ks={key:0,class:"selection-badge hide"},bs={key:1,class:"selection-badge show"},ws={key:0,class:"merge-actions"},_s={key:0,class:"suggestion-box"},Cs={class:"suggest-items"},Vs={class:"conf-text"},Ss={key:1,class:"mapping-box"},xs={class:"mapping-list"},Es={class:"map-from"},$s={class:"map-to"},Bs={class:"sec-body",style:{position:"relative"}},Ts={key:0,class:"section-mask"},Os={class:"filter-section"},Rs={class:"sec-header"},Ds={class:"sec-title-group"},zs={class:"title-main"},Ms={class:"switch-box"},Us={class:"filter-popover"},Ps={class:"sec-body",style:{position:"relative"}},Ls={key:0,class:"section-mask"},As={class:"main-viewport",style:{position:"relative"}},js={class:"list-container-el"},Ws=["onClick","onContextmenu"],Ns={key:0,class:"week-correction-display"},Fs={class:"original-week"},Is={class:"corrected-week"},Ys={key:1,class:"col-week"},Js={class:"col-time"},Hs={class:"time-date"},Ks={class:"col-item"},qs={class:"item-text"},Xs=["onClick"],Gs={key:0,class:"correction-winner-display"},Qs={class:"original-row",title:"原始记录获得者"},Zs={class:"corrected-row"},eo={key:1,class:"no-winner"},lo={class:"col-rolls"},ao={class:"pagination-box"},to={class:"tabs-sort-control"},so={class:"summary-grid has-sort-control"},oo={class:"summary-header"},no=["title"],io={class:"tabs-sort-control"},ro={class:"summary-grid slot-grid has-sort-control"},uo={class:"summary-header"},co={class:"s-right-group"},vo={class:"tabs-sort-control"},po={class:"week-content-wrapper"},mo={class:"summary-header"},yo={class:"week-list-body"},fo=["onContextmenu","onClick","onMouseenter"],go={class:"week-row-aside"},ho={class:"week-row-main"},ko={class:"week-item-name"},bo={key:0,class:"week-list-divider"},wo={style:{display:"flex","align-items":"center",gap:"4px"}},_o={key:0,class:"dot-warn",style:{margin:"0"}},Co={key:1,class:"empty-placeholder"},Vo={class:"empty-icon"},So={class:"empty-hint"},xo={key:0,class:"winner-change-popover"},Eo={class:"popover-header"},$o={class:"select-player-row"},Bo={key:0,class:"custom-context-menu"},To={class:"menu-info-header"},Oo={class:"action-label"},Ro={key:1,class:"empty-container"},Do={class:"empty-placeholder compact-guide"},zo={key:0,class:"empty-guide-main",style:{position:"relative"}},Mo={class:"empty-info-side"},Uo={class:"empty-hint"},Po={class:"empty-desc"},Lo={class:"empty-highlight"},Ao={class:"setup-form"},jo={class:"setup-row"},Wo={class:"setup-row"},No={class:"empty-hint",style:{"margin-top":"24px"}},Fo={key:2,class:"ready-state-container",style:{position:"relative",width:"100%",display:"flex","flex-direction":"column","align-items":"center"}},Io={class:"empty-title"},Yo={class:"empty-desc"},Jo={class:"empty-hint"},Ho={key:0,class:"export-selection-list"},Ko={class:"dialog-footer"},qo={key:0,class:"import-preview-box"},Xo={class:"import-selection-list"},Go={key:0,class:"import-not-found-hint"},Qo={key:1,class:"import-identical-hint"},Zo={key:0,class:"import-not-found-hint"},en={key:1,class:"import-identical-hint"},ln={key:0,class:"import-not-found-hint"},an={key:1,class:"import-identical-hint"},tn={key:0,class:"import-not-found-hint"},sn={key:1,class:"import-identical-hint"},on={key:0,class:"import-not-found-hint"},nn={key:1,class:"import-identical-hint"},rn={key:0,class:"import-not-found-hint"},un={key:1,class:"import-identical-hint"},cn={key:0,class:"import-not-found-hint"},dn={key:1,class:"import-identical-hint"},vn={key:0,class:"import-warning-info"},pn={key:1,class:"import-success-info"},mn={class:"dialog-footer"},yn={key:0,class:"clear-selection-list"},fn={class:"clear-selection-header"},gn={class:"clear-quick-actions"},hn={class:"clear-danger-hint"},kn={class:"dialog-footer"},bn={class:"dialog-footer"},wn={key:0,class:"premium-correction-layout"},_n={class:"correction-sidebar"},Cn={class:"nav-icon"},Vn={class:"nav-content"},Sn={class:"nav-status"},xn={class:"nav-icon"},En={class:"nav-content"},$n={class:"nav-status"},Bn={class:"sidebar-footer"},Tn={class:"correction-main"},On={class:"main-header"},Rn={class:"correction-grid-wrapper scroll-thin"},Dn={class:"card-main-row"},zn={class:"item-primary-info"},Mn=["title"],Un={class:"item-time"},Pn={class:"card-comparison-inline"},Ln={class:"comp-box old"},An={class:"value"},jn={key:1,class:"week-text"},Wn={class:"comp-arrow"},Nn={class:"comp-box new"},Fn={class:"value"},In={key:1,class:"week-text"},Yn={class:"card-actions"},Jn={key:0,class:"premium-empty"},Hn="需在左上方“固定队 - 职位设置”中完成所有职位后方可开启",Kn=e(a({__name:"lootHistory",setup(e){const a="2026-01-06T16:00",w="总冠军",_="装备掉落/拿装备记录",J="固定队成员",K="毕业装备需求 (BIS)",X="角色合并映射",G="手动修改过的CD周数",Le="手动修改过的装备获得者",Ae="过滤和排序偏好",We=al("loot-history-records"),Ne=al("loot-history-config"),Ye=al("loot-history-handle"),Ke=b(!0),qe=b(!1),Ze=b(!1),il=b(0),rl=b([]),ul=b([]),cl=T([]),dl=b(new Set),vl=b(new Set),pl=b({}),ml=b("summary"),yl=b(null),fl=b(!1),gl=b(!1),hl=b(!1),wl=b({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),_l=b({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),Cl=b({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),Vl=b(null),Sl=b({timestamp:"",item:"",player:""}),xl=b(!1),El=b({loot:!0,bis:!1,roles:!1,mapping:!1,weekCorrection:!1,playerCorrection:!1,settings:!1}),$l=b(!1),Bl=b({}),Tl=b({}),Ol=b({}),Rl=b(null),Dl=b(),zl=b({}),Ml=b(null),Ul=b(""),Pl=b(!1),Ll=b(!1),Al=b(""),jl=b("player"),Wl=b({playerBis:{}}),Nl=u(()=>{if(!Ll.value)return[];const e=[],l=new Map(cl.value.map(e=>[e.key,e]));if(Object.entries(Ol.value).forEach(([a,t])=>{const s=l.get(a);s&&e.push({key:a,type:"player",itemName:s.item,oldVal:s.player,newVal:t,record:s})}),!Al.value)return e;const a=Al.value.toLowerCase();return e.filter(e=>e.itemName.toLowerCase().includes(a)||e.oldVal.toString().toLowerCase().includes(a)||e.newVal.toString().toLowerCase().includes(a))}),Fl=u(()=>{if(!Ll.value)return[];const e=[],l=new Map(cl.value.map(e=>[e.key,e]));if(Object.entries(Tl.value).forEach(([t,s])=>{const o=l.get(t);if(!o)return;const n=tl(o.timestamp,a),i=n+s;e.push({key:t,type:"week",itemName:o.item,oldVal:`第 ${n} 周`,newVal:`第 ${i} 周`,record:o})}),!Al.value)return e;const t=Al.value.toLowerCase();return e.filter(e=>e.itemName.toLowerCase().includes(t)||e.oldVal.toString().toLowerCase().includes(t)||e.newVal.toString().toLowerCase().includes(t))});const Il=b("part"),Yl=b("part"),Jl=b("drop"),Hl=b("part"),Kl=b({});function ql(e){return Kl.value&&Kl.value[e]||e}function Xl(e){return Ol.value[e.key]||e.player}const Gl=b([]);function Ql(){2===Gl.value.length&&(la(Gl.value[0],Gl.value[1]),Gl.value=[])}const Zl=b("obtained"),ea=b("obtained");function la(e,l){e&&l&&(Kl.value={...Kl.value,[e]:l})}const aa=b(1),ta=b(""),sa=b(""),oa=b(!1),na=b({}),ia=b(a),ra=b(null),ua=b(!1),ca=b(!1),da=b(!1),va=["御敌","制敌","精准","治愈","强攻","强袭","游击","咏咒"].join("|"),pa=new RegExp(`${w}武器箱|${w}(?!${va})|规格神典石|强化药|硬化药|强化纤维|神典石`),ma=new RegExp(`(?<series>.+)(${va}).+`),ya=b(!1),fa=b(!1),ga=b(!1),ha=b(!0),ka=b({cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]}),ba=b({});let wa=!1;const _a=(()=>{let e=null;return l=>{e&&clearTimeout(e),e=setTimeout(()=>{Ne.bulkSet(l)},500)}})(),Ca=new Map;d([pl,Bl,ta,na,ia,ra,ml,ua,Wl,Kl,ba,ya,fa,ga,ka,da,Tl,Ol,Il,Yl,Jl,Hl,vl,ha,Zl,ea],()=>{const e=[{key:"itemVisibility",value:pl.value},{key:"playerVisibility",value:Bl.value},{key:"weekCorrections",value:Tl.value},{key:"playerCorrections",value:Ol.value},{key:"logPath",value:ta.value},{key:"processedFiles",value:na.value},{key:"syncStartDate",value:ia.value},{key:"syncEndDate",value:ra.value},{key:"viewMode",value:ml.value},{key:"isRaidFilterActive",value:ua.value},{key:"bisConfig",value:Wl.value},{key:"hideUnselectedItems",value:fa.value},{key:"hideUnselectedPlayers",value:ga.value},{key:"playerMapping",value:Kl.value},{key:"playerRoles",value:ba.value},{key:"showOnlyRole",value:ya.value},{key:"isOnlyRaidMembersActive",value:da.value},{key:"systemFilterSettings",value:ka.value},{key:"summarySortMode",value:Il.value},{key:"slotSortMode",value:Yl.value},{key:"weekSortMode",value:Jl.value},{key:"bisSortMode",value:Hl.value},{key:"playerSummaryFilterMode",value:Zl.value},{key:"slotSummaryFilterMode",value:ea.value},{key:"hideEmptyPlayers",value:ha.value},{key:"blacklistedKeys",value:Array.from(vl.value)}],l=[];for(const{key:a,value:t}of e){const e="object"==typeof t?JSON.stringify(t):String(t);Ca.get(a)!==e&&(l.push({key:a,value:"object"==typeof t?JSON.parse(e):t}),Ca.set(a,e))}l.length>0&&_a(l)},{deep:!0}),d([ia,ra],()=>{Ke.value||(ca.value=!0,gi())});const Va=b(!1),Sa=u(()=>{const e={};return cl.value.forEach(l=>{const a=ql(Xl(l));e[a]=(e[a]||0)+1}),e}),xa=u(()=>{if(Ke.value)return[];const e=new Set;return cl.value.forEach(l=>{e.add(ql(Xl(l))),l.rolls.forEach(l=>e.add(ql(l.player)))}),Object.values(ba.value).forEach(l=>{l&&e.add(ql(l))}),Array.from(e).sort((e,l)=>Si(e,l,Sa.value))}),Ea=u(()=>{if(Ke.value)return[];const e=new Date(ia.value).getTime(),l=ra.value?new Date(ra.value).getTime():1/0,a=pl.value,t=Bl.value;return cl.value.filter(s=>{if(ki(s.item))return!1;const o=ql(Xl(s));if(!1===t[o])return!1;if(!1===a[s.item])return!1;const n=s.timestamp.getTime();return!(n<e||n>l)}).sort((e,l)=>l.timestamp.getTime()-e.timestamp.getTime())}),$a=u(()=>{if(Ke.value)return{};const e={};return Ea.value.forEach(l=>{const a=ql(Xl(l)),t=l.item;e[a]||(e[a]={}),e[a][t]||(e[a][t]=0),e[a][t]++}),e}),Ba=u(()=>{if(Ke.value)return[];const e=new Set(cl.value.filter(e=>!ki(e.item)).map(e=>e.item));return Array.from(e).sort((e,l)=>{const a=Kn(e),t=Kn(l);return a!==t?a-t:e.localeCompare(l)})}),Ta=u(()=>{const e=new Set,l={};Ea.value.forEach(e=>{const{label:a}=Xe(e.timestamp);l[a]||(l[a]=[]),l[a].push(e)});for(const a in l){const t=l[a],s={};t.forEach(e=>{s[e.item]||(s[e.item]=[]),s[e.item].push(e)});const o=[];for(const e in s){const l=s[e];if(l.length>1){l.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime());for(let e=0;e<l.length-1;e++){const a=l[e];l[e+1].timestamp.getTime()-a.timestamp.getTime()>3e5&&o.push(a.timestamp.getTime())}}}t.forEach(l=>{if(!pa.test(l.item))return;const a=l.timestamp,t=a.getDay(),s=a.getHours();if(2!==t)return;if(s<16||s>=19)return;const n=l.timestamp.getTime();o.some(e=>Math.abs(n-e)<=3e5)&&e.add(l.key)})}return e}),Oa=u(()=>Fe.every(e=>!!ba.value[e])),Ra=u(()=>{const e=new Set,l=new Date(ia.value).getTime(),a=ra.value?new Date(ra.value).getTime():1/0;return cl.value.forEach(t=>{if(ki(t.item))return;if(!1===pl.value[t.item])return;const s=t.timestamp.getTime();s<l||s>a||e.add(ql(Xl(t)))}),e}),Da=u(()=>{let e=xa.value;return da.value?e=e.filter(e=>!!Bi(e)):ga.value&&(e=e.filter(e=>wi(e))),ha.value&&!da.value&&(e=e.filter(e=>Ra.value.has(e))),e});function za(){"visible"===document.visibilityState&&cl.value.length>0&&gi()}C(async()=>{Ke.value=!0;try{const[e,l,a]=await Promise.all([We.getAll(),Ne.getAll(),Ye.get("current-log-dir")]);let t=!1;const s=e.map(e=>{const l=el(e.item),a=ll(e.player),s=e.rolls.map(e=>({...e,player:ll(e.player)}));return(l!==e.item||a!==e.player||JSON.stringify(s)!==JSON.stringify(e.rolls))&&(t=!0),{...e,item:l,player:a,rolls:s,timestamp:new Date(e.timestamp)}});if(t&&await We.bulkSet(JSON.parse(JSON.stringify(s))),l.forEach(e=>{"itemVisibility"===e.key&&(pl.value=e.value),"playerVisibility"===e.key&&(Bl.value=e.value),"logPath"===e.key&&(ta.value=e.value),"processedFiles"===e.key&&(na.value=e.value||{}),"weekCorrections"===e.key&&(Tl.value=e.value||{}),"playerCorrections"===e.key&&(Ol.value=e.value||{}),"syncStartDate"===e.key&&e.value&&(ia.value=e.value),"syncEndDate"===e.key&&(ra.value=e.value||null),"viewMode"===e.key&&(ml.value=e.value),"hideUnselectedItems"===e.key&&(fa.value=!!e.value),"hideUnselectedPlayers"===e.key&&(ga.value=!!e.value),"playerMapping"===e.key&&(Kl.value=e.value||{}),"playerRoles"===e.key&&(ba.value=e.value||{}),"showOnlyRole"===e.key&&(ya.value=!!e.value),"systemFilterSettings"===e.key&&e.value&&(ka.value={...ka.value,...e.value}),"isRaidFilterActive"===e.key&&(ua.value=!!e.value),"isOnlyRaidMembersActive"===e.key&&(da.value=!!e.value),"summarySortMode"===e.key&&(Il.value=e.value||"part"),"slotSortMode"===e.key&&(Yl.value=e.value||"part"),"weekSortMode"===e.key&&(Jl.value=e.value||"drop"),"bisSortMode"===e.key&&(Hl.value=e.value||"part"),"blacklistedKeys"===e.key&&(vl.value=new Set(e.value||[])),"bisConfig"===e.key&&(Wl.value=e.value||{playerBis:{}}),"playerSummaryFilterMode"===e.key&&(Zl.value=e.value||"obtained"),"slotSummaryFilterMode"===e.key&&(ea.value=e.value||"obtained")}),a&&a.handle){yl.value=a.handle,sa.value=a.handle.name;"granted"===await a.handle.queryPermission({mode:"read"})?wa=!0:ta.value="未授权，请点击同步按钮"}cl.value=s,dl.value=new Set(s.map(e=>e.key)),Oa.value||"list"===ml.value||(ml.value="list"),window.addEventListener("paste",Ka),document.body.addEventListener("dragover",Ia),document.body.addEventListener("dragleave",Ya),document.body.addEventListener("drop",Ja),window.addEventListener("click",qa),window.addEventListener("keydown",st),window.addEventListener("click",Fa),window.addEventListener("visibilitychange",za),cl.value.length>0&&setTimeout(()=>{gi()},300),await V(),setTimeout(()=>{Ke.value=!1},50)}catch(e){Ke.value=!1}});const Ma=b(!1),Ua=b(!1);let Pa=null;const La=b(!1),Aa=b(),ja=b("");function Na(){La.value=!1}function Fa(e){if(Rl.value){const l=document.querySelector(".winner-change-popper"),a=l?.contains(e.target),t=e.target.closest(".winner-selector-trigger");a||t||(Rl.value=null)}}function Ia(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer?.types.includes("Files")&&(Ma.value=!0,Pa&&(clearTimeout(Pa),Pa=null))}function Ya(e){e.preventDefault(),Pa&&clearTimeout(Pa),Pa=setTimeout(()=>{Ma.value=!1,Ua.value=!1},100)}function Ja(e){if(e.preventDefault(),e.stopPropagation(),Ma.value=!1,Ua.value=!1,Pa&&(clearTimeout(Pa),Pa=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Fi(l)}}function Ha(e){if(e.preventDefault(),e.stopPropagation(),Ma.value=!1,Ua.value=!1,Pa&&(clearTimeout(Pa),Pa=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Fi(l)}}async function Ka(e){const l=e.clipboardData?.getData("text");if(l)try{if(!l.trim().startsWith("{"))return;const a=JSON.parse(l);a.r&&Array.isArray(a.r)&&(e.preventDefault(),await Wi(a))}catch{}}function qa(){Va.value=!1}S(()=>{window.removeEventListener("paste",Ka),document.body.removeEventListener("dragover",Ia),document.body.removeEventListener("dragleave",Ya),document.body.removeEventListener("drop",Ja),window.removeEventListener("click",qa),window.removeEventListener("keydown",st),window.removeEventListener("visibilitychange",za),window.removeEventListener("click",Fa)});const Xa=u(()=>{if(Ke.value||!qe.value||0===cl.value.length)return new Map;const e=new Map;return cl.value.forEach(l=>{const a=new Set([l.player,...l.rolls.map(e=>e.player)]);a.forEach(l=>{e.has(l)||e.set(l,new Set);const t=e.get(l);a.forEach(e=>{e!==l&&t.add(e)})})}),e}),Ga=u(()=>{if(Ke.value||!qe.value||0===Xa.value.size)return[];const e=[],l=Array.from(Xa.value.keys());for(let a=0;a<l.length;a++)for(let t=a+1;t<l.length;t++){const s=l[a],o=l[t];if(ql(s)===ql(o))continue;const n=Xa.value.get(s),i=Xa.value.get(o);if(n.size<3||i.size<3)continue;const r=new Set([...n].filter(e=>i.has(e))),u=new Set([...n,...i]),c=r.size/u.size;c>.9&&e.push({from:s,to:o,confidence:Math.round(100*c)})}return e.sort((e,l)=>l.confidence-e.confidence).slice(0,5)}),Za=u(()=>{const e=new Set;return cl.value.forEach(l=>{if(pa.test(l.item))return;const a=l.item.match(ma);a?.groups?.series&&e.add(a.groups.series)}),Array.from(e).sort()}),lt=u(()=>new Set(Object.values(ba.value))),at=u(()=>!!Oa.value&&Fe.every(e=>je(Wl.value,e)));function st(e){const l=e.target,a=["INPUT","TEXTAREA"].includes(l.tagName)||l.isContentEditable;if("Escape"===e.key){if(Rl.value)return void(Rl.value=null);if(Va.value)return void(Va.value=!1);if(fl.value)return void(fl.value=!1);if(gl.value)return void(gl.value=!1);if(hl.value)return void(hl.value=!1);if(xl.value)return void(xl.value=!1);if($l.value)return void($l.value=!1)}a||e.ctrlKey||e.altKey||e.metaKey||e.shiftKey||("1"===e.key?ml.value="list":Oa.value&&("2"===e.key&&(ml.value="summary"),"3"===e.key&&(ml.value="slot"),"4"===e.key&&(ml.value="week"),"5"===e.key&&(ml.value="chart"),"6"===e.key&&(ml.value="bis")))}const nt=u(()=>{const e=new Set;cl.value.forEach(l=>{e.add(ql(l.player))});const l=new Set;cl.value.forEach(e=>{l.add(e.player),e.rolls.forEach(e=>l.add(e.player))});const a=new Set(Object.keys(Kl.value));return Array.from(l).filter(e=>{if(a.has(e))return!1;return wi(ql(e))}).sort((e,l)=>Si(e,l,Sa.value))}),it=u(()=>{let e=Da.value;"needed"===Zl.value&&(e=e.filter(e=>{const l=Bi(e);return l&&!l.startsWith("LEFT:")&&!l.startsWith("SUB:")}));const l=$a.value,a={};return e.forEach(e=>{a[e]=Object.values(l[e]||{}).reduce((e,l)=>e+l,0)}),[...e].sort((e,l)=>Si(e,l,a))}),rt=u(()=>ha.value?xa.value.filter(e=>Ra.value.has(e)):xa.value),ut=u(()=>fa.value?Ba.value.filter(bi):Ba.value);d([ua,Ba],([e])=>{e?(!function(){const e={};Ba.value.forEach(l=>{e[l]=pa.test(l)}),pl.value=e,0===Xn.value&&(l=!0,xa.value.forEach(e=>Bl.value[e]=l));var l}(),fa.value=!0):fa.value=!1},{immediate:!0}),d(Oa,e=>{!e&&da.value&&(da.value=!1),e||(ml.value="list")});const ct=He;function Kn(e,l="part"){const a=("part"===l?He:ol).findIndex(l=>e.includes(l)||l.includes(e));return-1!==a?a:pa.test(e)?50:100}const qn=u(()=>ut.value.length),Xn=u(()=>Da.value.length),Gn=u(()=>Ea.value.map(e=>({...e,player:Xl(e)})));const Qn=u(()=>{if(Ke.value)return{};const e={};return ct.forEach(l=>{e[l]={}}),Ea.value.forEach(l=>{let a=(t=l.item,ct.find(e=>t.includes(e))||"其他");var t;"其他"===a&&(a=l.item),e[a]||(e[a]={});const s=e[a],o=ql(Xl(l));s[o]||(s[o]=0),s[o]++}),e}),Zn=u(()=>{const e=ea.value;return[...("part"===Yl.value?He:ol).filter(l=>{if("all"===e)return!0;if(Qn.value[l]&&Object.keys(Qn.value[l]).length>0)return!0;if("needed"===e){const e=Ie.find(e=>e.name===l||e.keywords===l);if(!e)return!1;return Object.keys(ba.value).filter(e=>!e.startsWith("LEFT:")&&!e.startsWith("SUB:")).some(l=>{const a=ba.value[l];if(!a)return!1;const t=$a.value[a]||{};return nl(e,t)<Ci(e,a)})}return!1}),...Object.keys(Qn.value).filter(e=>!He.includes(e)&&!ol.includes(e)).filter(e=>Object.keys(Qn.value[e]||{}).length>0).sort((e,l)=>{const a=e=>Object.values(Qn.value[e]||{}).reduce((e,l)=>e+l,0),t=a(e),s=a(l);return t!==s?s-t:e.localeCompare(l)})]});const ei=u(()=>Qe(new Date(a)));function li(e){const{label:l}=Ge(e,ei.value);return l}const ai=u(()=>{const e={};Ea.value.forEach(l=>{const t=function(e){const l=Tl.value[e.key]||0;return Xe(e.timestamp,l,a).label}(l);e[t]||(e[t]={});const s=ql(Xl(l));e[t][s]||(e[t][s]=[]),e[t][s].push(l)});for(const l in e)for(const a in e[l]){const t=e[l][a];t&&t.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime())}return e}),ti=u(()=>Object.keys(ai.value).sort().reverse());function si(e){const l=ai.value[e];if(!l)return[];const a=[];return Object.values(l).forEach(e=>{a.push(...e)}),a.sort((e,l)=>{const a=Kn(e.item,Jl.value),t=Kn(l.item,Jl.value);if(a!==t)return a-t;const s=Si(e.player,l.player);return 0!==s?s:e.timestamp.getTime()-l.timestamp.getTime()})}function oi(e){const l=Kn(e,Jl.value);return"drop"===Jl.value?l<=3?1:l<=8?2:l<=12?3:4:0===l?1:l<=5?2:l<=9?3:4}function ni(e,l){if(l>=e.length-1)return!1;const a=e[l],t=e[l+1];if(!a||!t)return!1;return oi(a.item)!==oi(t.item)}const ii=b(null),ri=b({x:0,y:0}),ui={getBoundingClientRect:()=>({width:0,height:0,top:ri.value.y,bottom:ri.value.y,left:ri.value.x,right:ri.value.x})};function ci(e,l){e.preventDefault(),e.stopPropagation(),ii.value=l,ri.value={x:e.clientX,y:e.clientY},Va.value=!0}function di(){ii.value&&function(e){const l=Tl.value[e.key]||0,a={...Tl.value};l<0?delete a[e.key]:a[e.key]=-1,Tl.value=a}(ii.value),Va.value=!1}d(()=>Rl.value,e=>{e||(Dl.value=null)});const vi=u(()=>{const e=50*(aa.value-1);return Ea.value.slice(e,e+50)});function pi(){pl.value={},Bl.value={},ua.value=!1,ia.value=a,ra.value=null}async function mi(){try{const e=window.showDirectoryPicker;if(!e)return void le.alert("你的浏览器不支持此功能","错误",{confirmButtonText:"确定",type:"error"});const l=await e();l&&(await We.clear(),await Ne.set({key:"processedFiles",value:{}}),na.value={},Tl.value={},cl.value=[],dl.value.clear(),pl.value={},Bl.value={},await Ye.set({key:"current-log-dir",handle:l}),yl.value=l,ta.value=l.name,sa.value=l.name,$l.value=!0)}catch(e){e.name}}async function yi(e,l=!1){try{const a=cl.value.findIndex(l=>l.key===e.key);-1!==a&&cl.value.splice(a,1),await We.remove(e.key),dl.value.delete(e.key),vl.value.add(e.key),l||ee.success("记录已永久删除")}catch(a){l||ee.error("删除失败")}}async function fi(){$l.value=!1,await gi(!0)}async function gi(e=!1){if(oa.value||!yl.value)return;ca.value=!1;const l=yl.value;if(!wa){if("granted"!==await l.queryPermission({mode:"read"})){if(!e)return void(ca.value=!0);if("granted"!==await l.requestPermission({mode:"read"}))return}wa=!0}oa.value=!0;const a=0===dl.value.size;a&&(Ze.value=!0),il.value=0;try{const t=new Date(ia.value).getTime(),s=ra.value?new Date(ra.value).getTime():1/0,o=[],n=new Set(dl.value),i=[],r=new Set,u=new Set;for await(const e of l.values())if("file"===e.kind&&e.name.toLowerCase().endsWith(".log")){const l=e.name,a=l.match(/_(\d{8})(?:\.|_)/);if(a&&a[1]){const e=`${a[1].slice(0,4)}-${a[1].slice(4,6)}-${a[1].slice(6,8)} 00:00:00`,l=new Date(e).getTime();if(l+864e5<t||l>s)continue}const n=await e.getFile();if(n.size<10)continue;if(!a&&(n.lastModified<t||n.lastModified>s))continue;const i=na.value[l];let r=0;if(i){if(n.size===i.size&&n.lastModified<=i.mtime)continue;n.size>i.size&&(r=i.size)}o.push({handle:e,name:l,size:n.size,startByte:r})}if(0===o.length)return oa.value=!1,Ze.value=!1,Ul.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),void(e&&(Pl.value=!0,setTimeout(()=>{Pl.value=!1},800)));o.sort((e,l)=>e.name.localeCompare(l.name));const c=10;rl.value=[],ul.value=o.map(e=>({name:e.name,size:e.size-e.startByte}));let d=0;for(let e=0;e<o.length;e+=c){const l=o.slice(e,e+c).map(async e=>{const l=await e.handle.getFile(),a=await l.slice(e.startByte).text(),{records:t,players:s,items:c}=await hi(a);for(const o of t)n.has(o.key)||vl.value.has(o.key)||(n.add(o.key),i.push(o));s.forEach(e=>r.add(e)),c.forEach(e=>u.add(e)),na.value[e.name]={size:l.size,mtime:l.lastModified},d++,il.value=Math.round(d/o.length*100),rl.value.push({name:e.name,size:e.size}),rl.value.sort((e,l)=>e.name.localeCompare(l.name)),ul.value=ul.value.filter(l=>l.name!==e.name)});await Promise.all(l),await new Promise(e=>setTimeout(e,0))}if(i.length>0){await We.bulkSet(JSON.parse(JSON.stringify(i))),cl.value=[...cl.value,...i],dl.value=n,Oi(i,"sync");let e=!1;const l={...pl.value},t={...Bl.value};if(u.forEach(a=>{void 0===l[a]&&(l[a]=!0,e=!0)}),r.forEach(l=>{void 0===t[l]&&(t[l]=!0,e=!0)}),e&&(pl.value=l,Bl.value=t),a||ee.success({message:`同步完成，新增 ${i.length} 条记录`,showClose:!0}),a){new Set(cl.value.filter(e=>pa.test(e.item)).map(e=>e.item)).size>=12&&(ua.value=!0),Oa.value||ee.warning({message:"解析成功，请先在「固定队 - 职位设置」中完成所有职位的设置，以开启更多功能。",duration:1e4,showClose:!0})}}Ul.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e&&(Pl.value=!0,setTimeout(()=>{Pl.value=!1},800)),ta.value=yl.value.name}catch(t){}finally{oa.value=!1,Ze.value=!1,il.value=0}}function hi(e){return new Promise((l,a)=>{const t=new vt;t.onmessage=e=>{l(e.data),t.terminate()},t.onerror=e=>{a(e),t.terminate()},t.postMessage(e)})}function ki(e){if(ka.value.cards&&e.startsWith("九宫幻卡"))return!0;if(ka.value.materia&&e.includes("魔晶石"))return!0;if(ka.value.music&&(e.startsWith("管弦乐琴乐谱")||e.startsWith("陈旧的乐谱")))return!0;if(ka.value.book&&e.endsWith("断章"))return!0;if(ka.value.totem&&e.endsWith("图腾"))return!0;if(ka.value.other&&e.includes("经验值"))return!0;if(!pa.test(e)){const l=e.match(ma);if(l?.groups?.series&&ka.value.maskedSeries?.includes(l.groups.series))return!0}return!1}function bi(e){return ua.value?pa.test(e):!1!==pl.value[e]}function wi(e){return da.value?!!Bi(e):!1!==Bl.value[e]}function _i(e,l){e.ctrlKey?Ri(l):e.altKey?Ji("item",l):ua.value||function(e){const l=!1!==pl.value[e];pl.value[e]=!l}(l)}function Ci(e,l){const a=Bi(l);if(!a)return 0;const t=(Wl.value.playerBis||{})[a]||{};if("count"===e.type&&0===t[e.id])return 0;if(sl(e,t))return"count"===e.type?t[e.id]||0:1;const s="toggle"===e.type&&"weapon"!==e.id,o="twine"===e.id||"coating"===e.id||"solvent"===e.id||"tome"===e.id;return s||o?1:0}function Vi(e,l){if(!e)return;if(Object.entries(ba.value).some(([a,t])=>a.startsWith(`${l}:`)&&t===e))return;let a=1,t=`${l}:${a}`;for(;ba.value[t];)a++,t=`${l}:${a}`;ba.value[t]=e}function Si(e,l,a){const t=Bi(e),s=Bi(l),o=e=>e?Fe.includes(e)?Fe.indexOf(e):e.startsWith("SUB:")?100:e.startsWith("LEFT:")?200:500:999,n=o(t),i=o(s);if(n!==i)return n-i;const r=a||Sa.value,u=r[e]||0,c=r[l]||0;return u!==c?c-u:e.localeCompare(l)}function xi(e,l){const a=ea.value,t=Ie.find(e=>e.name===l||e.keywords===l);if(!t)return Object.keys(e||{}).sort((l,a)=>Si(l,a,e||{}));const s=Object.entries(ba.value).filter(([e,l])=>l&&!e.startsWith("LEFT:")).map(([e,l])=>l),o=Array.from(new Set([...Object.keys(e||{}),...s])),n=[];return o.forEach(l=>{const o=Bi(l),i=o?.startsWith("LEFT:")||o?.startsWith("SUB:");if("needed"===a&&i)return;const r=e?.[l]||0,u=Ci(t,l);"all"===a?(r>0||s.includes(l))&&n.push(l):"obtained"===a?r>0&&n.push(l):"needed"===a&&!i&&r<u&&n.push(l)}),n.sort((l,a)=>Si(l,a,e||{}))}function Ei(e,l,a){const t=Ie.find(e=>e.name===l||e.keywords===l);if(!t){const e=l.startsWith(w)&&pa.test(l);return{count:a,isRandomWeapon:e,layerName:e?"4层":void 0}}const s=Bi(e);if(!(s&&Fe.includes(s)))return{count:a,layerName:Je.find(e=>e.items.includes(t.id))?.name};const o=(Wl.value.playerBis||{})[s]||{},n=void 0!==o[t.id],i=Ci(t,e),r=sl(t,o),u=Je.find(e=>e.items.includes(t.id));return{count:a,isBis:n?r:void 0,isBisFalse:!r&&i>0,layerName:u?.name}}function $i(e){const l=$a.value[e]||{},a={},t=new Set;Ie.forEach(e=>{a[e.id]=0,Object.entries(l).forEach(([l,s])=>{const o=s||0;l.includes(e.keywords)&&(a[e.id]=(a[e.id]||0)+o,t.add(l))})});const s=[],o=Bi(e),n=!(!o||!Fe.includes(o)),i=(Wl.value?.playerBis||{})[o||""]||{};Ie.forEach(l=>{const t=a[l.id],o=Ci(l,e);let r=!1;const u=t||0;if(("all"===Zl.value||u>0||"needed"===Zl.value&&u<o)&&(r=!0),r){const e=Je.find(e=>e.items.includes(l.id));s.push({name:l.keywords||l.name,count:u,isBis:n&&void 0!==i[l.id]?o>0:void 0,id:l.id,layerName:e?e.name:void 0})}});const r=je(Wl.value,Bi(e)||e);Object.entries(l).forEach(([e,l])=>{if(!t.has(e)){const a=e.startsWith(w)&&pa.test(e);s.push({name:e,count:l,isRandomWeapon:a,isBis:(a||!n||!r)&&void 0,layerName:a?"4层":void 0})}});const u=Il.value;return s.sort((e,l)=>{const a=Kn(e.id&&Ie.find(l=>l.id===e.id)?.keywords||e.name,u),t=Kn(l.id&&Ie.find(e=>e.id===l.id)?.keywords||l.name,u);return a!==t?a-t:e.name.localeCompare(l.name)}),"obtained"===Zl.value?s.filter(e=>e.count>0):"needed"===Zl.value?s.filter(e=>0===e.count):s}function Bi(e){for(const[l,a]of Object.entries(ba.value))if(a===e)return l}function Ti(e,l){var a;e.ctrlKey?Ri(l):e.altKey?Ji("player",l):da.value||(a=l,Bl.value[a]=!(!1!==Bl.value[a]))}async function Oi(e,l){const a=function(e){const l=cl.value.filter(e=>e.isManual);if(0===l.length)return[];const a=[],t=new Map;return e.forEach(e=>{if(e.isManual)return;const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`;t.has(l)||t.set(l,new Set),t.get(l).add(ql(e.player))}),l.forEach(e=>{const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`,s=t.get(l);s&&s.has(ql(e.player))&&a.push(e)}),a}(e);if(0===a.length)return;const t="sync"===l?"同步的日志":"导入的数据";try{await le.confirm(`在${t}中发现了 ${a.length} 条与现有手动记录重合的数据（同日期、同玩家、同物品）。<br/><br/>是否删除这些手动记录，以真实的解析数据为准？`,"发现重复记录",{confirmButtonText:"删除手动记录",cancelButtonText:"全部保留",type:"info",dangerouslyUseHTMLString:!0});for(const e of a)await yi(e,!0);ee.success(`已清理 ${a.length} 条手动记录`)}catch{}}async function Ri(e){try{await navigator.clipboard.writeText(e),ee.success({message:`已复制: ${e}`,duration:1500,showClose:!0})}catch(l){ee.error({message:"复制失败",showClose:!0})}}function Di(){Sl.value={timestamp:(new Date).toISOString(),item:"",player:""},fl.value=!0}function zi(e,l){l(Array.from(Ba.value).filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}function Mi(e,l){l(xa.value.filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}async function Ui(){const e=Sl.value.item.trim(),l=Sl.value.player.trim();if(!Sl.value.timestamp||!e||!l)return void ee.error("请填写完整信息");const a=!Ba.value.includes(e),t=!xa.value.includes(l);if(a||t){let s="";s=a&&t?`物品 "<b>${e}</b>" 和 玩家 "<b>${l}</b>" 都是第一次出现。`:a?`物品 "<b>${e}</b>" 是第一次出现。`:`玩家 "<b>${l}</b>" 是第一次出现。`;try{await le.confirm(`${s}<br/><br/>确定要以此名称创建记录吗？请检查是否有错别字。`,"发现新条目",{confirmButtonText:"确定创建",cancelButtonText:"返回修改",type:"warning",dangerouslyUseHTMLString:!0})}catch{return}}const s=new Date(Sl.value.timestamp),o={key:`manual-${s.getTime()}-${Math.random().toString(36).slice(2)}`,timestamp:s,item:e,player:l,rolls:[],isManual:!0};await We.set(JSON.parse(JSON.stringify(o))),void 0===pl.value[o.item]&&(pl.value[o.item]=!0),void 0===Bl.value[ql(o.player)]&&(Bl.value[ql(o.player)]=!0),cl.value=[...cl.value,o],fl.value=!1,ee.success({message:`已添加: ${o.item} - ${o.player}`,showClose:!0})}const Pi=b(null);function Li(e){"clear"===e?(El.value={loot:!0,bis:!1,roles:!1,mapping:!1,weekCorrection:!1,playerCorrection:!1,settings:!1},xl.value=!0):"export"===e?gl.value=!0:"import"===e?Pi.value?.click():"manual"===e&&Di()}async function Ai(){try{const e=new Set,l=new Set;let a=Date.now();cl.value.forEach(t=>{e.add(t.item),l.add(t.player);const s=t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp;s<a&&(a=s),t.rolls&&t.rolls.forEach(e=>l.add(e.player))});const t=Array.from(e),s=Array.from(l),o=new Map(t.map((e,l)=>[e,l])),n=new Map(s.map((e,l)=>[e,l])),i=new Map(["need","greed","assign","direct","manual"].map((e,l)=>[e,l])),r={v:4,base:a,dicts:{i:t,p:s},r:wl.value.loot?cl.value.map(e=>{const l=[(e.timestamp instanceof Date?e.timestamp.getTime():e.timestamp)-a,o.get(e.item),n.get(e.player),e.key];return e.rolls&&e.rolls.length>0?(l.push(e.rolls.length),e.rolls.forEach(e=>{l.push(n.get(e.player)),l.push(e.value),l.push(i.get(e.type)??0)})):l.push(0),l}):[]},u={};if(wl.value.mapping&&(u.map=Kl.value),wl.value.roles&&(u.roles=ba.value),wl.value.bis){const e={playerBis:{}};Fe.forEach(l=>{const a=Wl.value.playerBis?.[l];a&&(e.playerBis[l]=a)}),u.bisConfig=e}wl.value.settings&&(u.filter=ka.value,u.raidActive=da.value),wl.value.weekCorrection&&(u.weekCorrections=Tl.value),wl.value.playerCorrection&&(u.playerCorrections=Ol.value),r.c=u;const c=new Blob([JSON.stringify(r)],{type:"application/json"}),d=URL.createObjectURL(c),v=document.createElement("a");v.href=d,v.download=`ff14_loot_backup_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(d),gl.value=!1,ee.success({message:"数据已导出",showClose:!0})}catch(e){ee.error({message:"导出失败",showClose:!0})}}function ji(e,l){if(e===l)return!0;if("object"!=typeof e||null===e||"object"!=typeof l||null===l)return!1;if(Array.isArray(e)!==Array.isArray(l))return!1;if(Array.isArray(e)){if(e.length!==l.length)return!1;for(let a=0;a<e.length;a++)if(!ji(e[a],l[a]))return!1;return!0}const a=Object.keys(e).sort(),t=Object.keys(l).sort();if(a.length!==t.length)return!1;for(let s=0;s<a.length;s++){const o=a[s];if(void 0===o)return!1;if(o!==t[s])return!1;if(!ji(e[o],l[o]))return!1}return!0}async function Wi(e){try{if(!e.r||!Array.isArray(e.r))return void ee.error({message:"无效的备份文件格式",showClose:!0});const l=!!e.r?.length,a=!!(e.c?.bisConfig||e.bisConfig||e.c?.bis),t=!!e.c?.roles&&Object.keys(e.c.roles).length>0,s=!!e.c?.map&&Object.keys(e.c.map).length>0,o=!!e.c?.weekCorrections&&Object.keys(e.c.weekCorrections).length>0,n=!!e.c?.playerCorrections&&Object.keys(e.c.playerCorrections).length>0,i=e.c?.filter||void 0!==e.c?.raidActive,r=!Wl.value||!Wl.value.playerBis||0===Object.keys(Wl.value.playerBis).length,u=0===Object.keys(ba.value).length,c=0===Object.keys(Kl.value).length,d=0===Object.keys(Tl.value).length,v=0===Object.keys(Ol.value).length;let p=0;if(l){const l=new Set(cl.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(cl.value.map(e=>e.key)),t=e.base||0,s=e.dicts?.i||[],o=e.dicts?.p||[];for(const n of e.r){const e=t+n[0],i=s[n[1]],r=o[n[2]],u=n[3];if(!i||!r)continue;const c=u&&"string"==typeof u?u:`${e}_${i}_${r}`;if(a.has(c)||vl.value.has(c))continue;const d=`${e}|${i}|${r}`;l.has(d)||p++}}const m=e.c?.bisConfig||e.bisConfig||e.c?.bis;Cl.value={loot:l&&p>0,bis:(()=>{if(!a)return!1;const e={},l={};return Fe.forEach(a=>{const t=Wl.value.playerBis;t&&t[a]&&(e[a]=t[a]);const s=m?.playerBis;s&&s[a]&&(l[a]=s[a])}),!ji(e,l)})(),roles:t&&!ji(ba.value,e.c.roles),mapping:s&&!ji(Kl.value,e.c.map),weekCorrection:o&&!ji(Tl.value,e.c.weekCorrections||{}),playerCorrection:n&&!ji(Ol.value,e.c.playerCorrections||{}),settings:i&&(!ji(ka.value,e.c.filter||ka.value)||da.value!==(e.c.raidActive??da.value))},_l.value={loot:Cl.value.loot,bis:a&&r&&Cl.value.bis,roles:t&&u&&Cl.value.roles,mapping:s&&c&&Cl.value.mapping,weekCorrection:o&&d&&Cl.value.weekCorrection,playerCorrection:n&&v&&Cl.value.playerCorrection,settings:i&&Cl.value.settings},Vl.value=e,hl.value=!0}catch(l){ee.error({message:"解析出错",showClose:!0})}}async function Ni(){const e=Vl.value;if(!e)return;let l;try{if(l=ee({message:"正在导入数据...",duration:0,type:"info",showClose:!0}),e.c){if(_l.value.mapping&&e.c.map&&(Kl.value={...Kl.value,...e.c.map}),_l.value.roles&&e.c.roles&&(ba.value={...ba.value,...e.c.roles}),_l.value.bis){const l=e.c.bisConfig||e.bisConfig||e.c.bis;if(l){const e={playerBis:{}};Fe.forEach(a=>{const t=l.playerBis?.[a];t&&(e.playerBis[a]=t)}),Wl.value=e}}_l.value.settings&&(e.c.filter&&(ka.value={...ka.value,...e.c.filter}),void 0!==e.c.raidActive&&(da.value=e.c.raidActive)),_l.value.weekCorrection&&e.c.weekCorrections&&(Tl.value={...Tl.value,...e.c.weekCorrections}),_l.value.playerCorrection&&e.c.playerCorrections&&(Ol.value={...Ol.value,...e.c.playerCorrections})}if(_l.value.loot&&e.r&&e.r.length>0){const l=new Set(cl.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(cl.value.map(e=>e.key)),t=[],s=e.base||0,o=e.dicts?.i||[],n=e.dicts?.p||[],i=["need","greed","assign","direct","manual"];for(const r of e.r){const e=s+r[0],u=o[r[1]],c=n[r[2]],d=r[3],v=r[4],p=[];if(v>0){let e=5;for(let l=0;l<v&&!(e+2>=r.length);l++)p.push({player:n[r[e]],value:r[e+1],type:i[r[e+2]]||"need"}),e+=3}if(!u||!c)continue;const m=d&&"string"==typeof d?d:`${e}_${u}_${c}_${Math.random().toString(36).slice(2)}`;if(a.has(m)||vl.value.has(m))continue;const y=`${e}|${u}|${c}`;l.has(y)||(t.push({key:m,timestamp:new Date(e),item:u,player:c,rolls:p,source:"import",id:""}),l.add(y),a.add(m))}t.length>0&&(await We.bulkSet(JSON.parse(JSON.stringify(t))),cl.value=[...cl.value,...t].sort((e,l)=>new Date(l.timestamp).getTime()-new Date(e.timestamp).getTime()),dl.value=new Set(cl.value.map(e=>e.key)),Oi(t,"import"))}ee.success({message:"数据导入已完成",showClose:!0}),hl.value=!1,Vl.value=null}catch(a){ee.error({message:"导入失败",showClose:!0})}finally{l?.close()}}function Fi(e){const l=new FileReader;l.onload=async e=>{try{const l=JSON.parse(e.target?.result);await Wi(l)}catch(l){ee.error({message:"文件解析失败",showClose:!0})}},l.readAsText(e)}function Ii(e){const l=e.target;l.files&&0!==l.files.length&&(Fi(l.files[0]),l.value="")}const Yi=b(null);function Ji(e,l){const a="item"===e,t=a?pl:Bl,s=a?Ba:xa;if(Yi.value?.type===e&&Yi.value.key===l)return t.value={...Yi.value.snapshot},Yi.value=null,void ee.info({message:"已恢复到独显前的状态",duration:2e3,showClose:!0});let o=t.value;Yi.value?.type===e&&(o=Yi.value.snapshot),Yi.value={type:e,key:l,snapshot:JSON.parse(JSON.stringify(o))};const n={};s.value.forEach(e=>{n[e]=e===l}),t.value=n,ee.success({message:`仅显示: ${l} (再次 Alt+点击 恢复)`,duration:2e3})}function Hi(e){const l=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${e.getFullYear()}/${l}/${a} ${t}:${s}`}function Ki(e){return 0===e?"0 MB":`${(e/1048576).toFixed(2)} MB`}function qi(e){const l=e.rolls.find(l=>l.player===e.player);if(l)return l;if(e.player){const l=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:e.player,type:l,value:null}}return null}function Xi(e){const l=Xl(e);if(!!Ol.value[e.key])return{player:l,type:"replace",value:null};const a=e.rolls.find(e=>e.player===l);if(a)return a;if(l){const a=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:l,type:a,value:null}}return null}async function Gi(){if(0===Object.values(El.value).filter(Boolean).length)return void(xl.value=!1);xl.value=!1;const e=[];El.value.loot&&(e.push(We.clear()),cl.value=[],dl.value.clear(),na.value={},e.push(Ne.remove("processedFiles"))),El.value.weekCorrection&&(Tl.value={},e.push(Ne.remove("weekCorrections"))),El.value.playerCorrection&&(Ol.value={},e.push(Ne.remove("playerCorrections"))),El.value.settings&&(ka.value={cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]},da.value=!1,e.push(Ne.remove("systemFilterSettings")),e.push(Ne.remove("isOnlyRaidMembersActive"))),El.value.bis&&(Wl.value={playerBis:{}},e.push(Ne.remove("bisConfig"))),El.value.roles&&(ba.value={},e.push(Ne.remove("playerRoles"))),El.value.mapping&&(Kl.value={},e.push(Ne.remove("playerMapping"))),await Promise.all(e),ee.success({message:"所选数据已清空",showClose:!0})}async function Qi(e,l){l&&(Ml.value={record:e,newPlayer:l},Rl.value=null,setTimeout(()=>{Ml.value&&async function(){if(!Ml.value)return;const{record:e,newPlayer:l}=Ml.value,a={...Ol.value};l===e.player?delete a[e.key]:a[e.key]=l;Ol.value=a,ee.success({message:l===e.player?"已恢复原始获得者":`已将物品重新分配给 ${l}`,showClose:!0}),Ml.value=null}()},75))}return(e,u)=>{const d=l,b=D,w=M,C=te,V=L,S=A,T=U,le=j,je=Y,We=he,Ne=_e,Ie=Se,Ye=$e,Je=Ve,He=Be,Xe=Ce,Ge=se,Qe=Pe;return t(),s("div",{class:n(["app-container",{"is-onboarding":!yl.value||$l.value||0===cl.value.length}])},[c(x,{name:"fade"},{default:p(()=>[Ke.value?(t(),s("div",pt,[v("div",mt,[u[88]||(u[88]=v("div",{class:"skeleton-header"},[v("div",{class:"skeleton-item brand"}),v("div",{class:"skeleton-item toolbar"})],-1)),v("div",yt,[u[86]||(u[86]=v("div",{class:"skeleton-item control"},null,-1)),u[87]||(u[87]=v("div",{class:"skeleton-filters"},[v("div",{class:"skeleton-item filter-box"}),v("div",{class:"skeleton-item filter-box"})],-1)),v("div",ft,[(t(),s(g,null,h(8,e=>v("div",{key:e,class:"skeleton-item card"})),64))])])])])):r("",!0)]),_:1}),v("div",gt,[c(d,{"storage-key":"loot-history-theme"})]),Ke.value?r("",!0):(t(),s(g,{key:0},[c(x,{name:"fade"},{default:p(()=>[Ze.value?(t(),s("div",ht,[v("div",kt,[v("div",bt,[u[89]||(u[89]=v("div",{class:"spinner-small"},null,-1)),v("span",wt,"解析中... "+i(il.value)+"%",1)]),v("div",_t,[v("div",Ct,[v("div",Vt," 已完成 ("+i(rl.value.length)+") ",1),v("div",St,[c(O,{name:"list"},{default:p(()=>[(t(!0),s(g,null,h(rl.value,e=>(t(),s("div",{key:e.name,class:"file-item done"},[v("div",xt,[c(b,null,{default:p(()=>[c(m(oe))]),_:1}),v("span",{class:"file-name",title:e.name},i(e.name),9,Et)]),v("span",$t,i(Ki(e.size)),1)]))),128))]),_:1})])]),u[90]||(u[90]=v("div",{class:"list-divider"},null,-1)),v("div",Bt,[v("div",Tt," 待处理 ("+i(ul.value.length)+") ",1),v("div",Ot,[(t(!0),s(g,null,h(ul.value.slice(0,50),e=>(t(),s("div",{key:e.name,class:"file-item pending"},[v("div",Rt,[c(b,null,{default:p(()=>[c(m(ne))]),_:1}),v("span",{class:"file-name",title:e.name},i(e.name),9,Dt)]),v("span",zt,i(Ki(e.size)),1)]))),128)),ul.value.length>50?(t(),s("div",Mt," ...还有 "+i(ul.value.length-50)+" 个文件 ",1)):r("",!0)])])])])])):r("",!0)]),_:1}),cl.value.length>0?(t(),s("main",Ut,[v("div",Pt,[Ma.value?(t(),s("div",{key:0,class:n(["drag-guide-zone",{"is-active":Ua.value}]),onDrop:k(Ha,["stop","prevent"]),onDragover:u[0]||(u[0]=k(()=>{},["prevent"])),onDragenter:u[1]||(u[1]=e=>Ua.value=!0),onDragleave:u[2]||(u[2]=e=>Ua.value=!1)},[c(b,{class:"guide-icon"},{default:p(()=>[c(m(ie))]),_:1}),u[91]||(u[91]=v("span",null,"释放文件以导入备份",-1))],34)):r("",!0),v("div",Lt,[c(w,{type:ca.value?"warning":"primary",size:"small",loading:oa.value,class:"sync-btn-fixed",onClick:u[3]||(u[3]=e=>gi(!0))},{default:p(()=>[f(i(oa.value?"同步中":ca.value?"需要同步":"立即同步")+" ",1),ca.value?(t(),s("span",At)):r("",!0)]),_:1},8,["type","loading"]),v("div",jt,[E(v("div",{class:"sync-hint-text time-hint"}," 上次同步: "+i(Ul.value),513),[[$,!Pl.value&&Ul.value]]),E(v("div",Wt," 同步成功 ",512),[[$,Pl.value]])]),c(C,{modelValue:ia.value,"onUpdate:modelValue":u[4]||(u[4]=e=>ia.value=e),type:"datetime",size:"small",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1,class:"date-picker-el"},null,8,["modelValue"]),u[108]||(u[108]=v("span",{class:"range-sep"},"-",-1)),c(C,{modelValue:ra.value,"onUpdate:modelValue":u[5]||(u[5]=e=>ra.value=e),type:"datetime",size:"small",placeholder:"截止时间(可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:"",class:"date-picker-el"},null,8,["modelValue"]),c(w,{plain:"",class:"tool-btn",onClick:mi},{default:p(()=>[c(b,null,{default:p(()=>[c(m(re))]),_:1}),u[92]||(u[92]=v("span",null,"日志目录",-1))]),_:1}),u[109]||(u[109]=v("div",{class:"v-divider"},null,-1)),c(w,{plain:"",class:"tool-btn",onClick:Di},{default:p(()=>[c(b,null,{default:p(()=>[c(m(F))]),_:1}),u[93]||(u[93]=v("span",null,"手动添加",-1))]),_:1}),c(T,{trigger:"click",onCommand:Li},{dropdown:p(()=>[c(S,null,{default:p(()=>[c(V,{command:"import"},{default:p(()=>[c(b,null,{default:p(()=>[c(m(ue))]),_:1}),u[95]||(u[95]=f("导入备份 (JSON) ",-1))]),_:1}),c(V,{command:"export"},{default:p(()=>[c(b,null,{default:p(()=>[c(m(ce))]),_:1}),u[96]||(u[96]=f("导出备份 (JSON) ",-1))]),_:1}),c(V,{command:"clear",divided:"",style:{color:"#f56c6c"}},{default:p(()=>[c(b,null,{default:p(()=>[c(m(I))]),_:1}),u[97]||(u[97]=f("清空数据库 ",-1))]),_:1})]),_:1})]),default:p(()=>[c(w,{plain:"",class:"tool-btn"},{default:p(()=>[c(b,null,{default:p(()=>[c(m(z))]),_:1}),u[94]||(u[94]=v("span",null,"数据管理",-1)),c(b,{class:"el-icon--right"},{default:p(()=>[c(m(P))]),_:1})]),_:1})]),_:1}),c(w,{plain:"",class:"tool-btn",onClick:u[6]||(u[6]=e=>Ll.value=!0)},{default:p(()=>[c(b,null,{default:p(()=>[c(m(de))]),_:1}),u[98]||(u[98]=v("span",null,"自定义修正管理",-1))]),_:1}),u[110]||(u[110]=v("div",{class:"v-divider"},null,-1)),c(le,{placement:"bottom-end",width:480,trigger:"click","popper-class":"guide-popover-popper"},{reference:p(()=>[c(w,{plain:"",class:"tool-btn"},{default:p(()=>[c(b,null,{default:p(()=>[c(m(W))]),_:1}),u[99]||(u[99]=v("span",null,"使用指南",-1))]),_:1})]),default:p(()=>[v("div",Nt,[v("section",Ft,[v("h4",null,[c(b,null,{default:p(()=>[c(m(H))]),_:1}),u[100]||(u[100]=f(" 这是什么？ ",-1))]),u[101]||(u[101]=v("p",null,[f(" 这是一个专门为 FFXIV 固定队设计的"),v("strong",null,"掉落历史统计"),f("与 "),v("strong",null,"BIS 分配管理"),f("工具。它能自动从你的 ACT 日志中记录战利品信息，并以此为基础提供自动化的分配建议与数据分析。 ")],-1))]),v("section",It,[v("h4",null,[c(b,null,{default:p(()=>[c(m(ve))]),_:1}),u[102]||(u[102]=f(" 注意事项 ",-1))]),u[103]||(u[103]=v("div",{class:"warning-box"},[v("ul",null,[v("li",null,[v("strong",null,"保持 ACT 运行："),f("且未勾选“隐藏聊天日志(隐私保护)”。 ")]),v("li",null,[v("strong",null,"请勿提前退本："),f(" 一定要等装备分完了再退本！以保证日志完整。 ")])])],-1))]),v("section",Yt,[v("h4",null,[c(b,null,{default:p(()=>[c(m(pe))]),_:1}),u[104]||(u[104]=f(" 快速上手 ",-1))]),u[105]||(u[105]=v("ol",null,[v("li",null,[v("strong",null,"配置人员："),f(" 在左上方“固定队 - 职位设置”中绑定队员 ID。 ")]),v("li",null,[v("strong",null,"BIS 规划："),f(" 切换至“BIS分配”页签，录入全队成员的毕业装备需求。 ")]),v("li",null,[v("strong",null,"一键分配："),f(" 副本结束后，可参考“BIS分配”页签的建议进行分配。 ")])],-1))]),v("section",Jt,[v("h4",null,[c(b,null,{default:p(()=>[c(m(me))]),_:1}),u[106]||(u[106]=f(" 漏了记录怎么办？ ",-1))]),u[107]||(u[107]=v("p",null,[f(" 如果因意外（如掉线、忘开 ACT 等）漏掉记录，请点击主界面右上角的“"),v("strong",null,"手动添加"),f("”补全。手动添加的记录也会参与 BIS 统计与分配计算。 ")],-1))])])]),_:1})])]),v("div",Ht,[v("div",Kt,[v("div",qt,[v("div",Xt,[v("span",Gt,"👥 玩家 ("+i(Xn.value)+")",1),u[116]||(u[116]=v("div",{class:"header-sep"},null,-1)),c(le,{placement:"bottom",width:360,trigger:"click","popper-class":"role-settings-popper"},{reference:p(()=>[c(w,{size:"small",class:"soft-action-btn primary"},{default:p(()=>[c(b,null,{default:p(()=>[c(m(N))]),_:1}),u[111]||(u[111]=v("span",null,"固定队 - 职位设置",-1)),Oa.value?r("",!0):(t(),s("span",Qt))]),_:1})]),default:p(()=>[v("div",Zt,[v("div",es,[(t(!0),s(g,null,h(m(Fe),e=>(t(),s("div",{key:e,class:"role-setup-item"},[v("div",ls,[c(kl,{role:e},null,8,["role"])]),c(m(ye),{modelValue:ba.value[e],"onUpdate:modelValue":l=>ba.value[e]=l,placeholder:"选择/输入玩家",filterable:"","allow-create":"","default-first-option":"",clearable:"",size:"small",style:{flex:"1"},teleported:!1},{default:p(()=>[(t(!0),s(g,null,h(rt.value.filter(l=>l===ba.value[e]||!lt.value.has(l)),e=>(t(),y(m(fe),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128))]),u[114]||(u[114]=v("div",{class:"role-divider"}," 特殊分组 ",-1)),v("div",as,[v("div",ts,[u[112]||(u[112]=v("div",{class:"group-title"}," 临时替补 ",-1)),v("div",ss,[(t(!0),s(g,null,h(ba.value,(e,l)=>(t(),s(g,{key:l},[l.startsWith("SUB:")?(t(),s("div",os,[c(m(ge),{closable:"",onClose:e=>delete ba.value[l]},{default:p(()=>[f(i(e),1)]),_:2},1032,["onClose"])])):r("",!0)],64))),128)),c(m(ye),{placeholder:"添加/输入替补",filterable:"","allow-create":"","default-first-option":"",size:"small",value:"",style:{width:"120px"},teleported:!1,onChange:u[7]||(u[7]=e=>Vi(e,"SUB"))},{default:p(()=>[(t(!0),s(g,null,h(rt.value.filter(e=>!lt.value.has(e)),e=>(t(),y(m(fe),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])]),v("div",ns,[u[113]||(u[113]=v("div",{class:"group-title"}," 已离队 ",-1)),v("div",is,[(t(!0),s(g,null,h(ba.value,(e,l)=>(t(),s(g,{key:l},[l.startsWith("LEFT:")?(t(),s("div",rs,[c(m(ge),{closable:"",onClose:e=>delete ba.value[l]},{default:p(()=>[f(i(e),1)]),_:2},1032,["onClose"])])):r("",!0)],64))),128)),c(m(ye),{placeholder:"添加/输入离队",filterable:"","allow-create":"","default-first-option":"",size:"small",value:"",style:{width:"120px"},teleported:!1,onChange:u[8]||(u[8]=e=>Vi(e,"LEFT"))},{default:p(()=>[(t(!0),s(g,null,h(rt.value.filter(e=>!lt.value.has(e)),e=>(t(),y(m(fe),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])])])])]),_:1}),u[117]||(u[117]=v("div",{class:"header-sep"},null,-1)),c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[v("label",us,[c(m(ae),{modelValue:ya.value,"onUpdate:modelValue":u[9]||(u[9]=e=>ya.value=e),disabled:!Oa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6","--el-switch-off-color":"#cbd5e1"}},null,8,["modelValue","disabled"]),v("span",{class:"switch-label",style:o({opacity:Oa.value?1:.5})},"只显示职位",4)])]),_:1},8,["disabled"]),u[118]||(u[118]=v("div",{class:"header-sep"},null,-1)),c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[v("div",cs,[c(m(ae),{modelValue:da.value,"onUpdate:modelValue":u[10]||(u[10]=e=>da.value=e),disabled:!Oa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue","disabled"]),v("span",{class:"switch-label",style:o({opacity:Oa.value?1:.5,fontSize:"12px"})}," 只看固定队 ",4)])]),_:1},8,["disabled"]),da.value?r("",!0):(t(),s("div",ds)),da.value?r("",!0):(t(),s("label",vs,[c(m(ae),{modelValue:ha.value,"onUpdate:modelValue":u[11]||(u[11]=e=>ha.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),u[115]||(u[115]=v("span",{class:"switch-label"},"隐藏无记录玩家",-1))]))]),v("div",ps,[c(le,{visible:qe.value,"onUpdate:visible":u[12]||(u[12]=e=>qe.value=e),placement:"bottom",width:320,trigger:"click"},{reference:p(()=>[c(w,{size:"small",class:"soft-action-btn"},{default:p(()=>[...u[119]||(u[119]=[f(" 合并大小号 ",-1)])]),_:1})]),default:p(()=>[v("div",ms,[v("div",ys,[v("div",fs,[c(b,null,{default:p(()=>[c(m(H))]),_:1}),u[120]||(u[120]=v("div",{class:"guide-content"},[v("p",null,[f(" 合并角色将"),v("strong",null,"永久归并"),f("两者的所有历史记录。 ")]),v("p",null," 若仅需修正单次分配错误，请直接在“详情记录”中点击姓名进行修改。 ")],-1))]),v("div",gs,[v("div",{class:n(["step-dot hide",{"is-active":0===Gl.value.length}])},[...u[121]||(u[121]=[v("span",{class:"step-num"},"1",-1),v("span",{class:"step-label"},"被合角色",-1)])],2),c(b,{class:"step-arrow"},{default:p(()=>[c(m(Z))]),_:1}),v("div",{class:n(["step-dot show",{"is-active":1===Gl.value.length}])},[...u[122]||(u[122]=[v("span",{class:"step-num"},"2",-1),v("span",{class:"step-label"},"目标角色",-1)])],2)]),v("div",hs,[(t(!0),s(g,null,h(nt.value,e=>(t(),y(We,{key:e,checked:Gl.value.includes(e),class:n(["merge-check-tag",[Gl.value[0]===e?"is-hiding":"",Gl.value[1]===e?"is-showing":""]]),onChange:l=>function(e){Gl.value.includes(e)?Gl.value=Gl.value.filter(l=>l!==e):(Gl.value.length>=2&&Gl.value.shift(),Gl.value.push(e))}(e)},{default:p(()=>[c(bl,{name:e,role:Bi(e),"show-only-role":ya.value,class:"tag-label-name"},null,8,["name","role","show-only-role"]),Gl.value[0]===e?(t(),s("div",ks,[c(b,null,{default:p(()=>[c(m(ke))]),_:1}),u[123]||(u[123]=v("span",null,"隐身角色",-1))])):r("",!0),Gl.value[1]===e?(t(),s("div",bs,[c(b,null,{default:p(()=>[c(m(be))]),_:1}),u[124]||(u[124]=v("span",null,"主角色",-1))])):r("",!0)]),_:2},1032,["checked","class","onChange"]))),128))]),2===Gl.value.length?(t(),s("div",ws,[c(w,{type:"primary",size:"default",class:"confirm-merge-btn-new",onClick:Ql},{default:p(()=>[...u[125]||(u[125]=[f(" 确认将数据合并 ",-1)])]),_:1})])):r("",!0)]),Ga.value.length>0?(t(),s("div",_s,[u[126]||(u[126]=v("div",{class:"suggest-title"}," 💡 发现疑似换号 (>90% 重合)： ",-1)),v("div",Cs,[(t(!0),s(g,null,h(Ga.value,e=>(t(),y(w,{key:e.from+e.to,size:"small",plain:"",class:"suggest-btn",onClick:l=>la(e.from,e.to)},{default:p(()=>[c(bl,{name:e.from,role:Bi(e.from),"show-only-role":ya.value},null,8,["name","role","show-only-role"]),c(b,{style:{margin:"0 4px"}},{default:p(()=>[c(m(Z))]),_:1}),c(bl,{name:e.to,role:Bi(e.to),"show-only-role":ya.value},null,8,["name","role","show-only-role"]),v("span",Vs,"("+i(e.confidence)+"%)",1)]),_:2},1032,["onClick"]))),128))])])):r("",!0),Object.keys(Kl.value).length>0?(t(),s("div",Ss,[u[129]||(u[129]=v("div",{class:"selector-title"}," 当前合并映射: ",-1)),v("div",xs,[(t(!0),s(g,null,h(Kl.value,(e,l)=>(t(),s("div",{key:l,class:"mapping-item-row"},[v("div",Es,[u[127]||(u[127]=v("span",{class:"map-tag-hint"},"隐身",-1)),c(bl,{name:l,role:Bi(l),"show-only-role":ya.value},null,8,["name","role","show-only-role"])]),c(b,{class:"map-arrow"},{default:p(()=>[c(m(Z))]),_:1}),v("div",$s,[u[128]||(u[128]=v("span",{class:"map-tag-hint"},"显示",-1)),c(bl,{name:e,role:Bi(e),"show-only-role":ya.value},null,8,["name","role","show-only-role"])]),c(w,{link:"",type:"danger",icon:m(I),class:"map-remove",onClick:e=>function(e){const l={...Kl.value};delete l[e],Kl.value=l}(l)},null,8,["icon","onClick"])]))),128))])])):r("",!0)])]),_:1},8,["visible"]),u[130]||(u[130]=v("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示",-1))])]),v("div",Bs,[da.value?(t(),s("div",Ts)):r("",!0),(t(!0),s(g,null,h(Da.value,e=>(t(),y(We,{key:e,checked:wi(e),class:n([{"readonly-tag":da.value},"mini-tag-el player-tag"]),onClick:k(l=>Ti(l,e),["stop"])},{default:p(()=>[c(bl,{name:e,role:Bi(e),"show-only-role":ya.value},null,8,["name","role","show-only-role"])]),_:2},1032,["checked","class","onClick"]))),128))])]),v("div",Os,[v("div",Rs,[v("div",Ds,[v("span",zs,"📦 物品 ("+i(qn.value)+")",1),v("label",Ms,[c(m(ae),{modelValue:ua.value,"onUpdate:modelValue":u[13]||(u[13]=e=>ua.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),u[131]||(u[131]=v("span",{class:"switch-label"},"只看零式掉落",-1))]),u[141]||(u[141]=v("div",{class:"header-sep"},null,-1)),c(le,{placement:"bottom-start",width:220,trigger:"click"},{reference:p(()=>[c(w,{size:"small",class:"soft-action-btn primary"},{default:p(()=>[c(b,{style:{"margin-right":"4px"}},{default:p(()=>[c(m(z))]),_:1}),u[132]||(u[132]=f(" 杂物屏蔽设置 ",-1))]),_:1})]),default:p(()=>[v("div",Us,[u[140]||(u[140]=v("div",{class:"pop-title"}," 屏蔽杂物 (非零式模式下生效) ",-1)),v("div",{class:"filter-list",style:o({opacity:ua.value?.5:1,pointerEvents:ua.value?"none":"auto"})},[c(m(we),{modelValue:ka.value.cards,"onUpdate:modelValue":u[14]||(u[14]=e=>ka.value.cards=e),size:"small"},{default:p(()=>[...u[133]||(u[133]=[f(" 九宫幻卡 ",-1)])]),_:1},8,["modelValue"]),c(m(we),{modelValue:ka.value.materia,"onUpdate:modelValue":u[15]||(u[15]=e=>ka.value.materia=e),size:"small"},{default:p(()=>[...u[134]||(u[134]=[f(" 魔晶石 ",-1)])]),_:1},8,["modelValue"]),c(m(we),{modelValue:ka.value.music,"onUpdate:modelValue":u[16]||(u[16]=e=>ka.value.music=e),size:"small"},{default:p(()=>[...u[135]||(u[135]=[f(" 乐谱 ",-1)])]),_:1},8,["modelValue"]),c(m(we),{modelValue:ka.value.book,"onUpdate:modelValue":u[17]||(u[17]=e=>ka.value.book=e),size:"small"},{default:p(()=>[...u[136]||(u[136]=[f(" 零式断章 ",-1)])]),_:1},8,["modelValue"]),c(m(we),{modelValue:ka.value.totem,"onUpdate:modelValue":u[18]||(u[18]=e=>ka.value.totem=e),size:"small"},{default:p(()=>[...u[137]||(u[137]=[f(" 极神图腾 ",-1)])]),_:1},8,["modelValue"]),c(m(we),{modelValue:ka.value.other,"onUpdate:modelValue":u[19]||(u[19]=e=>ka.value.other=e),size:"small"},{default:p(()=>[...u[138]||(u[138]=[f(" 经验值/金币 ",-1)])]),_:1},8,["modelValue"]),Za.value.length>0?(t(),s(g,{key:0},[u[139]||(u[139]=v("div",{class:"pop-title",style:{margin:"8px 0 4px","padding-top":"8px"}}," 屏蔽装备系列 ",-1)),c(Ne,{modelValue:ka.value.maskedSeries,"onUpdate:modelValue":u[20]||(u[20]=e=>ka.value.maskedSeries=e),style:{display:"flex","flex-direction":"column",gap:"4px"}},{default:p(()=>[(t(!0),s(g,null,h(Za.value,e=>(t(),y(m(we),{key:e,value:e,size:"small"},{default:p(()=>[f(i(e)+"系列 ",1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])],64)):r("",!0)],4)])]),_:1})]),u[142]||(u[142]=v("div",{class:"acts"},[v("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示")],-1))]),v("div",Ps,[ua.value?(t(),s("div",Ls)):r("",!0),(t(!0),s(g,null,h(ut.value,e=>(t(),y(We,{key:e,checked:bi(e),class:n([{"readonly-tag":ua.value},"mini-tag-el item-tag"]),onClick:k(l=>_i(l,e),["stop"])},{default:p(()=>[f(i(e),1)]),_:2},1032,["checked","class","onClick"]))),128))])])]),v("div",As,[Ea.value.length>0?(t(),y(Ge,{key:0,modelValue:ml.value,"onUpdate:modelValue":u[31]||(u[31]=e=>ml.value=e),class:"mode-tabs-el",type:"card"},{default:p(()=>[c(Xe,{label:"详细记录",name:"list"},{default:p(()=>[v("div",js,[c(Je,{data:vi.value,style:{width:"100%"},class:"loot-record-table","cell-class-name":"loot-cell"},{default:p(()=>[c(Ie,{label:"周",width:"60",align:"center"},{default:p(e=>[v("div",{class:"col-week-interactive",onClick:k(l=>ci(l,e.row),["stop"]),onContextmenu:k(l=>ci(l,e.row),["prevent"])},[Tl.value[e.row.key]?(t(),s("div",Ns,[v("div",Fs," W"+i(m(tl)(e.row.timestamp,a)),1),c(b,{class:"week-arrow"},{default:p(()=>[c(m(P))]),_:1}),v("div",Is," W"+i(m(tl)(e.row.timestamp,a)+(Tl.value[e.row.key]||0)),1)])):(t(),s("div",Ys,[f(" W"+i(m(tl)(e.row.timestamp,a))+" ",1),Ta.value.has(e.row.key)&&!Tl.value[e.row.key]?(t(),y(je,{key:0,placement:"top",enterable:!1},{content:p(()=>[...u[143]||(u[143]=[f(" 可能归属周错误（通常发生在周二压线进本）。",-1),v("br",null,null,-1),f("点击可选择将其归入上一周。 ",-1)])]),default:p(()=>[c(b,{class:"week-warning-icon"},{default:p(()=>[c(m(q))]),_:1})]),_:1})):r("",!0)]))],40,Ws)]),_:1}),c(Ie,{label:"时间",width:"140"},{default:p(e=>[v("div",Js,[v("span",Hs,i(Hi(e.row.timestamp)),1)])]),_:1}),c(Ie,{label:"物品",width:"220"},{default:p(e=>[v("div",Ks,[v("span",qs,i(e.row.item),1)])]),_:1}),c(Ie,{label:"获得者",width:"260"},{default:p(e=>[v("div",{class:"winner-selector-trigger",onClick:k(l=>{return a=l,t=e.row,void(Rl.value?.key!==t.key?(Dl.value=a.currentTarget,Rl.value=t,zl.value[t.key]=!!Ol.value[t.key]):Rl.value=null);var a,t},["stop"])},[Ol.value[e.row.key]?(t(),s("div",Gs,[v("div",Qs,[u[144]||(u[144]=v("span",{class:"correction-label"},"原始记录:",-1)),qi(e.row)?(t(),y(tt,{key:0,roll:qi(e.row),"show-only-role":ya.value,"get-player-role":Bi,class:"original-display"},null,8,["roll","show-only-role"])):(t(),y(bl,{key:1,name:e.row.player,role:Bi(e.row.player),"show-only-role":ya.value,class:"original-display"},null,8,["name","role","show-only-role"]))]),v("div",Zs,[c(b,{class:"correction-arrow"},{default:p(()=>[c(m(xe))]),_:1}),Xi(e.row)?(t(),y(tt,{key:0,roll:Xi(e.row),"is-winner":"","show-only-role":ya.value,"get-player-role":Bi},null,8,["roll","show-only-role"])):r("",!0)])])):(t(),s(g,{key:1},[Xi(e.row)?(t(),y(tt,{key:0,roll:Xi(e.row),"is-winner":"","show-only-role":ya.value,"get-player-role":Bi},null,8,["roll","show-only-role"])):(t(),s("div",eo," 未分配 "))],64)),c(b,{class:"winner-edit-icon"},{default:p(()=>[c(m(Ee))]),_:1})],8,Xs)]),_:1}),c(Ie,{label:"其他 Roll 点记录"},{default:p(e=>{return[v("div",lo,[(t(!0),s(g,null,h((l=e.row,l.rolls.filter(e=>e.player!==l.player).sort((e,l)=>{const a={need:0,greed:1},t=a[e.type]??3,s=a[l.type]??3;return t!==s?t-s:(l.value||0)-(e.value||0)})),e=>(t(),y(tt,{key:e.player,roll:e,"show-only-role":ya.value,"get-player-role":Bi},null,8,["roll","show-only-role"]))),128))])];var l}),_:1}),c(Ie,{label:"操作",width:"60",align:"center"},{default:p(e=>[c(Ye,{title:"确定永久删除吗？","confirm-button-text":"删除","cancel-button-text":"取消",onConfirm:l=>yi(e.row)},{reference:p(()=>[c(w,{type:"danger",icon:m(I),size:"small",circle:"",plain:""},null,8,["icon"])]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"]),v("div",ao,[c(He,{"current-page":aa.value,"onUpdate:currentPage":u[21]||(u[21]=e=>aa.value=e),"page-size":50,layout:"total, prev, pager, next",total:Ea.value.length,size:"small"},null,8,["current-page","total"])])])]),_:1}),c(Xe,{name:"summary",disabled:!Oa.value,lazy:""},{label:p(()=>[c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[...u[145]||(u[145]=[v("span",null,"按玩家",-1)])]),_:1},8,["disabled"])]),default:p(()=>[v("div",to,[c(ot,{modelValue:Il.value,"onUpdate:modelValue":u[22]||(u[22]=e=>Il.value=e)},null,8,["modelValue"]),u[146]||(u[146]=v("div",{class:"v-divider-mini"},null,-1)),c(et,{modelValue:Zl.value,"onUpdate:modelValue":u[23]||(u[23]=e=>Zl.value=e)},null,8,["modelValue"])]),v("div",so,[(t(!0),s(g,null,h(it.value,e=>(t(),s("div",{key:e,class:"summary-card"},[v("div",oo,[c(bl,{name:e,role:Bi(e),"show-only-role":ya.value},null,8,["name","role","show-only-role"])]),v("div",null,[(t(!0),s(g,null,h($i(e),e=>(t(),s("div",{key:e.name,class:n(["summary-item",{"is-not-obtained":0===e.count}])},[v("span",{class:"s-name",title:e.name},i(e.name),9,no),c(dt,{item:e},null,8,["item"])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(Xe,{name:"slot",disabled:!Oa.value,lazy:""},{label:p(()=>[c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[...u[147]||(u[147]=[v("span",null,"按部位",-1)])]),_:1},8,["disabled"])]),default:p(()=>[v("div",io,[c(ot,{modelValue:Yl.value,"onUpdate:modelValue":u[24]||(u[24]=e=>Yl.value=e)},null,8,["modelValue"]),u[148]||(u[148]=v("div",{class:"v-divider-mini"},null,-1)),c(et,{modelValue:ea.value,"onUpdate:modelValue":u[25]||(u[25]=e=>ea.value=e)},null,8,["modelValue"])]),v("div",ro,[(t(!0),s(g,null,h(Zn.value,e=>(t(),s("div",{key:e,class:"summary-card"},[v("div",uo,i(e),1),v("div",null,[(t(!0),s(g,null,h(xi(Qn.value[e]||{},e),l=>(t(),s("div",{key:l,class:n(["summary-item",{"is-not-obtained":0===(Qn.value[e]?.[l]||0)}])},[c(bl,{class:"s-name",name:l,role:Bi(l),"show-only-role":ya.value},null,8,["name","role","show-only-role"]),v("div",co,[c(dt,{item:Ei(l,e,Qn.value[e]?.[l]||0)},null,8,["item"])])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(Xe,{name:"week",disabled:!Oa.value,lazy:""},{label:p(()=>[c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[...u[149]||(u[149]=[v("span",null,"按CD周",-1)])]),_:1},8,["disabled"])]),default:p(()=>[v("div",vo,[c(ot,{modelValue:Jl.value,"onUpdate:modelValue":u[26]||(u[26]=e=>Jl.value=e)},null,8,["modelValue"])]),v("div",po,[v("div",{class:n(["summary-grid has-sort-control",{"is-compact-role":ya.value}])},[(t(!0),s(g,null,h(ti.value,e=>(t(),s("div",{key:e,class:"summary-card",onContextmenu:u[27]||(u[27]=k(()=>{},["prevent"]))},[v("div",mo,i(li(e)),1),v("div",yo,[(t(!0),s(g,null,h([si(e)],l=>(t(),s("div",{key:l.length+e},[(t(!0),s(g,null,h(l,(e,a)=>(t(),s(g,{key:e.key},[v("div",{class:n(["summary-item week-record-row",{"is-corrected":Tl.value[e.key],"is-suspicious":Ta.value.has(e.key)&&!Tl.value[e.key]}]),onContextmenu:k(l=>ci(l,e),["prevent"]),onClick:k(l=>ci(l,e),["stop"]),onMouseenter:l=>function(e,l){Ta.value.has(l.key)&&void 0===Tl.value[l.key]&&(Aa.value=e.currentTarget,ja.value="可能归属周错误（通常发生在周二压线进本）。点击可选择将其归入上一周。",La.value=!0)}(l,e),onMouseleave:Na},[v("div",go,[c(bl,{name:e.player,role:Bi(e.player),"show-only-role":ya.value,"name-class":"week-player-name"},null,8,["name","role","show-only-role"])]),v("div",ho,[v("span",ko,i(e.item),1),Ta.value.has(e.key)&&!Tl.value[e.key]?(t(),y(b,{key:0,class:"row-status-icon is-warning"},{default:p(()=>[c(m(q))]),_:1})):r("",!0),Tl.value[e.key]?(t(),y(b,{key:1,class:"row-status-icon is-info"},{default:p(()=>[c(m(ne))]),_:1})):r("",!0)])],42,fo),ni(l,a)?(t(),s("div",bo)):r("",!0)],64))),128))]))),128))])],32))),128))],2)]),c(je,{visible:La.value,"onUpdate:visible":u[28]||(u[28]=e=>La.value=e),"virtual-ref":Aa.value,"virtual-triggering":"",placement:"top",content:ja.value,"popper-class":"week-suspicious-tooltip"},null,8,["visible","virtual-ref","content"])]),_:1},8,["disabled"]),c(Xe,{name:"chart",disabled:!Oa.value,lazy:""},{label:p(()=>[c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[...u[150]||(u[150]=[v("span",null,"图表分析",-1)])]),_:1},8,["disabled"])]),default:p(()=>[c(Qa,{records:Gn.value,players:Da.value,"get-actual-player":ql,"get-player-role":Bi,"record-week-corrections":Tl.value,"sync-start-date":ia.value,"player-visibility":ya.value?"role":"all"},null,8,["records","players","record-week-corrections","sync-start-date","player-visibility"])]),_:1},8,["disabled"]),c(Xe,{name:"bis",disabled:!Oa.value,lazy:""},{label:p(()=>[c(je,{disabled:Oa.value,content:Hn,placement:"top"},{default:p(()=>[v("div",wo,[u[151]||(u[151]=v("span",null,"BIS分配",-1)),Oa.value&&!at.value?(t(),s("span",_o)):r("",!0)])]),_:1},8,["disabled"])]),default:p(()=>[c(Wa,{modelValue:Wl.value,"onUpdate:modelValue":u[29]||(u[29]=e=>Wl.value=e),"sort-mode":Hl.value,"onUpdate:sortMode":u[30]||(u[30]=e=>Hl.value=e),players:Da.value,records:Gn.value,"get-player-role":Bi,"get-actual-player":ql,"show-only-role":ya.value},null,8,["modelValue","sort-mode","players","records","show-only-role"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):(t(),s("div",Co,[v("div",Vo,[c(b,null,{default:p(()=>[c(m(Te))]),_:1})]),u[153]||(u[153]=v("div",{class:"empty-title"}," 未发现匹配记录 ",-1)),u[154]||(u[154]=v("p",{class:"empty-desc"},[f(" 当前筛选条件过于严格，数据库中有数据但未能匹配。"),v("br"),f(" 请尝试"),v("span",{class:"empty-highlight"},"清除筛选条件"),f("或调整时间范围。 ")],-1)),v("div",So,[c(w,{type:"info",plain:"",onClick:pi},{default:p(()=>[...u[152]||(u[152]=[f(" 显示所有掉落 ",-1)])]),_:1})])])),c(le,{visible:!!Rl.value,"virtual-ref":Dl.value,"virtual-triggering":"",persistent:!1,"hide-after":0,placement:"bottom",width:240,"popper-class":"winner-change-popper"},{default:p(()=>[Rl.value?(t(),s("div",xo,[v("div",Eo,[u[156]||(u[156]=v("div",{class:"popover-title"}," 变更获得者 ",-1)),zl.value[Rl.value.key]?(t(),y(w,{key:0,type:"primary",link:"",size:"small",class:"restore-btn",onClick:u[32]||(u[32]=e=>Qi(Rl.value,Rl.value.player))},{default:p(()=>[...u[155]||(u[155]=[f(" 恢复原始记录 ",-1)])]),_:1})):r("",!0)]),u[157]||(u[157]=v("div",{class:"popover-desc"}," 将掉落记录手动转移至其他玩家名下 ",-1)),c(m(ye),{"model-value":Xl(Rl.value),placeholder:"选择新获得者",filterable:"",size:"small",class:"winner-select-bar",onChange:u[33]||(u[33]=e=>Qi(Rl.value,e))},{default:p(()=>[(t(!0),s(g,null,h(Da.value,e=>(t(),y(m(fe),{key:e,label:ya.value&&Bi(e)||e,value:e},{default:p(()=>[v("div",$o,[c(bl,{name:e,role:Bi(e),"show-only-role":ya.value},null,8,["name","role","show-only-role"])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["model-value"])])):r("",!0)]),_:1},8,["visible","virtual-ref"]),c(le,{visible:Va.value,"onUpdate:visible":u[34]||(u[34]=e=>Va.value=e),"virtual-ref":ui,"virtual-triggering":"",persistent:!1,"hide-after":0,"popper-class":"context-menu-popper",width:180,"show-arrow":!1,placement:"bottom-start"},{default:p(()=>[ii.value?(t(),s("div",Bo,[v("div",To,[c(b,null,{default:p(()=>[c(m(Oe))]),_:1}),v("span",null,i(Hi(ii.value.timestamp)),1)]),u[158]||(u[158]=v("div",{class:"menu-divider"},null,-1)),v("div",{class:"menu-action-item",onClick:di},[c(b,{class:"action-arrow"},{default:p(()=>[(t(),y(R(Tl.value[ii.value.key]?m(de):m(Re))))]),_:1}),v("span",Oo,i(Tl.value[ii.value.key]?"归回原始周":"归入上一周"),1)])])):r("",!0)]),_:1},8,["visible"])])])):(t(),s("div",Ro,[v("div",Do,[yl.value?$l.value?(t(),s(g,{key:1},[u[172]||(u[172]=v("div",{class:"empty-title"}," 设置同步范围 ",-1)),v("p",Po,[u[165]||(u[165]=f(" 已关联目录：",-1)),v("span",Lo,i(yl.value.name),1),u[166]||(u[166]=v("br",null,null,-1)),u[167]||(u[167]=f(" 请指定你想要同步的历史记录起始时间。 ",-1))]),v("div",Ao,[v("div",jo,[u[168]||(u[168]=v("span",{class:"setup-label"},"起始时间:",-1)),c(C,{modelValue:ia.value,"onUpdate:modelValue":u[39]||(u[39]=e=>ia.value=e),type:"datetime",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1},null,8,["modelValue"])]),v("div",Wo,[u[169]||(u[169]=v("span",{class:"setup-label"},"截止时间:",-1)),c(C,{modelValue:ra.value,"onUpdate:modelValue":u[40]||(u[40]=e=>ra.value=e),type:"datetime",placeholder:"现在 (可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm"},null,8,["modelValue"])])]),v("div",No,[c(w,{plain:"",size:"large",onClick:u[41]||(u[41]=e=>yl.value=null)},{default:p(()=>[...u[170]||(u[170]=[f(" 返回重选 ",-1)])]),_:1}),c(w,{type:"primary",size:"large",onClick:fi},{default:p(()=>[...u[171]||(u[171]=[f(" 开始解析并导入 ",-1)])]),_:1})])],64)):(t(),s("div",Fo,[Ma.value?(t(),s("div",{key:0,class:n(["setup-drag-zone",{"is-active":Ua.value}]),onDrop:k(Ha,["stop","prevent"]),onDragover:u[42]||(u[42]=k(()=>{},["prevent"])),onDragenter:u[43]||(u[43]=e=>Ua.value=!0),onDragleave:u[44]||(u[44]=e=>Ua.value=!1)},[c(b,{class:"guide-icon"},{default:p(()=>[c(m(ie))]),_:1}),u[173]||(u[173]=v("span",null,"释放文件以导入备份",-1))],34)):r("",!0),v("div",Io,i(oa.value?"正在同步数据":"准备就绪"),1),v("p",Yo,i(oa.value?"正在处理日志文件，请稍候。":"数据库当前为空。你可以开始解析数据，或从备份文件恢复。"),1),v("div",Jo,[oa.value?r("",!0):(t(),y(w,{key:0,type:"primary",size:"large",onClick:u[45]||(u[45]=e=>gi(!0))},{default:p(()=>[...u[174]||(u[174]=[f(" 开始解析数据 ",-1)])]),_:1})),oa.value?r("",!0):(t(),y(w,{key:1,plain:"",size:"large",onClick:u[46]||(u[46]=e=>Pi.value?.click())},{default:p(()=>[...u[175]||(u[175]=[f(" 导入备份数据 ",-1)])]),_:1})),oa.value?r("",!0):(t(),y(w,{key:2,plain:"",size:"large",onClick:u[47]||(u[47]=e=>$l.value=!0)},{default:p(()=>[...u[176]||(u[176]=[f(" 调整时间范围 ",-1)])]),_:1}))])])):(t(),s("div",zo,[Ma.value?(t(),s("div",{key:0,class:n(["setup-drag-zone",{"is-active":Ua.value}]),onDrop:k(Ha,["stop","prevent"]),onDragover:u[35]||(u[35]=k(()=>{},["prevent"])),onDragenter:u[36]||(u[36]=e=>Ua.value=!0),onDragleave:u[37]||(u[37]=e=>Ua.value=!1)},[c(b,{class:"guide-icon"},{default:p(()=>[c(m(ie))]),_:1}),u[159]||(u[159]=v("span",null,"释放文件以导入备份",-1))],34)):r("",!0),v("div",Mo,[u[162]||(u[162]=v("div",{class:"empty-title"}," 欢迎使用 Loot History ",-1)),u[163]||(u[163]=v("p",{class:"empty-desc"},[f(" 选择你的"),v("span",{class:"empty-highlight"},"FFXIV 日志文件夹"),f("，开始记录掉落。 ")],-1)),v("div",Uo,[c(w,{type:"primary",size:"large",onClick:mi},{default:p(()=>[...u[160]||(u[160]=[f(" 选择日志目录 ",-1)])]),_:1}),c(w,{type:"info",plain:"",size:"large",onClick:u[38]||(u[38]=e=>Pi.value?.click())},{default:p(()=>[...u[161]||(u[161]=[f(" 导入备份数据 ",-1)])]),_:1})])]),u[164]||(u[164]=v("div",{class:"guide-img-box"},[v("img",{src:"/ff14-overlay-vue/assets/lootHistoryGuide-CNWHhK0O.jpg",alt:"Guide",class:"guide-img"})],-1))]))])])),c(m(Q),{modelValue:gl.value,"onUpdate:modelValue":u[56]||(u[56]=e=>gl.value=e),title:"选择导出内容",width:"360px","append-to-body":"","destroy-on-close":""},B({default:p(()=>[gl.value?(t(),s("div",Ho,[c(m(we),{modelValue:wl.value.loot,"onUpdate:modelValue":u[48]||(u[48]=e=>wl.value.loot=e)},{default:p(()=>[f(i(_)+" ("+i(cl.value.length)+") ",1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.roles,"onUpdate:modelValue":u[49]||(u[49]=e=>wl.value.roles=e)},{default:p(()=>[f(i(J),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.bis,"onUpdate:modelValue":u[50]||(u[50]=e=>wl.value.bis=e)},{default:p(()=>[f(i(K),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.mapping,"onUpdate:modelValue":u[51]||(u[51]=e=>wl.value.mapping=e)},{default:p(()=>[f(i(X),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.weekCorrection,"onUpdate:modelValue":u[52]||(u[52]=e=>wl.value.weekCorrection=e)},{default:p(()=>[f(i(G),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.playerCorrection,"onUpdate:modelValue":u[53]||(u[53]=e=>wl.value.playerCorrection=e)},{default:p(()=>[f(i(Le),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:wl.value.settings,"onUpdate:modelValue":u[54]||(u[54]=e=>wl.value.settings=e)},{default:p(()=>[f(i(Ae),1)]),_:1},8,["modelValue"])])):r("",!0)]),_:2},[gl.value?{name:"footer",fn:p(()=>[v("span",Ko,[c(w,{onClick:u[55]||(u[55]=e=>gl.value=!1)},{default:p(()=>[...u[177]||(u[177]=[f("取消",-1)])]),_:1}),c(w,{type:"primary",onClick:Ai},{default:p(()=>[...u[178]||(u[178]=[f("立即导出",-1)])]),_:1})])]),key:"0"}:void 0]),1032,["modelValue"]),c(m(Q),{modelValue:hl.value,"onUpdate:modelValue":u[65]||(u[65]=e=>hl.value=e),title:"选择导入内容",width:"400px","append-to-body":"","destroy-on-close":""},{footer:p(()=>[v("span",mn,[c(w,{onClick:u[64]||(u[64]=e=>hl.value=!1)},{default:p(()=>[...u[182]||(u[182]=[f("取消",-1)])]),_:1}),c(w,{type:"primary",onClick:Ni},{default:p(()=>[...u[183]||(u[183]=[f("确认导入",-1)])]),_:1})])]),default:p(()=>[hl.value&&Vl.value?(t(),s("div",qo,[u[181]||(u[181]=v("p",{class:"import-hint-text"}," 发现备份文件，请选择要导入的部分： ",-1)),v("div",Xo,[c(m(we),{modelValue:_l.value.loot,"onUpdate:modelValue":u[57]||(u[57]=e=>_l.value.loot=e),disabled:!Vl.value.r?.length},{default:p(()=>[f(i(_)+" ("+i(Vl.value.r?.length||0)+" 条) ",1),Vl.value.r?.length?Cl.value.loot?r("",!0):(t(),s("span",Qo,"(与现有记录一致)")):(t(),s("span",Go,"- 备份文件中未发现记录"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.bis,"onUpdate:modelValue":u[58]||(u[58]=e=>_l.value.bis=e),disabled:!Vl.value.bisConfig&&!Vl.value.c?.bisConfig&&!Vl.value.c?.bis},{default:p(()=>[f(i(K)+" ",1),Vl.value.bisConfig||Vl.value.c?.bisConfig||Vl.value.c?.bis?Cl.value.bis?r("",!0):(t(),s("span",en,"(与现有配置一致)")):(t(),s("span",Zo,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.roles,"onUpdate:modelValue":u[59]||(u[59]=e=>_l.value.roles=e),disabled:!Vl.value.c?.roles},{default:p(()=>[f(i(J)+" ",1),Vl.value.c?.roles?Cl.value.roles?r("",!0):(t(),s("span",an,"(与现有设置一致)")):(t(),s("span",ln,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.mapping,"onUpdate:modelValue":u[60]||(u[60]=e=>_l.value.mapping=e),disabled:!Vl.value.c?.map},{default:p(()=>[f(i(X)+" ",1),Vl.value.c?.map?Cl.value.mapping?r("",!0):(t(),s("span",sn,"(与现有设置一致)")):(t(),s("span",tn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.weekCorrection,"onUpdate:modelValue":u[61]||(u[61]=e=>_l.value.weekCorrection=e),disabled:!Vl.value.c?.weekCorrections},{default:p(()=>[f(i(G)+" ",1),Vl.value.c?.weekCorrections?Cl.value.weekCorrection?r("",!0):(t(),s("span",nn,"(与现有设置一致)")):(t(),s("span",on,"- 未发现数据"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.playerCorrection,"onUpdate:modelValue":u[62]||(u[62]=e=>_l.value.playerCorrection=e),disabled:!Vl.value.c?.playerCorrections},{default:p(()=>[f(i(Le)+" ",1),Vl.value.c?.playerCorrections?Cl.value.playerCorrection?r("",!0):(t(),s("span",un,"(与现有设置一致)")):(t(),s("span",rn,"- 未发现数据"))]),_:1},8,["modelValue","disabled"]),c(m(we),{modelValue:_l.value.settings,"onUpdate:modelValue":u[63]||(u[63]=e=>_l.value.settings=e),disabled:!Vl.value.c?.filter&&void 0===Vl.value.c?.raidActive},{default:p(()=>[f(i(Ae)+" ",1),Vl.value.c?.filter||void 0!==Vl.value.c?.raidActive?Cl.value.settings?r("",!0):(t(),s("span",dn,"(与现有设置一致)")):(t(),s("span",cn,"- 未发现数据"))]),_:1},8,["modelValue","disabled"])]),_l.value.bis&&Cl.value.bis||_l.value.roles&&Cl.value.roles||_l.value.mapping&&Cl.value.mapping||_l.value.weekCorrection&&Cl.value.weekCorrection||_l.value.playerCorrection&&Cl.value.playerCorrection||_l.value.settings&&Cl.value.settings?(t(),s("div",vn,[c(b,null,{default:p(()=>[c(m(q))]),_:1}),u[179]||(u[179]=v("span",null,"所选配置项导入后将覆盖当前设置",-1))])):!(_l.value.bis||_l.value.roles||_l.value.mapping||_l.value.weekCorrection||_l.value.playerCorrection||_l.value.settings)||Cl.value.bis||Cl.value.roles||Cl.value.mapping||Cl.value.weekCorrection||Cl.value.playerCorrection||Cl.value.settings?r("",!0):(t(),s("div",pn,[c(b,null,{default:p(()=>[c(m(De))]),_:1}),u[180]||(u[180]=v("span",null,"所选配置项已与本地同步，无需重复导入",-1))]))])):r("",!0)]),_:1},8,["modelValue"]),c(m(Q),{modelValue:xl.value,"onUpdate:modelValue":u[76]||(u[76]=e=>xl.value=e),title:"清空数据选项",width:"400px","append-to-body":"","destroy-on-close":""},{footer:p(()=>[v("span",kn,[c(w,{onClick:u[75]||(u[75]=e=>xl.value=!1)},{default:p(()=>[...u[188]||(u[188]=[f("取消",-1)])]),_:1}),c(w,{type:"danger",onClick:Gi},{default:p(()=>[...u[189]||(u[189]=[f("确定清空",-1)])]),_:1})])]),default:p(()=>[xl.value?(t(),s("div",yn,[v("div",fn,[u[186]||(u[186]=v("p",{class:"clear-warning-text"}," 请选择要彻底删除的数据项： ",-1)),v("div",gn,[c(w,{link:"",type:"primary",size:"small",onClick:u[66]||(u[66]=e=>El.value={loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0})},{default:p(()=>[...u[184]||(u[184]=[f(" 全选 ",-1)])]),_:1}),c(w,{link:"",size:"small",onClick:u[67]||(u[67]=e=>El.value={loot:!El.value.loot,bis:!El.value.bis,roles:!El.value.roles,mapping:!El.value.mapping,weekCorrection:!El.value.weekCorrection,playerCorrection:!El.value.playerCorrection,settings:!El.value.settings})},{default:p(()=>[...u[185]||(u[185]=[f(" 反选 ",-1)])]),_:1})])]),c(m(we),{modelValue:El.value.loot,"onUpdate:modelValue":u[68]||(u[68]=e=>El.value.loot=e)},{default:p(()=>[f(i(_)+" ("+i(cl.value.length)+") ",1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.roles,"onUpdate:modelValue":u[69]||(u[69]=e=>El.value.roles=e)},{default:p(()=>[f(i(J),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.bis,"onUpdate:modelValue":u[70]||(u[70]=e=>El.value.bis=e)},{default:p(()=>[f(i(K),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.mapping,"onUpdate:modelValue":u[71]||(u[71]=e=>El.value.mapping=e)},{default:p(()=>[f(i(X),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.weekCorrection,"onUpdate:modelValue":u[72]||(u[72]=e=>El.value.weekCorrection=e)},{default:p(()=>[f(i(G),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.playerCorrection,"onUpdate:modelValue":u[73]||(u[73]=e=>El.value.playerCorrection=e)},{default:p(()=>[f(i(Le),1)]),_:1},8,["modelValue"]),c(m(we),{modelValue:El.value.settings,"onUpdate:modelValue":u[74]||(u[74]=e=>El.value.settings=e)},{default:p(()=>[f(i(Ae)+" (重置) ",1)]),_:1},8,["modelValue"])])):r("",!0),v("div",hn,[c(b,null,{default:p(()=>[c(m(q))]),_:1}),u[187]||(u[187]=v("span",null,"选中的数据将被永久删除，无法撤销。",-1))])]),_:1},8,["modelValue"]),c(m(Q),{modelValue:fl.value,"onUpdate:modelValue":u[81]||(u[81]=e=>fl.value=e),title:"手动添加记录",width:"400px","append-to-body":"","destroy-on-close":""},{footer:p(()=>[v("span",bn,[c(w,{onClick:u[80]||(u[80]=e=>fl.value=!1)},{default:p(()=>[...u[190]||(u[190]=[f("取消",-1)])]),_:1}),c(w,{type:"primary",onClick:Ui},{default:p(()=>[...u[191]||(u[191]=[f("确定添加",-1)])]),_:1})])]),default:p(()=>[fl.value?(t(),y(m(ze),{key:0,"label-width":"80px"},{default:p(()=>[c(m(Me),{label:"时间"},{default:p(()=>[c(C,{modelValue:Sl.value.timestamp,"onUpdate:modelValue":u[77]||(u[77]=e=>Sl.value.timestamp=e),type:"datetime",placeholder:"选择获得时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(m(Me),{label:"物品"},{default:p(()=>[c(m(Ue),{modelValue:Sl.value.item,"onUpdate:modelValue":u[78]||(u[78]=e=>Sl.value.item=e),"fetch-suggestions":zi,placeholder:"请输入物品名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(m(Me),{label:"获得者"},{default:p(()=>[c(m(Ue),{modelValue:Sl.value.player,"onUpdate:modelValue":u[79]||(u[79]=e=>Sl.value.player=e),"fetch-suggestions":Mi,placeholder:"请输入玩家名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})):r("",!0)]),_:1},8,["modelValue"]),c(m(Q),{modelValue:Ll.value,"onUpdate:modelValue":u[85]||(u[85]=e=>Ll.value=e),title:"自定义修正管理",width:"850px","append-to-body":"","destroy-on-close":"",class:"premium-correction-dialog"},{default:p(()=>[Ll.value?(t(),s("div",wn,[v("div",_n,[v("div",{class:n(["nav-item",{active:"player"===jl.value}]),onClick:u[82]||(u[82]=e=>jl.value="player")},[v("div",Cn,[c(b,null,{default:p(()=>[c(m(N))]),_:1})]),v("div",Vn,[u[192]||(u[192]=v("div",{class:"nav-title"}," 获得者修正 ",-1)),v("div",Sn,i(Nl.value.length)+" 个条目 ",1)])],2),v("div",{class:n(["nav-item",{active:"week"===jl.value}]),onClick:u[83]||(u[83]=e=>jl.value="week")},[v("div",xn,[c(b,null,{default:p(()=>[c(m(Oe))]),_:1})]),v("div",En,[u[193]||(u[193]=v("div",{class:"nav-title"}," CD周数修正 ",-1)),v("div",$n,i(Fl.value.length)+" 个条目 ",1)])],2),v("div",Bn,[c(Qe,{modelValue:Al.value,"onUpdate:modelValue":u[84]||(u[84]=e=>Al.value=e),placeholder:"搜索内容...","prefix-icon":"Search",size:"small",clearable:""},null,8,["modelValue"])])]),v("div",Tn,[v("div",On,[v("h3",null,i("player"===jl.value?"获得者修正管理":"CD周数修正管理"),1),u[194]||(u[194]=v("p",null,"可以撤销手动进行的改动，恢复最原始的系统记录。",-1))]),v("div",Rn,[(t(!0),s(g,null,h("player"===jl.value?Nl.value:Fl.value,e=>(t(),s("div",{key:e.key,class:"correction-card-compact"},[v("div",Dn,[v("div",zn,[v("div",{class:"item-name",title:e.itemName},i(e.itemName),9,Mn),v("div",Un,i(Hi(e.record.timestamp)),1)]),v("div",Pn,[v("div",Ln,[v("div",An,["player"===jl.value?(t(),y(bl,{key:0,name:e.oldVal,role:Bi(e.oldVal),"show-only-role":!1},null,8,["name","role"])):(t(),s("span",jn,i(e.oldVal),1))])]),v("div",Wn,[c(b,null,{default:p(()=>[c(m(Z))]),_:1})]),v("div",Nn,[v("div",Fn,["player"===jl.value?(t(),y(bl,{key:0,name:e.newVal,role:Bi(e.newVal),"show-only-role":!1},null,8,["name","role"])):(t(),s("span",In,i(e.newVal),1))])])]),v("div",Yn,[c(w,{type:"primary",link:"",size:"small",onClick:l=>function(e){if("player"===e.type){const l={...Ol.value};delete l[e.key],Ol.value=l}else{const l={...Tl.value};delete l[e.key],Tl.value=l}ee.success("已还原该条修正项")}(e)},{default:p(()=>[c(b,null,{default:p(()=>[c(m(de))]),_:1}),u[195]||(u[195]=f(" 还原 ",-1))]),_:1},8,["onClick"])])])]))),128)),0===("player"===jl.value?Nl.value:Fl.value).length?(t(),s("div",Jn,[c(b,{class:"empty-icon"},{default:p(()=>[c(m(De))]),_:1}),u[196]||(u[196]=v("p",null,"暂无符合条件的修正项",-1))])):r("",!0)])])])):r("",!0)]),_:1},8,["modelValue"])],64)),v("input",{ref_key:"importInputRef",ref:Pi,type:"file",accept:".json",style:{display:"none"},onChange:Ii},null,544)],2)}}}),[["__scopeId","data-v-1cb48be7"]]);export{Kn as default};
