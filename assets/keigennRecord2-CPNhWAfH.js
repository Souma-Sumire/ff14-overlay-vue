import{_ as e,e as t}from"./shared-common-DIre_LNG.js";import{h as a,g as n,a as s,e as o,b as i,c as r,n as l,t as c,f as d,d as u,y as m,z as p,F as f,G as v,r as g,cO as y,x as h,dx as b,w as k,dz as w,b2 as j,D as I,s as $,u as D,cj as R,b9 as C,o as N,j as _,l as E,p as x,v as A,i as S,bW as T,J as M,ch as L}from"./vendor-vue-i6lpFrx4.js";import{U as z,ac as F,r as H,s as P,ad as K,u as O,w as G,a9 as W,f as B,$ as J,ae as Z,a7 as U,t as V,Z as q,l as X,af as Y,ag as Q,ah as ee,ai as te,aj as ae,A as ne,ak as se}from"./shared-core-D87P9W7_.js";import{t as oe,J as ie,aC as re,b as le,a as ce,E as de,aD as ue,aE as me,w as pe,g as fe,aF as ve,aG as ge,n as ye}from"./vendor-element-plus-DxZgBX3C.js";import{N as he,a as be,l as ke}from"./cactbot-DtpbXwrG.js";const we={class:"amount"},je={class:"row-info"},Ie=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:g,shield:y,source:h,type:b}=t.row,k=Math.round(v*+y/100),w=Math.round(g/v*100),j=t.row.reduction,I=(a&&Math.round((a+k)/(1-j))||0).toLocaleString(),$=a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString(),D=b;return(e,t)=>{const a=oe,v=ie;return s(),n(v,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:o(()=>[i("span",we,[i("span",{class:p(d(D))},c(d($)),3)])]),default:o(()=>[i("ul",je,[i("li",null,c(e.$t("keigennRecord.source"))+": "+c(d(h)),1),i("li",null,c(e.$t("keigennRecord.playerShield"))+": "+c(d(y))+"%",1),i("li",null,c(e.$t("keigennRecord.playerHp"))+": "+c(d(g).toLocaleString())+"("+c(d(w))+"%)",1),d(j)<1&&"dot"!==d(b)?(s(),r(f,{key:0},[u(a),i("li",null,c(e.$t("keigennRecord.reductionRate"))+": "+c((100*d(j)).toFixed(2))+"% ",1),i("li",null,[m(c(e.$t("keigennRecord.originalDamage"))+": ",1),i("span",{class:p(d(D))},c(d(I)),3)])],64)):l("",!0)])]),_:1})}}}),[["__scopeId","data-v-6d7269b5"]]),$e={class:"subtitle"},De={class:"skill-grid"},Re=["title"],Ce=["src"],Ne={class:"skill-text"},_e={class:"subtitle"},Ee={class:"skill-grid"},xe=["title"],Ae=["src"],Se={key:2,class:"no-data"},Te=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=v(()=>y(t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[])),m=v(()=>y(t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>z.enumSortMethod(e.ownerJob,t.ownerJob))??[]));function p(e){const t=z.jobEnumToJob(e);return z.jobToFullName(t).simple2||""}const h={modifiers:[{name:"preventOverflow",options:{padding:24}}]};return(e,t)=>{const v=le,y=oe,b=ie;return s(),n(b,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover",transition:"none","show-after":0,"hide-after":0,"popper-options":h},{reference:o(()=>[u(v,{class:"view-icon"},{default:o(()=>[u(d(re))]),_:1})]),default:o(()=>[d(a).length>0?(s(),r(f,{key:0},[i("div",$e,c(e.$t("keigennRecord.coolingDown")),1),i("div",De,[(s(!0),r(f,null,g(d(a),e=>(s(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Ce),t[0]||(t[0]=i("div",{class:"skill-overlay"},null,-1)),i("span",Ne,c(e.recastLeft),1)],8,Re)]))),128))])],64)):l("",!0),d(m).length>0?(s(),r(f,{key:1},[d(a).length>0?(s(),n(y,{key:0})):l("",!0),i("div",_e,c(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),i("div",Ee,[(s(!0),r(f,null,g(d(m),e=>(s(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Ae)],8,xe)]))),128))])],64)):l("",!0),0===d(a).length&&0===d(m).length?(s(),r("div",Se,c(e.$t("keigennRecord.noData")),1)):l("",!0)]),_:1})}}}),[["__scopeId","data-v-d1f9fd8f"]]),Me={key:0},Le={key:1,class:"status-container"},ze=["title","data-duration","data-sourcePov"],Fe=["src","alt"],He={class:"flags"},Pe=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=F(),n=a.userOptions,o=a.icon4k;return(e,a)=>"dot"===t.row.type?(s(),r("div",Me,c(e.$t("keigennRecord.noSupport")),1)):(s(),r("div",Le,[(s(!0),r(f,null,g(t.row.keigenns,(e,l)=>(s(),r("span",{key:l},[i("span",{class:"status",title:`${d(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[i("img",{class:p(`statusIcon ${d(K)(e,t.row.type)}`),src:d(P)(`/i/${e.fullIcon}${d(o)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>d(H)&&d(H)(...e))},null,42,Fe)],8,ze)]))),128)),i("span",He,c("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),Ke={class:"target"},Oe=["src","alt"],Ge={key:1,class:"alt-text"},We={key:2,class:"has-duplicate"},Be=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=F(),n=h(!1);function o(e){n.value=!0;e.target.style.display="none"}const i=v(()=>!n.value&&"icon"===(a.userOptions.targetType??"icon"));return(e,n)=>{return s(),r("div",Ke,[d(i)?(s(),r("img",{key:0,class:p(`${d(a).isBrowser?"browser":"act"} jobIcon cj${d(a).userOptions.iconType}`),src:(u=t.row.jobIcon,m=d(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${m}/${u.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:o},null,42,Oe)):(s(),r("span",Ge,c(t.row.job),1)),t.row.hasDuplicate?(s(),r("span",We,c(d(a).formatterName(t.row.target)),1)):l("",!0)]);var u,m}}}),[["__scopeId","data-v-0700f4bb"]]),Je={class:"table-container"},Ze={class:"table-wrapper"},Ue=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=O(),a=e,n=F(),m=n.userOptions,p=b("contextMenu"),f=h(""),g=h(""),y=h(null);k(()=>a.rows,e=>{0===e.length&&(f.value="",g.value="",y.value=null)},{immediate:!0});const D=h(!1),R=h(0),C=h(0),N=h(null);w(p,()=>{D.value=!1});const _=t("keigennRecord.cancelFilter"),E=v(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey]))).filter(e=>null!=e);return[{label:_,value:""},...e.map(e=>({label:e,value:e}))]}),x=v(()=>{const e=Array.from(new Map(a.rows.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:_,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>z.enumSortMethod(e.job,t.job))});function A(){if(N.value){const e=N.value[a.actionKey];f.value===e?f.value="":f.value=e,D.value=!1}}function S(){if(N.value){const e=N.value.targetId;g.value===e?g.value="":g.value=e,D.value=!1}}function T(e){const t=e&&"object"==typeof e&&"key"in e?e:N.value;if(t&&"death"===t.type){g.value=t.targetId;const e=t.timestamp;y.value={endTime:e,windowBase:e-15e3,startTime:e-3e4},f.value="",D.value=!1}}function M(){y.value=null,g.value=""}const L=v(()=>{if(y.value){const e=g.value,{startTime:t,endTime:n,windowBase:s}=y.value,o=a.rows.filter(t=>t.targetId===e&&t.timestamp<=n),i=o.filter(e=>e.timestamp>=s);if(i.filter(e=>"death"!==e.type).length>=5)return i;const r=o.filter(e=>e.timestamp>=t),l=r.filter(e=>"death"!==e.type);if(l.length>=5){const e=l[4].timestamp;return r.filter(t=>t.timestamp>=e)}return r}return a.rows.filter(e=>{const t=!f.value||f.value===_||e[a.actionKey]===f.value,n=!g.value||g.value===_||e.targetId===g.value;return t&&n})}),H=new Map;function P(e){const t=Math.round(100*e)/100;if(H.has(t))return H.get(t);const a=[88,88,88],n=[50,250,200],s=Math.min(1,t/.5),o=Math.min(9,Math.floor(10*s))/9,i=Math.pow(o,.8),r=a[0]+(n[0]-a[0])*i,l=a[1]+(n[1]-a[1])*i,c=a[2]+(n[2]-a[2])*i,d=`rgba(${Math.round(r)}, ${Math.round(l)}, ${Math.round(c)}, 1)`;return H.set(t,d),d}const K=({rowData:e})=>"death"===e.type?"row-death":"",W=j([{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>I("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>I("div",{class:"header-filter"},[I(ce,{size:"small",modelValue:f.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>f.value=e===_?"":e},()=>E.value.map(e=>I(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source,a=null!==y.value;return I("div",{class:"death-message-left"},[I("span","ðŸ’€ "),I("span",{class:"death-target-name"},e.target||"çŽ©å®¶"),I("span",t?[I("span"," å›  "),I("span",{class:"death-terrain"},"åœ°å½¢æ€"),I("span"," å€’ä¸‹äº†ï¼")]:[I("span"," è¢« "),I("span",{class:"death-source-name"},e.source||"çŽ¯å¢ƒ"),I("span"," åšæŽ‰äº†ï¼")]),I("span",{class:"death-recap-inline",onClick:()=>{a?M():T(e)}},a?" [é€€å‡ºå›žæ”¾]":" [æŸ¥çœ‹æ­»äº¡å›žæ”¾]")])}return I("span",e[a.actionKey]??"")}},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>I("div",{class:"header-filter"},[I(ce,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{g.value=e===_?"":e}},()=>x.value.map(e=>I(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>"death"===e.type?I("div"):I(Be,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>"death"===e.type?I("div"):I(Ie,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>I("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>"death"===e.type?I("div"):I("span",{class:"col-reduction-number",style:{color:P(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>"death"===e.type?I("div"):I(Pe,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>I("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},I("div",{style:{position:"absolute",right:"0px",zIndex:5}},"death"===e.type?void 0:I(Te,{row:e})))}]);let B=null;const J=v(()=>({onClick:({rowData:e})=>{const a=null!==y.value;if("death"===e.type)return void(a?M():T(e));const{actionCN:n,amount:s,job:o,keigenns:i,time:r,type:l,effect:c,currentHp:d,maxHp:u,shield:p,reduction:f}=e,v="damage done"===c?"":`,${t(`keigennRecord.${c}`)}`,g=`${r} ${o} ${n} ${s.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*f).toFixed(0)}%):${0===i.length&&""===v?t("keigennRecord.none"):i.map(e=>m.statusCN?e.name:e.effect).join(",")+v} ${t("keigennRecord.hp")}}:${d}(${Math.round(d/u*100)}%)+${t("keigennRecord.shield")}:${Math.round(u*+p/100)}(${p}%)`;G(g).then(()=>{B?.close(),B=fe.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>fe.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const a=t;N.value=e,R.value=a.clientX,C.value=a.clientY,D.value=!0}}));return(a,m)=>{const v=pe,y=me,h=ue;return s(),r("div",Je,[i("div",Ze,[u(h,{style:{height:"100%",width:"100%"}},{default:o(({height:m,width:h})=>[u(y,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:d(W),data:L.value,width:h,height:m,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":J.value,"row-class":K},{empty:o(()=>[u(v,{description:d(n).isBrowser?a.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["columns","data","width","height","row-event-handlers"]),d(D)?(s(),r("div",{key:0,ref_key:"contextMenu",ref:p,class:"context-menu",style:$({top:`${d(C)}px`,left:`${d(R)}px`})},[i("ul",null,[i("li",{onClick:A},c(d(f)===(d(N)?.[e.actionKey]??"")?d(t)("keigennRecord.filter.action_cancel",{actionName:d(N)?.[e.actionKey]??d(t)("keigennRecord.this_skill")}):d(t)("keigennRecord.filter.action_only",{actionName:d(N)?.[e.actionKey]??d(t)("keigennRecord.this_skill")})),1),i("li",{onClick:S},c(d(g)===d(N)?.targetId?d(t)("keigennRecord.filter.target_cancel",{jobName:d(N)?.job??d(t)("keigennRecord.this_job")}):d(t)("keigennRecord.filter.target_only",{jobName:d(N)?.job??d(t)("keigennRecord.this_job")})),1)])],4)):l("",!0)]),_:1})])])}}}),[["__scopeId","data-v-eec02fde"]]),Ve={class:"header-select"},qe={style:{height:"100%"}},Xe={key:0,class:"testLog"},Ye=e(a({__name:"keigennRecord2",setup(e){const a=B();O();const c=F(),b=c.userOptions;c.checkIsBrowser();const w=h(b.minimize),I=v(()=>b.actionCN?"actionCN":"action"),H=h(!1),P=D("keigenn-record-2-pov-id",""),K=D("keigenn-record-2-party-list",[]),G=D("keigenn-record-2-job-map",{}),oe=D("keigenn-record-2-party-event-party",[]),ie=D("souma-keigenn-record-2-rsv-data",{}),re={povId:R(P.value),partyLogList:R(K.value),entitiesMap:R(G.value),partyEventParty:R(oe.value),rsvData:R(ie.value)};function le(e,t){k(t,t=>{re[e]=R(t)},{flush:"sync"})}le("povId",P),le("partyLogList",K),le("entitiesMap",G),le("partyEventParty",oe),le("rsvData",ie);let ue=0;const me=h(0),pe=j([{zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}]),fe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:he.ability(),statusEffectExplicit:he.statusEffectExplicit(),gainsEffect:he.gainsEffect(),losesEffect:he.losesEffect(),death:he.wasDefeated(),changeZone:he.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:he.addedCombatant(),removingCombatant:he.removingCombatant(),networkDoT:he.networkDoT()},we=h(0),je=D("souma-keigenn-record-2-zone-name",""),Ie={},$e={friendly:{},enemy:{}},De=W.filter(e=>1===e.line||2===e.line);let Re={};const Ce=J("keigenn-record-2"),Ne=new Map;function _e(){H.value=!0,we.value=0,Re={},me.value=0,pe.value.length=0,pe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1})}async function Ee(){H.value=!1,null!==Me&&(cancelAnimationFrame(Me),Me=null,Te.length>0&&(pe.value[0].table.unshift(...Te.reverse()),Te=[])),await Pe(),L(pe)}function xe(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!fe.gainsEffect.exec(e))return;const t=a[ke.GainsEffect.fields.effectId],n=a[ke.GainsEffect.fields.effect],s=a[ke.GainsEffect.fields.target],o=a[ke.GainsEffect.fields.targetId],i=Number.parseInt(a[ke.GainsEffect.fields.count],16);let r=ee(t);if(!r){const e=o.startsWith("1")&&te.get(Number.parseInt(t,16).toString())||o.startsWith("4")&&ae.get(Number.parseInt(t,16).toString());if(!e)return;const a=ne(e.icon),n=i>1?se(a,i):a;r={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const l=a[ke.GainsEffect.fields.duration],c=a[ke.GainsEffect.fields.source],d=a[ke.GainsEffect.fields.sourceId],u=new Date(a[ke.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),m={name:r.name,type:r.type,count:i,effect:n,effectId:t,source:c,sourceId:d,target:s,targetId:o,expirationTimestamp:u,performance:r.performance,fullIcon:r.fullIcon,isPov:re.povId===d};o.startsWith("1")&&r.isFriendly?(void 0===$e.friendly[o]&&($e.friendly[o]={}),$e.friendly[o][t]=m):o.startsWith("4")&&!r.isFriendly&&(void 0===$e.enemy[s]&&($e.enemy[s]={}),$e.enemy[s][t]=m)}break;case"30":{const e=a[ke.LosesEffect.fields.target],t=a[ke.LosesEffect.fields.targetId],n=a[ke.LosesEffect.fields.effectId];t.startsWith("1")?$e.friendly[t]&&Reflect.deleteProperty($e.friendly[t],n):$e.enemy[e]&&Reflect.deleteProperty($e.enemy[e],n)}break;case"21":case"22":{if(0===we.value)return;const e=a[ke.Ability.fields.sourceId]??"???",t=a[ke.Ability.fields.id]??"???",n=new Date(a[ke.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),s=function(e){let t=Ne.get(e);if(!t){t=new Map;for(const a of De){if(a.minLevel>e)continue;const n=Z(a.id,e);t.set(n,a)}Ne.set(e,t)}return t}(re.entitiesMap[e]?.level??999);s.get(a)&&(Re[e]||(Re[e]={}),Re[e][a]=n)}const s=Y(a);if(s.isAttack&&s.amount>=0){const o=a[ke.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!o.startsWith("1"))return;if(o!==re.povId&&!re.partyLogList.includes(o)&&!re.partyEventParty.find(e=>e.id===o))return;const i=a[ke.Ability.fields.ability],r=i.match(/^_rsv_(?<id>\d+)_/);let l=i;if(r){const e=Number(r.groups?.id);l=re.rsvData[e]??i.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(l=l.replace(/unknown_.*/,"æ”»å‡»"),!1===b.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(l))return;const c=V(Number.parseInt(t,16)),d=c&&""!==c?c:l,u=Number(a[ke.Ability.fields.targetCurrentHp]),m=Number(a[ke.Ability.fields.targetMaxHp]),p=a[ke.Ability.fields.source]??"???",f=a[ke.Ability.fields.target]??"???",{effect:v,type:g}=Q(s.flags),y=Ke(0===we.value?0:n-we.value),{jobEnum:h,job:k,jobIcon:w,hasDuplicate:j}=Se(o),I=Object.values($e.friendly[o]??[]).concat(Object.values($e.enemy[p]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),$=Ie[o]??"0",D=s.amount;let R=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of I)"absorbed"!==a.type&&(t*=a.performance[g]??1);R=1-t*e}Le({key:(ue++).toString(),time:y,timestamp:n,id:t,action:l,actionCN:d,source:p,target:f,targetId:o,job:k,jobIcon:w,jobEnum:h,hasDuplicate:j,amount:D,keigenns:I,currentHp:u,maxHp:m,effect:v,type:g,shield:$,povId:re.povId,reduction:R,keySkills:He(n)}),pe.value[0].duration=Ke(new Date(a[ke.Ability.fields.timestamp]).getTime()-we.value)}}break;case"25":{const t=fe.death.exec(e);if(!t||!t.groups)return;const a=t.groups.targetId,n=t.groups.target,s="E0000000"===t.groups.sourceId?"åœ°å½¢æ€":t.groups.source,o=t.groups.timestamp;if(0===we.value)return;if(a!==re.povId&&!re.partyLogList.includes(a)&&!re.partyEventParty.find(e=>e.id===a))return;const i=new Date(o).getTime(),r=Ke(i-we.value),{jobEnum:l,job:c,jobIcon:d,hasDuplicate:u}=Se(a);Le({key:(ue++).toString(),time:r,timestamp:i,id:void 0,action:"Death",actionCN:"æ­»äº¡",source:s,target:n,targetId:a,job:c,jobIcon:d,jobEnum:l,hasDuplicate:u,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:re.povId,reduction:0,keySkills:He(i)})}break;case"34":{const t=fe.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Ie[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[ke.InCombat.fields.inACTCombat],t="1"===a[ke.InCombat.fields.inGameCombat],n=new Date(a[ke.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[ke.InCombat.fields.timestamp];if(we.value>0)return;return 0===pe.value[0].table.length&&0===Te.length||(null!==Me&&(cancelAnimationFrame(Me),Me=null),Te.length>0&&(pe.value[0].table.unshift(...Te.reverse()),Te=[]),pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:e,timestamp:n}),L(pe)),we.value=n,pe.value[0].zoneName=je.value,pe.value[0].timestamp=n,pe.value[0].key=e,void(me.value=0)}if(!e&&!t)return void ze(n)}break;case"01":{const e=parseInt(a[ke.ChangeZone.fields.id],16);if(je.value=a[ke.ChangeZone.fields.name],q[e]?.name){const t=X(q[e]?.name);t&&"Unknown"!==t&&(je.value=t)}ze(new Date(a[ke.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=fe.partyList.exec(e);t&&(K.value=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":P.value=a[ke.ChangedPlayer.fields.id];break;case"03":if("00"!==a[ke.AddedCombatant.fields.job]){const e=a[ke.AddedCombatant.fields.job],t=a[ke.AddedCombatant.fields.name],n=new Date(a[ke.AddedCombatant.fields.timestamp]).getTime(),s=parseInt(a[ke.AddedCombatant.fields.level],16);G.value[a[ke.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:s}}break;case"04":Reflect.deleteProperty(G.value,a[ke.RemovedCombatant.fields.id]),Reflect.deleteProperty($e.friendly,a[ke.RemovedCombatant.fields.id]),Reflect.deleteProperty($e.enemy,a[ke.RemovedCombatant.fields.id]);break;case"262":{const t=fe.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[ke.RSVData.fields.value];e&&n&&(ie.value[Number(e)]=n)}}break;case"37":if(!b.parseDoT)return;{const e=a[ke.NetworkDoT.fields.which],t=a[ke.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==re.povId&&!re.partyLogList.includes(t)&&!re.partyEventParty.find(e=>e.id===t))return;const n=a[ke.NetworkDoT.fields.name],s=a[ke.NetworkDoT.fields.damage],o=Number.parseInt(s,16),i=new Date(a[ke.Ability.fields.timestamp]??"???").getTime(),r=Number(a[ke.NetworkDoT.fields.currentHp]),l=Number(a[ke.NetworkDoT.fields.maxHp]),c=Ke(0===we.value?0:i-we.value),{jobEnum:d,job:u,jobIcon:m,hasDuplicate:p}=Se(t);Le({key:(ue++).toString(),time:c,timestamp:i,id:void 0,action:e,actionCN:e,source:"",target:n,targetId:t,job:u,jobIcon:m,jobEnum:d,hasDuplicate:p,amount:o,keigenns:[],currentHp:r,maxHp:l,effect:"damage done",type:"dot",shield:Ie[t]??"0",povId:re.povId,reduction:0,keySkills:[]})}}}const Ae=new Map;function Se(e){const t=Ae.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=G.value[e],a=oe.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,s=n===t?Object.entries(G.value).some(([t,a])=>t!==e&&a.job===n?.job&&K.value.includes(t)):oe.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:s}}(e),s=a,o={jobEnum:s,job:z.jobToFullName(z.jobEnumToJob(s)).simple2,jobIcon:z.jobEnumToIcon(s),hasDuplicate:n};return Ae.set(e,o),o}let Te=[],Me=null;function Le(e){Te.push(y(e)),null===Me&&(Me=requestAnimationFrame(()=>{pe.value[0].table.unshift(...Te.reverse()),Te=[],Me=null}))}function ze(e){0!==we.value&&(pe.value[0].duration=Ke(e-we.value),pe.value[0]=y(pe.value[0]),we.value=0,$e.friendly={},$e.enemy={},Re={},Ae.clear(),Pe())}const Fe=v(()=>{const e=new Set;oe.value.forEach(t=>e.add(t.id)),K.value.forEach(t=>e.add(t)),P.value&&e.add(P.value);const t=[];for(const n of e){const e=oe.value.find(e=>e.id===n);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const a=G.value[n];a&&t.push({id:n,job:a.job,name:a.name??"Unknown",level:a.level})}const a=new Map;return t.forEach(e=>{a.set(e.job,(a.get(e.job)||0)+1)}),t.flatMap(e=>{const t=e.level||999,n=(a.get(e.job)||0)>1;return De.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const s=Z(a.id,t),o=Z(a.recast1000ms,t);return{id:s,name:V(s)||"Unknown",icon:U(s),recast1000ms:o,ownerId:e.id,ownerName:e.name,ownerJob:e.job,hasDuplicate:n}})})});function He(e){return Fe.value.map(t=>{const a=Re[t.ownerId]?.[t.id]??0;let n=!0,s=0;if(a>0){const o=e-a,i=1e3*t.recast1000ms;o<i&&(n=!1,s=Math.ceil((i-o)/1e3))}return{...t,recastLeft:s,ready:n}})}async function Pe(){if(H.value)return;const e=pe.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?R(e.table):[];return{...R(e),table:t}});await Ce.replaceAll(e)}function Ke(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Oe(){w.value=!w.value}function Ge(){pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:"test",timestamp:Date.now()}),L(pe),me.value=0}function We(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return N(()=>{const e=_({storageKey:"keigenn-record-2-theme"}),t=E(e);!1===e.value&&t();for(const a in G.value){const e=G.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(G.value,a)}!async function(){me.value=0;try{const e=await Ce.getAll();if(e.length){pe.value.length=0;const t=e.filter(e=>e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp).reverse().map(e=>({...e,table:M(Array.isArray(e.table)?[...e.table]:[])}));pe.value.push(...t),0===pe.value.length&&pe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}),L(pe)}}catch(e){throw pe.value.length=0,e}}(),be("LogLine",e=>{xe(e.rawLine)}),be("PartyChanged",e=>{oe.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),be("ChangePrimaryPlayer",e=>{P.value=Number(e.charID).toString(16).toUpperCase()}),be("CombatData",e=>{if(!(we.value>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(je.value=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==pe.value[0].table.length&&(pe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:String(n),timestamp:n}),L(pe)),pe.value[0].zoneName=je.value,we.value=n,pe.value[0].timestamp=n,pe.value[0].key=String(n),me.value=0}})}),(e,v)=>{const y=de,h=ce,k=ye,j=Ue,D=t;return s(),r(f,null,[i("div",{class:"wrapper",style:$({"--scale":d(b).scale,"--opacity":d(b).opacity}),onContextmenu:v[1]||(v[1]=T(()=>{},["prevent"]))},[i("header",null,[i("div",Ve,[x(u(h,{modelValue:d(me),"onUpdate:modelValue":v[0]||(v[0]=e=>S(me)?me.value=e:null),size:"small",class:p(["combat-select",d(c).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:o(()=>[(s(!0),r(f,null,g(d(pe).length,e=>(s(),n(y,{key:`${d(pe)[e-1].key}-${d(pe)[e-1].duration}-${d(pe)[e-1].zoneName}`,value:e-1,label:`${d(pe)[e-1].zoneName}${""===d(pe)[e-1].zoneName?"":` - [${d(pe)[e-1].duration}] ${We(d(pe)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[A,!d(w)]])]),d(c).isBrowser?l("",!0):(s(),n(k,{key:0,class:p(["minimize",d(w)?"in-minimize":"not-minimize"]),icon:d(w)?d(ve):d(ge),circle:"",style:$({opacity:d(w)?.5:1}),onClick:Oe},null,8,["class","icon","style"]))]),x(i("main",qe,[u(j,{rows:d(pe)[d(me)].table,"action-key":d(I)},null,8,["rows","action-key"])],512),[[A,!d(w)]])],36),d(c).isBrowser||d(a)?(s(),r("div",Xe,[d(a)?(s(),n(k,{key:0,onClick:Ge},{default:o(()=>[...v[2]||(v[2]=[m(" æµ‹è¯• ",-1)])]),_:1})):l("",!0),u(D,{"m-1":"",onBeforeHandle:_e,onAfterHandle:Ee,onHandleLine:xe})])):l("",!0)],64)}}}),[["__scopeId","data-v-f503bfea"]]);export{Ye as default};
