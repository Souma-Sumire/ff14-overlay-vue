const t=new URLSearchParams(window.location.href.split("?")[1]).get("api"),e="cafemaker.wakingsands.com",n="xivapi.com",r=new Map,o={first:`https://${"xivapi"===t?.toLowerCase()?n:e}`,second:`https://${"xivapi"===t?.toLowerCase()?e:n}`},c={get random(){return Math.floor(864e5*Math.random()*11)+216e7}},a=new Map(Object.entries({"任务指令":"/i/000000/000123.png","冲刺":"/i/000000/000104.png","坐骑":"/i/000000/000118.png","攻击":"/i/000000/000101.png","腐秽大地":"/i/003000/003090.png"})),s="souma-action-cache",i=JSON.parse(localStorage.getItem(s)||"[]"),g=Date.now(),p=i.filter((t,e)=>t.expirationTime>=g&&e<1e3);localStorage.setItem(s,JSON.stringify(p));const f=/(\d{6})\/(\d{6})\.png$/;async function m(t,e,n=["ID","Icon","ActionCategoryTargetID"]){if(r.has(e))return r.get(e);const c=function(t,e,n){const r=`${o.first}/${t}/${e}?columns=${n.join(",")}`;return[r,r.replace(o.first,o.second)]}(t,e,n);try{const t=await d(c,{mode:"cors"});return r.set(e,t),t}catch(a){return Promise.resolve({ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"})}}async function u(t,e=!1){return`${o.first}${t}`.replace(f,(t,n,r)=>`${n}/${e?"hq/":""}${r}.png`)}async function l(t){return u((await m("action",t,["Icon"])).Icon)}async function h(t){const n=a.get(t);if(n)return{ActionCategoryTargetID:0,ID:0,Icon:n};const r=i.find(e=>e.name===t);if(r?.action)return r.action;try{const n=(await d([`https://${e}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).Results[0];if(n){const e=Date.now()+c.random,r={name:t,action:n,expirationTime:e};return i.push(r),localStorage.setItem(s,JSON.stringify(i)),n}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(o){throw new Error("Failed to retrieve action data")}}async function w(t,e){let n;const r=new Promise((t,r)=>{n=setTimeout(()=>{r(new Error("Promise timed out"))},e)});return Promise.race([t,r]).finally(()=>{clearTimeout(n)})}async function d(t,e){const n=Object.assign({cache:"force-cache"},e);for(const r of t)try{const t=await w(fetch(r,n),3e3);if(t.ok){const e=await t.json(),n=new URL(r).host;return{...e,Host:n}}}catch{}throw new Error("All fetch attempts failed.")}const $=new Map;function I(t){return $.has(t)?$.get(t):`${o.first}${t}`}function y(t){const e=t.target,n=e.src.match(new RegExp("(?<=\\.\\w+)\\/.+$"))?.[0];n&&""!==e.src&&(/pictomancer\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(e.src)?e.src="//souma.diemoe.net/resources/img/viper.png":e.src.includes(o.first)?e.src=e.src.replace(o.first,o.second):e.src="",$.set(n,e.src))}export{h as a,u as b,l as c,r as d,I as g,y as h,m as p,o as s};
