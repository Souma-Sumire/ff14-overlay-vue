import{M as e,V as t,g as a}from"./mapCoordinates-D6Cs2O2e.js";import{Z as n}from"./zoneInfo-Kvs06RCG.js";import{g as r}from"./contentFinderCondition-BIZz1N_J.js";import{d as s,h as l,r as o,i,B as u,c,o as p,G as f,q as v,F as m,m as y,s as d,t as h,k as g,u as k}from"./index-DtMP2P0p.js";import{_ as b}from"./_plugin-vue_export-helper-BCo6x5W8.js";const w=["src"],x=b(s({__name:"MapCanvas",props:{mapId:{type:Number,required:!0},markers:{type:Array,required:!0},size:{type:Number,default:180},forceTerritoryType:{type:Number,default:void 0}},setup(s){const g=s,k=l(()=>{if(0===g.mapId&&!g.forceTerritoryType)return;const t=g.forceTerritoryType??r(g.mapId),a=e[t.toString()];return a?`https://v2.xivapi.com/api/asset/map/${a.id}`:void 0});function b(e){const s=g.forceTerritoryType??r(g.mapId),l=n[s]??{sizeFactor:100,offsetX:0,offsetY:0},o=new t(e.x,e.z),i=new t(l.offsetX,l.offsetY);return a(o,i,l.sizeFactor)}const x=o(0),I=o(0),z=o(.5),M=o(16),D=o(!1);let T=0,A=0;function _(e){e.preventDefault(),D.value=!0,T=e.clientX-x.value,A=e.clientY-I.value}function F(e){e.preventDefault(),D.value&&(x.value=e.clientX-T,I.value=e.clientY-A)}function $(e){e.preventDefault(),D.value=!1}function C(e){e.preventDefault();const t=e.deltaY>0?.9:1.1;let a=z.value*t;a=Math.min(4,Math.max(.2,a));const n=e.currentTarget.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top;x.value=r-(r-x.value)*a/z.value,I.value=s-(s-I.value)*a/z.value,z.value=a}function U(e){const t=b(e),a=Math.max(1/z.value*M.value,M.value);return{"--left":`${t.x}px`,"--top":`${t.y}px`,"--font-size":`${a}px`}}const B=l(()=>({width:`${g.size}px`,height:`${g.size}px`,overflow:"hidden",position:"relative",cursor:D.value?"grabbing":"grab",userSelect:"none"})),V=l(()=>({transform:`translate(${x.value}px, ${I.value}px) scale(${z.value})`,transformOrigin:"top left",width:"2048px",height:"2048px",position:"absolute",left:0,top:0})),Y=o(null),j=o(!1);return i(()=>{const e=new IntersectionObserver(t=>{t[0]?.isIntersecting&&(j.value=!0,e.disconnect())},{rootMargin:"200px"});Y.value&&e.observe(Y.value)}),u(()=>g.markers,()=>{const e=g.markers.filter(e=>e.active);if(0===e.length)return z.value=.5,x.value=g.size/2-1024*z.value,void(I.value=g.size/2-1024*z.value);const t=e.reduce((e,t)=>{const a=b(t);return e.x+=a.x,e.y+=a.y,e},{x:0,y:0});t.x/=e.length,t.y/=e.length;let a=1/0,n=-1/0,r=1/0,s=-1/0;for(const p of e){const e=b(p);a=Math.min(a,e.x),n=Math.max(n,e.x),r=Math.min(r,e.y),s=Math.max(s,e.y)}const l=n-a,o=s-r,i=g.size/l,u=g.size/o;let c=Math.min(i,u);c=Math.min(1,Math.max(.5,.5*c)),z.value=c,x.value=g.size/2-t.x*z.value,I.value=g.size/2-t.y*z.value},{immediate:!0,deep:!0}),(e,t)=>(p(),c("div",{ref_key:"containerRef",ref:Y,class:"crop-custom",style:v(B.value),onMousedown:_,onMousemove:F,onMouseup:$,onMouseleave:$,onWheel:C},[j.value?(p(),c("div",{key:0,class:"crop-1024",style:v(V.value)},[k.value?(p(),c("img",{key:0,src:k.value,alt:""},null,8,w)):f("",!0),(p(!0),c(m,null,y(s.markers,e=>(p(),c("span",{key:e.key,class:d(`markIcon markIcon${e.key}`),style:v([U(e)])},h(e.active?e.label:""),7))),128))],4)):f("",!0)],36))}}),[["__scopeId","data-v-c4e50d24"]]),I=(e,t=49)=>e.map(e=>e^t),z=[{key:"A",label:"A",bit:1,id:0},{key:"B",label:"B",bit:2,id:1},{key:"C",label:"C",bit:4,id:2},{key:"D",label:"D",bit:8,id:3},{key:"One",label:"1",bit:16,id:4},{key:"Two",label:"2",bit:32,id:5},{key:"Three",label:"3",bit:64,id:6},{key:"Four",label:"4",bit:128,id:7}];async function M(e){const t=new Uint8Array(e),a=new DataView(t.buffer);if(t.length<16)throw new Error("File too small");const n=a.getInt32(8,!0),r=I(t.slice(16,16+n)),s=new DataView(r.buffer);let l=16;const o=[];let i=new Uint8Array(0),u=new Uint8Array(0);const c=[];for(;l<r.length-2;){const e=s.getInt16(l,!0),t=s.getInt32(l+8,!0),a=r.slice(l+16,l+16+t),n=r.slice(l,l+16+t+4);if(17===e){i=a.slice(0,16);for(let e=16;e+104<=a.length;e+=104){const t=new DataView(a.buffer,a.byteOffset+e,104),n={enableFlag:a[e+96]??0,unknown:a[e+97]??0,regionID:t.getUint16(98,!0),timestamp:t.getInt32(100,!0)};z.forEach((e,a)=>{n[e.key]={x:t.getInt32(12*a,!0),y:t.getInt32(12*a+4,!0),z:t.getInt32(12*a+8,!0)}}),o.push(n)}u=a.slice(104*o.length+16)}else c.push(n);l+=16+t+4}if(0===o.length)throw new Error("No waymark data found in UISAVE.DAT");const p=new Uint8Array(c.reduce((e,t)=>e+t.length,0));let f=0;return c.forEach(e=>{p.set(e,f),f+=e.length}),{fileFormatVersion:t.slice(0,8),fileUnknown:t.slice(12,16),payloadUnknown:r.slice(0,8),userID:s.getBigInt64(8,!0),wayMarks:o,markerHeader:i,markerTail:u,otherSections:p}}const D=s({__name:"WaymarkDisplay",props:{waymark:{},size:{}},setup(e){const t=e,a=t.size??180,n=["A","B","C","D","1","2","3","4"],r=[1,2,4,8,16,32,64,128];const s=l(()=>["A","B","C","D","One","Two","Three","Four"].map((e,a)=>{const s=t.waymark[e];return{key:e,label:n[a]??"",x:s.x/1e3,z:s.z/1e3,active:(l=a,0!==((t.waymark?.enableFlag??0)&(r[l]??0)))};var l}));return(t,n)=>(p(),g(x,{"map-id":e.waymark.regionID,markers:s.value,size:k(a)},null,8,["map-id","markers","size"]))}});export{x as M,D as _,z as a,M as p,I as x};
