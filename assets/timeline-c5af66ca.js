import{u as e,_ as t,p as i}from"./TimelineShow-434fdc3c.js";import"./index-21d13668.js";import{b as o,w as n,H as l}from"./element-plus-22d49fc5.js";import{a,c as s}from"./overlay_plugin_api-974cdd44.js";import{u as c}from"./index-b29bea73.js";import{t as m,V as u,r,c as d,f as p,v as f,x as g,H as y,M as v,u as T,A as b,L as h,a9 as w,K as k,G as j,J as x,D as C,E as A}from"./vue-vendor-80a2ed00.js";import{_ as S}from"./_plugin-vue_export-helper-6a8c15be.js";import"./regexes-da03e94d.js";import"./util-c5e2dd68.js";import"./xivapi-3a0d4d4e.js";const _={id:"wrapper"},O={key:0,class:"optionalTimelines"},V=["onClick"],E={key:7,style:{color:"white","background-color":"black"}},I=S(m({__name:"timeline",setup(m){const S=e(),I=u({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),B=r(0),L=r(0-S.configValues.preBattle),D=r(0);let G=!1;const N=c("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),z=new URLSearchParams(location.hash.split("?")[1]),H=r(window.location.href.match(/localhost/)||"1"===z.get("dev")),P=d(()=>I.loadedTimeline.filter(e=>e.sync)),$=d(()=>I.loadedTimeline.filter(e=>e.tts));function F(){R(),I.loadedTimeline.length=0,I.optionalTimeline.length=0;const e=S.getTimeline(N.value);1===e.length?M(e[0]):e.length>1&&(I.optionalTimeline=e,M(e[0]))}async function M(e,t=!0){I.selectedOptionalTimeline=e,t&&R(),G=!1,e?.timeline&&(I.loadedTimeline=await i(e.timeline),I.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{G=!0},1e3)}function R(){B.value=0,L.value=0-S.configValues.preBattle,D.value=0;for(const e of I.loadedTimeline)e.alertAlready=!1;for(const e of P.value)e.syncAlready=!1}function q(e,t=!0){t&&(G=!1,setTimeout(()=>{G=!0},1e3)),L.value=0,D.value=0,B.value=(new Date).getTime()+1e3*e,$.value.forEach(e=>{e.alertAlready=!1}),J()}function J(){if(0===B.value)return;L.value=((new Date).getTime()-B.value+D.value)/1e3;const e=$.value.find(e=>!e.alertAlready&&e.time-S.configValues.ttsAdvance<=L.value);e&&(e.alertAlready=!0,e.tts&&Q(e.tts)),requestAnimationFrame(J)}function K(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)q(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))R();else{const e=P.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&L.value>=e.time-e.windowBefore&&L.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,U(e.jump||e.time))}}}function U(e){0===B.value&&q(0,!1),D.value+=1e3*(e-L.value),$.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}p(()=>{a("onLogEvent",K),a("onPlayerChangedEvent",X),a("ChangeZone",Z),a("BroadcastMessage",Y),a("onInCombatChangedEvent",ee),S.loadTimelineSettings(),o({message:`${S.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),F()});const X=e=>{N.value.jobs[0]!==e.detail.job&&(N.value.jobs[0]=e.detail.job,F())},Z=e=>{N.value.zoneId=String(e.zoneID),F()};function Q(e,t=!1){e&&(G||t)&&s({call:"cactbotSay",text:e})}function W(){o.closeAll(),o({message:"弹窗测试",type:"success",duration:0,showClose:!0})}const Y=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>S.jobList.indexOf(e)-S.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");S.allTimelines=t.allTimelines,S.configValues=t.configValues,S.showStyle=t.showStyle,S.saveTimelineSettings(),o.closeAll(),o({message:"已更新数据",type:"success",duration:0,showClose:!0}),F()}"get"===e.msg.type&&function(e,t={}){s({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}("post",S.$state)}};function ee(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===B.value?q(0):e.detail.inGameCombat||e.detail.inACTCombat||R()}return(e,i)=>{const o=l,a=t;return g(),f("div",_,[T(I).optionalTimeline.length&&T(L)<=-T(S).configValues.preBattle?(g(),f("ul",O,[i[5]||(i[5]=b("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(g(!0),f(h,null,w(T(I).optionalTimeline,(e,t)=>(g(),f("li",{key:t,class:j(T(I).selectedOptionalTimeline===e?"active":""),onClick:t=>{M(e)}},[x(k(e.name)+" ",1),T(I).selectedOptionalTimeline===e?(g(),C(o,{key:0},{default:A(()=>[v(T(n))]),_:1})):y("",!0)],10,V))),128))])):y("",!0),v(a,{config:T(S).configValues,lines:T(I).loadedTimeline,runtime:T(L),"show-style":T(S).showStyle},null,8,["config","lines","runtime","show-style"]),T(H)?(g(),f("button",{key:1,onClick:i[0]||(i[0]=e=>q(30))}," 开始从-30 ")):y("",!0),T(H)?(g(),f("button",{key:2,onClick:i[1]||(i[1]=e=>q(0))}," 开始从0 ")):y("",!0),T(H)?(g(),f("button",{key:3,onClick:i[2]||(i[2]=e=>R())}," 团灭 ")):y("",!0),T(H)?(g(),f("button",{key:4,onClick:i[3]||(i[3]=e=>{U(1e3)})}," 跳转1000测试 ")):y("",!0),T(H)?(g(),f("button",{key:5,onClick:i[4]||(i[4]=e=>Q("今天天气真不错",!0))}," TTS测试 ")):y("",!0),T(H)?(g(),f("button",{key:6,onClick:W}," 弹窗测试 ")):y("",!0),T(H)?(g(),f("span",E,k(T(L)),1)):y("",!0)])}}}),[["__scopeId","data-v-80703600"]]);export{I as default};
