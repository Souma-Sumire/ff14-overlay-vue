import{c as e,a as t,b as a,_ as o}from"./shared-common-CYjYp2IA.js";import{o as s,bC as n,r as l,B as c,a5 as r,v as i,J as d,dz as u,ac as p,t as m,u as b,H as h,R as w,K as f,M as v,Z as g,I as y,Y as C,X as S,c as P}from"./vendor-vue-GqahCgpc.js";import{u as V,F as _,H as R,h as E}from"./shared-core-1WzSK5h7.js";import{N as k,a as U,r as N,k as D,l as O}from"./cactbot-CmNinDrW.js";import{a as z,n as T,a2 as x,f as B,u as A,U as L,S as M,j as W,t as F,a3 as j,a4 as I,k as Y,F as Z,G as $,b as q,g as G}from"./vendor-element-plus-DIlhOlLn.js";const H={key:0,class:"mini-mode"},K={class:"zone-info"},J={class:"zone-name-wrapper"},X={class:"zone-name"},Q={class:"rules-status"},ee=["title"],te=["title"],ae=["title"],oe=["title"],se=["title"],ne={key:1,class:"obs-status-text"},le={class:"mode-switch-container"},ce={class:"mini-mode-placeholder",style:{visibility:"hidden","pointer-events":"none"}},re={class:"zone-info"},ie={class:"zone-name-wrapper"},de={class:"zone-name"},ue={class:"zone-type"},pe={class:"rules-status"},me={class:"rule-item"},be={class:"rule-item"},he={class:"rule-item"},we={class:"rule-item"},fe={class:"rule-item"},ve={key:1,class:"obs-status-text"},ge={class:"card-header"},ye={class:"header-actions"},Ce={key:1},Se={class:"card-header"},Pe={class:"status-info"},Ve={class:"button-container"},_e={class:"card-header"},Re={class:"header-actions"},Ee={class:"profile-info"},ke={class:"append-content-toggle"},Ue={class:"card-header"},Ne={class:"header-actions"},De={key:0,class:"current-type"},Oe=o(s({__name:"obs2",setup(o){const{t:s}=V(),{zoneType:Oe}=_(),ze=n("obs-zone-name",""),Te=n("obs-user-config",{host:4455,password:"",path:"",fileName:"%CCYY-%MM-%DD %hh-%mm-%ss",appendContentName:!0},localStorage,{mergeDefaults:!0}),xe=n("obs-user-content-setting",[]),Be=E(),Ae=l(1),Le=n("obs-has-used-before",!1),Me=l(Le.value),We={inCombat:k.inCombat(),countdown:k.countdown(),countdownCancel:k.countdownCancel(),wipe:D.wipe},Fe={enter:!1,countdown:!0,countdownCancel:!0,combatStart:!0,combatEnd:!0,wipe:!0,partyLength:1,customPath:""},je={enter:!1,countdown:!1,countdownCancel:!1,combatStart:!1,combatEnd:!1,wipe:!1,partyLength:1,customPath:""};const Ie=new class{ws;status;connectingPromise=null;handleConnectionError=()=>{$e("OBS connection error"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleConnectionClosed=()=>{$e("OBS connection closed"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleRecordStateChanged=e=>{this.status.connected=!0,this.status.recording="OBS_WEBSOCKET_OUTPUT_STARTED"===e.outputState,this.status.outputActive=e.outputActive,this.status.outputPath=e.outputPath||""};constructor(){this.ws=new u,this.status=p({connecting:!1,connected:!1,recording:!1,outputActive:!1,outputPath:""}),this.ws.on("ConnectionClosed",this.handleConnectionClosed),this.ws.on("ConnectionError",this.handleConnectionError),this.ws.on("RecordStateChanged",this.handleRecordStateChanged)}async connect(){return this.status.connected?Promise.resolve():(this.connectingPromise||(this.connectingPromise=(async()=>{if($e("Connecting to OBS"),Te.value.host){this.status.connecting=!0;try{await this.ws.connect(`ws://127.0.0.1:${Te.value.host}`,Te.value.password),$e("Connected to OBS");const e=await this.ws.call("GetRecordStatus");if(this.status.recording=e.outputActive,this.status.outputActive=e.outputActive,this.status.connected=!0,!Te.value.path){const e=await this.ws.call("GetRecordDirectory");e.recordDirectory&&(Te.value.path=e.recordDirectory,xe.value.forEach(t=>{""===t.customPath&&(t.customPath=e.recordDirectory)}))}Te.value.fileName||(Te.value.fileName="%CCYY-%MM-%DD %hh-%mm-%ss"),Le.value=!0}catch(e){$e("OBS connection failed",e),z({type:"error",message:s("obs2.connection failed"),duration:1e3})}finally{this.status.connecting=!1,this.connectingPromise=null}}else z({type:"error",message:s("obs2.host required"),duration:1e3})})()),this.connectingPromise)}disconnect(){$e("Disconnecting from OBS"),this.ws.disconnect()}async startRecord(){$e("Starting recording"),await this.setProfileParameter("start"),this.ws.call("StartRecord")}async stopRecord(){return $e("Stopping recording"),await this.setProfileParameter("stop"),this.ws.call("StopRecord")}async splitRecord(){$e("Splitting recording"),await this.setProfileParameter("split"),await this.ws.call("StopRecord"),setTimeout(()=>{this.startRecord()},1e3)}async setProfileParameter(e){const t=[{requestType:"SetProfileParameter",requestData:{parameterCategory:"AdvOut",parameterName:"RecFilePath",parameterValue:"stop"===e?Te.value.path:xe.value.find(e=>e.type===Oe.value)?.customPath||Te.value.path}},{requestType:"SetProfileParameter",requestData:{parameterCategory:"Output",parameterName:"FilenameFormatting",parameterValue:"stop"===e?Te.value.fileName:Te.value.fileName+(Te.value.appendContentName?` - ${ze.value}`:"")}}];return this.ws.callBatch(t)}},Ye=e=>{$e("ChangeZone:",e),ze.value=e.zoneName,qe("enter")},Ze=e=>{const t=e.rawLine;for(const a in We){if(We[a].exec(t)){const e=t.split("|");switch(a){case"inCombat":{const t="1"===e[O.InCombat.fields.inACTCombat],a="1"===e[O.InCombat.fields.inGameCombat];if(t&&a)return void qe("combatStart");if(!t&&!a)return void qe("combatEnd");break}case"countdown":qe("countdown");break;case"countdownCancel":qe("countdownCancel");break;case"wipe":qe("wipe")}}}};function $e(...e){Be.value}function qe(e){$e();const t=xe.value.find(e=>e.type===Oe.value);if(!t)throw new Error(`Rule not found for zone type:${Oe.value}`);if(!1===t.enter&&"enter"===e&&Ie.status.recording)Ie.stopRecord();else if(t[e])switch($e(Oe.value),e){case"enter":case"countdown":case"combatStart":if(Ae.value<t.partyLength)return;if(!Ie.status.connected)return void Ie.connect()?.then(()=>{Ie.status.connected&&Ie.startRecord()});if(!1===Ie.status.recording)return void Ie.startRecord();!0===Ie.status.recording&&"combatStart"!==e&&Ie.splitRecord();break;case"countdownCancel":case"combatEnd":case"wipe":Ie.status.recording&&Ie.stopRecord()}else $e()}const Ge=e=>{$e(),Ae.value=e.party.length||1};c(()=>{Ie.connect(),U("ChangeZone",Ye),U("LogLine",Ze),U("PartyChanged",Ge),function(){const e=["Savage","Extreme","Ultimate","Chaotic","OccultCrescent","DeepDungeonExtras","Default"];if(0===xe.value.length){xe.value=[...e.map(e=>({type:e,...Fe})),...R.filter(t=>!e.includes(t)).map(e=>({type:e,...je}))];const t=xe.value.find(e=>"OccultCrescent"===e.type);t&&(t.partyLength=40)}else{xe.value=xe.value.filter(e=>R.includes(e.type));const t=R.filter(e=>!xe.value.some(t=>t.type===e)&&"Default"!==e).map(t=>e.includes(t)?{type:t,...Fe}:{type:t,...je});xe.value.push(...t)}xe.value.sort((e,t)=>R.indexOf(e.type)-R.indexOf(t.type)),xe.value=xe.value.map(t=>({...e.includes(t.type)?Fe:je,...t})),Te.value.path&&xe.value.forEach(e=>{""===e.customPath&&(e.customPath=Te.value.path)})}()}),r(()=>{Ie.disconnect(),N("ChangeZone",Ye),N("LogLine",Ze)});const He=P(()=>xe.value.find(e=>e.type===Oe.value));function Ke({row:e}){return e.type===Oe.value?"current-zone-row":""}return(o,n)=>{const l=T,c=x,r=t,u=a,p=W,P=M,V=L,_=F,R=B,E=I,k=j,U=Y,N=$,D=q,O=G,z=Z,Ae=A,Le=e;return m(),i(Le,null,{default:d(()=>[b(Me)?(m(),h("div",H,[b(Ie).status.connected?(m(),h(w,{key:0},[f("div",{class:v(["recording-dot",{"is-recording":b(Ie).status.recording}])},null,2),f("div",K,[f("div",J,[f("div",X,g(b(ze)||b(s)("obs2.Unknown")),1)])]),f("div",Q,[f("span",{class:v(["rule-item",{active:b(He)?.enter}]),title:b(s)("obs2.Enter Zone")},g(b(s)("obs2.EnterShort")),11,ee),f("span",{class:v(["rule-item",{active:b(He)?.countdown}]),title:b(s)("obs2.CountDown")},g(b(s)("obs2.CountdownShort")),11,te),f("span",{class:v(["rule-item",{active:b(He)?.combatStart}]),title:b(s)("obs2.CombatStart")},g(b(s)("obs2.CombatStartShort")),11,ae),f("span",{class:v(["rule-item",{active:b(He)?.combatEnd}]),title:b(s)("obs2.CombatEnd")},g(b(s)("obs2.CombatEndShort")),11,oe),f("span",{class:v(["rule-item",{active:b(He)?.wipe}]),title:b(s)("obs2.Wipe")},g(b(s)("obs2.WipeShort")),11,se)])],64)):(m(),h("div",ne,g(b(s)("obs2.OBS Not Connected")),1)),f("button",{class:"settings-btn",title:"展开详情",onClick:n[0]||(n[0]=e=>Me.value=!1)}," ⚙ ")])):(m(),h(w,{key:1},[f("div",le,[f("div",ce,[b(Ie).status.connected?(m(),h(w,{key:0},[n[13]||(n[13]=f("div",{class:"recording-dot"},null,-1)),f("div",re,[f("div",ie,[f("div",de,g(b(ze)||b(s)("obs2.Unknown")),1)]),f("div",ue,g(b(Oe)?`（${b(s)(`obs2.${b(Oe)}`)}）`:""),1)]),f("div",pe,[f("span",me,g(b(s)("obs2.EnterShort")),1),f("span",be,g(b(s)("obs2.CountdownShort")),1),f("span",he,g(b(s)("obs2.CombatStartShort")),1),f("span",we,g(b(s)("obs2.CombatEndShort")),1),f("span",fe,g(b(s)("obs2.WipeShort")),1)])],64)):(m(),h("div",ve,g(b(s)("obs2.OBS Not Connected")),1))]),y(l,{size:"small",class:"mini-toggle-btn",onClick:n[1]||(n[1]=e=>Me.value=!0)},{default:d(()=>[C(g(b(s)("obs2.Mini Mode")),1)]),_:1})]),y(c,{title:b(s)("obs2.size warning"),type:"warning",center:"","show-icon":"",closable:!1,class:"window-size-warning"},null,8,["title"]),y(R,{class:"obs-container"},{default:d(()=>[y(Ae,null,{default:d(()=>[b(Ie).status.connected?(m(),h("div",Ce,[b(Be)?(m(),i(R,{key:0,class:"status-card"},{header:d(()=>[f("div",Se,[f("span",null,g(b(s)("obs2.Connection Status")),1),y(l,{type:"danger",size:"small",class:"disconnect-button",onClick:n[5]||(n[5]=e=>b(Ie).disconnect())},{default:d(()=>[C(g(b(s)("obs2.Disconnect")),1)]),_:1})])]),default:d(()=>[f("div",Pe,[y(k,{direction:"vertical",column:1,border:""},{default:d(()=>[y(E,{label:b(s)("obs2.Recording")},{default:d(()=>[C(g(b(Ie).status.recording?b(s)("obs2.Yes"):b(s)("obs2.No")),1)]),_:1},8,["label"]),y(E,{label:b(s)("obs2.Output Path")},{default:d(()=>[C(g(b(Ie).status.outputPath||b(s)("obs2.None")),1)]),_:1},8,["label"])]),_:1})]),f("div",Ve,[y(l,{disabled:!b(Ie).status.connected||b(Ie).status.recording,type:"primary",onClick:n[6]||(n[6]=e=>b(Ie).startRecord())},{default:d(()=>[C(g(b(s)("obs2.Start Record")),1)]),_:1},8,["disabled"]),y(l,{disabled:!b(Ie).status.connected||!b(Ie).status.recording,type:"danger",onClick:n[7]||(n[7]=e=>b(Ie).stopRecord())},{default:d(()=>[C(g(b(s)("obs2.Stop Record")),1)]),_:1},8,["disabled"]),y(l,{disabled:!b(Ie).status.connected||!b(Ie).status.recording,type:"warning",onClick:n[8]||(n[8]=e=>b(Ie).splitRecord())},{default:d(()=>[C(g(b(s)("obs2.Split Record")),1)]),_:1},8,["disabled"]),y(l,{type:"primary",onClick:n[9]||(n[9]=e=>b(Ie).setProfileParameter("stop"))},{default:d(()=>[C(g(b(s)("obs2.Set Recording Name")),1)]),_:1})])]),_:1})):S("",!0),y(R,{class:"profile-card"},{header:d(()=>[f("div",_e,[f("span",null,g(b(s)("obs2.Recording Profile")),1),f("div",Re,[y(r,{"storage-key":"obs-2-theme"}),y(u)])])]),default:d(()=>[f("div",Ee,[y(V,{"label-position":"top",class:"content-form"},{default:d(()=>[y(P,{label:b(s)("obs2.Record Default Path")},{default:d(()=>[y(p,{modelValue:b(Te).path,"onUpdate:modelValue":n[10]||(n[10]=e=>b(Te).path=e),placeholder:b(s)("obs2.recordPathPlaceholder")},null,8,["modelValue","placeholder"]),y(c,{description:b(s)("obs2.filePathExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),y(P,{label:b(s)("obs2.Record File Name")},{default:d(()=>[y(p,{modelValue:b(Te).fileName,"onUpdate:modelValue":n[11]||(n[11]=e=>b(Te).fileName=e),placeholder:b(s)("obs2.recordFileNamePlaceholder")},null,8,["modelValue","placeholder"]),y(c,{description:b(s)("obs2.fileNameExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),y(P,null,{default:d(()=>[f("div",ke,[f("span",null,g(b(s)("obs2.Append Content Name")),1),y(U,{modelValue:b(Te).appendContentName,"onUpdate:modelValue":n[12]||(n[12]=e=>b(Te).appendContentName=e)},null,8,["modelValue"])])]),_:1})]),_:1})])]),_:1}),y(c,{class:"instruction-alert",type:"info",description:b(s)("obs2.IMETutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(R,{class:"table-card"},{header:d(()=>[f("div",Ue,[f("span",null,g(b(s)("obs2.User Content Settings")),1),f("div",Ne,[y(r,{"storage-key":"obs-2-theme"}),y(u)])])]),default:d(()=>[y(z,{data:b(xe),border:!0,stripe:"","row-class-name":Ke},{default:d(()=>[y(N,{prop:"type",label:b(s)("obs2.Type"),width:"100",fixed:"",align:"center"},{default:d(e=>[b(Oe)===e.row.type?(m(),h("span",De,[C(g(b(s)("obs2.Current")),1),n[14]||(n[14]=f("br",null,null,-1))])):S("",!0),f("span",null,g(e.row.type?b(s)(`obs2.${e.row.type}`):""),1)]),_:1},8,["label"]),y(N,{label:b(s)("obs2.Start When"),align:"center"},{default:d(()=>[y(N,{label:b(s)("obs2.When Party"),align:"center",width:"70"},{default:d(e=>[y(D,{modelValue:e.row.partyLength,"onUpdate:modelValue":t=>e.row.partyLength=t,min:1,max:48,style:{width:"40px"},size:"small",controls:!1},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"enter",label:b(s)("obs2.Enter Zone"),align:"center",width:"50"},{default:d(e=>[y(O,{modelValue:e.row.enter,"onUpdate:modelValue":t=>e.row.enter=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"countdown",label:b(s)("obs2.CountDown"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.countdown,"onUpdate:modelValue":t=>e.row.countdown=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"combatStart",label:b(s)("obs2.CombatStart"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.combatStart,"onUpdate:modelValue":t=>e.row.combatStart=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),y(N,{label:b(s)("obs2.End When"),align:"center"},{default:d(()=>[y(N,{prop:"combatEnd",label:b(s)("obs2.CombatEnd"),align:"center",width:"55"},{default:d(e=>[y(O,{modelValue:e.row.combatEnd,"onUpdate:modelValue":t=>e.row.combatEnd=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"wipe",label:b(s)("obs2.Wipe"),align:"center",width:"50"},{default:d(e=>[y(O,{modelValue:e.row.wipe,"onUpdate:modelValue":t=>e.row.wipe=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),y(N,{prop:"countdown",label:b(s)("obs2.CountDownCancel"),align:"center",width:"60"},{default:d(e=>[y(O,{modelValue:e.row.countdownCancel,"onUpdate:modelValue":t=>e.row.countdownCancel=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),y(N,{label:b(s)("obs2.Custom Path"),align:"left","min-width":"200"},{default:d(e=>[y(p,{modelValue:e.row.customPath,"onUpdate:modelValue":t=>e.row.customPath=t,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})])):(m(),i(R,{key:0,class:"connection-card"},{header:d(()=>[f("div",ge,[f("span",null,g(b(s)("obs2.Connect to OBS")),1),f("div",ye,[y(r,{"storage-key":"obs-2-theme"}),y(u)])])]),default:d(()=>[y(V,{"label-position":"top",class:"connection-form"},{default:d(()=>[y(P,{label:b(s)("obs2.Port")},{default:d(()=>[y(p,{modelValue:b(Te).host,"onUpdate:modelValue":n[2]||(n[2]=e=>b(Te).host=e),placeholder:b(s)("obs2.portPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),y(P,{label:b(s)("obs2.Password")},{default:d(()=>[y(p,{modelValue:b(Te).password,"onUpdate:modelValue":n[3]||(n[3]=e=>b(Te).password=e),placeholder:b(s)("obs2.passwordPlaceholder"),type:"password"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),y(P,null,{default:d(()=>[y(l,{type:"primary",class:"connect-button",loading:b(Ie).status.connecting,disabled:b(Ie).status.connecting||!b(Te).host,onClick:n[4]||(n[4]=e=>b(Ie).connect())},{default:d(()=>[C(g(b(Ie).status.connecting?b(s)("obs2.Connecting"):b(s)("obs2.Connect")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),y(_,null,{default:d(()=>[C(g(b(s)("obs2.Instructions")),1)]),_:1}),y(c,{class:"instruction-alert",type:"info",description:b(s)("obs2.obsTutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(c,{class:"instruction-alert",type:"info",description:b(s)("obs2.inputTutorial"),closable:!1,"show-icon":""},null,8,["description"]),y(c,{class:"instruction-alert",type:"info",description:b(s)("obs2.firewallTutorial"),closable:!1,"show-icon":""},null,8,["description"])]),_:1}))]),_:1})]),_:1})],64))]),_:1})}}}),[["__scopeId","data-v-fd79d74f"]]);export{Oe as default};
