import{T as M,d as T,o as p,e as h,F as x,M as k,u as o,Q as A,R as E,x as b,H as L,I as H,Y as O,$ as S,y as w,A as N,b as U,a as _,w as f,G as F,a4 as R,a5 as z,O as B}from"./vendor-2a442634.js";import{c as V,a as I}from"./overlay_plugin_api-409cb9ea.js";import{U as g}from"./util-831b56e7.js";import{d as W,s as J,p as Q,b as q,h as D,e as G}from"./xivapi-a5c0f7f0.js";import{_ as $}from"./_plugin-vue_export-helper-c27b6911.js";const C=new URLSearchParams(window.location.href.split("?")[1]),P=["tank","healer","dps","crafter","gatherer","none"],j=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],v=M("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(C.get("duration")||15)}}),getters:{partyDataFormatted(t){return t.partyData.sort((e,s)=>P.indexOf(g.jobToRole(g.jobEnumToJob(e.job)))-P.indexOf(g.jobToRole(g.jobEnumToJob(s.job))))},focusTargetCastArr(t){return t.castData.filter(e=>e.casterId===t.focusTargetId)}},actions:{testAction(){const t=j[Math.floor(Math.random()*j.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,e,s,r,n,d){if(this.partyData.length===0&&r===this.playerId||this.partyData.length>0&&r===this.focusTargetId){let a=n,l="action",y=!1;if(s.startsWith("item_"))return;s.startsWith("mount_")&&(a=Number.parseInt(s.replace(/^.+_/,""),16),a>983040&&(a=Number.parseInt(a.toString().slice(-5),10),y=!0),l=s.replace(/_.+$/,""));const m=`${t}-${e}-${r}-${n}`,c={casterId:r,time:t,expirationTime:Date.now()+this.config.duration*1e3,logLine:e,src:"",class:"",key:m},u=W.get(a);if(u&&(c.src=`//${u.Host}${u.Icon}`),this.castData.push(c),e===14&&d&&setTimeout(()=>{this.castData=this.castData.filter(i=>(i==null?void 0:i.key)!==m)},d*1e3-500),s.startsWith("unknown_"))c.src=`${J.first}/i/000000/000405.png`,c.class="action action-category-0";else if(a<1e5){const i=u||await Q(l,a,["ID","Icon","ActionCategoryTargetID"]);i.ID===3&&(i.Icon="/i/000000/000104.png"),u||(c.src=await q((i==null?void 0:i.Icon)??"",y)),l==="action"?c.class=`action action-category-${i==null?void 0:i.ActionCategoryTargetID}`:l==="mount"&&(c.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){t.line[0]==="20"?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):(t.line[0]==="21"||t.line[0]==="22"&&t.line[45]==="0")&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(e=>e.inParty).map(e=>({...e,src:""}));for(const e in this.castData)Object.prototype.hasOwnProperty.call(this.castData,e)&&(this.partyData.find(s=>s.id===e)||Reflect.deleteProperty(this.castData,e));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(C.get("syncFocusWS")||"")&&V({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),Y=t=>(L("data-v-67c0fa3f"),t=t(),H(),t),K={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},X=["data-casterId"],Z=["src"],tt=Y(()=>b("img",{class:"frame",loading:"lazy"},null,-1)),et=T({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=v(),r=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??""));return(n,d)=>(p(),h("div",K,[(p(!0),h(x,null,k(o(s).castData.filter(a=>a.key),a=>(p(),h("div",{key:a.key,"data-casterId":a.casterId,class:A(`images ${a.class} logLine${a.logLine} displayAA${o(r)}`),style:E(`--animeDuration: ${o(s).config.duration}s;`)},[b("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy",onError:d[0]||(d[0]=(...l)=>o(D)&&o(D)(...l))},null,40,Z),tt],14,X))),128))]))}});const at=$(et,[["__scopeId","data-v-67c0fa3f"]]),st={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},ot=["onClick"],nt={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},rt=["src","onerror"],it=T({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=v();O(()=>{for(const n of s.partyData)n.src=G(n.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(n,d)=>o(r)&&o(s).partyData.length>1?(p(),h("div",st,[(p(!0),h(x,null,k(o(s).partyDataFormatted,(a,l)=>(p(),h("button",{key:l,class:A(["job-lists",o(s).focusTargetId===a.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:y=>o(s).handleClickChangeTarget(a.id)},[b("div",nt,[b("img",{src:a.src,style:{height:"1.25em"},loading:"lazy",onerror:o(D)},null,8,rt),w(" "+N(o(g).nameToFullName(o(g).jobEnumToJob(a.job)).simple2),1)])],10,ot))),128))])):S("",!0)}});const ct=$(it,[["__scopeId","data-v-427ac828"]]),lt={class:"common-layout"},dt={key:0},ut=T({__name:"castingMonitor",setup(t){const e=v(),s=location.href.includes("localhost");return U(()=>{I("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),I("LogLine",e.handleLogLine),I("PartyChanged",e.handlePartyChanged),I("BroadcastMessage",r=>{r.source==="castMonitorOverlay"&&(e.focusTargetId=r.msg.targetId)})}),setInterval(()=>{e.cleanUpExpired()},1e3),(r,n)=>{const d=ct,a=F,l=at,y=R,m=z,c=B;return p(),h("div",lt,[_(m,{"items-center":""},{default:f(()=>[_(a,{class:"header-layout"},{default:f(()=>[_(d)]),_:1}),_(y,null,{default:f(()=>[_(l)]),_:1})]),_:1}),o(s)?(p(),h("footer",dt,[_(c,{onClick:n[0]||(n[0]=u=>o(e).testParty(!0))},{default:f(()=>[w(" 虚假小队 ")]),_:1}),_(c,{onClick:n[1]||(n[1]=u=>o(e).testParty(!1))},{default:f(()=>[w(" 单人 ")]),_:1}),_(c,{onClick:n[2]||(n[2]=u=>o(e).testAction())},{default:f(()=>[w(" Action ")]),_:1})])):S("",!0)])}}});const yt=$(ut,[["__scopeId","data-v-7a87f66d"]]);export{yt as default};
