import{S as e,Y as a,a2 as i,a3 as s,b as r,n as t,q as n,a4 as l,a5 as o,i as c}from"./element-plus-cb4c922a.js";import{t as d,r as m,e as p,P as u,v as y,x as f,A as g,aC as h,c as b,D as v,E as k,H as w,K as F,u as C,J as j,G as N,L as I,aa as $,aE as E,M as _,S as T,a4 as x,at as D,F as A,O as L,h as S,R as O,ad as H}from"./vue-vendor-6f37fd53.js";import{_ as P}from"./_plugin-vue_export-helper-6a8c15be.js";import"./index-5bc95ff7.js";/* empty css                 *//* empty css                     */import{d as R,o as z,u as M,e as K,a as W}from"./index-c9f4301b.js";import{s as G,c as B,a as U}from"./status-9bc9036c.js";import{c as Z}from"./clipboard-e5e2548c.js";import{U as V}from"./util-3591e9ca.js";/* empty css                  *//* empty css                   */import{h as J,g as Y}from"./xivapi-72ab0990.js";/* empty css                  *//* empty css               *//* empty css                  */import{u as q}from"./useDev-cab88d81.js";import{g as X}from"./actionChinese-e2356100.js";import{l as Q}from"./regexes-da03e94d.js";import{N as ee}from"./netregexes-ed180b06.js";import{a as ae}from"./overlay_plugin_api-974cdd44.js";const ie={class:"upload select"},se=P(d({__name:"TestLog",emits:["handleLine","beforeHandle","afterHandle"],setup(a,{emit:i}){const s=i,r=m(null),t=m(null);async function n(a){t.value?.classList.remove("drag");const i=a.target.files;if(!i||0===i.length)return;s("beforeHandle");const r=e.service({fullscreen:!0,text:"正在解析……请稍候",lock:!0,spinner:'<div style="width:0;height:0"></div>'});for(let e=0;e<i.length;e++){const a=i[e],r=await a.text();for(const e of r.split("\n"))s("handleLine",e)}r.close(),s("afterHandle"),t.value?.classList.remove("drag")}function l(e){e.preventDefault(),t.value?.classList.add("drag")}function o(e){e.preventDefault(),t.value?.classList.remove("drag")}return p(()=>{r.value?.addEventListener("change",n),t.value?.addEventListener("dragover",l),t.value?.addEventListener("dragleave",o)}),u(()=>{r.value?.removeEventListener("change",n),t.value?.removeEventListener("dragover",l),t.value?.removeEventListener("dragleave",o)}),(e,a)=>(f(),y("div",ie,[g("div",{ref_key:"select",ref:t,class:"upload-select"},[a[0]||(a[0]=g("div",{class:"upload text"},[g("span",null,"+"),g("p",null,"上传或拖入ACT日志")],-1)),g("input",{ref_key:"input",ref:r,type:"file"},null,512)],512)]))}}),[["__scopeId","data-v-6722092f"]]),re=[{name:"铁壁",id:1191,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"盾阵",id:1856,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"干预",id:1174,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"预警",id:74,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"武装",id:1176,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"神圣领域",id:82,type:"multiplier",performance:{physics:0,magic:0,darkness:0},isFriendly:!0},{name:"圣光幕帘",id:1362,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"圣盾阵",id:2674,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"骑士的坚守",id:2675,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"壁垒",id:77,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"极致防御",id:3829,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"极致护盾",id:3830,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的直觉",id:735,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的勇猛",id:1857,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的武猛",id:1858,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"战栗",id:87,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"复仇",id:89,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"摆脱",id:1457,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死斗",id:409,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的血气",id:2678,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的血潮",id:2679,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的血烟",id:2680,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"戮罪",id:3832,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"至黑之夜",id:1178,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"弃明投暗",id:746,type:"multiplier",performance:{physics:.9,magic:.8,darkness:1},isFriendly:!0},{name:"暗影墙",id:747,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"暗黑布道",id:1894,type:"multiplier",performance:{physics:.95,magic:.9,darkness:1},isFriendly:!0},{name:"暗影卫",id:3835,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"行尸走肉",id:810,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死而不僵",id:811,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"出死入生",id:3255,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"献奉",id:2682,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"石之心",id:1840,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"残暴弹",id:1898,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"伪装",id:1832,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"星云",id:1834,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"光之心",id:1839,type:"multiplier",performance:{physics:.95,magic:.85,darkness:1},isFriendly:!0},{name:"超火流星",id:1836,type:"multiplier",performance:{physics:0,magic:0,darkness:0},isFriendly:!0},{name:"刚玉之心",id:2683,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"刚玉之清",id:2684,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"神祝祷",id:1218,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"节制",id:1873,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"水流幕",id:2708,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"鼓舞",id:297,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"激励",id:1918,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"炽天的幕帘",id:1917,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"野战治疗阵",id:299,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"异想的幻光",id:317,type:"multiplier",performance:{physics:1,magic:.95,darkness:1},isFriendly:!0},{name:"炽天的幻光",id:1875,type:"multiplier",performance:{physics:1,magic:.95,darkness:1},isFriendly:!0},{name:"生命回生法",id:2710,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"怒涛之计",id:2711,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"命运之轮",id:849,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"天星交错",id:1889,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"擢升",id:2717,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"中间学派",id:1921,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡诊断",id:2607,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"齐衡诊断",id:2608,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡预后",id:2609,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"坚角清汁",id:2618,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"白牛清汁",id:2619,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"整体论",id:3003,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"整体盾",id:3365,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"输血",id:2612,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"泛输血",id:2613,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"心眼",id:1232,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"金刚极意",id:1179,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"行吟",id:1934,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"策动",id:1951,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"防守之桑巴",id:1826,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"即兴表演结束",id:2697,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"残影",id:488,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"魔罩",id:168,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护之光",id:2702,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护纹",id:2597,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"抗死",id:2707,type:"multiplier",performance:{physics:1,magic:.9,darkness:1},isFriendly:!0},{name:"雪仇",id:1193,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"牵制",id:1195,type:"multiplier",performance:{physics:.9,magic:.95,darkness:1},isFriendly:!1},{name:"昏乱",id:1203,type:"multiplier",performance:{physics:.95,magic:.9,darkness:1},isFriendly:!1},{name:"武装解除",id:860,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"减速",id:9,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"体力增加",id:2120,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"腐臭",id:1715,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"智力精神降低",id:2115,type:"multiplier",performance:{physics:1,magic:.9,darkness:1},isFriendly:!1},{name:"龙之力",id:2500,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"超硬化",id:1722,type:"multiplier",performance:{physics:.1,magic:.1,darkness:1},isFriendly:!0},{name:"玄结界",id:2496,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"仙人盾",id:2119,type:"multiplier",performance:{physics:.95,magic:.95,darkness:1},isFriendly:!0},{name:"强力守护",id:1719,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"哥布防御",id:2114,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"铜墙铁盾",id:194,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"坚守要塞",id:195,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"终极堡垒",id:196,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"原初大地",id:863,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"暗黑之力",id:864,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"灵魂之青",id:1931,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"坦培拉涂层",id:3686,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"油性坦培拉涂层",id:3687,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"世界树之干",id:3890,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"建筑神之塔",id:3892,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"太阳星座",id:3896,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"神爱抚",id:3903,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0}],te=[...re],ne=new Map;let le="Chinese";function oe(e){if(le!==e||0===ne.size){ne.clear();for(const a of"Chinese"===e?re:te){const e=G[a.id][1];a.fullIcon=B(e),ne.set(a.id.toString(16).toUpperCase().padStart(2,"0"),a)}le=e}}function ce(e){return ne.get(e)}function de(e,a){if("absorbed"===e.type)return"useful";if("dot"===a||"darkness"===a)return"unuseful";if(0===e.performance.darkness&&0===e.performance.magic&&0===e.performance.physics||1===e.performance.darkness&&1===e.performance.magic&&1===e.performance.physics)return"useful";const i="physics"===a?"magic":"physics";return 2*(100-100*e.performance[a])===100-100*e.performance[i]?"half-useful":1===e.performance[a]?"unuseful":"useful"}oe("Chinese");function me(e,a){return Object.entries(G).reduce((i,[s,[r,t]])=>(e.test(r)&&i.set(s,{name:r,icon:t,isFriendly:a}),i),new Map)}const pe=me(/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/,!0),ue=me(/(?:精神|力量|灵巧|智力){1,2}(?:大幅)?降低/,!1),ye=R("hash"),fe=h("keigennRecord2.1",{state:()=>({userOptions:{scale:b(()=>ge(ye.scale,1)),opacity:b(()=>ge(ye.opacity,.9)),targetType:b(()=>ge(ye.targetType,"icon")),iconType:b(()=>ge(ye.iconType,3)),parseAA:b(()=>ge(ye.parseAA,!0)),parseDoT:b(()=>ge(ye.parseDoT,!1)),minimize:b(()=>ge(ye.minimize,!1)),actionCN:b(()=>ge(ye.actionCN,!0)),statusCN:b(()=>ge(ye.statusCN,!0))},isBrowser:!1}),getters:{icon4k:e=>e.userOptions.scale>=2||window.devicePixelRatio>=2?"_hr1":""},actions:{checkIsBrowser(){this.isBrowser=!window.OverlayPluginApi&&!ye.OVERLAY_WS&&!ye.HOST_PORT,this.isBrowser&&setTimeout(()=>this.checkIsBrowser(),1e3)},formatterName:e=>e,initEnvironment(e){/^[A-Z]\S+ [A-Z]\S+$/.test(e)?oe("Global"):oe("Chinese")}}});function ge(e,a){return"boolean"==typeof a?"0"!==e&&"false"!==e?.toLocaleLowerCase()&&("1"===e||"true"===e?.toLocaleLowerCase()||a):"number"==typeof a?Number.isNaN(+e)?a:+e:"string"==typeof a?e:a}function he(e){return{dodge:"闪避","damage done":"击中","blocked damage":"格挡","parried damage":"招架","instant death":"即死",heal:"治疗","crit heal":"暴击治疗"}[e]}function be(e){const a=function(e){switch(!0){case e.endsWith("33"):return"instant death";case/2\w{4}4$/.test(e):return"crit heal";case e.endsWith("1"):return"dodge";case e.endsWith("3"):return"damage done";case e.endsWith("4"):return"heal";case e.endsWith("5"):return"blocked damage";case e.endsWith("6"):return"parried damage";default:throw new Error(`Unknown effect flag ${e}`)}}(e),i=function(e){switch(!0){case/2\w{3}$/.test(e):return"crit damage";case/4\w{3}$/.test(e):return"direct hit damage";case/6\w{3}$/.test(e):return"crit direct hit damage";default:return"damage"}}(e),s=function(e){switch(!0){case/7?[1-4]\w{3}[35]$/.test(e):case/[16]$/.test(e):return"physics";case/^E$/.test(e):case/5\w{4}$/.test(e):return"magic";case/^(?:\d0)?3$/.test(e):case/6\w{4}$/.test(e):return"darkness";default:return"physics"}}(e);return{effect:a,properties:i,type:s}}const ve=["3E","113","213","313"],ke=["A10","E"],we=["04"],Fe=["01","03","05","06","36"];function Ce(e){let a=0,i=e[8]??"",s=e[9]??"";ve.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s),ke.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s);const r=function(e){if(void 0===e)return 0;const a=e.length;if(a<=4)return 0;let i=Number.parseInt(e.slice(0,a-4),16);if("4"===e[a-4]){const s=Number.parseInt(e.slice(a-2,a),16);i=i-s+(s<<16)}return i}(s),t=`00${i}`.slice(-2);return{amount:r,lowByte:t,flags:i,isHeal:we.includes(t),isAttack:Fe.includes(t)}}const je=[Number(409).toString(16).toUpperCase(),Number(810).toString(16).toUpperCase(),Number(811).toString(16).toUpperCase(),Number(1836).toString(16).toUpperCase()];const Ne={class:"amount"},Ie={class:"row-info"},$e=P(d({__name:"Amount",props:{row:{}},setup(e){const i=e,s=fe().userOptions,{amount:r,maxHp:t,currentHp:n,shield:l,source:o,target:c,type:d,keigenns:m,effect:p}=i.row,u=Math.round(t*+l/100),h=Math.round(n/t*100),$=n-r,E=Math.round($/t*100);let _=0;if("instant death"!==p&&"dodge"!==p){let e=1;"blocked damage"===p?e=.8:"parried damage"===p&&(e=.85);let a=1;for(const i of m)"absorbed"!==i.type&&(a*=i.performance[d]??1);_=1-a*e}const T=(r&&Math.round((r+u)/(1-_))||0).toLocaleString(),x=(100*_).toFixed(2),D=b(()=>r.toLocaleString()),A=b(()=>s.actionCN?i.row.actionCN:i.row.action),L=d,S=(O=i.row).currentHp-O.amount<0&&!O.keigenns.find(e=>je.includes(e.effectId));var O;const H=(()=>{const e=[u>0?"有盾不准":"",m.find(e=>e.name.includes("受伤加重"))?"不算易伤":""].filter(Boolean);return e.length?`（${e.join("、")}）`:""})();return(e,i)=>{const s=a;return f(),v(s,{"append-to":".wrapper",title:C(A),trigger:"hover",enterable:!1,"hide-after":0,width:220},{reference:k(()=>[g("span",Ne,[g("span",{class:N(C(L))},[g("span",{class:N({lethal:C(S)})},F(C(D)),3)],2)])]),default:k(()=>[g("ul",Ie,[g("li",null,"来源: "+F(C(o)),1),g("li",null,"目标: "+F(C(c)),1),g("li",null,"护盾: "+F(C(u))+" ("+F(C(l))+"%)",1),g("li",null,"血量: "+F(C(n))+"/"+F(C(t))+" ("+F(C(h))+"%)",1),g("li",null,[i[0]||(i[0]=j(" 伤害: ",-1)),g("span",{class:N(C(L))},F(C(D)),3)]),g("li",null,"血量剩余: "+F($)+" ("+F(C(E))+"%)",1),C(_)<1&&"dot"!==C(d)?(f(),y(I,{key:0},[i[3]||(i[3]=g("hr",{class:"divider"},null,-1)),g("li",null,[i[1]||(i[1]=j("玩家减伤率: ",-1)),g("strong",null,F(C(x))+"%",1)]),g("li",null,[i[2]||(i[2]=j(" 倒推裸吃伤害: ",-1)),g("span",{class:N(C(L))},F(C(T)),3)]),g("li",null,F(C(H)),1)],64)):w("",!0)])]),_:1},8,["title"])}}}),[["__scopeId","data-v-96480248"]]),Ee={key:0},_e={key:1,class:"status-container"},Te=["title","data-duration","data-sourcePov"],xe=["src","alt"],De={class:"flags"},Ae=P(d({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=fe(),s=i.userOptions,r=i.icon4k;return(e,i)=>"dot"===a.row.type?(f(),y("div",Ee," （不支持） ")):(f(),y("div",_e,[(f(!0),y(I,null,$(a.row.keigenns,(e,t)=>(f(),y("span",{key:t},[g("span",{class:"status",title:`${C(s).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[g("img",{class:N(`statusIcon ${C(de)(e,a.row.type)}`),src:C(Y)(`/i/${e.fullIcon}${C(r)}.png`),alt:e.effect,loading:"lazy",onError:i[0]||(i[0]=(...e)=>C(J)&&C(J)(...e))},null,42,xe)],8,Te)]))),128)),g("span",De,F("damage done"===a.row.effect?"":C(he)(a.row.effect)),1)]))}}),[["__scopeId","data-v-9b1eaeae"]]),Le={class:"target"},Se=["src","alt"],Oe={key:1,class:"alt-text"},He=P(d({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=fe(),s=m(!1);function r(e){s.value=!0;e.target.style.display="none"}const t=b(()=>!s.value&&"icon"===(i.userOptions.targetType??"icon"));return(e,s)=>{return f(),y("div",Le,[C(t)?(f(),y("img",{key:0,class:N(`jobIcon cj${C(i).userOptions.iconType}`),src:(n=a.row.jobIcon,l=C(i).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${l}/${n.replace(/([A-Z])/g," $1").trim()}.png`),alt:a.row.jobIcon,onError:r},null,42,Se)):(f(),y("span",Oe,F(a.row.job),1))]);var n,l}}}),[["__scopeId","data-v-0c7a0405"]]),Pe="[取消筛选]",Re=P(d({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const a=e,l=fe().userOptions,o=E("contextMenu"),c=m(""),d=m(""),p=m(!1),u=m(0),h=m(0),j=m(null);z(o,()=>{p.value=!1});const N=b(()=>[Pe,...Array.from(new Set(a.rows.map(e=>e[a.actionKey])))]),I=b(()=>[{label:"[取消筛选]",value:"",job:-1},...Array.from(new Map(a.rows.map(e=>[e.target,e])).values()).map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,a)=>V.enumSortMethod(e.job,a.job)));function $(){if(j.value){const e=j.value[a.actionKey];c.value===e?c.value="":c.value=e,p.value=!1}}function D(){if(j.value){const e=j.value.target;d.value===e?d.value="":d.value=e,p.value=!1}}const A=b(()=>a.rows.filter(e=>{const i=!c.value||c.value===Pe||e[a.actionKey]===c.value,s=!d.value||d.value===Pe||e.target===d.value;return i&&s})),L=b(()=>[{key:"time",title:"时间",dataKey:"time",width:40,align:"center",class:"col-time"},{key:"action",title:"技能",dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:c.value,placeholder:"技能",clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>c.value=e===Pe?"":e},()=>N.value.map(e=>x(n,{key:e,label:e,value:e})))]),cellRenderer:({rowData:e})=>e[a.actionKey]},{key:"target",title:"职业",dataKey:"target",width:32,align:"center",class:"col-target",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:d.value,placeholder:"职业",clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{d.value=e===Pe?"":e}},()=>I.value.map(e=>x(n,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>x(He,{row:e})},{key:"amount",title:"伤害",dataKey:"amount",width:45,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>x($e,{row:e})},{key:"keigenns",title:"减伤",dataKey:"keigenns",width:100,align:"left",flexGrow:1,class:"col-keigenns",cellRenderer:({rowData:e})=>x(Ae,{row:e})}]);let S=null;const O=b(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:i,job:s,keigenns:t,time:n,type:o,effect:c,currentHp:d,maxHp:m,shield:p}=e,u="damage done"===c?"":`,${he(c)}`,y=`${n} ${s} ${a} ${i.toLocaleString()}(${f=o,{physics:"物理",magic:"魔法",darkness:"暗黑",dot:"持续伤害"}[f]}) 减伤:${0===t.length&&""===u?"无":t.map(e=>l.statusCN?e.name:e.effect).join(",")+u} HP:${d}/${m}(${Math.round(d/m*100)}%)+盾:${Math.round(m*+p/100)}(${p}%)`;var f;Z(y).then(()=>{S?.close(),S=r.success({message:"复制成功",duration:800})}).catch(()=>r.error("复制失败"))},onContextmenu:({rowData:e,event:a})=>{const i=a;j.value=e,u.value=i.clientX,h.value=i.clientY,p.value=!0}}));return(e,a)=>{const r=s,t=i;return f(),v(t,{style:{height:"100%",width:"100%"}},{default:k(({height:a,width:i})=>[_(r,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:L.value,data:A.value,width:i,height:a,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":O.value},null,8,["columns","data","width","height","row-event-handlers"]),C(p)?(f(),y("div",{key:0,ref_key:"contextMenu",ref:o,class:"context-menu",style:T({top:`${C(h)}px`,left:`${C(u)}px`})},[g("ul",null,[g("li",{onClick:$},F(C(c)===(C(j)?.[e.actionKey]??"")?`取消筛选 [${C(j)?.[e.actionKey]??"此技能"}]`:`只看 [${C(j)?.[e.actionKey]??"此技能"}]`),1),g("li",{onClick:D},F(C(d)===C(j)?.target?`取消筛选 [${C(j)?.job??"此职业"}]`:`只看 [${C(j)?.job??"此职业"}]`),1)])],4)):w("",!0)]),_:1})}}}),[["__scopeId","data-v-dbc5b88c"]]),ze="function"==typeof structuredClone?structuredClone:e=>{if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e.source,e.flags);if(Array.isArray(e))return e.map(e=>ze(e));if(Object.getPrototypeOf(e)===Object.prototype){const a={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(a[i]=ze(e[i]));return a}return e},Me={class:"header-select"},Ke={style:{height:"100%"}},We={key:0,class:"testLog"},Ge="souma-keigenn-record-2",Be=P(d({__name:"keigennRecord2",setup(e){const a=q(),i=fe(),s=i.userOptions;i.checkIsBrowser();const r=m(s.minimize),d=b(()=>s.actionCN?"actionCN":"action"),u=m(!1);let h=!1;const F=M("keigenn-record-2-pov-name",""),E=M("keigenn-record-2-pov-id",""),x=M("keigenn-record-2-party-list",[]),P=M("keigenn-record-2-job-map",{}),R=M("keigenn-record-2-party-event-party",[]),z=m(0),G=m([{zoneName:"",duration:"00:00",table:D([]),key:"init",timestamp:-1}]),Z={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ee.ability(),statusEffectExplicit:ee.statusEffectExplicit(),gainsEffect:ee.gainsEffect(),losesEffect:ee.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:ee.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:ee.addedCombatant(),removingCombatant:ee.removingCombatant(),networkDoT:ee.networkDoT()},J=m(0),Y=M("souma-keigenn-record-2-zone-name",""),ie=M("souma-keigenn-record-2-rsv-data",{}),re={},te={friendly:{},enemy:{}};function ne(){var e;u.value=!0,h=!1,J.value=0,z.value=0,G.value.length=0,G.value.push({zoneName:"",duration:"00:00",table:D([]),key:"placeholder",timestamp:-1}),(e=G.value[0]).table.length=0,e.zoneName="",e.duration="00:00",e.key="init",ge()}function le(){G.value=G.value.filter(e=>"00:00"!==e.duration&&0!==e.table.length),h=!0,u.value=!1}function oe(e){for(const a in Z){const r=Z[a].exec(e);if(r){const t=e.split("|");switch(a){case"statusEffectExplicit":r.groups?.targetId.startsWith("1")&&(re[r.groups.targetId]=r.groups.currentShield);break;case"gainsEffect":{const e=t[Q.GainsEffect.fields.effectId],a=t[Q.GainsEffect.fields.effect],i=t[Q.GainsEffect.fields.target],s=t[Q.GainsEffect.fields.targetId],r=Number.parseInt(t[Q.GainsEffect.fields.count],16);let n=ce(e);if(!n){const a=s.startsWith("1")&&pe.get(Number.parseInt(e,16).toString())||s.startsWith("4")&&ue.get(Number.parseInt(e,16).toString());if(!a)return;const i=B(a.icon),t=r>1?U(i,r):i;n={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(e,16),fullIcon:t,name:a.name,isFriendly:a.isFriendly}}const l=t[Q.GainsEffect.fields.duration],o=t[Q.GainsEffect.fields.source],c=t[Q.GainsEffect.fields.sourceId],d=new Date(t[Q.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),m={name:n.name,type:n.type,count:r,effect:a,effectId:e,source:o,sourceId:c,target:i,targetId:s,expirationTimestamp:d,performance:n.performance,fullIcon:n.fullIcon,isPov:E.value===c};s.startsWith("1")&&n.isFriendly?(void 0===te.friendly[s]&&(te.friendly[s]={}),te.friendly[s][e]=m):s.startsWith("4")&&!n.isFriendly&&(void 0===te.enemy[i]&&(te.enemy[i]={}),te.enemy[i][e]=m)}break;case"losesEffect":{const e=t[Q.LosesEffect.fields.target],a=t[Q.LosesEffect.fields.targetId],i=t[Q.LosesEffect.fields.effectId];a.startsWith("1")?te.friendly[a]&&Reflect.deleteProperty(te.friendly[a],i):te.enemy[e]&&Reflect.deleteProperty(te.enemy[e],i)}break;case"addCombatant":if("00"!==t[Q.AddedCombatant.fields.job]){const e=t[Q.AddedCombatant.fields.job],a=new Date(t[Q.AddedCombatant.fields.timestamp]).getTime();P.value[t[Q.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a}}break;case"removingCombatant":Reflect.deleteProperty(P.value,t[Q.RemovedCombatant.fields.id]);break;case"primaryPlayer":{E.value=t[Q.ChangedPlayer.fields.id];const e=t[Q.ChangedPlayer.fields.name];if(F.value===e)return;F.value=e,i.initEnvironment(t[Q.ChangedPlayer.fields.name])}break;case"partyList":x.value=r.groups?.list?.split("|")??[];break;case"changeZone":Y.value=t[Q.ChangeZone.fields.name],ye(new Date(t[Q.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const e="1"===t[Q.InCombat.fields.inACTCombat],a="1"===t[Q.InCombat.fields.inGameCombat],i=new Date(t[Q.InCombat.fields.timestamp]).getTime();if(e||a){if(J.value>0)return;return"placeholder"===G.value[0].key&&G.value.splice(0,1),0!==G.value[0].table.length&&(G.value.unshift({zoneName:"",duration:"00:00",table:D([]),key:t[Q.InCombat.fields.timestamp],timestamp:i}),G.value.length>=3&&G.value.splice(G.value.length-1,1)),J.value=i,G.value[0].zoneName=Y.value,void(z.value=0)}if(!e&&!a)return void ye(i)}break;case"rsv":{const e=Number(r.groups?.id),a=t[Q.RSVData.fields.value];e&&a&&(ie.value[Number(e)]=a)}break;case"networkDoT":if(!s.parseDoT)return;{const e=t[Q.NetworkDoT.fields.which],a=t[Q.NetworkDoT.fields.id];if("DoT"!==e||a.startsWith("4")||a!==E.value&&!x.value.includes(a)&&!R.value.find(e=>e.id===a))return;const i=t[Q.NetworkDoT.fields.name],s=t[Q.NetworkDoT.fields.damage],r=Number.parseInt(s,16),n=new Date(t[Q.Ability.fields.timestamp]??"???").getTime(),l=Number(t[Q.NetworkDoT.fields.currentHp]),o=Number(t[Q.NetworkDoT.fields.maxHp]),c=he(0===J.value?0:n-J.value),d=de(a),m=V.jobToFullName(V.jobEnumToJob(d)).simple2,p=d,u=V.jobEnumToIcon(p);me({key:G.value[0].table.length.toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:i,targetId:a,job:m,jobIcon:u,jobEnum:p,amount:r,keigenns:[],currentHp:l,maxHp:o,effect:"damage done",type:"dot",shield:re[a]??"0",povId:E.value})}break;case"ability":if(0===J.value)return;{const e=Ce(t);if(e.isAttack&&e.amount>=0){const a=t[Q.Ability.fields.sourceId]??"???",i=t[Q.Ability.fields.targetId]??"???";if(!a.startsWith("4")||!i.startsWith("1"))return;if(i!==E.value&&!x.value.includes(i)&&!R.value.find(e=>e.id===i))return;const n=new Date(t[Q.Ability.fields.timestamp]??"???").getTime(),l=t[Q.Ability.fields.ability],o=l.match(/^_rsv_(?<id>\d+)_/),c=t[Q.Ability.fields.id]??"???";let d=l;if(o){const e=Number(o.groups?.id);d=ie.value[e]??l.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(d=d.replace(/unknown_.*/,"攻击"),!1===s.parseAA&&/^攻击|攻撃|[Aa]ttack$/.test(d))return;const m=X(Number.parseInt(c,16)),p=m&&""!==m?m:d,u=Number(t[Q.Ability.fields.targetCurrentHp])??"???",y=Number(t[Q.Ability.fields.targetMaxHp])??"???",f=t[Q.Ability.fields.source]??"???",g=t[Q.Ability.fields.target]??"???",{effect:h,type:b}=be(e.flags),v=he(0===J.value?0:n-J.value),k=de(i),w=V.jobToFullName(V.jobEnumToJob(k)).simple2,F=k,C=V.jobEnumToIcon(F),j=ze(Object.values(te.friendly[i]??[]).concat(Object.values(te.enemy[f]??[])).filter(e=>{const a=Math.max(0,(e.expirationTimestamp-n)/1e3);return e.remainingDuration=a>=999?"":a.toFixed(a>.05&&a<.95?1:0),Number(e.remainingDuration)>-3}));me({key:G.value[0].table.length.toString(),time:v,id:c,action:d,actionCN:p,source:f,target:g,targetId:i,job:w,jobIcon:C,jobEnum:F,amount:e.amount,keigenns:j,currentHp:u,maxHp:y,effect:h,type:b,shield:re[r.groups.targetId]??"0",povId:E.value}),G.value[0].duration=he(new Date(t[Q.Ability.fields.timestamp]).getTime()-J.value)}}}}}}function de(e){return[P.value[e],R.value.find(a=>a.id===e)??{job:0,timestamp:0}].sort((e,a)=>a.timestamp-e.timestamp)[0].job}function me(e){G.value[0].table.unshift(e)}function ye(e){0!==J.value&&(G.value[0].duration=he(e-J.value),G.value[0]=H(G.value[0]),J.value=0,te.friendly={},te.enemy={},ge())}function ge(){h&&localStorage.setItem(Ge,JSON.stringify(G.value.filter(e=>"placeholder"!==e.key&&e.timestamp>0).slice().sort((e,a)=>a.timestamp-e.timestamp).slice(0,3)))}function he(e){const a=Math.max(Math.floor(e/6e4),0),i=Math.max(Math.floor((e-6e4*a)/1e3),0);return`${a<10?"0":""}${a}:${i<10?"0":""}${i}`}function ve(){r.value=!r.value}function ke(){const e={...G.value[0].table[0],key:crypto.randomUUID()};G.value[0].table.unshift(e)}return i.isBrowser&&(F.value="测试用户"),""!==F.value&&i.initEnvironment(F.value),p(()=>{const e=K({storageKey:"keigenn-record-2-theme"}),a=W(e);!1===e.value&&a();for(const i in P.value){const e=P.value[i];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(P.value,i)}!function(){const e=localStorage.getItem(Ge);if(e)try{const a=JSON.parse(e);G.value.length=0,G.value.push(...a)}catch(a){throw G.value.length=0,a}}(),ae("LogLine",e=>{oe(e.rawLine)}),ae("PartyChanged",e=>{R.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),ae("ChangePrimaryPlayer",e=>{F.value=e.charName,E.value=Number(e.charID).toString(16).toUpperCase()})}),(e,m)=>{const p=n,u=t,h=c,b=Re,F=se;return f(),y(I,null,[g("div",{class:"wrapper",style:T({"--scale":C(s).scale,"--opacity":C(s).opacity}),onContextmenu:m[1]||(m[1]=O(()=>{},["prevent"]))},[g("header",null,[g("div",Me,[A(_(u,{modelValue:C(z),"onUpdate:modelValue":m[0]||(m[0]=e=>S(z)?z.value=e:null),size:"small",class:N(["combat-select",C(i).isBrowser?"browser":"act"]),"popup-class-name":"combat-select-popup",offset:0,"show-arrow":!1},{default:k(()=>[(f(!0),y(I,null,$(C(G).length,e=>(f(),v(p,{key:`${C(G)[e-1].key}-${C(G)[e-1].duration}-${C(G)[e-1].zoneName}`,value:e-1,label:`${C(G)[e-1].duration} ${C(G)[e-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[L,!C(r)]])]),C(i).isBrowser?w("",!0):(f(),v(h,{key:0,class:N(["minimize",C(r)?"in-minimize":"not-minimize"]),icon:C(r)?C(l):C(o),circle:"",style:T({opacity:C(r)?.5:1}),onClick:ve},null,8,["class","icon","style"]))]),A(g("main",Ke,[_(b,{rows:C(G)[C(z)].table,"action-key":C(d)},null,8,["rows","action-key"])],512),[[L,!C(r)]])],36),C(i).isBrowser||C(a)?(f(),y("div",We,[C(a)?(f(),v(h,{key:0,onClick:ke},{default:k(()=>m[2]||(m[2]=[j(" 测试 ",-1)])),_:1,__:[2]})):w("",!0),_(F,{"m-1":"",onBeforeHandle:ne,onAfterHandle:le,onHandleLine:oe})])):w("",!0)],64)}}}),[["__scopeId","data-v-b2ec4bd3"]]);export{Be as default};
