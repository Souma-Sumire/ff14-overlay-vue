import{_ as a}from"./ActWrapper-5069e8c1.js";import{i as t,o as e,h as s,f as r}from"./element-plus-901ad096.js";import{aR as o,k as n,l as i,o as l,F as c,ae as d,U as u,A as p,u as h,q as m,af as g,B as y,D as f,E as I,J as b,x as D,y as j,G as _}from"./vue-49c48d91.js";import{U as w}from"./util-3591e9ca.js";import{c as T,s as P,p as C,a as k,h as v}from"./xivapi-72ab0990.js";import{c as $,a as A}from"./cactbot-49e370f3.js";import{_ as x}from"./_plugin-vue_export-helper-6a8c15be.js";import{u as L}from"./useDev-861d544b.js";import"./useDemo-86956ef5.js";import"./vendor-979eac9e.js";const N=new URLSearchParams(window.location.href.split("?")[1]),M=["tank","healer","dps","crafter","gatherer","none"],E=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],U=o("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(N.get("duration")||15)}}),getters:{partyDataFormatted:a=>a.partyData.sort((a,t)=>M.indexOf(w.jobToRole(w.jobEnumToJob(a.job)))-M.indexOf(w.jobToRole(w.jobEnumToJob(t.job)))),focusTargetCastArr:a=>a.castData.filter(t=>t.casterId===a.focusTargetId)},actions:{testAction(){const a=E[Math.floor(Math.random()*E.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,a)},testParty(a){this.handlePartyChanged({party:a?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(a,t,e,s,r,o){if(0===this.partyData.length&&s===this.playerId||this.partyData.length>0&&s===this.focusTargetId){let n=r,i="action",l=!1;if(e.startsWith("item_"))return;e.startsWith("mount_")&&(n=Number.parseInt(e.replace(/^.+_/,""),16),n>983040&&(n=Number.parseInt(n.toString().slice(-5),10),l=!0),i=e.replace(/_.+$/,""));const c=`${a}-${t}-${s}-${r}`,d={casterId:s,time:a,expirationTime:Date.now()+1e3*this.config.duration,logLine:t,src:"",class:"",key:c},u=T.get(n);if(u&&(d.src=`//${u.Host}${u.Icon}`),this.castData.push(d),14===t&&o&&setTimeout(()=>{this.castData=this.castData.filter(a=>a?.key!==c)},1e3*o-500),e.startsWith("unknown_"))d.src=`${P.first}/i/000000/000405.png`,d.class="action action-category-0";else if(n<1e5){const a=u||await C(i,n,["ID","Icon","ActionCategoryTargetID"]);3===a.ID&&(a.Icon="/i/000000/000104.png"),u||(d.src=await k(a?.Icon??"",l)),"action"===i?d.class=`action action-category-${a?.ActionCategoryTargetID}`:"mount"===i&&(d.class="mount")}}},handleChangePrimaryPlayer(a){this.playerId=a.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(a){"20"===a.line[0]?this.pushAction(Date.now(),14,a.line[5],a.line[2],Number.parseInt(a.line[4],16),Number(a.line[8])):("21"===a.line[0]||"22"===a.line[0]&&"0"===a.line[45])&&this.pushAction(Date.now(),15,a.line[5],a.line[2],Number.parseInt(a.line[4],16))},handlePartyChanged(a){if(a.party.length>0){this.partyData=a.party.filter(a=>a.inParty).map(a=>({...a,src:""}));for(const a in this.castData)Object.prototype.hasOwnProperty.call(this.castData,a)&&(this.partyData.find(t=>t.id===a)||Reflect.deleteProperty(this.castData,a));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(a){a===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=a,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(N.get("syncFocusWS")||"")&&$({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(a=>a.expirationTime>Date.now())}}}),F={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},O=["data-casterId"],R=["src"],S=x(n({__name:"Main",setup(a){const t=new URLSearchParams(window.location.href.split("?")[1]),e=U(),s=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(t.get("displayAA")??""));return(a,t)=>(l(),i("div",F,[(l(!0),i(c,null,d(h(e).castData.filter(a=>a.key),a=>(l(),i("div",{key:a.key,"data-casterId":a.casterId,class:p(`images ${a.class} logLine${a.logLine} displayAA${h(s)}`),style:u(`--animeDuration: ${h(e).config.duration}s;`)},[m("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy",onError:t[0]||(t[0]=(...a)=>h(v)&&h(v)(...a))},null,40,R),t[1]||(t[1]=m("img",{class:"frame",loading:"lazy"},null,-1))],14,O))),128))]))}}),[["__scopeId","data-v-67c0fa3f"]]),J={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},W=["onClick"],z={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},H=["src","onerror"],B=x(n({__name:"Header",setup(a){const t=new URLSearchParams(window.location.href.split("?")[1]);function e(a){const t=w.jobEnumToJob(a);return`https://souma.diemoe.net/resources/img/cj2/${w.jobToFullName(t).en}.png`}const s=U();g(()=>{for(const a of s.partyData)a.src=e(a.job)});const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(t.get("showHeader")||"true");return(a,t)=>h(r)&&h(s).partyData.length>1?(l(),i("div",J,[(l(!0),i(c,null,d(h(s).partyDataFormatted,(a,t)=>(l(),i("button",{key:t,class:p(["job-lists",h(s).focusTargetId===a.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:t=>h(s).handleClickChangeTarget(a.id)},[m("div",z,[m("img",{src:a.src,style:{height:"1.25em"},loading:"lazy",onerror:h(v)},null,8,H),f(" "+I(h(w).jobToFullName(h(w).jobEnumToJob(a.job)).simple2),1)])],10,W))),128))])):y("",!0)}}),[["__scopeId","data-v-4e98a4d9"]]),G={class:"common-layout"},q={key:0},Q=x(n({__name:"castingMonitor",setup(o){const n=U(),c=L();return b(()=>{A("ChangePrimaryPlayer",n.handleChangePrimaryPlayer),A("LogLine",n.handleLogLine),A("PartyChanged",n.handlePartyChanged),A("BroadcastMessage",a=>{"castMonitorOverlay"===a.source&&(n.focusTargetId=a.msg.targetId)})}),setInterval(()=>{n.cleanUpExpired()},1e3),(o,d)=>{const u=B,p=t,g=S,I=e,b=s,w=r,T=a;return l(),D(T,null,{default:j(()=>[m("div",G,[_(b,{"items-center":""},{default:j(()=>[_(p,{class:"header-layout"},{default:j(()=>[_(u)]),_:1}),_(I,null,{default:j(()=>[_(g)]),_:1})]),_:1}),h(c)?(l(),i("footer",q,[_(w,{onClick:d[0]||(d[0]=a=>h(n).testParty(!0))},{default:j(()=>d[3]||(d[3]=[f(" 虚假小队 ",-1)])),_:1,__:[3]}),_(w,{onClick:d[1]||(d[1]=a=>h(n).testParty(!1))},{default:j(()=>d[4]||(d[4]=[f(" 单人 ",-1)])),_:1,__:[4]}),_(w,{onClick:d[2]||(d[2]=a=>h(n).testAction())},{default:j(()=>d[5]||(d[5]=[f(" Action ",-1)])),_:1,__:[5]})])):y("",!0)])]),_:1})}}}),[["__scopeId","data-v-427fd25d"]]);export{Q as default};
