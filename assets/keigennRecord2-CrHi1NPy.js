import{_ as e,e as t}from"./shared-common-BKuSzJeA.js";import{h as a,g as n,a as o,e as s,b as i,c as l,n as r,t as c,f as d,d as u,y as m,z as p,F as f,G as v,r as g,cO as y,x as b,dx as h,w as k,dz as w,b2 as j,D as $,s as I,u as R,cj as N,J as C,o as D,j as _,l as E,p as x,v as A,i as M,bW as S,ch as T}from"./vendor-vue-i6lpFrx4.js";import{ac as L,U as z,ad as F,r as K,s as P,ae as H,u as O,w as G,a9 as W,f as B,$ as J,af as Z,a7 as U,t as V,Z as q,l as X,ag as Y,ah as Q,ai as ee,aj as te,ak as ae,A as ne,al as oe}from"./shared-core-wtLCg29f.js";import{t as se,J as ie,aC as le,b as re,a as ce,E as de,aD as ue,w as me,aE as pe,g as fe,aF as ve,aG as ge,n as ye}from"./vendor-element-plus-DxZgBX3C.js";import{N as be,a as he,l as ke}from"./cactbot-DtpbXwrG.js";const we={class:"amount"},je={class:"row-info"},$e=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:g,shield:y,source:b,type:h}=t.row,k=Math.round(v*+y/100),w=Math.round(g/v*100),j=t.row.reduction,$=(a&&Math.round((a+k)/(1-j))||0).toLocaleString(),I=a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString(),R=h,N=L(t.row);return(e,t)=>{const a=se,v=ie;return o(),n(v,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:s(()=>[i("span",we,[i("span",{class:p(d(R))},[i("span",{class:p({lethal:d(N)})},c(d(I)),3)],2)])]),default:s(()=>[i("ul",je,[i("li",null,c(e.$t("keigennRecord.source"))+": "+c(d(b)),1),i("li",null,c(e.$t("keigennRecord.playerShield"))+": "+c(d(y))+"%",1),i("li",null,c(e.$t("keigennRecord.playerHp"))+": "+c(d(w))+"%",1),d(j)<1&&"dot"!==d(h)?(o(),l(f,{key:0},[u(a),i("li",null,c(e.$t("keigennRecord.reductionRate"))+": "+c((100*d(j)).toFixed(3))+"% ",1),i("li",null,[m(c(e.$t("keigennRecord.originalDamage"))+": ",1),i("span",{class:p(d(R))},c(d($)),3)])],64)):r("",!0)])]),_:1})}}}),[["__scopeId","data-v-8b91d23d"]]),Ie={class:"subtitle"},Re={class:"skill-grid"},Ne=["title"],Ce=["src"],De={class:"skill-text"},_e={class:"subtitle"},Ee={class:"skill-grid"},xe=["title"],Ae=["src"],Me={key:2,class:"no-data"},Se=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=v(()=>y(t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[])),m=v(()=>y(t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>z.enumSortMethod(e.ownerJob,t.ownerJob))??[]));function p(e){const t=z.jobEnumToJob(e);return z.jobToFullName(t).simple2||""}const b={modifiers:[{name:"preventOverflow",options:{padding:24}}]};return(e,t)=>{const v=re,y=se,h=ie;return o(),n(h,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover",transition:"none","show-after":0,"hide-after":0,"popper-options":b},{reference:s(()=>[u(v,{class:"view-icon"},{default:s(()=>[u(d(le))]),_:1})]),default:s(()=>[d(a).length>0?(o(),l(f,{key:0},[i("div",Ie,c(e.$t("keigennRecord.coolingDown")),1),i("div",Re,[(o(!0),l(f,null,g(d(a),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Ce),t[0]||(t[0]=i("div",{class:"skill-overlay"},null,-1)),i("span",De,c(e.recastLeft),1)],8,Ne)]))),128))])],64)):r("",!0),d(m).length>0?(o(),l(f,{key:1},[d(a).length>0?(o(),n(y,{key:0})):r("",!0),i("div",_e,c(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),i("div",Ee,[(o(!0),l(f,null,g(d(m),e=>(o(),l("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[i("div",{class:"skill-icon-container",title:`${e.ownerName} (${p(e.ownerJob)})`},[i("img",{src:e.icon,class:"skill-icon"},null,8,Ae)],8,xe)]))),128))])],64)):r("",!0),0===d(a).length&&0===d(m).length?(o(),l("div",Me,c(e.$t("keigennRecord.noData")),1)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-d1f9fd8f"]]),Te={key:0},Le={key:1,class:"status-container"},ze=["title","data-duration","data-sourcePov"],Fe=["src","alt"],Ke={class:"flags"},Pe=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=F(),n=a.userOptions,s=a.icon4k;return(e,a)=>"dot"===t.row.type?(o(),l("div",Te,c(e.$t("keigennRecord.noSupport")),1)):(o(),l("div",Le,[(o(!0),l(f,null,g(t.row.keigenns,(e,r)=>(o(),l("span",{key:r},[i("span",{class:"status",title:`${d(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[i("img",{class:p(`statusIcon ${d(H)(e,t.row.type)}`),src:d(P)(`/i/${e.fullIcon}${d(s)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>d(K)&&d(K)(...e))},null,42,Fe)],8,ze)]))),128)),i("span",Ke,c("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),He={class:"target"},Oe=["src","alt"],Ge={key:1,class:"alt-text"},We={key:3,class:"has-duplicate"},Be=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=F(),n=b(!1);function s(e){n.value=!0;e.target.style.display="none"}const i=v(()=>!n.value&&"icon"===(a.userOptions.targetType??"icon")),u=L(t.row);return(e,n)=>{return o(),l("div",He,[d(i)?(o(),l("img",{key:0,class:p(`${d(a).isBrowser?"browser":"act"} jobIcon cj${d(a).userOptions.iconType} ${d(u)?"lethal-icon":""}`),src:(m=t.row.jobIcon,f=d(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${f}/${m.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:s},null,42,Oe)):(o(),l("span",Ge,c(t.row.job),1)),d(u)?(o(),l("span",{key:2,class:p(`lethal-emoji ${d(a).isBrowser?"browser":"act"} emoji-cj${d(a).userOptions.iconType}`)}," ðŸ’€ ",2)):r("",!0),t.row.hasDuplicate?(o(),l("span",We,c(d(a).formatterName(t.row.target)),1)):r("",!0)]);var m,f}}}),[["__scopeId","data-v-60253f4d"]]),Je=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=O(),a=e,m=F(),p=m.userOptions,f=h("contextMenu"),g=b(""),y=b("");k(()=>a.rows,e=>{0===e.length&&(g.value="",y.value="")},{immediate:!0});const R=b(!1),N=b(0),C=b(0),D=b(null);w(f,()=>{R.value=!1});const _=t("keigennRecord.cancelFilter"),E=v(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey])));return[{label:_,value:""},...e.map(e=>({label:e,value:e}))]}),x=v(()=>{const e=Array.from(new Map(a.rows.map(e=>[e.target,e])).values());return[{label:_,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,t)=>z.enumSortMethod(e.job,t.job))});function A(){if(D.value){const e=D.value[a.actionKey];g.value===e?g.value="":g.value=e,R.value=!1}}function M(){if(D.value){const e=D.value.target;y.value===e?y.value="":y.value=e,R.value=!1}}const S=v(()=>a.rows.filter(e=>{const t=!g.value||g.value===_||e[a.actionKey]===g.value,n=!y.value||y.value===_||e.target===y.value;return t&&n})),T=new Map;function L(e){const t=Math.round(100*e)/100;if(T.has(t))return T.get(t);const a=[88,88,88],n=[50,250,200],o=Math.min(1,t/.5),s=Math.min(9,Math.floor(10*o))/9,i=Math.pow(s,.8),l=a[0]+(n[0]-a[0])*i,r=a[1]+(n[1]-a[1])*i,c=a[2]+(n[2]-a[2])*i,d=`rgba(${Math.round(l)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return T.set(t,d),d}const K=j([{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>$("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(ce,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>g.value=e===_?"":e},()=>E.value.map(e=>$(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$("span",e[a.actionKey]??"")},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(ce,{size:"small",modelValue:y.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{y.value=e===_?"":e}},()=>x.value.map(e=>$(de,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$(Be,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>$($e,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>$("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>$("span",{class:"col-reduction-number",style:{color:L(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>$(Pe,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>$("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},$("div",{style:{position:"absolute",right:"0px",zIndex:5}},$(Se,{row:e})))}]);let P=null;const H=v(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:n,job:o,keigenns:s,time:i,type:l,effect:r,currentHp:c,maxHp:d,shield:u,reduction:m}=e,f="damage done"===r?"":`,${t(`keigennRecord.${r}`)}`,v=`${i} ${o} ${a} ${n.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*m).toFixed(0)}%):${0===s.length&&""===f?t("keigennRecord.none"):s.map(e=>p.statusCN?e.name:e.effect).join(",")+f} ${t("keigennRecord.hp")}}:${c}(${Math.round(c/d*100)}%)+${t("keigennRecord.shield")}:${Math.round(d*+u/100)}(${u}%)`;G(v).then(()=>{P?.close(),P=fe.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>fe.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{const a=t;D.value=e,N.value=a.clientX,C.value=a.clientY,R.value=!0}}));return(a,p)=>{const v=me,b=pe,h=ue;return o(),n(h,{style:{height:"100%",width:"100%"}},{default:s(({height:n,width:p})=>[u(b,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:d(K),data:S.value,width:p,height:n,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":H.value},{empty:s(()=>[u(v,{description:d(m).isBrowser?a.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["columns","data","width","height","row-event-handlers"]),d(R)?(o(),l("div",{key:0,ref_key:"contextMenu",ref:f,class:"context-menu",style:I({top:`${d(C)}px`,left:`${d(N)}px`})},[i("ul",null,[i("li",{onClick:A},c(d(g)===(d(D)?.[e.actionKey]??"")?d(t)("keigennRecord.filter.action_cancel",{actionName:d(D)?.[e.actionKey]??d(t)("keigennRecord.this_skill")}):d(t)("keigennRecord.filter.action_only",{actionName:d(D)?.[e.actionKey]??d(t)("keigennRecord.this_skill")})),1),i("li",{onClick:M},c(d(y)===d(D)?.target?d(t)("keigennRecord.filter.target_cancel",{jobName:d(D)?.job??d(t)("keigennRecord.this_job")}):d(t)("keigennRecord.filter.target_only",{jobName:d(D)?.job??d(t)("keigennRecord.this_job")})),1)])],4)):r("",!0)]),_:1})}}}),[["__scopeId","data-v-c1ed0eeb"]]),Ze={class:"header-select"},Ue={style:{height:"100%"}},Ve={key:0,class:"testLog"},qe=e(a({__name:"keigennRecord2",setup(e){const a=B();O();const c=F(),h=c.userOptions;c.checkIsBrowser();const w=b(h.minimize),$=v(()=>h.actionCN?"actionCN":"action"),L=b(!1),K=R("keigenn-record-2-pov-id",""),P=R("keigenn-record-2-party-list",[]),H=R("keigenn-record-2-job-map",{}),G=R("keigenn-record-2-party-event-party",[]),se=R("souma-keigenn-record-2-rsv-data",{}),ie={povId:N(K.value),partyLogList:N(P.value),entitiesMap:N(H.value),partyEventParty:N(G.value),rsvData:N(se.value)};function le(e,t){k(t,t=>{ie[e]=N(t)},{flush:"sync"})}le("povId",K),le("partyLogList",P),le("entitiesMap",H),le("partyEventParty",G),le("rsvData",se);let re=0;const ue=b(0),me=j([{zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}]),pe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:be.ability(),statusEffectExplicit:be.statusEffectExplicit(),gainsEffect:be.gainsEffect(),losesEffect:be.losesEffect(),changeZone:be.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:be.addedCombatant(),removingCombatant:be.removingCombatant(),networkDoT:be.networkDoT()},fe=b(0),we=R("souma-keigenn-record-2-zone-name",""),je={},$e={friendly:{},enemy:{}},Ie=W.filter(e=>1===e.line||2===e.line);let Re={};const Ne=J("keigenn-record-2"),Ce=new Map;function De(){L.value=!0,fe.value=0,Re={},ue.value=0,me.value.length=0,me.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1})}async function _e(){L.value=!1,null!==Se&&(cancelAnimationFrame(Se),Se=null,Me.length>0&&(me.value[0].table.unshift(...Me.reverse()),Me=[])),await Ke(),T(me)}function Ee(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!pe.gainsEffect.exec(e))return;const t=a[ke.GainsEffect.fields.effectId],n=a[ke.GainsEffect.fields.effect],o=a[ke.GainsEffect.fields.target],s=a[ke.GainsEffect.fields.targetId],i=Number.parseInt(a[ke.GainsEffect.fields.count],16);let l=ee(t);if(!l){const e=s.startsWith("1")&&te.get(Number.parseInt(t,16).toString())||s.startsWith("4")&&ae.get(Number.parseInt(t,16).toString());if(!e)return;const a=ne(e.icon),n=i>1?oe(a,i):a;l={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[ke.GainsEffect.fields.duration],c=a[ke.GainsEffect.fields.source],d=a[ke.GainsEffect.fields.sourceId],u=new Date(a[ke.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:l.name,type:l.type,count:i,effect:n,effectId:t,source:c,sourceId:d,target:o,targetId:s,expirationTimestamp:u,performance:l.performance,fullIcon:l.fullIcon,isPov:ie.povId===d};s.startsWith("1")&&l.isFriendly?(void 0===$e.friendly[s]&&($e.friendly[s]={}),$e.friendly[s][t]=m):s.startsWith("4")&&!l.isFriendly&&(void 0===$e.enemy[o]&&($e.enemy[o]={}),$e.enemy[o][t]=m)}break;case"30":{const e=a[ke.LosesEffect.fields.target],t=a[ke.LosesEffect.fields.targetId],n=a[ke.LosesEffect.fields.effectId];t.startsWith("1")?$e.friendly[t]&&Reflect.deleteProperty($e.friendly[t],n):$e.enemy[e]&&Reflect.deleteProperty($e.enemy[e],n)}break;case"21":case"22":{if(0===fe.value)return;const e=a[ke.Ability.fields.sourceId]??"???",t=a[ke.Ability.fields.id]??"???",n=new Date(a[ke.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),o=function(e){let t=Ce.get(e);if(!t){t=new Map;for(const a of Ie){if(a.minLevel>e)continue;const n=Z(a.id,e);t.set(n,a)}Ce.set(e,t)}return t}(ie.entitiesMap[e]?.level??999);o.get(a)&&(Re[e]||(Re[e]={}),Re[e][a]=n)}const o=Y(a);if(o.isAttack&&o.amount>=0){const s=a[ke.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!s.startsWith("1"))return;if(s!==ie.povId&&!ie.partyLogList.includes(s)&&!ie.partyEventParty.find(e=>e.id===s))return;const i=a[ke.Ability.fields.ability],l=i.match(/^_rsv_(?<id>\d+)_/);let r=i;if(l){const e=Number(l.groups?.id);r=ie.rsvData[e]??i.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(r=r.replace(/unknown_.*/,"æ”»å‡»"),!1===h.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(r))return;const c=V(Number.parseInt(t,16)),d=c&&""!==c?c:r,u=Number(a[ke.Ability.fields.targetCurrentHp]),m=Number(a[ke.Ability.fields.targetMaxHp]),p=a[ke.Ability.fields.source]??"???",f=a[ke.Ability.fields.target]??"???",{effect:v,type:g}=Q(o.flags),y=Pe(0===fe.value?0:n-fe.value),{jobEnum:b,job:k,jobIcon:w,hasDuplicate:j}=Ae(s),$=Object.values($e.friendly[s]??[]).concat(Object.values($e.enemy[p]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),I=je[s]??"0",R=o.amount;let N=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of $)"absorbed"!==a.type&&(t*=a.performance[g]??1);N=1-t*e}Te({key:(re++).toString(),time:y,id:t,action:r,actionCN:d,source:p,target:f,targetId:s,job:k,jobIcon:w,jobEnum:b,hasDuplicate:j,amount:R,keigenns:$,currentHp:u,maxHp:m,effect:v,type:g,shield:I,povId:ie.povId,reduction:N,keySkills:Fe(n)}),me.value[0].duration=Pe(new Date(a[ke.Ability.fields.timestamp]).getTime()-fe.value)}}break;case"34":{const t=pe.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(je[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[ke.InCombat.fields.inACTCombat],t="1"===a[ke.InCombat.fields.inGameCombat],n=new Date(a[ke.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[ke.InCombat.fields.timestamp];if(fe.value>0)return;return 0===me.value[0].table.length&&0===Me.length||(null!==Se&&(cancelAnimationFrame(Se),Se=null),Me.length>0&&(me.value[0].table.unshift(...Me.reverse()),Me=[]),me.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:e,timestamp:n}),T(me)),fe.value=n,me.value[0].zoneName=we.value,me.value[0].timestamp=n,me.value[0].key=e,void(ue.value=0)}if(!e&&!t)return void Le(n)}break;case"01":{const e=parseInt(a[ke.ChangeZone.fields.id],16);if(we.value=a[ke.ChangeZone.fields.name],q[e]?.name){const t=X(q[e]?.name);t&&"Unknown"!==t&&(we.value=t)}Le(new Date(a[ke.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=pe.partyList.exec(e);t&&(P.value=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":K.value=a[ke.ChangedPlayer.fields.id];break;case"03":if("00"!==a[ke.AddedCombatant.fields.job]){const e=a[ke.AddedCombatant.fields.job],t=a[ke.AddedCombatant.fields.name],n=new Date(a[ke.AddedCombatant.fields.timestamp]).getTime(),o=parseInt(a[ke.AddedCombatant.fields.level],16);H.value[a[ke.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:o}}break;case"04":Reflect.deleteProperty(H.value,a[ke.RemovedCombatant.fields.id]),Reflect.deleteProperty($e.friendly,a[ke.RemovedCombatant.fields.id]),Reflect.deleteProperty($e.enemy,a[ke.RemovedCombatant.fields.id]);break;case"262":{const t=pe.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[ke.RSVData.fields.value];e&&n&&(se.value[Number(e)]=n)}}break;case"37":if(!h.parseDoT)return;{const e=a[ke.NetworkDoT.fields.which],t=a[ke.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==ie.povId&&!ie.partyLogList.includes(t)&&!ie.partyEventParty.find(e=>e.id===t))return;const n=a[ke.NetworkDoT.fields.name],o=a[ke.NetworkDoT.fields.damage],s=Number.parseInt(o,16),i=new Date(a[ke.Ability.fields.timestamp]??"???").getTime(),l=Number(a[ke.NetworkDoT.fields.currentHp]),r=Number(a[ke.NetworkDoT.fields.maxHp]),c=Pe(0===fe.value?0:i-fe.value),{jobEnum:d,job:u,jobIcon:m,hasDuplicate:p}=Ae(t);Te({key:(re++).toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:n,targetId:t,job:u,jobIcon:m,jobEnum:d,hasDuplicate:p,amount:s,keigenns:[],currentHp:l,maxHp:r,effect:"damage done",type:"dot",shield:je[t]??"0",povId:ie.povId,reduction:0,keySkills:[]})}}}const xe=new Map;function Ae(e){const t=xe.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=H.value[e],a=G.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,o=n===t?Object.entries(H.value).some(([t,a])=>t!==e&&a.job===n?.job&&P.value.includes(t)):G.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:o}}(e),o=a,s={jobEnum:o,job:z.jobToFullName(z.jobEnumToJob(o)).simple2,jobIcon:z.jobEnumToIcon(o),hasDuplicate:n};return xe.set(e,s),s}let Me=[],Se=null;function Te(e){Me.push(y(e)),null===Se&&(Se=requestAnimationFrame(()=>{me.value[0].table.unshift(...Me.reverse()),Me=[],Se=null}))}function Le(e){0!==fe.value&&(me.value[0].duration=Pe(e-fe.value),me.value[0]=y(me.value[0]),fe.value=0,$e.friendly={},$e.enemy={},Re={},xe.clear(),Ke())}const ze=v(()=>{const e=new Set;G.value.forEach(t=>e.add(t.id)),P.value.forEach(t=>e.add(t)),K.value&&e.add(K.value);const t=[];for(const n of e){const e=G.value.find(e=>e.id===n);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const a=H.value[n];a&&t.push({id:n,job:a.job,name:a.name??"Unknown",level:a.level})}const a=new Map;return t.forEach(e=>{a.set(e.job,(a.get(e.job)||0)+1)}),t.flatMap(e=>{const t=e.level||999,n=(a.get(e.job)||0)>1;return Ie.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const o=Z(a.id,t),s=Z(a.recast1000ms,t);return{id:o,name:V(o)||"Unknown",icon:U(o),recast1000ms:s,ownerId:e.id,ownerName:e.name,ownerJob:e.job,hasDuplicate:n}})})});function Fe(e){return ze.value.map(t=>{const a=Re[t.ownerId]?.[t.id]??0;let n=!0,o=0;if(a>0){const s=e-a,i=1e3*t.recast1000ms;s<i&&(n=!1,o=Math.ceil((i-s)/1e3))}return{...t,recastLeft:o,ready:n}})}async function Ke(){if(L.value)return;const e=me.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?N(e.table):[];return{...N(e),table:t}});await Ne.replaceAll(e)}function Pe(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function He(){w.value=!w.value}function Oe(){me.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:"test",timestamp:Date.now()}),T(me),ue.value=0}function Ge(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return D(()=>{const e=_({storageKey:"keigenn-record-2-theme"}),t=E(e);!1===e.value&&t();for(const a in H.value){const e=H.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(H.value,a)}!async function(){ue.value=0;try{const e=await Ne.getAll();if(e.length){me.value.length=0;const t=e.filter(e=>e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp).reverse().map(e=>({...e,table:C(Array.isArray(e.table)?[...e.table]:[])}));me.value.push(...t),0===me.value.length&&me.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}),T(me)}}catch(e){throw me.value.length=0,e}}(),he("LogLine",e=>{Ee(e.rawLine)}),he("PartyChanged",e=>{G.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),he("ChangePrimaryPlayer",e=>{K.value=Number(e.charID).toString(16).toUpperCase()}),he("CombatData",e=>{if(!(fe.value>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(we.value=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==me.value[0].table.length&&(me.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:String(n),timestamp:n}),T(me)),me.value[0].zoneName=we.value,fe.value=n,me.value[0].timestamp=n,me.value[0].key=String(n),ue.value=0}})}),(e,v)=>{const y=de,b=ce,k=ye,j=Je,R=t;return o(),l(f,null,[i("div",{class:"wrapper",style:I({"--scale":d(h).scale,"--opacity":d(h).opacity}),onContextmenu:v[1]||(v[1]=S(()=>{},["prevent"]))},[i("header",null,[i("div",Ze,[x(u(b,{modelValue:d(ue),"onUpdate:modelValue":v[0]||(v[0]=e=>M(ue)?ue.value=e:null),size:"small",class:p(["combat-select",d(c).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:s(()=>[(o(!0),l(f,null,g(d(me).length,e=>(o(),n(y,{key:`${d(me)[e-1].key}-${d(me)[e-1].duration}-${d(me)[e-1].zoneName}`,value:e-1,label:`${d(me)[e-1].zoneName}${""===d(me)[e-1].zoneName?"":` - [${d(me)[e-1].duration}] ${Ge(d(me)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[A,!d(w)]])]),d(c).isBrowser?r("",!0):(o(),n(k,{key:0,class:p(["minimize",d(w)?"in-minimize":"not-minimize"]),icon:d(w)?d(ve):d(ge),circle:"",style:I({opacity:d(w)?.5:1}),onClick:He},null,8,["class","icon","style"]))]),x(i("main",Ue,[u(j,{rows:d(me)[d(ue)].table,"action-key":d($)},null,8,["rows","action-key"])],512),[[A,!d(w)]])],36),d(c).isBrowser||d(a)?(o(),l("div",Ve,[d(a)?(o(),n(k,{key:0,onClick:Oe},{default:s(()=>[...v[2]||(v[2]=[m(" æµ‹è¯• ",-1)])]),_:1})):r("",!0),u(R,{"m-1":"",onBeforeHandle:De,onAfterHandle:_e,onHandleLine:Ee})])):r("",!0)],64)}}}),[["__scopeId","data-v-7df91474"]]);export{qe as default};
