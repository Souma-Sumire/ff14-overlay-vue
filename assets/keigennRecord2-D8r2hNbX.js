import{_ as e,e as t}from"./shared-common-BTkSSeU7.js";import{h as a,dx as n,x as s,w as l,b2 as o,dz as i,G as r,D as c,c as d,b as u,d as m,e as p,a as f,n as g,f as h,s as v,t as b,i as y,F as k,y as w,z as I,r as S,g as C,b9 as j,o as N,j as R,l as D,b7 as E,p as $,v as T,bW as A,cO as _,ch as x,b8 as M,cj as O}from"./vendor-vue-i6lpFrx4.js";import{u as P,ac as H,r as L,f as V,w as z,U as F,a9 as J,$ as K,Z as B,l as G,ad as W,t as Z,ae as U,af as Y,ag as q,ah as X,A as Q,ai as ee,aj as te,a7 as ae,ak as ne,s as se}from"./shared-core-3WpGeK2J.js";import{a as le,E as oe,aC as ie,aD as re,w as ce,J as de,t as ue,g as me,aE as pe,aF as fe,n as ge}from"./vendor-element-plus-C8e3lHeC.js";import{N as he,a as ve,l as be}from"./cactbot-DtpbXwrG.js";const ye={class:"table-container"},ke={class:"table-wrapper"},we={key:0,class:"row-info"},Ie={class:"info-line"},Se={class:"info-line"},Ce={class:"info-line"},je={class:"info-line"},Ne={class:"info-line"},Re={key:1,class:"skill-popover-content"},De={class:"subtitle"},Ee={class:"skill-grid"},$e=["title"],Te=["src"],Ae={class:"skill-text"},_e={class:"subtitle"},xe={class:"skill-grid"},Me=["title"],Oe=["src"],Pe={key:2,class:"no-data"},He={key:2,class:"death-recap-popover"},Le={class:"recap-header"},Ve={class:"align-right"},ze={class:"time"},Fe={class:"ability-cell"},Je={class:"ability-content"},Ke=["src"],Be=["title"],Ge={class:"status-cell"},We={class:"status-content"},Ze=["title","data-duration"],Ue=["src"],Ye=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e,{expose:t}){const a=V(),{t:j}=P(),N=e,R=H(),D=R.userOptions,E=n("contextMenu"),$=s(""),T=s("");l(()=>N.rows,e=>{0===e.length&&($.value="",T.value="")},{immediate:!0});const A=s(!1),_=s(0),x=s(0),M=s(null),O=s(null),J=s({getBoundingClientRect:()=>({top:0,left:0,bottom:0,right:0,width:0,height:0})}),K=s(null),B=s(!1),G=s("top"),W=o([]);function Z(e,t,a){K.value=t,"skills"===t?G.value="left":"death-recap"===t?(G.value="auto",function(e){const t=e.targetId,a=e.timestamp,n=a-2e4,s=[],l=N.rows.indexOf(e);if(-1===l)return;for(let i=l;i>=0;i--){const e=N.rows[i];if(e)if(e.timestamp<=a&&e.timestamp>=n)e.targetId===t&&s.push(e);else if(e.timestamp<n&&"push"===R.userOptions.order)break}for(let i=l+1;i<N.rows.length;i++){const e=N.rows[i];if(e)if(e.timestamp<=a&&e.timestamp>=n)e.targetId===t&&s.push(e);else if(e.timestamp<n&&"unshift"===R.userOptions.order)break}const o=Array.from(new Set(s)).sort((e,t)=>t.timestamp-e.timestamp);W.value=o.map(e=>{const t="heal"===e.effect||"crit heal"===e.effect,n="death"===e.type,s=!t&&e.amount>0&&!n;let l="",o="";t?(l="+",o="is-heal"):s&&(l="-",o="is-damage");const i=e.amount>0||t?l+e.preCalculated.amountDisplay:e.preCalculated.amountDisplay;return{key:e.key,timeStr:((e.timestamp-a)/1e3).toFixed(1).replace("-0.0","0.0")+"s",amountStr:i,amountClass:o,actionCN:e.actionCN,isDeath:n,iconSrc:"",keigenns:e.preCalculated.keigenns}})}(e)):G.value="right",O.value=e,J.value=a.currentTarget,B.value=!0}i(E,()=>{A.value=!1});const U=j("keigennRecord.cancelFilter"),Y=r(()=>{const e=N.rows.filter(e=>R.userOptions.debugShowHeals||"heal"!==e.effect&&"crit heal"!==e.effect),t=Array.from(new Set(e.map(e=>e[N.actionKey]))).filter(e=>null!=e);return[{label:U,value:""},...t.map(e=>({label:e,value:e}))]}),q=r(()=>{const e=N.rows.filter(e=>R.userOptions.debugShowHeals||"heal"!==e.effect&&"crit heal"!==e.effect),t=Array.from(new Map(e.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:U,value:"",job:-1},...t.map(e=>({label:e.job,fullLabel:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>F.enumSortMethod(e.job,t.job))});function X(){if(M.value){const e=M.value[N.actionKey];$.value===e?$.value="":$.value=e,A.value=!1}}function Q(){if(M.value){const e=M.value.targetId;T.value===e?T.value="":T.value=e,A.value=!1}}function ee(){R.userOptions.debugShowHeals=!R.userOptions.debugShowHeals,A.value=!1}const te=(e,t="")=>c("div",{class:["header-static",t]},e),ae=()=>c("div"),ne=e=>c("div",{class:"header-filter"},[c(le,{size:"small",modelValue:e.modelValue,placeholder:e.placeholder,clearable:!1,style:`width:${e.width}`,teleported:!0,popperClass:"keigenn-header-select-popper",onChange:e.onUpdate},()=>e.options.map(e=>c(oe,{key:e.value,label:e.label,value:e.value},{default:()=>e.fullLabel||e.label})))]),se=r(()=>{const e=N.rows.filter(e=>R.userOptions.debugShowHeals||"heal"!==e.effect&&"crit heal"!==e.effect);return $.value&&$.value!==U||T.value&&T.value!==U?e.filter(e=>{const t=!$.value||$.value===U||e[N.actionKey]===$.value,a=!T.value||T.value===U||e.targetId===T.value;return t&&a}):e}),pe=({rowData:e})=>"death"===e.type?"row-death":"",fe=[{key:"time",title:j("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>te(j("keigennRecord.time"),"header-time")},{key:"action",title:j("keigennRecord.action"),dataKey:N.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>c(ne,{modelValue:$.value,options:Y.value,placeholder:j("keigennRecord.action"),width:"4.5em",onUpdate:e=>$.value=e===U?"":e}),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source;return c("div",{class:"death-message-left"},[c("span","ðŸ’€ "),c("span",{class:"death-target-name"},e.target||"çŽ©å®¶"),c("span",t?[c("span"," å›  "),c("span",{class:"death-terrain"},"åœ°å½¢æ€"),c("span"," å€’ä¸‹äº†ï¼")]:[c("span"," è¢« "),c("span",{class:"death-source-name"},e.source||"çŽ¯å¢ƒä¼¤å®³"),c("span"," åšæŽ‰äº†ï¼")]),c("span",{class:"death-recap-inline",onMouseenter:t=>{Z(e,"death-recap",t)}}," [æ­»äº¡å›žæ”¾]")])}return c("span",e[N.actionKey]??"")}},{key:"target",title:j("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>c(ne,{modelValue:T.value,options:q.value,placeholder:j("keigennRecord.target"),width:"4.7em",onUpdate:e=>T.value=e===U?"":e}),cellRenderer:({rowData:e})=>"death"===e.type?ae():c("div",{class:"target"},[e.preCalculated.jobIconSrc?c("img",{class:[R.isBrowser?"browser":"act","jobIcon",`cj${R.userOptions.iconType}`],src:e.preCalculated.jobIconSrc,alt:e.jobIcon,onError:e=>{e.target.style.display="none"}}):c("span",{class:"alt-text"},e.job),e.hasDuplicate?c("span",{class:"has-duplicate"},R.formatterName(e.target)):void 0])},{key:"amount",title:j("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",headerCellRenderer:()=>te(j("keigennRecord.amount")),cellRenderer:({rowData:e})=>"death"===e.type?ae():c("span",{class:"amount",onMouseenter:t=>Z(e,"amount",t)},[c("span",{class:e.preCalculated.damageTypeClass},e.preCalculated.amountDisplay)])},{key:"reduction",title:j("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>te(j("keigennRecord.reduction"),"header-reduction"),cellRenderer:({rowData:e})=>"death"===e.type?ae():c("span",{class:"col-reduction-number",style:{color:e.preCalculated.reductionColor}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:j("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",headerCellRenderer:()=>te(j("keigennRecord.keigenns")),cellRenderer:({rowData:e})=>"death"===e.type?ae():c("div",{class:"status-container"},[...e.preCalculated.keigenns.map(e=>c("span",{class:"status-wrapper"},[c("span",{class:"status",title:e.title,"data-duration":e.duration,"data-sourcePov":e.isPov},[c("img",{class:["statusIcon",e.usefulClass],src:e.src,alt:e.effect,onError:L})])])),c("span",{class:"flags"},"damage done"===e.effect||"heal"===e.type?"":j(`keigennRecord.${e.effect}`))])},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>c("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:10}},"death"===e.type?void 0:c("div",{class:"view-icon",onMouseenter:t=>Z(e,"skills",t)},[c("div",{class:"dots"},[c("i"),c("i"),c("i")])]))}];let ge=null;const he={onClick:({rowData:e})=>{if("death"===e.type)return;const{actionCN:t,amount:a,job:n,keigenns:s,time:l,type:o,effect:i,currentHp:r,maxHp:c,shield:d,reduction:u}=e,m="damage done"===i?"":`,${j(`keigennRecord.${i}`)}`,p=`${l} ${n} ${t} ${a.toLocaleString()}(${j(`keigennRecord.${o}`)}) ${j("keigennRecord.reduction")}(${(100*u).toFixed(0)}%):${0===s.length&&""===m?j("keigennRecord.none"):s.map(e=>D.statusCN?e.name:e.effect).join(",")+m} ${j("keigennRecord.hp")}}:${r}(${Math.round(r/c*100)}%)+${j("keigennRecord.shield")}:${Math.round(c*+d/100)}(${d}%)`;z(p).then(()=>{ge?.close(),ge=me.success({message:j("keigennRecord.copySuccess"),duration:800})}).catch(()=>me.error(j("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const a=t;M.value=e,_.value=a.clientX,x.value=a.clientY,A.value=!0}},ve=s(null);return t({scrollToBottom:function(){ve.value&&ve.value.scrollToRow(se.value.length-1)}}),(t,n)=>{const s=ce,l=re,o=ue,i=de,r=ie;return f(),d("div",ye,[u("div",ke,[m(r,{style:{height:"100%",width:"100%"}},{default:p(({height:r,width:c})=>[m(l,{ref_key:"tableV2Ref",ref:ve,"header-class":"keigenn-table-header",class:"keigenn-table performance-table",columns:fe,data:se.value,width:c,height:r,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":he,"row-class":pe,"overscan-row-count":2},{empty:p(()=>[m(s,{description:h(R).isBrowser?t.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["data","width","height"]),h(A)?(f(),d("div",{key:0,ref_key:"contextMenu",ref:E,class:"context-menu",style:v({top:`${h(x)}px`,left:`${h(_)}px`})},[u("ul",null,[u("li",{onClick:X},b(h($)===(h(M)?.[e.actionKey]??"")?h(j)("keigennRecord.filter.action_cancel",{actionName:h(M)?.[e.actionKey]??h(j)("keigennRecord.this_skill")}):h(j)("keigennRecord.filter.action_only",{actionName:h(M)?.[e.actionKey]??h(j)("keigennRecord.this_skill")})),1),u("li",{onClick:Q},b(h(T)===h(M)?.targetId?h(j)("keigennRecord.filter.target_cancel",{jobName:h(M)?.job??h(j)("keigennRecord.this_job")}):h(j)("keigennRecord.filter.target_only",{jobName:h(M)?.job??h(j)("keigennRecord.this_job")})),1),h(a)?(f(),d("li",{key:0,style:{"border-top":"1px solid rgba(255,255,255,0.1)","margin-top":"4px","padding-top":"4px",color:"#aaa"},onClick:ee},b(h(R).userOptions.debugShowHeals?"è°ƒè¯•ï¼šéšè—æ²»ç–—ä¿¡æ¯":"è°ƒè¯•ï¼šæ˜¾ç¤ºæ²»ç–—ä¿¡æ¯"),1)):g("",!0)])],4)):g("",!0),m(i,{visible:h(B),"onUpdate:visible":n[0]||(n[0]=e=>y(B)?B.value=e:null),"virtual-ref":h(J),"virtual-triggering":"","popper-class":"keigenn-global-popover",transition:"none","show-after":0,"hide-after":0,offset:6,enterable:!0,teleported:!0,placement:"top",width:"auto","fallback-placements":["top-end","top-start","bottom","bottom-end","bottom-start"]},{default:p(()=>[h(O)&&"amount"===h(K)?(f(),d("div",we,[u("div",Ie,b(h(j)("keigennRecord.source"))+": "+b(h(O).source),1),u("div",Se,b(h(j)("keigennRecord.playerShield"))+": "+b(h(O).shield)+"%",1),u("div",Ce,b(h(j)("keigennRecord.playerHp"))+": "+b(h(O).currentHp.toLocaleString())+"("+b(h(O).preCalculated.hpPercent)+"%)",1),h(O).reduction<1&&"dot"!==h(O).type?(f(),d(k,{key:0},[n[1]||(n[1]=u("div",{class:"info-divider"},null,-1)),u("div",je,b(h(j)("keigennRecord.reductionRate"))+": "+b((100*h(O).reduction).toFixed(2))+"%",1),u("div",Ne,[w(b(h(j)("keigennRecord.originalDamage"))+": ",1),u("span",{class:I(h(O).preCalculated.damageTypeClass)},b(h(O).preCalculated.originalDamageDisplay),3)])],64)):g("",!0)])):h(O)&&"skills"===h(K)?(f(),d("div",Re,[h(O).preCalculated.coolingDownSkills.length>0?(f(),d(k,{key:0},[u("div",De,b(h(j)("keigennRecord.coolingDown")),1),u("div",Ee,[(f(!0),d(k,null,S(h(O).preCalculated.coolingDownSkills,e=>(f(),d("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[u("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[u("img",{src:e.icon,class:"skill-icon"},null,8,Te),n[2]||(n[2]=u("div",{class:"skill-overlay"},null,-1)),u("span",Ae,b(e.recastLeft),1)],8,$e)]))),128))])],64)):g("",!0),h(O).preCalculated.readySkills.length>0?(f(),d(k,{key:1},[h(O).preCalculated.coolingDownSkills.length>0?(f(),C(o,{key:0})):g("",!0),u("div",_e,b(h(j)("keigennRecord.ready")||"å¯ç”¨"),1),u("div",xe,[(f(!0),d(k,null,S(h(O).preCalculated.readySkills,e=>(f(),d("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[u("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[u("img",{src:e.icon,class:"skill-icon"},null,8,Oe)],8,Me)]))),128))])],64)):g("",!0),0===h(O).preCalculated.coolingDownSkills.length&&0===h(O).preCalculated.readySkills.length?(f(),d("div",Pe,b(h(j)("keigennRecord.noData")),1)):g("",!0)])):h(O)&&"death-recap"===h(K)?(f(),d("div",He,[u("div",Le,[u("span",null,b(h(j)("keigennRecord.time")),1),u("span",Ve,b(h(j)("keigennRecord.amount")),1),u("span",null,b(h(j)("keigennRecord.action")),1),u("span",null,b(h(j)("keigennRecord.keigenns")),1)]),(f(!0),d(k,null,S(h(W),e=>(f(),d("div",{key:e.key,class:I(["recap-row",{"is-death":e.isDeath}])},[u("span",ze,b(e.timeStr),1),u("span",{class:I(["amount-cell align-right",e.amountClass])},b(e.amountStr),3),u("div",Fe,[u("div",Je,[e.iconSrc?(f(),d("img",{key:0,src:e.iconSrc,class:"ability-icon"},null,8,Ke)):g("",!0),u("span",{class:"ability-name",title:e.actionCN},b(e.actionCN),9,Be)])]),u("div",Ge,[u("div",We,[(f(!0),d(k,null,S(e.keigenns,(e,t)=>(f(),d("div",{key:t,class:"status-wrapper"},[u("div",{class:I(["status",{"is-pov":e.isPov}]),title:e.title,"data-duration":e.duration},[u("img",{src:e.src,class:I(["status-icon",e.usefulClass])},null,10,Ue)],10,Ze)]))),128))])])],2))),128))])):g("",!0)]),_:1},8,["visible","virtual-ref"])]),_:1})])])}}}),[["__scopeId","data-v-3e7e3b42"]]),qe={class:"header-select"},Xe={style:{height:"100%"}},Qe={key:0,class:"testLog"},et="v20260131",tt=e(a({__name:"keigennRecord2",setup(e){const a=V(),n=H(),l=n.userOptions;n.checkIsBrowser();const i="push"===l.order,r=s(l.minimize),c=l.actionCN?"actionCN":"action",b=s(!1),y={POV_ID:"keigenn-record-2-pov-id",PARTY_LIST:"keigenn-record-2-party-list",ENTITIES_MAP:"keigenn-record-2-job-map",PARTY_EVENT:"keigenn-record-2-party-event-party",RSV_DATA:"souma-keigenn-record-2-rsv-data",ZONE_NAME:"souma-keigenn-record-2-zone-name",VERSION:"keigenn-record-2-data-version"};let P=!1;let L="",z=[],ie={},re=[],ce={},de=0,ue="",me=0;const ye=s(0),ke=o([{zoneName:"",duration:"00:00",table:j([]),key:"init",timestamp:-1}]),we={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:he.ability(),statusEffectExplicit:he.statusEffectExplicit(),gainsEffect:he.gainsEffect(),losesEffect:he.losesEffect(),death:he.wasDefeated(),changeZone:he.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:he.addedCombatant(),removingCombatant:he.removingCombatant(),networkDoT:he.networkDoT()};let Ie={},Se={friendly:{},enemy:{}},Ce={},je=new Map;const Ne=J.filter(e=>1===e.line||2===e.line),Re=K("keigenn-record-2");function De(){b.value=!0,de=0,Ce={},ye.value=0,ke.value.length=0,ke.value.push({zoneName:"",duration:"00:00",table:j([]),key:"init",timestamp:-1}),Ie={},Se={friendly:{},enemy:{}},ie={},re=[],z=[],L="",me=0,$e.clear(),xe.clear(),je.clear(),ce={}}async function Ee(){b.value=!1,null!==He&&(cancelAnimationFrame(He),He=null,Pe.length>0&&(i?(ke.value[0].table.push(...Pe),M(()=>Le.value?.scrollToBottom())):ke.value[0].table.unshift(...Pe.reverse()),Pe=[])),await Je(),x(ke)}const $e=new Map;const Te=n.icon4k;function Ae(e){const t=function(e){const t=Math.round(100*e)/100;if($e.has(t))return $e.get(t);const a=[88,88,88],n=[50,250,200],s=Math.min(1,t/.5),l=Math.min(9,Math.floor(10*s))/9,o=Math.pow(l,.8),i=a[0]+(n[0]-a[0])*o,r=a[1]+(n[1]-a[1])*o,c=a[2]+(n[2]-a[2])*o,d=`rgba(${Math.round(i)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return $e.set(t,d),d}(e.reduction),a=e.amount>999999?`${(e.amount/1e4).toFixed(0)}ä¸‡`:e.amount.toLocaleString(),n=((e,t)=>`https://souma.diemoe.net/resources/img/cj${t}/${e.replaceAll(/([A-Z])/g," $1").trim()}.png`)(e.jobIcon,l.iconType),{amount:s,maxHp:o,currentHp:i,shield:r,type:c,reduction:d}=e,u=Math.round(o*+r/100),m=Math.round(i/o*100),p=(s&&Math.round((s+u)/(1-d))||0).toLocaleString();return{...e,preCalculated:{reductionColor:t,amountDisplay:a,damageTypeClass:"heal"===e.effect||"crit heal"===e.effect?"is-heal":c,jobIconSrc:n,keigenns:e.keigenns.map(e=>({src:se(`/i/${e.fullIcon}${Te}.png`),usefulClass:ne(e,c),title:`${l.statusCN?e.name:e.effect}(${e.source})`,duration:e.remainingDuration??"",isPov:e.isPov,effect:e.effect})),originalDamageDisplay:p,hpPercent:m,coolingDownSkills:e.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[],readySkills:e.keySkills?.filter(e=>e.ready).sort((e,t)=>F.enumSortMethod(e.ownerJob,t.ownerJob))??[]}}}function _e(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!we.gainsEffect.exec(e))return;const t=a[be.GainsEffect.fields.effectId],n=a[be.GainsEffect.fields.effect],s=a[be.GainsEffect.fields.target],l=a[be.GainsEffect.fields.targetId],o=Number.parseInt(a[be.GainsEffect.fields.count],16);let i=Y(t);if(!i){const e=l.startsWith("1")&&q.get(Number.parseInt(t,16).toString())||l.startsWith("4")&&X.get(Number.parseInt(t,16).toString());if(!e)return;const a=Q(e.icon),n=o>1?ee(a,o):a;i={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[be.GainsEffect.fields.duration],c=a[be.GainsEffect.fields.source],d=a[be.GainsEffect.fields.sourceId],u=new Date(a[be.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:i.name,type:i.type,count:o,effect:n,effectId:t,source:c,sourceId:d,target:s,targetId:l,expirationTimestamp:u,performance:i.performance,fullIcon:i.fullIcon,isPov:L===d};l.startsWith("1")&&i.isFriendly?(void 0===Se.friendly[l]&&(Se.friendly[l]={}),Se.friendly[l][t]=m):l.startsWith("4")&&!i.isFriendly&&(void 0===Se.enemy[s]&&(Se.enemy[s]={}),Se.enemy[s][t]=m)}break;case"30":{const e=a[be.LosesEffect.fields.target],t=a[be.LosesEffect.fields.targetId],n=a[be.LosesEffect.fields.effectId];t.startsWith("1")?Se.friendly[t]&&Reflect.deleteProperty(Se.friendly[t],n):Se.enemy[e]&&Reflect.deleteProperty(Se.enemy[e],n)}break;case"21":case"22":{if(0===de)return;const e=a[be.Ability.fields.sourceId]??"???",t=a[be.Ability.fields.id]??"???",n=new Date(a[be.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),s=function(e){let t=je.get(e);if(!t){t=new Map;for(const a of Ne){if(a.minLevel>e)continue;const n=te(a.id,e);t.set(n,a)}je.set(e,t)}return t}(ie[e]?.level??999);s.get(a)&&(Ce[e]||(Ce[e]={}),Ce[e][a]=n)}const s=W(a),o=a[be.Ability.fields.targetId]??"???",i=s.isHeal&&s.amount>0&&o.startsWith("1"),r=s.isAttack&&s.amount>=0&&e.startsWith("4")&&o.startsWith("1");if(i||r){if(o!==L&&!z.includes(o)&&!re.find(e=>e.id===o))return;const e=a[be.Ability.fields.ability],r=e.match(/^_rsv_(?<id>\d+)_/);let c=e;if(r){const t=Number(r.groups?.id);c=ce[t]??e.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===l.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=Z(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(a[be.Ability.fields.targetCurrentHp]),p=Number(a[be.Ability.fields.targetMaxHp]),f=a[be.Ability.fields.source]??"???",g=a[be.Ability.fields.target]??"???",{effect:h,type:v}=U(s.flags),b=Ke(0===de?0:n-de),{jobEnum:y,job:k,jobIcon:w,hasDuplicate:I}=Oe(o),S=Object.values(Se.friendly[o]??[]).concat(Object.values(Se.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),C=Ie[o]??"0",j=s.amount;let N=0;if(!i&&"instant death"!==h&&"dodge"!==h){let e=1;"blocked damage"===h?e=.8:"parried damage"===h&&(e=.85);let t=1;for(const a of S)"absorbed"!==a.type&&(t*=a.performance[v]??1);N=1-t*e}Ve(Ae({key:(me++).toString(),time:b,timestamp:n,id:t,action:c,actionCN:u,source:f,target:g,targetId:o,job:k,jobIcon:w,jobEnum:y,hasDuplicate:I,amount:j,keigenns:S,currentHp:m,maxHp:p,effect:h,type:v,shield:C,povId:L,reduction:N,keySkills:Fe(n)})),ke.value[0].duration=Ke(new Date(a[be.Ability.fields.timestamp]).getTime()-de)}}break;case"25":{const t=we.death.exec(e);if(!t||!t.groups)return;const a=t.groups.targetId,n=t.groups.target,s=t.groups.sourceId,l="E0000000"===s?"åœ°å½¢æ€":t.groups.source,o=t.groups.timestamp;if(0===de)return;if(a!==L&&!z.includes(a)&&!re.find(e=>e.id===a))return;const i=new Date(o).getTime(),r=Ke(i-de),{jobEnum:c,job:d,jobIcon:u,hasDuplicate:m}=Oe(a);Ve(Ae({key:(me++).toString(),time:r,timestamp:i,id:"",action:"Death",actionCN:"E0000000"===s?"åœ°å½¢æ€":"çŽ¯å¢ƒä¼¤å®³",source:l,target:n,targetId:a,job:d,jobIcon:u,jobEnum:c,hasDuplicate:m,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:L,reduction:0,keySkills:Fe(i)}))}break;case"38":{const t=we.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Ie[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[be.InCombat.fields.inACTCombat],t="1"===a[be.InCombat.fields.inGameCombat],n=new Date(a[be.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[be.InCombat.fields.timestamp];if(de>0)return;return 0===ke.value[0].table.length&&0===Pe.length||(null!==He&&(cancelAnimationFrame(He),He=null),Pe.length>0&&(i?ke.value[0].table.push(...Pe):ke.value[0].table.unshift(...Pe.reverse()),Pe=[]),ke.value.unshift({zoneName:"",duration:"00:00",table:j([]),key:e,timestamp:n}),x(ke)),de=n,ke.value[0].zoneName=ue,ke.value[0].timestamp=n,ke.value[0].key=e,void(ye.value=0)}if(!e&&!t)return void ze(n)}break;case"01":{const e=parseInt(a[be.ChangeZone.fields.id],16);if(ue=a[be.ChangeZone.fields.name],B[e]?.name){const t=G(B[e]?.name);t&&"Unknown"!==t&&(ue=t)}ze(new Date(a[be.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=we.partyList.exec(e);t&&(z=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":L=a[be.ChangedPlayer.fields.id];break;case"03":if("00"!==a[be.AddedCombatant.fields.job]){const e=a[be.AddedCombatant.fields.job],t=a[be.AddedCombatant.fields.name],n=new Date(a[be.AddedCombatant.fields.timestamp]).getTime(),s=parseInt(a[be.AddedCombatant.fields.level],16);ie[a[be.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:s}}break;case"04":Reflect.deleteProperty(ie,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Se.friendly,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Se.enemy,a[be.RemovedCombatant.fields.id]);break;case"262":{const t=we.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[be.RSVData.fields.value];e&&n&&(ce[Number(e)]=n)}}break;case"24":if(!l.parseDoT)return;{const e=a[be.NetworkDoT.fields.which],t=a[be.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==L&&!z.includes(t)&&!re.find(e=>e.id===t))return;const n=a[be.NetworkDoT.fields.name],s=a[be.NetworkDoT.fields.damage],l=Number.parseInt(s,16),o=new Date(a[be.Ability.fields.timestamp]??"???").getTime(),i=Number(a[be.NetworkDoT.fields.currentHp]),r=Number(a[be.NetworkDoT.fields.maxHp]),c=Ke(0===de?0:o-de),{jobEnum:d,job:u,jobIcon:m,hasDuplicate:p}=Oe(t);Ve(Ae({key:(me++).toString(),time:c,timestamp:o,id:"",action:e,actionCN:e,source:"",target:n,targetId:t,job:u,jobIcon:m,jobEnum:d,hasDuplicate:p,amount:l,keigenns:[],currentHp:i,maxHp:r,effect:"damage done",type:"dot",shield:Ie[t]??"0",povId:L,reduction:0,keySkills:[]}))}}}const xe=new Map;function Me(){xe.clear()}function Oe(e){const t=xe.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=ie[e],a=re.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,s=n===t?Object.entries(ie).some(([t,a])=>t!==e&&a.job===n?.job&&z.includes(t)):re.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:s}}(e),s=a,l={jobEnum:s,job:F.jobToFullName(F.jobEnumToJob(s)).simple2,jobIcon:F.jobEnumToIcon(s),hasDuplicate:n};return xe.set(e,l),l}let Pe=[],He=null;const Le=s(null);function Ve(e){Pe.push(_(e)),null===He&&(He=requestAnimationFrame(()=>{i?(ke.value[0].table.push(...Pe),b.value||M(()=>Le.value?.scrollToBottom())):ke.value[0].table.unshift(...Pe.reverse()),Pe=[],He=null}))}function ze(e){0!==de&&(ke.value[0].duration=Ke(e-de),ke.value[0]=_(ke.value[0]),de=0,Se.friendly={},Se.enemy={},Ce={},Me(),Je())}function Fe(e){const t=new Set;re.forEach(e=>t.add(e.id)),z.forEach(e=>t.add(e)),L&&t.add(L);const a=[];for(const s of t){const e=re.find(e=>e.id===s);if(e){a.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const t=ie[s];t&&a.push({id:s,job:t.job,name:t.name??"Unknown",level:t.level})}const n=new Map;a.forEach(e=>n.set(e.job,(n.get(e.job)||0)+1));return a.flatMap(e=>{const t=e.level||999;return Ne.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const n=te(a.id,t),s=te(a.recast1000ms,t);return{id:n,name:Z(n)||"Unknown",icon:ae(n),recast1000ms:s,ownerId:e.id,ownerName:e.name,ownerJob:e.job,ownerJobName:F.jobToFullName(F.jobEnumToJob(e.job)).simple2}})}).map(t=>{const a=Ce[t.ownerId]?.[t.id]??0;let n=!0,s=0;if(a>0){const l=e-a,o=1e3*t.recast1000ms;l<o&&(n=!1,s=Math.ceil((o-l)/1e3))}return{...t,recastLeft:s,ready:n}})}async function Je(){if(b.value)return;const e=ke.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?O(e.table):[];return{...O(e),table:t}});await Re.replaceAll(e)}function Ke(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Be(){r.value=!r.value}function Ge(){"init"!==ke.value[0]?.key&&void 0!==ke.value[0]||(ke.value.unshift({zoneName:"",duration:"00:00",table:j([]),key:"test",timestamp:Date.now()}),x(ke),ye.value=0),Ve(Ae({key:(me++).toString(),time:Ke(Date.now()-(de||Date.now())),timestamp:Date.now(),id:"unknown",action:"test",actionCN:"æµ‹è¯•æŠ€èƒ½",source:"çŽ¯å¢ƒä¼¤å®³",target:"æµ‹è¯•è§’è‰²",targetId:"test-id",job:"æµ‹è¯•èŒä¸š",jobIcon:F.jobEnumToIcon(19),jobEnum:19,hasDuplicate:!1,amount:12345,keigenns:[],currentHp:5e4,maxHp:1e5,effect:"damage done",type:"physics",shield:"10",povId:"test-id",reduction:.1,keySkills:[]}))}function We(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return N(()=>{!function(){try{if(localStorage.getItem(y.VERSION)!==et)return Object.values(y).forEach(e=>{e!==y.VERSION&&localStorage.removeItem(e)}),localStorage.setItem(y.VERSION,et),void(P=!0);const e=localStorage.getItem(y.POV_ID);e&&(L=e);const t=localStorage.getItem(y.PARTY_LIST);t&&(z=JSON.parse(t));const a=localStorage.getItem(y.ENTITIES_MAP);a&&(ie=JSON.parse(a));const n=localStorage.getItem(y.PARTY_EVENT);n&&(re=JSON.parse(n));const s=localStorage.getItem(y.RSV_DATA);s&&(ce=JSON.parse(s));const l=localStorage.getItem(y.ZONE_NAME);l&&(ue=l)}catch(e){}}();const e=R({storageKey:"keigenn-record-2-theme"}),t=D(e);!1===e.value&&t();for(const a in ie){const e=ie[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(ie,a)}!async function(){ye.value=0;try{if(P)await Re.replaceAll([]),ke.value.length=0;else{const e=await Re.getAll();if(e.length){ke.value.length=0;let t=e.filter(e=>n.isBrowser||e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp);i||(t=t.reverse());const a=t.map(e=>({...e,table:j(Array.isArray(e.table)?e.table.map(e=>_(e)):[])}));ke.value.push(...a)}}0===ke.value.length&&ke.value.push({zoneName:"",duration:"00:00",table:j([]),key:"init",timestamp:-1}),x(ke)}catch(e){throw ke.value.length=0,e}}(),ve("LogLine",e=>{_e(e.rawLine)}),ve("PartyChanged",e=>{re=e.party.map(e=>({...e,timestamp:Date.now()})),Me()}),ve("ChangePrimaryPlayer",e=>{L=Number(e.charID).toString(16).toUpperCase()}),ve("CombatData",e=>{if(!(de>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(ue=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==ke.value[0].table.length&&(ke.value.unshift({zoneName:"",duration:"00:00",table:j([]),key:String(n),timestamp:n}),x(ke)),ke.value[0].zoneName=ue,de=n,ke.value[0].timestamp=n,ke.value[0].key=String(n),ye.value=0}})}),E(()=>{!function(){try{localStorage.setItem(y.POV_ID,L),localStorage.setItem(y.PARTY_LIST,JSON.stringify(z)),localStorage.setItem(y.ENTITIES_MAP,JSON.stringify(ie)),localStorage.setItem(y.PARTY_EVENT,JSON.stringify(re)),localStorage.setItem(y.RSV_DATA,JSON.stringify(ce)),localStorage.setItem(y.ZONE_NAME,ue)}catch(e){}}()}),(e,s)=>{const o=oe,i=le,b=ge,y=Ye,j=t;return f(),d(k,null,[u("div",{class:"wrapper",style:v({"--scale":h(l).scale,"--opacity":h(l).opacity}),onContextmenu:s[1]||(s[1]=A(()=>{},["prevent"]))},[u("header",null,[u("div",qe,[$(m(i,{modelValue:ye.value,"onUpdate:modelValue":s[0]||(s[0]=e=>ye.value=e),size:"small",class:I(["combat-select",h(n).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:p(()=>[(f(!0),d(k,null,S(ke.value.length,e=>(f(),C(o,{key:`${ke.value[e-1].key}-${ke.value[e-1].duration}-${ke.value[e-1].zoneName}`,value:e-1,label:`${ke.value[e-1].zoneName}${""===ke.value[e-1].zoneName?"":` - [${ke.value[e-1].duration}] ${We(ke.value[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[T,!r.value]])]),h(n).isBrowser?g("",!0):(f(),C(b,{key:0,class:I(["minimize",r.value?"in-minimize":"not-minimize"]),icon:r.value?h(pe):h(fe),circle:"",style:v({opacity:r.value?.5:1}),onClick:Be},null,8,["class","icon","style"]))]),$(u("main",Xe,[m(y,{ref_key:"tableRef",ref:Le,rows:ke.value[ye.value].table,"action-key":h(c)},null,8,["rows","action-key"])],512),[[T,!r.value]])],36),h(n).isBrowser||h(a)?(f(),d("div",Qe,[h(a)?(f(),C(b,{key:0,onClick:Ge},{default:p(()=>[...s[2]||(s[2]=[w(" æµ‹è¯• ",-1)])]),_:1})):g("",!0),m(j,{"m-1":"",onBeforeHandle:De,onAfterHandle:Ee,onHandleLine:_e})])):g("",!0)],64)}}}),[["__scopeId","data-v-0c528998"]]);export{tt as default};
