import"./index-CyFUfx3x.js";/* empty css                  *//* empty css                */import{u as e,_ as t,p as n}from"./TimelineShow-BY5_iFfi.js";import{l}from"./lz-string-uL7b9dJQ.js";/* empty css                 *//* empty css                        *//* empty css                   *//* empty css                  *//* empty css               *//* empty css                  *//* empty css               *//* empty css                *//* empty css                *//* empty css                        *//* empty css                  *//* empty css                  */import{h as a,C as i,D as s,r as o,F as c,e as r,G as d,f as u,H as p,I as m,J as f,z as y,y as g,m as w,j as b,n as h,K as v,s as _,L as x,M as T,d as O,k as S,l as V,o as $,q as F,N as k,O as I,b as j,P as C,B}from"./element-plus-BPeHK5i2.js";import{g as A}from"./actionChinese-5sTdZFSW.js";import{U as z}from"./util-u6u0BslC.js";import{h as N,g as E}from"./xivapi-CDkmt4QZ.js";import{t as U,r as D,V as P,f as J,v as M,x as K,M as L,D as R,H,A as q,E as W,J as G,S as Q,u as X,h as Y,K as Z,L as ee,a9 as te,d as ne,c as le,aq as ae,C as ie,w as se}from"./vue-vendor-Bp7_Yb1I.js";import{_ as oe}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as ce}from"./useWebSocket-Dkn8N2er.js";import{c as re}from"./el-space-C6hHzNgb.js";import{h as de}from"./utils-CBOc1lqT.js";import{z as ue}from"./zoneInfo-CyhIZ0MY.js";import{a as pe,c as me}from"./overlay_plugin_api-DHbPkDtN.js";/* empty css                */import{b as fe}from"./index-CPPE20Uu.js";import"./zone_info-CC6h72pn.js";class ye{prefix;maxSize;cleanupRatio;constructor(e){this.prefix=e?.prefix??"cache:",this.maxSize=e?.maxSize??2097152,this.cleanupRatio=e?.cleanupRatio??.25}buildKey(e){return this.prefix+e}getAllCacheKeys(){return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix))}getTotalSize(){return this.getAllCacheKeys().reduce((e,t)=>{const n=localStorage.getItem(t);return e+(n?new Blob([n]).size:0)},0)}cleanupOldEntries(){const e=[];for(const n of this.getAllCacheKeys())try{const t=localStorage.getItem(n);if(!t)continue;const l=JSON.parse(t);e.push({key:n,expire:l.expire??0})}catch{localStorage.removeItem(n)}e.sort((e,t)=>e.expire-t.expire);const t=Math.ceil(e.length*this.cleanupRatio);for(let n=0;n<t;n++)localStorage.removeItem(e[n].key)}set(e,t,n=36e5){const l=this.buildKey(e),a={data:t,expire:Date.now()+n};try{localStorage.setItem(l,JSON.stringify(a))}catch{this.cleanupOldEntries();try{localStorage.setItem(l,JSON.stringify(a))}catch(i){}}this.getTotalSize()>this.maxSize&&this.cleanupOldEntries()}get(e){const t=this.buildKey(e);try{const e=localStorage.getItem(t);if(!e)return null;const n=JSON.parse(e);return n.expire<Date.now()?(localStorage.removeItem(t),null):n.data}catch{return localStorage.removeItem(t),null}}clearExpired(){const e=Date.now();for(const t of this.getAllCacheKeys())try{const n=JSON.parse(localStorage.getItem(t));(!n.expire||n.expire<e)&&localStorage.removeItem(t)}catch{localStorage.removeItem(t)}}clearAll(){for(const e of this.getAllCacheKeys())localStorage.removeItem(e)}}const ge=new Map;ge.set(26155,{type:"cast",window:[999,999],battleOnce:!0}),ge.set(28027,{type:"cast",window:[999,999],battleOnce:!0}),ge.set(26340,{type:"cast",window:[999,999],battleOnce:!0}),ge.set(25533,{type:"begincast",window:[60,60]}),ge.set(26376,{type:"cast",window:[999,999],battleOnce:!0}),ge.set(26814,{type:"begincast",window:[999,999],battleOnce:!0}),ge.set(25313,{type:"begincast",window:[200,200]}),ge.set(27526,{type:"begincast",window:[999,999],battleOnce:!0}),ge.set(26215,{type:"cast",window:[500,30],battleOnce:!0}),ge.set(29050,{type:"begincast",window:[200,30],battleOnce:!0}),ge.set(29156,{type:"cast",window:[20,20]}),ge.set(27973,{type:"cast",window:[20,20]}),ge.set(27937,{type:"begincast",window:[20,20]}),ge.set(28059,{type:"begincast",window:[20,20]}),ge.set(28060,{type:"begincast",window:[20,20]}),ge.set(28061,{type:"begincast",window:[20,20]}),ge.set(27956,{type:"begincast",window:[20,20]}),ge.set(27957,{type:"begincast",window:[20,20]}),ge.set(27952,{type:"begincast",window:[30,30]}),ge.set(27969,{type:"begincast",window:[20,20]}),ge.set(27971,{type:"begincast",window:[20,20]}),ge.set(27939,{type:"begincast",window:[20,20]}),ge.set(27966,{type:"begincast",window:[20,20]}),ge.set(25316,{type:"begincast",window:[999,999],battleOnce:!0}),ge.set(25544,{type:"begincast",window:[10,10]}),ge.set(26379,{type:"begincast",window:[10,10]}),ge.set(31552,{type:"begincast",window:[30,30]}),ge.set(31573,{type:"begincast",window:[30,30]}),ge.set(31573,{type:"begincast",window:[30,30]}),ge.set(31617,{type:"begincast",window:[8,8]}),ge.set(31624,{type:"begincast",window:[30,30]}),ge.set(31649,{type:"begincast",window:[30,30]}),ge.set(18864,{type:"cast",window:[10,2.5],syncOnce:!0}),ge.set(18480,{type:"cast",window:[200,60],syncOnce:!0,battleOnce:!0}),ge.set(18516,{type:"cast",window:[250,65],syncOnce:!0,battleOnce:!0}),ge.set(18522,{type:"begincast",window:[500,500],syncOnce:!0,battleOnce:!0}),ge.set(18552,{type:"begincast",window:[67,67],syncOnce:!0}),ge.set(18553,{type:"cast",window:[67,67],syncOnce:!0}),ge.set(19083,{type:"cast",window:[900,0],syncOnce:!0,battleOnce:!0}),ge.set(40191,{type:"begincast",window:[200,20],syncOnce:!0}),ge.set(40265,{type:"begincast",window:[500,20],syncOnce:!0,battleOnce:!0}),ge.set(40246,{type:"begincast",window:[999,30],syncOnce:!0,battleOnce:!0}),ge.set(40306,{type:"begincast",window:[30,30],syncOnce:!0}),ge.set(11103,{type:"begincast",window:[310,30],syncOnce:!0,battleOnce:!0}),ge.set(11517,{type:"begincast",window:[600,30],syncOnce:!0,battleOnce:!0}),ge.set(11122,{type:"begincast",window:[100,30],syncOnce:!0,battleOnce:!0}),ge.set(11143,{type:"begincast",window:[60,60],syncOnce:!0}),ge.set(11126,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ge.set(11596,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ge.set(11597,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ge.set(42785,{type:"begincast",window:[9.6,2],syncOnce:!0}),ge.set(42838,{type:"cast",window:[77.2,30],syncOnce:!0,battleOnce:!0}),ge.set(42863,{type:"cast",window:[30,30],syncOnce:!1}),ge.set(42787,{type:"cast",window:[30,30],syncOnce:!1}),ge.set(42864,{type:"cast",window:[30,30],syncOnce:!1}),ge.set(41946,{type:"begincast",window:[10,10],syncOnce:!1}),ge.set(41936,{type:"begincast",window:[10,10],syncOnce:!0}),ge.set(41939,{type:"begincast",window:[10,10],syncOnce:!0}),ge.set(42825,{type:"begincast",window:[400,10],syncOnce:!0,battleOnce:!0}),ge.set(41969,{type:"begincast",window:[10,10],syncOnce:!0}),ge.set(41871,{type:"cast",window:[140,0],syncOnce:!0,battleOnce:!0}),ge.set(43053,{type:"cast",window:[610,0],syncOnce:!0,battleOnce:!0});const we={class:"query-results"},be={class:"ability-filter-container"},he={key:0,class:"loading-abilities"},ve=["src","alt","onerror"],_e=oe(U({__name:"FflogsImport",props:{filters:{}},emits:["showFFlogsToggle","editTimeline"],setup(t,{emit:n}){const l=t,v=n,_=new RegExp("(?<=^|\\/)(?<code>\\w{16,})[#?]fight=(?<fight>\\d+|last)"),x={begincast:"14",cast:"1[56]"},T=D("查询"),O=D(""),S=D(!1),V=D(!1),$=D(0),F=D(!1),k=P({});ae();const I=e(),j=new ye({prefix:"fflogs:",maxSize:2097152,cleanupRatio:.25});function C(e){const t=j.get(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}function B(e,t,n=36e5){const l={data:t,expire:Date.now()+n};j.set(e,JSON.stringify(l),n)}function U(e){return e&&e.expire>Date.now()}async function ne(e){V.value=!0,$.value=2,k.player=e;try{await async function(){F.value=!1;const e=[];async function t(n){try{const l=`fflogs:events:friendly:${k.code}:${n}:${k.player?.id}`,a=C(l);let i;a&&U(a)?i=a.data:(i=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${k.code}?start=${n}&end=${k.end}&hostility=0&sourceid=${k.player?.id}&api_key=${I.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),B(l,i)),e.push(...i.events),i.nextPageTimestamp&&i.nextPageTimestamp>0&&i.nextPageTimestamp<k.end&&await t(i.nextPageTimestamp)}catch(l){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${l}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function n(t,l){if(l>=0)try{const a=`fflogs:events:enemy:${k.code}:${t}:${k.bossIDs[l]}`,i=C(a);let s;i&&U(i)?s=i.data:(s=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${k.code}?start=${t}&end=${k.end}&hostility=1&sourceid=${k.bossIDs[l]}&api_key=${I.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),B(a,s)),e.push(...s.events),s.nextPageTimestamp&&s.nextPageTimestamp>0&&s.nextPageTimestamp<k.end&&await n(s.nextPageTimestamp,l),l<k.bossIDs.length-1&&await n(t,l+1)}catch(a){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${a}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}k.abilityFilterEvents.length=0,await Promise.all([t(k.start),n(k.start,0)]);for(const l of e)"begincast"===l.type&&l.sourceIsFriendly||k.abilityFilterEvents.push({time:Number(((l.timestamp-k.start)/1e3).toFixed(1)),type:l.type,actionName:A(l.ability.guid)??l.ability.name,actionId:l.ability.guid,sourceIsFriendly:l.sourceIsFriendly,url:l?.ability?.abilityIcon.replace("-","/").replace(".png","")??"000000/000405",window:void 0,sourceID:l.sourceID});k.player?.icon&&l.filters[k.player.icon]&&(k.abilityFilterSelected=l.filters[k.player.icon]);F.value=!0}(),k.abilityFilterCandidate=k.abilityFilterEvents.reduce((e,t)=>(t.sourceIsFriendly&&!e.find(e=>e.actionId===t.actionId)&&e.push(t),e),[]),V.value=!1}catch(t){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${t}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),V.value=!1}}function le(){V.value=!0,$.value=3,k.player?.icon&&I.updateFilters(k.player?.icon,JSON.parse(JSON.stringify(k.abilityFilterSelected))),k.abilityFilterEvents=k.abilityFilterEvents.filter(e=>e.sourceIsFriendly&&k.abilityFilterSelected.includes(e.actionId)||!e.sourceIsFriendly).sort((e,t)=>e.time-t.time),k.abilityFilterEvents=function(e){for(const t of e){const e=ge.get(t.actionId);e?.type===t.type&&(t.window=e?.window),t.syncOnce=Boolean(e?.syncOnce),t.battleOnce=Boolean(e?.battleOnce)}return e}(k.abilityFilterEvents),k.abilityFilterEventsAfterFilterRawTimeline=k.abilityFilterEvents.map(e=>{const{time:t,actionName:n,actionId:l,type:a,sourceID:i,window:s,sourceIsFriendly:o,syncOnce:c,battleOnce:r}=e;if(o)return`${t} "<${n}>~"${S.value?` tts "${n}"`:""}`;if(/^(?:攻击|attack|攻撃)$/i.test(n)&&!s||"cast"===a&&!s||k.battleSyncedIDs.includes(l))return`# ${t} "${n}"`;const d=k.enemies.find(e=>e.id===i);if(("NPC"===d?.type||/unknown/.test(n))&&!s)return null;const u=l.toString(16).toUpperCase(),p=`${t} "${n}" sync${c?".once":""} /^.{14} \\w+ ${x[a]}:4.{7}:[^:]+:${u}:/`;return r&&s&&k.battleSyncedIDs.push(l),s?`${p} window ${s.join(",")}`:`# ${p}`}).filter(e=>null!==e).join("\n");const e=I.newTimeline(`导入${k.player?.name}`,{zoneId:k.zoneID.toString(),jobs:[k.player?.icon??"NONE"]},k.abilityFilterEventsAfterFilterRawTimeline,`${k.code}#fight=${k.fightIndex+1}`);ae(),v("showFFlogsToggle"),v("editTimeline",I.allTimelines[e]),setTimeout(()=>{$.value=0},500),V.value=!1}function ae(){k.code="",k.fightIndex=0,k.start=0,k.end=0,k.friendlies=[],k.abilityFilterEvents=[],k.abilityFilterCandidate=[],k.abilityFilterSelected=[],k.abilityFilterEventsAfterFilterRawTimeline="",k.player=void 0,k.zoneID=0,k.bossIDs=[],k.enemies=[],k.battleSyncedIDs=[]}function ie(){window.open("https://cn.fflogs.com/profile","_blank")}return J(()=>{j.clearExpired()}),(e,t)=>{const n=a,l=i,v=s,x=r,j=c,A=d,D=u,P=p,J=f,se=o,oe=y,ce=g,re=h,de=w;return K(),M(ee,null,[L(n,{style:Q(X($)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"","position-absolute":"","z-999":"",class:"guide",onClick:t[0]||(t[0]=e=>$.value--)},{default:W(()=>t[6]||(t[6]=[G(" 上一步 ")])),_:1,__:[6]},8,["style"]),L(v,{active:X($),class:"steps-guide","align-center":""},{default:W(()=>[L(l,{title:"输入链接"}),L(l,{title:"选择玩家"}),L(l,{title:"过滤技能"})]),_:1},8,["active"]),0===X($)?(K(),R(se,{key:0,class:"input-section"},{default:W(()=>[L(J,{"label-width":"150px",class:"fflogs-form"},{default:W(()=>[L(j,{label:"FF Logs 战斗链接"},{default:W(()=>[L(x,{modelValue:X(O),"onUpdate:modelValue":t[1]||(t[1]=e=>Y(O)?O.value=e:null),placeholder:"https://www.fflogs.com/reports/AAAaAaAAaa1aA1aA?fight=1",autocomplete:"on"},null,8,["modelValue"])]),_:1}),L(j,{label:"FF logs V1 Key"},{default:W(()=>[L(x,{modelValue:X(I).settings.api,"onUpdate:modelValue":t[2]||(t[2]=e=>X(I).settings.api=e),placeholder:"在 FF Logs 个人设置页面获取 V1 API Key",type:"password","show-password":""},{append:W(()=>[L(A,{content:"点击前往 FF Logs 个人设置页面，在最下方填写 V1客户名称 并点击确认后，再获取你的 V1 客户端密钥",placement:"top",effect:"light"},{default:W(()=>[L(n,{type:"primary",link:"",onClick:ie},{default:W(()=>t[7]||(t[7]=[G(" 如何获取 ")])),_:1,__:[7]})]),_:1})]),_:1},8,["modelValue"])]),_:1}),L(j,{label:"使用 TTS"},{default:W(()=>[L(D,{modelValue:X(S),"onUpdate:modelValue":t[3]||(t[3]=e=>Y(S)?S.value=e:null)},null,8,["modelValue"])]),_:1}),L(j,null,{default:W(()=>[L(n,{disabled:"正在查询..."===X(T),type:"primary",onClick:t[4]||(t[4]=e=>async function(e){V.value=!0,ae(),T.value="正在查询...";const t=e.match(_);if(!I.settings.api)return b.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方<strong>填写 V1 客户名称并点击确认</strong>后，获取你的 V1 客户端密钥</a>'}),T.value="查询",void(V.value=!1);if(!t)return b.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),T.value="查询",void(V.value=!1);k.code=t.groups?.code??"";try{const e=`fflogs:fights:${k.code}`,n=C(e);let l;n&&U(n)?l=n.data:(l=await fetch(`https://cn.fflogs.com/v1/report/fights/${k.code}?api_key=${I.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),B(e,l)),k.bossIDs=l.enemies.filter(e=>["Boss","NPC"].includes(e.type)).map(e=>e.id),k.enemies=l.enemies.slice(),k.fightIndex=("last"===t?.groups?.fight?l.fights.length:Number.parseInt(t?.groups?.fight??"0"))-1;const a=l.fights[k.fightIndex];k.zoneID=a.zoneID,k.start=a.start_time,k.end=a.end_time,k.friendlies=l.friendlies.filter(e=>"LimitBreak"!==e.icon&&e.fights.find(e=>e.id===k.fightIndex+1)),T.value="查询",k.abilityFilterEvents.length=0,k.abilityFilterCandidate.length=0,V.value=!1,$.value=1}catch(n){b.alert(`\n  <h3 style="margin-bottom: 10px;">可能的原因：</h3>\n  <ul style="padding-left: 20px; margin-bottom: 10px;">\n    <li> <strong>90%概率</strong>：你没有<strong style="color: red;">先起名</strong>再获取 V1 客户端密钥</li>\n    <li> <strong>5%概率</strong>：该战斗记录是私人或匿名模式</li>\n    <li> <strong>5%概率</strong>：网络异常</li>\n  </ul>\n<p class="error-details"><strong>错误：</strong>${n}</p>\n`,"请求失败",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),T.value="查询",V.value=!1}}(X(O)))},{default:W(()=>[X(V)?(K(),R(P,{key:0,class:"is-loading"},{default:W(()=>[L(X(m))]),_:1})):H("",!0),G(" "+Z(X(T)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):H("",!0),q("div",we,[1===X($)?(K(),R(se,{key:0,class:"player-selection"},{default:W(()=>[L(ce,{data:X(k).friendlies.filter(e=>!["NPC"].includes(e.icon)),stripe:"",border:"",class:"friendlies-table"},{default:W(()=>[L(oe,{prop:"name",label:"玩家名称"}),L(oe,{label:"职业"},{default:W(({row:e})=>[G(Z(X(z).nameToFullName(X(z).jobEnumToJob(X(z).iconToJobEnum(e.icon))).cn),1)]),_:1}),L(oe,{label:"选定",width:"100",align:"center"},{default:W(e=>[L(n,{type:"primary",size:"small",onClick:t=>ne(e.row)},{default:W(()=>t[8]||(t[8]=[G(" 选择 ")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):H("",!0),2===X($)?(K(),R(se,{key:1,class:"ability-filter"},{default:W(()=>[q("div",be,[X(F)?H("",!0):(K(),M("div",he,[L(P,{class:"is-loading"},{default:W(()=>[L(X(m))]),_:1}),t[9]||(t[9]=q("span",null,"正在加载技能列表...",-1))])),X(F)?(K(),R(de,{key:1,modelValue:X(k).abilityFilterSelected,"onUpdate:modelValue":t[5]||(t[5]=e=>X(k).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:W(()=>[(K(!0),M(ee,null,te(X(k).abilityFilterCandidate,e=>(K(),R(re,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:W(()=>[q("img",{src:X(E)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:X(N)},null,8,ve),q("span",null,Z(e.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])):H("",!0),X(F)?(K(),R(n,{key:2,type:"success",class:"filter-confirm-btn",disabled:!X(F),onClick:le},{default:W(()=>t[10]||(t[10]=[G(Z("生成时间轴"))])),_:1,__:[10]},8,["disabled"])):H("",!0)])]),_:1})):H("",!0)])],64)}}}),[["__scopeId","data-v-1bd29990"]]),xe=oe(U({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(n,{emit:l}){const a=n,i=l,s=e();ne(()=>{s.saveTimelineSettings()});const o=le({get:()=>a.modelValue,set:e=>i("update:modelValue",e)}),r=D(-15),d=D([{time:-15,action:"<圣光幕帘>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:-2,action:"<圣灵>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:0,action:"战斗开始！",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:3,action:"<挑衅>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:5,action:"<神圣领域>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1}]);return(e,n)=>{const l=O,a=c,i=T,u=_,p=x,m=t,y=f,g=v;return K(),R(g,{modelValue:X(o),"onUpdate:modelValue":n[1]||(n[1]=e=>Y(o)?o.value=e:null),modal:!0,overflow:"","close-on-click-modal":!1,"close-on-press-escape":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:W(()=>n[2]||(n[2]=[q("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)])),default:W(()=>[L(y,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:W(()=>[n[3]||(n[3]=q("h3",{class:"form-section-title"}," 参数 ",-1)),L(u,{gutter:20},{default:W(()=>[(K(!0),M(ee,null,te(X(s).configValues,(e,t,n)=>(K(),R(i,{key:n,span:12},{default:W(()=>[L(a,{label:X(s).configTranslate[t]},{default:W(()=>[L(l,{modelValue:X(s).configValues[t],"onUpdate:modelValue":e=>X(s).configValues[t]=e,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),n[4]||(n[4]=q("h3",{class:"form-section-title"}," 样式 ",-1)),L(u,{gutter:20},{default:W(()=>[(K(!0),M(ee,null,te(X(s).showStyle,(e,t,n)=>(K(),R(i,{key:n,span:12},{default:W(()=>[L(a,{label:X(s).showStyleTranslate[t]},{default:W(()=>[L(l,{modelValue:X(s).showStyle[t],"onUpdate:modelValue":e=>X(s).showStyle[t]=e,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),n[5]||(n[5]=q("h3",{class:"form-section-title"}," 测试用例 ",-1)),L(u,{gutter:20},{default:W(()=>[L(p,{modelValue:X(r),"onUpdate:modelValue":n[0]||(n[0]=e=>Y(r)?r.value=e:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),L(m,{config:X(s).configValues,lines:X(d),runtime:X(r),"show-style":X(s).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1,__:[3,4,5]})]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-fcf4e153"]]),Te={key:0,class:"alerts-container"},Oe={class:"batch-operations",style:{"margin-bottom":"15px",display:"flex","justify-content":"space-between"}},Se={class:"editor-dialog-content"},Ve={class:"slider-demo-block"},$e={class:"time-display",style:{width:"80px","text-align":"center"}},Fe={class:"time-display-text"},ke={class:"time-display-text"},Ie={style:{"margin-top":"1em"}},je=oe(U({__name:"timelineSettings",setup(i){const s=ae(),{wsConnected:d}=ce({allowClose:!0,addWsParam:!0}),u=e(),p=ie(u,"allTimelines"),m=ie(u,"filters"),f=D(0),O=fe("realtimeMode",!0),A=D([]),N=D(!1),E=D(!1),U=D(!1),P=D(!1),ne=fe("timelineCurrentlyEditing",{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}),oe=D([]),ye=[{id:"0",name:"任意"}];let ge=null,we=!1;const be=le(()=>{const e=f.value,t=e<0,n=Math.abs(Math.floor(e)),l=Math.floor(n/60),a=n%60;return`${t?"-":""}${String(l).padStart(2,"0")}:${String(a).padStart(2,"0")}`}),he=le(()=>{n(ne.value.timeline);return Math.max(...oe.value.map(e=>e.time),550)+30});function ve(e){ne.value=e,E.value=!0,Be()}function je(){E.value=!1}function Ce(){ve(u.allTimelines[u.newTimeline()])}function Be(){oe.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],n(ne.value.timeline).then(e=>{oe.value=e}),f.value=-u.configValues.preBattle}function Ae(){if(0===A.value.length)return void j.warning("请选择要删除的时间轴");const e=A.value.map(e=>`「${e.name}」`).join("<br/>");b.confirm(`确定要删除选中的 ${A.value.length} 个时间轴吗？<br>${e}`,"批量删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",dangerouslyUseHTMLString:!0,type:"warning"}).then(()=>{p.value=p.value.filter(e=>!A.value.includes(e)),A.value=[],N.value=!1,j.success(`成功删除 ${A.value.length} 个时间轴`)}).catch(()=>{})}function ze(){N.value=!N.value,A.value=N.value?[...p.value]:[]}function Ne(){b.confirm(O.value?"关闭实时更新模式后，你需要手动点击'应用'按钮，数据才会发送至悬浮窗。":"开启实时更新模式后，你不再需要手动点击'应用'按钮了，所有改动将立即生效。","提示",{confirmButtonText:O.value?"关闭实时更新模式":"开启实时更新模式",cancelButtonText:"再想想",type:"warning"}).then(()=>{O.value=!O.value,O.value&&Je("post",u.$state)}).catch(()=>{})}function Ee(){0!==A.value.length?Ue(A.value):j.warning("请选择要导出的时间轴")}function Ue(e){const t=JSON.stringify(e),n=JSON.parse(t);for(const l of n)l.timeline=l.timeline.replace(/^#.*(?:\n|$)/gm,"");const a=JSON.stringify(n),i=l.compressToBase64(t),s=l.compressToBase64(a),o=i.length,c=s.length;if(o===c)return void Qe(i,"数据复制成功，已写入剪切板。","复制失败，请手动复制！");const r=((o-c)/o*100).toFixed(2);b.confirm(`\n     1. 完整版本（包含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${o} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>\n     2. 优化版本（不含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${c} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 节省 ${r}% 的空间<br>\n     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:e=>{if("cancel"===e||"confirm"===e){Qe("confirm"===e?s:i,"数据复制成功，已写入剪切板。","复制失败，请手动复制！")}}})}function De(){b.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:e=>{if(!e)return"请输入导出的字符串";const t=e.split("\n").filter(e=>""!==e.trim());let n=[];for(const a of t){let e;try{e=JSON.parse(a)}catch{try{const t=l.decompressFromBase64(a);e=JSON.parse(t)}catch{return`无法解析输入的数据：${a}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(e))return`导入的数据格式不正确：${a}`;n=n.concat(e)}return 0!==n.length||"导入的数据不包含任何时间轴。"},inputErrorMessage:"无效的输入"}).then(({value:e})=>{const t=e.split("\n").filter(e=>""!==e.trim());let n=[];for(const s of t){let e;try{e=JSON.parse(s)}catch{const t=l.decompressFromBase64(s);e=JSON.parse(t)}n=n.concat(e)}const a=n.length,i=n.map(e=>`「${e.name}」`).join(", ");b({title:"确认",message:`导入 ${a} 个时间轴：\n${i}\n？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:e=>{"cancel"===e?b.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:e})=>{"我确认"===e&&Pe(n,!0)}).catch(()=>{}):"confirm"===e&&Pe(n,!1)}})}).catch(()=>{})}function Pe(e,t){t&&(u.allTimelines.length=0),u.allTimelines.push(...e),u.sortTimelines();for(const i of u.allTimelines)void 0===i.condition.jobs&&(i.condition.jobs=[i.condition.job]);if(t)return void j({type:"success",message:"覆盖成功！",duration:2e3});const n=[],l=new Set;for(const i of u.allTimelines){const e=JSON.stringify({name:i.name,condition:i.condition,timeline:i.timeline,codeFight:i.codeFight,create:i.create});l.has(e)||(l.add(e),n.push(i))}const a=u.allTimelines.length-n.length;u.allTimelines=n,j({message:`追加成功！共导入 ${e.length} 个时间轴${a>0?`，但其中 ${a} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}function Je(e,t={}){me({call:"broadcast",source:"soumaTimelineSettings",msg:{type:e,data:t}})}function Me(){b.confirm("要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Je("post",u.$state)}).catch(()=>{})}function Ke(){b.confirm("要读取 ACT 悬浮窗数据吗？你将丢失所有未应用的修改！","读取悬浮窗数据",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Le()}).catch(()=>{})}function Le(){const e=s.resolve({path:"/timeline"}),t=`${window.location.protocol}//${window.location.host}/ff14-overlay-vue/${e.href}`;we=!0,ge=C.service({lock:!0,text:`正在请求数据，请确保 ACT 中已添加并启用此悬浮窗：${t}`,background:"rgba(0, 0, 0, 0.7)"}),Je("get"),setTimeout(()=>{we&&(j.info("重新尝试获取数据..."),Le())},5e3)}const Re=e=>{if("soumaTimeline"===e.source&&"post"===e.msg.type){we=!1,ge.close();const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>u.jobList.indexOf(e)-u.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");u.allTimelines=t.allTimelines,u.configValues=t.configValues,u.showStyle=t.showStyle,j.closeAll(),j({message:"数据获取成功",type:"success",duration:3e3})}};function He(){window.open("https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8","_blank")}function qe(){const e=s.resolve({path:"/timelineHelp"}).href;window.open(e,"_blank")}function We(){U.value=!0}function Ge(e){u.configValues=e.configValues,u.showStyle=e.showStyle}function Qe(e,t="复制成功",n="复制失败"){re(e).then(()=>j.success(t)).catch(()=>j.error(n))}function Xe({row:e}){return e===ne.value?"editing-row":""}return J(()=>{pe("BroadcastMessage",Re);const e=se(d,t=>{t&&(0===u.allTimelines.length&&Le(),e())});se(()=>u.$state,()=>{d.value&&O.value&&Je("post",u.$state)},{deep:!0})}),function(){for(const e in ue)if(Object.prototype.hasOwnProperty.call(ue,e)){const t=ue[e];switch(t.contentType){case 4:case 5:case 28:ye.push({id:e,name:t.name?.cn??t.name?.ja??e})}}u.loadTimelineSettings(),u.sortTimelines()}(),(e,n)=>{const l=xe,i=a,s=$,d=V,C=_,D=S,J=_e,le=v,ae=k,ie=y,se=g,ce=o,re=I,ue=F,pe=r,me=c,fe=T,ge=h,we=w,Pe=x,Je=t,Le=B;return K(),R(Le,{class:"container"},{default:W(()=>[L(l,{modelValue:X(P),"onUpdate:modelValue":n[0]||(n[0]=e=>Y(P)?P.value=e:null),onSave:Ge},null,8,["modelValue"]),L(D,{class:"flex-header"},{default:W(()=>[L(C,{justify:"space-between",align:"middle","m-b-2":""},{default:W(()=>[L(d,{wrap:"",size:10},{default:W(()=>[L(s,null,{default:W(()=>[L(i,{type:"primary",size:"small",onClick:We},{default:W(()=>n[18]||(n[18]=[G(" 从 FFlogs 生成 ")])),_:1,__:[18]}),L(i,{type:"primary",size:"small",onClick:He},{default:W(()=>n[19]||(n[19]=[G(" 从 在线文档 获取 ")])),_:1,__:[19]}),L(i,{type:"primary",size:"small",onClick:Ce},{default:W(()=>n[20]||(n[20]=[G(" 手动编写 ")])),_:1,__:[20]})]),_:1}),L(s,null,{default:W(()=>[L(i,{size:"small",onClick:De},{default:W(()=>n[21]||(n[21]=[G(" 导入字符串 ")])),_:1,__:[21]}),L(i,{size:"small",class:"export",onClick:n[1]||(n[1]=e=>Ue(X(p)))},{default:W(()=>n[22]||(n[22]=[G(" 导出全部 ")])),_:1,__:[22]})]),_:1}),L(s,null,{default:W(()=>[L(i,{size:"small",type:X(O)?"success":"default",onClick:Ne},{default:W(()=>[G(Z(X(O)?"实时更新模式：开启中":"实时更新模式：关闭中"),1)]),_:1},8,["type"])]),_:1})]),_:1}),L(d,null,{default:W(()=>[X(O)?H("",!0):(K(),R(i,{key:0,color:"#a0d911",style:{color:"white"},size:"small",onClick:Ke},{default:W(()=>n[23]||(n[23]=[G(" 读取来自悬浮窗的数据 ")])),_:1,__:[23]})),L(i,{color:"#626aef",style:{color:"white"},size:"small",onClick:n[2]||(n[2]=e=>P.value=!0)},{default:W(()=>n[24]||(n[24]=[G(" 设置 ")])),_:1,__:[24]})]),_:1})]),_:1}),X(O)?H("",!0):(K(),M("div",Te,[L(i,{type:"success",size:"default",onClick:Me},{default:W(()=>n[25]||(n[25]=[G(" 编辑完毕后，点击这里应用，将编辑器数据发送至悬浮窗 ")])),_:1,__:[25]})]))]),_:1}),L(ue,null,{default:W(()=>[L(le,{modelValue:X(U),"onUpdate:modelValue":n[4]||(n[4]=e=>Y(U)?U.value=e:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>U.value=!1,"close-on-press-escape":!1},{default:W(()=>[L(J,{filters:X(m),onShowFFlogsToggle:n[3]||(n[3]=()=>U.value=!1),onEditTimeline:ve},null,8,["filters"])]),_:1},8,["modelValue","before-close"]),X(p).length>0?(K(),R(ce,{key:0},{default:W(()=>[q("div",Oe,[q("div",null,[L(i,{type:"primary",size:"small",disabled:0===X(A).length,onClick:Ee},{default:W(()=>[G(" 批量导出 ("+Z(X(A).length)+") ",1)]),_:1},8,["disabled"]),L(i,{type:"danger",size:"small",disabled:0===X(A).length,style:{"margin-right":"10px"},onClick:Ae},{default:W(()=>[G(" 批量删除 ("+Z(X(A).length)+") ",1)]),_:1},8,["disabled"])])]),L(se,{data:X(p),"row-class-name":Xe,style:{width:"100%"},stripe:"",onSelectionChange:n[6]||(n[6]=e=>{A.value=e,N.value=e.length===X(p).length})},{default:W(()=>[L(ie,{type:"selection",width:"55",align:"center",selectable:()=>!0},{header:W(()=>[L(ae,{modelValue:X(N),"onUpdate:modelValue":n[5]||(n[5]=e=>Y(N)?N.value=e:null),onChange:ze},null,8,["modelValue"])]),_:1}),L(ie,{prop:"name",label:"名称"}),L(ie,{prop:"condition",label:"地图",sortable:""},{default:W(e=>[G(Z(ye.find(t=>t.id===e.row.condition.zoneId)?.name),1)]),_:1}),L(ie,{prop:"condition",label:"职业"},{default:W(e=>[G(Z(e.row.condition.jobs.map(e=>X(z).nameToFullName(e.toUpperCase())?.cn??e).join("、").replace("冒险者","全部职业")),1)]),_:1}),L(ie,{fixed:"right",label:"操作",width:"150"},{default:W(e=>[L(i,{type:"primary",size:"small",onClick:t=>ve(e.row)},{default:W(()=>n[26]||(n[26]=[G(" 编辑 ")])),_:2,__:[26]},1032,["onClick"]),L(i,{type:"danger",size:"small",onClick:t=>{return n=e.row,void b.confirm(`确定要删除「${n.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{p.value.splice(p.value.findIndex(e=>e===n),1)}).catch(()=>{});var n}},{default:W(()=>n[27]||(n[27]=[G(" 删除 ")])),_:2,__:[27]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):H("",!0),0===X(p).length?(K(),R(ce,{key:1},{default:W(()=>[L(re,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):H("",!0)]),_:1}),L(le,{modelValue:X(E),"onUpdate:modelValue":n[17]||(n[17]=e=>Y(E)?E.value=e:null),title:"编辑时间轴",top:"5vh","before-close":je,class:"timeline-dialog",width:"65%",style:{"min-width":"550px","max-width":"1000px"},"close-on-click-modal":!1,"close-on-press-escape":!1},{default:W(()=>[q("div",Se,[L(C,{class:"timeline-header",gutter:10},{default:W(()=>[L(fe,{span:14},{default:W(()=>[L(me,{label:"名称"},{default:W(()=>[L(pe,{modelValue:X(ne).name,"onUpdate:modelValue":n[7]||(n[7]=e=>X(ne).name=e)},null,8,["modelValue"])]),_:1})]),_:1}),L(fe,{span:8},{default:W(()=>[L(me,{label:"来源"},{default:W(()=>[L(pe,{modelValue:X(ne).codeFight,"onUpdate:modelValue":n[8]||(n[8]=e=>X(ne).codeFight=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),L(fe,{span:22},{default:W(()=>[L(me,{label:"地图"},{default:W(()=>[L(we,{modelValue:X(ne).condition.zoneId,"onUpdate:modelValue":n[9]||(n[9]=e=>X(ne).condition.zoneId=e),filterable:"",style:{width:"100%"}},{default:W(()=>[(K(),M(ee,null,te(ye,e=>L(ge,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1}),L(fe,{span:22},{default:W(()=>[L(me,{label:"职业"},{default:W(()=>[L(we,{modelValue:X(ne).condition.jobs,"onUpdate:modelValue":n[10]||(n[10]=e=>X(ne).condition.jobs=e),multiple:""},{default:W(()=>[(K(!0),M(ee,null,te(X(u).jobList,e=>(K(),R(ge,{key:e,label:(X(z).nameToFullName(e)?.cn??e).replace("冒险者","全部职业"),value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),q("div",Ve,[L(Pe,{modelValue:X(f),"onUpdate:modelValue":n[11]||(n[11]=e=>Y(f)?f.value=e:null),min:-X(u).configValues.preBattle,max:X(he),step:.1},null,8,["modelValue","min","max"]),q("div",$e,[q("p",Fe,Z(X(be)),1),q("p",ke," ("+Z(X(f))+"s) ",1)])]),L(C,{class:"timeline-editor-body",gutter:10},{default:W(()=>[L(fe,null,{default:W(()=>[L(pe,{modelValue:X(ne).timeline,"onUpdate:modelValue":n[12]||(n[12]=e=>X(ne).timeline=e),style:Q({width:`calc(100% - ${X(u).showStyle["--timeline-width"]}px)`}),type:"textarea",autosize:{minRows:10,maxRows:20},wrap:"off",placeholder:"请键入时间轴文本",onChange:n[13]||(n[13]=e=>Be())},null,8,["modelValue","style"])]),_:1}),L(Je,{style:{position:"absolute",right:0,top:0},config:X(u).configValues,lines:X(oe),runtime:X(f),"show-style":X(u).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1}),q("div",Ie,[L(d,null,{default:W(()=>[L(i,{onClick:n[14]||(n[14]=e=>Ue([X(ne)]))},{default:W(()=>n[28]||(n[28]=[G(" 导出 ")])),_:1,__:[28]}),L(i,{type:"primary",onClick:n[15]||(n[15]=e=>{ne.value.timeline=ne.value.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(e,t)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(e.toString())?de.duration(`00:${e.toString()}`).as("seconds").toString():de.utc(1e3*Number.parseFloat(e.toString())).format("mm:ss.S"))})},{default:W(()=>n[29]||(n[29]=[G(" 切换时间格式 ")])),_:1,__:[29]}),L(i,{onClick:qe},{default:W(()=>n[30]||(n[30]=[G(" 时间轴语法 ")])),_:1,__:[30]}),L(i,{onClick:n[16]||(n[16]=e=>{b.confirm("要删除所有的注释行，仅保留必要的时间轴数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(()=>{ne.value.timeline=ne.value.timeline.replace(/^#.*(?:\n|$)/gm,""),j.success("完成")}).catch(()=>{})})},{default:W(()=>n[31]||(n[31]=[G(" 删除注释行 ")])),_:1,__:[31]})]),_:1})])])]),_:1},8,["modelValue"])]),_:1})}}}),[["__scopeId","data-v-cf949059"]]);export{je as default};
