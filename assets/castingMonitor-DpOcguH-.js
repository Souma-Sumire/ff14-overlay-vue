import{_ as t}from"./ActWrapper-Ci6rJir2.js";import{ag as a,d as e,c as s,o as r,F as o,l as i,p as n,q as l,u as c,a as d,av as p,z as u,e as m,t as h,h as g,j as y,w as f,b as I}from"./index-BjBG6rkc.js";/* empty css                  *//* empty css                  */import{a as b,b as j,E as D}from"./el-header-MsoeyAuF.js";/* empty css                */import{U as w}from"./util-BOtaAWHW.js";import{c as T,s as _,p as P,a as C,h as k}from"./xivapi-a6oZXlzI.js";import{c as v,a as x}from"./overlay_plugin_api-DHbPkDtN.js";import{_ as $}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as A}from"./useDev-AndoZ6fC.js";import{E as L}from"./index-83eW4gRH.js";import"./el-card-Bug0YRzT.js";import"./index-D0Q-H-Cn.js";import"./useDemo-BGcfL7IJ.js";import"./index-CpvUxtDm.js";import"./use-form-common-props-w_Mhq1ju.js";const E=new URLSearchParams(window.location.href.split("?")[1]),N=["tank","healer","dps","crafter","gatherer","none"],M=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],U=a("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(E.get("duration")||15)}}),getters:{partyDataFormatted:t=>t.partyData.sort((t,a)=>N.indexOf(w.jobToRole(w.jobEnumToJob(t.job)))-N.indexOf(w.jobToRole(w.jobEnumToJob(a.job)))),focusTargetCastArr:t=>t.castData.filter(a=>a.casterId===t.focusTargetId)},actions:{testAction(){const t=M[Math.floor(Math.random()*M.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(t,a,e,s,r,o){if(0===this.partyData.length&&s===this.playerId||this.partyData.length>0&&s===this.focusTargetId){let i=r,n="action",l=!1;if(e.startsWith("item_"))return;e.startsWith("mount_")&&(i=Number.parseInt(e.replace(/^.+_/,""),16),i>983040&&(i=Number.parseInt(i.toString().slice(-5),10),l=!0),n=e.replace(/_.+$/,""));const c=`${t}-${a}-${s}-${r}`,d={casterId:s,time:t,expirationTime:Date.now()+1e3*this.config.duration,logLine:a,src:"",class:"",key:c},p=T.get(i);if(p&&(d.src=`//${p.Host}${p.Icon}`),this.castData.push(d),14===a&&o&&setTimeout(()=>{this.castData=this.castData.filter(t=>t?.key!==c)},1e3*o-500),e.startsWith("unknown_"))d.src=`${_.first}/i/000000/000405.png`,d.class="action action-category-0";else if(i<1e5){const t=p||await P(n,i,["ID","Icon","ActionCategoryTargetID"]);3===t.ID&&(t.Icon="/i/000000/000104.png"),p||(d.src=await C(t?.Icon??"",l)),"action"===n?d.class=`action action-category-${t?.ActionCategoryTargetID}`:"mount"===n&&(d.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){"20"===t.line[0]?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):("21"===t.line[0]||"22"===t.line[0]&&"0"===t.line[45])&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(t=>t.inParty).map(t=>({...t,src:""}));for(const t in this.castData)Object.prototype.hasOwnProperty.call(this.castData,t)&&(this.partyData.find(a=>a.id===t)||Reflect.deleteProperty(this.castData,t));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(E.get("syncFocusWS")||"")&&v({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),F={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},O=["data-casterId"],z=["src"],R=$(e({__name:"Main",setup(t){const a=new URLSearchParams(window.location.href.split("?")[1]),e=U(),p=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(a.get("displayAA")??""));return(t,a)=>(r(),s("div",F,[(r(!0),s(o,null,i(c(e).castData.filter(t=>t.key),t=>(r(),s("div",{key:t.key,"data-casterId":t.casterId,class:l(`images ${t.class} logLine${t.logLine} displayAA${c(p)}`),style:n(`--animeDuration: ${c(e).config.duration}s;`)},[d("img",{src:t.src,class:"action-icon",height:"40",loading:"lazy",onError:a[0]||(a[0]=(...t)=>c(k)&&c(k)(...t))},null,40,z),a[1]||(a[1]=d("img",{class:"frame",loading:"lazy"},null,-1))],14,O))),128))]))}}),[["__scopeId","data-v-67c0fa3f"]]),S={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},W=["onClick"],J={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},H=["src","onerror"],q=$(e({__name:"Header",setup(t){const a=new URLSearchParams(window.location.href.split("?")[1]);function e(t){const a=w.jobEnumToJob(t);return`https://souma.diemoe.net/resources/img/cj2/${w.jobToFullName(a).en}.png`}const n=U();p(()=>{for(const t of n.partyData)t.src=e(t.job)});const g=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(a.get("showHeader")||"true");return(t,a)=>c(g)&&c(n).partyData.length>1?(r(),s("div",S,[(r(!0),s(o,null,i(c(n).partyDataFormatted,(t,a)=>(r(),s("button",{key:a,class:l(["job-lists",c(n).focusTargetId===t.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:a=>c(n).handleClickChangeTarget(t.id)},[d("div",J,[d("img",{src:t.src,style:{height:"1.25em"},loading:"lazy",onerror:c(k)},null,8,H),m(" "+h(c(w).jobToFullName(c(w).jobEnumToJob(t.job)).simple2),1)])],10,W))),128))])):u("",!0)}}),[["__scopeId","data-v-4e98a4d9"]]),B={class:"common-layout"},Q={key:0},V=$(e({__name:"castingMonitor",setup(a){const e=U(),o=A();return g(()=>{x("ChangePrimaryPlayer",e.handleChangePrimaryPlayer),x("LogLine",e.handleLogLine),x("PartyChanged",e.handlePartyChanged),x("BroadcastMessage",t=>{"castMonitorOverlay"===t.source&&(e.focusTargetId=t.msg.targetId)})}),setInterval(()=>{e.cleanUpExpired()},1e3),(a,i)=>{const n=q,l=b,p=R,h=j,g=D,w=L,T=t;return r(),y(T,null,{default:f(()=>[d("div",B,[I(g,{"items-center":""},{default:f(()=>[I(l,{class:"header-layout"},{default:f(()=>[I(n)]),_:1}),I(h,null,{default:f(()=>[I(p)]),_:1})]),_:1}),c(o)?(r(),s("footer",Q,[I(w,{onClick:i[0]||(i[0]=t=>c(e).testParty(!0))},{default:f(()=>[...i[3]||(i[3]=[m(" 虚假小队 ",-1)])]),_:1}),I(w,{onClick:i[1]||(i[1]=t=>c(e).testParty(!1))},{default:f(()=>[...i[4]||(i[4]=[m(" 单人 ",-1)])]),_:1}),I(w,{onClick:i[2]||(i[2]=t=>c(e).testAction())},{default:f(()=>[...i[5]||(i[5]=[m(" Action ",-1)])]),_:1})])):u("",!0)])]),_:1})}}}),[["__scopeId","data-v-427fd25d"]]);export{V as default};
