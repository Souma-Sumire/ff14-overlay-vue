import{c as e,_ as t}from"./shared-common-iS-rKQ6e.js";import{_ as a}from"./TimelineShow-Bo-jaBSN.js";import{a as n,e as o,D as l}from"./vendor-element-plus-ICQGukrc.js";import{r as i,w as s,y as c,A as r,h as u}from"./shared-core-CJNBDgH7.js";import{c as m,a as d,r as f}from"./cactbot-Bq2Gp82n.js";import{o as p,r as g,bC as v,B as y,a5 as T,v as b,J as h,c as C,ac as k,t as w,K as j,u as x,H as A,R as D,am as E,M as I,Y as B,Z as O,I as S,X as _}from"./vendor-vue-iK2zA9mI.js";const N={id:"wrapper"},V={key:0,class:"optionalTimelines"},z=["onClick"],L={key:7,style:{color:"white","background-color":"black"}},M=t(p({__name:"timeline",setup(t){const p=i(),M=k({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),P=g(0),Z=g(0-p.configValues.preBattle),$=g(0);let F=!1;const G=v("timeline-condition-2",{zoneID:"0",jobs:["NONE"],phase:void 0}),R=u(),q=C(()=>M.loadedTimeline.filter(e=>e.sync)),H=C(()=>M.loadedTimeline.filter(e=>e.tts));function J(){X(),M.loadedTimeline.length=0,M.optionalTimeline.length=0;const e=p.getTimeline(G.value);1===e.length?K(e[0]):e.length>1&&(M.optionalTimeline=e,K(e[0]))}async function K(e,t=!0){M.selectedOptionalTimeline=e,t&&X(),F=!1,e?.timeline&&(M.loadedTimeline=await c(e.timeline),M.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{F=!0},1e3)}function X(){P.value=0,Z.value=0-p.configValues.preBattle,$.value=0;for(const e of M.loadedTimeline)e.alertAlready=!1;for(const e of q.value)e.syncAlready=!1}function Y(e,t=!0){t&&(F=!1,setTimeout(()=>{F=!0},1e3)),Z.value=0,$.value=0,P.value=(new Date).getTime()+1e3*e,H.value.forEach(e=>{e.alertAlready=!1}),Q()}function Q(){if(0===P.value)return;Z.value=((new Date).getTime()-P.value+$.value)/1e3;const e=H.value.find(e=>!e.alertAlready&&e.time-p.configValues.ttsAdvance<=Z.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;(F||t)&&r(e)}(e.tts)),requestAnimationFrame(Q)}y(()=>{d("onLogEvent",ee),d("onPlayerChangedEvent",ae),d("ChangeZone",ne),d("BroadcastMessage",ie),d("onInCombatChangedEvent",se),p.loadTimelineSettings(),n({message:`${p.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),le("hello")});let U=0;const W=e=>{const t=Date.now();if(t-U<1e3)return;if(U=t,!e.Target)return;const a=e.Target.BNpcID,n=s[Number(G.value.zoneID)];n&&n.includes(a)&&(f("EnmityTargetData",W),G.value.phase="final",J())};function ee(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)Y(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:400000(?:0F|10|03)/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))X();else{const e=q.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&Z.value>=e.time-e.windowBefore&&Z.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,te(e.jump||e.time))}}}function te(e){0===P.value&&Y(0,!1),$.value+=1e3*(e-Z.value),H.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const ae=e=>{G.value.jobs[0]!==e.detail.job&&(G.value.jobs[0]=e.detail.job,J())},ne=e=>{G.value.phase=void 0,f("EnmityTargetData",W),s[e.zoneID]&&(G.value.phase="door",d("EnmityTargetData",W)),G.value.zoneID=e.zoneID.toString(),J()};function oe(){n.closeAll(),n({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function le(e,t={}){m({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const ie=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>p.jobList.indexOf(e)-p.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");p.allTimelines=t.allTimelines,p.configValues=t.configValues,p.showStyle=t.showStyle,p.saveTimelineSettings(),n.closeAll(),n({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),J(),le("success")}"get"===e.msg.type&&le("post",p.$state)}};function se(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===P.value?Y(0):e.detail.inGameCombat||e.detail.inACTCombat||X()}return T(()=>{f("onLogEvent",ee),f("onPlayerChangedEvent",ae),f("ChangeZone",ne),f("BroadcastMessage",ie),f("onInCombatChangedEvent",se),f("EnmityTargetData",W)}),(t,n)=>{const i=o,s=a,c=e;return w(),b(c,null,{default:h(()=>[j("div",N,[x(M).optionalTimeline.length&&x(Z)<=-x(p).configValues.preBattle?(w(),A("ul",V,[n[5]||(n[5]=j("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(w(!0),A(D,null,E(x(M).optionalTimeline,(e,t)=>(w(),A("li",{key:t,class:I(x(M).selectedOptionalTimeline===e?"active":""),onClick:t=>{K(e)}},[B(O(e.name)+" ",1),x(M).selectedOptionalTimeline===e?(w(),b(i,{key:0},{default:h(()=>[S(x(l))]),_:1})):_("",!0)],10,z))),128))])):_("",!0),S(s,{config:x(p).configValues,lines:x(M).loadedTimeline,runtime:x(Z),"show-style":x(p).showStyle},null,8,["config","lines","runtime","show-style"]),x(R)?(w(),A("button",{key:1,onClick:n[0]||(n[0]=e=>Y(30))}," 开始从-30 ")):_("",!0),x(R)?(w(),A("button",{key:2,onClick:n[1]||(n[1]=e=>Y(0))}," 开始从0 ")):_("",!0),x(R)?(w(),A("button",{key:3,onClick:n[2]||(n[2]=e=>X())}," 团灭 ")):_("",!0),x(R)?(w(),A("button",{key:4,onClick:n[3]||(n[3]=e=>{te(1e3)})}," 跳转1000测试 ")):_("",!0),x(R)?(w(),A("button",{key:5,onClick:n[4]||(n[4]=e=>x(r)("今天天气真不错"))}," TTS测试 ")):_("",!0),x(R)?(w(),A("button",{key:6,onClick:oe}," 弹窗测试 ")):_("",!0),x(R)?(w(),A("span",L,O(x(Z)),1)):_("",!0)])]),_:1})}}}),[["__scopeId","data-v-bcaa4edb"]]);export{M as default};
