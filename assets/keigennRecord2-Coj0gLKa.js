import{_ as e,e as t}from"./shared-common-CkFh8mcd.js";import{d as s,dx as a,x as i,w as o,I as n,o as r,b7 as l,dz as c,G as d,D as u,c as m,b as p,e as f,g as h,a as v,n as g,f as b,s as k,t as y,i as w,F as j,y as I,z as R,r as C,b9 as L,j as T,l as S,p as N,h as E,v as x,bW as D,cj as A,cO as $,ch as _,b8 as M}from"./vendor-vue-MSvGQJWD.js";import{u as P,af as O,s as G,y as H,U as F,ad as J,q as z,f as V,a1 as K,Z as W,l as B,ae as U,ag as Z,ah as Y,v as q,ai as X,aj as Q,ak as ee,al as te,B as se,am as ae,a8 as ie,an as oe,t as ne,ao as re}from"./shared-core-D2SGP-qI.js";import{E as le,a as ce,aG as de,aH as ue,w as me,J as pe,g as fe,aI as he,aJ as ve,n as ge}from"./vendor-element-plus-CsMNiL2J.js";import{l as be,N as ke,a as ye}from"./cactbot-DtpbXwrG.js";const we={class:"table-wrapper"},je={key:0,class:"row-info"},Ie={class:"info-line"},Re={class:"info-line"},Ce={class:"info-line"},Le={class:"info-line"},Te={class:"info-line"},Se={key:1,class:"skill-popover-content"},Ne={key:0,class:"skill-grid"},Ee=["title"],xe=["src"],De={key:0,class:"skill-overlay"},Ae={key:1,class:"skill-text"},$e={key:2,class:"skill-charges"},_e={key:4,class:"skill-extra-text"},Me={key:5,class:"skill-job-name"},Pe={key:1,class:"no-data"},Oe={key:2,class:"death-recap-popover"},Ge={class:"recap-header"},He={class:"align-right"},Fe={class:"time"},Je={class:"ability-cell"},ze={class:"ability-content"},Ve=["src"],Ke=["title"],We={class:"status-cell"},Be={class:"status-content"},Ue=["title","data-duration"],Ze=["src"],Ye=e(s({__name:"Table",props:{rows:{},actionKey:{}},setup(e,{expose:t}){const{t:s}=P(),L=e,T=O(),S=T.userOptions,N=a("contextMenu"),E=i(""),x=i("");o(()=>L.rows,e=>{0===e.length&&(E.value="",x.value="")},{immediate:!0});const D=i(!1),A=i(0),$=i(0),_=i(null),M=i(null),J=i({getBoundingClientRect:()=>({top:0,left:0,bottom:0,right:0,width:0,height:0})}),z=i(null),V=i(!1),K=i("top"),W=n([]);function B(e,t,s){V.value&&M.value?.key===e.key&&z.value===t||(z.value=t,"skills"===t?K.value="left":"death-recap"===t?(K.value="auto",function(e){const t=e.targetId,s=e.timestamp,a=s-2e4,i=[],o=L.rows.indexOf(e);if(-1===o)return;for(let r=o;r>=0;r--){const e=L.rows[r];if(e)if(e.timestamp<=s&&e.timestamp>=a)e.targetId===t&&i.push(e);else if(e.timestamp<a&&"push"===T.userOptions.order)break}for(let r=o+1;r<L.rows.length;r++){const e=L.rows[r];if(e)if(e.timestamp<=s&&e.timestamp>=a)e.targetId===t&&i.push(e);else if(e.timestamp<a&&"unshift"===T.userOptions.order)break}const n=Array.from(new Set(i)).sort((e,t)=>t.timestamp-e.timestamp);W.value=n.map(e=>{const t="heal"===e.effect,a="death"===e.type,i=!t&&e.amount>0&&!a;let o="",n="";t?(o="+",n="is-heal"):i&&(o="-",n="is-damage");const r=e.amount>0||t?o+e.preCalculated.amountDisplay:e.preCalculated.amountDisplay;return{key:e.key,timeStr:((e.timestamp-s)/1e3).toFixed(1).replace("-0.0","0.0")+"s",amountStr:r,amountClass:n,actionCN:e.actionCN,isDeath:a,iconSrc:"",keigenns:e.preCalculated.keigenns}})}(e)):K.value="right",M.value=e,J.value=s.currentTarget,V.value=!0)}const U={x:0,y:0},Z=e=>{U.x=e.clientX,U.y=e.clientY};let Y=0;const q=e=>{D.value&&(D.value=!1);const t=e.target;t?.closest(".keigenn-global-popover")||(cancelAnimationFrame(Y),Y=requestAnimationFrame(()=>{((e,t)=>{const s=document.elementFromPoint(e,t),a=s?.closest("[data-row-key][data-hover-mode]");if(a){const e=a.dataset.rowKey,t=a.dataset.hoverMode,s=re.value.find(t=>t.key===e);if(s)return void B(s,t,{currentTarget:a})}V.value=!1})(U.x,U.y)}))},X=a("tableContainer");r(()=>{X.value?.addEventListener("wheel",q,{passive:!0}),window.addEventListener("mousemove",Z,{passive:!0})}),l(()=>{X.value?.removeEventListener("wheel",q),window.removeEventListener("mousemove",Z)}),c(N,()=>{D.value=!1});const Q=s("keigennRecord.cancelFilter"),ee=d(()=>{const e=L.rows.filter(e=>T.debugShowHeals||"heal"!==e.effect),t=Array.from(new Set(e.map(e=>e[L.actionKey]))).filter(e=>null!=e);return[{label:Q,value:""},...t.map(e=>({label:e,value:e}))]}),te=d(()=>{const e=L.rows.filter(e=>T.debugShowHeals||"heal"!==e.effect),t=Array.from(new Map(e.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:Q,value:"",job:-1},...t.map(e=>({label:e.job,fullLabel:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>F.enumSortMethod(e.job,t.job))});function se(){if(_.value){const e=_.value[L.actionKey];E.value===e?E.value="":E.value=e,D.value=!1}}function ae(){if(_.value){const e=_.value.targetId;x.value===e?x.value="":x.value=e,D.value=!1}}const ie=(e,t="")=>u("div",{class:["header-static",t]},e),oe=()=>u("div"),ne=e=>u("div",{class:"header-filter"},[u(le,{size:"small",modelValue:e.modelValue,placeholder:e.placeholder,clearable:!1,style:`width:${e.width}`,teleported:!0,popperClass:"keigenn-header-select-popper",onChange:e.onUpdate},()=>e.options.map(e=>u(ce,{key:e.value,label:e.label,value:e.value},{default:()=>e.fullLabel||e.label})))]),re=d(()=>{const e=L.rows.filter(e=>T.debugShowHeals||"heal"!==e.effect);return E.value&&E.value!==Q||x.value&&x.value!==Q?e.filter(e=>{const t=!E.value||E.value===Q||e[L.actionKey]===E.value,s=!x.value||x.value===Q||e.targetId===x.value;return t&&s}):e}),he=({rowData:e})=>"death"===e.type?"row-death":"",ve=[{key:"time",title:s("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>ie(s("keigennRecord.time"),"header-time")},{key:"action",title:s("keigennRecord.action"),dataKey:L.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>u(ne,{modelValue:E.value,options:ee.value,placeholder:s("keigennRecord.action"),width:"4.5em",onUpdate:e=>E.value=e===Q?"":e}),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source;return u("div",{class:"death-message-left"},[u("span","ðŸ’€ "),u("span",{class:"death-target-name"},e.target),u("span",t?[u("span"," å›  "),u("span",{class:"death-terrain"},"åœ°å½¢æ€"),u("span"," å€’ä¸‹äº†ï¼")]:[u("span"," è¢« "),u("span",{class:"death-source-name"},e.source),u("span"," åšæŽ‰äº†ï¼")]),u("span",{class:"death-recap-inline","data-row-key":e.key,"data-hover-mode":"death-recap",onMouseenter:t=>{B(e,"death-recap",t)}}," [æ­»äº¡å›žæ”¾]")])}return u("span",e[L.actionKey]??"")}},{key:"target",title:s("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>u(ne,{modelValue:x.value,options:te.value,placeholder:s("keigennRecord.target"),width:"4.7em",onUpdate:e=>x.value=e===Q?"":e}),cellRenderer:({rowData:e})=>"death"===e.type?oe():u("div",{class:"target"},[e.preCalculated.jobIconSrc?u("img",{class:[T.isBrowser?"browser":"act","jobIcon",`cj${T.userOptions.iconType}`],src:e.preCalculated.jobIconSrc,alt:e.jobIcon,onError:e=>{e.target.style.display="none"}}):u("span",{class:"alt-text"},e.job),e.hasDuplicate?u("span",{class:"has-duplicate"},T.formatterName(e.target)):void 0])},{key:"amount",title:s("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",headerCellRenderer:()=>ie(s("keigennRecord.amount")),cellRenderer:({rowData:e})=>"death"===e.type?oe():u("span",{class:"amount","data-row-key":e.key,"data-hover-mode":"amount",onMouseenter:t=>B(e,"amount",t)},[u("span",{class:e.preCalculated.damageTypeClass},e.preCalculated.amountDisplay)])},{key:"reduction",title:s("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>ie(s("keigennRecord.reduction"),"header-reduction"),cellRenderer:({rowData:e})=>"death"===e.type?oe():u("span",{class:"col-reduction-number",style:{color:e.preCalculated.reductionColor}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:s("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",headerCellRenderer:()=>ie(s("keigennRecord.keigenns")),cellRenderer:({rowData:e})=>"death"===e.type?oe():u("div",{class:"status-container"},[...e.preCalculated.keigenns.map(e=>u("span",{class:"status-wrapper"},[u("span",{class:"status",title:e.title,"data-duration":e.duration,"data-sourcePov":e.isPov},[u("img",{class:["statusIcon",e.usefulClass],src:e.src,alt:e.effect,onError:G})])])),u("span",{class:"flags"},"damage done"===e.effect||"heal"===e.type?"":s(`keigennRecord.${e.effect}`))])},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>u("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:10}},"death"===e.type?void 0:u("div",{class:"view-icon","data-row-key":e.key,"data-hover-mode":"skills",onMouseenter:t=>B(e,"skills",t)},[u("div",{class:"dots"},[u("i"),u("i"),u("i")])]))}];let ge=null;const be={onClick:({rowData:e})=>{if("death"===e.type)return;const{actionCN:t,amount:a,job:i,keigenns:o,time:n,type:r,effect:l,currentHp:c,maxHp:d,shield:u,reduction:m}=e,p="damage done"===l?"":`,${s(`keigennRecord.${l}`)}`,f=`${n} ${i} ${t} ${a.toLocaleString()}(${s(`keigennRecord.${r}`)}) ${s("keigennRecord.reduction")}(${(100*m).toFixed(0)}%):${0===o.length&&""===p?s("keigennRecord.none"):o.map(e=>S.statusCN?e.name:e.effect).join(",")+p} ${s("keigennRecord.hp")}}:${c}(${Math.round(c/d*100)}%)+${s("keigennRecord.shield")}:${Math.round(d*+u/100)}(${u}%)`;H(f).then(()=>{ge?.close(),ge=fe.success({message:s("keigennRecord.copySuccess"),duration:800})}).catch(()=>fe.error(s("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const s=t;_.value=e,A.value=s.clientX,$.value=s.clientY,D.value=!0}},ke=i(null);const ye=(e,t)=>{let s=0;for(const a of e)if(a.id===t&&(s++,s>1))return!0;return!1},Ye=e=>e.preCalculated.sortedSkills||[];return t({scrollToBottom:function(){ke.value&&ke.value.scrollToRow(re.value.length-1)}}),(t,a)=>{const i=me,o=ue,n=pe,r=de;return v(),m("div",{ref_key:"tableContainer",ref:X,class:"table-container"},[p("div",we,[f(r,{style:{height:"100%",width:"100%"}},{default:h(({height:r,width:l})=>[f(o,{ref_key:"tableV2Ref",ref:ke,"header-class":"keigenn-table-header",class:"keigenn-table performance-table",columns:ve,data:re.value,width:l,height:r,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":be,"row-class":he,"overscan-row-count":2},{empty:h(()=>[f(i,{description:b(T).isBrowser?t.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["data","width","height"]),b(D)?(v(),m("div",{key:0,ref_key:"contextMenu",ref:N,class:"context-menu",style:k({top:`${b($)}px`,left:`${b(A)}px`})},[p("ul",null,[p("li",{onClick:se},y(b(E)===(b(_)?.[e.actionKey]??"")?b(s)("keigennRecord.filter.action_cancel",{actionName:b(_)?.[e.actionKey]??b(s)("keigennRecord.this_skill")}):b(s)("keigennRecord.filter.action_only",{actionName:b(_)?.[e.actionKey]??b(s)("keigennRecord.this_skill")})),1),p("li",{onClick:ae},y(b(x)===b(_)?.targetId?b(s)("keigennRecord.filter.target_cancel",{jobName:b(_)?.job??b(s)("keigennRecord.this_job")}):b(s)("keigennRecord.filter.target_only",{jobName:b(_)?.job??b(s)("keigennRecord.this_job")})),1)])],4)):g("",!0),f(n,{visible:b(V),"onUpdate:visible":a[0]||(a[0]=e=>w(V)?V.value=e:null),"virtual-ref":b(J),"virtual-triggering":"","popper-class":"keigenn-global-popover",transition:"none","show-after":0,"hide-after":0,offset:6,enterable:!0,teleported:!0,placement:"top",width:"auto","fallback-placements":["top-end","top-start","bottom","bottom-end","bottom-start"]},{default:h(()=>[b(M)&&"amount"===b(z)?(v(),m("div",je,[p("div",Ie,y(b(s)("keigennRecord.source"))+": "+y(b(M).source),1),p("div",Re,y(b(s)("keigennRecord.playerShield"))+": "+y(b(M).shield)+"%",1),p("div",Ce,y(b(s)("keigennRecord.playerHp"))+": "+y(b(M).currentHp.toLocaleString())+"("+y(b(M).preCalculated.hpPercent)+"%)",1),b(M).reduction<1&&"dot"!==b(M).type?(v(),m(j,{key:0},[a[1]||(a[1]=p("div",{class:"info-divider"},null,-1)),p("div",Le,y(b(s)("keigennRecord.reductionRate"))+": "+y((100*b(M).reduction).toFixed(2))+"%",1),p("div",Te,[I(y(b(s)("keigennRecord.originalDamage"))+": ",1),p("span",{class:R(b(M).preCalculated.damageTypeClass)},y(b(M).preCalculated.originalDamageDisplay),3)])],64)):g("",!0)])):b(M)&&"skills"===b(z)?(v(),m("div",Se,[Ye(b(M)).length>0?(v(),m("div",Ne,[(v(!0),m(j,null,C(Ye(b(M)),e=>{return v(),m("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[p("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[p("img",{src:e.icon,class:"skill-icon"},null,8,xe),e.ready?g("",!0):(v(),m("div",De)),e.recastLeft>0?(v(),m("span",Ae,y(e.recastLeft),1)):g("",!0),e.maxCharges&&e.maxCharges>1?(v(),m("span",$e,y(e.chargesReady),1)):g("",!0),void 0!==e.jobResource?(v(),m("span",{key:3,class:"skill-resource",style:k({fontSize:e.jobResource.toString().length>2?"9px":"11px"})},y(e.jobResource),5)):g("",!0),e.extraText?(v(),m("span",_e,y(e.extraText),1)):g("",!0),ye(Ye(b(M)),e.id)?(v(),m("span",Me,y((t=e.ownerJob,F.jobToFullName(F.jobEnumToJob(t))?.simple1??"")),1)):g("",!0)],8,Ee)]);var t}),128))])):g("",!0),0===Ye(b(M)).length?(v(),m("div",Pe,y(b(s)("keigennRecord.noData")),1)):g("",!0)])):b(M)&&"death-recap"===b(z)?(v(),m("div",Oe,[p("div",Ge,[p("span",null,y(b(s)("keigennRecord.time")),1),p("span",He,y(b(s)("keigennRecord.amount")),1),p("span",null,y(b(s)("keigennRecord.action")),1),p("span",null,y(b(s)("keigennRecord.keigenns")),1)]),(v(!0),m(j,null,C(b(W),e=>(v(),m("div",{key:e.key,class:R(["recap-row",{"is-death":e.isDeath}])},[p("span",Fe,y(e.timeStr),1),p("span",{class:R(["amount-cell align-right",e.amountClass])},y(e.amountStr),3),p("div",Je,[p("div",ze,[e.iconSrc?(v(),m("img",{key:0,src:e.iconSrc,class:"ability-icon"},null,8,Ve)):g("",!0),p("span",{class:"ability-name",title:e.actionCN},y(e.actionCN),9,Ke)])]),p("div",We,[p("div",Be,[(v(!0),m(j,null,C(e.keigenns,(e,t)=>(v(),m("div",{key:t,class:"status-wrapper"},[p("div",{class:R(["status",{"is-pov":e.isPov}]),title:e.title,"data-duration":e.duration},[p("img",{src:e.src,class:R(["status-icon",e.usefulClass])},null,10,Ze)],10,Ue)]))),128))])])],2))),128))])):g("",!0)]),_:1},8,["visible","virtual-ref"])]),_:1})])],512)}}}),[["__scopeId","data-v-006627b9"]]),qe="self",Xe="other",Qe="party",et=[...J.filter(e=>1===e.line||2===e.line).map(({tts:e,duration:t,key:s,line:a,...i})=>({...i,scope:Qe})),{id:7531,recast1000ms:90,job:[1,3,19,21,32,37],minLevel:1,scope:qe},{id:7561,recast1000ms:"(lv) => lv>=94 ? 40 : 60",job:[6,24,27,28,33,40],minLevel:18,scope:Qe},{id:7542,recast1000ms:90,job:[2,4,20,22,29,30,34,39,41],minLevel:1,scope:qe},{id:7541,recast1000ms:120,job:[2,4,5,20,22,23,29,30,31,34,38,39,41],minLevel:1,scope:qe},{id:7548,recast1000ms:120,job:[1,2,3,4,5,19,20,21,22,23,29,30,31,32,34,37,38,39,41],minLevel:1,scope:qe},{id:7559,recast1000ms:"120",job:[6,7,8,24,25,26,27,28,33,35,36,40,42],minLevel:1,scope:qe},{id:17,recast1000ms:120,job:[1],minLevel:38,scope:qe},{id:"(lv) => lv>=92 ? 36920 : 17",recast1000ms:120,job:[19],minLevel:38,scope:qe},{id:22,recast1000ms:90,job:[19],minLevel:52,scope:qe},{id:"(lv) => lv>=82 ? 25746 : 3542",recast1000ms:5,job:[19],minLevel:35,scope:qe,showResource:!0,resourceCost:50},{id:7382,recast1000ms:10,job:[19],minLevel:62,scope:Xe,showResource:!0,resourceCost:50},{id:44,recast1000ms:120,job:[3],minLevel:38,scope:qe},{id:"(lv) => lv>=92 ? 36923 : 44",recast1000ms:120,job:[21],minLevel:38,scope:qe},{id:40,recast1000ms:90,job:[3,21],minLevel:30,scope:qe},{id:3552,recast1000ms:60,job:[21],minLevel:58,scope:qe},{id:"(lv) => lv>=82 ? 25751 : 3551",recast1000ms:25,job:[21],minLevel:56,scope:qe},{id:16464,recast1000ms:25,job:[21],minLevel:76,scope:Xe},{id:"(lv) => lv>=92 ? 36927 : 3636",recast1000ms:120,job:[32],minLevel:38,scope:qe},{id:3634,recast1000ms:60,job:[32],minLevel:45,scope:qe},{id:7393,recast1000ms:15,job:[32],minLevel:70,scope:Qe,showResource:!0,resourceCost:3e3},{id:25754,recast1000ms:60,job:[32],minLevel:82,scope:Qe,maxCharges:2},{id:"(lv) => lv>=92 ? 36935 : 16148",recast1000ms:120,job:[37],minLevel:38,scope:qe},{id:16140,recast1000ms:90,job:[37],minLevel:6,scope:qe},{id:"(lv) => lv>=82 ? 25758 : 16161",recast1000ms:25,job:[37],minLevel:68,scope:Qe},{id:16151,recast1000ms:60,job:[37],minLevel:45,scope:Qe,maxCharges:"(lv) => lv>=84 ? 2 : 1"},{id:3570,recast1000ms:60,job:[24],minLevel:60,scope:Qe,maxCharges:"(lv) => lv>=98 ? 2 : 1"},{id:7432,recast1000ms:30,job:[24],minLevel:66,scope:Qe,maxCharges:"(lv) => lv>=98 ? 2 : 1"},{id:25861,recast1000ms:60,job:[24],minLevel:86,scope:Qe},{id:16542,recast1000ms:90,job:[28],minLevel:70,scope:Qe},{id:3585,recast1000ms:90,job:[28],minLevel:56,scope:Qe},{id:16538,recast1000ms:120,job:[28],minLevel:40,scope:Qe},{id:188,recast1000ms:30,job:[28],minLevel:50,scope:Qe,showResource:!0,resourceCost:1},{id:3583,recast1000ms:30,job:[28],minLevel:52,scope:Qe,showResource:!0,resourceCost:1},{id:7434,recast1000ms:45,job:[28],minLevel:62,scope:Qe,showResource:!0,resourceCost:1},{id:16545,recast1000ms:120,job:[28],minLevel:80,scope:Qe},{id:25867,recast1000ms:60,job:[28],minLevel:86,scope:Qe},{id:37014,recast1000ms:180,job:[28],minLevel:100,scope:Qe},{id:3614,recast1000ms:40,job:[33],minLevel:15,scope:Qe,maxCharges:"(lv) => lv>=78 ? (lv>=98 ? 3 : 2) : 1"},{id:3613,recast1000ms:60,job:[33],minLevel:58,scope:Qe},{id:16553,recast1000ms:60,job:[33],minLevel:60,scope:Qe},{id:7439,recast1000ms:60,job:[33],minLevel:62,scope:Qe},{id:16556,recast1000ms:30,job:[33],minLevel:74,scope:Qe,maxCharges:"(lv) => lv>=88 ? 2 : 1"},{id:16557,recast1000ms:60,job:[33],minLevel:76,scope:Qe},{id:16559,recast1000ms:120,job:[33],minLevel:80,scope:Qe},{id:25873,recast1000ms:60,job:[33],minLevel:86,scope:Qe},{id:24298,recast1000ms:30,job:[40],minLevel:50,scope:Qe,showResource:!0,resourceCost:1},{id:24299,recast1000ms:30,job:[40],minLevel:52,scope:Qe,showResource:!0,resourceCost:1},{id:24303,recast1000ms:45,job:[40],minLevel:62,scope:Qe,showResource:!0,resourceCost:1},{id:24305,recast1000ms:120,job:[40],minLevel:70,scope:Qe},{id:24311,recast1000ms:120,job:[40],minLevel:80,scope:Qe},{id:24310,recast1000ms:120,job:[40],minLevel:76,scope:Qe},{id:24300,recast1000ms:"(lv) => lv>=88 ? 90 : 120",job:[40],minLevel:56,scope:Qe},{id:24318,recast1000ms:120,job:[40],minLevel:90,scope:Qe},{id:37035,recast1000ms:180,job:[40],minLevel:100,scope:Qe},{id:7394,recast1000ms:120,job:[20],minLevel:64,scope:qe},{id:7394,overrideIconId:36944,recast1000ms:120,job:[20],minLevel:64,scope:Xe},{id:65,recast1000ms:90,job:[2,20],minLevel:42,scope:Qe},{id:2241,recast1000ms:120,job:[29,30],minLevel:2,scope:qe},{id:"(lv) => lv>=82 ? 36962 : 7498",recast1000ms:15,job:[34],minLevel:6,scope:qe},{id:24404,recast1000ms:30,job:[39],minLevel:40,scope:qe},{id:7408,recast1000ms:120,job:[23],minLevel:66,scope:Qe},{id:16015,recast1000ms:60,job:[38],minLevel:52,scope:Qe},{id:16014,recast1000ms:120,job:[38],minLevel:80,scope:Qe},{id:157,recast1000ms:120,job:[7,25],minLevel:40,scope:qe},{id:155,recast1000ms:10,job:[25],minLevel:50,scope:qe},{id:25799,recast1000ms:60,job:[26,27],minLevel:2,scope:qe,maxCharges:"(lv) => lv>=88 ? 2 : 1"},{id:34685,recast1000ms:120,job:[42],minLevel:10,scope:Qe}],tt=166,st=3587,at=167,it=3583,ot=188,nt=7434,rt=16542,lt=1896;class ct{stacks={};recitation={};lastRecitationUsed={};reset(){this.stacks={},this.recitation={},this.lastRecitationUsed={}}getResource(e){return this.stacks[e]??0}isReady(e,t,s){return!(!this.recitation[e]||t!==it&&t!==nt)||(this.stacks[e]??0)>=s}getExtraText(e,t,s,a){if(t===it||t===nt){const t=this.lastRecitationUsed[e]??0;if(t>0){const e=t+9e4;if(s<e)return Math.ceil((e-s)/1e3).toString()}}return""}processLine(e,t){switch(e){case"21":case"22":{const e=t[be.Ability.fields.sourceId],s=parseInt(t[be.Ability.fields.id],16),a=new Date(t[be.Ability.fields.timestamp]).getTime();if(s===rt&&(this.lastRecitationUsed[e]=a),s===tt||s===st)return void(this.stacks[e]=3);const i=this.recitation[e];s===it||s===nt?i||this.consumeStack(e):s!==at&&s!==ot||this.consumeStack(e)}break;case"26":if(parseInt(t[be.GainsEffect.fields.effectId],16)===lt){const e=t[be.GainsEffect.fields.targetId];this.recitation[e]=!0}break;case"30":if(parseInt(t[be.LosesEffect.fields.effectId],16)===lt){const e=t[be.LosesEffect.fields.targetId];delete this.recitation[e]}break;case"25":{const e=t[be.WasDefeated.fields.targetId];this.stacks[e]=0}}}consumeStack(e){const t=this.stacks[e]||0;t>0&&(this.stacks[e]=t-1)}}const dt=7,ut=3542,mt=25746,pt=7382,ft=27;class ht{gauge={};reset(){this.gauge={}}getResource(e){return this.gauge[e]??100}processLine(e,t){switch(e){case"21":case"22":{const e=t[be.Ability.fields.sourceId],s=parseInt(t[be.Ability.fields.id],16);s===dt?this.addGauge(e,5):s!==ut&&s!==mt&&s!==pt&&s!==ft||this.consumeGauge(e,50)}break;case"25":{const e=t[be.WasDefeated.fields.targetId];this.gauge[e]=0}}}consumeGauge(e,t){const s=this.getResource(e);this.gauge[e]=Math.max(0,s-t)}addGauge(e,t){const s=this.getResource(e);this.gauge[e]=Math.min(100,s+t)}}const vt=24296,gt=24298,bt=24299,kt=24303,yt=24309;class wt{stacks={};lastGenTime={};reset(){this.stacks={},this.lastGenTime={}}getResource(e){return this.stacks[e]??3}processLine(e,t){if("21"!==e&&"22"!==e&&"25"!==e)return;const s=t[1];if(!s)return;const a=new Date(s).getTime();switch(e){case"21":case"22":{const e=t[be.Ability.fields.sourceId];if(!e.startsWith("1"))return;this.updateStacks(e,a);const s=parseInt(t[be.Ability.fields.id],16);s===vt||s===gt||s===bt||s===kt?this.consumeStack(e):s===yt&&this.addStack(e)}break;case"25":{const e=t[be.WasDefeated.fields.targetId];this.stacks[e]=0,delete this.lastGenTime[e]}}}updateStacks(e,t){if(!this.lastGenTime[e])return this.lastGenTime[e]=t,void(void 0===this.stacks[e]&&(this.stacks[e]=3));const s=t-this.lastGenTime[e],a=Math.floor(s/2e4);if(a>0){const t=this.stacks[e]??0;this.stacks[e]=Math.min(3,t+a),this.lastGenTime[e]+=2e4*a}}consumeStack(e){const t=this.stacks[e]||0;t>0&&(this.stacks[e]=t-1)}addStack(e){const t=this.stacks[e]||0;this.stacks[e]=Math.min(3,t+1)}}class jt{mp={};reset(){this.mp={}}getResource(e){return this.mp[e]??1e4}processLine(e,t){switch(e){case"21":case"22":{const e=t[be.Ability.fields.sourceId];if(!e.startsWith("1"))return;const s=parseInt(t[be.Ability.fields.currentMp]);isNaN(s)||(this.mp[e]=s)}break;case"25":{const e=t[be.WasDefeated.fields.targetId];this.mp[e]=0}}}}const It=34685,Rt=3686,Ct=3687;class Lt{activeShields={};pendingTransition={};reset(){this.activeShields={},this.pendingTransition={}}getResource(e){}processLine(e,t,s={}){const a=t[be.GainsEffect?.fields?.timestamp??1],i=a?new Date(a).getTime():0;if(!(i<=0))switch(e){case"26":{const e=t[be.GainsEffect.fields.targetId],s=parseInt(t[be.GainsEffect.fields.effectId],16),a=t[be.GainsEffect.fields.duration],o=a?parseFloat(a):0;s===Rt?this.activeShields[e]={type:"coat",expiresAt:i+1e3*o}:s===Ct&&(this.activeShields[e]={type:"grassa",expiresAt:i+1e3*o},delete this.pendingTransition[e])}break;case"30":{const e=t[be.LosesEffect.fields.targetId],a=parseInt(t[be.LosesEffect.fields.effectId],16);if(a===Rt){const t=this.activeShields[e];"coat"===t?.type&&(t.expiresAt-i>500&&(this.pendingTransition[e]=i,setTimeout(()=>{this.pendingTransition[e]===i&&(this.reduceCooldown(e,6e4,s),delete this.pendingTransition[e])},100)),delete this.activeShields[e])}else if(a===Ct){const t=this.activeShields[e];"grassa"===t?.type&&(t.expiresAt-i>500&&this.reduceCooldown(e,3e4,s),delete this.activeShields[e])}}}}reduceCooldown(e,t,s){const a=s[e];if(a){const e=a[It];if(e&&e.length>0){const s=e.length-1;e[s]=(e[s]??0)-t}}}}class Tt{allTrackers=new Map;activeTrackers=new Map;constructor(){this.allTrackers.set(28,ct),this.allTrackers.set(19,ht),this.allTrackers.set(40,wt),this.allTrackers.set(32,jt),this.allTrackers.set(42,Lt)}updateParty(e){const t=new Set(e);for(const s of t){const e=this.allTrackers.get(s);e&&!this.activeTrackers.has(s)&&this.activeTrackers.set(s,new e)}}clear(){this.activeTrackers.clear()}reset(){for(const e of this.activeTrackers.values())e.reset()}processLine(e,t,s){for(const a of this.activeTrackers.values())a.processLine(e,t,s)}getResource(e,t){const s=this.activeTrackers.get(e);if(s)return s.getResource(t)}isResourceReady(e,t,s,a){const i=this.activeTrackers.get(e);if(i&&i.isReady)return i.isReady(t,s,a);return(this.getResource(e,t)??0)>=a}getExtraText(e,t,s,a,i){const o=this.activeTrackers.get(e);return o&&o.getExtraText?o.getExtraText(t,s,a,i):""}}const St={class:"header-select"},Nt={style:{height:"100%"}},Et={key:0,class:"testLog"},xt="v20260131",Dt=e(s({__name:"keigennRecord2",setup(e){const s=V(),a=O(),o=a.userOptions;a.checkIsBrowser();const c="push"===o.order,d=i(o.minimize),u=o.actionCN?"actionCN":"action",y=i(!1),w={POV_ID:"keigenn-record-2-pov-id",PARTY_LIST:"keigenn-record-2-party-list",ENTITIES_MAP:"keigenn-record-2-job-map",PARTY_EVENT:"keigenn-record-2-party-event-party",RSV_DATA:"souma-keigenn-record-2-rsv-data",ZONE_NAME:"souma-keigenn-record-2-zone-name",VERSION:"keigenn-record-2-data-version"};let P=!1;let G="",H=[],J={},de=[],ue={},me=0,pe="",fe=0;const we=i(0),je=n([{zoneName:"",duration:"00:00",table:L([]),key:"init",timestamp:-1}]),Ie={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ke.ability(),statusEffectExplicit:ke.statusEffectExplicit(),gainsEffect:ke.gainsEffect(),losesEffect:ke.losesEffect(),death:ke.wasDefeated(),changeZone:ke.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:ke.addedCombatant(),removingCombatant:ke.removingCombatant(),networkDoT:ke.networkDoT(),wipe:ke.network6d({command:["40000010","4000000F"]})};let Re={},Ce={friendly:{},enemy:{}},Le={},Te=new Map;const Se=et,Ne=new Tt,Ee=K("keigenn-record-2");function xe(){y.value=!0,me=0,Le={},we.value=0,je.value.length=0,je.value.push({zoneName:"",duration:"00:00",table:L([]),key:"init",timestamp:-1}),Re={},Ce={friendly:{},enemy:{}},J={},de=[],H=[],G="",fe=0,Ae.clear(),Te.clear(),ue={},Ne.clear(),Ge()}async function De(){y.value=!1,null!==Je&&(cancelAnimationFrame(Je),Je=null,Fe.length>0&&(c?(je.value[0].table.push(...Fe),M(()=>ze.value?.scrollToBottom())):je.value[0].table.unshift(...Fe.reverse()),Fe=[])),await Be(),_(je)}const Ae=new Map;const $e=a.icon4k;function _e(e){const t=function(e){const t=Math.round(100*e)/100;if(Ae.has(t))return Ae.get(t);const s=[88,88,88],a=[50,250,200],i=Math.min(1,t/.5),o=Math.min(9,Math.floor(10*i))/9,n=Math.pow(o,.8),r=s[0]+(a[0]-s[0])*n,l=s[1]+(a[1]-s[1])*n,c=s[2]+(a[2]-s[2])*n,d=`rgba(${Math.round(r)}, ${Math.round(l)}, ${Math.round(c)}, 1)`;return Ae.set(t,d),d}(e.reduction),s=e.amount>999999?`${(e.amount/1e4).toFixed(0)}ä¸‡`:e.amount.toLocaleString(),a=((e,t)=>`https://souma.diemoe.net/resources/img/cj${t}/${e.replaceAll(/([A-Z])/g," $1").trim()}.png`)(e.jobIcon,o.iconType),{amount:i,maxHp:n,currentHp:r,shield:l,type:c,reduction:d}=e,u=Math.round(n*+l/100),m=Math.round(r/n*100),p=(i&&Math.round((i+u)/(1-d))||0).toLocaleString();return{...e,preCalculated:{reductionColor:t,amountDisplay:s,damageTypeClass:"heal"===e.effect?"is-heal":c,jobIconSrc:a,keigenns:e.keigenns.map(e=>({src:ne(`/i/${e.fullIcon}${$e}.png`),usefulClass:oe(e,c),title:`${o.statusCN?e.name:e.effect}(${e.source})`,duration:e.remainingDuration??"",isPov:e.isPov,effect:e.effect})),originalDamageDisplay:p,hpPercent:m,sortedSkills:(e.keySkills??[]).sort((e,t)=>{const s={party:0,other:1,self:2};return e.scope!==t.scope?s[e.scope]-s[t.scope]:e.ownerJob!==t.ownerJob?re.indexOf(e.ownerJob)-re.indexOf(t.ownerJob):e.recast1000ms!==t.recast1000ms?t.recast1000ms-e.recast1000ms:e.id-t.id})}}}function Me(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const s=e.split("|");switch(Ne.processLine(t,s,Le),t){case"26":{if(!Ie.gainsEffect.exec(e))return;const t=s[be.GainsEffect.fields.effectId],a=s[be.GainsEffect.fields.effect],i=s[be.GainsEffect.fields.target],o=s[be.GainsEffect.fields.targetId],n=Number.parseInt(s[be.GainsEffect.fields.count],16);let r=Q(t);if(!r){const e=o.startsWith("1")&&ee.get(Number.parseInt(t,16).toString())||o.startsWith("4")&&te.get(Number.parseInt(t,16).toString());if(!e)return;const s=se(e.icon),a=n>1?ae(s,n):s;r={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:a,name:e.name,isFriendly:e.isFriendly}}const l=s[be.GainsEffect.fields.duration],c=s[be.GainsEffect.fields.source],d=s[be.GainsEffect.fields.sourceId],u=new Date(s[be.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),m={name:r.name,type:r.type,count:n,effect:a,effectId:t,source:c,sourceId:d,target:i,targetId:o,expirationTimestamp:u,performance:r.performance,fullIcon:r.fullIcon,isPov:G===d};o.startsWith("1")&&r.isFriendly?(void 0===Ce.friendly[o]&&(Ce.friendly[o]={}),Ce.friendly[o][t]=m):o.startsWith("4")&&!r.isFriendly&&(void 0===Ce.enemy[i]&&(Ce.enemy[i]={}),Ce.enemy[i][t]=m)}break;case"30":{const e=s[be.LosesEffect.fields.target],t=s[be.LosesEffect.fields.targetId],a=s[be.LosesEffect.fields.effectId];t.startsWith("1")?Ce.friendly[t]&&Reflect.deleteProperty(Ce.friendly[t],a):Ce.enemy[e]&&Reflect.deleteProperty(Ce.enemy[e],a)}break;case"21":case"22":{if(0===me)return;const e=s[be.Ability.fields.sourceId]??"???",t=s[be.Ability.fields.id]??"???",a=new Date(s[be.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const s=Number.parseInt(t,16),i=J[e]?.level??999,o=function(e){let t=Te.get(e);if(!t){t=new Map;for(const s of Se){if(s.minLevel>e)continue;const a=Z(s.id,e);t.set(a,s);const i=U(a);i!==a&&t.set(i,s)}Te.set(e,t)}return t}(i),n=U(s),r=o.get(s)||o.get(n);if(r){Le[e]||(Le[e]={}),Le[e][n]||(Le[e][n]=[]);const t=Le[e][n];t.push(a);const s=Z(r.maxCharges||1,i);t.length>s&&t.shift()}}const i=Y(s),n=s[be.Ability.fields.targetId]??"???",r=i.isHeal&&i.amount>0&&n.startsWith("1"),l=i.isAttack&&i.amount>=0&&e.startsWith("4")&&n.startsWith("1");if(r||l){if(n!==G&&!H.includes(n)&&!de.find(e=>e.id===n))return;const e=s[be.Ability.fields.ability],l=e.match(/^_rsv_(?<id>\d+)_/);let c=e;if(l){const t=Number(l.groups?.id);c=ue[t]??e.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===o.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=q(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(s[be.Ability.fields.targetCurrentHp]),p=Number(s[be.Ability.fields.targetMaxHp]),f=s[be.Ability.fields.source]??"???",h=s[be.Ability.fields.target]??"???",{effect:v,type:g}=X(i.flags),b=Ue(0===me?0:a-me),{jobEnum:k,job:y,jobIcon:w,hasDuplicate:j}=He(n),I=Object.values(Ce.friendly[n]??[]).concat(Object.values(Ce.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-a)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),R=Re[n]??"0",C=i.amount;let L=0;if(!r&&"instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const s of I)"absorbed"!==s.type&&(t*=s.performance[g]??1);L=1-t*e}Ve(_e({key:(fe++).toString(),time:b,timestamp:a,id:t,action:c,actionCN:u,source:f,target:h,targetId:n,job:y,jobIcon:w,jobEnum:k,hasDuplicate:j,amount:C,keigenns:I,currentHp:m,maxHp:p,effect:v,type:g,shield:R,povId:G,reduction:L,keySkills:We(a,n)})),je.value[0].duration=Ue(new Date(s[be.Ability.fields.timestamp]).getTime()-me)}}break;case"25":{const t=Ie.death.exec(e);if(!t||!t.groups)return;const s=t.groups.targetId,a=t.groups.target,i=t.groups.sourceId,o="E0000000"===i?"åœ°å½¢æ€":t.groups.source,n=t.groups.timestamp;if(0===me)return;if(s!==G&&!H.includes(s)&&!de.find(e=>e.id===s))return;const r=new Date(n).getTime(),l=Ue(r-me),{jobEnum:c,job:d,jobIcon:u,hasDuplicate:m}=He(s);Ve(_e({key:(fe++).toString(),time:l,timestamp:r,id:"",action:"Death",actionCN:"E0000000"===i?"åœ°å½¢æ€":"æ­»äº¡",source:o,target:a,targetId:s,job:d,jobIcon:u,jobEnum:c,hasDuplicate:m,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:G,reduction:0,keySkills:We(r,s)}))}break;case"38":{const t=Ie.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Re[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===s[be.InCombat.fields.inACTCombat],t="1"===s[be.InCombat.fields.inGameCombat],a=new Date(s[be.InCombat.fields.timestamp]).getTime();if(e||t){const e=s[be.InCombat.fields.timestamp];if(me>0)return;return 0===je.value[0].table.length&&0===Fe.length||(null!==Je&&(cancelAnimationFrame(Je),Je=null),Fe.length>0&&(c?je.value[0].table.push(...Fe):je.value[0].table.unshift(...Fe.reverse()),Fe=[]),je.value.unshift({zoneName:"",duration:"00:00",table:L([]),key:e,timestamp:a}),_(je)),me=a,je.value[0].zoneName=pe,je.value[0].timestamp=a,je.value[0].key=e,void(we.value=0)}if(!e&&!t)return void Ke(a)}break;case"01":{const e=parseInt(s[be.ChangeZone.fields.id],16);if(pe=s[be.ChangeZone.fields.name],W[e]?.name){const t=B(W[e]?.name);t&&"Unknown"!==t&&(pe=t)}Le={},Ne.clear(),Ke(new Date(s[be.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=Ie.partyList.exec(e);t&&(H=(t.groups?.list?.split("|")??[]).filter(Boolean),Ge())}break;case"02":G=s[be.ChangedPlayer.fields.id],Ge();break;case"03":if("00"!==s[be.AddedCombatant.fields.job]){const e=s[be.AddedCombatant.fields.job],t=s[be.AddedCombatant.fields.name],a=new Date(s[be.AddedCombatant.fields.timestamp]).getTime(),i=parseInt(s[be.AddedCombatant.fields.level],16);J[s[be.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a,name:t,level:i},Ge()}break;case"04":Reflect.deleteProperty(J,s[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ce.friendly,s[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Ce.enemy,s[be.RemovedCombatant.fields.id]),Ge();break;case"262":{const t=Ie.rsv.exec(e);if(t){const e=Number(t.groups?.id),a=s[be.RSVData.fields.value];e&&a&&(ue[Number(e)]=a)}}break;case"24":{const e=s[be.NetworkDoT.fields.which],t=s[be.NetworkDoT.fields.effectId],a=parseInt(t,16),i="HoT"===e&&2718===a;if(!i&&!o.parseDoT)return;const n=s[be.NetworkDoT.fields.id];if("DoT"!==e&&"HoT"!==e||n.startsWith("4")||n!==G&&!H.includes(n)&&!de.find(e=>e.id===n))return;const r=s[be.NetworkDoT.fields.name],l=s[be.NetworkDoT.fields.damage],c=Number.parseInt(l,16);let d=e;i&&(d=o.actionCN?"å°å®‡å®™":"Microcosmos");const u=new Date(s[be.Ability.fields.timestamp]??"???").getTime(),m=Number(s[be.NetworkDoT.fields.currentHp]),p=Number(s[be.NetworkDoT.fields.maxHp]),f=Ue(0===me?0:u-me),{jobEnum:h,job:v,jobIcon:g,hasDuplicate:b}=He(n);Ve(_e({key:(fe++).toString(),time:f,timestamp:u,id:"",action:d,actionCN:d,source:"",target:r,targetId:n,job:v,jobIcon:g,jobEnum:h,hasDuplicate:b,amount:c,keigenns:[],currentHp:m,maxHp:p,effect:i?"heal":"damage done",type:i?"heal":"dot",shield:Re[n]??"0",povId:G,reduction:0,keySkills:[]}))}break;case"33":Ie.wipe.exec(e)&&(Ne.reset(),Le={},Re={},Ce.friendly={},Ce.enemy={})}}const Pe=new Map;let Oe=null;function Ge(){Pe.clear(),Oe=null,function(){const e=new Set;if(de.forEach(t=>e.add(t.job)),G){const t=de.find(e=>e.id===G)||J[G];t&&e.add(t.job)}H.forEach(t=>{const s=J[t];s&&e.add(s.job)}),Ne.updateParty(e)}()}function He(e){const t=Pe.get(e);if(t)return t;const{job:s,hasDuplicate:a}=function(e){const t=J[e],s=de.find(t=>t.id===e)??{job:0,timestamp:0},a=(t?.timestamp??0)>s.timestamp?t:s,i=a===t?Object.entries(J).some(([t,s])=>t!==e&&s.job===a?.job&&H.includes(t)):de.some(t=>t.id!==e&&t.job===a?.job);return{job:a?.job??0,hasDuplicate:i}}(e),i=s,o={jobEnum:i,job:F.jobToFullName(F.jobEnumToJob(i)).simple2,jobIcon:F.jobEnumToIcon(i),hasDuplicate:a};return Pe.set(e,o),o}let Fe=[],Je=null;const ze=i(null);function Ve(e){Fe.push($(e)),null===Je&&(Je=requestAnimationFrame(()=>{c?(je.value[0].table.push(...Fe),y.value||M(()=>ze.value?.scrollToBottom())):je.value[0].table.unshift(...Fe.reverse()),Fe=[],Je=null}))}function Ke(e){0!==me&&(je.value[0].duration=Ue(e-me),je.value[0]=$(je.value[0]),me=0,Ce.friendly={},Ce.enemy={},Re={},Ge(),Be())}function We(e,t){if(!Oe){const e=new Set;de.forEach(t=>e.add(t.id)),H.forEach(t=>e.add(t)),G&&e.add(G);const t=[];for(const s of e){const e=de.find(e=>e.id===s);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const a=J[s];a&&t.push({id:s,job:a.job,name:a.name??"Unknown",level:a.level})}Oe=t.flatMap(e=>{const t=e.level||999;return Se.filter(s=>s.job.includes(e.job)&&s.minLevel<=t).map(s=>{const a=Z(s.id,t),i=Z(s.recast1000ms,t);return{id:a,name:q(a)||"Unknown",icon:ie(s.overrideIconId??a),recast1000ms:i,ownerId:e.id,ownerName:e.name,ownerJob:e.job,ownerJobName:F.jobToFullName(F.jobEnumToJob(e.job)).simple2,maxCharges:Z(s.maxCharges||1,t),scope:s.scope,showResource:s.showResource,resourceCost:s.resourceCost}})})}return Oe?Oe.filter(e=>"party"===e.scope||("self"===e.scope?e.ownerId===t:"other"===e.scope&&e.ownerId!==t)).map(t=>{const s=Le[t.ownerId]?.[U(t.id)]??[],a=t.maxCharges||1,i=1e3*t.recast1000ms,o=new Array(a).fill(0);for(let e=0;e<s.length;e++){const t=s[e],a=e>0?o[e-1]:0;o[e]=Math.max(t,a)+i}let n=a-s.length,r=0;for(let m=0;m<s.length;m++){if(!(e>=o[m])){r=Math.ceil((o[m]-e)/1e3);break}n++}const l=t.showResource?Ne.getResource(t.ownerJob,t.ownerId):void 0,c=void 0===t.resourceCost||Ne.isResourceReady(t.ownerJob,t.ownerId,t.id,t.resourceCost),d=n>0&&c,u=Ne.getExtraText(t.ownerJob,t.ownerId,t.id,e,Le[t.ownerId]||{});return{...t,jobResource:l,recastLeft:r,ready:d,chargesReady:n,extraText:u}}):[]}async function Be(){if(y.value)return;const e=je.value.filter(e=>"init"!==e.key&&e.timestamp>0&&e.table.length>0).map(e=>{const t=Array.isArray(e.table)?A(e.table):[];return{...A(e),table:t}});await Ee.replaceAll(e)}function Ue(e){const t=Math.max(Math.floor(e/6e4),0),s=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${s<10?"0":""}${s}`}function Ze(){d.value=!d.value}function qe(){"init"!==je.value[0]?.key&&void 0!==je.value[0]||(je.value.unshift({zoneName:"",duration:"00:00",table:L([]),key:"test",timestamp:Date.now()}),_(je),we.value=0),Ve(_e({key:(fe++).toString(),time:Ue(Date.now()-(me||Date.now())),timestamp:Date.now(),id:"unknown",action:"test",actionCN:"æµ‹è¯•æŠ€èƒ½",source:"çŽ¯å¢ƒä¼¤å®³",target:"æµ‹è¯•è§’è‰²",targetId:"test-id",job:"æµ‹è¯•èŒä¸š",jobIcon:F.jobEnumToIcon(19),jobEnum:19,hasDuplicate:!1,amount:12345,keigenns:[],currentHp:5e4,maxHp:1e5,effect:"damage done",type:"physics",shield:"10",povId:"test-id",reduction:.1,keySkills:[]}))}function Xe(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return r(()=>{z(),function(){try{if(localStorage.getItem(w.VERSION)!==xt)return Object.values(w).forEach(e=>{e!==w.VERSION&&localStorage.removeItem(e)}),localStorage.setItem(w.VERSION,xt),void(P=!0);const e=localStorage.getItem(w.POV_ID);e&&(G=e);const t=localStorage.getItem(w.PARTY_LIST);t&&(H=JSON.parse(t));const s=localStorage.getItem(w.ENTITIES_MAP);s&&(J=JSON.parse(s));const a=localStorage.getItem(w.PARTY_EVENT);a&&(de=JSON.parse(a));const i=localStorage.getItem(w.RSV_DATA);i&&(ue=JSON.parse(i));const o=localStorage.getItem(w.ZONE_NAME);o&&(pe=o)}catch(e){}}();const e=T({storageKey:"keigenn-record-2-theme"}),t=S(e);!1===e.value&&t();for(const s in J){const e=J[s];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(J,s)}!async function(){we.value=0;try{if(P)await Ee.replaceAll([]),je.value.length=0;else{const e=await Ee.getAll();if(e.length){je.value.length=0;let t=e.filter(e=>a.isBrowser||e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp);c||(t=t.reverse());const s=t.map(e=>({...e,table:L(Array.isArray(e.table)?e.table.map(e=>$(e)):[])}));je.value.push(...s)}}0===je.value.length&&je.value.push({zoneName:"",duration:"00:00",table:L([]),key:"init",timestamp:-1}),_(je)}catch(e){throw je.value.length=0,e}}(),ye("LogLine",e=>{Me(e.rawLine)}),ye("PartyChanged",e=>{de=e.party.map(e=>({...e,timestamp:Date.now()})),Ge()}),ye("ChangePrimaryPlayer",e=>{G=Number(e.charID).toString(16).toUpperCase(),Ge()}),ye("CombatData",e=>{if(!(me>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(pe=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let s=0;3===t.length?s=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(s=1e3*(60*t[0]+t[1]));const a=Date.now()-s;0!==je.value[0].table.length&&(je.value.unshift({zoneName:"",duration:"00:00",table:L([]),key:String(a),timestamp:a}),_(je)),je.value[0].zoneName=pe,me=a,je.value[0].timestamp=a,je.value[0].key=String(a),we.value=0}})}),l(()=>{!function(){try{localStorage.setItem(w.POV_ID,G),localStorage.setItem(w.PARTY_LIST,JSON.stringify(H)),localStorage.setItem(w.ENTITIES_MAP,JSON.stringify(J)),localStorage.setItem(w.PARTY_EVENT,JSON.stringify(de)),localStorage.setItem(w.RSV_DATA,JSON.stringify(ue)),localStorage.setItem(w.ZONE_NAME,pe)}catch(e){}}(),Be()}),(e,i)=>{const n=ce,r=le,l=ge,c=Ye,y=t;return v(),m(j,null,[p("div",{class:"wrapper",style:k({"--scale":b(o).scale,"--opacity":b(o).opacity}),onContextmenu:i[1]||(i[1]=D(()=>{},["prevent"]))},[p("header",null,[p("div",St,[N(f(r,{modelValue:we.value,"onUpdate:modelValue":i[0]||(i[0]=e=>we.value=e),size:"small",class:R(["combat-select",b(a).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:h(()=>[(v(!0),m(j,null,C(je.value.length,e=>(v(),E(n,{key:`${je.value[e-1].key}-${je.value[e-1].duration}-${je.value[e-1].zoneName}`,value:e-1,label:`${je.value[e-1].zoneName}${""===je.value[e-1].zoneName?"":` - [${je.value[e-1].duration}] ${Xe(je.value[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[x,!d.value]])]),b(a).isBrowser?g("",!0):(v(),E(l,{key:0,class:R(["minimize",d.value?"in-minimize":"not-minimize"]),icon:d.value?b(he):b(ve),circle:"",style:k({opacity:d.value?.5:1}),onClick:Ze},null,8,["class","icon","style"]))]),N(p("main",Nt,[f(c,{ref_key:"tableRef",ref:ze,rows:je.value[we.value].table,"action-key":b(u)},null,8,["rows","action-key"])],512),[[x,!d.value]])],36),b(a).isBrowser||b(s)?(v(),m("div",Et,[b(s)?(v(),E(l,{key:0,onClick:qe},{default:h(()=>[...i[2]||(i[2]=[I(" æµ‹è¯• ",-1)])]),_:1})):g("",!0),f(y,{"m-1":"",onBeforeHandle:xe,onAfterHandle:De,onHandleLine:Me})])):g("",!0)],64)}}}),[["__scopeId","data-v-5fcab1ee"]]);export{Dt as default};
