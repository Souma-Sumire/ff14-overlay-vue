import{M as e,_ as a}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-DDrTXhwN.js";import{e as l,f as t,h as o,p as n,M as i,i as s,Z as r,j as c,k as d,l as u,n as m}from"./shared-core-C66uuNY0.js";import{o as p,t as b,v as y,u as f,c as k,bE as z,bC as w,B as h,A as g,V as M,_,J as v,r as C,I as $,K as D,H as V,R as x,am as E,Y as Z,Z as I,X as P,L as U,a as A,a6 as T}from"./vendor-vue-iK2zA9mI.js";import{a as N,b as j,_ as S}from"./shared-common-Cc1o9pRN.js";import{o as L,p as H,q as O,n as X,r as B,t as W,u as Y,v as J,w as F,f as K,j as q,x as R,y as G,A as Q,B as ee,C as ae,D as le,F as te,G as oe,k as ne,b as ie,H as se,I as re,g as ce,J as de,K as ue,a as me}from"./vendor-element-plus-BVM8ID8U.js";import{_ as pe}from"./zoneSelecter-DW_k-4F6.js";import{a as be}from"./cactbot-DRs0Yy4Y.js";import"./map-DW4z5uTS.js";const ye=p({__name:"MarksDiv",props:{macro:{type:Object,required:!0},size:{type:Number,default:180}},setup(a){const t=a,o=l(),n=["A","B","C","D","1","2","3","4"],i=k(()=>{if(!t.macro?.Place)return[];const e=t.macro.Place;return Object.keys(e).map((a,l)=>{const t=e[a];return{key:a,label:n[l]??a,x:Number(t.X),z:Number(t.Z),active:t.Active}})});return(l,t)=>(b(),y(e,{"map-id":Number(f(o).selectZone),"force-territory-type":Number(f(o).selectZone),markers:i.value,size:a.size},null,8,["map-id","force-territory-type","markers","size"]))}}),fe={class:"header-row"},ke={class:"fast-entrance-group"},ze={class:"header-row"},we={class:"badge-group"},he={key:0,class:"subtle-badge from-user"},ge={key:1,class:"subtle-badge from-native"},Me=["innerHTML"],_e={key:0},ve={key:0,class:"macro-content"},Ce={key:1},$e={style:{"margin-bottom":"10px"}},De={class:"dialog-footer"},Ve=S(p({__name:"zoneMacro",setup(e){const{t:p}=z(),S=o(),Ve=l();w("zoneMacroHideOnStartup",C(!1)).value&&(Ve.show=!1),S.value||t({allowClose:!0,addWsParam:!0});const xe=k(()=>Ve.fastEntrance.map(e=>({text:d(e.text),value:e.value}))),Ee=C(null),Ze=C(null),Ie=C(!1),Pe=C(!0),Ue=C([]),Ae=k(()=>u(Number(Ve.selectZone))),Te=k(()=>{if(!Ze.value)return[];let e=Ze.value.wayMarks.map((e,a)=>({mark:e,index:a})).filter(e=>0!==e.mark.regionID);return Pe.value&&(e=e.filter(e=>e.mark.regionID===Ae.value)),e});async function Ne(e){const a=e.target,l=a.files?.[0];if(l)try{Ze.value=await n(await l.arrayBuffer()),Ie.value=!0,Pe.value=!1}catch(t){me.error(`Parse failed: ${t}`)}finally{a.value=""}}function je(e){Ue.value=e}function Se(){Ue.value.forEach(({mark:e})=>{const a={};i.forEach(l=>{const t=e[l.key];t&&(a[l.key]={X:t.x/1e3,Y:t.y/1e3,Z:t.z/1e3,Active:(e.enableFlag&l.bit)>0})}),Ve.newPlace({...a,Name:`Imported ${new Date(1e3*e.timestamp).toLocaleString()}`,MapID:e.regionID,Editable:!1})}),Ie.value=!1,me.success(p("zoneMacro.importSelected",[Ue.value.length]))}function Le(e){const a=s(e);if(!a)return"Unknown";const l=r[a];return l?c(l.name):"Unknown"}function He(e,a){return Le(e.mark.regionID).localeCompare(Le(a.mark.regionID))}return h(()=>{be("ChangeZone",Ve.handleChangeZone),g(T(Ve,"selectZone"),()=>{const e=(Ve.data.zoneId[Ve.selectZone]?.map(e=>{const{Editable:a,...l}=e;return l})||m.zoneId[Ve.selectZone]||[]).filter(e=>e.Deletability),a=m.zoneId[Ve.selectZone]??[];Ve.data.zoneId[Ve.selectZone]=[...a,...e]},{immediate:!0})}),(e,l)=>{const t=X,o=O,n=W,i=N,s=j,r=H,c=F,d=q,u=R,m=ne,p=oe,k=ie,z=te,w=J,h=ye,g=K,C=Y,T=ce,S=de,me=re,be=L;return M((b(),y(be,{class:"elcontainer"},{default:v(()=>[$(r,{height:"auto",class:"elheader"},{default:v(()=>[D("div",fe,[$(o,{content:"定位到当前区域",placement:"bottom"},{default:v(()=>[$(t,{type:"primary",size:"small",icon:f(B),circle:"",onClick:l[0]||(l[0]=e=>f(Ve).positioning())},null,8,["icon"])]),_:1}),$(pe,{"select-zone":f(Ve).selectZone,"onUpdate:selectZone":l[1]||(l[1]=e=>f(Ve).selectZone=e)},null,8,["select-zone"]),D("div",ke,[(b(!0),V(x,null,E(f(xe),(e,a)=>(b(),y(t,{key:a,plain:"",size:"small",onClick:a=>f(Ve).selectZone=e.value},{default:v(()=>[Z(I(e.text),1)]),_:2},1032,["onClick"]))),128))])]),D("div",ze,[$(t,{type:"success",size:"small",onClick:l[2]||(l[2]=e=>f(Ve).newMacro())},{default:v(()=>[Z(I(e.$t("zoneMacro.newMacro")),1)]),_:1}),$(t,{type:"primary",size:"small",onClick:l[3]||(l[3]=e=>f(Ve).newPlace())},{default:v(()=>[Z(I(e.$t("zoneMacro.newWaymark")),1)]),_:1}),$(n,{direction:"vertical",class:"toolbar-divider"}),$(t,{size:"small",color:"#BA5783",onClick:l[4]||(l[4]=e=>f(Ve).importPPJSON())},{default:v(()=>[Z(I(e.$t("zoneMacro.importPP")),1)]),_:1}),$(t,{size:"small",color:"#9D5C63",onClick:l[5]||(l[5]=e=>f(Ee)?.click())},{default:v(()=>[Z(I(e.$t("zoneMacro.importUISAVE")),1)]),_:1}),$(n,{direction:"vertical",class:"toolbar-divider"}),$(t,{type:"warning",size:"small",onClick:l[6]||(l[6]=e=>f(Ve).resetZone())},{default:v(()=>[Z(I(e.$t("zoneMacro.resetZone")),1)]),_:1}),$(t,{type:"danger",size:"small",onClick:l[7]||(l[7]=e=>f(Ve).resetAllData())},{default:v(()=>[Z(I(e.$t("zoneMacro.resetAll")),1)]),_:1}),$(n,{direction:"vertical",class:"toolbar-divider"}),$(i,{"storage-key":"zone-macro-theme"}),$(s)])]),_:1}),$(C,{class:"main-content"},{default:v(()=>[$(w,{wrap:"",alignment:"flex-start",class:"macro-grid"},{default:v(()=>[void 0===f(Ve).data.zoneId[f(Ve).selectZone]||0===f(Ve).data.zoneId[f(Ve).selectZone].length?(b(),y(c,{key:0,"w-100":"","image-size":150,description:e.$t("zoneMacro.noDataTip")},null,8,["description"])):(b(!0),V(x,{key:1},E(f(Ve).data.zoneId[f(Ve).selectZone],(a,l)=>(b(),y(g,{key:l,shadow:"hover",class:"main-box-card"},{default:v(()=>[D("div",we,[a.Deletability?(b(),V("span",he,I(e.$t("zoneMacro.badgeUser")),1)):(b(),V("span",ge,I(e.$t("zoneMacro.badgeNative")),1))]),M(D("p",{class:"macro-title",innerHTML:a.Name},null,8,Me),[[_,!a.Editable]]),M($(d,{modelValue:a.Name,"onUpdate:modelValue":e=>a.Name=e,size:"small",placeholder:e.$t("zoneMacro.placeholderMacroTitle"),style:{width:"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[_,a.Editable]]),"Text"in a?(b(),V("div",_e,[a.Editable?P("",!0):(b(),V("article",ve,[(b(!0),V(x,null,E(a.Text?.split("\n"),(e,a)=>(b(),V("div",{key:a,class:"macroText"},I(e),1))),128))])),M($(d,{modelValue:a.Text,"onUpdate:modelValue":e=>a.Text=e,type:"textarea",size:"small",placeholder:e.$t("zoneMacro.placeholderMacroText"),wrap:"off",autosize:{minRows:3},style:{width:"450px","max-width":"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[_,a.Editable]]),a.Editable?P("",!0):(b(),y(u,{key:1,class:"buttonArea",style:U({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:v(()=>[a.Deletability?(b(),y(t,{key:0,icon:f(G),size:"small",onClick:e=>f(Ve).editMacroMacro(a)},null,8,["icon","onClick"])):P("",!0),$(t,{icon:f(Q),type:"info",size:"small",onClick:e=>f(Ve).sendMacroEcho(a.Text)},{default:v(()=>[Z(I(e.$t("zoneMacro.sendEcho")),1)]),_:1},8,["icon","onClick"]),$(t,{icon:f(ee),type:"primary",size:"small",onClick:e=>f(Ve).sendMacroParty(a.Text)},{default:v(()=>[Z(I(e.$t("zoneMacro.sendParty")),1)]),_:1},8,["icon","onClick"])]),_:2},1032,["style"])),a.Editable?(b(),y(u,{key:2,class:"buttonAreaEditing"},{default:v(()=>[$(t,{type:"success",size:"small",icon:f(ae),onClick:e=>f(Ve).submitMacroMacro(a)},{default:v(()=>[Z(I(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(b(),y(t,{key:0,type:"danger",size:"small",icon:f(le),onClick:e=>f(Ve).deleteMacro(a)},{default:v(()=>[Z(I(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):P("",!0)]),_:2},1024)):P("",!0)])):P("",!0),"Place"in a?(b(),V("div",Ce,[M($(w,null,{default:v(()=>[$(z,{data:Object.entries(a.Place).filter(e=>["A","B","C","D","One","Two","Three","Four"].includes(e[0])),border:"",size:"small"},{default:v(()=>[$(p,{align:"center",label:e.$t("zoneMacro.tableActive"),width:"50"},{default:v(e=>[$(m,{modelValue:e.row[1].Active,"onUpdate:modelValue":a=>e.row[1].Active=a,size:"small",style:{"--el-switch-on-color":"#13ce66"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),$(p,{align:"center",label:e.$t("zoneMacro.tableMark"),width:"50"},{default:v(e=>[D("span",null,I(e.row[0]),1)]),_:1},8,["label"]),$(p,{align:"center",label:e.$t("zoneMacro.tableX"),width:"120"},{default:v(e=>[M(D("span",null,I(e.row.X),513),[[_,!a.Editable]]),M($(k,{modelValue:e.row[1].X,"onUpdate:modelValue":a=>e.row[1].X=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[_,a.Editable]])]),_:2},1032,["label"]),$(p,{align:"center",label:e.$t("zoneMacro.tableZ"),width:"120"},{default:v(e=>[M(D("span",null,I(e.row.Z),513),[[_,!a.Editable]]),M($(k,{modelValue:e.row[1].Z,"onUpdate:modelValue":a=>e.row[1].Z=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[_,a.Editable]])]),_:2},1032,["label"]),$(p,{align:"center",label:e.$t("zoneMacro.tableY"),width:"120"},{default:v(e=>[M(D("span",null,I(e.row.Y),513),[[_,!a.Editable]]),M($(k,{modelValue:e.row[1].Y,"onUpdate:modelValue":a=>e.row[1].Y=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[_,a.Editable]])]),_:2},1032,["label"])]),_:2},1032,["data"])]),_:2},1536),[[_,a.Editable]]),$(w,null,{default:v(()=>[(b(),y(h,{key:JSON.stringify(a.Place)+a.Name+l,macro:a,"zone-id":f(Ve).selectZone},null,8,["macro","zone-id"]))]),_:2},1024),a.Editable?P("",!0):(b(),y(u,{key:0,class:"buttonArea",style:U({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:v(()=>[$(t,{type:"primary",size:"small",onClick:e=>f(Ve).doLocalWayMark(a.Place)},{default:v(()=>[Z(I(e.$t("zoneMacro.doLocal")),1)]),_:1},8,["onClick"]),$(t,{type:"primary",size:"small",onClick:e=>f(Ve).doPartyWayMark(a.Place)},{default:v(()=>[Z(I(e.$t("zoneMacro.doPublic")),1)]),_:1},8,["onClick"]),$(t,{icon:f(se),size:"small",class:"export",onClick:e=>f(Ve).exportWaymarksJson(a)},null,8,["icon","onClick"]),a.Deletability?(b(),y(t,{key:0,icon:f(G),size:"small",onClick:e=>f(Ve).editMacroPlace(a)},null,8,["icon","onClick"])):P("",!0)]),_:2},1032,["style"])),a.Editable?(b(),y(u,{key:1,class:"buttonAreaEditing"},{default:v(()=>[$(t,{type:"success",size:"small",icon:f(ae),onClick:e=>f(Ve).submitMacroPlace(a)},{default:v(()=>[Z(I(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(b(),y(t,{key:0,type:"danger",size:"small",icon:f(le),onClick:e=>f(Ve).deleteMacro(a)},{default:v(()=>[Z(I(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):P("",!0)]),_:2},1024)):P("",!0)])):P("",!0)]),_:2},1024))),128))]),_:1})]),_:1}),D("input",{ref_key:"fileInput",ref:Ee,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:Ne},null,544),$(me,{modelValue:f(Ie),"onUpdate:modelValue":l[10]||(l[10]=e=>A(Ie)?Ie.value=e:null),title:e.$t("zoneMacro.uisaveDialogTitle"),width:"800px"},{footer:v(()=>[D("div",De,[$(t,{onClick:l[9]||(l[9]=e=>Ie.value=!1)},{default:v(()=>[Z(I(e.$t("zoneMacro.cancel")),1)]),_:1}),$(t,{type:"primary",disabled:0===f(Ue).length,onClick:Se},{default:v(()=>[Z(I(e.$t("zoneMacro.importSelected",[f(Ue).length])),1)]),_:1},8,["disabled"])])]),default:v(()=>[D("div",$e,[$(T,{modelValue:f(Pe),"onUpdate:modelValue":l[8]||(l[8]=e=>A(Pe)?Pe.value=e:null)},{default:v(()=>[Z(I(e.$t("zoneMacro.onlyCurrentZone",[f(Ae),Le(f(Ae))])),1)]),_:1},8,["modelValue"])]),$(z,{data:f(Te),style:{width:"100%"},height:"400",onSelectionChange:je},{default:v(()=>[$(p,{type:"selection",width:"40"}),$(p,{label:e.$t("zoneMacro.slot"),width:"80",align:"center",sortable:"","sort-by":"index"},{default:v(({row:e})=>[Z(I(e.index+1),1)]),_:1},8,["label"]),$(p,{prop:"mark.regionID",label:e.$t("zoneMacro.mapID"),width:"100",sortable:"","sort-by":"mark.regionID"},{default:v(({row:e})=>[Z(I(e.mark.regionID),1)]),_:1},8,["label"]),$(p,{label:e.$t("zoneMacro.mapName"),sortable:"","sort-method":He,"min-width":"150"},{default:v(({row:e})=>[Z(I(Le(e.mark.regionID)),1)]),_:1},8,["label"]),$(p,{label:e.$t("zoneMacro.preview"),width:"70",align:"center"},{default:v(({row:e})=>[$(S,{placement:"left",width:280,trigger:"hover"},{reference:v(()=>[$(t,{icon:f(ue),circle:"",size:"small"},null,8,["icon"])]),default:v(()=>[$(a,{waymark:e.mark,size:250},null,8,["waymark"])]),_:2},1024)]),_:1},8,["label"]),$(p,{label:e.$t("zoneMacro.timestamp"),width:"160",sortable:"","sort-by":"mark.timestamp"},{default:v(({row:e})=>[Z(I(new Date(1e3*e.mark.timestamp).toLocaleString()),1)]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"])]),_:1},512)),[[_,f(Ve).show]])}}}),[["__scopeId","data-v-c8a97a78"]]);export{Ve as default};
