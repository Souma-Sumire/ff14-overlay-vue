import{_ as e}from"./ActWrapper-5069e8c1.js";import{k as t,r as n,aW as a,J as o,L as r,x as s,y as i,o as u,z as m,H as l,u as c,q as d}from"./vue-49c48d91.js";import{t as f}from"./tts-30083447.js";import{U as p}from"./util-3591e9ca.js";import{N as w,a as b,r as v,c as h}from"./cactbot-49e370f3.js";import{_ as T}from"./_plugin-vue_export-helper-6a8c15be.js";import"./element-plus-901ad096.js";import"./vendor-979eac9e.js";import"./useDev-861d544b.js";import"./useDemo-86956ef5.js";const g=T(t({__name:"enmity",setup(t){let T=0;const g=n([]),y=a("hash"),C=n(!1),j=[p.iconToJobEnum("Paladin"),p.iconToJobEnum("Warrior"),p.iconToJobEnum("DarkKnight"),p.iconToJobEnum("Gunbreaker")],I=[2843,3124,743,1833];let P,L;const k={countdown:w.countdown(),countdownCancel:w.countdownCancel(),wipe:w.network6d({command:["40000010","4000000F"]}),inCombat:w.inCombat()};async function J(){const e=(await h({call:"getCombatants"})).combatants.filter(e=>g.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===T)?.Job;if(void 0===t)return D(),C.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!j.includes(t))return D(),C.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>I.includes(e.BuffID))),partyCombatState:e}}function _(){D(),P=window.setInterval(()=>{J().then(({enmityTanks:e})=>{0!==e.length?C.value=!1:C.value=!0}).catch(()=>{C.value=!1})},500)}function D(){L&&clearTimeout(L),P&&clearInterval(P)}const E=e=>{const t=k.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)_(),L=window.setTimeout(()=>{J().then(({enmityTanks:e})=>{2===e.length&&f("双T都开盾了"),0===e.length&&f("没人开盾")}).catch(()=>{C.value=!1})},1e3*(Number.parseInt(t)-10));else if(k.countdownCancel.test(e.rawLine))D(),C.value=!1;else if(k.wipe.test(e.rawLine))D(),C.value=!1;else if(k.inCombat.test(e.rawLine)){if("false"===y.stRemind)return;const{inACTCombat:t,inGameCombat:n}=k.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===n&&(_(),L=window.setTimeout(()=>{J().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>p.isTankJob(p.jobEnumToJob(e.Job))).length&&1===e.length&&e[0]?.ID!==T&&f("ST开盾")}).catch(()=>{C.value=!1})},2e4))}},x=e=>{g.value=e.party},G=e=>{T=e.charID};return o(()=>{b("LogLine",E),b("PartyChanged",x),b("ChangePrimaryPlayer",G)}),r(()=>{P&&clearInterval(P),L&&clearTimeout(L),v("LogLine",E),v("PartyChanged",x),v("ChangePrimaryPlayer",G)}),(t,n)=>{const a=e;return u(),s(a,null,{default:i(()=>[m(d("strong",null,"没人开盾",512),[[l,c(C)]])]),_:1})}}}),[["__scopeId","data-v-55dd9f0d"]]);export{g as default};
