import{_ as e,c as a}from"./shared-common-Cj1e4wWg.js";import{d as s,c as l,a as t,z as n,b as o,t as r,F as i,n as u,x as d,G as c,o as m,j as v,l as y,B as p,h,g as b,f as g,y as f,r as k,bW as w,cj as j}from"./vendor-vue-MSvGQJWD.js";import{h as x,a1 as C,f as I,U as $,as as T}from"./shared-core-BIIy0jrA.js";import{a as A,r as L,c as B}from"./cactbot-DtpbXwrG.js";import{_ as E}from"./vendor-element-plus-CsMNiL2J.js";const D={class:"user-header"},M={class:"user-info"},F={class:"user-name"},N={key:0,class:"status-badge pre",title:"尚未查询"},S={key:0,class:"status-badge",title:"正在使用 BBY"},z={key:1,class:"status-badge unused",title:"未使用 BBY"},_={class:"user-meta"},q={key:0,class:"user-job"},P={key:1,class:"user-world"},W=e(s({__name:"UserCard",props:{user:{},blurMode:{type:Boolean}},setup:e=>(a,s)=>(t(),l("div",{class:n(["user-card",{"not-responded":e.user.isQueried&&!e.user.hasResponded,"pre-query":!e.user.isQueried,"blur-mode":e.blurMode}])},[o("div",D,[o("div",M,[o("div",F,[o("span",{class:n({"blurred-text":e.blurMode})},r(e.user.name),3),e.user.isQueried?(t(),l(i,{key:1},[e.user.hasResponded?(t(),l("span",S,"BBY")):(t(),l("span",z,"未使用"))],64)):(t(),l("span",N,"尚未查询"))]),o("div",_,[e.user.job?(t(),l("span",q,r(e.user.job),1)):u("",!0),e.user.world?(t(),l("span",P,r(e.user.world),1)):u("",!0)])])])],2))}),[["__scopeId","data-v-80c67691"]]),U={class:"advwm-container"},Y={class:"header"},O={class:"query-methods"},J={class:"query-item"},Q=["disabled"],R={class:"users-section"},H={class:"users-header-row"},X={key:0,class:"status-hint"},Z={class:"using-count"},G={class:"last-query-time"},K={class:"users-list"},V={key:0,class:"empty-state"},ee={key:1,class:"debug-section"},ae={style:{"margin-bottom":"16px"}},se={key:2,class:"history-section"},le={class:"history-header"},te={class:"history-list"},ne={class:"snapshot-header"},oe={class:"snapshot-time"},re={key:0,class:"snapshot-query-time"},ie={class:"snapshot-members"},ue={class:"member-name"},de={key:0,class:"member-world"},ce={class:"member-job"},me=e(s({__name:"bby",setup(e){const s=I();x({addWsParam:!0,allowClose:!1});const D=["A","B","C","D","One","Two","Three","Four"],M={floorMarker:/^(?<timestamp>^.{14}) WaymarkMarker (?<type>1C):(?<operation>[^:]*):(?<waymark>[^:]*):(?<id>[^:]*):(?<name>[^:]*):(?<x>[^:]*):(?<y>[^:]*):(?<z>[^:]*)(?:$|:)/},F=d([]),N=d(""),S=d(!1),z=d({}),_=d({}),q=d(null),P=c(()=>ge.value.filter(e=>e).length),me=d(!1),ve=()=>{me.value=!me.value},ye=C("bby"),pe=d([]);async function he(){const e=pe.value.map(e=>j(e));await ye.replaceAll(e)}async function be(){pe.value=[],await ye.clear()}const ge=d([]),fe=d(null),ke=c(()=>ge.value.map(e=>{if(!e)return null;const a=F.value.find(a=>a.id===e.id),s=$.jobToFullName($.jobEnumToJob(e.job)).cn||"",l=!!q.value;return a?{...a,hasResponded:!0,isQueried:l}:{id:e.id,name:e.name,job:s,world:e.world,flags:0,waymarkIndex:-1,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!1,isInitiator:!1,hasResponded:!1,isQueried:l}}).filter(e=>null!==e));function we(e){const a=e-Math.floor(e);return Math.round(100*(a-.01))}const je=(...e)=>S.value&&void 0,xe=(...e)=>S.value&&void 0,Ce=(...e)=>S.value&&void 0;function Ie(e){return e.endsWith("1")}const $e=e=>{for(const a of e.detail.logs){const e=M.floorMarker.exec(a);if(e?.groups){const{operation:a,waymark:s,id:l,x:t,y:n,z:o}=e.groups,r=parseInt(s||"0");if(xe(`[LogEvent] 捕获标点变更: ${a} waymarkIdx:${r} waymarkName:${D[r]} (x:${t}, y:${n}, z:${o})`),!isNaN(r)&&r>=0&&r<=7&&("Add"===a||"Change"===a?_.value[r]={x:parseFloat(t||"0"),y:parseFloat(n||"0"),z:parseFloat(o||"0"),active:!0}:"Delete"===a&&_.value[r]&&(_.value[r].active=!1)),!a||"Add"!==a&&"Change"!==a)continue;if(!(s&&l&&t&&n&&o)){Ce("[LogEvent] 标点数据缺失:",{operation:a,waymark:s,id:l,x:t,y:n,z:o});continue}const i=parseFloat(t||"0"),u=parseFloat(n||"0"),d=parseFloat(o||"0");if(isNaN(r)||r<0||r>7)continue;if(Math.abs(i)>1e4||Math.abs(u)>1e4)continue;const c=we(d),m=Ie(t),v=Ie(n);if(m&&v){xe(`[LogEvent] 检测到特征信号 (WaymarkIdx: ${r}, Flags: 0x${c.toString(16)})`);if(!!(8&c)&&0===r){xe("[LogEvent] 忽略匿名查询广播");continue}const e=ge.value[r];if(!e){Ce(`[LogEvent] 索引 ${r} 对应的是空槽位`);continue}const a=$.jobToFullName($.jobEnumToJob(e.job)).cn||"";xe(`[LogEvent] 解析成员: ${e.name} (${a})`);Te({id:e.id,name:e.name||"未知",job:a,flags:c,waymarkIndex:r,isAnonymous:!!(1&c),isIdHidden:!!(2&c),isWaymarkEnabled:!!(4&c),isInitiator:!!(8&c),world:e.world})}else je(`[LogEvent] 坐标特征不符 (X:${t}, Y:${n})`)}}};function Te(e){if(e.id===N.value&&e.isInitiator)return;const a=F.value.findIndex(a=>a.id===e.id);a>=0?(xe(`[User] 更新用户信息: ${e.name}`),F.value[a]=e):e.isInitiator&&e.id!==N.value?(xe(`[User] 检测到来自 ${e.name} 的被动查询，清空当前列表`),F.value.length>0&&(xe("[User] 存档当前列表到历史记录"),pe.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:q.value,members:[...F.value]}),he()),q.value=(new Date).toLocaleTimeString(),F.value=[e]):(xe(`[User] 新增响应者: ${e.name}`),F.value.push(e)),xe("当前响应者列表:",F.value)}const Ae=e=>{const a=[];if(e.party&&Array.isArray(e.party))for(const t of e.party)t.id&&t.inParty&&a.push({id:t.id.toUpperCase(),hexId:parseInt(t.id,16),name:t.name||"",job:t.job||0,level:t.level||0,world:T[t.worldId]||""});const s=[...a].sort((e,a)=>e.hexId-a.hexId),l=new Array(8).fill(null);for(let t=0;t<8;t++){const e=(t+3)%8;e<s.length&&(l[t]=s[e]||null)}ge.value=l,xe(l)},Le=()=>{const e="A",a=_.value[0]||{x:0,y:0,z:0},s=0===a.x&&0===a.y&&0===a.z;let l=Math.round(10*a.x)/10;l+=l>=0?.01:-.01;let t=Math.round(10*a.y)/10;t+=t>=0?.01:-.01;let n=Math.floor(a.z+.01);n+=.16;const o={Local:!1,[e]:{X:l,Y:n,Z:t,Active:!0}};xe(`[Ask] 计算坐标(索引 0): X=${l}, Y=${n}, Z=${t}`),(e=>{xe("调用鲶鱼精邮差:",JSON.stringify(e)),B({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({...e,LocalOnly:!1})})})(o),F.value.length>0&&(pe.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:q.value,members:[...F.value]}),he()),q.value=(new Date).toLocaleTimeString(),F.value=[],E.closeAll(),E.info({message:"正在获取信号...",position:"top-left",customClass:"bby-mini-notify",showClose:!1}),fe.value&&clearTimeout(fe.value),fe.value=setTimeout(()=>{s&&(xe("清理所有标点"),B({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({LocalOnly:!1,A:{},B:{},C:{},D:{},One:{},Two:{},Three:{},Four:{}})})),fe.value=null,E.closeAll(),F.value.length>0?E.success({message:`发现 ${F.value.length} 名 BBY 成员`,position:"top-left",customClass:"bby-mini-notify",showClose:!1}):E.warning({message:"未发现 BBY 成员",position:"top-left",customClass:"bby-mini-notify",showClose:!1})},1e3)},Be=e=>{const a=e.charID.toString(16).toUpperCase();N.value!==a&&(N.value=a,xe(`我的 ID 已更新: ${a}`))},Ee=()=>{const e=["地平关","迷雾湿地","拉诺西亚","紫水栈桥","幻影群岛"],a=["鸣神小吉","猫三水","苏摩","艾露恩","莉莉丝","阿尔法","欧米茄","泰坦","利维亚桑","希瓦"],s=[];for(let t=0;t<8;t++)s.push({id:(1e3+t).toString(16).toUpperCase(),hexId:1e3+t,name:a[t%a.length],job:1+t%38,level:100,world:e[t%e.length]});ge.value=s;const l=[];s.forEach((e,a)=>{Math.random()>.4&&l.push({id:e.id,name:e.name,job:$.jobToFullName($.jobEnumToJob(e.job)).cn||"冒险者",flags:0,waymarkIndex:a,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!0,isInitiator:!1,world:e.world})}),q.value=(new Date).toLocaleTimeString(),F.value=l};return m(()=>{!async function(){try{const e=await ye.getAll();e&&e.length>0&&(pe.value=e.sort((e,a)=>a.key.localeCompare(e.key)))}catch(e){}}(),A("onLogEvent",$e),A("PartyChanged",Ae),A("ChangePrimaryPlayer",Be);const e=v({storageKey:"bby-theme"}),a=y(e);!1===e.value&&a()}),p(()=>{L("onLogEvent",$e),L("PartyChanged",Ae),L("ChangePrimaryPlayer",Be)}),(e,d)=>{const c=a;return t(),h(c,null,{default:b(()=>[o("div",U,[o("div",Y,[d[2]||(d[2]=o("h2",null,"小队里谁在使用BBY",-1)),o("div",O,[o("div",J,[o("button",{class:n(["ask-btn",{searching:!!fe.value}]),onClick:Le,disabled:!!fe.value},r(fe.value?"正在查询...":"主动查询"),11,Q),g(s)?(t(),l("button",{key:0,class:"ask-btn fake-test-btn",onClick:Ee}," 生成测试数据 ")):u("",!0),d[0]||(d[0]=o("span",{class:"item-desc"},[f(" 通过场地标点通信，需要使用鲶鱼精邮差（你和对方都要）并处于可以标点的同一地图中"),o("br")],-1))]),d[1]||(d[1]=o("div",{class:"query-item passive"},[o("span",{class:"passive-title"},"被动接收"),o("span",{class:"item-desc"},"当队伍内其他玩家发起查询时，此处也会同步显示结果。")],-1))])]),o("div",R,[o("div",H,[o("h3",null,"当前小队 ("+r(ke.value.length)+")",1),q.value?(t(),l(i,{key:1},[o("span",Z,"发现使用中: "+r(F.value.length),1),o("span",G,"最后查询: "+r(q.value),1)],64)):(t(),l("span",X,"尚未进行查询"))]),o("div",K,[(t(!0),l(i,null,k(ke.value,e=>(t(),h(W,{key:e.id,user:e,"blur-mode":me.value,onContextmenu:w(ve,["prevent"])},null,8,["user","blur-mode"]))),128))])]),0===ke.value.length?(t(),l("div",V,[...d[3]||(d[3]=[o("p",null,"等待小队数据...",-1)])])):u("",!0),S.value?(t(),l("div",ee,[d[11]||(d[11]=o("h3",null,"调试信息",-1)),o("div",ae,[d[4]||(d[4]=o("strong",null,"用户总数:",-1)),f(" "+r(F.value.length),1),d[5]||(d[5]=o("br",null,null,-1)),d[6]||(d[6]=o("strong",null,"应答者数:",-1)),f(" "+r(ke.value.length),1),d[7]||(d[7]=o("br",null,null,-1)),d[8]||(d[8]=o("strong",null,"小队成员数:",-1)),f(" "+r(P.value),1)]),o("details",null,[d[9]||(d[9]=o("summary",null,"用户列表详情",-1)),o("pre",null,r(F.value),1)]),o("details",null,[d[10]||(d[10]=o("summary",null,"标点解析详情",-1)),o("pre",null,r(z.value),1)])])):u("",!0),pe.value.length>0?(t(),l("div",se,[o("div",le,[o("h3",null,"历史记录 ("+r(pe.value.length)+")",1),o("button",{class:"clear-history-btn",onClick:be},"清空历史")]),o("div",te,[(t(!0),l(i,null,k(pe.value,(e,a)=>(t(),l("div",{key:a,class:"history-item"},[o("div",ne,[o("div",oe,"存档时间: "+r(e.timestamp),1),e.queryTime?(t(),l("div",re,"查询时间: "+r(e.queryTime),1)):u("",!0)]),o("div",ie,[(t(!0),l(i,null,k(e.members,e=>(t(),l("div",{key:e.id,class:"history-member-tag"},[o("span",ue,r(e.name),1),e.world?(t(),l("span",de,r(e.world),1)):u("",!0),o("span",ce,r(e.job),1)]))),128))])]))),128))])])):u("",!0)])]),_:1})}}}),[["__scopeId","data-v-c566704b"]]);export{me as default};
