const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BDX5zKpi.js","assets/index-KvaI-AmP.js","assets/index-UC8NxFqI.js","assets/index-BcVR4bQL.css","assets/validator-CjloZ3Xb.js","assets/index-CphUH1Mn.js","assets/index-DMm7F1S_.js","assets/use-form-common-props-Dq_CR9aO.js","assets/index-DTrbrJAb.js","assets/focus-trap-C2EWSxtz.js","assets/index-B3UkOGLW.js","assets/index-DmFeUug1.js","assets/index-BMRMzDZW.js","assets/_commonjsHelpers-CLPN-Npl.js","assets/index-DJjaN_SQ.js","assets/index-Cb0j40Ks.js","assets/index-CkuD8Gze.js","assets/index-DY8POeFa.js","assets/index-DHlxSnqE.js","assets/index-BmT2PzfO.js","assets/vnode-C953S0yz.js","assets/index-BXbVygHw.js","assets/defaults-CGwgk0Vt.js","assets/clamp-BA6-Lypc.js","assets/index-puhV-yzi.js","assets/index-Ck8cMd74.js","assets/_baseClone-01jSQdH2.js","assets/index-D9b4GHjE.js","assets/index-wtpOgdiq.js","assets/zoneSelecter-ECyudNXK.js","assets/useLang-DcjKKrsC.js","assets/content_type-uhloenTS.js","assets/zoneInfo-Kvs06RCG.js","assets/zone_info-C8YMEhdS.js","assets/index-z7y1K3rT.js","assets/cloneDeep-DttUZbQ7.js","assets/_plugin-vue_export-helper-BCo6x5W8.js","assets/zoneSelecter-BySQY_ZA.css","assets/index-i1kS8I7w.js","assets/index-Dn2JSiFj.js","assets/index-CSwEJc71.js","assets/index-CJt6S9YI.js","assets/index-KtnfWnMF.js","assets/index-Bwi0nMtq.js","assets/index-DPi0ZATO.js","assets/index-Cp-oDfoR.js","assets/index-BHUAGzlo.js","assets/index-BwVd6sOb.js","assets/index-CevVk3A-.js","assets/index-BTfz5b6c.js","assets/index-B_TlCgF6.js","assets/index-BnzLe-4V.js","assets/index-Cwi-wxhH.js","assets/index-DzvMco-Y.js","assets/index-BYmAbhD6.js","assets/index-Bkdt34CC.js","assets/index-Chc0y1iC.js","assets/index-DoInc_wN.js","assets/index-B1uTqGEa.js"])))=>i.map(i=>d[i]);
import{d as e,A as t,r as a,c as s,G as o,a as r,b as n,w as i,t as l,u as c,k as d,F as u,m as p,P as m,Q as v,_ as f,E as y,o as g,S as k,e as b,T as w,U as h,V as D}from"./index-UC8NxFqI.js";import{_ as E}from"./ThemeToggle-DqBQpFEP.js";import{p as x,a as I,_ as j,x as A}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-Z-vjqUDz.js";import{Z as _}from"./zoneInfo-Kvs06RCG.js";import{a as T,g as z}from"./contentFinderCondition-BIZz1N_J.js";import{_ as U}from"./zoneSelecter-ECyudNXK.js";import{_ as O}from"./LanguageSwitcher-DWwDt4OE.js";import{E as C}from"./index-BXbVygHw.js";import{E as F}from"./index-DJjaN_SQ.js";import{E as S}from"./index-Ck8cMd74.js";import{E as Z}from"./index-CkuD8Gze.js";import{E as L}from"./index-wtpOgdiq.js";import{E as V}from"./index-DoInc_wN.js";import{_ as M}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./mapCoordinates-D6Cs2O2e.js";import"./zone_info-C8YMEhdS.js";import"./useLang-DcjKKrsC.js";import"./content_type-uhloenTS.js";import"./index-B3UkOGLW.js";import"./index-CphUH1Mn.js";import"./index-z7y1K3rT.js";import"./use-form-common-props-Dq_CR9aO.js";import"./index-Cb0j40Ks.js";import"./focus-trap-C2EWSxtz.js";import"./index-DmFeUug1.js";import"./index-BMRMzDZW.js";import"./vnode-C953S0yz.js";import"./cloneDeep-DttUZbQ7.js";import"./_baseClone-01jSQdH2.js";import"./validator-CjloZ3Xb.js";import"./index-DMm7F1S_.js";import"./index-DTrbrJAb.js";import"./index-BmT2PzfO.js";const Y={key:0,class:"drag-full-overlay"},$={class:"overlay-content"},N={class:"sub-text"},X={class:"header-container"},B={class:"header-left"},P={class:"title-group"},R={key:0,class:"status-badges"},J={class:"header-right"},W={class:"action-buttons"},q={key:1,class:"content"},G={class:"marks-grid"},K={class:"card-header"},Q={class:"card-title"},H={class:"index-num"},ee={class:"map-id-text"},te={style:{display:"flex",gap:"0"}},ae={class:"waymark-content"},se={class:"waymark-controls"},oe={class:"control-header"},re={class:"col-mark"},ne={class:"waymark-map-container"},ie={key:1,class:"empty-map-placeholder"},le={class:"empty-icon-wrapper"},ce={class:"upload-text"},de=M(e({__name:"uisaveEditor",setup(e){const{t:M}=t(),de=a(null),ue=a(null),pe=a(!1),me=a(!1),ve=a(!1),fe=a(6);let ye=0;const ge=e=>e/1e3,ke=()=>{ve.value=!0},be=(e,t)=>0!==(e.enableFlag&t),we=(e,t,a,s)=>{var o;void 0!==s&&(e[t][a]=(o=s,Math.round(1e3*o)),ke())};async function he(e){const t=(await f(async()=>{const{ElLoading:e}=await import("./index-BDX5zKpi.js");return{ElLoading:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58]))).ElLoading.service({lock:!0,text:"正在解析 UISAVE.DAT...",background:"rgba(0, 0, 0, 0.7)"});me.value=!0;try{await new Promise(e=>setTimeout(e,50)),ue.value=await x(await e.arrayBuffer()),fe.value=12;const t=()=>{ue.value&&fe.value<ue.value.wayMarks.length&&(fe.value+=12,requestAnimationFrame(t))};requestAnimationFrame(t),requestAnimationFrame(t),y.success(M("uisaveEditor.importSuccess")),ve.value=!1}catch(a){y.error(`解析失败: ${a instanceof Error?a.message:String(a)}`)}finally{me.value=!1,t.close()}}function De(){if(!ue.value)return;const{wayMarks:e,markerHeader:t,markerTail:a,otherSections:s,userID:o,payloadUnknown:r,fileFormatVersion:n,fileUnknown:i,belongsToWaymarkDat:l}=ue.value;if(l){const t=new Uint8Array(104*e.length);e.forEach((e,a)=>{const s=104*a,o=new DataView(t.buffer,t.byteOffset+s,104);I.forEach((t,a)=>{o.setInt32(12*a,e[t.key].x,!0),o.setInt32(12*a+4,e[t.key].y,!0),o.setInt32(12*a+8,e[t.key].z,!0)}),t[s+96]=e.enableFlag,t[s+97]=e.unknown,o.setUint16(98,e.regionID,!0),o.setInt32(100,e.timestamp,!0)});const a=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),s=document.createElement("a");return s.href=a,s.download="WAYMARK.DAT",s.click(),URL.revokeObjectURL(a),ve.value=!1,void y.success(M("uisaveEditor.exportSuccess"))}const c=new Uint8Array(16+104*e.length+a.length);c.set(t,0),e.forEach((e,t)=>{const a=16+104*t,s=new DataView(c.buffer,c.byteOffset+a,104);I.forEach((t,a)=>{s.setInt32(12*a,e[t.key].x,!0),s.setInt32(12*a+4,e[t.key].y,!0),s.setInt32(12*a+8,e[t.key].z,!0)}),c[a+96]=e.enableFlag,c[a+97]=e.unknown,s.setUint16(98,e.regionID,!0),s.setInt32(100,e.timestamp,!0)}),c.set(a,16+104*e.length);const d=new Uint8Array(16+c.length+4),u=new DataView(d.buffer);u.setInt16(0,17,!0),u.setInt32(8,c.length,!0),d.set(c,16);const p=new Uint8Array(16+s.length+d.length);p.set(r,0),new DataView(p.buffer).setBigInt64(8,o,!0),p.set(s,16),p.set(d,16+s.length);const m=A(p),v=new Uint8Array(16+m.length),f=new DataView(v.buffer);v.set(n,0),f.setInt32(8,m.length,!0),v.set(i,12),v.set(m,16);const g=URL.createObjectURL(new Blob([v],{type:"application/octet-stream"})),k=document.createElement("a");k.href=g,k.download="UISAVE.DAT",k.click(),URL.revokeObjectURL(g),ve.value=!1,y.success(M("uisaveEditor.exportSuccess"))}const Ee=new Set(["X","Y","Z","ID","Active"]),xe=new Set(["Name","MapID","A","B","C","D","One","Two","Three","Four"]);async function Ie(e){try{const{value:t}=await V.prompt(M("uisaveEditor.pastePrompt"),M("uisaveEditor.importTitle"),{confirmButtonText:M("uisaveEditor.import"),cancelButtonText:M("uisaveEditor.cancel"),inputType:"textarea",inputPlaceholder:'{"Name":...,"MapID":...,"A":{...}...}',inputPattern:/^{.*}$/,inputErrorMessage:M("uisaveEditor.jsonError"),closeOnClickModal:!1,customClass:"ppjson-import-dialog",inputValidator:e=>{if(!e)return M("uisaveEditor.inputEmpty");try{const t=function(e){if("object"!=typeof e||null===e)return"输入必须是 JSON 对象";for(const s of Object.keys(e))if(!xe.has(s))return`根节点包含非法字段: ${s}`;const t=e;if("number"!=typeof t.MapID)return"缺少 MapID 或类型错误 (应为数字)";if("Name"in t&&"string"!=typeof t.Name)return"Name 字段类型错误 (应为字符串)";const a=["A","B","C","D","One","Two","Three","Four"];for(const s of a)if(s in t){const e=t[s];if("object"!=typeof e||null===e)return`标点 ${s} 格式错误 (应为对象)`;for(const t of Object.keys(e))if(!Ee.has(t))return`标点 ${s} 包含非法字段: ${t}`;if("number"!=typeof e.X)return`标点 ${s}.X 类型错误 (应为数字)`;if("number"!=typeof e.Y)return`标点 ${s}.Y 类型错误 (应为数字)`;if("number"!=typeof e.Z)return`标点 ${s}.Z 类型错误 (应为数字)`;if("ID"in e&&"number"!=typeof e.ID)return`标点 ${s}.ID 类型错误 (应为数字)`;if("Active"in e&&"boolean"!=typeof e.Active)return`标点 ${s}.Active 类型错误 (应为布尔值)`}return!0}(JSON.parse(e));return!0===t||`${M("uisaveEditor.invalidPPJson")}: ${t}`}catch{return M("uisaveEditor.jsonError")}}});if(!t)return;const a=JSON.parse(t),s=ue.value?.wayMarks[e];if(!s)return;s.regionID=a.MapID;const o={A:"A",B:"B",C:"C",D:"D",One:"One",Two:"Two",Three:"Three",Four:"Four"},r=(e,t)=>{0!==(s.enableFlag&e)!==t&&(s.enableFlag^=e)};for(const[e,n]of Object.entries(o)){const t=a[e],o=t?{...t,Active:t.Active??!0}:{X:0,Y:0,Z:0,ID:0,Active:!1};we(s,n,"x",o.X),we(s,n,"y",o.Y),we(s,n,"z",o.Z);const i=I.find(e=>e.key===n);i&&r(i.bit,o.Active)}ke(),ke(),y.success(M("uisaveEditor.importSuccess"))}catch(t){if("cancel"===t)return;y.error(M("uisaveEditor.importFail"))}}const je=e=>{const t=e.target.files?.[0];t&&he(t)},Ae=e=>{pe.value=!1,ye=0;const t=e.dataTransfer?.files[0];t?.name.toLowerCase().endsWith(".dat")&&he(t)},_e=()=>{ye++,pe.value=!0},Te=()=>{ye--,0===ye&&(pe.value=!1)};return(e,t)=>{const a=v,f=C,x=F,A=E,V=S,me=Z,ye=L;return g(),s("div",{class:"uisave-editor",onDragenter:m(_e,["prevent"]),onDragover:t[2]||(t[2]=m(()=>{},["prevent"])),onDragleave:m(Te,["prevent"]),onDrop:m(Ae,["prevent"])},[pe.value?(g(),s("div",Y,[r("div",$,[n(a,{size:80,color:"var(--el-color-primary)"},{default:i(()=>[n(c(k))]),_:1}),r("p",null,l(c(M)("uisaveEditor.dropToLoad")),1),r("span",N,l(c(M)("uisaveEditor.description")),1)])])):o("",!0),r("header",X,[r("div",B,[r("div",P,[r("h1",null,l(c(M)("uisaveEditor.title")),1),ue.value?(g(),s("div",R,[ve.value?(g(),d(f,{key:0,type:"danger",effect:"dark",round:"",size:"small",class:"unsaved-tag"},{default:i(()=>[b(" ● "+l(c(M)("uisaveEditor.unsaved")),1)]),_:1})):o("",!0)])):o("",!0)])]),r("div",J,[r("input",{ref_key:"fileInput",ref:de,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:je},null,544),r("div",W,[n(x,{class:"action-btn import-btn",size:"small",round:"",onClick:t[0]||(t[0]=e=>de.value?.click())},{default:i(()=>[n(a,{class:"el-icon--left"},{default:i(()=>[n(c(k))]),_:1}),b(" "+l(c(M)("uisaveEditor.parseDat")),1)]),_:1}),n(x,{class:"action-btn export-btn",type:"primary",size:"small",round:"",disabled:!ue.value,onClick:De},{default:i(()=>[n(a,{class:"el-icon--left"},{default:i(()=>[n(c(w))]),_:1}),b(" "+l(c(M)("uisaveEditor.download")),1)]),_:1},8,["disabled"])]),t[3]||(t[3]=r("div",{class:"divider"},null,-1)),n(O),n(A,{"storage-key":"ui-save-editor"})])]),ue.value?(g(),s("div",q,[r("div",G,[(g(!0),s(u,null,p(ue.value.wayMarks.slice(0,fe.value),(e,o)=>(g(),d(ye,{key:o,shadow:"hover",class:"waymark-card"},{header:i(()=>[r("div",K,[r("div",Q,[r("span",H,"#"+l(o+1),1),r("span",ee,l(c(M)("uisaveEditor.mapId",[e.regionID])),1)]),n(U,{"select-zone":c(z)(e.regionID).toString(),placeholder:c(M)("uisaveEditor.zoneSelectPlaceholder"),"onUpdate:selectZone":t=>{e.regionID=c(T)(Number(t)),ke()},width:"100%","show-all-levels":!1,border:!1,class:"header-zone-select"},null,8,["select-zone","placeholder","onUpdate:selectZone"]),r("div",te,[n(x,{size:"small",icon:c(k),onClick:e=>Ie(o),title:`${c(M)("uisaveEditor.import")} PP JSON`,text:"",style:{margin:"0"}},{default:i(()=>[b(l(c(M)("uisaveEditor.import")),1)]),_:1},8,["icon","onClick","title"]),n(x,{size:"small",icon:c(D),onClick:e=>async function(e){const t=ue.value?.wayMarks[e];if(!t)return;const a=_[z(t.regionID)],s={Name:a?.name.cn||a?.name.en||`Zone_${t.regionID}`,MapID:t.regionID,A:{X:ge(t.A.x),Y:ge(t.A.y),Z:ge(t.A.z),ID:0,Active:be(t,1)},B:{X:ge(t.B.x),Y:ge(t.B.y),Z:ge(t.B.z),ID:1,Active:be(t,2)},C:{X:ge(t.C.x),Y:ge(t.C.y),Z:ge(t.C.z),ID:2,Active:be(t,4)},D:{X:ge(t.D.x),Y:ge(t.D.y),Z:ge(t.D.z),ID:3,Active:be(t,8)},One:{X:ge(t.One.x),Y:ge(t.One.y),Z:ge(t.One.z),ID:4,Active:be(t,16)},Two:{X:ge(t.Two.x),Y:ge(t.Two.y),Z:ge(t.Two.z),ID:5,Active:be(t,32)},Three:{X:ge(t.Three.x),Y:ge(t.Three.y),Z:ge(t.Three.z),ID:6,Active:be(t,64)},Four:{X:ge(t.Four.x),Y:ge(t.Four.y),Z:ge(t.Four.z),ID:7,Active:be(t,128)}};await navigator.clipboard.writeText(JSON.stringify(s)),await navigator.clipboard.writeText(JSON.stringify(s)),y.success(M("uisaveEditor.copySuccess"))}(o),title:`${c(M)("uisaveEditor.copy")} PP JSON`,text:"",style:{margin:"0"}},{default:i(()=>[b(l(c(M)("uisaveEditor.copy")),1)]),_:1},8,["icon","onClick","title"])])])]),default:i(()=>[r("div",ae,[r("div",se,[r("div",oe,[r("span",re,l(c(M)("uisaveEditor.active")),1),t[4]||(t[4]=r("span",{class:"col-coord"},"X",-1)),t[5]||(t[5]=r("span",{class:"col-coord"},"Y",-1)),t[6]||(t[6]=r("span",{class:"col-coord"},"Z",-1))]),(g(!0),s(u,null,p(c(I),t=>(g(),s("div",{key:t.key,class:"control-row"},[n(V,{"model-value":be(e,t.bit),onChange:a=>((e,t)=>{const a=0===(e.enableFlag&t);if(e.enableFlag^=t,ke(),a){const a=I.find(e=>e.bit===t);if(a){const t=e[a.key];0===t.x&&0===t.y&&0===t.z&&(t.x=1e5,t.z=1e5)}}})(e,t.bit),class:"marker-checkbox",disabled:0===e.regionID},{default:i(()=>[b(l(t.label),1)]),_:2},1032,["model-value","onChange","disabled"]),n(me,{"model-value":ge(e[t.key].x),"onUpdate:modelValue":a=>we(e,t.key,"x",a),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"]),n(me,{"model-value":ge(e[t.key].y),"onUpdate:modelValue":a=>we(e,t.key,"y",a),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"]),n(me,{"model-value":ge(e[t.key].z),"onUpdate:modelValue":a=>we(e,t.key,"z",a),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"])]))),128))]),r("div",ne,[0!==e.regionID?(g(),d(j,{key:0,waymark:e,size:250},null,8,["waymark"])):(g(),s("div",ie,[n(a,{size:24,color:"var(--el-text-color-placeholder)"},{default:i(()=>[n(c(h))]),_:1})]))])])]),_:2},1024))),128))])])):(g(),s("div",{key:2,class:"empty-state",onClick:t[1]||(t[1]=e=>de.value?.click())},[r("div",le,[n(a,{size:64},{default:i(()=>[n(c(k))]),_:1})]),r("h2",null,l(c(M)("uisaveEditor.startUsage")),1),r("p",ce,l(c(M)("uisaveEditor.description")),1)]))],32)}}}),[["__scopeId","data-v-72b9f756"]]);export{de as default};
