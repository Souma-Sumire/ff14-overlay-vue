import{M as e,d as t,z as l,N as i,i as n,O as a,P as s,Q as o,_ as r,S as c,A as d,c as u,o as p,T as m,b as f,u as y,s as g,U as w,V as b,W as v,r as h,X as _,h as x,j as S,D as $,a as F,q as T,k as j,w as O,n as V,Y as k,J as C,Z as E,t as I,e as A,$ as B,a0 as N,a1 as z,a2 as U,a3 as D,a4 as P,f as J,a5 as L,a6 as M,F as R,m as H,a7 as K,B as W,a8 as Z,a9 as q,l as Q,v as Y,E as G,aa as X}from"./index-C_vJrq5H.js";/* empty css                  *//* empty css                  *//* empty css                */import{u as ee,_ as te,p as le}from"./TimelineShow-MViPFQza.js";import{E as ie}from"./el-slider-Ct6ksQ15.js";/* empty css                 */import{E as ne}from"./el-input-number-C2KhqdY8.js";/* empty css                   */import{E as ae}from"./el-popper-VrKIWMTN.js";import{E as se}from"./el-link-CPi2_ksn.js";import{E as oe}from"./el-col-BrdHe519.js";import{E as re,a as ce}from"./el-form-CqRLHISV.js";import{E as de}from"./el-empty-DEWNinop.js";import{E as ue}from"./el-card-Cy19VjyD.js";import{E as pe}from"./el-checkbox-BMro3ZXq.js";import"./el-tag-CL4elYdq.js";import{E as me,a as fe}from"./el-select-nw4Uy7Vr.js";import{E as ye,_ as ge}from"./zoneSelecter.vue_vue_type_script_setup_true_lang-CfWX7pu1.js";import{E as we}from"./el-switch-CBjkiNNt.js";import{a as be,E as ve}from"./el-table-column-UN8yUgsx.js";/* empty css                  */import{g as he}from"./actionChinese-DM96CSZ4.js";import{U as _e}from"./util-BSI8OlRX.js";import{h as xe,g as Se}from"./xivapi-a6oZXlzI.js";import{E as $e,a as Fe}from"./index-BiQCIIgT.js";import{C as Te}from"./index-BQUC8YF5.js";import{f as je}from"./vnode-DCFdyNXF.js";import{E as Oe}from"./validator-B4JQ65dM.js";import{E as Ve}from"./index-DtlOpm4r.js";import{_ as ke}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{E as Ce}from"./el-row-OdOxnJyS.js";import{_ as Ee}from"./ThemeToggle-Nw-CaZvI.js";/* empty css                        */import{E as Ie}from"./el-overlay-B3W8Hr_9.js";import{l as Ae}from"./lz-string-Bhlr6y1U.js";import{h as Be}from"./moment-CBOc1lqT.js";import{u as Ne}from"./useWebSocket-CrZK_hjZ.js";import{c as ze}from"./clipboard-BKuKuDeo.js";import{a as Ue,c as De}from"./overlay_plugin_api-DHbPkDtN.js";import{Z as Pe}from"./zoneInfo-Kvs06RCG.js";import{E as Je,a as Le,b as Me}from"./index-DYYxig3l.js";import{u as Re}from"./use-form-common-props-gFrq1vXC.js";import{E as He}from"./index-gXo5Vck_.js";import{E as Ke}from"./index-cSJq7UaI.js";import"./status-DO8_dJa3.js";import"./regexes-Blkj7yOl.js";import"./chineseToIcon-xFdmTerz.js";import"./index-D0Ykw6Qx.js";import"./focus-trap-cRSfNoTL.js";import"./index-qmBAyEMl.js";import"./_baseClone-DJG_2cop.js";import"./index-D9P7iDwm.js";import"./el-radio-BpLq7HGe.js";import"./useLang-D9mhVQKB.js";import"./content_type-uhloenTS.js";import"./cloneDeep-UT94MEV4.js";import"./raf-BsVmNUKN.js";import"./index-B1JHDqqb.js";import"./index-22NpK9fU.js";import"./_commonjsHelpers-CLPN-Npl.js";import"./zone_info-C8YMEhdS.js";const We=(s,o)=>{const r=e({}),c=e([]),d=new WeakMap,u=()=>{c.value=((e,t,l)=>je(e.subTree).filter(e=>{var l;return a(e)&&(null==(l=e.type)?void 0:l.name)===t&&!!e.component}).map(e=>e.component.uid).map(e=>l[e]).filter(e=>!!e))(s,o,r.value)},p=e=>e.render(),m=t({setup:(e,{slots:t})=>()=>(u(),t.default?l(p,{render:t.default}):null)});return{children:c,addChild:e=>{r.value[e.uid]=e,i(r),n(()=>{const t=e.getVnode().el,l=t.parentNode;if(!d.has(l)){d.set(l,[]);const e=l.insertBefore.bind(l);l.insertBefore=(t,n)=>(d.get(l).some(e=>t===e||n===e)&&i(r),e(t,n))}d.get(l).push(t)})},removeChild:e=>{delete r.value[e.uid],i(r);const t=e.getVnode().el,l=t.parentNode,n=d.get(l),a=n.indexOf(t);n.splice(a,1)},ChildrenSorter:m}},Ze=s({space:{type:[Number,String],default:""},active:{type:Number,default:0},direction:{type:String,default:"horizontal",values:["horizontal","vertical"]},alignCenter:{type:Boolean},simple:{type:Boolean},finishStatus:{type:String,values:["wait","process","finish","error","success"],default:"finish"},processStatus:{type:String,values:["wait","process","finish","error","success"],default:"process"}}),qe={[Te]:(e,t)=>[e,t].every(o)},Qe="ElSteps",Ye=t({name:"ElSteps"});var Ge=r(t({...Ye,props:Ze,emits:qe,setup(e,{emit:t}){const l=e,i=c("steps"),{children:n,addChild:a,removeChild:s,ChildrenSorter:o}=We(w(),"ElStep");return d(n,()=>{n.value.forEach((e,t)=>{e.setIndex(t)})}),b(Qe,{props:l,steps:n,addStep:a,removeStep:s}),d(()=>l.active,(e,l)=>{t(Te,e,l)}),(e,t)=>(p(),u("div",{class:g([y(i).b(),y(i).m(e.simple?"simple":e.direction)])},[m(e.$slots,"default"),f(y(o))],2))}}),[["__file","steps.vue"]]);const Xe=s({title:{type:String,default:""},icon:{type:v},description:{type:String,default:""},status:{type:String,values:["","wait","process","finish","error","success"],default:""}}),et=t({name:"ElStep"});var tt=r(t({...et,props:Xe,setup(e){const t=e,l=c("step"),i=h(-1),a=h({}),s=h(""),r=_(Qe),b=w();n(()=>{d([()=>r.props.active,()=>r.props.processStatus,()=>r.props.finishStatus],([e])=>{R(e)},{immediate:!0})});const v=x(()=>t.status||s.value),B=x(()=>{const e=r.steps.value[i.value-1];return e?e.internalStatus.value:"wait"}),N=x(()=>r.props.alignCenter),z=x(()=>"vertical"===r.props.direction),U=x(()=>r.props.simple),D=x(()=>r.steps.value.length),P=x(()=>{var e;return(null==(e=r.steps.value[D.value-1])?void 0:e.uid)===b.uid}),J=x(()=>U.value?"":r.props.space),L=x(()=>[l.b(),l.is(U.value?"simple":r.props.direction),l.is("flex",P.value&&!J.value&&!N.value),l.is("center",N.value&&!z.value&&!U.value)]),M=x(()=>{const e={flexBasis:o(J.value)?`${J.value}px`:J.value?J.value:100/(D.value-(N.value?0:1))+"%"};return z.value||P.value&&(e.maxWidth=100/D.value+"%"),e}),R=e=>{e>i.value?s.value=r.props.finishStatus:e===i.value&&"error"!==B.value?s.value=r.props.processStatus:s.value="wait";const t=r.steps.value[i.value-1];t&&t.calcProgress(s.value)},H={uid:b.uid,getVnode:()=>b.vnode,currentStatus:v,internalStatus:s,setIndex:e=>{i.value=e},calcProgress:e=>{const t="wait"===e,l={transitionDelay:`${t?"-":""}${150*i.value}ms`},n=e===r.props.processStatus||t?0:100;l.borderWidth=n&&!U.value?"1px":0,l["vertical"===r.props.direction?"height":"width"]=`${n}%`,a.value=l}};return r.addStep(H),S(()=>{r.removeStep(H)}),(e,t)=>(p(),u("div",{style:T(y(M)),class:g(y(L))},[$(" icon & line "),F("div",{class:g([y(l).e("head"),y(l).is(y(v))])},[y(U)?$("v-if",!0):(p(),u("div",{key:0,class:g(y(l).e("line"))},[F("i",{class:g(y(l).e("line-inner")),style:T(a.value)},null,6)],2)),F("div",{class:g([y(l).e("icon"),y(l).is(e.icon||e.$slots.icon?"icon":"text")])},[m(e.$slots,"icon",{},()=>[e.icon?(p(),j(y(k),{key:0,class:g(y(l).e("icon-inner"))},{default:O(()=>[(p(),j(V(e.icon)))]),_:1},8,["class"])):"success"===y(v)?(p(),j(y(k),{key:1,class:g([y(l).e("icon-inner"),y(l).is("status")])},{default:O(()=>[f(y(C))]),_:1},8,["class"])):"error"===y(v)?(p(),j(y(k),{key:2,class:g([y(l).e("icon-inner"),y(l).is("status")])},{default:O(()=>[f(y(E))]),_:1},8,["class"])):y(U)?$("v-if",!0):(p(),u("div",{key:3,class:g(y(l).e("icon-inner"))},I(i.value+1),3))])],2)],2),$(" title & description "),F("div",{class:g(y(l).e("main"))},[F("div",{class:g([y(l).e("title"),y(l).is(y(v))])},[m(e.$slots,"title",{},()=>[A(I(e.title),1)])],2),y(U)?(p(),u("div",{key:0,class:g(y(l).e("arrow"))},null,2)):(p(),u("div",{key:1,class:g([y(l).e("description"),y(l).is(y(v))])},[m(e.$slots,"description",{},()=>[A(I(e.description),1)])],2))],2)],6))}}),[["__file","item.vue"]]);const lt=N(Ge,{Step:tt}),it=B(tt),nt=s({type:{type:String,values:["primary","success","info","warning","danger",""],default:""},size:{type:String,values:z,default:""},truncated:Boolean,lineClamp:{type:[String,Number]},tag:{type:String,default:"span"}}),at=t({name:"ElText"});const st=N(r(t({...at,props:nt,setup(e){const t=e,l=h(),i=Re(),a=c("text"),s=x(()=>[a.b(),a.m(t.type),a.m(i.value),a.is("truncated",t.truncated),a.is("line-clamp",!U(t.lineClamp))]),o=()=>{var e,i,n,a,s,o,r;if(P().title)return;let c=!1;const d=(null==(e=l.value)?void 0:e.textContent)||"";if(t.truncated){const e=null==(i=l.value)?void 0:i.offsetWidth,t=null==(n=l.value)?void 0:n.scrollWidth;e&&t&&t>e&&(c=!0)}else if(!U(t.lineClamp)){const e=null==(a=l.value)?void 0:a.offsetHeight,t=null==(s=l.value)?void 0:s.scrollHeight;e&&t&&t>e&&(c=!0)}c?null==(o=l.value)||o.setAttribute("title",d):null==(r=l.value)||r.removeAttribute("title")};return n(o),D(o),(e,t)=>(p(),j(V(e.tag),{ref_key:"textRef",ref:l,class:g(y(s)),style:T({"-webkit-line-clamp":e.lineClamp})},{default:O(()=>[m(e.$slots,"default")]),_:3},8,["class","style"]))}}),[["__file","text.vue"]])),ot=new Map;ot.set(26155,{type:"cast",window:[999,999],battleOnce:!0}),ot.set(28027,{type:"cast",window:[999,999],battleOnce:!0}),ot.set(26340,{type:"cast",window:[999,999],battleOnce:!0}),ot.set(25533,{type:"begincast",window:[60,60]}),ot.set(26376,{type:"cast",window:[999,999],battleOnce:!0}),ot.set(26814,{type:"begincast",window:[999,999],battleOnce:!0}),ot.set(25313,{type:"begincast",window:[200,200]}),ot.set(27526,{type:"begincast",window:[999,999],battleOnce:!0}),ot.set(26215,{type:"cast",window:[500,30],battleOnce:!0}),ot.set(29050,{type:"begincast",window:[200,30],battleOnce:!0}),ot.set(29156,{type:"cast",window:[20,20]}),ot.set(27973,{type:"cast",window:[20,20]}),ot.set(27937,{type:"begincast",window:[20,20]}),ot.set(28059,{type:"begincast",window:[20,20]}),ot.set(28060,{type:"begincast",window:[20,20]}),ot.set(28061,{type:"begincast",window:[20,20]}),ot.set(27956,{type:"begincast",window:[20,20]}),ot.set(27957,{type:"begincast",window:[20,20]}),ot.set(27952,{type:"begincast",window:[30,30]}),ot.set(27969,{type:"begincast",window:[20,20]}),ot.set(27971,{type:"begincast",window:[20,20]}),ot.set(27939,{type:"begincast",window:[20,20]}),ot.set(27966,{type:"begincast",window:[20,20]}),ot.set(25316,{type:"begincast",window:[999,999],battleOnce:!0}),ot.set(25544,{type:"begincast",window:[10,10]}),ot.set(26379,{type:"begincast",window:[10,10]}),ot.set(31552,{type:"begincast",window:[30,30]}),ot.set(31573,{type:"begincast",window:[30,30]}),ot.set(31573,{type:"begincast",window:[30,30]}),ot.set(31617,{type:"begincast",window:[8,8]}),ot.set(31624,{type:"begincast",window:[30,30]}),ot.set(31649,{type:"begincast",window:[30,30]}),ot.set(18864,{type:"cast",window:[10,2.5],syncOnce:!0}),ot.set(18480,{type:"cast",window:[200,60],syncOnce:!0,battleOnce:!0}),ot.set(18516,{type:"cast",window:[250,65],syncOnce:!0,battleOnce:!0}),ot.set(18522,{type:"begincast",window:[500,500],syncOnce:!0,battleOnce:!0}),ot.set(18552,{type:"begincast",window:[67,67],syncOnce:!0}),ot.set(18553,{type:"cast",window:[67,67],syncOnce:!0}),ot.set(19083,{type:"cast",window:[900,200],syncOnce:!0,battleOnce:!0}),ot.set(40191,{type:"begincast",window:[200,20],syncOnce:!0}),ot.set(40265,{type:"begincast",window:[500,20],syncOnce:!0,battleOnce:!0}),ot.set(40246,{type:"begincast",window:[999,30],syncOnce:!0,battleOnce:!0}),ot.set(40306,{type:"begincast",window:[30,30],syncOnce:!0}),ot.set(11103,{type:"begincast",window:[310,30],syncOnce:!0,battleOnce:!0}),ot.set(11517,{type:"begincast",window:[600,30],syncOnce:!0,battleOnce:!0}),ot.set(11122,{type:"begincast",window:[100,30],syncOnce:!0,battleOnce:!0}),ot.set(11143,{type:"begincast",window:[60,60],syncOnce:!0}),ot.set(11126,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ot.set(11596,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ot.set(11597,{type:"begincast",window:[100,100],syncOnce:!0,battleOnce:!0}),ot.set(42785,{type:"begincast",window:[9.6,2],syncOnce:!0}),ot.set(42838,{type:"cast",window:[77.2,30],syncOnce:!0,battleOnce:!0}),ot.set(42863,{type:"cast",window:[30,30],syncOnce:!1}),ot.set(42787,{type:"cast",window:[30,30],syncOnce:!1}),ot.set(42864,{type:"cast",window:[30,30],syncOnce:!1}),ot.set(41946,{type:"begincast",window:[10,10],syncOnce:!1}),ot.set(41936,{type:"begincast",window:[20,30],syncOnce:!0}),ot.set(41939,{type:"begincast",window:[20,20],syncOnce:!0}),ot.set(42825,{type:"begincast",window:[60,60],syncOnce:!0,battleOnce:!0}),ot.set(41969,{type:"begincast",window:[20,20],syncOnce:!0}),ot.set(41871,{type:"cast",window:[60,60],syncOnce:!0,battleOnce:!0}),ot.set(43053,{type:"cast",window:[60,60],syncOnce:!0,battleOnce:!0}),ot.set(45645,{type:"cast",window:[60,60],syncOnce:!0,battleOnce:!0});class rt{storageKey;maxSize;cleanupRatio;constructor(e){this.storageKey=e?.key??"cache:all",this.maxSize=e?.maxSize??2097152,this.cleanupRatio=e?.cleanupRatio??.25}loadAll(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch{return{}}}saveAll(e){try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch{this.cleanupOldEntries(e);try{localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(t){}}}getTotalSize(e){return new Blob([JSON.stringify(e)]).size}cleanupOldEntries(e){const t=Object.entries(e),l=t.map(([e,t])=>({key:e,expire:t?.expire??0}));l.sort((e,t)=>e.expire-t.expire);const i=Math.ceil(t.length*this.cleanupRatio);for(let n=0;n<i;n++)delete e[l[n].key]}set(e,t,l=2592e5){const i=this.loadAll();i[e]={data:t,expire:Date.now()+l},this.getTotalSize(i)>this.maxSize&&this.cleanupOldEntries(i),this.saveAll(i)}get(e){const t=this.loadAll(),l=t[e];return l?l.expire<Date.now()?(delete t[e],this.saveAll(t),null):l.data:null}clearExpired(){const e=this.loadAll(),t=Date.now();let l=!1;for(const i in e)(!e[i].expire||e[i].expire<t)&&(delete e[i],l=!0);l&&this.saveAll(e)}clearAll(){localStorage.removeItem(this.storageKey)}}const ct={class:"query-results"},dt={flex:"~","m-t-10":""},ut={class:"ability-filter-container"},pt={key:0,class:"loading-abilities"},mt=["src","alt","onerror"],ft=ke(t({__name:"FflogsImport",props:{filters:{}},emits:["showFFlogsToggle","editTimeline"],setup(e,{emit:t}){const l=e,i=t,a=new RegExp("(?<=^|\\/)(?<code>(?:a:)?\\w{16,})[#?]fight=(?<fight>\\d+|last)"),s=h("查询"),o=h(""),r=h(!1),c=h(!1),d=h(0),m=h(!1),g=J({});B();const w=ee(),b=new rt({key:"souma-fflogs-cache",maxSize:2097152,cleanupRatio:.25});function v(e){const t=b.get(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}function _(e,t,l=2592e5){const i={data:t,expire:Date.now()+l};b.set(e,JSON.stringify(i),l)}function x(e){return e&&e.expire>Date.now()}async function S(e){c.value=!0,d.value=2,g.player=e,g.type="friendies",g.abilityFilterEvents.length=0,g.abilityFilterCandidate.length=0,g.enemiesAbilityFilterSelected.length=0;try{await async function(){m.value=!1;const e=[];async function t(l){try{const i=`events:friendly:${g.code}:${l}:${g.player?.id}`,n=v(i);let a;n&&x(n)?a=n.data:(a=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${g.code}?start=${l}&end=${g.end}&hostility=0&sourceid=${g.player?.id}&api_key=${w.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),_(i,a)),e.push(...a.events),a.nextPageTimestamp&&a.nextPageTimestamp>0&&a.nextPageTimestamp<g.end&&await t(a.nextPageTimestamp)}catch(i){Ve.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${i}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function l(t,i){if(i>=0)try{const n=`events:enemy:${g.code}:${t}:${g.bossIDs[i]}`,a=v(n);let s;a&&x(a)?s=a.data:(s=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${g.code}?start=${t}&end=${g.end}&hostility=1&sourceid=${g.bossIDs[i]}&api_key=${w.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),_(n,s)),e.push(...s.events),s.nextPageTimestamp&&s.nextPageTimestamp>0&&s.nextPageTimestamp<g.end&&await l(s.nextPageTimestamp,i),i<g.bossIDs.length-1&&await l(t,i+1)}catch(n){Ve.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${n}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}g.abilityFilterEvents.length=0,g.enemiesAbilityFilterSelected.length=0,await Promise.all([t(g.start),l(g.start,0)]);for(const i of e)"begincast"===i.type&&i.sourceIsFriendly||g.abilityFilterEvents.push({time:Number(((i.timestamp-g.start)/1e3).toFixed(1)),type:i.type,actionName:he(i.ability.guid)??i.ability.name,actionId:i.ability.guid,sourceIsFriendly:i.sourceIsFriendly,url:i?.ability?.abilityIcon.replace("-","/").replace(".png","")??"000000/000405",window:void 0,sourceID:i.sourceID});m.value=!0}(),g.abilityFilterCandidate=g.abilityFilterEvents.reduce((e,t)=>(t.sourceIsFriendly&&!e.find(e=>e.actionId===t.actionId)&&e.push(t),e),[]).sort((e,t)=>e.time-t.time),g.player?.icon&&l.filters[g.player.icon]&&(g.abilityFilterSelected=l.filters[g.player.icon]),g.abilityFilterSelected=g.abilityFilterSelected.filter(e=>g.abilityFilterCandidate.find(t=>t.actionId===e)),c.value=!1}catch(t){Ve.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${t}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),c.value=!1}}function V(){c.value=!0,d.value=3,g.player?.icon&&w.updateFilters(g.player?.icon,JSON.parse(JSON.stringify(g.abilityFilterSelected))),g.abilityFilterEvents=g.abilityFilterEvents.filter(e=>e.sourceIsFriendly&&g.abilityFilterSelected.includes(e.actionId)||!e.sourceIsFriendly).sort((e,t)=>e.time-t.time),g.abilityFilterEvents=function(e){for(const t of e){const e=ot.get(t.actionId);e?.type===t.type&&(t.window=e?.window,t.syncOnce=Boolean(e?.syncOnce),t.battleOnce=Boolean(e?.battleOnce))}return e}(g.abilityFilterEvents),g.abilityFilterEventsAfterFilterRawTimeline=g.abilityFilterEvents.map(e=>{const{time:t,actionName:l,actionId:i,type:n,sourceID:a,window:s,sourceIsFriendly:o,syncOnce:c,battleOnce:d}=e;if(o)return`${t} "<${l}>~"${r.value?` tts "${l}"`:""}`;if(/^(?:攻击|attack|攻撃)$/i.test(l)&&!s||"cast"===n&&!s||g.battleSyncedIDs.includes(i))return`# ${t} "${l}"`;const u=g.enemies.find(e=>e.id===a);if(("NPC"===u?.type||/unknown/.test(l))&&!s)return null;const p=`${t} "${l}" ${"begincast"===n?"StartsUsing":"Ability"} { id: "${i.toString(16).toUpperCase()}" }`;return d&&s&&g.battleSyncedIDs.push(i),s?`${p} window ${s.join(",")} ${c?"once":""}`:`# ${p}`}).filter(e=>null!==e).join("\n");const e=w.newTimeline(`导入${g.player?.name}`,{zoneId:g.zoneID.toString(),jobs:[g.player?.icon??"NONE"]},g.abilityFilterEventsAfterFilterRawTimeline,`${g.code}#fight=${g.fightIndex+1}`);B(),i("showFFlogsToggle"),i("editTimeline",w.allTimelines[e]),setTimeout(()=>{d.value=0},500),c.value=!1}async function C(){c.value=!0,d.value=2,g.type="enemies",g.abilityFilterEvents.length=0,g.abilityFilterCandidate.length=0;try{await async function(){m.value=!1;const e=[];async function t(l,i){if(i>=0)try{const n=`events:enemy:${g.code}:${l}:${g.bossIDs[i]}`,a=v(n);let s;a&&x(a)?s=a.data:(s=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${g.code}?start=${l}&end=${g.end}&hostility=1&sourceid=${g.bossIDs[i]}&api_key=${w.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),_(n,s)),e.push(...s.events),s.nextPageTimestamp&&s.nextPageTimestamp>0&&s.nextPageTimestamp<g.end&&await t(s.nextPageTimestamp,i),i<g.bossIDs.length-1&&await t(l,i+1)}catch(n){Ve.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${n}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}g.abilityFilterEvents.length=0,g.enemiesAbilityFilterSelected.length=0,await Promise.all([t(g.start,0)]);for(const i of e)g.abilityFilterEvents.push({time:Number(((i.timestamp-g.start)/1e3).toFixed(1)),type:i.type,actionName:he(i.ability.guid)??i.ability.name,actionId:i.ability.guid,sourceIsFriendly:!1,url:"",window:void 0,sourceID:i.sourceID});m.value=!0,g.enemiesAbilityFilterSelected.length=0;const l=Array.from(new Set(g.abilityFilterEvents.map(e=>e.actionName)));g.enemiesAbilityFilterSelected.push(...l)}(),g.abilityFilterCandidate=g.abilityFilterEvents.reduce((e,t)=>(!1!==t.sourceIsFriendly||e.find(e=>e.actionName===t.actionName)||e.push(t),e),[]).sort((e,t)=>e.time-t.time),g.enemiesAbilityFilterSelected=g.enemiesAbilityFilterSelected.filter(e=>g.abilityFilterCandidate.find(t=>t.actionName===e)),c.value=!1}catch(e){Ve.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${e}`,"获取敌人技能数据失败",{confirmButtonText:"确定",type:"error"}),c.value=!1}}function E(){d.value=3,g.abilityFilterEvents=g.abilityFilterEvents.filter(e=>g.enemiesAbilityFilterSelected.includes(e.actionName)).sort((e,t)=>e.time-t.time),g.abilityFilterEventsAfterFilterRawTimeline=g.abilityFilterEvents.map(e=>{const{time:t,actionName:l,actionId:i,type:n}=e,a="begincast"===n?"StartsUsing":"Ability",s=i.toString(16).toUpperCase(),o=g.enemies.find(t=>t.id===e.sourceID),r="Boss"===o?.type?"Boss":"分身";return`${t} "${l}" ${a} { id: "${s}" } #${o?.name??"未知"}（${r}）`}).join("\n");const e=w.newTimeline("BOSS时间轴（使用前请删除非必要的正则）",{zoneId:g.zoneID.toString(),jobs:[]},g.abilityFilterEventsAfterFilterRawTimeline,`${g.code}#fight=${g.fightIndex+1}`);B(),i("showFFlogsToggle"),i("editTimeline",w.allTimelines[e]),setTimeout(()=>{d.value=0},500)}function B(){g.type="friendies",g.code="",g.fightIndex=0,g.start=0,g.end=0,g.friendlies=[],g.abilityFilterEvents=[],g.abilityFilterCandidate=[],g.abilityFilterSelected=[],g.enemiesAbilityFilterSelected=[],g.abilityFilterEventsAfterFilterRawTimeline="",g.player=void 0,g.zoneID=0,g.bossIDs=[],g.enemies=[],g.battleSyncedIDs=[]}function N(){window.open("https://cn.fflogs.com/profile","_blank")}return n(()=>{b.clearExpired()}),(e,t)=>{const l=$e,i=it,n=lt,b=Oe,h=re,z=ae,U=k,D=ce,P=ue,J=be,K=ve,W=me,Z=fe,q=we;return p(),u(R,null,[f(l,{style:T(y(d)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"","position-absolute":"","z-999":"",class:"guide",onClick:t[0]||(t[0]=e=>d.value--)},{default:O(()=>[...t[8]||(t[8]=[A(" 上一步 ",-1)])]),_:1},8,["style"]),f(n,{active:y(d),class:"steps-guide","align-center":""},{default:O(()=>[f(i,{title:"导入战斗"}),f(i,{title:"选择目标"}),f(i,{title:"过滤技能"})]),_:1},8,["active"]),0===y(d)?(p(),j(P,{key:0,class:"input-section"},{default:O(()=>[f(D,{"label-width":"150px",class:"fflogs-form"},{default:O(()=>[f(h,{label:"FF Logs 战斗链接"},{default:O(()=>[f(b,{modelValue:y(o),"onUpdate:modelValue":t[1]||(t[1]=e=>L(o)?o.value=e:null),placeholder:"https://www.fflogs.com/reports/AAAaAaAAaa1aA1aA?fight=1",autocomplete:"on"},null,8,["modelValue"])]),_:1}),f(h,{label:"FF logs V1 Key"},{default:O(()=>[f(b,{modelValue:y(w).settings.api,"onUpdate:modelValue":t[2]||(t[2]=e=>y(w).settings.api=e),placeholder:"在 FF Logs 个人设置页面获取 V1 API Key",type:"password","show-password":""},{append:O(()=>[f(z,{content:"点击前往 FF Logs 个人设置页面，在最下方填写 V1客户名称 并点击确认后，再获取你的 V1 客户端密钥",placement:"top",effect:"light"},{default:O(()=>[f(l,{type:"primary",link:"",onClick:N},{default:O(()=>[...t[9]||(t[9]=[A(" 如何获取 ",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),f(h,null,{default:O(()=>[f(l,{disabled:"正在查询..."===y(s),type:"primary",onClick:t[3]||(t[3]=e=>async function(e){c.value=!0,B(),s.value="正在查询...";const t=e.match(a);if(!w.settings.api)return Ve.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方<strong>填写 V1 客户名称并点击确认</strong>后，获取你的 V1 客户端密钥</a>'}),s.value="查询",void(c.value=!1);if(!t)return Ve.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),s.value="查询",void(c.value=!1);g.code=t.groups?.code??"";try{const e=`fights:${g.code}`,l=v(e);let i;l&&x(l)?i=l.data:(i=await fetch(`https://cn.fflogs.com/v1/report/fights/${g.code}?api_key=${w.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}),_(e,i)),g.bossIDs=i.enemies.filter(e=>["Boss","NPC"].includes(e.type)).map(e=>e.id),g.enemies=i.enemies.slice(),g.fightIndex=("last"===t?.groups?.fight?i.fights.length:Number.parseInt(t?.groups?.fight??"0"))-1;const n=i.fights[g.fightIndex];g.zoneID=n.zoneID,g.start=n.start_time,g.end=n.end_time,g.friendlies=i.friendlies.filter(e=>"LimitBreak"!==e.icon&&e.fights.find(e=>e.id===g.fightIndex+1)),g.friendlies.sort((e,t)=>{const l=_e.iconToJobEnum(e.icon),i=_e.iconToJobEnum(t.icon);return _e.enumSortMethod(l,i)}),s.value="查询",g.abilityFilterEvents.length=0,g.abilityFilterCandidate.length=0,c.value=!1,d.value=1}catch(l){Ve.alert(`\n  <h3 style="margin-bottom: 10px;">可能的原因：</h3>\n  <ul style="padding-left: 20px; margin-bottom: 10px;">\n    <li> <strong>90%概率</strong>：你没有<strong style="color: red;">先起名</strong>再获取 V1 客户端密钥</li>\n    <li> <strong>5%概率</strong>：该战斗记录是私人或匿名模式</li>\n    <li> <strong>5%概率</strong>：网络异常</li>\n  </ul>\n<p class="error-details"><strong>错误：</strong>${l}</p>\n`,"请求失败",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),s.value="查询",c.value=!1}}(y(o)))},{default:O(()=>[y(c)?(p(),j(U,{key:0,class:"is-loading"},{default:O(()=>[f(y(M))]),_:1})):$("",!0),A(" "+I(y(s)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):$("",!0),F("div",ct,[1===y(d)?(p(),j(P,{key:0,class:"player-selection"},{default:O(()=>[f(K,{data:y(g).friendlies.filter(e=>!["NPC"].includes(e.icon)),stripe:"",border:"",class:"friendlies-table"},{default:O(()=>[f(J,{prop:"name",label:"玩家名称"}),f(J,{label:"职业"},{default:O(({row:e})=>{return[A(I((t=e.icon,_e.jobToFullName(_e.jobEnumToJob(_e.iconToJobEnum(t))).cn)),1)];var t}),_:1}),f(J,{label:"选定",width:"100",align:"center"},{default:O(e=>[f(l,{type:"primary",size:"small",onClick:t=>S(e.row)},{default:O(()=>[...t[10]||(t[10]=[A(" 选择 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),F("div",dt,[f(l,{type:"info",onClick:t[4]||(t[4]=e=>C())},{default:O(()=>[...t[11]||(t[11]=[A("不选择玩家，而是生成BOSS时间轴",-1)])]),_:1})])]),_:1})):$("",!0),2===y(d)?(p(),j(P,{key:1,class:"ability-filter"},{default:O(()=>[F("div",ut,[y(m)?$("",!0):(p(),u("div",pt,[f(U,{class:"is-loading"},{default:O(()=>[f(y(M))]),_:1}),t[12]||(t[12]=F("span",null,"正在加载技能列表...",-1))])),y(m)&&"friendies"===y(g).type?(p(),u(R,{key:1},[f(Z,{modelValue:y(g).abilityFilterSelected,"onUpdate:modelValue":t[5]||(t[5]=e=>y(g).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select",filterable:""},{default:O(()=>[(p(!0),u(R,null,H(y(g).abilityFilterCandidate,e=>(p(),j(W,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:O(()=>[F("img",{src:y(Se)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:y(xe)},null,8,mt),F("span",null,I(e.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"]),f(h,{label:"添加 TTS 语法","w-60":"","m-t-3":""},{default:O(()=>[f(q,{modelValue:y(r),"onUpdate:modelValue":t[6]||(t[6]=e=>L(r)?r.value=e:null)},null,8,["modelValue"])]),_:1}),f(l,{type:"success",class:"filter-confirm-btn",disabled:!y(m),onClick:V},{default:O(()=>[...t[13]||(t[13]=[A(I("生成玩家时间轴"),-1)])]),_:1},8,["disabled"])],64)):y(m)&&"enemies"===y(g).type?(p(),u(R,{key:2},[y(m)?(p(),j(Z,{key:0,modelValue:y(g).enemiesAbilityFilterSelected,"onUpdate:modelValue":t[7]||(t[7]=e=>y(g).enemiesAbilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select",filterable:""},{default:O(()=>[(p(!0),u(R,null,H(y(g).abilityFilterCandidate,e=>(p(),j(W,{key:e.actionName,value:e.actionName,class:"ability-filter-option"},{default:O(()=>[F("span",null,I(e.actionName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])):$("",!0),f(l,{type:"success",class:"filter-confirm-btn",disabled:!y(m),onClick:E},{default:O(()=>[...t[14]||(t[14]=[A(I("生成敌人时间轴"),-1)])]),_:1},8,["disabled"])],64)):$("",!0)])]),_:1})):$("",!0)])],64)}}}),[["__scopeId","data-v-d2ef8fea"]]),yt=ke(t({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const l=e,i=t,n=ee();K(()=>{n.saveTimelineSettings()});const a=x({get:()=>l.modelValue,set:e=>i("update:modelValue",e)}),s=h(-15),o=h([{time:-15,action:"<圣光幕帘>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:-2,action:"<圣灵>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:0,action:"战斗开始！",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:3,action:"<挑衅>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:5,action:"<神圣领域>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1}]);return(e,t)=>{const l=ne,i=re,r=oe,c=Ce,d=ie,m=te,g=ce,w=Ie;return p(),j(w,{modelValue:y(a),"onUpdate:modelValue":t[1]||(t[1]=e=>L(a)?a.value=e:null),modal:!0,overflow:"","close-on-click-modal":!1,"close-on-press-escape":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:O(()=>[...t[2]||(t[2]=[F("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)])]),default:O(()=>[f(g,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:O(()=>[t[3]||(t[3]=F("h3",{class:"form-section-title"}," 参数 ",-1)),f(c,{gutter:20},{default:O(()=>[(p(!0),u(R,null,H(y(n).configValues,(e,t,a)=>(p(),j(r,{key:a,span:12},{default:O(()=>[f(i,{label:y(n).configTranslate[t]},{default:O(()=>[f(l,{modelValue:y(n).configValues[t],"onUpdate:modelValue":e=>y(n).configValues[t]=e,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),t[4]||(t[4]=F("h3",{class:"form-section-title"}," 样式 ",-1)),f(c,{gutter:20},{default:O(()=>[(p(!0),u(R,null,H(y(n).showStyle,(e,t,a)=>(p(),j(r,{key:a,span:12},{default:O(()=>[f(i,{label:y(n).showStyleTranslate[t]},{default:O(()=>[f(l,{modelValue:y(n).showStyle[t],"onUpdate:modelValue":e=>y(n).showStyle[t]=e,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),t[5]||(t[5]=F("h3",{class:"form-section-title"}," 测试用例 ",-1)),f(c,{gutter:20},{default:O(()=>[f(d,{modelValue:y(s),"onUpdate:modelValue":t[0]||(t[0]=e=>L(s)?s.value=e:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),f(m,{config:y(n).configValues,lines:y(o),runtime:y(s),"show-style":y(n).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-fcf4e153"]]),gt={class:"batch-operations",style:{"margin-bottom":"15px",display:"flex","flex-wrap":"wrap","justify-content":"space-between",gap:"10px"}},wt={style:{display:"flex",gap:"10px","flex-wrap":"wrap"}},bt={class:"editor-dialog-content"},vt=["value"],ht={class:"slider-demo-block"},_t={class:"time-display",style:{width:"80px","text-align":"center"}},xt={class:"time-display-text"},St={class:"time-display-text"},$t={style:{"margin-top":"1em"}},Ft=ke(t({__name:"timelineSettings",setup(e){const t=q(),{wsConnected:i}=Ne({allowClose:!0,addWsParam:!0}),a=ee(),s=W(a,"allTimelines"),o=W(a,"filters"),r=h(0),c=h([]),m=h(!1),g=h(!1),w=h(!1),b=h(!1),v=h(!1);let _,S;const $=Z("timelineCurrentlyEditing",{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}),V=h([]);let k=null,C=!1;const E=h(""),B=h(""),N=h("");let z;const U=x(()=>s.value.filter(e=>{const t=e.name.toLowerCase().includes(E.value.toLowerCase()),l=!B.value||e.condition.zoneId===B.value,i=!N.value||e.condition.jobs.includes(N.value);return t&&l&&i})),D=x(()=>{const e=r.value,t=e<0,l=Math.abs(Math.floor(e)),i=Math.floor(l/60),n=l%60;return`${t?"-":""}${String(i).padStart(2,"0")}:${String(n).padStart(2,"0")}`}),P=h(0);function J(e){$.value=e,g.value=!0,ne()}function M(){g.value=!1}function K(){J(a.allTimelines[a.newTimeline()])}function ne(){V.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],le($.value.timeline).then(e=>{V.value=e;const t=Math.max(...V.value.map(e=>e.time),550);P.value=t+30,r.value=-a.configValues.preBattle})}function ae(){if(0===c.value.length)return void G.warning("请选择要删除的时间轴");const e=c.value.map(e=>`「${e.name}」`).join("<br/>");Ve.confirm(`确定要删除选中的 ${c.value.length} 个时间轴吗？<br>${e}`,"批量删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",dangerouslyUseHTMLString:!0,type:"warning"}).then(()=>{G.success(`成功删除 ${c.value.length} 个时间轴`),s.value=s.value.filter(e=>!c.value.includes(e)),c.value=[],m.value=!1}).catch(()=>{})}function ce(){m.value=!m.value,c.value=m.value?[...s.value]:[]}function we(){0!==c.value.length?he(c.value):G.warning("请选择要导出的时间轴")}function he(e){const t=JSON.stringify(e),l=JSON.parse(t);for(const c of l)c.timeline=c.timeline.replace(/^#.*(?:\n|$)/gm,"");const i=JSON.stringify(l),n=Ae.compressToBase64(t),a=Ae.compressToBase64(i),s=n.length,o=a.length;if(s===o)return void Qe(n,"数据复制成功，已写入剪切板。","复制失败，请手动复制！");const r=((s-o)/s*100).toFixed(2);Ve.confirm(`\n     1. 完整版本（包含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${s} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>\n     2. 优化版本（不含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${o} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 节省 ${r}% 的空间<br>\n     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:e=>{if("cancel"===e||"confirm"===e){Qe("confirm"===e?a:n,"数据复制成功，已写入剪切板。","复制失败，请手动复制！")}}})}function xe(){Ve.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:e=>{if(!e)return"请输入导出的字符串";const t=e.split("\n").filter(e=>""!==e.trim());let l=[];for(const i of t){let e;try{e=JSON.parse(i)}catch{try{const t=Ae.decompressFromBase64(i);e=JSON.parse(t)}catch{return`无法解析输入的数据：${i}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(e))return`导入的数据格式不正确：${i}`;l=l.concat(e)}return 0!==l.length||"导入的数据不包含任何时间轴。"},inputErrorMessage:"无效的输入"}).then(({value:e})=>{const t=e.split("\n").filter(e=>""!==e.trim());let l=[];for(const a of t){let e;try{e=JSON.parse(a)}catch{const t=Ae.decompressFromBase64(a);e=JSON.parse(t)}l=l.concat(e)}const i=l.length,n=l.map(e=>`「${e.name}」`).join(", ");Ve({title:"确认",message:`导入 ${i} 个时间轴：\n${n}\n？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:e=>{"cancel"===e?Ve.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:e})=>{"我确认"===e&&Se(l,!0)}).catch(()=>{}):"confirm"===e&&Se(l,!1)}})}).catch(()=>{})}function Se(e,t){t&&(a.allTimelines.length=0),a.allTimelines.push(...e),a.sortTimelines();for(const s of a.allTimelines)void 0===s.condition.jobs&&(s.condition.jobs=[s.condition?.job??"NONE"]);if(t)return void G({type:"success",message:"覆盖成功！",duration:2e3});const l=[],i=new Set;for(const s of a.allTimelines){const e=JSON.stringify({name:s.name,condition:s.condition,timeline:s.timeline,codeFight:s.codeFight,create:s.create});i.has(e)||(i.add(e),l.push(s))}const n=a.allTimelines.length-l.length;a.allTimelines=l,G({message:`追加成功！共导入 ${e.length} 个时间轴${n>0?`，但其中 ${n} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}function Te(e,t={}){De({call:"broadcast",source:"soumaTimelineSettings",msg:{type:e,data:t}})}function je(){const e=t.resolve({path:"/timeline"}),l=`${window.location.protocol}//${window.location.host}/ff14-overlay-vue/${e.href}`;C=!0,k=Ke.service({lock:!0,text:`正在请求数据，请确保 ACT 中已添加并启用此悬浮窗：${l}`,background:"rgba(0, 0, 0, 0.7)"}),Te("get"),setTimeout(()=>{C&&(G.info("重新尝试获取数据..."),je())},5e3)}const ke=e=>{if("soumaTimeline"===e.source)if("post"===e.msg.type){C=!1,k.close();const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>a.jobList.indexOf(e)-a.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");a.allTimelines=t.allTimelines,a.configValues=t.configValues,a.showStyle=t.showStyle,G.closeAll(),G({message:"数据获取成功",type:"success",duration:3e3})}else"success"===e.msg.type?(_&&(clearTimeout(_),_=void 0),S&&(S.close(),S=void 0),He.closeAll(),He({message:"数据同步成功",type:"success",duration:1e3,position:"bottom-left",icon:"el-icon-success",zIndex:1,showClose:!1})):"hello"===e.msg.type&&S&&Xe()};function Re(){window.open("https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8","_blank")}function We(){const e=t.resolve({path:"/timelineHelp"}).href;window.open(e,"_blank")}function Ze(){w.value=!0}function qe(e){a.configValues=e.configValues,a.showStyle=e.showStyle}function Qe(e,t="复制成功",l="复制失败"){ze(e).then(()=>G.success(t)).catch(()=>G.error(l))}function Ye({row:e}){return e===$.value?"editing-row":""}function Ge(){v.value=!0}function Xe(){Te("post",a.$state),clearTimeout(_),_=window.setTimeout(()=>{const e=t.resolve({path:"/timeline"}),i=`${window.location.protocol}//${window.location.host}/ff14-overlay-vue/${e.href}`;S?.close(),S=He({title:"同步数据失败",message:l("div",{style:"color:#f00"},[l("div",["请确保你已正确启用了 ",l("a",{href:i,target:"_blank",style:"color:#f00; text-decoration: underline;"},"此悬浮窗"),"。"])]),showClose:!1,duration:0,position:"bottom-left"})},500)}function et(e){const t=Pe[e]?.name;return t?t.cn||`${t.ja} / ${t.en}`:"未知地图"}function tt(e){return(_e.jobToFullName(e.toUpperCase())?.cn??e).replace("冒险者","全部职业")}return n(()=>{Ue("BroadcastMessage",ke);const e=d(i,t=>{t&&(0===a.allTimelines.length&&je(),e(),z&&(z.close(),Xe()))});a.allTimelines.forEach(e=>e.timeline=e.timeline.replaceAll(/^(?<a>.+), once: true(?<b>.+)$/gm,"$<a>$<b> once"));const t=X(()=>{i.value?Xe():(z?.close(),z=He({title:"你修改了时间轴，但",message:l("i",{style:"color: #f00"},"改动未应用，直到你成功连接到 WebSocket。"),showClose:!1,duration:0,position:"bottom-left"}))},500);d(()=>a.$state,t,{deep:!0})}),a.loadTimelineSettings(),a.sortTimelines(),(e,t)=>{const l=be,i=ve,n=Ie,d=yt,h=$e,_=Fe,x=ye,S=Ee,k=Ce,C=Le,z=ft,W=Oe,Z=ge,q=me,X=fe,ee=st,le=pe,_e=ue,Se=de,Te=Me,je=re,ke=oe,Ae=se,Ne=ie,ze=te,Ue=Je;return p(),j(Ue,{class:"container"},{default:O(()=>[f(n,{modelValue:y(v),"onUpdate:modelValue":t[0]||(t[0]=e=>L(v)?v.value=e:null),title:"时间轴解析结果","align-center":"",center:"",draggable:"",width:"80%"},{default:O(()=>[f(i,{data:y(V)},{default:O(()=>[f(l,{property:"time",label:"time","min-width":"60"}),f(l,{property:"action",label:"action",width:"150"},{default:O(({row:e})=>[A(I(e.action.replaceAll(/(^['"“”]|['"“”]$)/g,"")),1)]),_:1}),f(l,{property:"sync",label:"sync","min-width":"200"},{default:O(({row:e})=>[A(I(e.sync?e.sync:"-"),1)]),_:1}),f(l,{property:"syncOnce",label:"once","min-width":"100"},{default:O(({row:e})=>[A(I(e.syncOnce?"✅":"-"),1)]),_:1}),f(l,{label:"window","min-width":"100"},{default:O(({row:e})=>[A(I(e.sync?`${e.windowBefore},${e.windowAfter}`:"-"),1)]),_:1}),f(l,{property:"jump",label:"jump","min-width":"100"},{default:O(({row:e})=>[A(I(e.jump?e.jump:"-"),1)]),_:1}),f(l,{property:"tts",label:"tts","min-width":"150"},{default:O(({row:e})=>[A(I(e.tts?e.tts:"-"),1)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"]),f(d,{modelValue:y(b),"onUpdate:modelValue":t[1]||(t[1]=e=>L(b)?b.value=e:null),onSave:qe},null,8,["modelValue"]),f(C,{class:"flex-header"},{default:O(()=>[f(k,{justify:"space-between",align:"middle"},{default:O(()=>[f(x,null,{default:O(()=>[f(_,null,{default:O(()=>[f(h,{type:"primary",size:"small",onClick:Ze},{default:O(()=>[...t[21]||(t[21]=[A(" 从 FFlogs 生成 ",-1)])]),_:1}),f(h,{type:"primary",size:"small",onClick:Re},{default:O(()=>[...t[22]||(t[22]=[A(" 从 在线文档 获取 ",-1)])]),_:1}),f(h,{type:"primary",size:"small",onClick:K},{default:O(()=>[...t[23]||(t[23]=[A(" 手动编写 ",-1)])]),_:1})]),_:1}),f(_,null,{default:O(()=>[f(h,{size:"small",onClick:xe},{default:O(()=>[...t[24]||(t[24]=[A(" 导入字符串 ",-1)])]),_:1}),f(h,{size:"small",class:"export",onClick:t[2]||(t[2]=e=>he(y(s)))},{default:O(()=>[...t[25]||(t[25]=[A(" 导出全部 ",-1)])]),_:1})]),_:1})]),_:1}),f(x,null,{default:O(()=>[f(S,{"storage-key":"timeline-settings-theme"}),f(h,{color:"#626aef",style:{color:"white"},size:"small",onClick:t[3]||(t[3]=e=>b.value=!0)},{default:O(()=>[...t[26]||(t[26]=[A(" 参数设置 ",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),f(Te,null,{default:O(()=>[f(n,{modelValue:y(w),"onUpdate:modelValue":t[5]||(t[5]=e=>L(w)?w.value=e:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>w.value=!1,"close-on-press-escape":!1,"close-on-click-modal":!1},{default:O(()=>[f(z,{filters:y(o),onShowFFlogsToggle:t[4]||(t[4]=()=>w.value=!1),onEditTimeline:J},null,8,["filters"])]),_:1},8,["modelValue","before-close"]),y(s).length>0?(p(),j(_e,{key:0},{default:O(()=>[F("div",gt,[F("div",wt,[f(W,{modelValue:y(E),"onUpdate:modelValue":t[6]||(t[6]=e=>L(E)?E.value=e:null),placeholder:"搜索名称...",clearable:"",size:"small",style:{width:"180px"}},null,8,["modelValue"]),f(Z,{selectZone:y(B),"onUpdate:selectZone":t[7]||(t[7]=e=>L(B)?B.value=e:null),placeholder:"筛选地图",size:"small",style:{width:"180px"},clearable:!0},null,8,["selectZone"]),f(X,{modelValue:y(N),"onUpdate:modelValue":t[8]||(t[8]=e=>L(N)?N.value=e:null),placeholder:"筛选职业",clearable:"",size:"small",style:{width:"180px"}},{default:O(()=>[f(q,{label:"全部职业",value:""}),(p(!0),u(R,null,H(y(a).jobList,e=>(p(),j(q,{key:e,label:tt(e),value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),Q(F("div",null,[f(ee,{type:"info"},{default:O(()=>[A(" 筛选结果：共 "+I(y(U).length)+" 个时间轴 ",1)]),_:1})],512),[[Y,y(E)||y(B)||y(N)]]),F("div",null,[f(h,{type:"primary",size:"small",disabled:0===y(c).length,onClick:we},{default:O(()=>[A(" 批量导出 ("+I(y(c).length)+") ",1)]),_:1},8,["disabled"]),f(h,{type:"danger",size:"small",disabled:0===y(c).length,style:{"margin-left":"10px"},onClick:ae},{default:O(()=>[A(" 批量删除 ("+I(y(c).length)+") ",1)]),_:1},8,["disabled"])])]),f(i,{data:y(U),"row-class-name":Ye,style:{width:"100%"},stripe:"","default-sort":{prop:"condition",order:"ascending"},onSelectionChange:t[10]||(t[10]=e=>{c.value=e,m.value=e.length===y(s).length})},{default:O(()=>[f(l,{type:"selection",width:"55",align:"center"},{header:O(()=>[f(le,{modelValue:y(m),"onUpdate:modelValue":t[9]||(t[9]=e=>L(m)?m.value=e:null),onChange:ce},null,8,["modelValue"])]),_:1}),f(l,{prop:"name",label:"名称"}),f(l,{prop:"condition",label:"地图",sortable:""},{default:O(e=>[A(I(et(e.row.condition.zoneId)),1)]),_:1}),f(l,{prop:"condition",label:"职业"},{default:O(e=>[A(I(e.row.condition.jobs.map(e=>tt(e)).join("、").replace("冒险者","全部职业")),1)]),_:1}),f(l,{label:"操作",width:"150"},{default:O(e=>[f(h,{type:"primary",size:"small",onClick:t=>J(e.row)},{default:O(()=>[...t[27]||(t[27]=[A(" 编辑 ",-1)])]),_:1},8,["onClick"]),f(h,{type:"danger",size:"small",onClick:t=>{return l=e.row,void Ve.confirm(`确定要删除「${l.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{s.value.splice(s.value.findIndex(e=>e===l),1)}).catch(()=>{});var l}},{default:O(()=>[...t[28]||(t[28]=[A(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):(p(),j(_e,{key:1},{default:O(()=>[f(Se,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1}))]),_:1}),f(n,{modelValue:y(g),"onUpdate:modelValue":t[20]||(t[20]=e=>L(g)?g.value=e:null),title:"编辑时间轴",top:"5vh","before-close":M,class:"timeline-dialog",width:"65%",style:{"min-width":"550px","max-width":"1000px"},"close-on-click-modal":!1,"close-on-press-escape":!1},{default:O(()=>[F("div",bt,[f(k,{class:"timeline-header",gutter:10},{default:O(()=>[f(ke,{span:14},{default:O(()=>[f(je,{label:"名称"},{default:O(()=>[f(W,{modelValue:y($).name,"onUpdate:modelValue":t[11]||(t[11]=e=>y($).name=e)},null,8,["modelValue"])]),_:1})]),_:1}),f(ke,{span:8},{default:O(()=>[f(je,{label:"来源"},{default:O(()=>["用户创建"!==y($).codeFight?(p(),j(Ae,{key:0,href:`https://cn.fflogs.com/reports/${y($).codeFight.replace("#","?")}&type=damage-done`,target:"_blank"},{default:O(()=>[t[29]||(t[29]=F("img",{class:"site-logo",src:"https://assets.rpglogs.cn/img/ff/favicon.png?v=4",alt:"FF Logs",style:{width:"34px",height:"33.4688px"}},null,-1)),A(I(y($).codeFight),1)]),_:1},8,["href"])):(p(),u("input",{key:1,type:"text",value:`${y($).codeFight}（${y($).create}）`,"w-80":"","p-1.3":"",disabled:""},null,8,vt))]),_:1})]),_:1}),f(ke,{span:22},{default:O(()=>[f(je,{label:"地图"},{default:O(()=>[f(Z,{selectZone:y($).condition.zoneId,"onUpdate:selectZone":t[12]||(t[12]=e=>y($).condition.zoneId=e),size:"default"},null,8,["selectZone"])]),_:1})]),_:1}),f(ke,{span:22},{default:O(()=>[f(je,{label:"职业"},{default:O(()=>[f(X,{modelValue:y($).condition.jobs,"onUpdate:modelValue":t[13]||(t[13]=e=>y($).condition.jobs=e),multiple:""},{default:O(()=>[(p(!0),u(R,null,H(y(a).jobList,e=>(p(),j(q,{key:e,label:tt(e),value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),F("div",ht,[f(Ne,{modelValue:y(r),"onUpdate:modelValue":t[14]||(t[14]=e=>L(r)?r.value=e:null),min:-y(a).configValues.preBattle,max:y(P),step:.1},null,8,["modelValue","min","max"]),F("div",_t,[F("p",xt,I(y(D)),1),F("p",St,"("+I(y(r))+"s)",1)])]),f(k,{class:"timeline-editor-body",gutter:10},{default:O(()=>[f(ke,null,{default:O(()=>[f(W,{modelValue:y($).timeline,"onUpdate:modelValue":t[15]||(t[15]=e=>y($).timeline=e),style:T({width:`calc(100% - ${y(a).showStyle["--timeline-width"]}px)`}),type:"textarea",autosize:{minRows:10,maxRows:20},wrap:"off",placeholder:"请键入时间轴文本",onChange:t[16]||(t[16]=e=>ne())},null,8,["modelValue","style"])]),_:1}),f(ze,{style:{position:"absolute",right:0,top:0},config:y(a).configValues,lines:y(V),runtime:y(r),"show-style":y(a).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1}),F("div",$t,[f(x,null,{default:O(()=>[f(h,{onClick:t[17]||(t[17]=e=>he([y($)]))},{default:O(()=>[...t[30]||(t[30]=[A(" 导出 ",-1)])]),_:1}),f(h,{onClick:t[18]||(t[18]=e=>{$.value.timeline=$.value.timeline.replaceAll(new RegExp("(?<=^|^#\\s*)(\\d+:\\d+(?:\\.\\d{1,2})?|\\d+(?:\\.\\d+)?)","gm"),e=>e.includes(":")?Be.duration(`00:${e}`).as("seconds").toString():Be.utc(1e3*Number(e)).format("mm:ss.S"))})},{default:O(()=>[...t[31]||(t[31]=[A(" 切换时间格式 ",-1)])]),_:1}),f(h,{onClick:We},{default:O(()=>[...t[32]||(t[32]=[A(" 时间轴语法 ",-1)])]),_:1}),f(h,{onClick:t[19]||(t[19]=e=>{Ve.confirm("要删除所有的注释行，仅保留必要的时间轴数据吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(()=>{$.value.timeline=$.value.timeline.replace(/^#.*(?:\n|$)/gm,""),G.success("完成")}).catch(()=>{})})},{default:O(()=>[...t[33]||(t[33]=[A(" 去除注释行 ",-1)])]),_:1}),f(h,{onClick:Ge},{default:O(()=>[...t[34]||(t[34]=[A(" 展示调试信息 ",-1)])]),_:1})]),_:1})])])]),_:1},8,["modelValue"])]),_:1})}}}),[["__scopeId","data-v-7591524f"]]);export{Ft as default};
