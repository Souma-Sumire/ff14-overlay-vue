import{c as e,_ as t}from"./shared-common-BXEBdgir.js";import{_ as n}from"./TimelineShow-DKZYxEpg.js";import{g as o,b as l,C as i}from"./vendor-element-plus-C8e3lHeC.js";import{q as a,v as s,y as c,f as m}from"./shared-core-J8VRPXzA.js";import{c as u,a as r}from"./cactbot-DtpbXwrG.js";import{h as d,J as f,x as p,u as y,G as g,o as v,g as b,e as T,a as h,b as k,c as C,n as w,d as j,f as x,F as A,r as O,z as S,y as _,t as V}from"./vendor-vue-i6lpFrx4.js";const B={id:"wrapper"},E={key:0,class:"optionalTimelines"},I=["onClick"],L={key:7,style:{color:"white","background-color":"black"}},z=t(d({__name:"timeline",setup(t){const d=a(),z=f({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),D=p(0),N=p(0-d.configValues.preBattle),F=p(0);let G=!1;const $=y("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),q=m(),P=g(()=>z.loadedTimeline.filter(e=>e.sync)),J=g(()=>z.loadedTimeline.filter(e=>e.tts));function M(){Z(),z.loadedTimeline.length=0,z.optionalTimeline.length=0;const e=d.getTimeline($.value);1===e.length?R(e[0]):e.length>1&&(z.optionalTimeline=e,R(e[0]))}async function R(e,t=!0){z.selectedOptionalTimeline=e,t&&Z(),G=!1,e?.timeline&&(z.loadedTimeline=await s(e.timeline),z.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{G=!0},1e3)}function Z(){D.value=0,N.value=0-d.configValues.preBattle,F.value=0;for(const e of z.loadedTimeline)e.alertAlready=!1;for(const e of P.value)e.syncAlready=!1}function H(e,t=!0){t&&(G=!1,setTimeout(()=>{G=!0},1e3)),N.value=0,F.value=0,D.value=(new Date).getTime()+1e3*e,J.value.forEach(e=>{e.alertAlready=!1}),K()}function K(){if(0===D.value)return;N.value=((new Date).getTime()-D.value+F.value)/1e3;const e=J.value.find(e=>!e.alertAlready&&e.time-d.configValues.ttsAdvance<=N.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;(G||t)&&c(e)}(e.tts)),requestAnimationFrame(K)}function Q(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)H(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:400000(?:0F|10|03)/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))Z();else{const e=P.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&N.value>=e.time-e.windowBefore&&N.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,U(e.jump||e.time))}}}function U(e){0===D.value&&H(0,!1),F.value+=1e3*(e-N.value),J.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}v(()=>{r("onLogEvent",Q),r("onPlayerChangedEvent",W),r("ChangeZone",X),r("BroadcastMessage",te),r("onInCombatChangedEvent",ne),d.loadTimelineSettings(),o({message:`${d.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),M(),ee("hello")});const W=e=>{$.value.jobs[0]!==e.detail.job&&($.value.jobs[0]=e.detail.job,M())},X=e=>{$.value.zoneId=String(e.zoneID),M()};function Y(){o.closeAll(),o({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){u({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>d.jobList.indexOf(e)-d.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");d.allTimelines=t.allTimelines,d.configValues=t.configValues,d.showStyle=t.showStyle,d.saveTimelineSettings(),o.closeAll(),o({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),M(),ee("success")}"get"===e.msg.type&&ee("post",d.$state)}};function ne(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===D.value?H(0):e.detail.inGameCombat||e.detail.inACTCombat||Z()}return(t,o)=>{const a=l,s=n,m=e;return h(),b(m,null,{default:T(()=>[k("div",B,[x(z).optionalTimeline.length&&x(N)<=-x(d).configValues.preBattle?(h(),C("ul",E,[o[5]||(o[5]=k("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(h(!0),C(A,null,O(x(z).optionalTimeline,(e,t)=>(h(),C("li",{key:t,class:S(x(z).selectedOptionalTimeline===e?"active":""),onClick:t=>{R(e)}},[_(V(e.name)+" ",1),x(z).selectedOptionalTimeline===e?(h(),b(a,{key:0},{default:T(()=>[j(x(i))]),_:1})):w("",!0)],10,I))),128))])):w("",!0),j(s,{config:x(d).configValues,lines:x(z).loadedTimeline,runtime:x(N),"show-style":x(d).showStyle},null,8,["config","lines","runtime","show-style"]),x(q)?(h(),C("button",{key:1,onClick:o[0]||(o[0]=e=>H(30))}," 开始从-30 ")):w("",!0),x(q)?(h(),C("button",{key:2,onClick:o[1]||(o[1]=e=>H(0))}," 开始从0 ")):w("",!0),x(q)?(h(),C("button",{key:3,onClick:o[2]||(o[2]=e=>Z())}," 团灭 ")):w("",!0),x(q)?(h(),C("button",{key:4,onClick:o[3]||(o[3]=e=>{U(1e3)})}," 跳转1000测试 ")):w("",!0),x(q)?(h(),C("button",{key:5,onClick:o[4]||(o[4]=e=>x(c)("今天天气真不错"))}," TTS测试 ")):w("",!0),x(q)?(h(),C("button",{key:6,onClick:Y}," 弹窗测试 ")):w("",!0),x(q)?(h(),C("span",L,V(x(N)),1)):w("",!0)])]),_:1})}}}),[["__scopeId","data-v-68379865"]]);export{z as default};
