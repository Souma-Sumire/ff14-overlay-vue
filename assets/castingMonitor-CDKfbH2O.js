import{_ as t}from"./ActWrapper-B29c7I98.js";import{x as e,d as a,c as r,o as s,F as o,m as n,q as i,s as l,u as c,a as d,X as p,G as y,e as u,t as g,i as m,k as h,w as f,b as I}from"./index-VpNsQfk0.js";import{U as b}from"./util-BSI8OlRX.js";import{c as j,s as T,p as D,a as w,h as _}from"./xivapi-a6oZXlzI.js";import{c as P,a as v}from"./overlay_plugin_api-DHbPkDtN.js";import{_ as C}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as $}from"./useDev-BMQXaWGz.js";import{a as k,b as x,E as A}from"./index-ppP9-inx.js";import{E as L}from"./index-yElX-7CA.js";import"./useDemo-BUXCvhsC.js";import"./index-CZGo-NNe.js";import"./index-cRnXBoNm.js";import"./use-form-common-props-BUKwKChn.js";const M=new URLSearchParams(window.location.href.split("?")[1]),E=["tank","healer","dps","crafter","gatherer","none"],N=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],O=e("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(M.get("duration")||15)}}),getters:{partyDataFormatted:t=>t.partyData.sort((t,e)=>E.indexOf(b.jobToRole(b.jobEnumToJob(t.job)))-E.indexOf(b.jobToRole(b.jobEnumToJob(e.job)))),focusTargetCastArr:t=>t.castData.filter(e=>e.casterId===t.focusTargetId)},actions:{testAction(){const t=N[Math.floor(Math.random()*N.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,t)},testParty(t){this.handlePartyChanged({party:t?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0,level:100,contentId:0,flags:0,objectId:0,partyType:1,territoryType:0}]:[]})},async pushAction(t,e,a,r,s,o){if(0===this.partyData.length&&r===this.playerId||this.partyData.length>0&&r===this.focusTargetId){let n=s,i="action",l=!1;if(a.startsWith("item_"))return;a.startsWith("mount_")&&(n=Number.parseInt(a.replace(/^.+_/,""),16),n>983040&&(n=Number.parseInt(n.toString().slice(-5),10),l=!0),i=a.replace(/_.+$/,""));const c=`${t}-${e}-${r}-${s}`,d={casterId:r,time:t,expirationTime:Date.now()+1e3*this.config.duration,logLine:e,src:"",class:"",key:c},p=j.get(n);if(p&&(d.src=`//${p.Host}${p.Icon}`),this.castData.push(d),14===e&&o&&setTimeout(()=>{this.castData=this.castData.filter(t=>t?.key!==c)},1e3*o-500),a.startsWith("unknown_"))d.src=`${T.first}/i/000000/000405.png`,d.class="action action-category-0";else if(n<1e5){const t=p||await D(i,n,["ID","Icon","ActionCategoryTargetID"]);3===t.ID&&(t.Icon="/i/000000/000104.png"),p||(d.src=await w(t?.Icon??"",l)),"action"===i?d.class=`action action-category-${t?.ActionCategoryTargetID}`:"mount"===i&&(d.class="mount")}}},handleChangePrimaryPlayer(t){this.playerId=t.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(t){"20"===t.line[0]?this.pushAction(Date.now(),14,t.line[5],t.line[2],Number.parseInt(t.line[4],16),Number(t.line[8])):("21"===t.line[0]||"22"===t.line[0]&&"0"===t.line[45])&&this.pushAction(Date.now(),15,t.line[5],t.line[2],Number.parseInt(t.line[4],16))},handlePartyChanged(t){if(t.party.length>0){this.partyData=t.party.filter(t=>t.inParty).map(t=>({...t,src:""}));for(const t in this.castData)Object.prototype.hasOwnProperty.call(this.castData,t)&&(this.partyData.find(e=>e.id===t)||Reflect.deleteProperty(this.castData,t));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(t){t===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=t,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(M.get("syncFocusWS")||"")&&P({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter(t=>t.expirationTime>Date.now())}}}),R={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},S=["data-casterId"],U=["src"],F=C(a({__name:"Main",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),a=O(),p=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(e.get("displayAA")??""));return(t,e)=>(s(),r("div",R,[(s(!0),r(o,null,n(c(a).castData.filter(t=>t.key),t=>(s(),r("div",{key:t.key,"data-casterId":t.casterId,class:l(`images ${t.class} logLine${t.logLine} displayAA${c(p)}`),style:i(`--animeDuration: ${c(a).config.duration}s;`)},[d("img",{src:t.src,class:"action-icon",height:"40",loading:"lazy",onError:e[0]||(e[0]=(...t)=>c(_)&&c(_)(...t))},null,40,U),e[1]||(e[1]=d("img",{class:"frame",loading:"lazy"},null,-1))],14,S))),128))]))}}),[["__scopeId","data-v-67c0fa3f"]]),J={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},W=["onClick"],z={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},H=["src","onerror"],q=C(a({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]);function a(t){const e=b.jobEnumToJob(t);return`https://souma.diemoe.net/resources/img/cj2/${b.jobToFullName(e).en}.png`}const i=O();p(()=>{for(const t of i.partyData)t.src=a(t.job)});const m=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(t,e)=>c(m)&&c(i).partyData.length>1?(s(),r("div",J,[(s(!0),r(o,null,n(c(i).partyDataFormatted,(t,e)=>{return s(),r("button",{key:e,class:l(["job-lists",c(i).focusTargetId===t.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:e=>c(i).handleClickChangeTarget(t.id)},[d("div",z,[d("img",{src:t.src,style:{height:"1.25em"},loading:"lazy",onerror:c(_)},null,8,H),u(" "+g((a=t.job,b.jobToFullName(b.jobEnumToJob(a)).simple2)),1)])],10,W);var a}),128))])):y("",!0)}}),[["__scopeId","data-v-ebc78197"]]),B={class:"common-layout"},G={key:0},X=C(a({__name:"castingMonitor",setup(e){const a=O(),o=$();return m(()=>{v("ChangePrimaryPlayer",a.handleChangePrimaryPlayer),v("LogLine",a.handleLogLine),v("PartyChanged",a.handlePartyChanged),v("BroadcastMessage",t=>{"castMonitorOverlay"===t.source&&(a.focusTargetId=t.msg.targetId)})}),setInterval(()=>{a.cleanUpExpired()},1e3),(e,n)=>{const i=q,l=k,p=F,m=x,b=A,j=L,T=t;return s(),h(T,null,{default:f(()=>[d("div",B,[I(b,{"items-center":""},{default:f(()=>[I(l,{class:"header-layout"},{default:f(()=>[I(i)]),_:1}),I(m,null,{default:f(()=>[I(p)]),_:1})]),_:1}),c(o)?(s(),r("footer",G,[I(j,{onClick:n[0]||(n[0]=t=>c(a).testParty(!0))},{default:f(()=>[u(g(e.$t("castingMonitor.testParty")),1)]),_:1}),I(j,{onClick:n[1]||(n[1]=t=>c(a).testParty(!1))},{default:f(()=>[u(g(e.$t("castingMonitor.testSolo")),1)]),_:1}),I(j,{onClick:n[2]||(n[2]=t=>c(a).testAction())},{default:f(()=>[u(g(e.$t("castingMonitor.testAction")),1)]),_:1})])):y("",!0)])]),_:1})}}}),[["__scopeId","data-v-d2d6a76c"]]);export{X as default};
