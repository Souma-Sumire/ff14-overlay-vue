import{_ as e,a as l}from"./shared-common-9tgN7nPx.js";import{d as a,G as t,c as s,n as o,a as n,s as i,z as r,t as u,e as c,b as d,j as v,f as p,x as m,b6 as y,w as f,h as g,g as h,y as k,F as b,r as w,bW as _,I as C,o as V,b8 as S,B as x,bR as E,p as B,v as $,c7 as T,cM as O,bQ as R}from"./vendor-vue-MSvGQJWD.js";import{I as D,J as M,K as z,L as U,N as P,O as L,P as j,Q as A,R as W,S as F,T as I,W as N,X as Y,Y as J,$ as H,a0 as K,a1 as q,a2 as X,a3 as G,a4 as Q,a5 as Z,a6 as ee,a7 as le}from"./shared-core-Do8QyWoI.js";import{b as ae,a5 as te,n as se,a6 as oe,a7 as ne,a8 as ie,a9 as re,J as ue,aa as ce,ab as de,ac as ve,D as pe,q as me,ad as ye,ae as fe,h as ge,af as he,ag as ke,X as be,I as we,ah as _e,g as Ce,f as Ve,k as Se,ai as xe,aj as Ee,C as Be,ak as $e,al as Te,am as Oe,M as Re,N as De,an as Me,ao as ze,ap as Ue,aq as Pe,E as Le,a as je,L as Ae,ar as We,K as Fe,as as Ie,d as Ne,at as Ye,au as Je,F as He,G as Ke,av as qe,y as Xe,l as Ge,aw as Qe,ax as Ze,ay as el,az as ll,aA as al,U as tl,S as sl,aB as ol,j as nl}from"./vendor-element-plus-CsMNiL2J.js";import{u as il,s as rl,i as ul,a as cl,b as dl,c as vl,d as pl,e as ml,f as yl,g as fl,h as gl,j as hl}from"./vendor-echarts-C8iHwFK-.js";import"./cactbot-DtpbXwrG.js";function kl(e){return new Worker("/ff14-overlay-vue/assets/logParser-WvXw0JKp.js",{name:e?.name})}const bl=a({__name:"RoleBadge",props:{role:{},large:{type:Boolean}},setup(e){const l=e,a=t(()=>D(l.role)),c=t(()=>l.role?M(l.role):"");return(l,t)=>e.role?(n(),s("span",{key:0,class:r(["role-badge",{"badge-large":e.large}]),style:i({backgroundColor:a.value})},u(c.value),7)):o("",!0)}}),wl=e(bl,[["__scopeId","data-v-7ea46d60"]]),_l=a({__name:"PlayerDisplay",props:{name:{},role:{},showOnlyRole:{type:Boolean},nameClass:{}},setup:e=>(l,a)=>(n(),s("div",{class:r(["player-display",{"is-large":e.showOnlyRole}])},[c(wl,{role:e.role,large:e.showOnlyRole,class:"role-icon"},null,8,["role","large"]),e.showOnlyRole&&e.role?o("",!0):(n(),s("span",{key:0,class:r(["player-name-text",e.nameClass])},u(e.name),3))],2))}),Cl=e(_l,[["__scopeId","data-v-a4b6322e"]]),Vl={class:"mr-content"},Sl={key:0,class:"mr-val"},xl=a({__name:"LootPlayerRoll",props:{roll:{},isWinner:{type:Boolean},showOnlyRole:{type:Boolean},getPlayerRole:{type:Function}},setup(e){const l=e,a=t(()=>l.getPlayerRole(l.roll.player)),i=t(()=>`type-${l.roll.type}`),v=t(()=>z(l.roll.type)),p=t(()=>"assign"!==l.roll.type&&"direct"!==l.roll.type),m=t(()=>"assign"===l.roll.type||"direct"===l.roll.type||"replace"===l.roll.type);return(l,t)=>(n(),s("div",{class:r(["mini-roll",[i.value,{"winner-badge":e.isWinner}]])},[c(Cl,{name:e.roll.player,role:a.value,"show-only-role":e.showOnlyRole,class:"mr-display"},null,8,["name","role","show-only-role"]),d("div",Vl,[d("span",{class:r(["mr-type",[i.value,{"type-full-width":m.value}]])},u(v.value),3),p.value&&"replace"!==e.roll.type?(n(),s("span",Sl,u(null!==e.roll.value?e.roll.value:"-"),1)):o("",!0)])],2))}}),El=e(xl,[["__scopeId","data-v-76f5e983"]]),Bl={class:"sort-segmented"},$l=a({__name:"LootSortSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function t(e){a("update:modelValue",e)}return(l,a)=>(n(),s("div",Bl,[d("div",{class:r(["segment-item",{"is-active":"part"===e.modelValue}]),onClick:a[0]||(a[0]=e=>t("part"))}," 按装备部位顺序 ",2),d("div",{class:r(["segment-item",{"is-active":"drop"===e.modelValue}]),onClick:a[1]||(a[1]=e=>t("drop"))}," 按零式掉落顺序 ",2)]))}}),Tl=e($l,[["__scopeId","data-v-87e751bc"]]),Ol={class:"chart-container"},Rl={class:"chart-body"},Dl=a({__name:"ChartPlayerDistribution",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});il([ul,cl,dl,vl,pl,ml]);const a=e,o=t(()=>{const e=a.playerVisibility,t=new Map;a.players.forEach(e=>t.set(e,0)),a.records.forEach(e=>{const l=a.getActualPlayer?a.getActualPlayer(e.player):e.player;t.has(l)&&t.set(l,(t.get(l)||0)+1)});const s=a.players.map(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;return{name:e,value:t.get(e)||0,role:l?M(l):""}}),o=s.map(e=>e.name),n=s.map(e=>e.value),i=new Map;return a.players.forEach(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;l&&i.set(e,l)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0],a=l.name,t=i.get(a);return`${t?`[${t}] `:""}${a}<br/>获取数量: <b>${l.value}</b>`}},grid:{left:"2%",right:"2%",bottom:"10%",top:"10%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=i.get(e);return P(e,l,a.playerVisibility)},rich:U(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",minInterval:1,splitLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"获取数量",type:"bar",barWidth:"50%",data:n,itemStyle:{color:e=>{const l=e.name,a=i.get(l);return D(a)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",color:l.value?"#f1f5f9":"#1e293b"}}]}});return(e,a)=>(n(),s("div",Ol,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"获取数量统计")],-1)),d("div",Rl,[c(p(rl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),Ml=e(Dl,[["__scopeId","data-v-234e7083"]]),zl={class:"chart-container"},Ul={class:"chart-body"},Pl=a({__name:"ChartRollLuck",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});il([ul,cl,yl,dl,vl,pl,ml,fl]);const a=e,o=t(()=>{const e=a.playerVisibility,t=new Map;a.players.forEach(e=>t.set(e,[])),a.records.forEach(e=>{e.rolls.forEach(e=>{if(("need"===e.type||"greed"===e.type)&&null!==e.value){const l=a.getActualPlayer?a.getActualPlayer(e.player):e.player;t.has(l)&&t.get(l).push(e.value)}})});const s=a.players.map(e=>{const l=t.get(e)||[],s=l.length,o=l.reduce((e,l)=>e+l,0),n=s>0?o/s:0,i=s>0?Math.max(...l):0,r=s>0?Math.min(...l):0,u=a.getPlayerRole?a.getPlayerRole(e):void 0;return{name:e,value:n,min:r,max:i,count:s,role:u||"",formattedRole:u?M(u):""}}),o=s.map(e=>e.name),n=s.map(e=>e.value),i=new Map,r=new Map;return s.forEach(e=>{i.set(e.name,e.formattedRole),r.set(e.name,e)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0].name,a=r.get(l);if(!a)return"";let t=`${a.formattedRole?`[${a.formattedRole}] `:""}<b>${l}</b><br/>`;return 0===a.count?t+='<span style="color:#999">无数据</span>':(t+=`平均点数: <b>${a.value.toFixed(1)}</b><br/>`,t+=`最高点数: ${a.max}<br/>`,t+=`最低点数: ${a.min}<br/>`,t+=`Roll点次数: ${a.count}`),t}},grid:{left:"2%",right:"2%",bottom:"10%",top:"15%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=r.get(e)?.role;return P(e,l,a.playerVisibility)},rich:U(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",min:0,max:100,name:"平均点数",splitLine:{lineStyle:{color:l.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"平均Roll点",type:"bar",barWidth:"50%",data:n,itemStyle:{color:e=>{const l=r.get(e.name);return D(l?.role)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",formatter:e=>e.value>0?e.value.toFixed(1):"",color:l.value?"#f1f5f9":"#1e293b"},markLine:{data:[{type:"average",name:"平均"}],symbol:"none",lineStyle:{color:l.value?"rgba(255,255,255,0.4)":"#999",type:"dashed"},label:{position:"start",formatter:"{b}",color:l.value?"#94a3b8":"#64748b",padding:[0,8,0,0]}}}]}});return(e,a)=>(n(),s("div",zl,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"Roll 点运气统计")],-1)),d("div",Ul,[c(p(rl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),Ll=e(Pl,[["__scopeId","data-v-6e28d682"]]),jl={class:"chart-container"},Al=a({__name:"ChartWeeklyTrend",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup(e){const l=v({storageKey:"loot-history-theme"});il([ul,gl,dl,vl,hl,ml]);const a=e,o=t(()=>a.syncStartDate?L(new Date(a.syncStartDate)):null);const r=m(400),u=t(()=>{const e=new Map,l=new Map;a.records.forEach(t=>{const{label:s,sortKey:n}=function(e){const l=a.recordWeekCorrections?.[e.key]||0,{label:t}=j(e.timestamp,l),{label:s,index:n}=A(t,o.value);return{label:a.syncStartDate?`第 ${n} 周`:t,fullLabel:s,sortKey:n}}(t);e.set(s,n);const i=a.getActualPlayer?a.getActualPlayer(t.player):t.player;if(!a.players.includes(i))return;l.has(s)||l.set(s,new Map);const r=l.get(s);r.has(i)||r.set(i,{count:0,items:[]});const u=r.get(i);u.count++,u.items.push(t.item)});const t=Array.from(e.entries()).sort((e,l)=>e[1]-l[1]).map(e=>e[0]),s=[...a.players],n=[];t.forEach((e,a)=>{s.forEach((t,s)=>{const o=l.get(e)?.get(t),i=o?o.count:0;n.push({value:[s,a,i],items:o?o.items:[]})})});const i=40*t.length+120,r=Math.max(300,i);return{xData:s,sortedWeeks:t,seriesData:n,height:r}});y(()=>{r.value=u.value.height});const f=t(()=>{const e=a.playerVisibility,{xData:t,sortedWeeks:s,seriesData:o}=u.value,n=new Map;return a.players.forEach(e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;l&&n.set(e,M(l))}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{position:"top",formatter:e=>{const l=e.data,a=l.value[2],o=t[l.value[0]],i=s[l.value[1]],r=o?n.get(o):void 0;return`<b>${i}</b><br/>\n                <b>${r?`[${r}]`:""} ${o}</b><br/>\n                获取数量: ${a}<br/>\n                <hr style="margin:4px 0;opacity:0.3"/>\n                ${l.items&&l.items.length>0?l.items.map(e=>`• ${e}`).join("<br/>"):'<span style="color:#94a3b8;font-style:italic">无掉落</span>'}`}},grid:{top:40,bottom:"2%",left:"2%",right:"2%"},xAxis:{position:"bottom",type:"category",data:t,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{interval:0,rotate:0,formatter:e=>{const l=a.getPlayerRole?a.getPlayerRole(e):void 0;return P(e,l,a.playerVisibility)},rich:U(a.playerVisibility),color:l.value?"#e2e8f0":"#64748b"}},yAxis:{type:"category",data:s,inverse:!1,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:12,color:l.value?"#e2e8f0":"#64748b"}},visualMap:{min:0,max:8,calculable:!1,orient:"horizontal",right:0,top:0,itemWidth:15,itemHeight:15,type:"piecewise",pieces:[{value:0,color:l.value?"#1b1c26":"#f8fafc",label:"无"},{value:1,color:l.value?"#450a0a":"#fff7ed",label:"1"},{value:2,color:l.value?"#7f1d1d":"#ffedd5",label:"2"},{value:3,color:l.value?"#b91c1c":"#fed7aa",label:"3"},{value:4,color:l.value?"#c2410c":"#fdba74",label:"4"},{value:5,color:l.value?"#ea580c":"#f97316",label:"5"},{value:6,color:l.value?"#f97316":"#ea580c",label:"6"},{value:7,color:l.value?"#facc15":"#c2410c",label:"7"},{min:8,color:l.value?"#fef08a":"#9a3412",label:"8+"}],textStyle:{color:l.value?"#94a3b8":"#64748b"}},series:[{name:"每周获取",type:"heatmap",data:o,label:{show:!0,formatter:e=>e.value[2]>0?e.value[2]:"",color:"inherit"},itemStyle:{borderRadius:4,borderColor:l.value?"#252632":"#fff",borderWidth:2},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.4)"}}}]}});return(e,a)=>(n(),s("div",jl,[a[0]||(a[0]=d("div",{class:"chart-header"},[d("div",{class:"chart-title"},"每周获取热力图")],-1)),d("div",{class:"chart-body",style:i({height:r.value+"px"})},[c(p(rl),{class:"echarts-instance",option:f.value,"update-options":{notMerge:!0},theme:p(l)?"dark":"",autoresize:""},null,8,["option","theme"])],4)]))}}),Wl=e(Al,[["__scopeId","data-v-eb6bf288"]]),Fl={class:"stats-panel"},Il={class:"charts-grid"},Nl=a({__name:"LootStatisticsPanel",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup:e=>(l,a)=>(n(),s("div",Fl,[d("div",Il,[c(Ml,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(Ll,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),c(Wl,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"record-week-corrections":e.recordWeekCorrections,"sync-start-date":e.syncStartDate,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","record-week-corrections","sync-start-date","player-visibility"])])]))}),Yl=e(Nl,[["__scopeId","data-v-82f4fe50"]]),Jl={class:"filter-segmented"},Hl=a({__name:"LootDisplayFilterSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function t(e){a("update:modelValue",e)}return(l,a)=>(n(),s("div",Jl,[d("div",{class:r(["segment-item",{"is-active":"obtained"===e.modelValue}]),onClick:a[0]||(a[0]=e=>t("obtained"))}," 已获得 ",2),d("div",{class:r(["segment-item",{"is-active":"needed"===e.modelValue}]),onClick:a[1]||(a[1]=e=>t("needed"))}," 尚未获得 ",2),d("div",{class:r(["segment-item",{"is-active":"all"===e.modelValue}]),onClick:a[2]||(a[2]=e=>t("all"))}," 全部显示 ",2)]))}}),Kl=e(Hl,[["__scopeId","data-v-f07e22be"]]),ql={class:"bis-allocator"},Xl={class:"bis-toolbar"},Gl={key:0,class:"dot-warn"},Ql={key:0,class:"bis-view-panel"},Zl={class:"table-container"},ea={class:"bis-table"},la={class:"premium-header-player"},aa=["onClick"],ta={key:0},sa=["rowspan"],oa={class:"sticky-col col-item row-header"},na={class:"equip-cell-content"},ia={class:"tooltip-title"},ra={class:"tooltip-player-list"},ua=["onClick"],ca={class:"player-option-item"},da={key:0,class:"tooltip-divider"},va=["onClick"],pa={class:"cell-status-container"},ma={class:"status-main"},ya={key:0,class:"status-meta"},fa={key:1,class:"bis-onboarding"},ga={class:"onboarding-card"},ha={class:"icon-circle"},ka={class:"bis-config-panel-container"},ba={class:"bis-config-header-row"},wa={class:"bis-storage-info"},_a={class:"planned-weeks-config"},Ca={key:0,class:"validation-alerts"},Va={class:"alert-msg"},Sa={class:"table-scroll-wrapper"},xa={class:"bis-table config-table"},Ea={class:"vert-header"},Ba={class:"header-action-area"},$a={key:0,class:"incomplete-label"},Ta={class:"preset-apply-zone"},Oa=["title"],Ra={key:2},Da={class:"preset-item-content"},Ma={class:"preset-item-content"},za=["onClick"],Ua={class:"expand-action"},Pa={class:"preset-item-content"},La={class:"sticky-col row-header"},ja={key:0,class:"split-cell"},Aa=["onClick"],Wa=["onClick"],Fa={key:1,class:"count-cell"},Ia={class:"count-wrapper"},Na={class:"dialog-footer"},Ya={class:"footer-left"},Ja={class:"footer-right"},Ha={class:"config-status-msg"},Ka={key:0},qa={key:0,class:"import-empty-msg"},Xa={key:1,class:"import-diff-container"},Ga={class:"import-summary"},Qa={class:"diff-header"},Za={key:0,class:"diff-tag"},et={key:1,class:"diff-tag update"},lt={class:"diff-items"},at={class:"diff-label"},tt={class:"diff-values"},st={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},ot={key:0,class:"import-diff-container"},nt={class:"import-summary"},it={class:"diff-card"},rt={class:"diff-header"},ut={key:0,class:"diff-tag"},ct={key:1,class:"diff-tag update"},dt={class:"diff-items"},vt={class:"diff-label"},pt={class:"diff-values"},mt={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},yt=a({__name:"BisAllocator",props:{players:{},records:{},modelValue:{},getPlayerRole:{type:Function},getActualPlayer:{type:Function},showOnlyRole:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:l}){const a=m({});function i(e){const l=[];return e.forEach(e=>{const a=[],t=[];if(x.value[e.id]){const a=x.value[e.id];let t=y.getPlayerRole?.(a)||a;return t=t.replace(/^LEFT:/,"").trim(),void l.push(`/p ${e.name}：${t} (队长分配)`)}Ee.value.forEach(l=>{if(S.value.has(l))return;let s=y.getPlayerRole?.(l)||l;s=s.replace(/^LEFT:/,"").trim();const o=Q(l,e);"need"===o?a.push(s):"greed"===o&&t.push(s)});let s="";s=a.length>0?a.join("、"):t.length>0?t.join("、"):"随便ROLL",l.push(`/p ${e.name}：${s}`)}),l}function v(e){const l=new Date,a=y.records&&0!==y.records.length?K(y.records.map(e=>e.timestamp)):1,t=`${l.getMonth()+1}月${l.getDate()}日`;let s="",o="";if("all"===e){const e=[`/p <第${a}周分配优先级> ${t}`];le.value.forEach(l=>{e.push(...i(l.rows))}),s=e.join("\n"),o="已复制全层宏 (共"+e.length+"行)"}else{const l=[`/p <第${a}周${e.name}分配优先级> ${t}`];l.push(...i(e.rows)),s=l.join("\n"),o=`已复制 ${e.name} 分配宏`}s&&navigator.clipboard.writeText(s).then(()=>{Ce.success(o)}).catch(()=>{Ce.error("复制失败")})}const y=e,C=l,V=m(!1),S=m(new Set),x=m({});function E(e){return Object.values(x.value).includes(e)}const B=m({playerBis:{},plannedWeeks:8});function $(e){if(!y.getPlayerRole)return e;const l=y.getPlayerRole(e);return!l||l.startsWith("LEFT:")||l.startsWith("SUB:")?e:l}function T(){let e=N.filter(e=>!!B.value.playerBis[e]).map(e=>{const l=F.map(l=>{const a=B.value.playerBis[e]?.[l.id];return"toggle"===l.type?"raid"===a?"1":"0":"number"==typeof a&&a>0?"1":"0"}).join(""),a=parseInt(l,2).toString(36);return`${e}:${a}`}).join(";");navigator.clipboard.writeText(e).then(()=>{Ce.success("BIS 设置已复制到剪贴板")})}function O(){Ve.prompt("请粘贴 BIS 设置字符串","导入 BIS 设置",{confirmButtonText:"下一步",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"在此粘贴...",customClass:"bis-import-message-box",inputValidator:e=>{if(!e)return"内容不能为空";const l=e.trim().split(";").filter(e=>e.trim());if(0===l.length)return"格式错误：无法识别有效的分隔符";let a=0;for(const t of l){if(t.startsWith("weeks:"))continue;const e=t.split(":");if(2!==e.length)return`数据格式错误："${t.slice(0,10)}..."`;const[l,s]=e;if(!s||!/^[0-9a-z]+$/i.test(s))return`数据校验失败：职位 "${l||"未知"}" 的设置已损坏`;N.includes(l)&&a++}return 0!==a||"未找到匹配当前团队的有效设置数据"}}).then(({value:e})=>{e&&function(e){try{const l=e.trim();if(!l)throw new Error("输入内容为空");const a=l.split(";").filter(e=>e.trim());if(0===a.length)throw new Error("无效的格式");const t=[];if(j.value=void 0,a.forEach(e=>{if(e.startsWith("weeks:")){const l=parseInt(e.split(":")[1]||"0");return void(isNaN(l)||(j.value=l))}const l=e.split(":");if(2!==l.length)return;const a=l[0],s=l[1];if(!a||!s||!N.includes(a))return;const o=Ee.value.filter(e=>y.getPlayerRole?.(e)===a)[0]||a,n=parseInt(s,36).toString(2).padStart(F.length,"0"),i={};F.forEach((e,l)=>{const a=n[l];"toggle"===e.type?i[e.id]="1"===a?"raid":"tome":i[e.id]="1"===a?1:0});const r=B.value.playerBis[a]||{},u=[];let c=!1;F.forEach(e=>{const l=r[e.id],a=i[e.id],t=U(e,l),s=U(e,a);t!==s&&(c=!0,u.push({label:e.name,oldVal:t,newVal:s}))}),c&&t.push({name:o,role:a,isNew:0===Object.keys(r).length,changes:u,newConfig:i})}),0===t.length)return void Ce.info("未检测到有效的设置变更。");M.value=t,R.value=!0}catch(l){Ce.error(l.message||"解析失败")}}(e)}).catch(()=>{})}const R=m(!1),D=m(!1),M=m([]),z=m(null);function U(e,l){return"toggle"===e.type?"raid"===l?"零式":"tome"===l?"点数":"未设置":(l||1).toString()}function P(e){return"零式"===e?"is-raid":"点数"===e?"is-tome":""}function L(){!function(){const e={...B.value.playerBis};M.value.forEach(l=>{e[l.role]={...e[l.role],...l.newConfig}}),B.value.playerBis=e,void 0!==j.value&&(B.value.plannedWeeks=j.value);R.value=!1,Ce.success(`成功更新 ${M.value.length} 个职位的配置`)}()}const j=m(void 0);function A(e,l,a){const t=$(e);B.value.playerBis[t]||(B.value.playerBis[t]={});B.value.playerBis[t][l]===a?delete B.value.playerBis[t][l]:B.value.playerBis[t][l]=a}function q(){if(!z.value?.diff)return;const{player:e,preset:l,diff:a}=z.value,t=$(e);B.value.playerBis[t]||(B.value.playerBis[t]={}),Object.assign(B.value.playerBis[t],a.newConfig),D.value=!1,z.value=null,Ce.success(`已应用预设: ${l.name} (${e})`)}function X(e,l){if(!y.records)return 0;const a=l.keywords.replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);return 0===a.length?0:y.records.filter(l=>(y.getActualPlayer?y.getActualPlayer(l.player):l.player)===e&&a.some(e=>l.item.includes(e))).length}function G(e,l){return X(e,l)>0}function Q(e,l){const a=x.value[l.id];if(a)return a===e?"assigned":"pass";if("count"===l.type){const a=Ue(e,l.id);return 0===a?"greed":X(e,l)>=a?"pass":"need"}return G(e,l)?"pass":"raid"===Me(e,l.id)?"need":"greed"}function Z(e,l){if("count"===l.type){const a=Ue(e,l.id);return 0===a?"greed":X(e,l)>=a?"pass":"need"}return G(e,l)?"pass":"raid"===Me(e,l.id)?"need":"greed"}function ee(e,l){const a=Q(e,l);return De[a]?.text||""}const le=t(()=>W.map(e=>{const l=e.items.map(e=>F.find(l=>l.id===e)).filter(e=>!!e);return{name:e.name,rows:l}})),Se=t(()=>{const e=I;return[...F].sort((l,a)=>{const t=e.indexOf(l.keywords),s=e.indexOf(a.keywords);return-1===t&&-1===s?0:-1===t?1:-1===s?-1:t-s})});function xe(e){if(!y.getPlayerRole)return!1;const l=y.getPlayerRole(e);return!!l&&(!l.startsWith("LEFT:")&&!l.startsWith("SUB:"))}const Ee=t(()=>y.players.filter(xe)),Be=m(new Set);function $e(e){const l=y.getPlayerRole?.(e);if(!l)return null;const a=$(e),t=B.value.playerBis[a];if(!t||0===Object.keys(t).length)return null;const{recommended:s,others:o}=H(l),n=[...s,...o];for(const i of n){let e=!0;for(const l of Object.keys(i.config))if(t[l]!==i.config[l]){e=!1;break}if(e)return i.name}return null}function Te(e){const l=y.getPlayerRole?.(e),a=H(l);return a.recommended.length>0||a.others.length>0}const Oe=t(()=>{for(const e of N)if(!Y(B.value,e))return!1;return!0});f(()=>y.modelValue,e=>{if(e)if(function(e){if(!e||"object"!=typeof e||!e.playerBis)return!1;const l=Object.keys(e.playerBis)[0];return!!l&&Array.isArray(e.playerBis[l])}(e)){const l={playerBis:{}},a=JSON.parse(JSON.stringify(e));Object.keys(a.playerBis).forEach(e=>{l.playerBis[e]={};const t=a.playerBis[e];t&&t.forEach(a=>{l.playerBis[e]&&(l.playerBis[e][a]="raid")})}),B.value=l}else{const l=e;JSON.stringify(l)!==JSON.stringify(B.value)&&(B.value={...l,plannedWeeks:l.plannedWeeks??8})}},{immediate:!0,deep:!0});const Re=t(()=>N.filter(e=>!Y(B.value,e)).length);f(B,e=>{JSON.stringify(e)!==JSON.stringify(y.modelValue)&&C("update:modelValue",e)},{deep:!0});const De={pass:{text:"放弃",class:"status-pass"},need:{text:"需求",class:"status-need"},greed:{text:"贪婪",class:"status-greed-tome"},assigned:{text:"分配",class:"status-assigned"}};function Me(e,l){return B.value.playerBis[$(e)]?.[l]}function ze(e,l){return"tome"===Me(e,l)}function Ue(e,l){const a=Me(e,l);return"number"==typeof a?a:["tome","solvent"].includes(l)?0:1}function Pe(e,l){const a=Q(e,l),t=De[a]?.class||"";return S.value.has(e)?`${t} is-excluded`:t}const Le=J,je=t(()=>{const e=[],l=B.value.plannedWeeks||8;return[{id:"coating",name:"硬化药"},{id:"twine",name:"强化纤维"},{id:"tome",name:"神典石"},{id:"solvent",name:"强化药"}].forEach(a=>{let t=0;Ee.value.forEach(e=>{t+=Ue(e,a.id)}),t>l&&e.push({id:a.id,type:"warning",message:`${a.name}: 总需求(${t}) 大于 计划周数(${l})，这是不可能的分配。`})}),e});return(l,t)=>{const i=ae,m=se,f=ie,C=re,j=oe,W=ue,I=me,N=ge,J=be,K=we;return n(),s("div",ql,[d("div",Xl,[c(m,{size:"small",type:"primary",plain:"",onClick:t[0]||(t[0]=e=>V.value=!0),class:"setup-trigger-btn"},{default:h(()=>[c(i,{style:{"margin-right":"4px"}},{default:h(()=>[c(p(te))]),_:1}),t[9]||(t[9]=d("span",null,"设置 BIS",-1)),Oe.value?o("",!0):(n(),s("span",Gl))]),_:1}),Oe.value?(n(),g(j,{key:0,trigger:"click",onCommand:v},{dropdown:h(()=>[c(C,null,{default:h(()=>[c(f,{command:"all"},{default:h(()=>[...t[11]||(t[11]=[k(" 全层 ",-1)])]),_:1}),(n(!0),s(b,null,w(le.value,e=>(n(),g(f,{key:e.name,command:e,divided:""},{default:h(()=>[k(u(e.name),1)]),_:2},1032,["command"]))),128))]),_:1})]),default:h(()=>[c(m,{size:"small"},{default:h(()=>[t[10]||(t[10]=k(" 复制分配宏",-1)),c(i,{class:"el-icon--right"},{default:h(()=>[c(p(ne))]),_:1})]),_:1})]),_:1})):o("",!0),Oe.value?(n(),g(W,{key:1,placement:"top",title:"分配宏生成规则",width:320,trigger:"hover"},{reference:h(()=>[c(i,{class:"macro-help-icon"},{default:h(()=>[c(p(ce))]),_:1})]),default:h(()=>[t[12]||(t[12]=d("div",{class:"macro-help-content"},[d("div",{class:"intro"},"生成可以直接在游戏内发送的分配宏（/p）。"),d("div",{class:"rule-item"},[d("strong",null,"1. 优先需求"),d("span",null,"仅显示BIS设为“零式”且尚未获得的玩家。")]),d("div",{class:"rule-item"},[d("strong",null,"2. 次选贪婪"),d("span",null,"若无需求者，显示其余尚未获得的玩家。")]),d("div",{class:"rule-item"},[d("strong",null,"3. 兜底机制"),d("span",null,"若全员不需要，显示“随便ROLL”。")])],-1))]),_:1})):o("",!0)]),Oe.value?(n(),s("div",Ql,[d("div",Zl,[d("table",ea,[d("thead",null,[d("tr",null,[t[14]||(t[14]=d("th",{class:"sticky-col col-layer",style:{"z-index":"30"}},null,-1)),t[15]||(t[15]=d("th",{class:"sticky-col col-item",style:{"z-index":"30"}}," 装备 \\ 玩家 ",-1)),(n(!0),s(b,null,w(Ee.value,l=>(n(),s("th",{key:l,class:r({"is-excluded":S.value.has(l)})},[d("div",la,[c(Cl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),d("div",{class:r(["leave-tag-trigger",{"is-away":S.value.has(l),"is-disabled":E(l)}]),onClick:_(e=>{return E(l)?null:(a=l,void(S.value.has(a)?S.value.delete(a):S.value.add(a)));var a},["stop"])},[S.value.has(l)?(n(),s("span",ta,"已请假")):(n(),s(b,{key:1},[c(i,{style:{"margin-right":"2px"}},{default:h(()=>[c(p(de))]),_:1}),t[13]||(t[13]=d("span",null,"请假",-1))],64))],10,aa)])],2))),128))])]),d("tbody",null,[(n(!0),s(b,null,w(le.value,l=>(n(),s(b,{key:l.name},[(n(!0),s(b,null,w(l.rows,(v,m)=>(n(),s("tr",{key:v.id,class:r({"is-layer-end":m===l.rows.length-1})},[0===m?(n(),s("td",{key:0,rowspan:l.rows.length,class:"sticky-col col-layer layer-cell"},u(l.name),9,sa)):o("",!0),d("td",oa,[d("div",na,[d("span",null,u(v.name),1),c(I,{visible:a.value[v.id],"onUpdate:visible":e=>a.value[v.id]=e,placement:"right",trigger:"click","popper-class":"captain-player-tooltip-new",effect:"dark",offset:15,"hide-after":0},{content:h(()=>[d("div",ia,[t[16]||(t[16]=k(" 将 ",-1)),d("span",null,u(v.name),1),t[17]||(t[17]=k(" 分配给 ",-1))]),d("div",ra,[(n(!0),s(b,null,w(Ee.value,l=>(n(),s("div",{key:l,class:r(["tooltip-player-item",{"is-disabled":S.value.has(l),"is-active":x.value[v.id]===l}]),onClick:e=>!S.value.has(l)&&(x.value[v.id]=l)},[d("div",ca,[c(Cl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),d("span",{class:r(["mini-status-tag",Z(l,v)])},u(De[Z(l,v)].text),3)])],10,ua))),128)),x.value[v.id]?(n(),s("div",da)):o("",!0),x.value[v.id]?(n(),s("div",{key:1,class:"tooltip-player-item clear-btn",onClick:e=>x.value[v.id]=""},[c(i,null,{default:h(()=>[c(p(pe))]),_:1}),t[18]||(t[18]=d("span",null,"取消分配",-1))],8,va)):o("",!0)])]),default:h(()=>[d("div",{class:r(["assign-tag-trigger",{"is-active":x.value[v.id],"is-open":a.value[v.id]}])},[x.value[v.id]?(n(),s(b,{key:0},[c(Cl,{name:x.value[v.id],role:y.getPlayerRole?.(x.value[v.id]),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),t[19]||(t[19]=d("span",{class:"p-status"},"已分配",-1))],64)):(n(),s(b,{key:1},[c(i,{style:{"margin-right":"2px"}},{default:h(()=>[c(p(ve))]),_:1}),t[20]||(t[20]=d("span",null,"分配",-1))],64))],2)]),_:2},1032,["visible","onUpdate:visible"])])]),(n(!0),s(b,null,w(Ee.value,e=>(n(),s("td",{key:e,class:r(Pe(e,v))},[d("div",pa,[d("span",ma,u(ee(e,v)),1),"count"===v.type&&Ue(e,v.id)>1?(n(),s("span",ya," ("+u(X(e,v))+"/"+u(Ue(e,v.id))+") ",1)):o("",!0)])],2))),128))],2))),128))],64))),128))])])])])):(n(),s("div",fa,[d("div",ga,[d("div",ha,[c(i,null,{default:h(()=>[c(p(ye))]),_:1})]),t[22]||(t[22]=d("h3",null,"开启 BIS 分配",-1)),t[23]||(t[23]=d("p",null,"尚未设置团队成员的 BIS，无法生成分配推荐。",-1)),c(m,{type:"primary",size:"large",onClick:t[1]||(t[1]=e=>V.value=!0)},{default:h(()=>[...t[21]||(t[21]=[k(" 立即开始设置 ",-1)])]),_:1})])])),c(K,{modelValue:V.value,"onUpdate:modelValue":t[4]||(t[4]=e=>V.value=e),width:"auto","append-to-body":"",class:"bis-config-dialog","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",Na,[d("div",Ya,[c(J,null,{default:h(()=>[c(m,{size:"small",onClick:T},{default:h(()=>[...t[30]||(t[30]=[k("导出 BIS 设置",-1)])]),_:1}),c(m,{size:"small",onClick:O},{default:h(()=>[...t[31]||(t[31]=[k("导入 BIS 设置",-1)])]),_:1})]),_:1})]),d("div",Ja,[d("div",Ha,[Re.value>0?(n(),s("span",Ka," 还剩 "+u(Re.value)+" 个职位的 BIS 尚未填完 ",1)):o("",!0)]),c(m,{type:"primary",size:"small",onClick:t[3]||(t[3]=e=>V.value=!1)},{default:h(()=>[...t[32]||(t[32]=[k(" 完成并关闭 ",-1)])]),_:1})])])]),default:h(()=>[d("div",ka,[d("div",ba,[d("div",wa,[c(i,null,{default:h(()=>[c(p(fe))]),_:1}),t[24]||(t[24]=d("span",null,"提示：此 BIS 设置跟随职位（MT/ST等），不跟随具体玩家。",-1))]),d("div",_a,[t[25]||(t[25]=d("span",{class:"label"},"你们计划清几周CD：",-1)),c(N,{modelValue:B.value.plannedWeeks,"onUpdate:modelValue":t[2]||(t[2]=e=>B.value.plannedWeeks=e),min:1,max:16,size:"small","controls-position":"right",class:"weeks-stepper"},null,8,["modelValue"])])]),je.value.length>0?(n(),s("div",Ca,[(n(!0),s(b,null,w(je.value,e=>(n(),s("div",{key:e.id,class:r(["validation-alert",e.type])},[c(i,{class:"alert-icon"},{default:h(()=>["info"===e.type?(n(),g(p(fe),{key:0})):(n(),g(p(he),{key:1}))]),_:2},1024),d("span",Va,u(e.message),1)],2))),128))])):o("",!0),d("div",Sa,[d("table",xa,[d("thead",null,[d("tr",null,[t[29]||(t[29]=d("th",{class:"sticky-col"},"装备 \\ 玩家",-1)),(n(!0),s(b,null,w(Ee.value,l=>(n(),s("th",{key:l,class:r([{"header-incomplete":!p(Y)(B.value,$(l))},{"is-excluded":S.value.has(l)},p(Le)(e.getPlayerRole?.(l))])},[d("div",Ea,[c(Cl,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),d("div",Ba,[p(Y)(B.value,$(l))?o("",!0):(n(),s("span",$a,"未填写")),d("div",Ta,[Te(l)?(n(),g(j,{key:0,trigger:"click",onCommand:e=>function(e,l){const a=$(e),t=B.value.playerBis[a]||{},s={...l.config},o=[];if(F.forEach(e=>{const l=t[e.id],a=s[e.id],n=U(e,l),i=U(e,a);n!==i&&o.push({label:e.name,oldVal:n,newVal:i})}),0===o.length)return void Ce.info("当前设置与预设相同，无需更改");const n={name:e,role:y.getPlayerRole?.(e)||"Unknown",isNew:0===Object.keys(t).length,changes:o,newConfig:s};z.value={player:e,preset:l,diff:n},D.value=!0}(l,e),onVisibleChange:e=>!e&&Be.value.delete(l),"popper-class":"bis-preset-popper"},{dropdown:h(()=>[c(C,{class:"bis-preset-dropdown"},{default:h(()=>[(n(!0),s(b,null,w(p(H)(e.getPlayerRole?.(l)).recommended,e=>(n(),g(f,{key:e.name,command:e},{default:h(()=>[d("div",Da,[c(i,null,{default:h(()=>[c(p(ke))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command"]))),128)),0===p(H)(e.getPlayerRole?.(l)).recommended.length?(n(!0),s(b,{key:0},w(p(H)(e.getPlayerRole?.(l)).others,e=>(n(),g(f,{key:e.name,command:e},{default:h(()=>[d("div",Ma,[c(i,null,{default:h(()=>[c(p(ke))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command"]))),128)):p(H)(e.getPlayerRole?.(l)).others.length>0?(n(),s(b,{key:1},[Be.value.has(l)?(n(!0),s(b,{key:1},w(p(H)(e.getPlayerRole?.(l)).others,(e,l)=>(n(),g(f,{key:e.name,command:e,divided:0===l},{default:h(()=>[d("div",Pa,[c(i,null,{default:h(()=>[c(p(ke))]),_:1}),d("span",null,u(e.name),1)])]),_:2},1032,["command","divided"]))),128)):(n(),s("div",{key:0,class:"preset-expand-divider",onClick:_(e=>Be.value.add(l),["stop"])},[t[27]||(t[27]=d("div",{class:"divider-line"},null,-1)),d("div",Ua,[t[26]||(t[26]=d("span",null,"更多同职能预设",-1)),c(i,null,{default:h(()=>[c(p(ne))]),_:1})]),t[28]||(t[28]=d("div",{class:"divider-line"},null,-1))],8,za))],64)):o("",!0)]),_:2},1024)]),default:h(()=>[c(m,{size:"small",class:r(["preset-btn",{"is-matched":$e(l)}])},{default:h(()=>[$e(l)?o("",!0):(n(),g(i,{key:0,class:"magic-icon"},{default:h(()=>[c(p(ke))]),_:1})),$e(l)?(n(),s("span",{key:1,class:"matched-name-inline",title:$e(l)??""},u($e(l)),9,Oa)):(n(),s("span",Ra,"一键预设"))]),_:2},1032,["class"])]),_:2},1032,["onCommand","onVisibleChange"])):o("",!0)])])])],2))),128))])]),d("tbody",null,[(n(!0),s(b,null,w(Se.value,e=>(n(),s("tr",{key:e.id},[d("td",La,u(e.name),1),(n(!0),s(b,null,w(Ee.value,l=>{return n(),s("td",{key:l,class:"split-cell-container"},["toggle"===e.type?(n(),s("div",ja,[d("div",{class:r(["half-cell left-raid",{active:(a=l,t=e.id,"raid"===Me(a,t))}]),onClick:a=>A(l,e.id,"raid")}," 零式 ",10,Aa),d("div",{class:r(["half-cell right-tome",{active:ze(l,e.id)}]),onClick:a=>A(l,e.id,"tome")}," 点数 ",10,Wa)])):(n(),s("div",Fa,[d("div",Ia,[c(N,{"model-value":Ue(l,e.id),min:0,max:8,size:"small","controls-position":"right","onUpdate:modelValue":a=>function(e,l,a){const t=$(e);B.value.playerBis[t]||(B.value.playerBis[t]={}),B.value.playerBis[t][l]=a}(l,e.id,a||0),class:"mini-stepper"},null,8,["model-value","onUpdate:modelValue"])])]))]);var a,t}),128))]))),128))])])])])]),_:1},8,["modelValue"]),c(K,{modelValue:R.value,"onUpdate:modelValue":t[6]||(t[6]=e=>R.value=e),title:"确认导入 BIS 设置",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",st,[c(m,{onClick:t[5]||(t[5]=e=>R.value=!1)},{default:h(()=>[...t[33]||(t[33]=[k("取消",-1)])]),_:1}),c(m,{type:"primary",onClick:L,disabled:0===M.value.length},{default:h(()=>[...t[34]||(t[34]=[k(" 确认应用 ",-1)])]),_:1},8,["disabled"])])]),default:h(()=>[0===M.value.length?(n(),s("div",qa," 没有检测到有效的变更数据。 ")):(n(),s("div",Xa,[d("p",Ga," 检测到 "+u(M.value.length)+" 位玩家的设置变更。 ",1),(n(!0),s(b,null,w(M.value,l=>(n(),s("div",{key:l.name,class:"diff-card"},[d("div",Qa,[c(Cl,{name:l.name,role:l.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),l.isNew?(n(),s("span",Za,"新设置")):(n(),s("span",et,"更新"))]),d("div",lt,[(n(!0),s(b,null,w(l.changes,(e,l)=>(n(),s("div",{key:l,class:"diff-row"},[d("span",at,u(e.label),1),d("div",tt,[d("span",{class:r(["val old",P(e.oldVal)])},u(e.oldVal),3),c(i,null,{default:h(()=>[c(p(_e))]),_:1}),d("span",{class:r(["val new",P(e.newVal)])},u(e.newVal),3)])]))),128))])]))),128))]))]),_:1},8,["modelValue"]),c(K,{modelValue:D.value,"onUpdate:modelValue":t[8]||(t[8]=e=>D.value=e),title:"确认预设变更",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:h(()=>[d("div",mt,[c(m,{onClick:t[7]||(t[7]=e=>D.value=!1)},{default:h(()=>[...t[35]||(t[35]=[k("取消",-1)])]),_:1}),c(m,{type:"primary",onClick:q},{default:h(()=>[...t[36]||(t[36]=[k(" 确认应用 ",-1)])]),_:1})])]),default:h(()=>[z.value?.diff?(n(),s("div",ot,[d("p",nt," 应用 ["+u(z.value.preset.name)+"] 将会产生以下变更： ",1),d("div",it,[d("div",rt,[c(Cl,{name:z.value.diff.name,role:z.value.diff.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),z.value.diff.isNew?(n(),s("span",ut,"新设置")):(n(),s("span",ct,"更新"))]),d("div",dt,[(n(!0),s(b,null,w(z.value.diff.changes,(e,l)=>(n(),s("div",{key:l,class:"diff-row"},[d("span",vt,u(e.label),1),d("div",pt,[d("span",{class:r(["val old",P(e.oldVal)])},u(e.oldVal),3),c(i,null,{default:h(()=>[c(p(_e))]),_:1}),d("span",{class:r(["val new",P(e.newVal)])},u(e.newVal),3)])]))),128))])])])):o("",!0)]),_:1},8,["modelValue"])])}}}),ft=e(yt,[["__scopeId","data-v-163e2af0"]]),gt={class:"summary-item-right"},ht={key:0,class:"random-weapon-tag"},kt={key:0,class:"bis-tag"},bt={key:1,class:"non-bis-tag"},wt={key:2,class:"layer-tag"},_t=e(a({__name:"SummaryItemTags",props:{item:{}},setup:e=>(l,a)=>(n(),s("div",gt,[e.item.isRandomWeapon?(n(),s("span",ht,"随武")):(n(),s(b,{key:1},[e.item.isBis?(n(),s("span",kt,"毕业")):!1===e.item.isBis?(n(),s("span",bt,"副职")):o("",!0)],64)),e.item.layerName?(n(),s("span",wt,u(e.item.layerName),1)):o("",!0),d("span",{class:r(["count-badge",e.item.count>1?"count-many":0===e.item.count?"count-none":"count-single"])}," x"+u(e.item.count),3)]))}),[["__scopeId","data-v-10461ea9"]]),Ct={key:0,class:"initial-loading"},Vt={class:"skeleton-layout"},St={class:"skeleton-page-main"},xt={class:"skeleton-content-grid"},Et={class:"theme-toggle-fixed"},Bt={key:0,class:"loading-overlay"},$t={class:"loading-card-wide"},Tt={class:"loading-header"},Ot={class:"loading-title"},Rt={class:"parsing-lists"},Dt={class:"list-col"},Mt={class:"list-head"},zt={class:"list-body"},Ut={class:"file-info-left"},Pt=["title"],Lt={class:"file-size"},jt={class:"list-col"},At={class:"list-head"},Wt={class:"list-body"},Ft={class:"file-info-left"},It=["title"],Nt={class:"file-size"},Yt={key:0,class:"more-hint"},Jt={key:0,class:"app-main",style:{"padding-top":"10px"}},Ht={class:"control-bar",style:{position:"relative"}},Kt={class:"path-toolbar"},qt={key:0,class:"dot-warn"},Xt={class:"sync-status-container"},Gt={class:"sync-hint-text is-success success-hint"},Qt={class:"guide-content-popover"},Zt={class:"guide-section"},es={class:"guide-section"},ls={class:"guide-section"},as={class:"guide-section"},ts={class:"filter-panel"},ss={class:"filter-section"},os={class:"sec-header"},ns={class:"sec-title-group"},is={class:"title-main"},rs={key:0,class:"dot-warn"},us={class:"role-settings-content-popover"},cs={class:"role-grid"},ds={class:"role-setup-label"},vs={class:"special-role-section"},ps={class:"special-role-group"},ms={class:"special-list"},ys={key:0,class:"special-item"},fs={class:"special-role-group"},gs={class:"special-list"},hs={key:0,class:"special-item"},ks={class:"switch-box"},bs={class:"switch-container",style:{display:"inline-flex","align-items":"center",gap:"6px"}},ws={key:0,class:"header-sep"},_s={key:1,class:"switch-box"},Cs={class:"acts"},Vs={class:"popover-form"},Ss={class:"merge-selector-box"},xs={class:"merge-guide-desc"},Es={class:"procedure-steps-compact"},Bs={class:"selector-tags"},$s={key:0,class:"selection-badge hide"},Ts={key:1,class:"selection-badge show"},Os={key:0,class:"merge-actions"},Rs={key:0,class:"suggestion-box"},Ds={class:"suggest-items"},Ms={class:"conf-text"},zs={key:1,class:"mapping-box"},Us={class:"mapping-list"},Ps={class:"map-from"},Ls={class:"map-to"},js={class:"sec-body",style:{position:"relative"}},As={key:0,class:"section-mask"},Ws={class:"filter-section"},Fs={class:"sec-header"},Is={class:"sec-title-group"},Ns={class:"title-main"},Ys={class:"switch-box"},Js={class:"filter-popover"},Hs={class:"sec-body",style:{position:"relative"}},Ks={key:0,class:"section-mask"},qs={class:"main-viewport",style:{position:"relative"}},Xs={class:"list-container-el"},Gs=["onClick","onContextmenu"],Qs={key:0,class:"week-correction-display"},Zs={class:"original-week"},eo={class:"corrected-week"},lo={key:1,class:"col-week"},ao={class:"col-time"},to={class:"time-date"},so={class:"col-item"},oo={class:"item-text"},no=["onClick"],io={key:0,class:"correction-winner-display"},ro={class:"original-row",title:"原始记录获得者"},uo={class:"corrected-row"},co={key:1,class:"no-winner"},vo={class:"col-rolls"},po={class:"pagination-box"},mo={class:"tabs-sort-control"},yo={class:"summary-grid has-sort-control"},fo={class:"summary-header"},go=["title"],ho={class:"tabs-sort-control"},ko={class:"summary-grid slot-grid has-sort-control"},bo={class:"summary-header"},wo={class:"s-right-group"},_o={class:"tabs-sort-control"},Co={class:"week-content-wrapper"},Vo={class:"summary-header"},So={class:"week-list-body"},xo=["onContextmenu","onClick","onMouseenter"],Eo={class:"week-row-aside"},Bo={class:"week-row-main"},$o={class:"week-item-name"},To={key:0,class:"week-list-divider"},Oo={style:{display:"flex","align-items":"center",gap:"4px"}},Ro={key:0,class:"dot-warn",style:{margin:"0"}},Do={key:1,class:"empty-placeholder"},Mo={class:"empty-icon"},zo={class:"empty-hint"},Uo={key:0,class:"winner-change-popover"},Po={class:"popover-header"},Lo={class:"select-player-row"},jo={key:0,class:"custom-context-menu"},Ao={class:"menu-info-header"},Wo={class:"action-label"},Fo={key:1,class:"empty-container"},Io={class:"empty-placeholder compact-guide"},No={key:0,class:"empty-guide-main",style:{position:"relative"}},Yo={class:"empty-info-side"},Jo={class:"empty-hint"},Ho={class:"empty-desc"},Ko={class:"empty-highlight"},qo={class:"setup-form"},Xo={class:"setup-row"},Go={class:"setup-row"},Qo={class:"empty-hint",style:{"margin-top":"24px"}},Zo={key:2,class:"ready-state-container",style:{position:"relative",width:"100%",display:"flex","flex-direction":"column","align-items":"center"}},en={class:"empty-title"},ln={class:"empty-desc"},an={class:"empty-hint"},tn={key:0,class:"export-selection-list"},sn={class:"dialog-footer"},on={key:0,class:"import-preview-box"},nn={class:"import-selection-list"},rn={key:0,class:"import-not-found-hint"},un={key:1,class:"import-identical-hint"},cn={key:0,class:"import-not-found-hint"},dn={key:1,class:"import-identical-hint"},vn={key:0,class:"import-not-found-hint"},pn={key:1,class:"import-identical-hint"},mn={key:0,class:"import-not-found-hint"},yn={key:1,class:"import-identical-hint"},fn={key:0,class:"import-not-found-hint"},gn={key:1,class:"import-identical-hint"},hn={key:0,class:"import-not-found-hint"},kn={key:1,class:"import-identical-hint"},bn={key:0,class:"import-not-found-hint"},wn={key:1,class:"import-identical-hint"},_n={key:0,class:"import-warning-info"},Cn={key:1,class:"import-success-info"},Vn={class:"dialog-footer"},Sn={key:0,class:"clear-selection-list"},xn={class:"clear-selection-header"},En={class:"clear-quick-actions"},Bn={class:"clear-danger-hint"},$n={class:"dialog-footer"},Tn={class:"dialog-footer"},On={key:0,class:"premium-correction-layout"},Rn={class:"correction-sidebar"},Dn={class:"nav-icon"},Mn={class:"nav-content"},zn={class:"nav-status"},Un={class:"nav-icon"},Pn={class:"nav-content"},Ln={class:"nav-status"},jn={class:"sidebar-footer"},An={class:"correction-main"},Wn={class:"main-header"},Fn={class:"correction-grid-wrapper scroll-thin"},In={class:"card-main-row"},Nn={class:"item-primary-info"},Yn=["title"],Jn={class:"item-time"},Hn={class:"card-comparison-inline"},Kn={class:"comp-box old"},qn={class:"value"},Xn={key:1,class:"week-text"},Gn={class:"comp-arrow"},Qn={class:"comp-box new"},Zn={class:"value"},ei={key:1,class:"week-text"},li={class:"card-actions"},ai={key:0,class:"premium-empty"},ti="需在左上方“固定队 - 职位设置”中完成所有职位后方可开启",si=e(a({__name:"lootHistory",setup(e){const a="2026-01-06T16:00",v="总冠军",y="装备掉落/拿装备记录",D="固定队成员",M="毕业装备需求 (BIS)",z="角色合并映射",U="手动修改过的CD周数",P="手动修改过的装备获得者",J="过滤和排序偏好",H=q("loot-history-records"),K=q("loot-history-config"),ye=q("loot-history-handle"),ge=m(!0),ke=m(!1),be=m(!1),il=m(0),rl=m([]),ul=m([]),cl=C([]),dl=m(new Set),vl=m(new Set),pl=m({}),ml=m("summary"),yl=m(null),fl=m(!1),gl=m(!1),hl=m(!1),bl=m({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),_l=m({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),Vl=m({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0}),Sl=m(null),xl=m({timestamp:"",item:"",player:""}),Bl=m(!1),$l=m({loot:!0,bis:!1,roles:!1,mapping:!1,weekCorrection:!1,playerCorrection:!1,settings:!1}),Ol=m(!1),Rl=m({}),Dl=m({}),Ml=m({}),zl=m(null),Ul=m(),Pl=m({}),Ll=m(null),jl=m(""),Al=m(!1),Wl=m(!1),Fl=m(""),Il=m("player"),Nl=m({playerBis:{}}),Jl=t(()=>{if(!Wl.value)return[];const e=[],l=new Map(cl.value.map(e=>[e.key,e]));if(Object.entries(Ml.value).forEach(([a,t])=>{const s=l.get(a);s&&e.push({key:a,type:"player",itemName:s.item,oldVal:s.player,newVal:t,record:s})}),!Fl.value)return e;const a=Fl.value.toLowerCase();return e.filter(e=>e.itemName.toLowerCase().includes(a)||e.oldVal.toString().toLowerCase().includes(a)||e.newVal.toString().toLowerCase().includes(a))}),Hl=t(()=>{if(!Wl.value)return[];const e=[],l=new Map(cl.value.map(e=>[e.key,e]));if(Object.entries(Dl.value).forEach(([t,s])=>{const o=l.get(t);if(!o)return;const n=Q(o.timestamp,a),i=n+s;e.push({key:t,type:"week",itemName:o.item,oldVal:`第 ${n} 周`,newVal:`第 ${i} 周`,record:o})}),!Fl.value)return e;const t=Fl.value.toLowerCase();return e.filter(e=>e.itemName.toLowerCase().includes(t)||e.oldVal.toString().toLowerCase().includes(t)||e.newVal.toString().toLowerCase().includes(t))});const ql=m("part"),Xl=m("part"),Gl=m("drop"),Ql=m("part"),Zl=m({});function ea(e){return Zl.value&&Zl.value[e]||e}function la(e){return Ml.value[e.key]||e.player}const aa=m([]);function ta(){2===aa.value.length&&(na(aa.value[0],aa.value[1]),aa.value=[])}const sa=m("obtained"),oa=m("obtained");function na(e,l){e&&l&&(Zl.value={...Zl.value,[e]:l})}const ia=m(1),ra=m(""),ua=m(""),ca=m(!1),da=m({}),va=m(a),pa=m(null),ma=m(!1),ya=m(!1),fa=m(!1),ga=["御敌","制敌","精准","治愈","强攻","强袭","游击","咏咒"].join("|"),ha=new RegExp(`(${v}武器箱|${v}(?!${ga})|规格神典石|强化药|硬化药|强化纤维|神典石)`),ka=new RegExp(`(?<series>.+)(${ga}).+`),ba=m(!1),wa=m(!1),_a=m(!1),Ca=m(!0),Va=m({cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]}),Sa=m({});let xa=!1;const Ea=(()=>{let e=null;return l=>{e&&clearTimeout(e),e=setTimeout(()=>{K.bulkSet(l)},500)}})(),Ba=new Map;function $a(){"visible"===document.visibilityState&&cl.value.length>0&&gi()}f([pl,Rl,ra,da,va,pa,ml,ma,Nl,Zl,Sa,ba,wa,_a,Va,fa,Dl,Ml,ql,Xl,Gl,Ql,vl,Ca,sa,oa],()=>{const e=[{key:"itemVisibility",value:pl.value},{key:"playerVisibility",value:Rl.value},{key:"weekCorrections",value:Dl.value},{key:"playerCorrections",value:Ml.value},{key:"logPath",value:ra.value},{key:"processedFiles",value:da.value},{key:"syncStartDate",value:va.value},{key:"syncEndDate",value:pa.value},{key:"viewMode",value:ml.value},{key:"isRaidFilterActive",value:ma.value},{key:"bisConfig",value:Nl.value},{key:"hideUnselectedItems",value:wa.value},{key:"hideUnselectedPlayers",value:_a.value},{key:"playerMapping",value:Zl.value},{key:"playerRoles",value:Sa.value},{key:"showOnlyRole",value:ba.value},{key:"isOnlyRaidMembersActive",value:fa.value},{key:"systemFilterSettings",value:Va.value},{key:"summarySortMode",value:ql.value},{key:"slotSortMode",value:Xl.value},{key:"weekSortMode",value:Gl.value},{key:"bisSortMode",value:Ql.value},{key:"playerSummaryFilterMode",value:sa.value},{key:"slotSummaryFilterMode",value:oa.value},{key:"hideEmptyPlayers",value:Ca.value},{key:"blacklistedKeys",value:Array.from(vl.value)}],l=[];for(const{key:a,value:t}of e){const e="object"==typeof t?JSON.stringify(t):String(t);Ba.get(a)!==e&&(l.push({key:a,value:"object"==typeof t?JSON.parse(e):t}),Ba.set(a,e))}l.length>0&&Ea(l)},{deep:!0}),f([va,pa],()=>{ge.value||(ya.value=!0,gi())}),V(async()=>{ge.value=!0;try{const[e,l,a]=await Promise.all([H.getAll(),K.getAll(),ye.get("current-log-dir")]);let t=!1;const s=e.map(e=>{const l=X(e.item),a=G(e.player),s=e.rolls.map(e=>({...e,player:G(e.player)}));return(l!==e.item||a!==e.player||JSON.stringify(s)!==JSON.stringify(e.rolls))&&(t=!0),{...e,item:l,player:a,rolls:s,timestamp:new Date(e.timestamp)}});if(t&&await H.bulkSet(JSON.parse(JSON.stringify(s))),l.forEach(e=>{"itemVisibility"===e.key&&(pl.value=e.value),"playerVisibility"===e.key&&(Rl.value=e.value),"logPath"===e.key&&(ra.value=e.value),"processedFiles"===e.key&&(da.value=e.value||{}),"weekCorrections"===e.key&&(Dl.value=e.value||{}),"playerCorrections"===e.key&&(Ml.value=e.value||{}),"syncStartDate"===e.key&&e.value&&(va.value=e.value),"syncEndDate"===e.key&&(pa.value=e.value||null),"viewMode"===e.key&&["list","summary","slot","week","chart","bis"].includes(e.value)&&(ml.value=e.value),"hideUnselectedItems"===e.key&&(wa.value=!!e.value),"hideUnselectedPlayers"===e.key&&(_a.value=!!e.value),"playerMapping"===e.key&&(Zl.value=e.value||{}),"playerRoles"===e.key&&(Sa.value=e.value||{}),"showOnlyRole"===e.key&&(ba.value=!!e.value),"systemFilterSettings"===e.key&&e.value&&(Va.value={...Va.value,...e.value}),"isRaidFilterActive"===e.key&&(ma.value=!!e.value),"isOnlyRaidMembersActive"===e.key&&(fa.value=!!e.value),"summarySortMode"===e.key&&(ql.value=e.value||"part"),"slotSortMode"===e.key&&(Xl.value=e.value||"part"),"weekSortMode"===e.key&&(Gl.value=e.value||"drop"),"bisSortMode"===e.key&&(Ql.value=e.value||"part"),"blacklistedKeys"===e.key&&(vl.value=new Set(e.value||[])),"bisConfig"===e.key&&(Nl.value=e.value||{playerBis:{}}),"playerSummaryFilterMode"===e.key&&(sa.value=e.value||"obtained"),"slotSummaryFilterMode"===e.key&&(oa.value=e.value||"obtained")}),a&&a.handle){yl.value=a.handle,ua.value=a.handle.name;"granted"===await a.handle.queryPermission({mode:"read"})?xa=!0:ra.value="未授权，请点击同步按钮"}cl.value=s,dl.value=new Set(s.map(e=>e.key)),Xa.value||"list"===ml.value||(ml.value="list"),window.addEventListener("paste",Fa),document.body.addEventListener("dragover",La),document.body.addEventListener("dragleave",ja),document.body.addEventListener("drop",Aa),window.addEventListener("click",Ia),window.addEventListener("keydown",Qa),window.addEventListener("click",Pa),window.addEventListener("visibilitychange",$a),cl.value.length>0&&setTimeout(()=>{gi()},300),await S(),setTimeout(()=>{ge.value=!1},50)}catch(e){ge.value=!1}});const Ta=m(!1),Oa=m(!1);let Ra=null;const Da=m(!1),Ma=m(),za=m("");function Ua(){Da.value=!1}function Pa(e){if(zl.value){const l=document.querySelector(".winner-change-popper"),a=l?.contains(e.target),t=e.target.closest(".winner-selector-trigger");a||t||(zl.value=null)}}function La(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer?.types.includes("Files")&&(Ta.value=!0,Ra&&(clearTimeout(Ra),Ra=null))}function ja(e){e.preventDefault(),Ra&&clearTimeout(Ra),Ra=setTimeout(()=>{Ta.value=!1,Oa.value=!1},100)}function Aa(e){if(e.preventDefault(),e.stopPropagation(),Ta.value=!1,Oa.value=!1,Ra&&(clearTimeout(Ra),Ra=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Ii(l)}}function Wa(e){if(e.preventDefault(),e.stopPropagation(),Ta.value=!1,Oa.value=!1,Ra&&(clearTimeout(Ra),Ra=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Ii(l)}}async function Fa(e){const l=e.clipboardData?.getData("text");if(l)try{if(!l.trim().startsWith("{"))return;const a=JSON.parse(l);a.r&&Array.isArray(a.r)&&(e.preventDefault(),await Wi(a))}catch(a){}}function Ia(){ii.value=!1}x(()=>{window.removeEventListener("paste",Fa),document.body.removeEventListener("dragover",La),document.body.removeEventListener("dragleave",ja),document.body.removeEventListener("drop",Aa),window.removeEventListener("click",Ia),window.removeEventListener("keydown",Qa),window.removeEventListener("visibilitychange",$a),window.removeEventListener("click",Pa)});const Na=t(()=>{if(ge.value||!ke.value||0===cl.value.length)return new Map;const e=new Map;return cl.value.forEach(l=>{const a=new Set([l.player,...l.rolls.map(e=>e.player)]);a.forEach(l=>{e.has(l)||e.set(l,new Set);const t=e.get(l);a.forEach(e=>{e!==l&&t.add(e)})})}),e}),Ya=t(()=>{if(ge.value||!ke.value||0===Na.value.size)return[];const e=[],l=Array.from(Na.value.keys());for(let a=0;a<l.length;a++)for(let t=a+1;t<l.length;t++){const s=l[a],o=l[t];if(ea(s)===ea(o))continue;const n=Na.value.get(s),i=Na.value.get(o);if(n.size<3||i.size<3)continue;const r=new Set([...n].filter(e=>i.has(e))),u=new Set([...n,...i]),c=r.size/u.size;c>.9&&e.push({from:s,to:o,confidence:Math.round(100*c)})}return e.sort((e,l)=>l.confidence-e.confidence).slice(0,5)}),Ja=t(()=>{const e={};return cl.value.forEach(l=>{const a=ea(la(l));e[a]=(e[a]||0)+1}),e}),Ha=t(()=>{if(ge.value)return[];const e=new Set;return cl.value.forEach(l=>{e.add(ea(la(l))),l.rolls.forEach(l=>e.add(ea(l.player)))}),Object.values(Sa.value).forEach(l=>{l&&e.add(ea(l))}),Array.from(e).sort((e,l)=>Si(e,l,Ja.value))}),Ka=t(()=>{const e=new Set;return cl.value.forEach(l=>{if(ha.test(l.item))return;const a=l.item.match(ka);a?.groups?.series&&e.add(a.groups.series)}),Array.from(e).sort()}),qa=t(()=>new Set(Object.values(Sa.value))),Xa=t(()=>N.every(e=>!!Sa.value[e])),Ga=t(()=>!!Xa.value&&N.every(e=>Y(Nl.value,e)));function Qa(e){const l=e.target,a=["INPUT","TEXTAREA"].includes(l.tagName)||l.isContentEditable;if("Escape"===e.key){if(zl.value)return void(zl.value=null);if(ii.value)return void(ii.value=!1);if(fl.value)return void(fl.value=!1);if(gl.value)return void(gl.value=!1);if(hl.value)return void(hl.value=!1);if(Bl.value)return void(Bl.value=!1);if(Ol.value)return void(Ol.value=!1)}a||e.ctrlKey||e.altKey||e.metaKey||e.shiftKey||("1"===e.key?ml.value="list":Xa.value&&("2"===e.key&&(ml.value="summary"),"3"===e.key&&(ml.value="slot"),"4"===e.key&&(ml.value="week"),"5"===e.key&&(ml.value="chart"),"6"===e.key&&(ml.value="bis")))}const Za=t(()=>{const e=new Set;cl.value.forEach(l=>{e.add(ea(l.player))});const l=new Set;cl.value.forEach(e=>{l.add(e.player),e.rolls.forEach(e=>l.add(e.player))});const a=new Set(Object.keys(Zl.value));return Array.from(l).filter(e=>{if(a.has(e))return!1;return wi(ea(e))}).sort((e,l)=>Si(e,l,Ja.value))}),et=t(()=>{let e=at.value;"needed"===sa.value&&(e=e.filter(e=>{const l=$i(e);return l&&!l.startsWith("LEFT:")&&!l.startsWith("SUB:")}));const l=vt.value,a={};return e.forEach(e=>{a[e]=Object.values(l[e]||{}).reduce((e,l)=>e+l,0)}),[...e].sort((e,l)=>Si(e,l,a))}),lt=t(()=>{const e=new Set,l=new Date(va.value).getTime(),a=pa.value?new Date(pa.value).getTime():1/0;return cl.value.forEach(t=>{if(ki(t.item))return;if(!1===pl.value[t.item])return;const s=t.timestamp.getTime();s<l||s>a||e.add(ea(la(t)))}),e}),at=t(()=>{let e=Ha.value;return fa.value?e=e.filter(e=>!!$i(e)):_a.value&&(e=e.filter(e=>wi(e))),Ca.value&&!fa.value&&(e=e.filter(e=>lt.value.has(e))),e}),tt=t(()=>Ca.value?Ha.value.filter(e=>lt.value.has(e)):Ha.value),st=t(()=>wa.value?ot.value.filter(bi):ot.value),ot=t(()=>{if(ge.value)return[];const e=new Set(cl.value.filter(e=>!ki(e.item)).map(e=>e.item));return Array.from(e).sort((e,l)=>{const a=it(e),t=it(l);return a!==t?a-t:e.localeCompare(l)})});f([ma,ot],([e])=>{e?(!function(){const e={};ot.value.forEach(l=>{e[l]=ha.test(l)}),pl.value=e,0===ut.value&&(l=!0,Ha.value.forEach(e=>Rl.value[e]=l));var l}(),wa.value=!0):wa.value=!1},{immediate:!0}),f(Xa,e=>{!e&&fa.value&&(fa.value=!1),e||(ml.value="list")});const nt=I;function it(e,l="part"){const a=("part"===l?I:Z).findIndex(l=>e.includes(l)||l.includes(e));return-1!==a?a:ha.test(e)?50:100}const rt=t(()=>st.value.length),ut=t(()=>at.value.length),ct=t(()=>{if(ge.value)return[];const e=new Date(va.value).getTime(),l=pa.value?new Date(pa.value).getTime():1/0,a=pl.value,t=Rl.value;return cl.value.filter(s=>{if(ki(s.item))return!1;const o=ea(la(s));if(!1===t[o])return!1;if(!1===a[s.item])return!1;const n=s.timestamp.getTime();return!(n<e||n>l)}).sort((e,l)=>l.timestamp.getTime()-e.timestamp.getTime())}),dt=t(()=>ct.value.map(e=>({...e,player:la(e)}))),vt=t(()=>{if(ge.value)return{};const e={};return ct.value.forEach(l=>{const a=ea(la(l)),t=l.item;e[a]||(e[a]={}),e[a][t]||(e[a][t]=0),e[a][t]++}),e});const pt=t(()=>{if(ge.value)return{};const e={};return nt.forEach(l=>{e[l]={}}),ct.value.forEach(l=>{let a=(t=l.item,nt.find(e=>t.includes(e))||"其他");var t;"其他"===a&&(a=l.item),e[a]||(e[a]={});const s=e[a],o=ea(la(l));s[o]||(s[o]=0),s[o]++}),e}),mt=t(()=>{const e=oa.value;return[...("part"===Xl.value?I:Z).filter(l=>{if("all"===e)return!0;if(pt.value[l]&&Object.keys(pt.value[l]).length>0)return!0;if("needed"===e){const e=F.find(e=>e.name===l||e.keywords===l);if(!e)return!1;return Object.keys(Sa.value).filter(e=>!e.startsWith("LEFT:")&&!e.startsWith("SUB:")).some(l=>{const a=Sa.value[l];if(!a)return!1;const t=vt.value[a]||{};return ee(e,t)<Ci(e,a)})}return!1}),...Object.keys(pt.value).filter(e=>!I.includes(e)&&!Z.includes(e)).filter(e=>Object.keys(pt.value[e]||{}).length>0).sort((e,l)=>{const a=e=>Object.values(pt.value[e]||{}).reduce((e,l)=>e+l,0),t=a(e),s=a(l);return t!==s?s-t:e.localeCompare(l)})]});const yt=t(()=>L(new Date(a)));function gt(e){const{label:l}=A(e,yt.value);return l}const ht=t(()=>{const e={};ct.value.forEach(l=>{const t=function(e){const l=Dl.value[e.key]||0;return j(e.timestamp,l,a).label}(l);e[t]||(e[t]={});const s=ea(la(l));e[t][s]||(e[t][s]=[]),e[t][s].push(l)});for(const l in e)for(const a in e[l]){const t=e[l][a];t&&t.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime())}return e}),kt=t(()=>{const e=new Set,l={};ct.value.forEach(e=>{const{label:a}=j(e.timestamp);l[a]||(l[a]=[]),l[a].push(e)});for(const a in l){const t=l[a],s={};t.forEach(e=>{s[e.item]||(s[e.item]=[]),s[e.item].push(e)});const o=[];for(const e in s){const l=s[e];if(l.length>1){l.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime());for(let e=0;e<l.length-1;e++){const a=l[e];l[e+1].timestamp.getTime()-a.timestamp.getTime()>3e5&&o.push(a.timestamp.getTime())}}}t.forEach(l=>{if(!ha.test(l.item))return;const a=l.timestamp,t=a.getDay(),s=a.getHours();if(2!==t)return;if(s<16||s>=19)return;const n=l.timestamp.getTime();o.some(e=>Math.abs(n-e)<=3e5)&&e.add(l.key)})}return e}),bt=t(()=>Object.keys(ht.value).sort().reverse());function wt(e){const l=ht.value[e];if(!l)return[];const a=[];return Object.values(l).forEach(e=>{a.push(...e)}),a.sort((e,l)=>{const a=it(e.item,Gl.value),t=it(l.item,Gl.value);if(a!==t)return a-t;const s=Si(e.player,l.player);return 0!==s?s:e.timestamp.getTime()-l.timestamp.getTime()})}function si(e){const l=it(e,Gl.value);return"drop"===Gl.value?l<=3?1:l<=8?2:l<=12?3:4:0===l?1:l<=5?2:l<=9?3:4}function oi(e,l){if(l>=e.length-1)return!1;const a=e[l],t=e[l+1];if(!a||!t)return!1;return si(a.item)!==si(t.item)}const ni=m(null),ii=m(!1),ri=m({x:0,y:0}),ui={getBoundingClientRect:()=>({width:0,height:0,top:ri.value.y,bottom:ri.value.y,left:ri.value.x,right:ri.value.x})};function ci(e,l){e.preventDefault(),e.stopPropagation(),ni.value=l,ri.value={x:e.clientX,y:e.clientY},ii.value=!0}function di(){ni.value&&function(e){const l=Dl.value[e.key]||0,a={...Dl.value};l<0?delete a[e.key]:a[e.key]=-1,Dl.value=a}(ni.value),ii.value=!1}f(()=>zl.value,e=>{e||(Ul.value=null)});const vi=t(()=>{const e=50*(ia.value-1);return ct.value.slice(e,e+50)});function pi(){pl.value={},Rl.value={},ma.value=!1,va.value=a,pa.value=null}async function mi(){try{const e=window.showDirectoryPicker;if(!e)return void Ve.alert("你的浏览器不支持此功能","错误",{confirmButtonText:"确定",type:"error"});const l=await e();l&&(await H.clear(),await K.set({key:"processedFiles",value:{}}),da.value={},Dl.value={},cl.value=[],dl.value.clear(),pl.value={},Rl.value={},await ye.set({key:"current-log-dir",handle:l}),yl.value=l,ra.value=l.name,ua.value=l.name,Ol.value=!0)}catch(e){e.name}}async function yi(e,l=!1){try{const a=cl.value.findIndex(l=>l.key===e.key);-1!==a&&cl.value.splice(a,1),await H.remove(e.key),dl.value.delete(e.key),vl.value.add(e.key),l||Ce.success("记录已永久删除")}catch(a){l||Ce.error("删除失败")}}async function fi(){Ol.value=!1,await gi(!0)}async function gi(e=!1){if(ca.value||!yl.value)return;ya.value=!1;const l=yl.value;if(!xa){if("granted"!==await l.queryPermission({mode:"read"})){if(!e)return void(ya.value=!0);if("granted"!==await l.requestPermission({mode:"read"}))return}xa=!0}ca.value=!0;const a=0===dl.value.size;a&&(be.value=!0),il.value=0;try{const t=new Date(va.value).getTime(),s=pa.value?new Date(pa.value).getTime():1/0,o=[],n=new Set(dl.value),i=[],r=new Set,u=new Set;for await(const e of l.values())if("file"===e.kind&&e.name.toLowerCase().endsWith(".log")){const l=e.name,a=l.match(/_(\d{8})(?:\.|_)/);if(a&&a[1]){const e=`${a[1].slice(0,4)}-${a[1].slice(4,6)}-${a[1].slice(6,8)} 00:00:00`,l=new Date(e).getTime();if(l+864e5<t||l>s)continue}const n=await e.getFile();if(n.size<10)continue;if(!a&&(n.lastModified<t||n.lastModified>s))continue;const i=da.value[l];let r=0;if(i){if(n.size===i.size&&n.lastModified<=i.mtime)continue;n.size>i.size&&(r=i.size)}o.push({handle:e,name:l,size:n.size,startByte:r})}if(0===o.length)return ca.value=!1,be.value=!1,jl.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),void(e&&(Al.value=!0,setTimeout(()=>{Al.value=!1},800)));o.sort((e,l)=>e.name.localeCompare(l.name));const c=10;rl.value=[],ul.value=o.map(e=>({name:e.name,size:e.size-e.startByte}));let d=0;for(let e=0;e<o.length;e+=c){const l=o.slice(e,e+c).map(async e=>{const l=await e.handle.getFile(),a=await l.slice(e.startByte).text(),{records:t,players:s,items:c}=await hi(a);for(const o of t)n.has(o.key)||vl.value.has(o.key)||(n.add(o.key),i.push(o));s.forEach(e=>r.add(e)),c.forEach(e=>u.add(e)),da.value[e.name]={size:l.size,mtime:l.lastModified},d++,il.value=Math.round(d/o.length*100),rl.value.push({name:e.name,size:e.size}),rl.value.sort((e,l)=>e.name.localeCompare(l.name)),ul.value=ul.value.filter(l=>l.name!==e.name)});await Promise.all(l),await new Promise(e=>setTimeout(e,0))}if(i.length>0){await H.bulkSet(JSON.parse(JSON.stringify(i))),cl.value=[...cl.value,...i],dl.value=n,Oi(i,"sync");let e=!1;const l={...pl.value},t={...Rl.value};if(u.forEach(a=>{void 0===l[a]&&(l[a]=!0,e=!0)}),r.forEach(l=>{void 0===t[l]&&(t[l]=!0,e=!0)}),e&&(pl.value=l,Rl.value=t),a||Ce.success({message:`同步完成，新增 ${i.length} 条记录`,showClose:!0}),a){new Set(cl.value.filter(e=>ha.test(e.item)).map(e=>e.item)).size>=12&&(ma.value=!0),Xa.value||Ce.warning({message:"解析成功，请先在「固定队 - 职位设置」中完成所有职位的设置，以开启更多功能。",duration:1e4,showClose:!0})}}jl.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e&&(Al.value=!0,setTimeout(()=>{Al.value=!1},800)),ra.value=yl.value.name}catch(t){}finally{ca.value=!1,be.value=!1,il.value=0}}function hi(e){return new Promise((l,a)=>{const t=new kl;t.onmessage=e=>{l(e.data),t.terminate()},t.onerror=e=>{a(e),t.terminate()},t.postMessage(e)})}function ki(e){if(Va.value.cards&&e.startsWith("九宫幻卡"))return!0;if(Va.value.materia&&e.includes("魔晶石"))return!0;if(Va.value.music&&(e.startsWith("管弦乐琴乐谱")||e.startsWith("陈旧的乐谱")))return!0;if(Va.value.book&&e.endsWith("断章"))return!0;if(Va.value.totem&&e.endsWith("图腾"))return!0;if(Va.value.other&&e.includes("经验值"))return!0;if(!ha.test(e)){const l=e.match(ka);if(l?.groups?.series&&Va.value.maskedSeries?.includes(l.groups.series))return!0}return!1}function bi(e){return ma.value?ha.test(e):!1!==pl.value[e]}function wi(e){return fa.value?!!$i(e):!1!==Rl.value[e]}function _i(e,l){e.ctrlKey?Ri(l):e.altKey?Ji("item",l):ma.value||function(e){const l=!1!==pl.value[e];pl.value[e]=!l}(l)}function Ci(e,l){const a=$i(l);if(!a)return 0;const t=(Nl.value.playerBis||{})[a]||{};if("count"===e.type&&0===t[e.id])return 0;if(le(e,t))return"count"===e.type?t[e.id]||0:1;const s="toggle"===e.type&&"weapon"!==e.id,o="twine"===e.id||"coating"===e.id||"solvent"===e.id||"tome"===e.id;return s||o?1:0}function Vi(e,l){if(!e)return;if(Object.entries(Sa.value).some(([a,t])=>a.startsWith(l+":")&&t===e))return;let a=1,t=`${l}:${a}`;for(;Sa.value[t];)a++,t=`${l}:${a}`;Sa.value[t]=e}function Si(e,l,a){const t=$i(e),s=$i(l),o=e=>e?N.includes(e)?N.indexOf(e):e.startsWith("SUB:")?100:e.startsWith("LEFT:")?200:500:999,n=o(t),i=o(s);if(n!==i)return n-i;const r=a||Ja.value,u=r[e]||0,c=r[l]||0;return u!==c?c-u:e.localeCompare(l)}function xi(e,l){const a=oa.value,t=F.find(e=>e.name===l||e.keywords===l);if(!t)return Object.keys(e||{}).sort((l,a)=>Si(l,a,e||{}));const s=Object.entries(Sa.value).filter(([e,l])=>l&&!e.startsWith("LEFT:")).map(([e,l])=>l),o=Array.from(new Set([...Object.keys(e||{}),...s])),n=[];return o.forEach(l=>{const o=$i(l),i=o?.startsWith("LEFT:")||o?.startsWith("SUB:");if("needed"===a&&i)return;const r=e?.[l]||0,u=Ci(t,l);"all"===a?(r>0||s.includes(l))&&n.push(l):"obtained"===a?r>0&&n.push(l):"needed"===a&&!i&&r<u&&n.push(l)}),n.sort((l,a)=>Si(l,a,e||{}))}function Ei(e,l,a){const t=F.find(e=>e.name===l||e.keywords===l);if(!t){const e=l.startsWith(v)&&ha.test(l);return{count:a,isRandomWeapon:e,layerName:e?"4层":void 0}}const s=$i(e);if(!(s&&N.includes(s)))return{count:a,layerName:W.find(e=>e.items.includes(t.id))?.name};const o=(Nl.value.playerBis||{})[s]||{},n=void 0!==o[t.id],i=Ci(t,e),r=le(t,o),u=W.find(e=>e.items.includes(t.id));return{count:a,isBis:n?r:void 0,isBisFalse:!r&&i>0,layerName:u?.name}}function Bi(e){const l=vt.value[e]||{},a={},t=new Set;F.forEach(e=>{a[e.id]=0,Object.entries(l).forEach(([l,s])=>{const o=s||0;l.includes(e.keywords)&&(a[e.id]=(a[e.id]||0)+o,t.add(l))})});const s=[],o=$i(e),n=!(!o||!N.includes(o)),i=(Nl.value?.playerBis||{})[o||""]||{};F.forEach(l=>{const t=a[l.id],o=Ci(l,e);let r=!1;const u=t||0;if(("all"===sa.value||u>0||"needed"===sa.value&&u<o)&&(r=!0),r){const e=W.find(e=>e.items.includes(l.id));s.push({name:l.keywords||l.name,count:u,isBis:n&&void 0!==i[l.id]?o>0:void 0,id:l.id,layerName:e?e.name:void 0})}});const r=Y(Nl.value,$i(e)||e);Object.entries(l).forEach(([e,l])=>{if(!t.has(e)){const a=e.startsWith(v)&&ha.test(e);s.push({name:e,count:l,isRandomWeapon:a,isBis:(a||!n||!r)&&void 0,layerName:a?"4层":void 0})}});const u=ql.value;return s.sort((e,l)=>{const a=it(e.id&&F.find(l=>l.id===e.id)?.keywords||e.name,u),t=it(l.id&&F.find(e=>e.id===l.id)?.keywords||l.name,u);return a!==t?a-t:e.name.localeCompare(l.name)}),"obtained"===sa.value?s.filter(e=>e.count>0):"needed"===sa.value?s.filter(e=>0===e.count):s}function $i(e){for(const[l,a]of Object.entries(Sa.value))if(a===e)return l}function Ti(e,l){var a;e.ctrlKey?Ri(l):e.altKey?Ji("player",l):fa.value||(a=l,Rl.value[a]=!(!1!==Rl.value[a]))}async function Oi(e,l){const a=function(e){const l=cl.value.filter(e=>e.isManual);if(0===l.length)return[];const a=[],t=new Map;return e.forEach(e=>{if(e.isManual)return;const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`;t.has(l)||t.set(l,new Set),t.get(l).add(ea(e.player))}),l.forEach(e=>{const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`,s=t.get(l);s&&s.has(ea(e.player))&&a.push(e)}),a}(e);if(0===a.length)return;const t="sync"===l?"同步的日志":"导入的数据";try{await Ve.confirm(`在${t}中发现了 ${a.length} 条与现有手动记录重合的数据（同日期、同玩家、同物品）。<br/><br/>是否删除这些手动记录，以真实的解析数据为准？`,"发现重复记录",{confirmButtonText:"删除手动记录",cancelButtonText:"全部保留",type:"info",dangerouslyUseHTMLString:!0});for(const e of a)await yi(e,!0);Ce.success(`已清理 ${a.length} 条手动记录`)}catch{}}async function Ri(e){try{await navigator.clipboard.writeText(e),Ce.success({message:`已复制: ${e}`,duration:1500,showClose:!0})}catch(l){Ce.error({message:"复制失败",showClose:!0})}}function Di(){xl.value={timestamp:(new Date).toISOString(),item:"",player:""},fl.value=!0}function Mi(e,l){l(Array.from(ot.value).filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}function zi(e,l){l(Ha.value.filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}async function Ui(){const e=xl.value.item.trim(),l=xl.value.player.trim();if(!xl.value.timestamp||!e||!l)return void Ce.error("请填写完整信息");const a=!ot.value.includes(e),t=!Ha.value.includes(l);if(a||t){let s="";s=a&&t?`物品 "<b>${e}</b>" 和 玩家 "<b>${l}</b>" 都是第一次出现。`:a?`物品 "<b>${e}</b>" 是第一次出现。`:`玩家 "<b>${l}</b>" 是第一次出现。`;try{await Ve.confirm(`${s}<br/><br/>确定要以此名称创建记录吗？请检查是否有错别字。`,"发现新条目",{confirmButtonText:"确定创建",cancelButtonText:"返回修改",type:"warning",dangerouslyUseHTMLString:!0})}catch{return}}const s=new Date(xl.value.timestamp),o={key:`manual-${s.getTime()}-${Math.random().toString(36).slice(2)}`,timestamp:s,item:e,player:l,rolls:[],isManual:!0};await H.set(JSON.parse(JSON.stringify(o))),void 0===pl.value[o.item]&&(pl.value[o.item]=!0),void 0===Rl.value[ea(o.player)]&&(Rl.value[ea(o.player)]=!0),cl.value=[...cl.value,o],fl.value=!1,Ce.success({message:`已添加: ${o.item} - ${o.player}`,showClose:!0})}const Pi=m(null);function Li(e){"clear"===e?($l.value={loot:!0,bis:!1,roles:!1,mapping:!1,weekCorrection:!1,playerCorrection:!1,settings:!1},Bl.value=!0):"export"===e?gl.value=!0:"import"===e?Pi.value?.click():"manual"===e&&Di()}async function ji(){try{const e=new Set,l=new Set;let a=Date.now();cl.value.forEach(t=>{e.add(t.item),l.add(t.player);const s=t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp;s<a&&(a=s),t.rolls&&t.rolls.forEach(e=>l.add(e.player))});const t=Array.from(e),s=Array.from(l),o=new Map(t.map((e,l)=>[e,l])),n=new Map(s.map((e,l)=>[e,l])),i=new Map(["need","greed","assign","direct","manual"].map((e,l)=>[e,l])),r={v:4,base:a,dicts:{i:t,p:s},r:bl.value.loot?cl.value.map(e=>{const l=[(e.timestamp instanceof Date?e.timestamp.getTime():e.timestamp)-a,o.get(e.item),n.get(e.player),e.key];return e.rolls&&e.rolls.length>0?(l.push(e.rolls.length),e.rolls.forEach(e=>{l.push(n.get(e.player)),l.push(e.value),l.push(i.get(e.type)??0)})):l.push(0),l}):[]},u={};if(bl.value.mapping&&(u.map=Zl.value),bl.value.roles&&(u.roles=Sa.value),bl.value.bis){const e={playerBis:{}};N.forEach(l=>{const a=Nl.value.playerBis?.[l];a&&(e.playerBis[l]=a)}),u.bisConfig=e}bl.value.settings&&(u.filter=Va.value,u.raidActive=fa.value),bl.value.weekCorrection&&(u.weekCorrections=Dl.value),bl.value.playerCorrection&&(u.playerCorrections=Ml.value),r.c=u;const c=new Blob([JSON.stringify(r)],{type:"application/json"}),d=URL.createObjectURL(c),v=document.createElement("a");v.href=d,v.download=`ff14_loot_backup_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(d),gl.value=!1,Ce.success({message:"数据已导出",showClose:!0})}catch(e){Ce.error({message:"导出失败",showClose:!0})}}function Ai(e,l){if(e===l)return!0;if("object"!=typeof e||null===e||"object"!=typeof l||null===l)return!1;if(Array.isArray(e)!==Array.isArray(l))return!1;if(Array.isArray(e)){if(e.length!==l.length)return!1;for(let a=0;a<e.length;a++)if(!Ai(e[a],l[a]))return!1;return!0}const a=Object.keys(e).sort(),t=Object.keys(l).sort();if(a.length!==t.length)return!1;for(let s=0;s<a.length;s++){const o=a[s];if(void 0===o)return!1;if(o!==t[s])return!1;if(!Ai(e[o],l[o]))return!1}return!0}async function Wi(e){try{if(!e.r||!Array.isArray(e.r))return void Ce.error({message:"无效的备份文件格式",showClose:!0});const l=!!e.r?.length,a=!!(e.c?.bisConfig||e.bisConfig||e.c?.bis),t=!!e.c?.roles&&Object.keys(e.c.roles).length>0,s=!!e.c?.map&&Object.keys(e.c.map).length>0,o=!!e.c?.weekCorrections&&Object.keys(e.c.weekCorrections).length>0,n=!!e.c?.playerCorrections&&Object.keys(e.c.playerCorrections).length>0,i=e.c?.filter||void 0!==e.c?.raidActive,r=!Nl.value||!Nl.value.playerBis||0===Object.keys(Nl.value.playerBis).length,u=0===Object.keys(Sa.value).length,c=0===Object.keys(Zl.value).length,d=0===Object.keys(Dl.value).length,v=0===Object.keys(Ml.value).length;let p=0;if(l){const l=new Set(cl.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(cl.value.map(e=>e.key)),t=e.base||0,s=e.dicts?.i||[],o=e.dicts?.p||[];for(const n of e.r){const e=t+n[0],i=s[n[1]],r=o[n[2]],u=n[3];if(!i||!r)continue;const c=u&&"string"==typeof u?u:`${e}_${i}_${r}`;if(a.has(c)||vl.value.has(c))continue;const d=`${e}|${i}|${r}`;l.has(d)||p++}}const m=e.c?.bisConfig||e.bisConfig||e.c?.bis;Vl.value={loot:l&&p>0,bis:(()=>{if(!a)return!1;const e={},l={};return N.forEach(a=>{const t=Nl.value.playerBis;t&&t[a]&&(e[a]=t[a]);const s=m?.playerBis;s&&s[a]&&(l[a]=s[a])}),!Ai(e,l)})(),roles:t&&!Ai(Sa.value,e.c.roles),mapping:s&&!Ai(Zl.value,e.c.map),weekCorrection:o&&!Ai(Dl.value,e.c.weekCorrections||{}),playerCorrection:n&&!Ai(Ml.value,e.c.playerCorrections||{}),settings:i&&(!Ai(Va.value,e.c.filter||Va.value)||fa.value!==(e.c.raidActive??fa.value))},_l.value={loot:Vl.value.loot,bis:a&&r&&Vl.value.bis,roles:t&&u&&Vl.value.roles,mapping:s&&c&&Vl.value.mapping,weekCorrection:o&&d&&Vl.value.weekCorrection,playerCorrection:n&&v&&Vl.value.playerCorrection,settings:i&&Vl.value.settings},Sl.value=e,hl.value=!0}catch(l){Ce.error({message:"解析出错",showClose:!0})}}async function Fi(){const e=Sl.value;if(!e)return;let l;try{if(l=Ce({message:"正在导入数据...",duration:0,type:"info",showClose:!0}),e.c){if(_l.value.mapping&&e.c.map&&(Zl.value={...Zl.value,...e.c.map}),_l.value.roles&&e.c.roles&&(Sa.value={...Sa.value,...e.c.roles}),_l.value.bis){const l=e.c.bisConfig||e.bisConfig||e.c.bis;if(l){const e={playerBis:{}};N.forEach(a=>{const t=l.playerBis?.[a];t&&(e.playerBis[a]=t)}),Nl.value=e}}_l.value.settings&&(e.c.filter&&(Va.value={...Va.value,...e.c.filter}),void 0!==e.c.raidActive&&(fa.value=e.c.raidActive)),_l.value.weekCorrection&&e.c.weekCorrections&&(Dl.value={...Dl.value,...e.c.weekCorrections}),_l.value.playerCorrection&&e.c.playerCorrections&&(Ml.value={...Ml.value,...e.c.playerCorrections})}if(_l.value.loot&&e.r&&e.r.length>0){const l=new Set(cl.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(cl.value.map(e=>e.key)),t=[],s=e.base||0,o=e.dicts?.i||[],n=e.dicts?.p||[],i=["need","greed","assign","direct","manual"];for(const r of e.r){const e=s+r[0],u=o[r[1]],c=n[r[2]],d=r[3],v=r[4],p=[];if(v>0){let e=5;for(let l=0;l<v&&!(e+2>=r.length);l++)p.push({player:n[r[e]],value:r[e+1],type:i[r[e+2]]||"need"}),e+=3}if(!u||!c)continue;const m=d&&"string"==typeof d?d:`${e}_${u}_${c}_${Math.random().toString(36).slice(2)}`;if(a.has(m)||vl.value.has(m))continue;const y=`${e}|${u}|${c}`;l.has(y)||(t.push({key:m,timestamp:new Date(e),item:u,player:c,rolls:p,source:"import",id:""}),l.add(y),a.add(m))}t.length>0&&(await H.bulkSet(JSON.parse(JSON.stringify(t))),cl.value=[...cl.value,...t].sort((e,l)=>new Date(l.timestamp).getTime()-new Date(e.timestamp).getTime()),dl.value=new Set(cl.value.map(e=>e.key)),Oi(t,"import"))}Ce.success({message:"数据导入已完成",showClose:!0}),hl.value=!1,Sl.value=null}catch(a){Ce.error({message:"导入失败",showClose:!0})}finally{l?.close()}}function Ii(e){const l=new FileReader;l.onload=async e=>{try{const l=JSON.parse(e.target?.result);await Wi(l)}catch(l){Ce.error({message:"文件解析失败",showClose:!0})}},l.readAsText(e)}function Ni(e){const l=e.target;l.files&&0!==l.files.length&&(Ii(l.files[0]),l.value="")}const Yi=m(null);function Ji(e,l){const a="item"===e,t=a?pl:Rl,s=a?ot:Ha;if(Yi.value?.type===e&&Yi.value.key===l)return t.value={...Yi.value.snapshot},Yi.value=null,void Ce.info({message:"已恢复到独显前的状态",duration:2e3,showClose:!0});let o=t.value;Yi.value?.type===e&&(o=Yi.value.snapshot),Yi.value={type:e,key:l,snapshot:JSON.parse(JSON.stringify(o))};const n={};s.value.forEach(e=>{n[e]=e===l}),t.value=n,Ce.success({message:`仅显示: ${l} (再次 Alt+点击 恢复)`,duration:2e3})}function Hi(e){const l=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${e.getFullYear()}/${l}/${a} ${t}:${s}`}function Ki(e){return 0===e?"0 MB":(e/1048576).toFixed(2)+" MB"}function qi(e){const l=e.rolls.find(l=>l.player===e.player);if(l)return l;if(e.player){const l=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:e.player,type:l,value:null}}return null}function Xi(e){const l=la(e);if(!!Ml.value[e.key])return{player:l,type:"replace",value:null};const a=e.rolls.find(e=>e.player===l);if(a)return a;if(l){const a=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:l,type:a,value:null}}return null}async function Gi(){if(0===Object.values($l.value).filter(Boolean).length)return void(Bl.value=!1);Bl.value=!1;const e=[];$l.value.loot&&(e.push(H.clear()),cl.value=[],dl.value.clear(),da.value={},e.push(K.remove("processedFiles"))),$l.value.weekCorrection&&(Dl.value={},e.push(K.remove("weekCorrections"))),$l.value.playerCorrection&&(Ml.value={},e.push(K.remove("playerCorrections"))),$l.value.settings&&(Va.value={cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]},fa.value=!1,e.push(K.remove("systemFilterSettings")),e.push(K.remove("isOnlyRaidMembersActive"))),$l.value.bis&&(Nl.value={playerBis:{}},e.push(K.remove("bisConfig"))),$l.value.roles&&(Sa.value={},e.push(K.remove("playerRoles"))),$l.value.mapping&&(Zl.value={},e.push(K.remove("playerMapping"))),await Promise.all(e),Ce.success({message:"所选数据已清空",showClose:!0})}async function Qi(e,l){l&&(Ll.value={record:e,newPlayer:l},zl.value=null,setTimeout(()=>{Ll.value&&async function(){if(!Ll.value)return;const{record:e,newPlayer:l}=Ll.value,a={...Ml.value};l===e.player?delete a[e.key]:a[e.key]=l;Ml.value=a,Ce.success({message:l===e.player?"已恢复原始获得者":`已将物品重新分配给 ${l}`,showClose:!0}),Ll.value=null}()},75))}return(e,t)=>{const v=l,m=ae,f=se,C=xe,V=ie,S=re,x=oe,L=ue,j=me,A=We,W=Ye,F=Ke,I=Ge,Y=He,H=Qe,K=Je,q=Ee,X=nl;return n(),s("div",{class:r(["app-container",{"is-onboarding":!yl.value||Ol.value||0===cl.value.length}])},[c(E,{name:"fade"},{default:h(()=>[ge.value?(n(),s("div",Ct,[d("div",Vt,[t[88]||(t[88]=d("div",{class:"skeleton-header"},[d("div",{class:"skeleton-item brand"}),d("div",{class:"skeleton-item toolbar"})],-1)),d("div",St,[t[86]||(t[86]=d("div",{class:"skeleton-item control"},null,-1)),t[87]||(t[87]=d("div",{class:"skeleton-filters"},[d("div",{class:"skeleton-item filter-box"}),d("div",{class:"skeleton-item filter-box"})],-1)),d("div",xt,[(n(),s(b,null,w(8,e=>d("div",{key:e,class:"skeleton-item card"})),64))])])])])):o("",!0)]),_:1}),d("div",Et,[c(v,{"storage-key":"loot-history-theme"})]),ge.value?o("",!0):(n(),s(b,{key:0},[c(E,{name:"fade"},{default:h(()=>[be.value?(n(),s("div",Bt,[d("div",$t,[d("div",Tt,[t[89]||(t[89]=d("div",{class:"spinner-small"},null,-1)),d("span",Ot,"解析中... "+u(il.value)+"%",1)]),d("div",Rt,[d("div",Dt,[d("div",Mt," 已完成 ("+u(rl.value.length)+") ",1),d("div",zt,[c(O,{name:"list"},{default:h(()=>[(n(!0),s(b,null,w(rl.value,e=>(n(),s("div",{key:e.name,class:"file-item done"},[d("div",Ut,[c(m,null,{default:h(()=>[c(p(Be))]),_:1}),d("span",{class:"file-name",title:e.name},u(e.name),9,Pt)]),d("span",Lt,u(Ki(e.size)),1)]))),128))]),_:1})])]),t[90]||(t[90]=d("div",{class:"list-divider"},null,-1)),d("div",jt,[d("div",At," 待处理 ("+u(ul.value.length)+") ",1),d("div",Wt,[(n(!0),s(b,null,w(ul.value.slice(0,50),e=>(n(),s("div",{key:e.name,class:"file-item pending"},[d("div",Ft,[c(m,null,{default:h(()=>[c(p($e))]),_:1}),d("span",{class:"file-name",title:e.name},u(e.name),9,It)]),d("span",Nt,u(Ki(e.size)),1)]))),128)),ul.value.length>50?(n(),s("div",Yt," ...还有 "+u(ul.value.length-50)+" 个文件 ",1)):o("",!0)])])])])])):o("",!0)]),_:1}),cl.value.length>0?(n(),s("main",Jt,[d("div",Ht,[Ta.value?(n(),s("div",{key:0,class:r(["drag-guide-zone",{"is-active":Oa.value}]),onDrop:_(Wa,["stop","prevent"]),onDragover:t[0]||(t[0]=_(()=>{},["prevent"])),onDragenter:t[1]||(t[1]=e=>Oa.value=!0),onDragleave:t[2]||(t[2]=e=>Oa.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(Te))]),_:1}),t[91]||(t[91]=d("span",null,"释放文件以导入备份",-1))],34)):o("",!0),d("div",Kt,[c(f,{type:ya.value?"warning":"primary",size:"small",loading:ca.value,onClick:t[3]||(t[3]=e=>gi(!0)),class:"sync-btn-fixed"},{default:h(()=>[k(u(ca.value?"同步中":ya.value?"需要同步":"立即同步")+" ",1),ya.value?(n(),s("span",qt)):o("",!0)]),_:1},8,["type","loading"]),d("div",Xt,[B(d("div",{class:"sync-hint-text time-hint"}," 上次同步: "+u(jl.value),513),[[$,!Al.value&&jl.value]]),B(d("div",Gt," 同步成功 ",512),[[$,Al.value]])]),c(C,{modelValue:va.value,"onUpdate:modelValue":t[4]||(t[4]=e=>va.value=e),type:"datetime",size:"small",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1,class:"date-picker-el"},null,8,["modelValue"]),t[108]||(t[108]=d("span",{class:"range-sep"},"-",-1)),c(C,{modelValue:pa.value,"onUpdate:modelValue":t[5]||(t[5]=e=>pa.value=e),type:"datetime",size:"small",placeholder:"截止时间(可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:"",class:"date-picker-el"},null,8,["modelValue"]),c(f,{onClick:mi,plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Oe))]),_:1}),t[92]||(t[92]=d("span",null,"日志目录",-1))]),_:1}),t[109]||(t[109]=d("div",{class:"v-divider"},null,-1)),c(f,{onClick:Di,plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(ve))]),_:1}),t[93]||(t[93]=d("span",null,"手动添加",-1))]),_:1}),c(x,{trigger:"click",onCommand:Li},{dropdown:h(()=>[c(S,null,{default:h(()=>[c(V,{command:"import"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Re))]),_:1}),t[95]||(t[95]=k("导入备份 (JSON) ",-1))]),_:1}),c(V,{command:"export"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(De))]),_:1}),t[96]||(t[96]=k("导出备份 (JSON) ",-1))]),_:1}),c(V,{command:"clear",divided:"",style:{color:"#f56c6c"}},{default:h(()=>[c(m,null,{default:h(()=>[c(p(pe))]),_:1}),t[97]||(t[97]=k("清空数据库 ",-1))]),_:1})]),_:1})]),default:h(()=>[c(f,{plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(te))]),_:1}),t[94]||(t[94]=d("span",null,"数据管理",-1)),c(m,{class:"el-icon--right"},{default:h(()=>[c(p(ne))]),_:1})]),_:1})]),_:1}),c(f,{plain:"",class:"tool-btn",onClick:t[6]||(t[6]=e=>Wl.value=!0)},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Me))]),_:1}),t[98]||(t[98]=d("span",null,"自定义修正管理",-1))]),_:1}),t[110]||(t[110]=d("div",{class:"v-divider"},null,-1)),c(L,{placement:"bottom-end",width:480,trigger:"click","popper-class":"guide-popover-popper"},{reference:h(()=>[c(f,{plain:"",class:"tool-btn"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(ce))]),_:1}),t[99]||(t[99]=d("span",null,"使用指南",-1))]),_:1})]),default:h(()=>[d("div",Qt,[d("section",Zt,[d("h4",null,[c(m,null,{default:h(()=>[c(p(fe))]),_:1}),t[100]||(t[100]=k(" 这是什么？ ",-1))]),t[101]||(t[101]=d("p",null,[k(" 这是一个专门为 FFXIV 固定队设计的"),d("strong",null,"掉落历史统计"),k("与 "),d("strong",null,"BIS 分配管理"),k("工具。它能自动从你的 ACT 日志中记录战利品信息，并以此为基础提供自动化的分配建议与数据分析。 ")],-1))]),d("section",es,[d("h4",null,[c(m,null,{default:h(()=>[c(p(ze))]),_:1}),t[102]||(t[102]=k(" 注意事项 ",-1))]),t[103]||(t[103]=d("div",{class:"warning-box"},[d("ul",null,[d("li",null,[d("strong",null,"保持 ACT 运行："),k("且未勾选“隐藏聊天日志(隐私保护)”。 ")]),d("li",null,[d("strong",null,"请勿提前退本："),k(" 一定要等装备分完了再退本！以保证日志完整。 ")])])],-1))]),d("section",ls,[d("h4",null,[c(m,null,{default:h(()=>[c(p(Ue))]),_:1}),t[104]||(t[104]=k(" 快速上手 ",-1))]),t[105]||(t[105]=d("ol",null,[d("li",null,[d("strong",null,"配置人员："),k(" 在左上方“固定队 - 职位设置”中绑定队员 ID。 ")]),d("li",null,[d("strong",null,"BIS 规划："),k(" 切换至“BIS分配”页签，录入全队成员的毕业装备需求。 ")]),d("li",null,[d("strong",null,"一键分配："),k(" 副本结束后，可参考“BIS分配”页签的建议进行分配。 ")])],-1))]),d("section",as,[d("h4",null,[c(m,null,{default:h(()=>[c(p(Pe))]),_:1}),t[106]||(t[106]=k(" 漏了记录怎么办？ ",-1))]),t[107]||(t[107]=d("p",null,[k(" 如果因意外（如掉线、忘开 ACT 等）漏掉记录，请点击主界面右上角的“"),d("strong",null,"手动添加"),k("”补全。手动添加的记录也会参与 BIS 统计与分配计算。 ")],-1))])])]),_:1})])]),d("div",ts,[d("div",ss,[d("div",os,[d("div",ns,[d("span",is,"👥 玩家 ("+u(ut.value)+")",1),t[116]||(t[116]=d("div",{class:"header-sep"},null,-1)),c(L,{placement:"bottom",width:360,trigger:"click","popper-class":"role-settings-popper"},{reference:h(()=>[c(f,{size:"small",class:"soft-action-btn primary"},{default:h(()=>[c(m,null,{default:h(()=>[c(p(de))]),_:1}),t[111]||(t[111]=d("span",null,"固定队 - 职位设置",-1)),Xa.value?o("",!0):(n(),s("span",rs))]),_:1})]),default:h(()=>[d("div",us,[d("div",cs,[(n(!0),s(b,null,w(p(N),e=>(n(),s("div",{key:e,class:"role-setup-item"},[d("div",ds,[c(wl,{role:e},null,8,["role"])]),c(p(Le),{modelValue:Sa.value[e],"onUpdate:modelValue":l=>Sa.value[e]=l,placeholder:"选择/输入玩家",filterable:"","allow-create":"","default-first-option":"",clearable:"",size:"small",style:{flex:"1"},teleported:!1},{default:h(()=>[(n(!0),s(b,null,w(tt.value.filter(l=>l===Sa.value[e]||!qa.value.has(l)),e=>(n(),g(p(je),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128))]),t[114]||(t[114]=d("div",{class:"role-divider"},"特殊分组",-1)),d("div",vs,[d("div",ps,[t[112]||(t[112]=d("div",{class:"group-title"},"临时替补",-1)),d("div",ms,[(n(!0),s(b,null,w(Sa.value,(e,l)=>(n(),s(b,{key:l},[l.startsWith("SUB:")?(n(),s("div",ys,[c(p(Ae),{closable:"",onClose:e=>delete Sa.value[l]},{default:h(()=>[k(u(e),1)]),_:2},1032,["onClose"])])):o("",!0)],64))),128)),c(p(Le),{placeholder:"添加/输入替补",filterable:"","allow-create":"","default-first-option":"",size:"small",onChange:t[7]||(t[7]=e=>Vi(e,"SUB")),value:"",style:{width:"120px"},teleported:!1},{default:h(()=>[(n(!0),s(b,null,w(tt.value.filter(e=>!qa.value.has(e)),e=>(n(),g(p(je),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])]),d("div",fs,[t[113]||(t[113]=d("div",{class:"group-title"},"已离队",-1)),d("div",gs,[(n(!0),s(b,null,w(Sa.value,(e,l)=>(n(),s(b,{key:l},[l.startsWith("LEFT:")?(n(),s("div",hs,[c(p(Ae),{closable:"",onClose:e=>delete Sa.value[l]},{default:h(()=>[k(u(e),1)]),_:2},1032,["onClose"])])):o("",!0)],64))),128)),c(p(Le),{placeholder:"添加/输入离队",filterable:"","allow-create":"","default-first-option":"",size:"small",onChange:t[8]||(t[8]=e=>Vi(e,"LEFT")),value:"",style:{width:"120px"},teleported:!1},{default:h(()=>[(n(!0),s(b,null,w(tt.value.filter(e=>!qa.value.has(e)),e=>(n(),g(p(je),{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1})])])])])]),_:1}),t[117]||(t[117]=d("div",{class:"header-sep"},null,-1)),c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[d("label",ks,[c(p(Se),{modelValue:ba.value,"onUpdate:modelValue":t[9]||(t[9]=e=>ba.value=e),disabled:!Xa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6","--el-switch-off-color":"#cbd5e1"}},null,8,["modelValue","disabled"]),d("span",{class:"switch-label",style:i({opacity:Xa.value?1:.5})},"只显示职位",4)])]),_:1},8,["disabled"]),t[118]||(t[118]=d("div",{class:"header-sep"},null,-1)),c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[d("div",bs,[c(p(Se),{modelValue:fa.value,"onUpdate:modelValue":t[10]||(t[10]=e=>fa.value=e),disabled:!Xa.value,size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue","disabled"]),d("span",{class:"switch-label",style:i({opacity:Xa.value?1:.5,fontSize:"12px"})}," 只看固定队 ",4)])]),_:1},8,["disabled"]),fa.value?o("",!0):(n(),s("div",ws)),fa.value?o("",!0):(n(),s("label",_s,[c(p(Se),{modelValue:Ca.value,"onUpdate:modelValue":t[11]||(t[11]=e=>Ca.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),t[115]||(t[115]=d("span",{class:"switch-label"},"隐藏无记录玩家",-1))]))]),d("div",Cs,[c(L,{visible:ke.value,"onUpdate:visible":t[12]||(t[12]=e=>ke.value=e),placement:"bottom",width:320,trigger:"click"},{reference:h(()=>[c(f,{size:"small",class:"soft-action-btn"},{default:h(()=>[...t[119]||(t[119]=[k("合并大小号",-1)])]),_:1})]),default:h(()=>[d("div",Vs,[d("div",Ss,[d("div",xs,[c(m,null,{default:h(()=>[c(p(fe))]),_:1}),t[120]||(t[120]=d("div",{class:"guide-content"},[d("p",null,[k(" 合并角色将"),d("strong",null,"永久归并"),k("两者的所有历史记录。 ")]),d("p",null," 若仅需修正单次分配错误，请直接在“详情记录”中点击姓名进行修改。 ")],-1))]),d("div",Es,[d("div",{class:r(["step-dot hide",{"is-active":0===aa.value.length}])},[...t[121]||(t[121]=[d("span",{class:"step-num"},"1",-1),d("span",{class:"step-label"},"被合角色",-1)])],2),c(m,{class:"step-arrow"},{default:h(()=>[c(p(_e))]),_:1}),d("div",{class:r(["step-dot show",{"is-active":1===aa.value.length}])},[...t[122]||(t[122]=[d("span",{class:"step-num"},"2",-1),d("span",{class:"step-label"},"目标角色",-1)])],2)]),d("div",Bs,[(n(!0),s(b,null,w(Za.value,e=>(n(),g(A,{key:e,checked:aa.value.includes(e),onChange:l=>function(e){aa.value.includes(e)?aa.value=aa.value.filter(l=>l!==e):(aa.value.length>=2&&aa.value.shift(),aa.value.push(e))}(e),class:r(["merge-check-tag",[aa.value[0]===e?"is-hiding":"",aa.value[1]===e?"is-showing":""]])},{default:h(()=>[c(Cl,{name:e,role:$i(e),"show-only-role":ba.value,class:"tag-label-name"},null,8,["name","role","show-only-role"]),aa.value[0]===e?(n(),s("div",$s,[c(m,null,{default:h(()=>[c(p(Fe))]),_:1}),t[123]||(t[123]=d("span",null,"隐身角色",-1))])):o("",!0),aa.value[1]===e?(n(),s("div",Ts,[c(m,null,{default:h(()=>[c(p(Ie))]),_:1}),t[124]||(t[124]=d("span",null,"主角色",-1))])):o("",!0)]),_:2},1032,["checked","onChange","class"]))),128))]),2===aa.value.length?(n(),s("div",Os,[c(f,{type:"primary",size:"default",onClick:ta,class:"confirm-merge-btn-new"},{default:h(()=>[...t[125]||(t[125]=[k(" 确认将数据合并 ",-1)])]),_:1})])):o("",!0)]),Ya.value.length>0?(n(),s("div",Rs,[t[126]||(t[126]=d("div",{class:"suggest-title"}," 💡 发现疑似换号 (>90% 重合)： ",-1)),d("div",Ds,[(n(!0),s(b,null,w(Ya.value,e=>(n(),g(f,{key:e.from+e.to,size:"small",plain:"",class:"suggest-btn",onClick:l=>na(e.from,e.to)},{default:h(()=>[c(Cl,{name:e.from,role:$i(e.from),"show-only-role":ba.value},null,8,["name","role","show-only-role"]),c(m,{style:{margin:"0 4px"}},{default:h(()=>[c(p(_e))]),_:1}),c(Cl,{name:e.to,role:$i(e.to),"show-only-role":ba.value},null,8,["name","role","show-only-role"]),d("span",Ms,"("+u(e.confidence)+"%)",1)]),_:2},1032,["onClick"]))),128))])])):o("",!0),Object.keys(Zl.value).length>0?(n(),s("div",zs,[t[129]||(t[129]=d("div",{class:"selector-title"},"当前合并映射:",-1)),d("div",Us,[(n(!0),s(b,null,w(Zl.value,(e,l)=>(n(),s("div",{key:l,class:"mapping-item-row"},[d("div",Ps,[t[127]||(t[127]=d("span",{class:"map-tag-hint"},"隐身",-1)),c(Cl,{name:l,role:$i(l),"show-only-role":ba.value},null,8,["name","role","show-only-role"])]),c(m,{class:"map-arrow"},{default:h(()=>[c(p(_e))]),_:1}),d("div",Ls,[t[128]||(t[128]=d("span",{class:"map-tag-hint"},"显示",-1)),c(Cl,{name:e,role:$i(e),"show-only-role":ba.value},null,8,["name","role","show-only-role"])]),c(f,{link:"",type:"danger",icon:p(pe),onClick:e=>function(e){const l={...Zl.value};delete l[e],Zl.value=l}(l),class:"map-remove"},null,8,["icon","onClick"])]))),128))])])):o("",!0)])]),_:1},8,["visible"]),t[130]||(t[130]=d("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示",-1))])]),d("div",js,[fa.value?(n(),s("div",As)):o("",!0),(n(!0),s(b,null,w(at.value,e=>(n(),g(A,{key:e,checked:wi(e),class:r([{"readonly-tag":fa.value},"mini-tag-el player-tag"]),onClick:_(l=>Ti(l,e),["stop"])},{default:h(()=>[c(Cl,{name:e,role:$i(e),"show-only-role":ba.value},null,8,["name","role","show-only-role"])]),_:2},1032,["checked","class","onClick"]))),128))])]),d("div",Ws,[d("div",Fs,[d("div",Is,[d("span",Ns,"📦 物品 ("+u(rt.value)+")",1),d("label",Ys,[c(p(Se),{modelValue:ma.value,"onUpdate:modelValue":t[13]||(t[13]=e=>ma.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),t[131]||(t[131]=d("span",{class:"switch-label"},"只看零式掉落",-1))]),t[135]||(t[135]=d("div",{class:"header-sep"},null,-1)),c(L,{placement:"bottom-start",width:220,trigger:"click"},{reference:h(()=>[c(f,{size:"small",class:"soft-action-btn primary"},{default:h(()=>[c(m,{style:{"margin-right":"4px"}},{default:h(()=>[c(p(te))]),_:1}),t[132]||(t[132]=k(" 杂物屏蔽设置 ",-1))]),_:1})]),default:h(()=>[d("div",Js,[t[134]||(t[134]=d("div",{class:"pop-title"},"屏蔽杂物 (非零式模式下生效)",-1)),d("div",{class:"filter-list",style:i({opacity:ma.value?.5:1,pointerEvents:ma.value?"none":"auto"})},[c(p(Ne),{modelValue:Va.value.cards,"onUpdate:modelValue":t[14]||(t[14]=e=>Va.value.cards=e),label:"九宫幻卡",size:"small"},null,8,["modelValue"]),c(p(Ne),{modelValue:Va.value.materia,"onUpdate:modelValue":t[15]||(t[15]=e=>Va.value.materia=e),label:"魔晶石",size:"small"},null,8,["modelValue"]),c(p(Ne),{modelValue:Va.value.music,"onUpdate:modelValue":t[16]||(t[16]=e=>Va.value.music=e),label:"乐谱",size:"small"},null,8,["modelValue"]),c(p(Ne),{modelValue:Va.value.book,"onUpdate:modelValue":t[17]||(t[17]=e=>Va.value.book=e),label:"零式断章",size:"small"},null,8,["modelValue"]),c(p(Ne),{modelValue:Va.value.totem,"onUpdate:modelValue":t[18]||(t[18]=e=>Va.value.totem=e),label:"极神图腾",size:"small"},null,8,["modelValue"]),c(p(Ne),{modelValue:Va.value.other,"onUpdate:modelValue":t[19]||(t[19]=e=>Va.value.other=e),label:"经验值/金币",size:"small"},null,8,["modelValue"]),Ka.value.length>0?(n(),s(b,{key:0},[t[133]||(t[133]=d("div",{class:"pop-title",style:{margin:"8px 0 4px","padding-top":"8px"}}," 屏蔽装备系列 ",-1)),c(W,{modelValue:Va.value.maskedSeries,"onUpdate:modelValue":t[20]||(t[20]=e=>Va.value.maskedSeries=e),style:{display:"flex","flex-direction":"column",gap:"4px"}},{default:h(()=>[(n(!0),s(b,null,w(Ka.value,e=>(n(),g(p(Ne),{key:e,label:e,size:"small"},{default:h(()=>[k(u(e)+"系列 ",1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])],64)):o("",!0)],4)])]),_:1})]),t[136]||(t[136]=d("div",{class:"acts"},[d("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示")],-1))]),d("div",Hs,[ma.value?(n(),s("div",Ks)):o("",!0),(n(!0),s(b,null,w(st.value,e=>(n(),g(A,{key:e,checked:bi(e),class:r([{"readonly-tag":ma.value},"mini-tag-el item-tag"]),onClick:_(l=>_i(l,e),["stop"])},{default:h(()=>[k(u(e),1)]),_:2},1032,["checked","class","onClick"]))),128))])])]),d("div",qs,[ct.value.length>0?(n(),g(q,{key:0,modelValue:ml.value,"onUpdate:modelValue":t[31]||(t[31]=e=>ml.value=e),class:"mode-tabs-el",type:"card"},{default:h(()=>[c(K,{label:"详细记录",name:"list"},{default:h(()=>[d("div",Xs,[c(Y,{data:vi.value,style:{width:"100%"},class:"loot-record-table","cell-class-name":"loot-cell"},{default:h(()=>[c(F,{label:"周",width:"60",align:"center"},{default:h(e=>[d("div",{class:"col-week-interactive",onClick:_(l=>ci(l,e.row),["stop"]),onContextmenu:_(l=>ci(l,e.row),["prevent"])},[Dl.value[e.row.key]?(n(),s("div",Qs,[d("div",Zs," W"+u(p(Q)(e.row.timestamp,a)),1),c(m,{class:"week-arrow"},{default:h(()=>[c(p(ne))]),_:1}),d("div",eo," W"+u(p(Q)(e.row.timestamp,a)+(Dl.value[e.row.key]||0)),1)])):(n(),s("div",lo,[k(" W"+u(p(Q)(e.row.timestamp,a))+" ",1),c(j,{placement:"top",enterable:!1},{content:h(()=>[...t[137]||(t[137]=[k(" 可能归属周错误（通常发生在周二压线进本）。",-1),d("br",null,null,-1),k("点击可选择将其归入上一周。 ",-1)])]),default:h(()=>[kt.value.has(e.row.key)&&!Dl.value[e.row.key]?(n(),g(m,{key:0,class:"week-warning-icon"},{default:h(()=>[c(p(he))]),_:1})):o("",!0)]),_:2},1024)]))],40,Gs)]),_:1}),c(F,{label:"时间",width:"140"},{default:h(e=>[d("div",ao,[d("span",to,u(Hi(e.row.timestamp)),1)])]),_:1}),c(F,{label:"物品",width:"220"},{default:h(e=>[d("div",so,[d("span",oo,u(e.row.item),1)])]),_:1}),c(F,{label:"获得者",width:"260"},{default:h(e=>[d("div",{class:"winner-selector-trigger",onClick:_(l=>{return a=l,t=e.row,void(zl.value?.key!==t.key?(Ul.value=a.currentTarget,zl.value=t,Pl.value[t.key]=!!Ml.value[t.key]):zl.value=null);var a,t},["stop"])},[Ml.value[e.row.key]?(n(),s("div",io,[d("div",ro,[t[138]||(t[138]=d("span",{class:"correction-label"},"原始记录:",-1)),qi(e.row)?(n(),g(El,{key:0,roll:qi(e.row),"show-only-role":ba.value,"get-player-role":$i,class:"original-display"},null,8,["roll","show-only-role"])):(n(),g(Cl,{key:1,name:e.row.player,role:$i(e.row.player),"show-only-role":ba.value,class:"original-display"},null,8,["name","role","show-only-role"]))]),d("div",uo,[c(m,{class:"correction-arrow"},{default:h(()=>[c(p(qe))]),_:1}),Xi(e.row)?(n(),g(El,{key:0,roll:Xi(e.row),"is-winner":"","show-only-role":ba.value,"get-player-role":$i},null,8,["roll","show-only-role"])):o("",!0)])])):(n(),s(b,{key:1},[Xi(e.row)?(n(),g(El,{key:0,roll:Xi(e.row),"is-winner":"","show-only-role":ba.value,"get-player-role":$i},null,8,["roll","show-only-role"])):(n(),s("div",co,"未分配"))],64)),c(m,{class:"winner-edit-icon"},{default:h(()=>[c(p(Xe))]),_:1})],8,no)]),_:1}),c(F,{label:"其他 Roll 点记录"},{default:h(e=>{return[d("div",vo,[(n(!0),s(b,null,w((l=e.row,l.rolls.filter(e=>e.player!==l.player).sort((e,l)=>{const a={need:0,greed:1},t=a[e.type]??3,s=a[l.type]??3;return t!==s?t-s:(l.value||0)-(e.value||0)})),e=>(n(),g(El,{key:e.player,roll:e,"show-only-role":ba.value,"get-player-role":$i},null,8,["roll","show-only-role"]))),128))])];var l}),_:1}),c(F,{label:"操作",width:"60",align:"center"},{default:h(e=>[c(I,{title:"确定永久删除吗？","confirm-button-text":"删除","cancel-button-text":"取消",onConfirm:l=>yi(e.row)},{reference:h(()=>[c(f,{type:"danger",icon:p(pe),size:"small",circle:"",plain:""},null,8,["icon"])]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"]),d("div",po,[c(H,{"current-page":ia.value,"onUpdate:currentPage":t[21]||(t[21]=e=>ia.value=e),"page-size":50,layout:"total, prev, pager, next",total:ct.value.length,small:""},null,8,["current-page","total"])])])]),_:1}),c(K,{name:"summary",disabled:!Xa.value,lazy:""},{label:h(()=>[c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[...t[139]||(t[139]=[d("span",null,"按玩家",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",mo,[c(Tl,{modelValue:ql.value,"onUpdate:modelValue":t[22]||(t[22]=e=>ql.value=e)},null,8,["modelValue"]),t[140]||(t[140]=d("div",{class:"v-divider-mini"},null,-1)),c(Kl,{modelValue:sa.value,"onUpdate:modelValue":t[23]||(t[23]=e=>sa.value=e)},null,8,["modelValue"])]),d("div",yo,[(n(!0),s(b,null,w(et.value,e=>(n(),s("div",{key:e,class:"summary-card"},[d("div",fo,[c(Cl,{name:e,role:$i(e),"show-only-role":ba.value},null,8,["name","role","show-only-role"])]),d("div",null,[(n(!0),s(b,null,w(Bi(e),e=>(n(),s("div",{key:e.name,class:r(["summary-item",{"is-not-obtained":0===e.count}])},[d("span",{class:"s-name",title:e.name},u(e.name),9,go),c(_t,{item:e},null,8,["item"])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(K,{name:"slot",disabled:!Xa.value,lazy:""},{label:h(()=>[c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[...t[141]||(t[141]=[d("span",null,"按部位",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",ho,[c(Tl,{modelValue:Xl.value,"onUpdate:modelValue":t[24]||(t[24]=e=>Xl.value=e)},null,8,["modelValue"]),t[142]||(t[142]=d("div",{class:"v-divider-mini"},null,-1)),c(Kl,{modelValue:oa.value,"onUpdate:modelValue":t[25]||(t[25]=e=>oa.value=e)},null,8,["modelValue"])]),d("div",ko,[(n(!0),s(b,null,w(mt.value,e=>(n(),s("div",{key:e,class:"summary-card"},[d("div",bo,u(e),1),d("div",null,[(n(!0),s(b,null,w(xi(pt.value[e]||{},e),l=>(n(),s("div",{key:l,class:r(["summary-item",{"is-not-obtained":0===(pt.value[e]?.[l]||0)}])},[c(Cl,{class:"s-name",name:l,role:$i(l),"show-only-role":ba.value},null,8,["name","role","show-only-role"]),d("div",wo,[c(_t,{item:Ei(l,e,pt.value[e]?.[l]||0)},null,8,["item"])])],2))),128))])]))),128))])]),_:1},8,["disabled"]),c(K,{name:"week",disabled:!Xa.value,lazy:""},{label:h(()=>[c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[...t[143]||(t[143]=[d("span",null,"按CD周",-1)])]),_:1},8,["disabled"])]),default:h(()=>[d("div",_o,[c(Tl,{modelValue:Gl.value,"onUpdate:modelValue":t[26]||(t[26]=e=>Gl.value=e)},null,8,["modelValue"])]),d("div",Co,[d("div",{class:r(["summary-grid has-sort-control",{"is-compact-role":ba.value}])},[(n(!0),s(b,null,w(bt.value,e=>(n(),s("div",{key:e,class:"summary-card",onContextmenu:t[27]||(t[27]=_(()=>{},["prevent"]))},[d("div",Vo,u(gt(e)),1),d("div",So,[(n(!0),s(b,null,w([wt(e)],l=>(n(),s("div",{key:l.length+e},[(n(!0),s(b,null,w(l,(e,a)=>(n(),s(b,{key:e.key},[d("div",{class:r(["summary-item week-record-row",{"is-corrected":Dl.value[e.key],"is-suspicious":kt.value.has(e.key)&&!Dl.value[e.key]}]),onContextmenu:_(l=>ci(l,e),["prevent"]),onClick:_(l=>ci(l,e),["stop"]),onMouseenter:l=>function(e,l){kt.value.has(l.key)&&void 0===Dl.value[l.key]&&(Ma.value=e.currentTarget,za.value="可能归属周错误（通常发生在周二压线进本）。点击可选择将其归入上一周。",Da.value=!0)}(l,e),onMouseleave:Ua},[d("div",Eo,[c(Cl,{name:e.player,role:$i(e.player),"show-only-role":ba.value,"name-class":"week-player-name"},null,8,["name","role","show-only-role"])]),d("div",Bo,[d("span",$o,u(e.item),1),kt.value.has(e.key)&&!Dl.value[e.key]?(n(),g(m,{key:0,class:"row-status-icon is-warning"},{default:h(()=>[c(p(he))]),_:1})):o("",!0),Dl.value[e.key]?(n(),g(m,{key:1,class:"row-status-icon is-info"},{default:h(()=>[c(p($e))]),_:1})):o("",!0)])],42,xo),oi(l,a)?(n(),s("div",To)):o("",!0)],64))),128))]))),128))])],32))),128))],2)]),c(j,{visible:Da.value,"onUpdate:visible":t[28]||(t[28]=e=>Da.value=e),"virtual-ref":Ma.value,"virtual-triggering":"",placement:"top",content:za.value,"popper-class":"week-suspicious-tooltip"},null,8,["visible","virtual-ref","content"])]),_:1},8,["disabled"]),c(K,{name:"chart",disabled:!Xa.value,lazy:""},{label:h(()=>[c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[...t[144]||(t[144]=[d("span",null,"图表分析",-1)])]),_:1},8,["disabled"])]),default:h(()=>[c(Yl,{records:dt.value,players:at.value,"get-actual-player":ea,"get-player-role":$i,"record-week-corrections":Dl.value,"sync-start-date":va.value,"player-visibility":ba.value?"role":"all"},null,8,["records","players","record-week-corrections","sync-start-date","player-visibility"])]),_:1},8,["disabled"]),c(K,{name:"bis",disabled:!Xa.value,lazy:""},{label:h(()=>[c(j,{disabled:Xa.value,content:ti,placement:"top"},{default:h(()=>[d("div",Oo,[t[145]||(t[145]=d("span",null,"BIS分配",-1)),Xa.value&&!Ga.value?(n(),s("span",Ro)):o("",!0)])]),_:1},8,["disabled"])]),default:h(()=>[c(ft,{modelValue:Nl.value,"onUpdate:modelValue":t[29]||(t[29]=e=>Nl.value=e),sortMode:Ql.value,"onUpdate:sortMode":t[30]||(t[30]=e=>Ql.value=e),players:at.value,records:dt.value,"get-player-role":$i,"get-actual-player":ea,"show-only-role":ba.value},null,8,["modelValue","sortMode","players","records","show-only-role"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):(n(),s("div",Do,[d("div",Mo,[c(m,null,{default:h(()=>[c(p(Ze))]),_:1})]),t[147]||(t[147]=d("div",{class:"empty-title"},"未发现匹配记录",-1)),t[148]||(t[148]=d("p",{class:"empty-desc"},[k(" 当前筛选条件过于严格，数据库中有数据但未能匹配。"),d("br"),k(" 请尝试"),d("span",{class:"empty-highlight"},"清除筛选条件"),k("或调整时间范围。 ")],-1)),d("div",zo,[c(f,{type:"info",plain:"",onClick:pi},{default:h(()=>[...t[146]||(t[146]=[k("显示所有掉落",-1)])]),_:1})])])),c(L,{visible:!!zl.value,"virtual-ref":Ul.value,"virtual-triggering":"",persistent:!1,"hide-after":0,placement:"bottom",width:240,"popper-class":"winner-change-popper"},{default:h(()=>[zl.value?(n(),s("div",Uo,[d("div",Po,[t[150]||(t[150]=d("div",{class:"popover-title"},"变更获得者",-1)),Pl.value[zl.value.key]?(n(),g(f,{key:0,type:"primary",link:"",size:"small",class:"restore-btn",onClick:t[32]||(t[32]=e=>Qi(zl.value,zl.value.player))},{default:h(()=>[...t[149]||(t[149]=[k(" 恢复原始记录 ",-1)])]),_:1})):o("",!0)]),t[151]||(t[151]=d("div",{class:"popover-desc"}," 将掉落记录手动转移至其他玩家名下 ",-1)),c(p(Le),{"model-value":la(zl.value),placeholder:"选择新获得者",filterable:"",size:"small",class:"winner-select-bar",onChange:t[33]||(t[33]=e=>Qi(zl.value,e))},{default:h(()=>[(n(!0),s(b,null,w(at.value,e=>(n(),g(p(je),{key:e,label:ba.value&&$i(e)||e,value:e},{default:h(()=>[d("div",Lo,[c(Cl,{name:e,role:$i(e),"show-only-role":ba.value},null,8,["name","role","show-only-role"])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["model-value"])])):o("",!0)]),_:1},8,["visible","virtual-ref"]),c(L,{visible:ii.value,"onUpdate:visible":t[34]||(t[34]=e=>ii.value=e),"virtual-ref":ui,"virtual-triggering":"",persistent:!1,"hide-after":0,"popper-class":"context-menu-popper",width:180,"show-arrow":!1,placement:"bottom-start"},{default:h(()=>[ni.value?(n(),s("div",jo,[d("div",Ao,[c(m,null,{default:h(()=>[c(p(el))]),_:1}),d("span",null,u(Hi(ni.value.timestamp)),1)]),t[152]||(t[152]=d("div",{class:"menu-divider"},null,-1)),d("div",{class:"menu-action-item",onClick:di},[c(m,{class:"action-arrow"},{default:h(()=>[(n(),g(R(Dl.value[ni.value.key]?p(Me):p(ll))))]),_:1}),d("span",Wo,u(Dl.value[ni.value.key]?"归回原始周":"归入上一周"),1)])])):o("",!0)]),_:1},8,["visible"])])])):(n(),s("div",Fo,[d("div",Io,[yl.value?Ol.value?(n(),s(b,{key:1},[t[166]||(t[166]=d("div",{class:"empty-title"},"设置同步范围",-1)),d("p",Ho,[t[159]||(t[159]=k(" 已关联目录：",-1)),d("span",Ko,u(yl.value.name),1),t[160]||(t[160]=d("br",null,null,-1)),t[161]||(t[161]=k(" 请指定你想要同步的历史记录起始时间。 ",-1))]),d("div",qo,[d("div",Xo,[t[162]||(t[162]=d("span",{class:"setup-label"},"起始时间:",-1)),c(C,{modelValue:va.value,"onUpdate:modelValue":t[39]||(t[39]=e=>va.value=e),type:"datetime",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1},null,8,["modelValue"])]),d("div",Go,[t[163]||(t[163]=d("span",{class:"setup-label"},"截止时间:",-1)),c(C,{modelValue:pa.value,"onUpdate:modelValue":t[40]||(t[40]=e=>pa.value=e),type:"datetime",placeholder:"现在 (可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm"},null,8,["modelValue"])])]),d("div",Qo,[c(f,{onClick:t[41]||(t[41]=e=>yl.value=null),plain:"",size:"large"},{default:h(()=>[...t[164]||(t[164]=[k("返回重选",-1)])]),_:1}),c(f,{type:"primary",size:"large",onClick:fi},{default:h(()=>[...t[165]||(t[165]=[k(" 开始解析并导入 ",-1)])]),_:1})])],64)):(n(),s("div",Zo,[Ta.value?(n(),s("div",{key:0,class:r(["setup-drag-zone",{"is-active":Oa.value}]),onDrop:_(Wa,["stop","prevent"]),onDragover:t[42]||(t[42]=_(()=>{},["prevent"])),onDragenter:t[43]||(t[43]=e=>Oa.value=!0),onDragleave:t[44]||(t[44]=e=>Oa.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(Te))]),_:1}),t[167]||(t[167]=d("span",null,"释放文件以导入备份",-1))],34)):o("",!0),d("div",en,u(ca.value?"正在同步数据":"准备就绪"),1),d("p",ln,u(ca.value?"正在处理日志文件，请稍候。":"数据库当前为空。你可以开始解析数据，或从备份文件恢复。"),1),d("div",an,[ca.value?o("",!0):(n(),g(f,{key:0,onClick:t[45]||(t[45]=e=>gi(!0)),type:"primary",size:"large"},{default:h(()=>[...t[168]||(t[168]=[k("开始解析数据",-1)])]),_:1})),ca.value?o("",!0):(n(),g(f,{key:1,onClick:t[46]||(t[46]=e=>Pi.value?.click()),plain:"",size:"large"},{default:h(()=>[...t[169]||(t[169]=[k("导入备份数据",-1)])]),_:1})),ca.value?o("",!0):(n(),g(f,{key:2,onClick:t[47]||(t[47]=e=>Ol.value=!0),plain:"",size:"large"},{default:h(()=>[...t[170]||(t[170]=[k("调整时间范围",-1)])]),_:1}))])])):(n(),s("div",No,[Ta.value?(n(),s("div",{key:0,class:r(["setup-drag-zone",{"is-active":Oa.value}]),onDrop:_(Wa,["stop","prevent"]),onDragover:t[35]||(t[35]=_(()=>{},["prevent"])),onDragenter:t[36]||(t[36]=e=>Oa.value=!0),onDragleave:t[37]||(t[37]=e=>Oa.value=!1)},[c(m,{class:"guide-icon"},{default:h(()=>[c(p(Te))]),_:1}),t[153]||(t[153]=d("span",null,"释放文件以导入备份",-1))],34)):o("",!0),d("div",Yo,[t[156]||(t[156]=d("div",{class:"empty-title"},"欢迎使用 Loot History",-1)),t[157]||(t[157]=d("p",{class:"empty-desc"},[k(" 选择你的"),d("span",{class:"empty-highlight"},"FFXIV 日志文件夹"),k("，开始记录掉落。 ")],-1)),d("div",Jo,[c(f,{type:"primary",size:"large",onClick:mi},{default:h(()=>[...t[154]||(t[154]=[k(" 选择日志目录 ",-1)])]),_:1}),c(f,{type:"info",plain:"",size:"large",onClick:t[38]||(t[38]=e=>Pi.value?.click())},{default:h(()=>[...t[155]||(t[155]=[k(" 导入备份数据 ",-1)])]),_:1})])]),t[158]||(t[158]=d("div",{class:"guide-img-box"},[d("img",{src:"/ff14-overlay-vue/assets/lootHistoryGuide-CNWHhK0O.jpg",alt:"Guide",class:"guide-img"})],-1))]))])])),c(p(we),{modelValue:gl.value,"onUpdate:modelValue":t[56]||(t[56]=e=>gl.value=e),title:"选择导出内容",width:"360px","append-to-body":"","destroy-on-close":""},T({default:h(()=>[gl.value?(n(),s("div",tn,[c(p(Ne),{modelValue:bl.value.loot,"onUpdate:modelValue":t[48]||(t[48]=e=>bl.value.loot=e)},{default:h(()=>[k(u(y)+" ("+u(cl.value.length)+")",1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.roles,"onUpdate:modelValue":t[49]||(t[49]=e=>bl.value.roles=e)},{default:h(()=>[k(u(D),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.bis,"onUpdate:modelValue":t[50]||(t[50]=e=>bl.value.bis=e)},{default:h(()=>[k(u(M),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.mapping,"onUpdate:modelValue":t[51]||(t[51]=e=>bl.value.mapping=e)},{default:h(()=>[k(u(z),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.weekCorrection,"onUpdate:modelValue":t[52]||(t[52]=e=>bl.value.weekCorrection=e)},{default:h(()=>[k(u(U),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.playerCorrection,"onUpdate:modelValue":t[53]||(t[53]=e=>bl.value.playerCorrection=e)},{default:h(()=>[k(u(P),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:bl.value.settings,"onUpdate:modelValue":t[54]||(t[54]=e=>bl.value.settings=e)},{default:h(()=>[k(u(J),1)]),_:1},8,["modelValue"])])):o("",!0)]),_:2},[gl.value?{name:"footer",fn:h(()=>[d("span",sn,[c(f,{onClick:t[55]||(t[55]=e=>gl.value=!1)},{default:h(()=>[...t[171]||(t[171]=[k("取消",-1)])]),_:1}),c(f,{type:"primary",onClick:ji},{default:h(()=>[...t[172]||(t[172]=[k("立即导出",-1)])]),_:1})])]),key:"0"}:void 0]),1032,["modelValue"]),c(p(we),{modelValue:hl.value,"onUpdate:modelValue":t[65]||(t[65]=e=>hl.value=e),title:"选择导入内容",width:"400px","append-to-body":"","destroy-on-close":""},{footer:h(()=>[d("span",Vn,[c(f,{onClick:t[64]||(t[64]=e=>hl.value=!1)},{default:h(()=>[...t[176]||(t[176]=[k("取消",-1)])]),_:1}),c(f,{type:"primary",onClick:Fi},{default:h(()=>[...t[177]||(t[177]=[k("确认导入",-1)])]),_:1})])]),default:h(()=>[hl.value&&Sl.value?(n(),s("div",on,[t[175]||(t[175]=d("p",{class:"import-hint-text"},"发现备份文件，请选择要导入的部分：",-1)),d("div",nn,[c(p(Ne),{modelValue:_l.value.loot,"onUpdate:modelValue":t[57]||(t[57]=e=>_l.value.loot=e),disabled:!Sl.value.r?.length},{default:h(()=>[k(u(y)+" ("+u(Sl.value.r?.length||0)+" 条) ",1),Sl.value.r?.length?Vl.value.loot?o("",!0):(n(),s("span",un,"(与现有记录一致)")):(n(),s("span",rn,"- 备份文件中未发现记录"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.bis,"onUpdate:modelValue":t[58]||(t[58]=e=>_l.value.bis=e),disabled:!Sl.value.bisConfig&&!Sl.value.c?.bisConfig&&!Sl.value.c?.bis},{default:h(()=>[k(u(M)+" ",1),Sl.value.bisConfig||Sl.value.c?.bisConfig||Sl.value.c?.bis?Vl.value.bis?o("",!0):(n(),s("span",dn,"(与现有配置一致)")):(n(),s("span",cn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.roles,"onUpdate:modelValue":t[59]||(t[59]=e=>_l.value.roles=e),disabled:!Sl.value.c?.roles},{default:h(()=>[k(u(D)+" ",1),Sl.value.c?.roles?Vl.value.roles?o("",!0):(n(),s("span",pn,"(与现有设置一致)")):(n(),s("span",vn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.mapping,"onUpdate:modelValue":t[60]||(t[60]=e=>_l.value.mapping=e),disabled:!Sl.value.c?.map},{default:h(()=>[k(u(z)+" ",1),Sl.value.c?.map?Vl.value.mapping?o("",!0):(n(),s("span",yn,"(与现有设置一致)")):(n(),s("span",mn,"- 备份文件中未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.weekCorrection,"onUpdate:modelValue":t[61]||(t[61]=e=>_l.value.weekCorrection=e),disabled:!Sl.value.c?.weekCorrections},{default:h(()=>[k(u(U)+" ",1),Sl.value.c?.weekCorrections?Vl.value.weekCorrection?o("",!0):(n(),s("span",gn,"(与现有设置一致)")):(n(),s("span",fn,"- 未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.playerCorrection,"onUpdate:modelValue":t[62]||(t[62]=e=>_l.value.playerCorrection=e),disabled:!Sl.value.c?.playerCorrections},{default:h(()=>[k(u(P)+" ",1),Sl.value.c?.playerCorrections?Vl.value.playerCorrection?o("",!0):(n(),s("span",kn,"(与现有设置一致)")):(n(),s("span",hn,"- 未发现数据"))]),_:1},8,["modelValue","disabled"]),c(p(Ne),{modelValue:_l.value.settings,"onUpdate:modelValue":t[63]||(t[63]=e=>_l.value.settings=e),disabled:!Sl.value.c?.filter&&void 0===Sl.value.c?.raidActive},{default:h(()=>[k(u(J)+" ",1),Sl.value.c?.filter||void 0!==Sl.value.c?.raidActive?Vl.value.settings?o("",!0):(n(),s("span",wn,"(与现有设置一致)")):(n(),s("span",bn,"- 未发现数据"))]),_:1},8,["modelValue","disabled"])]),_l.value.bis&&Vl.value.bis||_l.value.roles&&Vl.value.roles||_l.value.mapping&&Vl.value.mapping||_l.value.weekCorrection&&Vl.value.weekCorrection||_l.value.playerCorrection&&Vl.value.playerCorrection||_l.value.settings&&Vl.value.settings?(n(),s("div",_n,[c(m,null,{default:h(()=>[c(p(he))]),_:1}),t[173]||(t[173]=d("span",null,"所选配置项导入后将覆盖当前设置",-1))])):!(_l.value.bis||_l.value.roles||_l.value.mapping||_l.value.weekCorrection||_l.value.playerCorrection||_l.value.settings)||Vl.value.bis||Vl.value.roles||Vl.value.mapping||Vl.value.weekCorrection||Vl.value.playerCorrection||Vl.value.settings?o("",!0):(n(),s("div",Cn,[c(m,null,{default:h(()=>[c(p(al))]),_:1}),t[174]||(t[174]=d("span",null,"所选配置项已与本地同步，无需重复导入",-1))]))])):o("",!0)]),_:1},8,["modelValue"]),c(p(we),{modelValue:Bl.value,"onUpdate:modelValue":t[76]||(t[76]=e=>Bl.value=e),title:"清空数据选项",width:"400px","append-to-body":"","destroy-on-close":""},{footer:h(()=>[d("span",$n,[c(f,{onClick:t[75]||(t[75]=e=>Bl.value=!1)},{default:h(()=>[...t[182]||(t[182]=[k("取消",-1)])]),_:1}),c(f,{type:"danger",onClick:Gi},{default:h(()=>[...t[183]||(t[183]=[k("确定清空",-1)])]),_:1})])]),default:h(()=>[Bl.value?(n(),s("div",Sn,[d("div",xn,[t[180]||(t[180]=d("p",{class:"clear-warning-text"},"请选择要彻底删除的数据项：",-1)),d("div",En,[c(f,{link:"",type:"primary",size:"small",onClick:t[66]||(t[66]=e=>$l.value={loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0,settings:!0})},{default:h(()=>[...t[178]||(t[178]=[k("全选",-1)])]),_:1}),c(f,{link:"",size:"small",onClick:t[67]||(t[67]=e=>$l.value={loot:!$l.value.loot,bis:!$l.value.bis,roles:!$l.value.roles,mapping:!$l.value.mapping,weekCorrection:!$l.value.weekCorrection,playerCorrection:!$l.value.playerCorrection,settings:!$l.value.settings})},{default:h(()=>[...t[179]||(t[179]=[k("反选",-1)])]),_:1})])]),c(p(Ne),{modelValue:$l.value.loot,"onUpdate:modelValue":t[68]||(t[68]=e=>$l.value.loot=e)},{default:h(()=>[k(u(y)+" ("+u(cl.value.length)+")",1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.roles,"onUpdate:modelValue":t[69]||(t[69]=e=>$l.value.roles=e)},{default:h(()=>[k(u(D),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.bis,"onUpdate:modelValue":t[70]||(t[70]=e=>$l.value.bis=e)},{default:h(()=>[k(u(M),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.mapping,"onUpdate:modelValue":t[71]||(t[71]=e=>$l.value.mapping=e)},{default:h(()=>[k(u(z),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.weekCorrection,"onUpdate:modelValue":t[72]||(t[72]=e=>$l.value.weekCorrection=e)},{default:h(()=>[k(u(U),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.playerCorrection,"onUpdate:modelValue":t[73]||(t[73]=e=>$l.value.playerCorrection=e)},{default:h(()=>[k(u(P),1)]),_:1},8,["modelValue"]),c(p(Ne),{modelValue:$l.value.settings,"onUpdate:modelValue":t[74]||(t[74]=e=>$l.value.settings=e)},{default:h(()=>[k(u(J)+" (重置)",1)]),_:1},8,["modelValue"])])):o("",!0),d("div",Bn,[c(m,null,{default:h(()=>[c(p(he))]),_:1}),t[181]||(t[181]=d("span",null,"选中的数据将被永久删除，无法撤销。",-1))])]),_:1},8,["modelValue"]),c(p(we),{modelValue:fl.value,"onUpdate:modelValue":t[81]||(t[81]=e=>fl.value=e),title:"手动添加记录",width:"400px","append-to-body":"","destroy-on-close":""},{footer:h(()=>[d("span",Tn,[c(f,{onClick:t[80]||(t[80]=e=>fl.value=!1)},{default:h(()=>[...t[184]||(t[184]=[k("取消",-1)])]),_:1}),c(f,{type:"primary",onClick:Ui},{default:h(()=>[...t[185]||(t[185]=[k("确定添加",-1)])]),_:1})])]),default:h(()=>[fl.value?(n(),g(p(tl),{key:0,"label-width":"80px"},{default:h(()=>[c(p(sl),{label:"时间"},{default:h(()=>[c(C,{modelValue:xl.value.timestamp,"onUpdate:modelValue":t[77]||(t[77]=e=>xl.value.timestamp=e),type:"datetime",placeholder:"选择获得时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(p(sl),{label:"物品"},{default:h(()=>[c(p(ol),{modelValue:xl.value.item,"onUpdate:modelValue":t[78]||(t[78]=e=>xl.value.item=e),"fetch-suggestions":Mi,placeholder:"请输入物品名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),c(p(sl),{label:"获得者"},{default:h(()=>[c(p(ol),{modelValue:xl.value.player,"onUpdate:modelValue":t[79]||(t[79]=e=>xl.value.player=e),"fetch-suggestions":zi,placeholder:"请输入玩家名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})):o("",!0)]),_:1},8,["modelValue"]),c(p(we),{modelValue:Wl.value,"onUpdate:modelValue":t[85]||(t[85]=e=>Wl.value=e),title:"自定义修正管理",width:"850px","append-to-body":"","destroy-on-close":"",class:"premium-correction-dialog"},{default:h(()=>[Wl.value?(n(),s("div",On,[d("div",Rn,[d("div",{class:r(["nav-item",{active:"player"===Il.value}]),onClick:t[82]||(t[82]=e=>Il.value="player")},[d("div",Dn,[c(m,null,{default:h(()=>[c(p(de))]),_:1})]),d("div",Mn,[t[186]||(t[186]=d("div",{class:"nav-title"},"获得者修正",-1)),d("div",zn,u(Jl.value.length)+" 个条目",1)])],2),d("div",{class:r(["nav-item",{active:"week"===Il.value}]),onClick:t[83]||(t[83]=e=>Il.value="week")},[d("div",Un,[c(m,null,{default:h(()=>[c(p(el))]),_:1})]),d("div",Pn,[t[187]||(t[187]=d("div",{class:"nav-title"},"CD周数修正",-1)),d("div",Ln,u(Hl.value.length)+" 个条目",1)])],2),d("div",jn,[c(X,{modelValue:Fl.value,"onUpdate:modelValue":t[84]||(t[84]=e=>Fl.value=e),placeholder:"搜索内容...","prefix-icon":"Search",size:"small",clearable:""},null,8,["modelValue"])])]),d("div",An,[d("div",Wn,[d("h3",null,u("player"===Il.value?"获得者修正管理":"CD周数修正管理"),1),t[188]||(t[188]=d("p",null,"可以撤销手动进行的改动，恢复最原始的系统记录。",-1))]),d("div",Fn,[(n(!0),s(b,null,w("player"===Il.value?Jl.value:Hl.value,e=>(n(),s("div",{key:e.key,class:"correction-card-compact"},[d("div",In,[d("div",Nn,[d("div",{class:"item-name",title:e.itemName},u(e.itemName),9,Yn),d("div",Jn,u(Hi(e.record.timestamp)),1)]),d("div",Hn,[d("div",Kn,[d("div",qn,["player"===Il.value?(n(),g(Cl,{key:0,name:e.oldVal,role:$i(e.oldVal),"show-only-role":!1},null,8,["name","role"])):(n(),s("span",Xn,u(e.oldVal),1))])]),d("div",Gn,[c(m,null,{default:h(()=>[c(p(_e))]),_:1})]),d("div",Qn,[d("div",Zn,["player"===Il.value?(n(),g(Cl,{key:0,name:e.newVal,role:$i(e.newVal),"show-only-role":!1},null,8,["name","role"])):(n(),s("span",ei,u(e.newVal),1))])])]),d("div",li,[c(f,{type:"primary",link:"",size:"small",onClick:l=>function(e){if("player"===e.type){const l={...Ml.value};delete l[e.key],Ml.value=l}else{const l={...Dl.value};delete l[e.key],Dl.value=l}Ce.success("已还原该条修正项")}(e)},{default:h(()=>[c(m,null,{default:h(()=>[c(p(Me))]),_:1}),t[189]||(t[189]=k(" 还原 ",-1))]),_:1},8,["onClick"])])])]))),128)),0===("player"===Il.value?Jl.value:Hl.value).length?(n(),s("div",ai,[c(m,{class:"empty-icon"},{default:h(()=>[c(p(al))]),_:1}),t[190]||(t[190]=d("p",null,"暂无符合条件的修正项",-1))])):o("",!0)])])])):o("",!0)]),_:1},8,["modelValue"])],64)),d("input",{ref_key:"importInputRef",ref:Pi,type:"file",accept:".json",style:{display:"none"},onChange:Ni},null,544)],2)}}}),[["__scopeId","data-v-df5518e9"]]);export{si as default};
