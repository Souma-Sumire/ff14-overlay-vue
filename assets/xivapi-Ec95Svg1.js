const t=new URLSearchParams(window.location.href.split("?")[1]).get("api"),e="cafemaker.wakingsands.com",n="xivapi.com",r=new Map,o={first:`https://${"xivapi"===(null==t?void 0:t.toLowerCase())?n:e}`,second:`https://${"xivapi"===(null==t?void 0:t.toLowerCase())?e:n}`},a={get random(){return Math.floor(864e5*Math.random()*11)+216e7}},c=new Map(Object.entries({"任务指令":"/i/000000/000123.png","冲刺":"/i/000000/000104.png","坐骑":"/i/000000/000118.png","攻击":"/i/000000/000101.png","腐秽大地":"/i/003000/003090.png"})),s="souma-action-cache",i=JSON.parse(localStorage.getItem(s)||"[]"),g=Date.now(),p=i.filter(((t,e)=>t.expirationTime>=g&&e<1e3));localStorage.setItem(s,JSON.stringify(p));const u=/(\d{6})\/(\d{6})\.png$/;async function f(t,e,n=["ID","Icon","ActionCategoryTargetID"]){if(r.has(e))return r.get(e);const a=function(t,e,n){const r=`${o.first}/${t}/${e}?columns=${n.join(",")}`;return[r,r.replace(o.first,o.second)]}(t,e,n);try{const t=await w(a,{mode:"cors"});return r.set(e,t),t}catch(c){return Promise.resolve({ActionCategoryTargetID:0,ID:e,Icon:"/i/000000/000405.png"})}}async function l(t,e=!1){return`${o.first}${t}`.replace(u,((t,n,r)=>`${n}/${e?"hq/":""}${r}.png`))}async function m(t){return l((await f("action",t,["Icon"])).Icon)}async function d(t){const n=c.get(t);if(n)return{ActionCategoryTargetID:0,ID:0,Icon:n};const r=i.find((e=>e.name===t));if(null==r?void 0:r.action)return r.action;try{const n=(await w([`https://${e}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(t)}`])).Results[0];if(n){const e=Date.now()+a.random,r={name:t,action:n,expirationTime:e};return i.push(r),localStorage.setItem(s,JSON.stringify(i)),n}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(o){throw new Error("Failed to retrieve action data")}}async function h(t,e){let n;const r=new Promise(((t,r)=>{n=setTimeout((()=>{r(new Error("Promise timed out"))}),e)}));return Promise.race([t,r]).finally((()=>{clearTimeout(n)}))}async function w(t,e){const n=Object.assign({cache:"force-cache"},e);for(const r of t)try{const t=await h(fetch(r,n),3e3);if(t.ok){const e=await t.json(),n=new URL(r).host;return{...e,Host:n}}}catch{}throw new Error("All fetch attempts failed.")}const $=new Map;function I(t){return $.has(t)?$.get(t):`${o.first}${t}`}function y(t){var e;const n=t.target,r=null==(e=n.src.match(new RegExp("(?<=\\.\\w+)\\/.+$")))?void 0:e[0];r&&""!==n.src&&(/pictomancer\.png$/.test(n.src)?n.src="//souma.diemoe.net/resources/img/pictomancer.png":/viper\.png$/.test(n.src)?n.src="//souma.diemoe.net/resources/img/viper.png":n.src.includes(o.first)?n.src=n.src.replace(o.first,o.second):n.src="",$.set(r,n.src))}export{d as a,l as b,m as c,r as d,I as g,y as h,f as p,o as s};
