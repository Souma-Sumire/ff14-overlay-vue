import{Q as e,W as a,a0 as i,a1 as s,a as r,k as t,m as n,a2 as l,a3 as o,f as c}from"./element-plus-901ad096.js";import{k as d,r as m,J as p,L as u,l as y,o as f,q as g,aR as h,aW as b,c as v,x as k,y as w,B as F,E as C,u as N,D as I,A as j,F as $,ae as E,aY as _,a_ as T,G as A,U as D,a8 as x,aP as L,aH as S,aX as H,aS as O,z as P,H as z,d as R,S as M,al as W}from"./vue-49c48d91.js";import{_ as G}from"./_plugin-vue_export-helper-6a8c15be.js";import{s as K,c as B,a as U}from"./res-status-9bc9036c.js";import{c as Z}from"./clipboard-e5e2548c.js";import{U as V}from"./util-3591e9ca.js";import{h as J,g as q}from"./xivapi-72ab0990.js";import{u as Y}from"./useDev-861d544b.js";import{g as Q}from"./res-action-f84fe53b.js";import{N as X,a as ee,l as ae}from"./cactbot-49e370f3.js";import"./vendor-979eac9e.js";const ie={class:"upload select"},se=G(d({__name:"TestLog",emits:["handleLine","beforeHandle","afterHandle"],setup(a,{emit:i}){const s=i,r=m(null),t=m(null);async function n(a){t.value?.classList.remove("drag");const i=a.target.files;if(!i||0===i.length)return;s("beforeHandle");const r=e.service({fullscreen:!0,text:"正在解析……请稍候",lock:!0,spinner:'<div style="width:0;height:0"></div>'});for(let e=0;e<i.length;e++){const a=i[e],r=await a.text();for(const e of r.split("\n"))s("handleLine",e)}r.close(),s("afterHandle"),t.value?.classList.remove("drag")}function l(e){e.preventDefault(),t.value?.classList.add("drag")}function o(e){e.preventDefault(),t.value?.classList.remove("drag")}return p(()=>{r.value?.addEventListener("change",n),t.value?.addEventListener("dragover",l),t.value?.addEventListener("dragleave",o)}),u(()=>{r.value?.removeEventListener("change",n),t.value?.removeEventListener("dragover",l),t.value?.removeEventListener("dragleave",o)}),(e,a)=>(f(),y("div",ie,[g("div",{ref_key:"select",ref:t,class:"upload-select"},[a[0]||(a[0]=g("div",{class:"upload text"},[g("span",null,"+"),g("p",null,"上传或拖入ACT日志")],-1)),g("input",{ref_key:"input",ref:r,type:"file"},null,512)],512)]))}}),[["__scopeId","data-v-6722092f"]]),re=[{name:"铁壁",id:1191,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"盾阵",id:1856,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"干预",id:1174,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"预警",id:74,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"武装",id:1176,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"神圣领域",id:82,type:"multiplier",performance:{physics:0,magic:0,darkness:0},isFriendly:!0},{name:"圣光幕帘",id:1362,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"圣盾阵",id:2674,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"骑士的坚守",id:2675,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"壁垒",id:77,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"极致防御",id:3829,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"极致护盾",id:3830,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的直觉",id:735,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的勇猛",id:1857,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的武猛",id:1858,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"战栗",id:87,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"复仇",id:89,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"摆脱",id:1457,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死斗",id:409,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的血气",id:2678,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的血潮",id:2679,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"原初的血烟",id:2680,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"戮罪",id:3832,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"至黑之夜",id:1178,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"弃明投暗",id:746,type:"multiplier",performance:{physics:.9,magic:.8,darkness:1},isFriendly:!0},{name:"暗影墙",id:747,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"暗黑布道",id:1894,type:"multiplier",performance:{physics:.95,magic:.9,darkness:1},isFriendly:!0},{name:"暗影卫",id:3835,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"行尸走肉",id:810,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死而不僵",id:811,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"出死入生",id:3255,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"献奉",id:2682,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"石之心",id:1840,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"残暴弹",id:1898,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"伪装",id:1832,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"星云",id:1834,type:"multiplier",performance:{physics:.7,magic:.7,darkness:1},isFriendly:!0},{name:"光之心",id:1839,type:"multiplier",performance:{physics:.95,magic:.85,darkness:1},isFriendly:!0},{name:"超火流星",id:1836,type:"multiplier",performance:{physics:0,magic:0,darkness:0},isFriendly:!0},{name:"刚玉之心",id:2683,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"刚玉之清",id:2684,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"神祝祷",id:1218,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"节制",id:1873,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"水流幕",id:2708,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"鼓舞",id:297,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"激励",id:1918,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"炽天的幕帘",id:1917,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"野战治疗阵",id:299,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"异想的幻光",id:317,type:"multiplier",performance:{physics:1,magic:.95,darkness:1},isFriendly:!0},{name:"炽天的幻光",id:1875,type:"multiplier",performance:{physics:1,magic:.95,darkness:1},isFriendly:!0},{name:"生命回生法",id:2710,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"怒涛之计",id:2711,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"命运之轮",id:849,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"天星交错",id:1889,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"擢升",id:2717,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"中间学派",id:1921,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡诊断",id:2607,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"齐衡诊断",id:2608,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡预后",id:2609,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"坚角清汁",id:2618,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"白牛清汁",id:2619,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"整体论",id:3003,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"整体盾",id:3365,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"输血",id:2612,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"泛输血",id:2613,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"心眼",id:1232,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"金刚极意",id:1179,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"行吟",id:1934,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"策动",id:1951,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"防守之桑巴",id:1826,type:"multiplier",performance:{physics:.85,magic:.85,darkness:1},isFriendly:!0},{name:"即兴表演结束",id:2697,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"残影",id:488,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"魔罩",id:168,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护之光",id:2702,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护纹",id:2597,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"抗死",id:2707,type:"multiplier",performance:{physics:1,magic:.9,darkness:1},isFriendly:!0},{name:"雪仇",id:1193,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"牵制",id:1195,type:"multiplier",performance:{physics:.9,magic:.95,darkness:1},isFriendly:!1},{name:"昏乱",id:1203,type:"multiplier",performance:{physics:.95,magic:.9,darkness:1},isFriendly:!1},{name:"武装解除",id:860,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"减速",id:9,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"体力增加",id:2120,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"腐臭",id:1715,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!1},{name:"智力精神降低",id:2115,type:"multiplier",performance:{physics:1,magic:.9,darkness:1},isFriendly:!1},{name:"龙之力",id:2500,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"超硬化",id:1722,type:"multiplier",performance:{physics:.1,magic:.1,darkness:1},isFriendly:!0},{name:"玄结界",id:2496,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"仙人盾",id:2119,type:"multiplier",performance:{physics:.95,magic:.95,darkness:1},isFriendly:!0},{name:"强力守护",id:1719,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"哥布防御",id:2114,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"铜墙铁盾",id:194,type:"multiplier",performance:{physics:.8,magic:.8,darkness:1},isFriendly:!0},{name:"坚守要塞",id:195,type:"multiplier",performance:{physics:.6,magic:.6,darkness:1},isFriendly:!0},{name:"终极堡垒",id:196,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"原初大地",id:863,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"暗黑之力",id:864,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"灵魂之青",id:1931,type:"multiplier",performance:{physics:.2,magic:.2,darkness:1},isFriendly:!0},{name:"坦培拉涂层",id:3686,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"油性坦培拉涂层",id:3687,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"世界树之干",id:3890,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"建筑神之塔",id:3892,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"太阳星座",id:3896,type:"multiplier",performance:{physics:.9,magic:.9,darkness:1},isFriendly:!0},{name:"神爱抚",id:3903,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0}],te=[...re],ne=new Map;let le="Chinese";function oe(e){if(le!==e||0===ne.size){ne.clear();for(const a of"Chinese"===e?re:te){const e=K[a.id][1];a.fullIcon=B(e),ne.set(a.id.toString(16).toUpperCase().padStart(2,"0"),a)}le=e}}function ce(e){return ne.get(e)}function de(e,a){if("absorbed"===e.type)return"useful";if("dot"===a||"darkness"===a)return"unuseful";if(0===e.performance.darkness&&0===e.performance.magic&&0===e.performance.physics||1===e.performance.darkness&&1===e.performance.magic&&1===e.performance.physics)return"useful";const i="physics"===a?"magic":"physics";return 2*(100-100*e.performance[a])===100-100*e.performance[i]?"half-useful":1===e.performance[a]?"unuseful":"useful"}oe("Chinese");function me(e,a){return Object.entries(K).reduce((i,[s,[r,t]])=>(e.test(r)&&i.set(s,{name:r,icon:t,isFriendly:a}),i),new Map)}const pe=me(/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/,!0),ue=me(/(?:精神|力量|灵巧|智力){1,2}(?:大幅)?降低/,!1),ye=b("hash"),fe=h("keigennRecord2.1",{state:()=>({userOptions:{scale:v(()=>ge(ye.scale,1)),opacity:v(()=>ge(ye.opacity,.9)),targetType:v(()=>ge(ye.targetType,"icon")),iconType:v(()=>ge(ye.iconType,3)),parseAA:v(()=>ge(ye.parseAA,!0)),parseDoT:v(()=>ge(ye.parseDoT,!1)),minimize:v(()=>ge(ye.minimize,!1)),actionCN:v(()=>ge(ye.actionCN,!0)),statusCN:v(()=>ge(ye.statusCN,!0))},isBrowser:!1}),getters:{icon4k:e=>e.userOptions.scale>=2||window.devicePixelRatio>=2?"_hr1":""},actions:{checkIsBrowser(){this.isBrowser=!window.OverlayPluginApi&&!ye.OVERLAY_WS&&!ye.HOST_PORT,this.isBrowser&&setTimeout(()=>this.checkIsBrowser(),1e3)},formatterName:e=>e,initEnvironment(e){/^[A-Z]\S+ [A-Z]\S+$/.test(e)?oe("Global"):oe("Chinese")}}});function ge(e,a){return"boolean"==typeof a?"0"!==e&&"false"!==e?.toLocaleLowerCase()&&("1"===e||"true"===e?.toLocaleLowerCase()||a):"number"==typeof a?Number.isNaN(+e)?a:+e:"string"==typeof a?e:a}function he(e){return{dodge:"闪避","damage done":"击中","blocked damage":"格挡","parried damage":"招架","instant death":"即死",heal:"治疗","crit heal":"暴击治疗"}[e]}function be(e){const a=function(e){switch(!0){case e.endsWith("33"):return"instant death";case/2\w{4}4$/.test(e):return"crit heal";case e.endsWith("1"):return"dodge";case e.endsWith("3"):return"damage done";case e.endsWith("4"):return"heal";case e.endsWith("5"):return"blocked damage";case e.endsWith("6"):return"parried damage";default:throw new Error(`Unknown effect flag ${e}`)}}(e),i=function(e){switch(!0){case/2\w{3}$/.test(e):return"crit damage";case/4\w{3}$/.test(e):return"direct hit damage";case/6\w{3}$/.test(e):return"crit direct hit damage";default:return"damage"}}(e),s=function(e){switch(!0){case/7?[1-4]\w{3}[35]$/.test(e):case/[16]$/.test(e):return"physics";case/^E$/.test(e):case/5\w{4}$/.test(e):return"magic";case/^(?:\d0)?3$/.test(e):case/6\w{4}$/.test(e):return"darkness";default:return"physics"}}(e);return{effect:a,properties:i,type:s}}const ve=["3E","113","213","313"],ke=["A10","E"],we=["04"],Fe=["01","03","05","06","36"];function Ce(e){let a=0,i=e[8]??"",s=e[9]??"";ve.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s),ke.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s);const r=function(e){if(void 0===e)return 0;const a=e.length;if(a<=4)return 0;let i=Number.parseInt(e.slice(0,a-4),16);if("4"===e[a-4]){const s=Number.parseInt(e.slice(a-2,a),16);i=i-s+(s<<16)}return i}(s),t=`00${i}`.slice(-2);return{amount:r,lowByte:t,flags:i,isHeal:we.includes(t),isAttack:Fe.includes(t)}}const Ne=[Number(409).toString(16).toUpperCase(),Number(810).toString(16).toUpperCase(),Number(811).toString(16).toUpperCase(),Number(1836).toString(16).toUpperCase()];const Ie={class:"amount"},je={class:"row-info"},$e=G(d({__name:"Amount",props:{row:{}},setup(e){const i=e,s=fe().userOptions,{amount:r,maxHp:t,currentHp:n,shield:l,source:o,target:c,type:d,keigenns:m,effect:p}=i.row,u=Math.round(t*+l/100),h=Math.round(n/t*100),b=n-r,E=Math.round(b/t*100);let _=0;if("instant death"!==p&&"dodge"!==p){let e=1;"blocked damage"===p?e=.8:"parried damage"===p&&(e=.85);let a=1;for(const i of m)"absorbed"!==i.type&&(a*=i.performance[d]??1);_=1-a*e}const T=(r&&Math.round((r+u)/(1-_))||0).toLocaleString(),A=(100*_).toFixed(2),D=v(()=>r.toLocaleString()),x=v(()=>s.actionCN?i.row.actionCN:i.row.action),L=d,S=(H=i.row).currentHp-H.amount<0&&!H.keigenns.find(e=>Ne.includes(e.effectId));var H;const O=(()=>{const e=[u>0?"有盾不准":"",m.find(e=>e.name.includes("受伤加重"))?"不算易伤":""].filter(Boolean);return e.length?`（${e.join("、")}）`:""})();return(e,i)=>{const s=a;return f(),k(s,{"append-to":".wrapper",title:N(x),trigger:"hover",enterable:!1,"hide-after":0,width:220},{reference:w(()=>[g("span",Ie,[g("span",{class:j(N(L))},[g("span",{class:j({lethal:N(S)})},C(N(D)),3)],2)])]),default:w(()=>[g("ul",je,[g("li",null,"来源: "+C(N(o)),1),g("li",null,"目标: "+C(N(c)),1),g("li",null,"护盾: "+C(N(u))+" ("+C(N(l))+"%)",1),g("li",null,"血量: "+C(N(n))+"/"+C(N(t))+" ("+C(N(h))+"%)",1),g("li",null,[i[0]||(i[0]=I(" 伤害: ",-1)),g("span",{class:j(N(L))},C(N(D)),3)]),g("li",null,"血量剩余: "+C(b)+" ("+C(N(E))+"%)",1),N(_)<1&&"dot"!==N(d)?(f(),y($,{key:0},[i[3]||(i[3]=g("hr",{class:"divider"},null,-1)),g("li",null,[i[1]||(i[1]=I("玩家减伤率: ",-1)),g("strong",null,C(N(A))+"%",1)]),g("li",null,[i[2]||(i[2]=I(" 倒推裸吃伤害: ",-1)),g("span",{class:j(N(L))},C(N(T)),3)]),g("li",null,C(N(O)),1)],64)):F("",!0)])]),_:1},8,["title"])}}}),[["__scopeId","data-v-96480248"]]),Ee={key:0},_e={key:1,class:"status-container"},Te=["title","data-duration","data-sourcePov"],Ae=["src","alt"],De={class:"flags"},xe=G(d({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=fe(),s=i.userOptions,r=i.icon4k;return(e,i)=>"dot"===a.row.type?(f(),y("div",Ee," （不支持） ")):(f(),y("div",_e,[(f(!0),y($,null,E(a.row.keigenns,(e,t)=>(f(),y("span",{key:t},[g("span",{class:"status",title:`${N(s).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[g("img",{class:j(`statusIcon ${N(de)(e,a.row.type)}`),src:N(q)(`/i/${e.fullIcon}${N(r)}.png`),alt:e.effect,loading:"lazy",onError:i[0]||(i[0]=(...e)=>N(J)&&N(J)(...e))},null,42,Ae)],8,Te)]))),128)),g("span",De,C("damage done"===a.row.effect?"":N(he)(a.row.effect)),1)]))}}),[["__scopeId","data-v-9b1eaeae"]]),Le={class:"target"},Se=["src","alt"],He={key:1,class:"alt-text"},Oe=G(d({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=fe(),s=m(!1);function r(e){s.value=!0;e.target.style.display="none"}const t=v(()=>!s.value&&"icon"===(i.userOptions.targetType??"icon"));return(e,s)=>{return f(),y("div",Le,[N(t)?(f(),y("img",{key:0,class:j(`jobIcon cj${N(i).userOptions.iconType}`),src:(n=a.row.jobIcon,l=N(i).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${l}/${n.replace(/([A-Z])/g," $1").trim()}.png`),alt:a.row.jobIcon,onError:r},null,42,Se)):(f(),y("span",He,C(a.row.job),1))]);var n,l}}}),[["__scopeId","data-v-0c7a0405"]]),Pe="[取消筛选]",ze=G(d({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const a=e,l=fe().userOptions,o=_("contextMenu"),c=m(""),d=m(""),p=m(!1),u=m(0),h=m(0),b=m(null);T(o,()=>{p.value=!1});const I=v(()=>[Pe,...Array.from(new Set(a.rows.map(e=>e[a.actionKey])))]),j=v(()=>[{label:"[取消筛选]",value:"",job:-1},...Array.from(new Map(a.rows.map(e=>[e.target,e])).values()).map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,a)=>V.enumSortMethod(e.job,a.job)));function $(){if(b.value){const e=b.value[a.actionKey];c.value===e?c.value="":c.value=e,p.value=!1}}function E(){if(b.value){const e=b.value.target;d.value===e?d.value="":d.value=e,p.value=!1}}const L=v(()=>a.rows.filter(e=>{const i=!c.value||c.value===Pe||e[a.actionKey]===c.value,s=!d.value||d.value===Pe||e.target===d.value;return i&&s})),S=v(()=>[{key:"time",title:"时间",dataKey:"time",width:40,align:"center",class:"col-time"},{key:"action",title:"技能",dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:c.value,placeholder:"技能",clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>c.value=e===Pe?"":e},()=>I.value.map(e=>x(n,{key:e,label:e,value:e})))]),cellRenderer:({rowData:e})=>x("span",e[a.actionKey]??"")},{key:"target",title:"职业",dataKey:"target",width:32,align:"center",class:"col-target",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:d.value,placeholder:"职业",clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{d.value=e===Pe?"":e}},()=>j.value.map(e=>x(n,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>x(Oe,{row:e})},{key:"amount",title:"伤害",dataKey:"amount",width:45,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>x($e,{row:e})},{key:"keigenns",title:"减伤",dataKey:"keigenns",width:100,align:"left",flexGrow:1,class:"col-keigenns",cellRenderer:({rowData:e})=>x(xe,{row:e})}]);let H=null;const O=v(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:i,job:s,keigenns:t,time:n,type:o,effect:c,currentHp:d,maxHp:m,shield:p}=e,u="damage done"===c?"":`,${he(c)}`,y=`${n} ${s} ${a} ${i.toLocaleString()}(${f=o,{physics:"物理",magic:"魔法",darkness:"暗黑",dot:"持续伤害"}[f]}) 减伤:${0===t.length&&""===u?"无":t.map(e=>l.statusCN?e.name:e.effect).join(",")+u} HP:${d}/${m}(${Math.round(d/m*100)}%)+盾:${Math.round(m*+p/100)}(${p}%)`;var f;Z(y).then(()=>{H?.close(),H=r.success({message:"复制成功",duration:800})}).catch(()=>r.error("复制失败"))},onContextmenu:({rowData:e,event:a})=>{const i=a;b.value=e,u.value=i.clientX,h.value=i.clientY,p.value=!0}}));return(e,a)=>{const r=s,t=i;return f(),k(t,{style:{height:"100%",width:"100%"}},{default:w(({height:a,width:i})=>[A(r,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:S.value,data:L.value,width:i,height:a,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":O.value},null,8,["columns","data","width","height","row-event-handlers"]),N(p)?(f(),y("div",{key:0,ref_key:"contextMenu",ref:o,class:"context-menu",style:D({top:`${N(h)}px`,left:`${N(u)}px`})},[g("ul",null,[g("li",{onClick:$},C(N(c)===(N(b)?.[e.actionKey]??"")?`取消筛选 [${N(b)?.[e.actionKey]??"此技能"}]`:`只看 [${N(b)?.[e.actionKey]??"此技能"}]`),1),g("li",{onClick:E},C(N(d)===N(b)?.target?`取消筛选 [${N(b)?.job??"此职业"}]`:`只看 [${N(b)?.job??"此职业"}]`),1)])],4)):F("",!0)]),_:1})}}}),[["__scopeId","data-v-06d51d88"]]),Re="function"==typeof structuredClone?structuredClone:e=>{if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e.source,e.flags);if(Array.isArray(e))return e.map(e=>Re(e));if(Object.getPrototypeOf(e)===Object.prototype){const a={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(a[i]=Re(e[i]));return a}return e},Me={class:"header-select"},We={style:{height:"100%"}},Ge={key:0,class:"testLog"},Ke="souma-keigenn-record-2",Be=G(d({__name:"keigennRecord2",setup(e){const a=Y(),i=fe(),s=i.userOptions;i.checkIsBrowser();const r=m(s.minimize),d=v(()=>s.actionCN?"actionCN":"action"),u=m(!1);let h=!1;const b=L("keigenn-record-2-pov-name",""),C=L("keigenn-record-2-pov-id",""),_=L("keigenn-record-2-party-list",[]),T=L("keigenn-record-2-job-map",{}),x=L("keigenn-record-2-party-event-party",[]),G=m(0),K=m([{zoneName:"",duration:"00:00",table:S([]),key:"init",timestamp:-1}]),Z={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:X.ability(),statusEffectExplicit:X.statusEffectExplicit(),gainsEffect:X.gainsEffect(),losesEffect:X.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:X.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:X.addedCombatant(),removingCombatant:X.removingCombatant(),networkDoT:X.networkDoT()},J=m(0),q=L("souma-keigenn-record-2-zone-name",""),ie=L("souma-keigenn-record-2-rsv-data",{}),re={},te={friendly:{},enemy:{}};function ne(){var e;u.value=!0,h=!1,J.value=0,G.value=0,K.value.length=0,K.value.push({zoneName:"",duration:"00:00",table:S([]),key:"placeholder",timestamp:-1}),(e=K.value[0]).table.length=0,e.zoneName="",e.duration="00:00",e.key="init",ge()}function le(){K.value=K.value.filter(e=>"00:00"!==e.duration&&0!==e.table.length),h=!0,u.value=!1}function oe(e){for(const a in Z){const r=Z[a].exec(e);if(r){const t=e.split("|");switch(a){case"statusEffectExplicit":r.groups?.targetId.startsWith("1")&&(re[r.groups.targetId]=r.groups.currentShield);break;case"gainsEffect":{const e=t[ae.GainsEffect.fields.effectId],a=t[ae.GainsEffect.fields.effect],i=t[ae.GainsEffect.fields.target],s=t[ae.GainsEffect.fields.targetId],r=Number.parseInt(t[ae.GainsEffect.fields.count],16);let n=ce(e);if(!n){const a=s.startsWith("1")&&pe.get(Number.parseInt(e,16).toString())||s.startsWith("4")&&ue.get(Number.parseInt(e,16).toString());if(!a)return;const i=B(a.icon),t=r>1?U(i,r):i;n={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(e,16),fullIcon:t,name:a.name,isFriendly:a.isFriendly}}const l=t[ae.GainsEffect.fields.duration],o=t[ae.GainsEffect.fields.source],c=t[ae.GainsEffect.fields.sourceId],d=new Date(t[ae.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),m={name:n.name,type:n.type,count:r,effect:a,effectId:e,source:o,sourceId:c,target:i,targetId:s,expirationTimestamp:d,performance:n.performance,fullIcon:n.fullIcon,isPov:C.value===c};s.startsWith("1")&&n.isFriendly?(void 0===te.friendly[s]&&(te.friendly[s]={}),te.friendly[s][e]=m):s.startsWith("4")&&!n.isFriendly&&(void 0===te.enemy[i]&&(te.enemy[i]={}),te.enemy[i][e]=m)}break;case"losesEffect":{const e=t[ae.LosesEffect.fields.target],a=t[ae.LosesEffect.fields.targetId],i=t[ae.LosesEffect.fields.effectId];a.startsWith("1")?te.friendly[a]&&Reflect.deleteProperty(te.friendly[a],i):te.enemy[e]&&Reflect.deleteProperty(te.enemy[e],i)}break;case"addCombatant":if("00"!==t[ae.AddedCombatant.fields.job]){const e=t[ae.AddedCombatant.fields.job],a=new Date(t[ae.AddedCombatant.fields.timestamp]).getTime();T.value[t[ae.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a}}break;case"removingCombatant":Reflect.deleteProperty(T.value,t[ae.RemovedCombatant.fields.id]);break;case"primaryPlayer":{C.value=t[ae.ChangedPlayer.fields.id];const e=t[ae.ChangedPlayer.fields.name];if(b.value===e)return;b.value=e,i.initEnvironment(t[ae.ChangedPlayer.fields.name])}break;case"partyList":_.value=r.groups?.list?.split("|")??[];break;case"changeZone":q.value=t[ae.ChangeZone.fields.name],ye(new Date(t[ae.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const e="1"===t[ae.InCombat.fields.inACTCombat],a="1"===t[ae.InCombat.fields.inGameCombat],i=new Date(t[ae.InCombat.fields.timestamp]).getTime();if(e||a){if(J.value>0)return;return"placeholder"===K.value[0].key&&K.value.splice(0,1),0!==K.value[0].table.length&&(K.value.unshift({zoneName:"",duration:"00:00",table:S([]),key:t[ae.InCombat.fields.timestamp],timestamp:i}),K.value.length>=3&&K.value.splice(K.value.length-1,1)),J.value=i,K.value[0].zoneName=q.value,void(G.value=0)}if(!e&&!a)return void ye(i)}break;case"rsv":{const e=Number(r.groups?.id),a=t[ae.RSVData.fields.value];e&&a&&(ie.value[Number(e)]=a)}break;case"networkDoT":if(!s.parseDoT)return;{const e=t[ae.NetworkDoT.fields.which],a=t[ae.NetworkDoT.fields.id];if("DoT"!==e||a.startsWith("4")||a!==C.value&&!_.value.includes(a)&&!x.value.find(e=>e.id===a))return;const i=t[ae.NetworkDoT.fields.name],s=t[ae.NetworkDoT.fields.damage],r=Number.parseInt(s,16),n=new Date(t[ae.Ability.fields.timestamp]??"???").getTime(),l=Number(t[ae.NetworkDoT.fields.currentHp]),o=Number(t[ae.NetworkDoT.fields.maxHp]),c=he(0===J.value?0:n-J.value),d=de(a),m=V.jobToFullName(V.jobEnumToJob(d)).simple2,p=d,u=V.jobEnumToIcon(p);me({key:K.value[0].table.length.toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:i,targetId:a,job:m,jobIcon:u,jobEnum:p,amount:r,keigenns:[],currentHp:l,maxHp:o,effect:"damage done",type:"dot",shield:re[a]??"0",povId:C.value})}break;case"ability":if(0===J.value)return;{const e=Ce(t);if(e.isAttack&&e.amount>=0){const a=t[ae.Ability.fields.sourceId]??"???",i=t[ae.Ability.fields.targetId]??"???";if(!a.startsWith("4")||!i.startsWith("1"))return;if(i!==C.value&&!_.value.includes(i)&&!x.value.find(e=>e.id===i))return;const n=new Date(t[ae.Ability.fields.timestamp]??"???").getTime(),l=t[ae.Ability.fields.ability],o=l.match(/^_rsv_(?<id>\d+)_/),c=t[ae.Ability.fields.id]??"???";let d=l;if(o){const e=Number(o.groups?.id);d=ie.value[e]??l.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(d=d.replace(/unknown_.*/,"攻击"),!1===s.parseAA&&/^攻击|攻撃|[Aa]ttack$/.test(d))return;const m=Q(Number.parseInt(c,16)),p=m&&""!==m?m:d,u=Number(t[ae.Ability.fields.targetCurrentHp])??"???",y=Number(t[ae.Ability.fields.targetMaxHp])??"???",f=t[ae.Ability.fields.source]??"???",g=t[ae.Ability.fields.target]??"???",{effect:h,type:b}=be(e.flags),v=he(0===J.value?0:n-J.value),k=de(i),w=V.jobToFullName(V.jobEnumToJob(k)).simple2,F=k,N=V.jobEnumToIcon(F),I=Re(Object.values(te.friendly[i]??[]).concat(Object.values(te.enemy[f]??[])).filter(e=>{const a=Math.max(0,(e.expirationTimestamp-n)/1e3);return e.remainingDuration=a>=999?"":a.toFixed(a>.05&&a<.95?1:0),Number(e.remainingDuration)>-3}));me({key:K.value[0].table.length.toString(),time:v,id:c,action:d,actionCN:p,source:f,target:g,targetId:i,job:w,jobIcon:N,jobEnum:F,amount:e.amount,keigenns:I,currentHp:u,maxHp:y,effect:h,type:b,shield:re[r.groups.targetId]??"0",povId:C.value}),K.value[0].duration=he(new Date(t[ae.Ability.fields.timestamp]).getTime()-J.value)}}}}}}function de(e){return[T.value[e],x.value.find(a=>a.id===e)??{job:0,timestamp:0}].sort((e,a)=>a.timestamp-e.timestamp)[0].job}function me(e){K.value[0].table.unshift(e)}function ye(e){0!==J.value&&(K.value[0].duration=he(e-J.value),K.value[0]=W(K.value[0]),J.value=0,te.friendly={},te.enemy={},ge())}function ge(){h&&localStorage.setItem(Ke,JSON.stringify(K.value.filter(e=>"placeholder"!==e.key&&e.timestamp>0).slice().sort((e,a)=>a.timestamp-e.timestamp).slice(0,3)))}function he(e){const a=Math.max(Math.floor(e/6e4),0),i=Math.max(Math.floor((e-6e4*a)/1e3),0);return`${a<10?"0":""}${a}:${i<10?"0":""}${i}`}function ve(){r.value=!r.value}function ke(){const e={...K.value[0].table[0],key:crypto.randomUUID()};K.value[0].table.unshift(e)}return i.isBrowser&&(b.value="测试用户"),""!==b.value&&i.initEnvironment(b.value),p(()=>{const e=H({storageKey:"keigenn-record-2-theme"}),a=O(e);!1===e.value&&a();for(const i in T.value){const e=T.value[i];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(T.value,i)}!function(){const e=localStorage.getItem(Ke);if(e)try{const a=JSON.parse(e);K.value.length=0,K.value.push(...a)}catch(a){throw K.value.length=0,a}}(),ee("LogLine",e=>{oe(e.rawLine)}),ee("PartyChanged",e=>{x.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),ee("ChangePrimaryPlayer",e=>{b.value=e.charName,C.value=Number(e.charID).toString(16).toUpperCase()})}),(e,m)=>{const p=n,u=t,h=c,b=ze,v=se;return f(),y($,null,[g("div",{class:"wrapper",style:D({"--scale":N(s).scale,"--opacity":N(s).opacity}),onContextmenu:m[1]||(m[1]=M(()=>{},["prevent"]))},[g("header",null,[g("div",Me,[P(A(u,{modelValue:N(G),"onUpdate:modelValue":m[0]||(m[0]=e=>R(G)?G.value=e:null),size:"small",class:j(["combat-select",N(i).isBrowser?"browser":"act"]),"popup-class-name":"combat-select-popup",offset:0,"show-arrow":!1},{default:w(()=>[(f(!0),y($,null,E(N(K).length,e=>(f(),k(p,{key:`${N(K)[e-1].key}-${N(K)[e-1].duration}-${N(K)[e-1].zoneName}`,value:e-1,label:`${N(K)[e-1].duration} ${N(K)[e-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[z,!N(r)]])]),N(i).isBrowser?F("",!0):(f(),k(h,{key:0,class:j(["minimize",N(r)?"in-minimize":"not-minimize"]),icon:N(r)?N(l):N(o),circle:"",style:D({opacity:N(r)?.5:1}),onClick:ve},null,8,["class","icon","style"]))]),P(g("main",We,[A(b,{rows:N(K)[N(G)].table,"action-key":N(d)},null,8,["rows","action-key"])],512),[[z,!N(r)]])],36),N(i).isBrowser||N(a)?(f(),y("div",Ge,[N(a)?(f(),k(h,{key:0,onClick:ke},{default:w(()=>m[2]||(m[2]=[I(" 测试 ",-1)])),_:1,__:[2]})):F("",!0),A(v,{"m-1":"",onBeforeHandle:ne,onAfterHandle:le,onHandleLine:oe})])):F("",!0)],64)}}}),[["__scopeId","data-v-b2ec4bd3"]]);export{Be as default};
