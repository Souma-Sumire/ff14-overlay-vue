import{_ as e,e as t}from"./shared-common-CQtq0auS.js";import{h as a,dx as n,x as l,w as o,dz as i,G as s,D as r,c,b as d,d as u,e as m,b8 as p,a as f,n as g,f as v,s as h,t as b,i as y,F as k,y as w,z as I,r as j,g as C,b2 as D,b9 as N,o as R,j as S,l as $,b7 as E,p as T,v as x,bW as A,cO as M,ch as _,cj as H}from"./vendor-vue-i6lpFrx4.js";import{u as L,ac as z,r as F,w as P,U as B,a9 as J,f as K,$ as O,Z as G,l as W,ad as U,t as V,ae as Z,af as q,ag as X,ah as Y,A as Q,ai as ee,aj as te,a7 as ae,ak as ne,s as le}from"./shared-core-Cqp6K9za.js";import{a as oe,E as ie,aC as se,aD as re,w as ce,J as de,t as ue,g as me,aE as pe,aF as fe,n as ge}from"./vendor-element-plus-C8e3lHeC.js";import{N as ve,a as he,l as be}from"./cactbot-DtpbXwrG.js";const ye={class:"table-container"},ke={class:"table-wrapper"},we={key:0,class:"row-info"},Ie={class:"info-line"},je={class:"info-line"},Ce={class:"info-line"},De={class:"info-line"},Ne={class:"info-line"},Re={key:1,class:"skill-popover-content"},Se={class:"subtitle"},$e={class:"skill-grid"},Ee=["title"],Te=["src"],xe={class:"skill-text"},Ae={class:"subtitle"},Me={class:"skill-grid"},_e=["title"],He=["src"],Le={key:2,class:"no-data"},ze=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e,{expose:t}){const{t:a}=L(),D=e,N=z(),R=N.userOptions,S=n("contextMenu"),$=l(""),E=l(""),T=l(null);o(()=>D.rows,e=>{0===e.length&&($.value="",E.value="",T.value=null)},{immediate:!0});const x=l(!1),A=l(0),M=l(0),_=l(null),H=l(null),J=l({getBoundingClientRect:()=>({top:0,left:0,bottom:0,right:0,width:0,height:0})}),K=l(null),O=l(!1),G=l("top");function W(e,t,a){K.value=t,G.value="skills"===t?"left":"right",H.value=e;const n=a.currentTarget;J.value={getBoundingClientRect:()=>n.getBoundingClientRect()},O.value=!0}function U(){O.value=!1}i(S,()=>{x.value=!1});const V=a("keigennRecord.cancelFilter"),Z=s(()=>{const e=Array.from(new Set(D.rows.map(e=>e[D.actionKey]))).filter(e=>null!=e);return[{label:V,value:""},...e.map(e=>({label:e,value:e}))]}),q=s(()=>{const e=Array.from(new Map(D.rows.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:V,value:"",job:-1},...e.map(e=>({label:e.job,fullLabel:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>B.enumSortMethod(e.job,t.job))});function X(){if(_.value){const e=_.value[D.actionKey];$.value===e?$.value="":$.value=e,x.value=!1}}function Y(){if(_.value){const e=_.value.targetId;E.value===e?E.value="":E.value=e,x.value=!1}}function Q(e){const t=e&&"object"==typeof e&&"key"in e?e:_.value;if(t&&"death"===t.type){E.value=t.targetId;const e=t.timestamp;T.value={endTime:e,windowBase:e-15e3,startTime:e-3e4},$.value="",x.value=!1}}function ee(){const e=null!==T.value;T.value=null,E.value="",e&&"push"===N.userOptions.order&&p(()=>be())}const te=(e,t="")=>r("div",{class:["header-static",t]},e),ae=()=>r("div"),ne=e=>r("div",{class:"header-filter"},[r(oe,{size:"small",modelValue:e.modelValue,placeholder:e.placeholder,clearable:!1,style:`width:${e.width}`,teleported:!0,popperClass:"keigenn-header-select-popper",onChange:e.onUpdate},()=>e.options.map(e=>r(ie,{key:e.value,label:e.label,value:e.value},{default:()=>e.fullLabel||e.label})))]),le=s(()=>{if(T.value){const e=E.value,{startTime:t,endTime:a,windowBase:n}=T.value,l=D.rows.filter(t=>t.targetId===e&&t.timestamp<=a),o=l.filter(e=>e.timestamp>=n);if(o.filter(e=>"death"!==e.type).length>=5)return o;const i=l.filter(e=>e.timestamp>=t),s=i.filter(e=>"death"!==e.type);if(s.length>=5){const e=s[4].timestamp;return i.filter(t=>t.timestamp>=e)}return i}return $.value&&$.value!==V||E.value&&E.value!==V?D.rows.filter(e=>{const t=!$.value||$.value===V||e[D.actionKey]===$.value,a=!E.value||E.value===V||e.targetId===E.value;return t&&a}):D.rows}),pe=({rowData:e})=>"death"===e.type?"row-death":"",fe=[{key:"time",title:a("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>te(a("keigennRecord.time"),"header-time")},{key:"action",title:a("keigennRecord.action"),dataKey:D.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>r(ne,{modelValue:$.value,options:Z.value,placeholder:a("keigennRecord.action"),width:"4.5em",onUpdate:e=>$.value=e===V?"":e}),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source,a=null!==T.value;return r("div",{class:"death-message-left"},[r("span","ðŸ’€ "),r("span",{class:"death-target-name"},e.target||"çŽ©å®¶"),r("span",t?[r("span"," å›  "),r("span",{class:"death-terrain"},"åœ°å½¢æ€"),r("span"," å€’ä¸‹äº†ï¼")]:[r("span"," è¢« "),r("span",{class:"death-source-name"},e.source||"çŽ¯å¢ƒ"),r("span"," åšæŽ‰äº†ï¼")]),r("span",{class:"death-recap-inline",onClick:t=>{t.stopPropagation(),a&&T.value?.endTime===e.timestamp&&E.value===e.targetId?ee():Q(e)}},a&&T.value?.endTime===e.timestamp&&E.value===e.targetId?" [é€€å‡ºå›žæ”¾]":" [æŸ¥çœ‹æ­»äº¡å›žæ”¾]")])}return r("span",e[D.actionKey]??"")}},{key:"target",title:a("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>r(ne,{modelValue:E.value,options:q.value,placeholder:a("keigennRecord.target"),width:"4.7em",onUpdate:e=>E.value=e===V?"":e}),cellRenderer:({rowData:e})=>"death"===e.type?ae():r("div",{class:"target"},[e.preCalculated.jobIconSrc?r("img",{class:[N.isBrowser?"browser":"act","jobIcon",`cj${N.userOptions.iconType}`],src:e.preCalculated.jobIconSrc,alt:e.jobIcon,onError:e=>{e.target.style.display="none"}}):r("span",{class:"alt-text"},e.job),e.hasDuplicate?r("span",{class:"has-duplicate"},N.formatterName(e.target)):void 0])},{key:"amount",title:a("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",headerCellRenderer:()=>te(a("keigennRecord.amount")),cellRenderer:({rowData:e})=>"death"===e.type?ae():r("span",{class:"amount",onMouseenter:t=>W(e,"amount",t),onMouseleave:U},[r("span",{class:e.preCalculated.damageTypeClass},e.preCalculated.amountDisplay)])},{key:"reduction",title:a("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>te(a("keigennRecord.reduction"),"header-reduction"),cellRenderer:({rowData:e})=>"death"===e.type?ae():r("span",{class:"col-reduction-number",style:{color:e.preCalculated.reductionColor}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:a("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",headerCellRenderer:()=>te(a("keigennRecord.keigenns")),cellRenderer:({rowData:e})=>"death"===e.type?ae():r("div",{class:"status-container"},[...e.preCalculated.keigenns.map(e=>r("span",{class:"status-wrapper"},[r("span",{class:"status",title:e.title,"data-duration":e.duration,"data-sourcePov":e.isPov},[r("img",{class:["statusIcon",e.usefulClass],src:e.src,alt:e.effect,onError:F})])])),r("span",{class:"flags"},"damage done"===e.effect?"":a(`keigennRecord.${e.effect}`))])},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>r("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:10}},"death"===e.type?void 0:r("div",{class:"view-icon",onMouseenter:t=>W(e,"skills",t),onMouseleave:U},[r("div",{class:"dots"},[r("i"),r("i"),r("i")])]))}];let ge=null;const ve={onClick:({rowData:e})=>{const t=null!==T.value;if("death"===e.type)return void(t&&T.value?.endTime===e.timestamp&&E.value===e.targetId?ee():Q(e));const{actionCN:n,amount:l,job:o,keigenns:i,time:s,type:r,effect:c,currentHp:d,maxHp:u,shield:m,reduction:p}=e,f="damage done"===c?"":`,${a(`keigennRecord.${c}`)}`,g=`${s} ${o} ${n} ${l.toLocaleString()}(${a(`keigennRecord.${r}`)}) ${a("keigennRecord.reduction")}(${(100*p).toFixed(0)}%):${0===i.length&&""===f?a("keigennRecord.none"):i.map(e=>R.statusCN?e.name:e.effect).join(",")+f} ${a("keigennRecord.hp")}}:${d}(${Math.round(d/u*100)}%)+${a("keigennRecord.shield")}:${Math.round(u*+m/100)}(${m}%)`;P(g).then(()=>{ge?.close(),ge=me.success({message:a("keigennRecord.copySuccess"),duration:800})}).catch(()=>me.error(a("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const a=t;_.value=e,A.value=a.clientX,M.value=a.clientY,x.value=!0}},he=l(null);function be(){he.value&&he.value.scrollToRow(le.value.length-1)}return t({scrollToBottom:be}),(t,n)=>{const l=ce,o=re,i=ue,s=de,r=se;return f(),c("div",ye,[d("div",ke,[u(r,{style:{height:"100%",width:"100%"}},{default:m(({height:r,width:p})=>[u(o,{ref_key:"tableV2Ref",ref:he,"header-class":"keigenn-table-header",class:"keigenn-table performance-table",columns:fe,data:le.value,width:p,height:r,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":ve,"row-class":pe,"overscan-row-count":2},{empty:m(()=>[u(l,{description:v(N).isBrowser?t.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["data","width","height"]),v(x)?(f(),c("div",{key:0,ref_key:"contextMenu",ref:S,class:"context-menu",style:h({top:`${v(M)}px`,left:`${v(A)}px`})},[d("ul",null,[d("li",{onClick:X},b(v($)===(v(_)?.[e.actionKey]??"")?v(a)("keigennRecord.filter.action_cancel",{actionName:v(_)?.[e.actionKey]??v(a)("keigennRecord.this_skill")}):v(a)("keigennRecord.filter.action_only",{actionName:v(_)?.[e.actionKey]??v(a)("keigennRecord.this_skill")})),1),d("li",{onClick:Y},b(v(E)===v(_)?.targetId?v(a)("keigennRecord.filter.target_cancel",{jobName:v(_)?.job??v(a)("keigennRecord.this_job")}):v(a)("keigennRecord.filter.target_only",{jobName:v(_)?.job??v(a)("keigennRecord.this_job")})),1)])],4)):g("",!0),u(s,{visible:v(O),"onUpdate:visible":n[0]||(n[0]=e=>y(O)?O.value=e:null),"virtual-ref":v(J),"virtual-triggering":"",trigger:"hover",placement:v(G),width:"auto","popper-class":"keigenn-global-popover",transition:"none","show-after":0,"hide-after":0,offset:6,enterable:!1},{default:m(()=>[v(H)&&"amount"===v(K)?(f(),c("div",we,[d("div",Ie,b(v(a)("keigennRecord.source"))+": "+b(v(H).source),1),d("div",je,b(v(a)("keigennRecord.playerShield"))+": "+b(v(H).shield)+"%",1),d("div",Ce,b(v(a)("keigennRecord.playerHp"))+": "+b(v(H).currentHp.toLocaleString())+"("+b(v(H).preCalculated.hpPercent)+"%)",1),v(H).reduction<1&&"dot"!==v(H).type?(f(),c(k,{key:0},[n[1]||(n[1]=d("div",{class:"info-divider"},null,-1)),d("div",De,b(v(a)("keigennRecord.reductionRate"))+": "+b((100*v(H).reduction).toFixed(2))+"%",1),d("div",Ne,[w(b(v(a)("keigennRecord.originalDamage"))+": ",1),d("span",{class:I(v(H).preCalculated.damageTypeClass)},b(v(H).preCalculated.originalDamageDisplay),3)])],64)):g("",!0)])):v(H)&&"skills"===v(K)?(f(),c("div",Re,[v(H).preCalculated.coolingDownSkills.length>0?(f(),c(k,{key:0},[d("div",Se,b(v(a)("keigennRecord.coolingDown")),1),d("div",$e,[(f(!0),c(k,null,j(v(H).preCalculated.coolingDownSkills,e=>(f(),c("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[d("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[d("img",{src:e.icon,class:"skill-icon"},null,8,Te),n[2]||(n[2]=d("div",{class:"skill-overlay"},null,-1)),d("span",xe,b(e.recastLeft),1)],8,Ee)]))),128))])],64)):g("",!0),v(H).preCalculated.readySkills.length>0?(f(),c(k,{key:1},[v(H).preCalculated.coolingDownSkills.length>0?(f(),C(i,{key:0})):g("",!0),d("div",Ae,b(v(a)("keigennRecord.ready")||"å¯ç”¨"),1),d("div",Me,[(f(!0),c(k,null,j(v(H).preCalculated.readySkills,e=>(f(),c("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[d("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[d("img",{src:e.icon,class:"skill-icon"},null,8,He)],8,_e)]))),128))])],64)):g("",!0),0===v(H).preCalculated.coolingDownSkills.length&&0===v(H).preCalculated.readySkills.length?(f(),c("div",Le,b(v(a)("keigennRecord.noData")),1)):g("",!0)])):g("",!0)]),_:1},8,["visible","virtual-ref","placement"])]),_:1})])])}}}),[["__scopeId","data-v-66032882"]]),Fe={class:"header-select"},Pe={style:{height:"100%"}},Be={key:0,class:"testLog"},Je=e(a({__name:"keigennRecord2",setup(e){const a=K(),n=z(),o=n.userOptions;n.checkIsBrowser();const i="push"===o.order,s=l(o.minimize),r=o.actionCN?"actionCN":"action",b=l(!1),y="keigenn-record-2-pov-id",L="keigenn-record-2-party-list",F="keigenn-record-2-job-map",P="keigenn-record-2-party-event-party",se="souma-keigenn-record-2-rsv-data",re="souma-keigenn-record-2-zone-name";let ce="",de=[],ue={},me=[],ye={},ke=0,we="",Ie=0;const je=l(0),Ce=D([{zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1}]),De={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ve.ability(),statusEffectExplicit:ve.statusEffectExplicit(),gainsEffect:ve.gainsEffect(),losesEffect:ve.losesEffect(),death:ve.wasDefeated(),changeZone:ve.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:ve.addedCombatant(),removingCombatant:ve.removingCombatant(),networkDoT:ve.networkDoT()};let Ne={},Re={friendly:{},enemy:{}},Se={},$e=new Map;const Ee=J.filter(e=>1===e.line||2===e.line),Te=O("keigenn-record-2");function xe(){b.value=!0,ke=0,Se={},je.value=0,Ce.value.length=0,Ce.value.push({zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1}),Ne={},Re={friendly:{},enemy:{}},ue={},me=[],de=[],ce="",Ie=0,Me.clear(),Je.clear(),$e.clear(),ye={}}async function Ae(){b.value=!1,null!==We&&(cancelAnimationFrame(We),We=null,Ge.length>0&&(i?(Ce.value[0].table.push(...Ge),p(()=>Ue.value?.scrollToBottom())):Ce.value[0].table.unshift(...Ge.reverse()),Ge=[])),await Xe(),_(Ce)}const Me=new Map;const _e=n.icon4k;function He(e){const t=function(e){const t=Math.round(100*e)/100;if(Me.has(t))return Me.get(t);const a=[88,88,88],n=[50,250,200],l=Math.min(1,t/.5),o=Math.min(9,Math.floor(10*l))/9,i=Math.pow(o,.8),s=a[0]+(n[0]-a[0])*i,r=a[1]+(n[1]-a[1])*i,c=a[2]+(n[2]-a[2])*i,d=`rgba(${Math.round(s)}, ${Math.round(r)}, ${Math.round(c)}, 1)`;return Me.set(t,d),d}(e.reduction),a=e.amount>999999?`${(e.amount/1e4).toFixed(0)}ä¸‡`:e.amount.toLocaleString(),n=((e,t)=>`https://souma.diemoe.net/resources/img/cj${t}/${e.replaceAll(/([A-Z])/g," $1").trim()}.png`)(e.jobIcon,o.iconType),{amount:l,maxHp:i,currentHp:s,shield:r,type:c,reduction:d}=e,u=Math.round(i*+r/100),m=Math.round(s/i*100),p=(l&&Math.round((l+u)/(1-d))||0).toLocaleString();return{...e,preCalculated:{reductionColor:t,amountDisplay:a,damageTypeClass:c,jobIconSrc:n,keigenns:e.keigenns.map(e=>({src:le(`/i/${e.fullIcon}${_e}.png`),usefulClass:ne(e,c),title:`${o.statusCN?e.name:e.effect}(${e.source})`,duration:e.remainingDuration??"",isPov:e.isPov,effect:e.effect})),originalDamageDisplay:p,hpPercent:m,coolingDownSkills:e.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[],readySkills:e.keySkills?.filter(e=>e.ready).sort((e,t)=>B.enumSortMethod(e.ownerJob,t.ownerJob))??[]}}}function Le(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const a=e.split("|");switch(t){case"26":{if(!De.gainsEffect.exec(e))return;const t=a[be.GainsEffect.fields.effectId],n=a[be.GainsEffect.fields.effect],l=a[be.GainsEffect.fields.target],o=a[be.GainsEffect.fields.targetId],i=Number.parseInt(a[be.GainsEffect.fields.count],16);let s=q(t);if(!s){const e=o.startsWith("1")&&X.get(Number.parseInt(t,16).toString())||o.startsWith("4")&&Y.get(Number.parseInt(t,16).toString());if(!e)return;const a=Q(e.icon),n=i>1?ee(a,i):a;s={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:n,name:e.name,isFriendly:e.isFriendly}}const r=a[be.GainsEffect.fields.duration],c=a[be.GainsEffect.fields.source],d=a[be.GainsEffect.fields.sourceId],u=new Date(a[be.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(r),m={name:s.name,type:s.type,count:i,effect:n,effectId:t,source:c,sourceId:d,target:l,targetId:o,expirationTimestamp:u,performance:s.performance,fullIcon:s.fullIcon,isPov:ce===d};o.startsWith("1")&&s.isFriendly?(void 0===Re.friendly[o]&&(Re.friendly[o]={}),Re.friendly[o][t]=m):o.startsWith("4")&&!s.isFriendly&&(void 0===Re.enemy[l]&&(Re.enemy[l]={}),Re.enemy[l][t]=m)}break;case"30":{const e=a[be.LosesEffect.fields.target],t=a[be.LosesEffect.fields.targetId],n=a[be.LosesEffect.fields.effectId];t.startsWith("1")?Re.friendly[t]&&Reflect.deleteProperty(Re.friendly[t],n):Re.enemy[e]&&Reflect.deleteProperty(Re.enemy[e],n)}break;case"21":case"22":{if(0===ke)return;const e=a[be.Ability.fields.sourceId]??"???",t=a[be.Ability.fields.id]??"???",n=new Date(a[be.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16),l=function(e){let t=$e.get(e);if(!t){t=new Map;for(const a of Ee){if(a.minLevel>e)continue;const n=te(a.id,e);t.set(n,a)}$e.set(e,t)}return t}(ue[e]?.level??999);l.get(a)&&(Se[e]||(Se[e]={}),Se[e][a]=n)}const l=U(a);if(l.isAttack&&l.amount>=0){const i=a[be.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!i.startsWith("1"))return;if(i!==ce&&!de.includes(i)&&!me.find(e=>e.id===i))return;const s=a[be.Ability.fields.ability],r=s.match(/^_rsv_(?<id>\d+)_/);let c=s;if(r){const e=Number(r.groups?.id);c=ye[e]??s.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===o.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=V(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(a[be.Ability.fields.targetCurrentHp]),p=Number(a[be.Ability.fields.targetMaxHp]),f=a[be.Ability.fields.source]??"???",g=a[be.Ability.fields.target]??"???",{effect:v,type:h}=Z(l.flags),b=Ye(0===ke?0:n-ke),{jobEnum:y,job:k,jobIcon:w,hasDuplicate:I}=Oe(i),j=Object.values(Re.friendly[i]??[]).concat(Object.values(Re.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-n)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),C=Ne[i]??"0",D=l.amount;let N=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of j)"absorbed"!==a.type&&(t*=a.performance[h]??1);N=1-t*e}Ve(He({key:(Ie++).toString(),time:b,timestamp:n,id:t,action:c,actionCN:u,source:f,target:g,targetId:i,job:k,jobIcon:w,jobEnum:y,hasDuplicate:I,amount:D,keigenns:j,currentHp:m,maxHp:p,effect:v,type:h,shield:C,povId:ce,reduction:N,keySkills:qe(n)})),Ce.value[0].duration=Ye(new Date(a[be.Ability.fields.timestamp]).getTime()-ke)}}break;case"25":{const t=De.death.exec(e);if(!t||!t.groups)return;const a=t.groups.targetId,n=t.groups.target,l="E0000000"===t.groups.sourceId?"åœ°å½¢æ€":t.groups.source,o=t.groups.timestamp;if(0===ke)return;if(a!==ce&&!de.includes(a)&&!me.find(e=>e.id===a))return;const i=new Date(o).getTime(),s=Ye(i-ke),{jobEnum:r,job:c,jobIcon:d,hasDuplicate:u}=Oe(a);Ve(He({key:(Ie++).toString(),time:s,timestamp:i,id:"",action:"Death",actionCN:"æ­»äº¡",source:l,target:n,targetId:a,job:c,jobIcon:d,jobEnum:r,hasDuplicate:u,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:ce,reduction:0,keySkills:qe(i)}))}break;case"38":{const t=De.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Ne[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===a[be.InCombat.fields.inACTCombat],t="1"===a[be.InCombat.fields.inGameCombat],n=new Date(a[be.InCombat.fields.timestamp]).getTime();if(e||t){const e=a[be.InCombat.fields.timestamp];if(ke>0)return;return 0===Ce.value[0].table.length&&0===Ge.length||(null!==We&&(cancelAnimationFrame(We),We=null),Ge.length>0&&(i?Ce.value[0].table.push(...Ge):Ce.value[0].table.unshift(...Ge.reverse()),Ge=[]),Ce.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:e,timestamp:n}),_(Ce)),ke=n,Ce.value[0].zoneName=we,Ce.value[0].timestamp=n,Ce.value[0].key=e,void(je.value=0)}if(!e&&!t)return void Ze(n)}break;case"01":{const e=parseInt(a[be.ChangeZone.fields.id],16);if(we=a[be.ChangeZone.fields.name],G[e]?.name){const t=W(G[e]?.name);t&&"Unknown"!==t&&(we=t)}Ze(new Date(a[be.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=De.partyList.exec(e);t&&(de=(t.groups?.list?.split("|")??[]).filter(Boolean))}break;case"02":ce=a[be.ChangedPlayer.fields.id];break;case"03":if("00"!==a[be.AddedCombatant.fields.job]){const e=a[be.AddedCombatant.fields.job],t=a[be.AddedCombatant.fields.name],n=new Date(a[be.AddedCombatant.fields.timestamp]).getTime(),l=parseInt(a[be.AddedCombatant.fields.level],16);ue[a[be.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:n,name:t,level:l}}break;case"04":Reflect.deleteProperty(ue,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Re.friendly,a[be.RemovedCombatant.fields.id]),Reflect.deleteProperty(Re.enemy,a[be.RemovedCombatant.fields.id]);break;case"262":{const t=De.rsv.exec(e);if(t){const e=Number(t.groups?.id),n=a[be.RSVData.fields.value];e&&n&&(ye[Number(e)]=n)}}break;case"24":if(!o.parseDoT)return;{const e=a[be.NetworkDoT.fields.which],t=a[be.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==ce&&!de.includes(t)&&!me.find(e=>e.id===t))return;const n=a[be.NetworkDoT.fields.name],l=a[be.NetworkDoT.fields.damage],o=Number.parseInt(l,16),i=new Date(a[be.Ability.fields.timestamp]??"???").getTime(),s=Number(a[be.NetworkDoT.fields.currentHp]),r=Number(a[be.NetworkDoT.fields.maxHp]),c=Ye(0===ke?0:i-ke),{jobEnum:d,job:u,jobIcon:m,hasDuplicate:p}=Oe(t);Ve(He({key:(Ie++).toString(),time:c,timestamp:i,id:"",action:e,actionCN:e,source:"",target:n,targetId:t,job:u,jobIcon:m,jobEnum:d,hasDuplicate:p,amount:o,keigenns:[],currentHp:s,maxHp:r,effect:"damage done",type:"dot",shield:Ne[t]??"0",povId:ce,reduction:0,keySkills:[]}))}}}const Je=new Map;function Ke(){Je.clear()}function Oe(e){const t=Je.get(e);if(t)return t;const{job:a,hasDuplicate:n}=function(e){const t=ue[e],a=me.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,l=n===t?Object.entries(ue).some(([t,a])=>t!==e&&a.job===n?.job&&de.includes(t)):me.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:l}}(e),l=a,o={jobEnum:l,job:B.jobToFullName(B.jobEnumToJob(l)).simple2,jobIcon:B.jobEnumToIcon(l),hasDuplicate:n};return Je.set(e,o),o}let Ge=[],We=null;const Ue=l(null);function Ve(e){Ge.push(M(e)),null===We&&(We=requestAnimationFrame(()=>{i?(Ce.value[0].table.push(...Ge),b.value||p(()=>Ue.value?.scrollToBottom())):Ce.value[0].table.unshift(...Ge.reverse()),Ge=[],We=null}))}function Ze(e){0!==ke&&(Ce.value[0].duration=Ye(e-ke),Ce.value[0]=M(Ce.value[0]),ke=0,Re.friendly={},Re.enemy={},Se={},Ke(),Xe())}function qe(e){const t=new Set;me.forEach(e=>t.add(e.id)),de.forEach(e=>t.add(e)),ce&&t.add(ce);const a=[];for(const l of t){const e=me.find(e=>e.id===l);if(e){a.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const t=ue[l];t&&a.push({id:l,job:t.job,name:t.name??"Unknown",level:t.level})}const n=new Map;a.forEach(e=>n.set(e.job,(n.get(e.job)||0)+1));return a.flatMap(e=>{const t=e.level||999;return Ee.filter(a=>a.job.includes(e.job)&&a.minLevel<=t).map(a=>{const n=te(a.id,t),l=te(a.recast1000ms,t);return{id:n,name:V(n)||"Unknown",icon:ae(n),recast1000ms:l,ownerId:e.id,ownerName:e.name,ownerJob:e.job,ownerJobName:B.jobToFullName(B.jobEnumToJob(e.job)).simple2}})}).map(t=>{const a=Se[t.ownerId]?.[t.id]??0;let n=!0,l=0;if(a>0){const o=e-a,i=1e3*t.recast1000ms;o<i&&(n=!1,l=Math.ceil((i-o)/1e3))}return{...t,recastLeft:l,ready:n}})}async function Xe(){if(b.value)return;const e=Ce.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?H(e.table):[];return{...H(e),table:t}});await Te.replaceAll(e)}function Ye(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Qe(){s.value=!s.value}function et(){"init"!==Ce.value[0]?.key&&void 0!==Ce.value[0]||(Ce.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:"test",timestamp:Date.now()}),_(Ce),je.value=0),Ve(He({key:(Ie++).toString(),time:Ye(Date.now()-(ke||Date.now())),timestamp:Date.now(),id:"unknown",action:"test",actionCN:"æµ‹è¯•æŠ€èƒ½",source:"çŽ¯å¢ƒ",target:"æµ‹è¯•è§’è‰²",targetId:"test-id",job:"æµ‹è¯•èŒä¸š",jobIcon:B.jobEnumToIcon(19),jobEnum:19,hasDuplicate:!1,amount:12345,keigenns:[],currentHp:5e4,maxHp:1e5,effect:"damage done",type:"physics",shield:"10",povId:"test-id",reduction:.1,keySkills:[]}))}function tt(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return R(()=>{!function(){try{const e=localStorage.getItem(y);e&&(ce=e);const t=localStorage.getItem(L);t&&(de=JSON.parse(t));const a=localStorage.getItem(F);a&&(ue=JSON.parse(a));const n=localStorage.getItem(P);n&&(me=JSON.parse(n));const l=localStorage.getItem(se);l&&(ye=JSON.parse(l));const o=localStorage.getItem(re);o&&(we=o)}catch(e){}}();const e=S({storageKey:"keigenn-record-2-theme"}),t=$(e);!1===e.value&&t();for(const a in ue){const e=ue[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(ue,a)}!async function(){je.value=0;try{const e=await Te.getAll();if(e.length){Ce.value.length=0;let t=e.filter(e=>n.isBrowser||e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp);i||(t=t.reverse());const a=t.map(e=>({...e,table:N(Array.isArray(e.table)?e.table.map(e=>M(e)):[])}));Ce.value.push(...a),0===Ce.value.length&&Ce.value.push({zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1}),_(Ce)}}catch(e){throw Ce.value.length=0,e}}(),he("LogLine",e=>{Le(e.rawLine)}),he("PartyChanged",e=>{me=e.party.map(e=>({...e,timestamp:Date.now()})),Ke()}),he("ChangePrimaryPlayer",e=>{ce=Number(e.charID).toString(16).toUpperCase()}),he("CombatData",e=>{if(!(ke>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(we=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==Ce.value[0].table.length&&(Ce.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:String(n),timestamp:n}),_(Ce)),Ce.value[0].zoneName=we,ke=n,Ce.value[0].timestamp=n,Ce.value[0].key=String(n),je.value=0}})}),E(()=>{!function(){try{localStorage.setItem(y,ce),localStorage.setItem(L,JSON.stringify(de)),localStorage.setItem(F,JSON.stringify(ue)),localStorage.setItem(P,JSON.stringify(me)),localStorage.setItem(se,JSON.stringify(ye)),localStorage.setItem(re,we)}catch(e){}}()}),(e,l)=>{const i=ie,p=oe,b=ge,y=ze,D=t;return f(),c(k,null,[d("div",{class:"wrapper",style:h({"--scale":v(o).scale,"--opacity":v(o).opacity}),onContextmenu:l[1]||(l[1]=A(()=>{},["prevent"]))},[d("header",null,[d("div",Fe,[T(u(p,{modelValue:je.value,"onUpdate:modelValue":l[0]||(l[0]=e=>je.value=e),size:"small",class:I(["combat-select",v(n).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:m(()=>[(f(!0),c(k,null,j(Ce.value.length,e=>(f(),C(i,{key:`${Ce.value[e-1].key}-${Ce.value[e-1].duration}-${Ce.value[e-1].zoneName}`,value:e-1,label:`${Ce.value[e-1].zoneName}${""===Ce.value[e-1].zoneName?"":` - [${Ce.value[e-1].duration}] ${tt(Ce.value[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[x,!s.value]])]),v(n).isBrowser?g("",!0):(f(),C(b,{key:0,class:I(["minimize",s.value?"in-minimize":"not-minimize"]),icon:s.value?v(pe):v(fe),circle:"",style:h({opacity:s.value?.5:1}),onClick:Qe},null,8,["class","icon","style"]))]),T(d("main",Pe,[u(y,{ref_key:"tableRef",ref:Ue,rows:Ce.value[je.value].table,"action-key":v(r)},null,8,["rows","action-key"])],512),[[x,!s.value]])],36),v(n).isBrowser||v(a)?(f(),c("div",Be,[v(a)?(f(),C(b,{key:0,onClick:et},{default:m(()=>[...l[2]||(l[2]=[w(" æµ‹è¯• ",-1)])]),_:1})):g("",!0),u(D,{"m-1":"",onBeforeHandle:xe,onAfterHandle:Ae,onHandleLine:Le})])):g("",!0)],64)}}}),[["__scopeId","data-v-d48129bb"]]);export{Je as default};
