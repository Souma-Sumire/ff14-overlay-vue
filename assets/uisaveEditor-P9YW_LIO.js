const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-element-plus-DgmfwXHJ.js","assets/vendor-vue-i6lpFrx4.js","assets/vendor-vue-CSRUKxnt.css","assets/vendor-element-plus--Mr-XVKt.css"])))=>i.map(i=>d[i]);
import{_ as e}from"./index-DoiNWFfb.js";import{b as a,a as t,_ as s}from"./shared-common-B0Qn_Y-k.js";import{h as o,E as n,x as r,c as i,n as l,b as c,d as u,e as d,t as p,f as v,g as m,F as f,r as y,bW as g,a as k,y as b}from"./vendor-vue-i6lpFrx4.js";import{b as h,L as w,n as D,g as I,M as E,N as A,d as x,h as _,O as z,P as T,c as U,f as O}from"./vendor-element-plus-DgmfwXHJ.js";import{_ as j}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-5NBSmHxY.js";import{p as C,M as F,j as S,k as Z,x as M,Z as V}from"./shared-core-D8l_fnWQ.js";import{_ as $}from"./zoneSelecter-ftyNwhkR.js";import"./cactbot-CjGan0Ay.js";import"./map-DW4z5uTS.js";const L={key:0,class:"drag-full-overlay"},N={class:"overlay-content"},Y={class:"sub-text"},B={class:"header-container"},X={class:"header-left"},P={class:"title-group"},J={key:0,class:"status-badges"},R={class:"header-right"},W={class:"action-buttons"},q={key:1,class:"content"},K={class:"marks-grid"},H={class:"card-header"},G={class:"card-title"},Q={class:"index-num"},ee={class:"map-id-text"},ae={style:{display:"flex",gap:"0"}},te={class:"waymark-content"},se={class:"waymark-controls"},oe={class:"control-header"},ne={class:"col-mark"},re={class:"waymark-map-container"},ie={key:1,class:"empty-map-placeholder"},le={class:"empty-icon-wrapper"},ce={class:"upload-text"},ue=s(o({__name:"uisaveEditor",setup(s){const{t:o}=n(),ue=r(null),de=r(null),pe=r(!1),ve=r(!1),me=r(!1),fe=r(6);let ye=0;const ge=e=>e/1e3,ke=()=>{me.value=!0},be=(e,a)=>0!==(e.enableFlag&a),he=(e,a,t,s)=>{var o;void 0!==s&&(e[a][t]=(o=s,Math.round(1e3*o)),ke())};async function we(a){const t=(await e(async()=>{const{ElLoading:e}=await import("./vendor-element-plus-DgmfwXHJ.js").then(e=>e.aJ);return{ElLoading:e}},__vite__mapDeps([0,1,2,3]))).ElLoading.service({lock:!0,text:"正在解析 UISAVE.DAT...",background:"rgba(0, 0, 0, 0.7)"});ve.value=!0;try{await new Promise(e=>setTimeout(e,50)),de.value=await C(await a.arrayBuffer()),fe.value=12;const e=()=>{de.value&&fe.value<de.value.wayMarks.length&&(fe.value+=12,requestAnimationFrame(e))};requestAnimationFrame(e),requestAnimationFrame(e),I.success(o("uisaveEditor.importSuccess")),me.value=!1}catch(s){I.error(`解析失败: ${s instanceof Error?s.message:String(s)}`)}finally{ve.value=!1,t.close()}}function De(){if(!de.value)return;const{wayMarks:e,markerHeader:a,markerTail:t,otherSections:s,userID:n,payloadUnknown:r,fileFormatVersion:i,fileUnknown:l,belongsToWaymarkDat:c}=de.value;if(c){const a=new Uint8Array(104*e.length);e.forEach((e,t)=>{const s=104*t,o=new DataView(a.buffer,a.byteOffset+s,104);F.forEach((a,t)=>{o.setInt32(12*t,e[a.key].x,!0),o.setInt32(12*t+4,e[a.key].y,!0),o.setInt32(12*t+8,e[a.key].z,!0)}),a[s+96]=e.enableFlag,a[s+97]=e.unknown,o.setUint16(98,e.regionID,!0),o.setInt32(100,e.timestamp,!0)});const t=URL.createObjectURL(new Blob([a],{type:"application/octet-stream"})),s=document.createElement("a");return s.href=t,s.download="WAYMARK.DAT",s.click(),URL.revokeObjectURL(t),me.value=!1,void I.success(o("uisaveEditor.exportSuccess"))}const u=new Uint8Array(16+104*e.length+t.length);u.set(a,0),e.forEach((e,a)=>{const t=16+104*a,s=new DataView(u.buffer,u.byteOffset+t,104);F.forEach((a,t)=>{s.setInt32(12*t,e[a.key].x,!0),s.setInt32(12*t+4,e[a.key].y,!0),s.setInt32(12*t+8,e[a.key].z,!0)}),u[t+96]=e.enableFlag,u[t+97]=e.unknown,s.setUint16(98,e.regionID,!0),s.setInt32(100,e.timestamp,!0)}),u.set(t,16+104*e.length);const d=new Uint8Array(16+u.length+4),p=new DataView(d.buffer);p.setInt16(0,17,!0),p.setInt32(8,u.length,!0),d.set(u,16);const v=new Uint8Array(16+s.length+d.length);v.set(r,0),new DataView(v.buffer).setBigInt64(8,n,!0),v.set(s,16),v.set(d,16+s.length);const m=M(v),f=new Uint8Array(16+m.length),y=new DataView(f.buffer);f.set(i,0),y.setInt32(8,m.length,!0),f.set(l,12),f.set(m,16);const g=URL.createObjectURL(new Blob([f],{type:"application/octet-stream"})),k=document.createElement("a");k.href=g,k.download="UISAVE.DAT",k.click(),URL.revokeObjectURL(g),me.value=!1,I.success(o("uisaveEditor.exportSuccess"))}const Ie=new Set(["X","Y","Z","ID","Active"]),Ee=new Set(["Name","MapID","A","B","C","D","One","Two","Three","Four"]);async function Ae(e){try{const{value:a}=await O.prompt(o("uisaveEditor.pastePrompt"),o("uisaveEditor.importTitle"),{confirmButtonText:o("uisaveEditor.import"),cancelButtonText:o("uisaveEditor.cancel"),inputType:"textarea",inputPlaceholder:'{"Name":...,"MapID":...,"A":{...}...}',inputPattern:/^{.*}$/,inputErrorMessage:o("uisaveEditor.jsonError"),closeOnClickModal:!1,customClass:"ppjson-import-dialog",inputValidator:e=>{if(!e)return o("uisaveEditor.inputEmpty");try{const a=function(e){if("object"!=typeof e||null===e)return"输入必须是 JSON 对象";for(const s of Object.keys(e))if(!Ee.has(s))return`根节点包含非法字段: ${s}`;const a=e;if("number"!=typeof a.MapID)return"缺少 MapID 或类型错误 (应为数字)";if("Name"in a&&"string"!=typeof a.Name)return"Name 字段类型错误 (应为字符串)";const t=["A","B","C","D","One","Two","Three","Four"];for(const s of t)if(s in a){const e=a[s];if("object"!=typeof e||null===e)return`标点 ${s} 格式错误 (应为对象)`;for(const a of Object.keys(e))if(!Ie.has(a))return`标点 ${s} 包含非法字段: ${a}`;if("number"!=typeof e.X)return`标点 ${s}.X 类型错误 (应为数字)`;if("number"!=typeof e.Y)return`标点 ${s}.Y 类型错误 (应为数字)`;if("number"!=typeof e.Z)return`标点 ${s}.Z 类型错误 (应为数字)`;if("ID"in e&&"number"!=typeof e.ID)return`标点 ${s}.ID 类型错误 (应为数字)`;if("Active"in e&&"boolean"!=typeof e.Active)return`标点 ${s}.Active 类型错误 (应为布尔值)`}return!0}(JSON.parse(e));return!0===a||`${o("uisaveEditor.invalidPPJson")}: ${a}`}catch{return o("uisaveEditor.jsonError")}}});if(!a)return;const t=JSON.parse(a),s=de.value?.wayMarks[e];if(!s)return;s.regionID=t.MapID;const n={A:"A",B:"B",C:"C",D:"D",One:"One",Two:"Two",Three:"Three",Four:"Four"},r=(e,a)=>{0!==(s.enableFlag&e)!==a&&(s.enableFlag^=e)};for(const[e,o]of Object.entries(n)){const a=t[e],n=a?{...a,Active:a.Active??!0}:{X:0,Y:0,Z:0,ID:0,Active:!1};he(s,o,"x",n.X),he(s,o,"y",n.Y),he(s,o,"z",n.Z);const i=F.find(e=>e.key===o);i&&r(i.bit,n.Active)}ke(),ke(),I.success(o("uisaveEditor.importSuccess"))}catch(a){if("cancel"===a)return;I.error(o("uisaveEditor.importFail"))}}const xe=e=>{const a=e.target.files?.[0];a&&we(a)},_e=e=>{pe.value=!1,ye=0;const a=e.dataTransfer?.files[0];a?.name.toLowerCase().endsWith(".dat")&&we(a)},ze=()=>{ye++,pe.value=!0},Te=()=>{ye--,0===ye&&(pe.value=!1)};return(e,s)=>{const n=h,r=w,O=D,C=t,M=x,ve=_,ye=U;return k(),i("div",{class:"uisave-editor",onDragenter:g(ze,["prevent"]),onDragover:s[2]||(s[2]=g(()=>{},["prevent"])),onDragleave:g(Te,["prevent"]),onDrop:g(_e,["prevent"])},[pe.value?(k(),i("div",L,[c("div",N,[u(n,{size:80,color:"var(--el-color-primary)"},{default:d(()=>[u(v(E))]),_:1}),c("p",null,p(v(o)("uisaveEditor.dropToLoad")),1),c("span",Y,p(v(o)("uisaveEditor.description")),1)])])):l("",!0),c("header",B,[c("div",X,[c("div",P,[c("h1",null,p(v(o)("uisaveEditor.title")),1),de.value?(k(),i("div",J,[me.value?(k(),m(r,{key:0,type:"danger",effect:"dark",round:"",size:"small",class:"unsaved-tag"},{default:d(()=>[b(" ● "+p(v(o)("uisaveEditor.unsaved")),1)]),_:1})):l("",!0)])):l("",!0)])]),c("div",R,[c("input",{ref_key:"fileInput",ref:ue,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:xe},null,544),c("div",W,[u(O,{class:"action-btn import-btn",size:"small",round:"",onClick:s[0]||(s[0]=e=>ue.value?.click())},{default:d(()=>[u(n,{class:"el-icon--left"},{default:d(()=>[u(v(E))]),_:1}),b(" "+p(v(o)("uisaveEditor.parseDat")),1)]),_:1}),u(O,{class:"action-btn export-btn",type:"primary",size:"small",round:"",disabled:!de.value,onClick:De},{default:d(()=>[u(n,{class:"el-icon--left"},{default:d(()=>[u(v(A))]),_:1}),b(" "+p(v(o)("uisaveEditor.download")),1)]),_:1},8,["disabled"])]),s[3]||(s[3]=c("div",{class:"divider"},null,-1)),u(a),u(C,{"storage-key":"ui-save-editor"})])]),de.value?(k(),i("div",q,[c("div",K,[(k(!0),i(f,null,y(de.value.wayMarks.slice(0,fe.value),(e,a)=>(k(),m(ye,{key:a,shadow:"hover",class:"waymark-card"},{header:d(()=>[c("div",H,[c("div",G,[c("span",Q,"#"+p(a+1),1),c("span",ee,p(v(o)("uisaveEditor.mapId",[e.regionID])),1)]),u($,{"select-zone":v(Z)(e.regionID).toString(),placeholder:v(o)("uisaveEditor.zoneSelectPlaceholder"),"onUpdate:selectZone":a=>{e.regionID=v(S)(Number(a)),ke()},width:"100%","show-all-levels":!1,border:!1,class:"header-zone-select"},null,8,["select-zone","placeholder","onUpdate:selectZone"]),c("div",ae,[u(O,{size:"small",icon:v(E),onClick:e=>Ae(a),title:`${v(o)("uisaveEditor.import")} PP JSON`,text:"",style:{margin:"0"}},{default:d(()=>[b(p(v(o)("uisaveEditor.import")),1)]),_:1},8,["icon","onClick","title"]),u(O,{size:"small",icon:v(T),onClick:e=>async function(e){const a=de.value?.wayMarks[e];if(!a)return;const t=V[Z(a.regionID)],s={Name:t?.name.cn||t?.name.en||`Zone_${a.regionID}`,MapID:a.regionID,A:{X:ge(a.A.x),Y:ge(a.A.y),Z:ge(a.A.z),ID:0,Active:be(a,1)},B:{X:ge(a.B.x),Y:ge(a.B.y),Z:ge(a.B.z),ID:1,Active:be(a,2)},C:{X:ge(a.C.x),Y:ge(a.C.y),Z:ge(a.C.z),ID:2,Active:be(a,4)},D:{X:ge(a.D.x),Y:ge(a.D.y),Z:ge(a.D.z),ID:3,Active:be(a,8)},One:{X:ge(a.One.x),Y:ge(a.One.y),Z:ge(a.One.z),ID:4,Active:be(a,16)},Two:{X:ge(a.Two.x),Y:ge(a.Two.y),Z:ge(a.Two.z),ID:5,Active:be(a,32)},Three:{X:ge(a.Three.x),Y:ge(a.Three.y),Z:ge(a.Three.z),ID:6,Active:be(a,64)},Four:{X:ge(a.Four.x),Y:ge(a.Four.y),Z:ge(a.Four.z),ID:7,Active:be(a,128)}};await navigator.clipboard.writeText(JSON.stringify(s)),await navigator.clipboard.writeText(JSON.stringify(s)),I.success(o("uisaveEditor.copySuccess"))}(a),title:`${v(o)("uisaveEditor.copy")} PP JSON`,text:"",style:{margin:"0"}},{default:d(()=>[b(p(v(o)("uisaveEditor.copy")),1)]),_:1},8,["icon","onClick","title"])])])]),default:d(()=>[c("div",te,[c("div",se,[c("div",oe,[c("span",ne,p(v(o)("uisaveEditor.active")),1),s[4]||(s[4]=c("span",{class:"col-coord"},"X",-1)),s[5]||(s[5]=c("span",{class:"col-coord"},"Y",-1)),s[6]||(s[6]=c("span",{class:"col-coord"},"Z",-1))]),(k(!0),i(f,null,y(v(F),a=>(k(),i("div",{key:a.key,class:"control-row"},[u(M,{"model-value":be(e,a.bit),onChange:t=>((e,a)=>{const t=0===(e.enableFlag&a);if(e.enableFlag^=a,ke(),t){const t=F.find(e=>e.bit===a);if(t){const a=e[t.key];0===a.x&&0===a.y&&0===a.z&&(a.x=1e5,a.z=1e5)}}})(e,a.bit),class:"marker-checkbox",disabled:0===e.regionID},{default:d(()=>[b(p(a.label),1)]),_:2},1032,["model-value","onChange","disabled"]),u(ve,{"model-value":ge(e[a.key].x),"onUpdate:modelValue":t=>he(e,a.key,"x",t),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"]),u(ve,{"model-value":ge(e[a.key].y),"onUpdate:modelValue":t=>he(e,a.key,"y",t),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"]),u(ve,{"model-value":ge(e[a.key].z),"onUpdate:modelValue":t=>he(e,a.key,"z",t),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID},null,8,["model-value","onUpdate:modelValue","disabled"])]))),128))]),c("div",re,[0!==e.regionID?(k(),m(j,{key:0,waymark:e,size:250},null,8,["waymark"])):(k(),i("div",ie,[u(n,{size:24,color:"var(--el-text-color-placeholder)"},{default:d(()=>[u(v(z))]),_:1})]))])])]),_:2},1024))),128))])])):(k(),i("div",{key:2,class:"empty-state",onClick:s[1]||(s[1]=e=>ue.value?.click())},[c("div",le,[u(n,{size:64},{default:d(()=>[u(v(E))]),_:1})]),c("h2",null,p(v(o)("uisaveEditor.startUsage")),1),c("p",ce,p(v(o)("uisaveEditor.description")),1)]))],32)}}}),[["__scopeId","data-v-72b9f756"]]);export{ue as default};
