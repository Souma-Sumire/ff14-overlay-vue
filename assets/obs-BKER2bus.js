import{t as e,V as a,r as t,f as n,ae as r,v as o,x as l,F as s,O as i,u as c,A as u,M as d,S as m,E as p,h as g,J as f,L as h}from"./vue-vendor-Bp7_Yb1I.js";import{j as y}from"./obs-Blt86nqO.js";import{V as v}from"./index-DMFkdgl3.js";import"./style-l0sNRNKZ.js";import{d as b}from"./content_type-lMHx3DqW.js";import{R as P,N as C,c as D}from"./netregexes-BPXJ-L2_.js";import{a as w}from"./overlay_plugin_api-DHbPkDtN.js";import{U as x}from"./user_config-Dpom12Ks.js";import{z as F}from"./zoneInfo-CyhIZ0MY.js";import{u as T}from"./index-DPl59_9W.js";import"./element-plus-CIPkFfIK.js";import"./zone_id-CumO8ZQS.js";import"./zone_info-CC6h72pn.js";const z={countdownStart:{en:"Battle commencing in (?<time>\\y{Float}) seconds! \\((?<player>.*?)\\)",de:"Noch (?<time>\\y{Float}) Sekunden bis Kampfbeginn! \\((?<player>.*?)\\)",fr:"Début du combat dans (?<time>\\y{Float}) secondes[ ]?! \\((?<player>.*?)\\)",ja:"戦闘開始まで(?<time>\\y{Float})秒！ （(?<player>.*?)）",cn:"距离战斗开始还有(?<time>\\y{Float})秒！ （(?<player>.*?)）",ko:"전투 시작 (?<time>\\y{Float})초 전! \\((?<player>.*?)\\)"},countdownEngage:{en:"Engage!",de:"Start!",fr:"À l'attaque[ ]?!",ja:"戦闘開始！",cn:"战斗开始！",ko:"전투 시작!"},countdownCancel:{en:"Countdown canceled by (?<player>\\y{Name})",de:"(?<player>\\y{Name}) hat den Countdown abgebrochen",fr:"Le compte à rebours a été interrompu par (?<player>\\y{Name})[ ]?\\.",ja:"(?<player>\\y{Name})により、戦闘開始カウントがキャンセルされました。",cn:"(?<player>\\y{Name})取消了战斗开始倒计时。",ko:"(?<player>\\y{Name}) 님이 초읽기를 취소했습니다\\."},areaSeal:{en:"(?<area>.*?) will be sealed off in (?<time>\\y{Float}) seconds!",de:"Noch (?<time>\\y{Float}) Sekunden, bis sich (?<area>.*?) schließt",fr:"Fermeture (?<area>.*?) dans (?<time>\\y{Float}) secondes[ ]?\\.",ja:"(?<area>.*?)の封鎖まであと(?<time>\\y{Float})秒",cn:"距(?<area>.*?)被封锁还有(?<time>\\y{Float})秒",ko:"(?<time>\\y{Float})초 후에 (?<area>.*?)(이|가) 봉쇄됩니다\\."},areaUnseal:{en:"(?<area>.*?) is no longer sealed.",de:"(?<area>.*?) öffnet sich erneut.",fr:"Ouverture (?<area>.*?)[ ]?!",ja:"(?<area>.*?)の封鎖が解かれた……",cn:"(?<area>.*?)的封锁解除了",ko:"(?<area>.*?)의 봉쇄가 해제되었습니다\\."},craftingStart:{en:"You begin synthesizing (?<count>(an?|\\d+) )?(?<recipe>.*)\\.",de:"Du hast begonnen, durch Synthese (?<count>(ein(e|es|em|er)?|\\d+) )?(?<recipe>.*) herzustellen\\.",fr:"Vous commencez à fabriquer (?<count>(une?|\\d+) )?(?<recipe>.*)\\.",ja:"(?<player>\\y{Name})は(?<recipe>.*)(×(?<count>\\d+))?の製作を開始した。",cn:"(?<player>\\y{Name})开始制作“(?<recipe>.*)”(×(?<count>\\d+))?。",ko:"(?<recipe>.*)(×(?<count>\\d+)개)? 제작을 시작합니다\\."},trialCraftingStart:{en:"You begin trial synthesis of (?<recipe>.*)\\.",de:"Du hast mit der Testsynthese von (?<recipe>.*) begonnen\\.",fr:"Vous commencez une synthèse d'essai pour une? (?<recipe>.*)\\.",ja:"(?<player>\\y{Name})は(?<recipe>.*)の製作練習を開始した。",cn:"(?<player>\\y{Name})开始练习制作(?<recipe>.*)。",ko:"(?<recipe>.*) 제작 연습을 시작합니다\\."},craftingFinish:{en:"You synthesize (?<count>(an?|\\d+) )?(?<recipe>.*)()?\\.",de:"Du hast erfolgreich (?<count>(ein(e|es|em|er)?|\\d+) )?(?<recipe>.*)()? hergestellt\\.",fr:"Vous fabriquez (?<count>(une?|\\d+) )?(?<recipe>.*)()?\\.",ja:"(?<player>\\y{Name})は(?<recipe>.*)()?(×(?<count>\\d+))?を完成させた！",cn:"(?<player>\\y{Name})制作“(?<recipe>.*)()?”(×(?<count>\\d+))?成功！",ko:"(?<player>\\y{Name}) 님이 (?<recipe>.*)()?(×(?<count>\\d+)개)?(을|를) 완성했습니다!"},trialCraftingFinish:{en:"Your trial synthesis of (?<recipe>.*) proved a success!",de:"Die Testsynthese von (?<recipe>.*) war erfolgreich!",fr:"Votre synthèse d'essai pour fabriquer (?<recipe>.*) a été couronnée de succès!",ja:"(?<player>\\y{Name})は(?<recipe>.*)の製作練習に成功した！",cn:"(?<player>\\y{Name})练习制作(?<recipe>.*)成功了！",ko:"(?<recipe>.*) 제작 연습에 성공했습니다!"},craftingFail:{en:"Your synthesis fails!",de:"Deine Synthese ist fehlgeschlagen!",fr:"La synthèse échoue\\.{3}",ja:"(?<player>\\y{Name})は製作に失敗した……",cn:"(?<player>\\y{Name})制作失败了……",ko:"제작에 실패했습니다……\\."},trialCraftingFail:{en:"Your trial synthesis of (?<recipe>.*) failed\\.{3}",de:"Die Testsynthese von (?<recipe>.*) ist fehlgeschlagen\\.{3}",fr:"Votre synthèse d'essai pour fabriquer (?<recipe>.*) s'est soldée par un échec\\.{3}",ja:"(?<player>\\y{Name})は(?<recipe>.*)の製作練習に失敗した……",cn:"(?<player>\\y{Name})练习制作(?<recipe>.*)失败了……",ko:"(?<recipe>.*) 제작 연습에 실패했습니다……\\."},craftingCancel:{en:"You cancel the synthesis\\.",de:"Du hast die Synthese abgebrochen\\.",fr:"La synthèse est annulée\\.",ja:"(?<player>\\y{Name})は製作を中止した。",cn:"(?<player>\\y{Name})中止了制作作业。",ko:"제작을 중지했습니다\\."},trialCraftingCancel:{en:"You abandoned trial synthesis\\.",de:"Testsynthese abgebrochen\\.",fr:"Vous avez interrompu la synthèse d'essai\\.",ja:"(?<player>\\y{Name})は製作練習を中止した。",cn:"(?<player>\\y{Name})停止了练习。",ko:"제작 연습을 중지했습니다\\."}};const V=new class{regexes;netRegexes;get localeRegex(){return this.regexes||(this.regexes=this.buildLocaleRegexes(z,e=>P.gameLog({line:`${e}.*?`}))),this.regexes}get localeNetRegex(){return this.netRegexes||(this.netRegexes=this.buildLocaleRegexes(z,e=>C.gameLog({line:`${e}[^|]*?`}))),this.netRegexes}buildLocaleRegexes(e,a){return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,this.buildLocaleRegex(t,a)]))}buildLocaleRegex(e,a){const t=a(e.en);return{en:t,de:void 0!==e.de?a(e.de):t,fr:void 0!==e.fr?a(e.fr):t,ja:void 0!==e.ja?a(e.ja):t,cn:void 0!==e.cn?a(e.cn):t,ko:void 0!==e.ko?a(e.ko):t}}};V.localeRegex;const R=V.localeNetRegex,S=e({__name:"obs",setup(e){const P=[b.DutyRoulette,b.Dungeons,b.DeepDungeons,b.VCDungeonFinder,b.Pvp,b.Trials,b.Raids,b.UltimateRaids],C={Default:"default",UltimateOrRaidOrTrials:"ultimateOrRaidOrTrials",VcOrDeepDungeons:"vcOrDeepDungeons",Pvp:"pvp"},z=JSON.parse(window.localStorage.getItem("obs2-data")??"{}")?.password,V=T("obs-passwd",z??""),S=T("aster-obs-config",{host:"4455",greaterThan:0,userRecFilePath:"",suffixByZone:!0,inCombatStart:!0,autoForZones:P,recFilePaths:Object.fromEntries(Object.values(C).map(e=>[e,""]))});S.value.host=S.value.host.replace(/^.+?:/,"");const N={partyLength:1,inACTCombat:!1,zoneID:0,zoneName:"Unknown",zoneType:C.Default,reason:""},O=a({connected:!1,recording:!1}),j=new y,_=t(!1),k=t(!0),U=t(!1),L={...x.getDefaultBaseOptions()},Z=window.location.href.includes("?dev=1")?console.log:()=>{};async function B(e=!1){return j.connect(`ws://127.0.0.1:${S.value.host}`,V.value).then(()=>(S.value.userRecFilePath||E(),j.call("GetRecordStatus").then(e=>{O.recording=e.outputActive}),v.modal.message({content:"连接成功",status:"success",width:"7rem",size:"mini",top:8}),O.connected=!0,k.value=!1,_.value=!0,Promise.resolve(!0))).catch(()=>(O.connected=!1,e?v.modal.message({content:"连接失败",status:"error",width:"7rem",size:"mini",top:8}):k.value=!1,Promise.resolve(!1)))}async function E(){return j.call("GetRecordDirectory").then(e=>{e.recordDirectory&&(S.value.userRecFilePath=e.recordDirectory,""===S.value.recFilePaths.default&&(S.value.recFilePaths.default=e.recordDirectory))})}async function A(e=!1){if(!O.connected&&!(await B()))return Promise.resolve(!1);let a=S.value.userRecFilePath,t="";S.value.suffixByZone&&(t="%CCYY-%MM-%DD %hh-%mm-%ss"),e||(t&&(t+=` ${N.zoneName.replaceAll(":","_")}`),S.value.userRecFilePath||await E(),a=S.value.recFilePaths[N.zoneType]?.trim(),a||(a=S.value.recFilePaths.default));const n=[];return""!==a&&(Z("[setFolder] ",{revert:e,recFilePath:a}),n.push({requestType:"SetProfileParameter",requestData:{parameterCategory:"SimpleOutput",parameterName:"FilePath",parameterValue:a}}),n.push({requestType:"SetProfileParameter",requestData:{parameterCategory:"AdvOut",parameterName:"RecFilePath",parameterValue:a}})),""!==t&&(Z("[setName] ",{revert:e,filenameFormatting:t}),n.push({requestType:"SetProfileParameter",requestData:{parameterCategory:"Output",parameterName:"FilenameFormatting",parameterValue:t}})),n.length>0?j.callBatch(n):Promise.resolve(!0)}async function I(e,a=!0,t=!1){Z("[obs_start_prepare] ",{recording:O.recording,data:N,reason:e,restart:a,justDoIt:t});try{if("countDown"===N.reason&&(N.reason=e),!t&&N.partyLength<=S.value.greaterThan)return Promise.resolve(!0);if(!O.connected&&!(await B()))return Promise.resolve(!1);if(O.recording&&!a)return Promise.resolve(!0);if(N.reason=e,O.recording&&a&&(await j.call("StopRecord"),await new Promise(e=>setTimeout(e,2e3))),!1!==await A(!1))return await new Promise(e=>setTimeout(e,500)),Z("[obs_start] ",{recording:O.recording,data:N,reason:e,restart:a,justDoIt:t}),j.call("StartRecord").then(()=>setTimeout(()=>A(!0),2e3))}catch(n){}return Promise.resolve(!1)}async function q(e=""){return Z("[obs_stop] ",{recording:O.recording,data:N,reason:e}),O.recording?j.call("StopRecord"):Promise.resolve(!0)}function Y(){O.connected=!1}function M(e){switch(e.outputState){case"OBS_WEBSOCKET_OUTPUT_STARTED":return void(O.recording=!0);case"OBS_WEBSOCKET_OUTPUT_STOPPED":O.recording=!1}}async function $(e){if(O.recording){if(a=e.rawLine,D.wipe.test(a)||/^41\|[^|]*\|[^|]*\|7DE\|/.test(a))return q("wipe");if("countDown"===N.reason&&function(e){return R.countdownCancel[L.ParserLanguage].test(e)}(e.rawLine))return q("countDown")}else if(function(e){return R.countdownStart[L.ParserLanguage].test(e)}(e.rawLine))return I("countDown",!1);var a;return Promise.resolve()}async function K(e){if(N.zoneID===e.zoneID)return Promise.resolve();N.zoneID=e.zoneID,N.zoneName=e.zoneName,N.zoneType=C.Default;const a=F[e.zoneID];return a&&a.contentType?(N.zoneName=a.name[L.ParserLanguage]??e.zoneName,N.zoneType=function(e){switch(e.contentType){case b.UltimateRaids:return C.UltimateOrRaidOrTrials;case b.Pvp:return C.Pvp;case b.DeepDungeons:case b.VCDungeonFinder:return C.VcOrDeepDungeons;case b.Trials:if(e.name.fr?.includes("(extrême)"))return C.UltimateOrRaidOrTrials;break;case b.Raids:if(e.name.en?.includes("(Savage)"))return C.UltimateOrRaidOrTrials}return C.Default}(a),Z(["changeZone"],{data:N,ev:e}),S.value.autoForZones.includes(a.contentType)?I("changeZone",!1):q("changeZone")):(Z(["changeZone"],{data:N,ev:e}),q("changeZone"))}const G=async e=>{if(!S.value.inCombatStart)return Promise.resolve();const a=N.inACTCombat;if(N.inACTCombat=e.detail.inACTCombat,Z(["InCombatChanged"],{now:e.detail.inACTCombat,prev:a,zoneName:N.zoneName,recording:O.recording}),await new Promise(e=>setTimeout(e,500)),!a&&e.detail.inACTCombat)return I("inCombat",!1);const t=F[N.zoneID],n=S.value.autoForZones.includes(t?.contentType??0);return!a||e.detail.inACTCombat||"inCombat"!==N.reason||n?Promise.resolve():q("inCombat")},J=e=>{N.partyLength=e.party?.length||1};function W(e){_.value="settings"!==e,k.value="settings"===e}return n(async()=>{j.on("ExitStarted",Y),j.on("ConnectionClosed",Y),j.on("ConnectionError",Y),j.on("RecordStateChanged",M),x.getUserConfigLocation("obs",L,()=>{w("LogLine",$),w("ChangeZone",K),w("onInCombatChangedEvent",G),w("PartyChanged",J)}),""!==V.value?await B(!0):v.modal.alert({content:"先锁定悬浮窗，再填写端口与密码",title:"初次使用",width:"80%",size:"mini"})}),(e,a)=>{const t=r("vxe-button"),n=r("vxe-form-item"),y=r("vxe-input"),P=r("vxe-switch"),C=r("vxe-checkbox"),D=r("vxe-checkbox-group"),w=r("vxe-form");return l(),o(h,null,[s(u("header",null,[u("div",null,[s(u("i",{class:"vxe-icon-dot icon",style:m({color:c(O).recording?"red":"gray",textShadow:"0px  0px 3px black",margin:"1px"})},null,4),[[i,c(O).connected]]),s(d(t,{class:"btns",icon:"vxe-icon-caret-right",onClick:a[0]||(a[0]=e=>I("manual",!1,!0))},null,512),[[i,c(O).connected&&!c(O).recording]]),s(d(t,{class:"btns",icon:"vxe-icon-close",size:"mini",onClick:a[1]||(a[1]=e=>q("manual"))},null,512),[[i,c(O).connected&&c(O).recording]]),s(d(t,{class:"btns",icon:"vxe-icon-cut",size:"mini",onClick:a[2]||(a[2]=e=>I("manual",!0,!0))},null,512),[[i,c(O).connected&&c(O).recording]]),d(t,{class:"btns settings",icon:"vxe-icon-setting",size:"mini",onClick:a[3]||(a[3]=e=>W("settings"))})])],512),[[i,c(_)]]),s(u("main",null,[d(w,{data:c(S),"collapse-status":!c(U),"custom-layout":"",size:"mini"},{default:p(()=>[s(d(n,{span:"24","class-name":"hidePageBtn"},{default:p(()=>[d(t,{size:"mini",content:"隐藏页面",icon:"vxe-icon-eye-fill-close",onClick:a[4]||(a[4]=e=>W("header"))})]),_:1},512),[[i,c(k)]]),d(n,{span:"24",field:"host",title:"OBS服务器端口"},{default:p(()=>[d(y,{modelValue:c(S).host,"onUpdate:modelValue":a[5]||(a[5]=e=>c(S).host=e),type:"number",size:"small",style:{width:"70%","margin-right":"-5px"}},null,8,["modelValue"]),d(t,{content:"无法输入",size:"mini",icon:"vxe-icon-question",type:"text",status:"info",onClick:a[6]||(a[6]=e=>c(v).modal.message({content:"先点击ACT，再点击悬浮窗，即可正常输入"}))})]),_:1}),d(n,{span:"24",field:"password",title:"OBS服务器密码"},{default:p(()=>[d(y,{modelValue:c(V),"onUpdate:modelValue":a[7]||(a[7]=e=>g(V)?V.value=e:null),size:"small",placeholder:"密码",type:"password"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",field:"inCombatStart",title:"进入战斗自动录制"},{default:p(()=>[d(P,{modelValue:c(S).inCombatStart,"onUpdate:modelValue":a[8]||(a[8]=e=>c(S).inCombatStart=e),"open-label":"是","close-label":"否"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",field:"suffixByZone",title:"录像文件名添加副本名后缀"},{default:p(()=>[d(P,{modelValue:c(S).suffixByZone,"onUpdate:modelValue":a[9]||(a[9]=e=>c(S).suffixByZone=e),"open-label":"是","close-label":"否"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",field:"greaterThan",title:"小队多于"},{default:p(()=>[d(y,{modelValue:c(S).greaterThan,"onUpdate:modelValue":a[10]||(a[10]=e=>c(S).greaterThan=e),size:"small",type:"integer",min:"0",max:"8",style:{width:"3rem"}},null,8,["modelValue"]),a[17]||(a[17]=f(" 人自动录制（8:永不自动） "))]),_:1,__:[17]}),d(n,{span:"24",field:"autoForZones",title:"进入区域自动录制","class-name":"zoneAuto",folding:"","title-overflow":""},{default:p(()=>[d(D,{modelValue:c(S).autoForZones,"onUpdate:modelValue":a[11]||(a[11]=e=>c(S).autoForZones=e)},{default:p(()=>[d(C,{label:c(b).UltimateRaids,content:"绝境战"},null,8,["label"]),d(C,{label:c(b).Raids,content:"大型Raid"},null,8,["label"]),d(C,{label:c(b).Trials,content:"讨伐战"},null,8,["label"]),d(C,{label:c(b).VCDungeonFinder,content:"异闻迷宫"},null,8,["label"]),d(C,{label:c(b).DeepDungeons,content:"深层迷宫"},null,8,["label"]),d(C,{label:c(b).Dungeons,content:"4人迷宫"},null,8,["label"]),d(C,{label:c(b).Pvp,content:"PVP"},null,8,["label"])]),_:1},8,["modelValue"])]),_:1}),d(n,{span:"24",title:"录像目录（须保证目录存在，可留空）",folding:""}),d(n,{span:"24",title:"默认",folding:"","class-name":"recPaths"},{default:p(()=>[d(y,{modelValue:c(S).recFilePaths.default,"onUpdate:modelValue":a[12]||(a[12]=e=>c(S).recFilePaths.default=e),size:"small",placeholder:"留空则使用OBS录像目录",spellcheck:"false"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",title:"高难",folding:"","class-name":"recPaths"},{default:p(()=>[d(y,{modelValue:c(S).recFilePaths.ultimateOrRaidOrTrials,"onUpdate:modelValue":a[13]||(a[13]=e=>c(S).recFilePaths.ultimateOrRaidOrTrials=e),size:"small",placeholder:"绝&零式&极神",spellcheck:"false"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",title:"深层",folding:"","class-name":"recPaths"},{default:p(()=>[d(y,{modelValue:c(S).recFilePaths.vcOrDeepDungeons,"onUpdate:modelValue":a[14]||(a[14]=e=>c(S).recFilePaths.vcOrDeepDungeons=e),size:"small",placeholder:"深层&异闻迷宫",spellcheck:"false"},null,8,["modelValue"])]),_:1}),d(n,{span:"24",title:"PVP",folding:"","class-name":"recPaths"},{default:p(()=>[d(y,{modelValue:c(S).recFilePaths.pvp,"onUpdate:modelValue":a[15]||(a[15]=e=>c(S).recFilePaths.pvp=e),size:"small",placeholder:"玩家对战",spellcheck:"false"},null,8,["modelValue"])]),_:1}),d(n,{span:"24","collapse-node":""},{default:p(()=>[d(t,{size:"mini",status:"primary",icon:"vxe-icon-swap",content:"连接",onClick:a[16]||(a[16]=e=>B(!0))})]),_:1})]),_:1},8,["data","collapse-status"])],512),[[i,c(k)]])],64)}}});export{S as default};
