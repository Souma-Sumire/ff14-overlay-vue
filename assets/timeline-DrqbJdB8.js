import{u as e,_ as t,p as n}from"./TimelineShow-vOs0e287.js";import{a as i,c as l}from"./overlay_plugin_api-DHbPkDtN.js";import{u as o}from"./index-CPPE20Uu.js";import{b as a,j as s}from"./element-plus-BPeHK5i2.js";import{t as c,V as m,r,c as u,f as d,v as f,x as g,H as p,M as y,u as v,L as T,a9 as h,K as b}from"./vue-vendor-Bp7_Yb1I.js";import{_ as j}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./regexes-BKeG-dSP.js";import"./util-u6u0BslC.js";import"./xivapi-CDkmt4QZ.js";const C={id:"wrapper"},w={key:0,class:"optionalTimelines"},k=["onClick"],A={key:6,style:{color:"white","background-color":"black"}},S=j(c({__name:"timeline",setup(c){const j=e(),S=m({loadedTimeline:[],optionalTimeline:[]}),x=r(0),_=r(0-j.configValues.preBattle),B=r(0);let L=!1;const V=o("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),E=new URLSearchParams(location.hash.split("?")[1]),$=r(window.location.href.match(/localhost/)||"1"===E.get("dev")),I=u(()=>S.loadedTimeline.filter(e=>e.sync)),O=u(()=>S.loadedTimeline.filter(e=>e.tts));function D(){z(),S.loadedTimeline.length=0,S.optionalTimeline.length=0;const e=j.getTimeline(V.value);1===e.length?N(e[0]):e.length>1&&(S.optionalTimeline=e)}async function N(e,t=!0){t&&z(),L=!1,e?.timeline&&(S.loadedTimeline=await n(e.timeline),S.loadedTimeline.sort((e,t)=>e.time-t.time),a.success(`加载了${e.name}`)),setTimeout(()=>{L=!0},1e3)}function z(){x.value=0,_.value=0-j.configValues.preBattle,B.value=0;for(const e of S.loadedTimeline)e.alertAlready=!1;for(const e of I.value)e.syncAlready=!1}function F(e,t=!0){t&&(L=!1,setTimeout(()=>{L=!0},1e3)),_.value=0,B.value=0,x.value=(new Date).getTime()+1e3*e,O.value.forEach(e=>{e.alertAlready=!1}),G()}function G(){if(0===x.value)return;_.value=((new Date).getTime()-x.value+B.value)/1e3;const e=O.value.find(e=>!e.alertAlready&&e.time-j.configValues.ttsAdvance<=_.value);e&&(e.alertAlready=!0,e.tts&&H(e.tts)),requestAnimationFrame(G)}function M(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)F(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(t))z();else{const e=I.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&_.value>=e.time-e.windowBefore&&_.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,P(e.jump||e.time))}if(/^.{14} ChatLog 00:0038::/.test(t)){const e=t.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/)?.groups?.name;if(e){const t=j.getTimeline(V.value).find(t=>t.name===e);t&&N(t,!1)}}}}function P(e){0===x.value&&F(0,!1),B.value+=1e3*(e-_.value),O.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}d(()=>{i("onLogEvent",M),i("onPlayerChangedEvent",R),i("ChangeZone",q),i("BroadcastMessage",K),i("onInCombatChangedEvent",U),j.loadTimelineSettings(),a({message:`${j.allTimelines.length}条时间轴已就绪`,type:"info",duration:1500,showClose:!0}),D()});const R=e=>{V.value.jobs[0]!==e.detail.job&&(V.value.jobs[0]=e.detail.job,D())},q=e=>{V.value.zoneId=String(e.zoneID),D()};function H(e,t=!1){e&&(L||t)&&l({call:"cactbotSay",text:e})}const K=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){let t=function(){for(const e of n.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>j.jobList.indexOf(e)-j.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");j.allTimelines=n.allTimelines,j.configValues=n.configValues,j.showStyle=n.showStyle,j.saveTimelineSettings(),a.closeAll(),a({message:"已更新数据",type:"success",duration:5e3,showClose:!1}),D()};const n=e.msg.data;n.allTimelines.length<j.allTimelines.length-1?(a.closeAll(),s.confirm(0===n.allTimelines.length?"传入数据为空. 确定要清空数据吗?":`此次编辑将删除了${j.allTimelines.length-n.allTimelines.length}条时间轴. 确定吗?`,"警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{a({type:"info",message:"操作已取消"})})):t()}"get"===e.msg.type&&function(e,t={}){l({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}("post",j.$state)}};function U(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===x.value?F(0):e.detail.inGameCombat||e.detail.inACTCombat||z()}return(e,n)=>{const i=t;return g(),f("div",C,[v(S).optionalTimeline.length&&v(_)<=-v(j).configValues.preBattle?(g(),f("ul",w,[(g(!0),f(T,null,h(v(S).optionalTimeline,(e,t)=>(g(),f("li",{key:t,onClick:t=>{N(e)}},b(e.name),9,k))),128))])):p("",!0),y(i,{config:v(j).configValues,lines:v(S).loadedTimeline,runtime:v(_),"show-style":v(j).showStyle},null,8,["config","lines","runtime","show-style"]),v($)?(g(),f("button",{key:1,onClick:n[0]||(n[0]=e=>F(30))}," 开始从-30 ")):p("",!0),v($)?(g(),f("button",{key:2,onClick:n[1]||(n[1]=e=>F(0))}," 开始从0 ")):p("",!0),v($)?(g(),f("button",{key:3,onClick:n[2]||(n[2]=e=>z())}," 团灭 ")):p("",!0),v($)?(g(),f("button",{key:4,onClick:n[3]||(n[3]=e=>{P(1e3)})}," 跳转1000测试 ")):p("",!0),v($)?(g(),f("button",{key:5,onClick:n[4]||(n[4]=e=>H("今天天气真不错",!0))}," TTS测试 ")):p("",!0),v($)?(g(),f("span",A,b(v(_)),1)):p("",!0)])}}}),[["__scopeId","data-v-8c931d94"]]);export{S as default};
