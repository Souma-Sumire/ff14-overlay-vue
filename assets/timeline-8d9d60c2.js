import{u as e,_ as t,p as o}from"./TimelineShow-54eac007.js";import{a as n,c as i}from"./overlay_plugin_api-974cdd44.js";import{u as a}from"./index-de57c9c1.js";import{b as l}from"./element-plus-2ee4efb4.js";import{t as s,V as c,r as m,c as u,f as r,v as d,x as f,H as g,M as p,u as y,L as v,a9 as b,K as h}from"./vue-vendor-db4de8ea.js";import{_ as T}from"./_plugin-vue_export-helper-6a8c15be.js";import"./regexes-da03e94d.js";import"./util-c5e2dd68.js";import"./xivapi-e20b15ac.js";const C={id:"wrapper"},j={key:0,class:"optionalTimelines"},w=["onClick"],k={key:7,style:{color:"white","background-color":"black"}},A=T(s({__name:"timeline",setup(s){const T=e(),A=c({loadedTimeline:[],optionalTimeline:[]}),S=m(0),_=m(0-T.configValues.preBattle),x=m(0);let L=!1;const V=a("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),B=new URLSearchParams(location.hash.split("?")[1]),E=m(window.location.href.match(/localhost/)||"1"===B.get("dev")),I=u(()=>A.loadedTimeline.filter(e=>e.sync)),$=u(()=>A.loadedTimeline.filter(e=>e.tts));function O(){N(),A.loadedTimeline.length=0,A.optionalTimeline.length=0;const e=T.getTimeline(V.value);1===e.length?D(e[0]):e.length>1&&(A.optionalTimeline=e)}async function D(e,t=!0){t&&N(),L=!1,e?.timeline&&(A.loadedTimeline=await o(e.timeline),A.loadedTimeline.sort((e,t)=>e.time-t.time),l.success(`加载了${e.name}`)),setTimeout(()=>{L=!0},1e3)}function N(){S.value=0,_.value=0-T.configValues.preBattle,x.value=0;for(const e of A.loadedTimeline)e.alertAlready=!1;for(const e of I.value)e.syncAlready=!1}function z(e,t=!0){t&&(L=!1,setTimeout(()=>{L=!0},1e3)),_.value=0,x.value=0,S.value=(new Date).getTime()+1e3*e,$.value.forEach(e=>{e.alertAlready=!1}),F()}function F(){if(0===S.value)return;_.value=((new Date).getTime()-S.value+x.value)/1e3;const e=$.value.find(e=>!e.alertAlready&&e.time-T.configValues.ttsAdvance<=_.value);e&&(e.alertAlready=!0,e.tts&&q(e.tts)),requestAnimationFrame(F)}function G(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)z(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(t))N();else{const e=I.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&_.value>=e.time-e.windowBefore&&_.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,M(e.jump||e.time))}if(/^.{14} ChatLog 00:0038::/.test(t)){const e=t.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/)?.groups?.name;if(e){const t=T.getTimeline(V.value).find(t=>t.name===e);t&&D(t,!1)}}}}function M(e){0===S.value&&z(0,!1),x.value+=1e3*(e-_.value),$.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}r(()=>{n("onLogEvent",G),n("onPlayerChangedEvent",P),n("ChangeZone",R),n("BroadcastMessage",K),n("onInCombatChangedEvent",U),T.loadTimelineSettings(),l({message:`${T.allTimelines.length}条时间轴已就绪`,type:"info",duration:1500,showClose:!0}),O()});const P=e=>{V.value.jobs[0]!==e.detail.job&&(V.value.jobs[0]=e.detail.job,O())},R=e=>{V.value.zoneId=String(e.zoneID),O()};function q(e,t=!1){e&&(L||t)&&i({call:"cactbotSay",text:e})}function H(){l.closeAll(),l({message:"已更新数据",type:"success",duration:0,showClose:!0})}const K=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>T.jobList.indexOf(e)-T.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");T.allTimelines=t.allTimelines,T.configValues=t.configValues,T.showStyle=t.showStyle,T.saveTimelineSettings(),l.closeAll(),l({message:"已更新数据",type:"success",duration:0,showClose:!0}),O()}"get"===e.msg.type&&function(e,t={}){i({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}("post",T.$state)}};function U(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===S.value?z(0):e.detail.inGameCombat||e.detail.inACTCombat||N()}return(e,o)=>{const n=t;return f(),d("div",C,[y(A).optionalTimeline.length&&y(_)<=-y(T).configValues.preBattle?(f(),d("ul",j,[(f(!0),d(v,null,b(y(A).optionalTimeline,(e,t)=>(f(),d("li",{key:t,onClick:t=>{D(e)}},h(e.name),9,w))),128))])):g("",!0),p(n,{config:y(T).configValues,lines:y(A).loadedTimeline,runtime:y(_),"show-style":y(T).showStyle},null,8,["config","lines","runtime","show-style"]),y(E)?(f(),d("button",{key:1,onClick:o[0]||(o[0]=e=>z(30))}," 开始从-30 ")):g("",!0),y(E)?(f(),d("button",{key:2,onClick:o[1]||(o[1]=e=>z(0))}," 开始从0 ")):g("",!0),y(E)?(f(),d("button",{key:3,onClick:o[2]||(o[2]=e=>N())}," 团灭 ")):g("",!0),y(E)?(f(),d("button",{key:4,onClick:o[3]||(o[3]=e=>{M(1e3)})}," 跳转1000测试 ")):g("",!0),y(E)?(f(),d("button",{key:5,onClick:o[4]||(o[4]=e=>q("今天天气真不错",!0))}," TTS测试 ")):g("",!0),y(E)?(f(),d("button",{key:6,onClick:H}," 弹窗测试 ")):g("",!0),y(E)?(f(),d("span",k,h(y(_)),1)):g("",!0)])}}}),[["__scopeId","data-v-1bfa8b23"]]);export{A as default};
