import{R as e,X as a,$ as i,a0 as s,b as r,n as t,o as n,a1 as l,a2 as o,i as c}from"./element-plus-e8d3f599.js";import{t as m,r as d,e as p,P as u,v as y,x as f,A as g,az as h,c as v,D as b,E as k,K as w,u as F,J as C,G as j,L as N,a9 as I,aB as $,M as E,H as _,S as T,a8 as x,aq as A,F as D,O as L,h as S,R as H,ac as O}from"./vue-vendor-d1e06839.js";import{_ as P}from"./_plugin-vue_export-helper-6a8c15be.js";import"./index-f7be25fa.js";/* empty css                 *//* empty css                     */import{c as R,o as z,d as M,u as W}from"./index-aaf5e89d.js";import{s as G,c as K,a as B}from"./status-84583663.js";import{c as U}from"./clipboard-e5e2548c.js";/* empty css                  *//* empty css                   */import{h as V,g as Z}from"./xivapi-3a0d4d4e.js";/* empty css                  *//* empty css               *//* empty css                  */import{u as J}from"./useDevMode-f627f232.js";import{g as q}from"./actionChinese-e2356100.js";import{U as X}from"./util-c5e2dd68.js";import{l as Y}from"./regexes-da03e94d.js";import{N as Q}from"./netregexes-ed180b06.js";import{a as ee}from"./overlay_plugin_api-974cdd44.js";const ae={class:"upload select"},ie=P(m({__name:"TestLog",emits:["handleLine","beforeHandle","afterHandle"],setup(a,{emit:i}){const s=i,r=d(null),t=d(null);async function n(a){t.value?.classList.remove("drag");const i=a.target.files;if(!i||0===i.length)return;s("beforeHandle");const r=e.service({fullscreen:!0,text:"正在解析……请稍候",lock:!0,spinner:'<div style="width:0;height:0"></div>'});for(let e=0;e<i.length;e++){const a=i[e],r=await a.text();for(const e of r.split("\n"))s("handleLine",e)}r.close(),s("afterHandle"),t.value?.classList.remove("drag")}function l(e){e.preventDefault(),t.value?.classList.add("drag")}function o(e){e.preventDefault(),t.value?.classList.remove("drag")}return p(()=>{r.value?.addEventListener("change",n),t.value?.addEventListener("dragover",l),t.value?.addEventListener("dragleave",o)}),u(()=>{r.value?.removeEventListener("change",n),t.value?.removeEventListener("dragover",l),t.value?.removeEventListener("dragleave",o)}),(e,a)=>(f(),y("div",ae,[g("div",{ref_key:"select",ref:t,class:"upload-select"},[a[0]||(a[0]=g("div",{class:"upload text"},[g("span",null,"+"),g("p",null,"上传或拖入ACT日志")],-1)),g("input",{ref_key:"input",ref:r,type:"file"},null,512)],512)]))}}),[["__scopeId","data-v-8d34df3c"]]),se=[{name:"铁壁",id:1191,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"盾阵",id:1856,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"干预",id:1174,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"预警",id:74,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"武装",id:1176,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"神圣领域",id:82,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"圣光幕帘",id:1362,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"圣盾阵",id:2674,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"骑士的坚守",id:2675,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"壁垒",id:77,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的直觉",id:735,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的勇猛",id:1857,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的武猛",id:1858,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"战栗",id:87,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"复仇",id:89,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"摆脱",id:1457,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死斗",id:409,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的血气",id:2678,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的血潮",id:2679,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初的血烟",id:2680,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"至黑之夜",id:1178,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"弃明投暗",id:746,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"暗影墙",id:747,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"暗黑布道",id:1894,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"行尸走肉",id:810,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"死而不僵",id:811,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"出死入生",id:3255,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"献奉",id:2682,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"石之心",id:1840,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"残暴弹",id:1898,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"伪装",id:1832,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"星云",id:1834,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"光之心",id:1839,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"超火流星",id:1836,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"刚玉之心",id:2683,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"刚玉之清",id:2684,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"神祝祷",id:1218,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"节制",id:1873,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"水流幕",id:2708,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"鼓舞",id:297,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"激励",id:1918,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"炽天的幕帘",id:1917,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"野战治疗阵",id:299,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"异想的幻光",id:317,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"炽天的幻光",id:1875,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"生命回生法",id:2710,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"怒涛之计",id:2711,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"命运之轮",id:849,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"天星交错",id:1889,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"擢升",id:2717,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"中间学派",id:1921,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡诊断",id:2607,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"齐衡诊断",id:2608,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"均衡预后",id:2609,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"坚角清汁",id:2618,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"白牛清汁",id:2619,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"整体论",id:3003,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"整体盾",id:3365,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"输血",id:2612,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"泛输血",id:2613,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"心眼",id:1232,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"金刚极意",id:1179,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"行吟",id:1934,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"策动",id:1951,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"防守之桑巴",id:1826,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"即兴表演结束",id:2697,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"残影",id:488,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"魔罩",id:168,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护之光",id:2702,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"守护纹",id:2597,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"抗死",id:2707,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!0},{name:"雪仇",id:1193,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"牵制",id:1195,type:"multiplier",performance:{physics:1,magic:.5,darkness:0},isFriendly:!1},{name:"昏乱",id:1203,type:"multiplier",performance:{physics:.5,magic:1,darkness:0},isFriendly:!1},{name:"武装解除",id:860,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"减速",id:9,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"体力增加",id:2120,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"腐臭",id:1715,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!1},{name:"智力精神降低",id:2115,type:"multiplier",performance:{physics:0,magic:1,darkness:0},isFriendly:!1},{name:"龙之力",id:2500,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"超硬化",id:1722,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"玄结界",id:2496,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"仙人盾",id:2119,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"强力守护",id:1719,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"哥布防御",id:2114,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"铜墙铁盾",id:194,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"坚守要塞",id:195,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"终极堡垒",id:196,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"原初大地",id:863,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"暗黑之力",id:864,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"灵魂之青",id:1931,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"极致防御",id:3829,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"极致护盾",id:3830,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"戮罪",id:3832,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"暗影卫",id:3835,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"大星云",id:3838,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"坦培拉涂层",id:3686,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"油性坦培拉涂层",id:3687,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"世界树之干",id:3890,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"建筑神之塔",id:3892,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"太阳星座",id:3896,type:"multiplier",performance:{physics:1,magic:1,darkness:1},isFriendly:!0},{name:"神爱抚",id:3903,type:"absorbed",performance:{physics:1,magic:1,darkness:1},isFriendly:!0}],re=[...se],te=new Map;let ne="Chinese";function le(e){if(ne!==e||0===te.size){te.clear();for(const a of"Chinese"===e?se:re){const e=G[a.id][1];a.fullIcon=K(e),te.set(a.id.toString(16).toUpperCase().padStart(2,"0"),a)}ne=e}}function oe(e){return te.get(e)}function ce(e){return 1===e?"useful":0===e?"unuseful":"half-useful"}le("Chinese");function me(e,a){return Object.entries(G).reduce((i,[s,[r,t]])=>(e.test(r)&&i.set(s,{name:r,icon:t,isFriendly:a}),i),new Map)}const de=me(/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/,!0),pe=me(/(?:精神|力量|灵巧|智力){1,2}(?:大幅)?降低/,!1),ue=R("hash"),ye=h("keigennRecord2.1",{state:()=>({userOptions:{scale:v(()=>fe(ue.scale,1)),opacity:v(()=>fe(ue.opacity,.9)),targetType:v(()=>fe(ue.targetType,"icon")),iconType:v(()=>fe(ue.iconType,3)),parseAA:v(()=>fe(ue.parseAA,!0)),parseDoT:v(()=>fe(ue.parseDoT,!1)),minimize:v(()=>fe(ue.minimize,!1)),actionCN:v(()=>fe(ue.actionCN,!0)),statusCN:v(()=>fe(ue.statusCN,!0))},isBrowser:!1}),getters:{icon4k:e=>e.userOptions.scale>=2||window.devicePixelRatio>=2?"_hr1":""},actions:{checkIsBrowser(){this.isBrowser=!window.OverlayPluginApi&&!ue.OVERLAY_WS&&!ue.HOST_PORT,this.isBrowser&&setTimeout(()=>this.checkIsBrowser(),1e3)},formatterName:e=>e,initEnvironment(e){/^[A-Z]\S+ [A-Z]\S+$/.test(e)?le("Global"):le("Chinese")}}});function fe(e,a){return"boolean"==typeof a?"0"!==e&&"false"!==e?.toLocaleLowerCase()&&("1"===e||"true"===e?.toLocaleLowerCase()||a):"number"==typeof a?Number.isNaN(+e)?a:+e:a}function ge(e){return{dodge:"闪避","damage done":"击中","blocked damage":"格挡","parried damage":"招架","instant death":"即死",heal:"治疗","crit heal":"暴击治疗",damage:"普通","crit damage":"暴击","direct hit damage":"直击","crit direct hit damage":"直暴",physics:"物理",magic:"魔法",darkness:"暗黑",dot:"持续伤害"}[e]}function he(e){const a=function(e){switch(!0){case e.endsWith("1"):return"dodge";case e.endsWith("3"):return"damage done";case e.endsWith("5"):return"blocked damage";case e.endsWith("6"):return"parried damage";case e.endsWith("33"):return"instant death";case e.endsWith("4"):return"heal";case/2\w{4}4$/.test(e):return"crit heal";default:throw new Error(`Unknown effect flag ${e}`)}}(e),i=function(e){switch(!0){case/2\w{3}$/.test(e):return"crit damage";case/4\w{3}$/.test(e):return"direct hit damage";case/6\w{3}$/.test(e):return"crit direct hit damage";default:return"damage"}}(e),s=function(e){switch(!0){case/7?[1-4]\w{3}[35]$|[16]$/.test(e):return"physics";case/^E$/.test(e):case/5\w{4}$/.test(e):return"magic";case/^(?:\d0)?3$/.test(e):case/6\w{4}$/.test(e):return"darkness";default:return"physics"}}(e);return{effect:a,properties:i,type:s}}const ve=["3E","113","213","313"],be=["A10","E"],ke=["04"],we=["01","03","05","06","36"];function Fe(e){let a=0,i=e[8]??"",s=e[9]??"";ve.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s),be.includes(i)&&(a+=2,i=e[8+a]??i,s=e[8+a+1]??s);const r=function(e){if(void 0===e)return 0;const a=e.length;if(a<=4)return 0;let i=Number.parseInt(e.slice(0,a-4),16);if("4"===e[a-4]){const s=Number.parseInt(e.slice(a-2,a),16);i=i-s+(s<<16)}return i}(s),t=`00${i}`.slice(-2);return{amount:r,lowByte:t,flags:i,isHeal:ke.includes(t),isAttack:we.includes(t)}}const Ce=[Number(409).toString(16).toUpperCase(),Number(810).toString(16).toUpperCase(),Number(811).toString(16).toUpperCase(),Number(1836).toString(16).toUpperCase()];function je(e){return e.currentHp-e.amount<0&&!e.keigenns.find(e=>Ce.includes(e.effectId))}const Ne={class:"amount"},Ie={class:"row-info"},$e=P(m({__name:"Amount",props:{row:{type:Object,required:!0}},setup(e){const i=e,s=ye().userOptions,r=v(()=>Math.round(i.row.maxHp*+i.row.shield/100)),t=v(()=>Math.round(i.row.currentHp/i.row.maxHp*100)),n=v(()=>i.row.currentHp-i.row.amount),l=v(()=>Math.round(n.value/i.row.maxHp*100));return(o,c)=>{const m=a;return f(),b(m,{"append-to":".wrapper",title:F(s).actionCN?i.row.actionCN:i.row.action,trigger:"hover",enterable:!1,"hide-after":0},{reference:k(()=>[g("span",Ne,[g("span",{class:j(i.row.type)},[g("span",{class:j(""+(F(je)(e.row)?"lethal":""))},w(e.row.amount.toLocaleString().padStart(3,"　")),3)],2)])]),default:k(()=>[g("ul",Ie,[g("li",null,"来源: "+w(i.row.source),1),g("li",null,"目标: "+w(i.row.target),1),g("li",null,"护盾: "+w(F(r))+" ("+w(i.row.shield)+"%)",1),g("li",null,"血量: "+w(i.row.currentHp)+"/"+w(i.row.maxHp)+" ("+w(F(t))+"%)",1),g("li",null,[c[0]||(c[0]=C(" 伤害: ")),g("span",{class:j(i.row.type)},w(i.row.amount),3)]),g("li",null,"剩余: "+w(F(n))+" ("+w(F(l))+"%)",1)])]),_:1},8,["title"])}}}),[["__scopeId","data-v-48c2e188"]]),Ee={key:0},_e={key:1},Te=["title","data-duration","data-sourcePov"],xe=["src","alt"],Ae=P(m({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=ye(),s=i.userOptions,r=i.icon4k;return(i,t)=>"dot"===a.row.type?(f(),y("div",Ee," （不支持） ")):(f(),y("div",_e,[(f(!0),y(N,null,I(a.row.keigenns,(a,i)=>(f(),y("span",{key:i},[g("span",{class:"status",title:`${F(s).statusCN?a.name:a.effect}(${a.source})`,"data-duration":a.remainingDuration,"data-sourcePov":a.isPov},[g("img",{class:j(`statusIcon ${F(ce)(a.performance[e.row.type])}`),src:F(Z)(`/i/${a.fullIcon}${F(r)}.png`),alt:a.effect,loading:"lazy",onError:t[0]||(t[0]=(...e)=>F(V)&&F(V)(...e))},null,42,xe)],8,Te)]))),128)),g("span",null,w("damage done"===e.row.effect?"":F(ge)(e.row.effect)),1)]))}}),[["__scopeId","data-v-31ac037a"]]),De={class:"target"},Le=["src","alt"],Se={key:1,class:"alt-text"},He=P(m({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const a=e,i=ye(),s=d(!1);function r(e){s.value=!0;e.target.style.display="none"}return(e,t)=>{return f(),y("div",De,[F(s)||"icon"!==F(i).userOptions.targetType?(f(),y("span",Se,w(a.row.job),1)):(f(),y("img",{key:0,class:j(`jobIcon cj${F(i).userOptions.iconType}`),src:(n=a.row.jobIcon,l=F(i).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${l}/${n.replace(/([A-Z])/g," $1").trim()}.png`),alt:a.row.jobIcon,onError:r},null,42,Le))]);var n,l}}}),[["__scopeId","data-v-e3fb42e4"]]),Oe="[取消筛选]",Pe=P(m({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const a=e,l=ye().userOptions,o=$("contextMenu"),c=28,m=40,p=64,u=32,h=45,C=d(""),j=d(""),N=d(!1),I=d(0),A=d(0),D=d(null);z(o,()=>{N.value=!1});const L=v(()=>[Oe,...Array.from(new Set(a.rows.map(e=>e[a.actionKey])))]),S=v(()=>[Oe,...Array.from(new Set(a.rows.map(e=>e.job)))]);function H(){if(D.value){const e=D.value[a.actionKey];C.value===e?C.value="":C.value=e,N.value=!1}}function O(){if(D.value){const e=D.value.job;j.value===e?j.value="":j.value=e,N.value=!1}}const P=v(()=>a.rows.filter(e=>{const i=!C.value||C.value===Oe||e[a.actionKey]===C.value,s=!j.value||j.value===Oe||e.job===j.value;return i&&s})),R=v(()=>[{key:"time",title:"时间",dataKey:"time",width:m,align:"center",class:"col-time"},{key:"action",title:"技能",dataKey:a.actionKey,width:p,align:"center",class:"col-action",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:C.value,placeholder:"技能",clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>C.value=e===Oe?"":e},()=>L.value.map(e=>x(n,{key:e,label:e,value:e})))]),cellRenderer:({rowData:e})=>e[a.actionKey]},{key:"target",title:"职业",dataKey:"target",width:u,align:"center",class:"col-target",headerCellRenderer:()=>x("div",{class:"header-filter"},[x(t,{size:"small",modelValue:j.value,placeholder:"职业",clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>j.value=e===Oe?"":e},()=>S.value.map(e=>x(n,{key:e,label:e,value:e})))]),cellRenderer:({rowData:e})=>x(He,{row:e})},{key:"amount",title:"伤害",dataKey:"amount",width:h,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>x($e,{row:e})},{key:"keigenns",title:"减伤",dataKey:"keigenns",width:0,align:"left",flexGrow:1,class:"col-keigenns",cellRenderer:({rowData:e})=>x(Ae,{row:e})}]);let M=null;const W=v(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:i,job:s,keigenns:t,time:n,type:o,effect:c,currentHp:m,maxHp:d,shield:p}=e,u="damage done"===c?"":`,${ge(c)}`,y=`${n} ${s} ${a} ${i.toLocaleString()}(${ge(o)}) 减伤:${0===t.length&&""===u?"无":t.map(e=>l.statusCN?e.name:e.effect).join(",")+u} HP:${m}/${d}(${Math.round(m/d*100)}%)+盾:${Math.round(d*+p/100)}(${p}%)`;U(y).then(()=>{M?.close(),M=r.success({message:"复制成功",duration:800})}).catch(()=>r.error("复制失败"))},onContextmenu:({rowData:e,event:a})=>{const i=a;D.value=e,I.value=i.clientX,A.value=i.clientY,N.value=!0}}));return(e,a)=>{const r=s,t=i;return f(),b(t,{style:{height:"100%",width:"100%"}},{default:k(({height:a,width:i})=>[E(r,{"header-class":"keigenn-table-header",class:"keigenn-table",style:T({"--row-height":`${c}px`}),columns:R.value,data:P.value,width:i,height:a,"row-height":c,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":W.value},null,8,["style","columns","data","width","height","row-height","row-event-handlers"]),F(N)?(f(),y("div",{key:0,ref_key:"contextMenu",ref:o,class:"context-menu",style:T({top:`${F(A)}px`,left:`${F(I)}px`})},[g("ul",null,[g("li",{onClick:H},w(F(C)===(F(D)?.[e.actionKey]??"")?`取消筛选 [${F(D)?.[e.actionKey]??"此技能"}]`:`只看 [${F(D)?.[e.actionKey]??"此技能"}]`),1),g("li",{onClick:O},w(F(j)===F(D)?.job?`取消筛选 [${F(D)?.job??"此职业"}]`:`只看 [${F(D)?.job??"此职业"}]`),1)])],4)):_("",!0)]),_:1})}}}),[["__scopeId","data-v-b1d43eee"]]),Re="function"==typeof structuredClone?structuredClone:e=>{if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e.source,e.flags);if(Array.isArray(e))return e.map(e=>Re(e));const a=new e.constructor;for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(a[i]=Re(e[i]));return a},ze={class:"header-select"},Me={style:{height:"100%"}},We={key:0,class:"testLog"},Ge="souma-keigenn-record-2",Ke=m({__name:"keigennRecord2",setup(e){const a=J();M();const i=ye(),s=i.userOptions;i.checkIsBrowser();const r=d(s.minimize),m=v(()=>s.actionCN?"actionCN":"action"),u=d(!1);let h=!1;const w=W("keigenn-record-2-pov-name",""),$=W("keigenn-record-2-pov-id",""),x=W("keigenn-record-2-party-list",[]),P=W("keigenn-record-2-job-map",{}),R=W("keigenn-record-2-party-event-party",[]),z=d(0),G=d([{zoneName:"",duration:"00:00",table:A([]),key:"init",timestamp:-1}]),U={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:Q.ability(),statusEffectExplicit:Q.statusEffectExplicit(),gainsEffect:Q.gainsEffect(),losesEffect:Q.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:Q.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:Q.addedCombatant(),removingCombatant:Q.removingCombatant(),networkDoT:Q.networkDoT()},V=d(0),Z=W("souma-keigenn-record-2-zone-name",""),ae=W("souma-keigenn-record-2-rsv-data",{}),se={},re={friendly:{},enemy:{}};function te(){var e;u.value=!0,h=!1,V.value=0,z.value=0,G.value.length=0,G.value.push({zoneName:"",duration:"00:00",table:A([]),key:"placeholder",timestamp:-1}),(e=G.value[0]).table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function ne(){G.value=G.value.filter(e=>"00:00"!==e.duration&&0!==e.table.length),h=!0,fe(),u.value=!1}function le(e){for(const a in U){const r=U[a].exec(e);if(r){const t=e.split("|");switch(a){case"statusEffectExplicit":r.groups?.targetId.startsWith("1")&&(se[r.groups?.targetId]=r.groups?.currentShield);break;case"gainsEffect":{const e=t[Y.GainsEffect.fields.effectId],a=t[Y.GainsEffect.fields.effect],i=t[Y.GainsEffect.fields.target],s=t[Y.GainsEffect.fields.targetId],r=Number.parseInt(t[Y.GainsEffect.fields.count],16);let n=oe(e);if(!n){const a=s.startsWith("1")&&de.get(Number.parseInt(e,16).toString())||s.startsWith("4")&&pe.get(Number.parseInt(e,16).toString());if(!a)return;const i=K(a.icon),t=r>1?B(i,r):i;n={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(e,16),fullIcon:t,name:a.name,isFriendly:a.isFriendly}}const l=t[Y.GainsEffect.fields.duration],o=t[Y.GainsEffect.fields.source],c=t[Y.GainsEffect.fields.sourceId],m=new Date(t[Y.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),d={name:n.name,count:r,effect:a,effectId:e,source:o,sourceId:c,target:i,targetId:s,expirationTimestamp:m,performance:n.performance,fullIcon:n.fullIcon,isPov:$.value===c};s.startsWith("1")&&n.isFriendly?(void 0===re.friendly[s]&&(re.friendly[s]={}),re.friendly[s][e]=d):s.startsWith("4")&&!n.isFriendly&&(void 0===re.enemy[i]&&(re.enemy[i]={}),re.enemy[i][e]=d)}break;case"losesEffect":{const e=t[Y.LosesEffect.fields.target],a=t[Y.LosesEffect.fields.targetId],i=t[Y.LosesEffect.fields.effectId];a.startsWith("1")?re.friendly[a]&&Reflect.deleteProperty(re.friendly[a],i):re.enemy[e]&&Reflect.deleteProperty(re.enemy[e],i)}break;case"addCombatant":if("00"!==t[Y.AddedCombatant.fields.job]){const e=t[Y.AddedCombatant.fields.job],a=new Date(t[Y.AddedCombatant.fields.timestamp]).getTime();P.value[t[Y.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a}}break;case"removingCombatant":Reflect.deleteProperty(P.value,t[Y.RemovedCombatant.fields.id]);break;case"primaryPlayer":{$.value=t[Y.ChangedPlayer.fields.id];const e=t[Y.ChangedPlayer.fields.name];if(w.value===e)return;w.value=e,i.initEnvironment(t[Y.ChangedPlayer.fields.name])}break;case"partyList":x.value=r.groups?.list?.split("|")??[];break;case"changeZone":Z.value=t[Y.ChangeZone.fields.name],ue(new Date(t[Y.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const e="1"===t[Y.InCombat.fields.inACTCombat],a="1"===t[Y.InCombat.fields.inGameCombat],i=new Date(t[Y.InCombat.fields.timestamp]).getTime();if(e||a){if(V.value>0)return;return"placeholder"===G.value[0].key&&G.value.splice(0,1),0!==G.value[0].table.length&&(G.value.unshift({zoneName:"",duration:"00:00",table:A([]),key:t[Y.InCombat.fields.timestamp],timestamp:i}),G.value.length>=5&&G.value.splice(G.value.length-1,1)),V.value=i,G.value[0].zoneName=Z.value,void(z.value=0)}if(!e&&!a)return void ue(i)}break;case"rsv":{const e=Number(r.groups?.id),a=t[Y.RSVData.fields.value];e&&a&&(ae.value[Number(e)]=a)}break;case"networkDoT":if(!s.parseDoT)return;{const e=t[Y.NetworkDoT.fields.which],a=t[Y.NetworkDoT.fields.id];if("DoT"!==e||a.startsWith("4")||a!==$.value&&!x.value.includes(a)&&!R.value.find(e=>e.id===a))return;const i=t[Y.NetworkDoT.fields.name],s=t[Y.NetworkDoT.fields.damage],r=Number.parseInt(s,16),n=new Date(t[Y.Ability.fields.timestamp]??"???").getTime(),l=Number(t[Y.NetworkDoT.fields.currentHp]),o=Number(t[Y.NetworkDoT.fields.maxHp]),c=ge(0===V.value?0:n-V.value),m=ce(a),d=X.nameToFullName(X.jobEnumToJob(m)).simple2,p=m,u=X.jobEnumToIcon(p);me({key:G.value[0].table.length.toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:i,targetId:a,job:d,jobIcon:u,jobEnum:p,amount:r,keigenns:[],currentHp:l,maxHp:o,effect:"damage done",type:"dot",shield:se[a],povId:$.value})}break;case"ability":if(0===V.value)return;{const e=Fe(t);if(e.isAttack&&e.amount>=0){const a=t[Y.Ability.fields.sourceId]??"???",i=t[Y.Ability.fields.targetId]??"???";if(!a.startsWith("4")||!i.startsWith("1"))return;if(i!==$.value&&!x.value.includes(i)&&!R.value.find(e=>e.id===i))return;const n=new Date(t[Y.Ability.fields.timestamp]??"???").getTime(),l=t[Y.Ability.fields.ability],o=l.match(/^_rsv_(?<id>\d+)_/),c=t[Y.Ability.fields.id]??"???";let m=l;if(o){const e=Number(o.groups?.id);m=ae.value[e]??l.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(m=m.replace(/unknown_.*/,"攻击"),!1===s.parseAA&&/^攻击|攻撃|[Aa]ttack$/.test(m))return;const d=q(Number.parseInt(c,16)),p=d&&""!==d?d:m,u=Number(t[Y.Ability.fields.targetCurrentHp])??"???",y=Number(t[Y.Ability.fields.targetMaxHp])??"???",f=t[Y.Ability.fields.source]??"???",g=t[Y.Ability.fields.target]??"???",{effect:h,type:v}=he(e.flags),b=ge(0===V.value?0:n-V.value),k=ce(i),w=X.nameToFullName(X.jobEnumToJob(k)).simple2,F=k,C=X.jobEnumToIcon(F),j=Re(Object.values(re.friendly[i]??[]).concat(Object.values(re.enemy[f]??[])).filter(e=>{const a=Math.max(0,(e.expirationTimestamp-n)/1e3);return e.remainingDuration=a>=999?"":a.toFixed(a>.05&&a<.95?1:0),Number(e.remainingDuration)>-3}));me({key:G.value[0].table.length.toString(),time:b,id:c,action:m,actionCN:p,source:f,target:g,targetId:i,job:w,jobIcon:C,jobEnum:F,amount:e.amount,keigenns:j,currentHp:u,maxHp:y,effect:h,type:v,shield:se[r.groups?.targetId??""],povId:$.value}),G.value[0].duration=ge(new Date(t[Y.Ability.fields.timestamp]).getTime()-V.value)}}}}}}function ce(e){return[P.value[e],R.value.find(a=>a.id===e)??{job:0,timestamp:0}].sort((e,a)=>a.timestamp-e.timestamp)[0].job}function me(e){G.value[0].table.unshift(e)}function ue(e){0!==V.value&&(G.value[0].duration=ge(e-V.value),G.value[0]=O(G.value[0]),V.value=0,re.friendly={},re.enemy={},fe())}function fe(){h&&localStorage.setItem(Ge,JSON.stringify(G.value.filter(e=>"placeholder"!==e.key&&e.timestamp>0).slice().sort((e,a)=>a.timestamp-e.timestamp).slice(0,5)))}function ge(e){const a=Math.max(Math.floor(e/6e4),0),i=Math.max(Math.floor((e-6e4*a)/1e3),0);return`${a<10?"0":""}${a}:${i<10?"0":""}${i}`}function ve(){r.value=!r.value}function be(){const e={...G.value[0].table[0],key:crypto.randomUUID()};G.value[0].table.unshift(e)}return i.isBrowser&&(w.value="测试用户"),""!==w.value&&i.initEnvironment(w.value),p(()=>{for(const e in P.value){const a=P.value[e];Date.now()-a.timestamp>864e5&&Reflect.deleteProperty(P.value,e)}!function(){const e=localStorage.getItem(Ge);if(e)try{const a=JSON.parse(e);G.value.length=0,G.value.push(...a)}catch(a){throw G.value.length=0,a}}(),ee("LogLine",e=>{le(e.rawLine)}),ee("PartyChanged",e=>{R.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),ee("ChangePrimaryPlayer",e=>{w.value=e.charName,$.value=Number(e.charID).toString(16).toUpperCase()})}),(e,d)=>{const p=n,u=t,h=c,v=Pe,w=ie;return f(),y(N,null,[g("div",{class:"wrapper",style:T({"--scale":F(s).scale,"--opacity":F(s).opacity}),onContextmenu:d[1]||(d[1]=H(()=>{},["prevent"]))},[g("header",null,[g("div",ze,[D(E(u,{modelValue:F(z),"onUpdate:modelValue":d[0]||(d[0]=e=>S(z)?z.value=e:null),size:"small",class:"combat-select","popup-class-name":"combat-select-popup",offset:0,"show-arrow":!1},{default:k(()=>[(f(!0),y(N,null,I(F(G).length,e=>(f(),b(p,{key:`${F(G)[e-1].key}-${F(G)[e-1].duration}-${F(G)[e-1].zoneName}`,value:e-1,label:`${F(G)[e-1].duration} ${F(G)[e-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[L,!F(r)]])]),E(h,{class:j(["minimize",F(r)?"in-minimize":"not-minimize"]),icon:F(r)?F(l):F(o),circle:"",style:T({opacity:F(r)?.5:1}),onClick:ve},null,8,["class","icon","style"])]),D(g("main",Me,[E(v,{rows:F(G)[F(z)].table,"action-key":F(m)},null,8,["rows","action-key"])],512),[[L,!F(r)]])],36),F(i).isBrowser?(f(),y("div",We,[F(a)?(f(),b(h,{key:0,onClick:be},{default:k(()=>d[2]||(d[2]=[C(" 测试 ")])),_:1,__:[2]})):_("",!0),E(w,{"m-1":"",onBeforeHandle:te,onAfterHandle:ne,onHandleLine:le})])):_("",!0)],64)}}});export{Ke as default};
