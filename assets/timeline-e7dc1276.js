import{_ as e}from"./ActWrapper-5069e8c1.js";import{u as t,p as o,_ as i}from"./TimelineShow-1418601a.js";import{a as n,G as l,v as a}from"./element-plus-901ad096.js";import{u as s}from"./useDev-861d544b.js";import{t as c}from"./tts-30083447.js";import{c as m,a as u}from"./cactbot-49e370f3.js";import{k as r,W as d,r as p,aP as f,c as y,J as g,x as v,y as T,o as b,q as h,l as j,B as k,G as C,u as w,F as x,ae as A,A as _,D as O,E as S}from"./vue-49c48d91.js";import{_ as B}from"./_plugin-vue_export-helper-6a8c15be.js";import"./useDemo-86956ef5.js";import"./res-status-9bc9036c.js";import"./vendor-979eac9e.js";import"./util-3591e9ca.js";import"./chineseToIcon-e0fcd48d.js";import"./xivapi-72ab0990.js";const D={id:"wrapper"},E={key:0,class:"optionalTimelines"},I=["onClick"],V={key:7,style:{color:"white","background-color":"black"}},G=B(r({__name:"timeline",setup(r){const B=t(),G=d({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),L=p(0),N=p(0-B.configValues.preBattle),F=p(0);let P=!1;const z=f("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),$=s(),q=y(()=>G.loadedTimeline.filter(e=>e.sync)),M=y(()=>G.loadedTimeline.filter(e=>e.tts));function R(){J(),G.loadedTimeline.length=0,G.optionalTimeline.length=0;const e=B.getTimeline(z.value);1===e.length?W(e[0]):e.length>1&&(G.optionalTimeline=e,W(e[0]))}async function W(e,t=!0){G.selectedOptionalTimeline=e,t&&J(),P=!1,e?.timeline&&(G.loadedTimeline=await o(e.timeline),G.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{P=!0},1e3)}function J(){L.value=0,N.value=0-B.configValues.preBattle,F.value=0;for(const e of G.loadedTimeline)e.alertAlready=!1;for(const e of q.value)e.syncAlready=!1}function Q(e,t=!0){t&&(P=!1,setTimeout(()=>{P=!0},1e3)),N.value=0,F.value=0,L.value=(new Date).getTime()+1e3*e,M.value.forEach(e=>{e.alertAlready=!1}),Z()}function Z(){if(0===L.value)return;N.value=((new Date).getTime()-L.value+F.value)/1e3;const e=M.value.find(e=>!e.alertAlready&&e.time-B.configValues.ttsAdvance<=N.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;(P||t)&&c(e)}(e.tts)),requestAnimationFrame(Z)}function H(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)Q(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))J();else{const e=q.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&N.value>=e.time-e.windowBefore&&N.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,K(e.jump||e.time))}}}function K(e){0===L.value&&Q(0,!1),F.value+=1e3*(e-N.value),M.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}g(()=>{u("onLogEvent",H),u("onPlayerChangedEvent",U),u("ChangeZone",X),u("BroadcastMessage",te),u("onInCombatChangedEvent",oe),B.loadTimelineSettings(),n({message:`${B.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),R(),ee("hello")});const U=e=>{z.value.jobs[0]!==e.detail.job&&(z.value.jobs[0]=e.detail.job,R())},X=e=>{z.value.zoneId=String(e.zoneID),R()};function Y(){n.closeAll(),n({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){m({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>B.jobList.indexOf(e)-B.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");B.allTimelines=t.allTimelines,B.configValues=t.configValues,B.showStyle=t.showStyle,B.saveTimelineSettings(),n.closeAll(),n({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),R(),ee("success")}"get"===e.msg.type&&ee("post",B.$state)}};function oe(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===L.value?Q(0):e.detail.inGameCombat||e.detail.inACTCombat||J()}return(t,o)=>{const n=l,s=i,m=e;return b(),v(m,null,{default:T(()=>[h("div",D,[w(G).optionalTimeline.length&&w(N)<=-w(B).configValues.preBattle?(b(),j("ul",E,[o[5]||(o[5]=h("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(b(!0),j(x,null,A(w(G).optionalTimeline,(e,t)=>(b(),j("li",{key:t,class:_(w(G).selectedOptionalTimeline===e?"active":""),onClick:t=>{W(e)}},[O(S(e.name)+" ",1),w(G).selectedOptionalTimeline===e?(b(),v(n,{key:0},{default:T(()=>[C(w(a))]),_:1})):k("",!0)],10,I))),128))])):k("",!0),C(s,{config:w(B).configValues,lines:w(G).loadedTimeline,runtime:w(N),"show-style":w(B).showStyle},null,8,["config","lines","runtime","show-style"]),w($)?(b(),j("button",{key:1,onClick:o[0]||(o[0]=e=>Q(30))}," 开始从-30 ")):k("",!0),w($)?(b(),j("button",{key:2,onClick:o[1]||(o[1]=e=>Q(0))}," 开始从0 ")):k("",!0),w($)?(b(),j("button",{key:3,onClick:o[2]||(o[2]=e=>J())}," 团灭 ")):k("",!0),w($)?(b(),j("button",{key:4,onClick:o[3]||(o[3]=e=>{K(1e3)})}," 跳转1000测试 ")):k("",!0),w($)?(b(),j("button",{key:5,onClick:o[4]||(o[4]=e=>w(c)("今天天气真不错"))}," TTS测试 ")):k("",!0),w($)?(b(),j("button",{key:6,onClick:Y}," 弹窗测试 ")):k("",!0),w($)?(b(),j("span",V,S(w(N)),1)):k("",!0)])]),_:1})}}}),[["__scopeId","data-v-4043b642"]]);export{G as default};
