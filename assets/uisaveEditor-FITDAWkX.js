const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-element-plus-DviEGymo.js","assets/vendor-vue-iK2zA9mI.js","assets/vendor-vue-DWnTz46N.css","assets/vendor-element-plus-DIgZjo4S.css"])))=>i.map(i=>d[i]);
import{_ as e,p as a,M as t,l as s,i as n,x as o,Z as r}from"./shared-core-DjphjpVF.js";import{b as i,a as l,_ as c}from"./shared-common-D_wk7g3H.js";import{o as u,bE as d,H as v,K as p,I as m,J as f,Z as y,u as g,X as k,v as b,R as h,am as w,a9 as D,r as I,t as E,Y as A}from"./vendor-vue-iK2zA9mI.js";import{e as x,L as _,n as z,a as T,M as U,N as O,g as j,b as C,O as S,P as F,E as Z,f as M}from"./vendor-element-plus-DviEGymo.js";import{_ as L}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-Cv6RznfP.js";import{_ as V}from"./zoneSelecter-DD4jCImf.js";import"./cactbot-DRs0Yy4Y.js";import"./map-DW4z5uTS.js";const Y={key:0,class:"drag-full-overlay"},$={class:"overlay-content"},N={class:"sub-text"},X={class:"header-container"},B={class:"header-left"},P={class:"title-group"},R={key:0,class:"status-badges"},J={class:"header-right"},W={class:"action-buttons"},q={key:1,class:"content"},K={class:"marks-grid"},H={class:"card-header"},Q={class:"card-title"},G={class:"index-num"},ee={class:"map-id-text"},ae={style:{display:"flex",gap:"0"}},te={class:"waymark-content"},se={class:"waymark-controls"},ne={class:"control-header"},oe={class:"col-mark"},re={class:"waymark-map-container"},ie={key:1,class:"empty-map-placeholder"},le={class:"empty-icon-wrapper"},ce={class:"upload-text"},ue=c(u({__name:"uisaveEditor",setup(c){const{t:u}=d(),ue=I(null),de=I(null),ve=I(!1),pe=I(!1),me=I(!1),fe=I(6);let ye=0;const ge=e=>e/1e3;function ke(){me.value=!0}const be=(e,a)=>0!==(e.enableFlag&a);function he(e,a,t,s){var n;void 0!==s&&(e[a][t]=(n=s,Math.round(1e3*n)),ke())}async function we(t){const s=(await e(async()=>{const{ElLoading:e}=await import("./vendor-element-plus-DviEGymo.js").then(e=>e.aQ);return{ElLoading:e}},__vite__mapDeps([0,1,2,3]))).ElLoading.service({lock:!0,text:"正在解析 UISAVE.DAT...",background:"rgba(0, 0, 0, 0.7)"});pe.value=!0;try{await new Promise(e=>setTimeout(e,50)),de.value=await a(await t.arrayBuffer()),fe.value=12;const e=()=>{de.value&&fe.value<de.value.wayMarks.length&&(fe.value+=12,requestAnimationFrame(e))};requestAnimationFrame(e),requestAnimationFrame(e),T.success(u("uisaveEditor.importSuccess")),me.value=!1}catch(n){T.error(`解析失败: ${n instanceof Error?n.message:String(n)}`)}finally{pe.value=!1,s.close()}}function De(){if(!de.value)return;const{wayMarks:e,markerHeader:a,markerTail:s,otherSections:n,userID:r,payloadUnknown:i,fileFormatVersion:l,fileUnknown:c,belongsToWaymarkDat:d}=de.value;if(d){const a=new Uint8Array(104*e.length);e.forEach((e,s)=>{const n=104*s,o=new DataView(a.buffer,a.byteOffset+n,104);t.forEach((a,t)=>{o.setInt32(12*t,e[a.key].x,!0),o.setInt32(12*t+4,e[a.key].y,!0),o.setInt32(12*t+8,e[a.key].z,!0)}),a[n+96]=e.enableFlag,a[n+97]=e.unknown,o.setUint16(98,e.regionID,!0),o.setInt32(100,e.timestamp,!0)});const s=URL.createObjectURL(new Blob([a],{type:"application/octet-stream"})),n=document.createElement("a");return n.href=s,n.download="WAYMARK.DAT",n.click(),URL.revokeObjectURL(s),me.value=!1,void T.success(u("uisaveEditor.exportSuccess"))}const v=new Uint8Array(16+104*e.length+s.length);v.set(a,0),e.forEach((e,a)=>{const s=16+104*a,n=new DataView(v.buffer,v.byteOffset+s,104);t.forEach((a,t)=>{n.setInt32(12*t,e[a.key].x,!0),n.setInt32(12*t+4,e[a.key].y,!0),n.setInt32(12*t+8,e[a.key].z,!0)}),v[s+96]=e.enableFlag,v[s+97]=e.unknown,n.setUint16(98,e.regionID,!0),n.setInt32(100,e.timestamp,!0)}),v.set(s,16+104*e.length);const p=new Uint8Array(16+v.length+4),m=new DataView(p.buffer);m.setInt16(0,17,!0),m.setInt32(8,v.length,!0),p.set(v,16);const f=new Uint8Array(16+n.length+p.length);f.set(i,0),new DataView(f.buffer).setBigInt64(8,r,!0),f.set(n,16),f.set(p,16+n.length);const y=o(f),g=new Uint8Array(16+y.length),k=new DataView(g.buffer);g.set(l,0),k.setInt32(8,y.length,!0),g.set(c,12),g.set(y,16);const b=URL.createObjectURL(new Blob([g],{type:"application/octet-stream"})),h=document.createElement("a");h.href=b,h.download="UISAVE.DAT",h.click(),URL.revokeObjectURL(b),me.value=!1,T.success(u("uisaveEditor.exportSuccess"))}const Ie=new Set(["X","Y","Z","ID","Active"]),Ee=new Set(["Name","MapID","A","B","C","D","One","Two","Three","Four"]);async function Ae(e){try{const a=await Z.prompt(u("uisaveEditor.pastePrompt"),u("uisaveEditor.importTitle"),{confirmButtonText:u("uisaveEditor.import"),cancelButtonText:u("uisaveEditor.cancel"),inputType:"textarea",inputPlaceholder:'{"Name":...,"MapID":...,"A":{...}...}',inputPattern:/^\{.*\}$/,inputErrorMessage:u("uisaveEditor.jsonError"),closeOnClickModal:!1,customClass:"ppjson-import-dialog",inputValidator:e=>{if(!e)return u("uisaveEditor.inputEmpty");try{const a=function(e){if("object"!=typeof e||null===e)return"输入必须是 JSON 对象";for(const s of Object.keys(e))if(!Ee.has(s))return`根节点包含非法字段: ${s}`;const a=e;if("number"!=typeof a.MapID)return"缺少 MapID 或类型错误 (应为数字)";if("Name"in a&&"string"!=typeof a.Name)return"Name 字段类型错误 (应为字符串)";const t=["A","B","C","D","One","Two","Three","Four"];for(const s of t)if(s in a){const e=a[s];if("object"!=typeof e||null===e)return`标点 ${s} 格式错误 (应为对象)`;for(const a of Object.keys(e))if(!Ie.has(a))return`标点 ${s} 包含非法字段: ${a}`;if("number"!=typeof e.X)return`标点 ${s}.X 类型错误 (应为数字)`;if("number"!=typeof e.Y)return`标点 ${s}.Y 类型错误 (应为数字)`;if("number"!=typeof e.Z)return`标点 ${s}.Z 类型错误 (应为数字)`;if("ID"in e&&"number"!=typeof e.ID)return`标点 ${s}.ID 类型错误 (应为数字)`;if("Active"in e&&"boolean"!=typeof e.Active)return`标点 ${s}.Active 类型错误 (应为布尔值)`}return!0}(JSON.parse(e));return!0===a||`${u("uisaveEditor.invalidPPJson")}: ${a}`}catch{return u("uisaveEditor.jsonError")}}}),{value:s}=a,n=s;if(!n)return;const o=JSON.parse(n),r=de.value?.wayMarks[e];if(!r)return;r.regionID=o.MapID;const i={A:"A",B:"B",C:"C",D:"D",One:"One",Two:"Two",Three:"Three",Four:"Four"},l=(e,a)=>{0!==(r.enableFlag&e)!==a&&(r.enableFlag^=e)};for(const[e,c]of Object.entries(i)){const a=o[e],s=a?{...a,Active:a.Active??!0}:{X:0,Y:0,Z:0,ID:0,Active:!1};he(r,c,"x",s.X),he(r,c,"y",s.Y),he(r,c,"z",s.Z);const n=t.find(e=>e.key===c);n&&l(n.bit,s.Active)}ke(),ke(),T.success(u("uisaveEditor.importSuccess"))}catch(a){if("cancel"===a)return;T.error(u("uisaveEditor.importFail"))}}function xe(e){const a=e.target.files?.[0];a&&we(a)}function _e(e){ve.value=!1,ye=0;const a=e.dataTransfer?.files[0];a?.name.toLowerCase().endsWith(".dat")&&we(a)}function ze(){ye++,ve.value=!0}function Te(){ye--,0===ye&&(ve.value=!1)}return(e,a)=>{const o=x,c=_,d=z,I=l,Z=j,pe=C,ye=M;return E(),v("div",{class:"uisave-editor",onDragenter:D(ze,["prevent"]),onDragover:a[2]||(a[2]=D(()=>{},["prevent"])),onDragleave:D(Te,["prevent"]),onDrop:D(_e,["prevent"])},[ve.value?(E(),v("div",Y,[p("div",$,[m(o,{size:80,color:"var(--el-color-primary)"},{default:f(()=>[m(g(U))]),_:1}),p("p",null,y(g(u)("uisaveEditor.dropToLoad")),1),p("span",N,y(g(u)("uisaveEditor.description")),1)])])):k("",!0),p("header",X,[p("div",B,[p("div",P,[p("h1",null,y(g(u)("uisaveEditor.title")),1),de.value?(E(),v("div",R,[me.value?(E(),b(c,{key:0,type:"danger",effect:"dark",round:"",size:"small",class:"unsaved-tag"},{default:f(()=>[A(" ● "+y(g(u)("uisaveEditor.unsaved")),1)]),_:1})):k("",!0)])):k("",!0)])]),p("div",J,[p("input",{ref_key:"fileInput",ref:ue,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:xe},null,544),p("div",W,[m(d,{class:"action-btn import-btn",size:"small",round:"",onClick:a[0]||(a[0]=e=>ue.value?.click())},{default:f(()=>[m(o,{class:"el-icon--left"},{default:f(()=>[m(g(U))]),_:1}),A(" "+y(g(u)("uisaveEditor.parseDat")),1)]),_:1}),m(d,{class:"action-btn export-btn",type:"primary",size:"small",round:"",disabled:!de.value,onClick:De},{default:f(()=>[m(o,{class:"el-icon--left"},{default:f(()=>[m(g(O))]),_:1}),A(" "+y(g(u)("uisaveEditor.download")),1)]),_:1},8,["disabled"])]),a[3]||(a[3]=p("div",{class:"divider"},null,-1)),m(i),m(I,{"storage-key":"ui-save-editor"})])]),de.value?(E(),v("div",q,[p("div",K,[(E(!0),v(h,null,w(de.value.wayMarks.slice(0,fe.value),(e,i)=>(E(),b(ye,{key:i,shadow:"hover",class:"waymark-card"},{header:f(()=>[p("div",H,[p("div",Q,[p("span",G,"#"+y(i+1),1),p("span",ee,y(g(u)("uisaveEditor.mapId",[e.regionID])),1)]),m(V,{"select-zone":g(n)(e.regionID).toString(),placeholder:g(u)("uisaveEditor.zoneSelectPlaceholder"),width:"100%","show-all-levels":!1,border:!1,class:"header-zone-select","onUpdate:selectZone":a=>{e.regionID=g(s)(Number(a)),ke()}},null,8,["select-zone","placeholder","onUpdate:selectZone"]),p("div",ae,[m(d,{size:"small",icon:g(U),title:`${g(u)("uisaveEditor.import")} PP JSON`,text:"",style:{margin:"0"},onClick:e=>Ae(i)},{default:f(()=>[A(y(g(u)("uisaveEditor.import")),1)]),_:1},8,["icon","title","onClick"]),m(d,{size:"small",icon:g(F),title:`${g(u)("uisaveEditor.copy")} PP JSON`,text:"",style:{margin:"0"},onClick:e=>async function(e){const a=de.value?.wayMarks[e];if(!a)return;const t=r[n(a.regionID)],s={Name:t?.name.cn||t?.name.en||`Zone_${a.regionID}`,MapID:a.regionID,A:{X:ge(a.A.x),Y:ge(a.A.y),Z:ge(a.A.z),ID:0,Active:be(a,1)},B:{X:ge(a.B.x),Y:ge(a.B.y),Z:ge(a.B.z),ID:1,Active:be(a,2)},C:{X:ge(a.C.x),Y:ge(a.C.y),Z:ge(a.C.z),ID:2,Active:be(a,4)},D:{X:ge(a.D.x),Y:ge(a.D.y),Z:ge(a.D.z),ID:3,Active:be(a,8)},One:{X:ge(a.One.x),Y:ge(a.One.y),Z:ge(a.One.z),ID:4,Active:be(a,16)},Two:{X:ge(a.Two.x),Y:ge(a.Two.y),Z:ge(a.Two.z),ID:5,Active:be(a,32)},Three:{X:ge(a.Three.x),Y:ge(a.Three.y),Z:ge(a.Three.z),ID:6,Active:be(a,64)},Four:{X:ge(a.Four.x),Y:ge(a.Four.y),Z:ge(a.Four.z),ID:7,Active:be(a,128)}};await navigator.clipboard.writeText(JSON.stringify(s)),await navigator.clipboard.writeText(JSON.stringify(s)),T.success(u("uisaveEditor.copySuccess"))}(i)},{default:f(()=>[A(y(g(u)("uisaveEditor.copy")),1)]),_:1},8,["icon","title","onClick"])])])]),default:f(()=>[p("div",te,[p("div",se,[p("div",ne,[p("span",oe,y(g(u)("uisaveEditor.active")),1),a[4]||(a[4]=p("span",{class:"col-coord"},"X",-1)),a[5]||(a[5]=p("span",{class:"col-coord"},"Y",-1)),a[6]||(a[6]=p("span",{class:"col-coord"},"Z",-1))]),(E(!0),v(h,null,w(g(t),a=>(E(),v("div",{key:a.key,class:"control-row"},[m(Z,{"model-value":be(e,a.bit),class:"marker-checkbox",disabled:0===e.regionID,onChange:s=>function(e,a){const s=0===(e.enableFlag&a);if(e.enableFlag^=a,ke(),s){const s=t.find(e=>e.bit===a);if(s){const a=e[s.key];0===a.x&&0===a.y&&0===a.z&&(a.x=1e5,a.z=1e5)}}}(e,a.bit)},{default:f(()=>[A(y(a.label),1)]),_:2},1032,["model-value","disabled","onChange"]),m(pe,{"model-value":ge(e[a.key].x),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID,"onUpdate:modelValue":t=>he(e,a.key,"x",t)},null,8,["model-value","disabled","onUpdate:modelValue"]),m(pe,{"model-value":ge(e[a.key].y),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID,"onUpdate:modelValue":t=>he(e,a.key,"y",t)},null,8,["model-value","disabled","onUpdate:modelValue"]),m(pe,{"model-value":ge(e[a.key].z),step:.01,precision:3,controls:!1,size:"small",class:"coord-input",disabled:0===e.regionID,"onUpdate:modelValue":t=>he(e,a.key,"z",t)},null,8,["model-value","disabled","onUpdate:modelValue"])]))),128))]),p("div",re,[0!==e.regionID?(E(),b(L,{key:0,waymark:e,size:250},null,8,["waymark"])):(E(),v("div",ie,[m(o,{size:24,color:"var(--el-text-color-placeholder)"},{default:f(()=>[m(g(S))]),_:1})]))])])]),_:2},1024))),128))])])):(E(),v("div",{key:2,class:"empty-state",onClick:a[1]||(a[1]=e=>ue.value?.click())},[p("div",le,[m(o,{size:64},{default:f(()=>[m(g(U))]),_:1})]),p("h2",null,y(g(u)("uisaveEditor.startUsage")),1),p("p",ce,y(g(u)("uisaveEditor.description")),1)]))],32)}}}),[["__scopeId","data-v-59a2a440"]]);export{ue as default};
