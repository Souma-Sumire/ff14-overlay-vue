let e=!1,r=null,n=null,s=[],t=0;const l={},i={},o=(e,r)=>{n?s?s.push(e):n.send(JSON.stringify(e)):s?s.push([e,r]):window.OverlayPluginApi.callHandler(JSON.stringify(e),r)},a=e=>{y();const r=i[e.type];null==r||r.forEach((r=>{try{r(e)}catch(n){}}))},c=a,d=(e,r)=>{var n;y(),i[e]||(i[e]=[],s||o({call:"subscribe",events:[e]})),null==(n=i[e])||n.push(r)},u=(e,r)=>{if(y(),i[e]){const n=i[e],s=null==n?void 0:n.indexOf(r);void 0!==s&&s>-1&&(null==n||n.splice(s,1))}},v=e=>{y();const r={...e,rseq:0};let s;return n?(r.rseq=t++,s=new Promise(((e,n)=>{l[r.rseq]={resolve:e,reject:n}})),o(r)):s=new Promise(((e,n)=>{o(r,(r=>{if(null===r)return void e(r);const s=JSON.parse(r);s.$error?n(s):e(s)}))})),s},w={},f=e=>{y();const r=e.call;return(w[r]??v)(e)},y=()=>{if(!e){if("undefined"!=typeof window){if(r=new URLSearchParams(window.location.href.split("?")[1]).get("OVERLAY_WS"),null!==r){const e=function(r){n=new WebSocket(r),n.addEventListener("error",(e=>{})),n.addEventListener("open",(()=>{const e=s??[];s=null,o({call:"subscribe",events:Object.keys(i)});for(const r of e)Array.isArray(r)||o(r)})),n.addEventListener("message",(e=>{try{if("string"!=typeof e.data)return;const r=JSON.parse(e.data),n=void 0!==(null==r?void 0:r.rseq)?l[r.rseq]:void 0;void 0!==r.rseq&&n?(r.$error?n.reject(r):n.resolve(r),delete l[r.rseq]):a(r)}catch(r){return}})),n.addEventListener("close",(()=>{s=null,window.setTimeout((()=>{e(r)}),300)}))};e(r)}else{const e=function(){var r;if(!(null==(r=window.OverlayPluginApi)?void 0:r.ready))return void window.setTimeout(e,300);const n=s??[];s=null,window.__OverlayCallback=a,o({call:"subscribe",events:Object.keys(i)});for(const e of n)Array.isArray(e)&&o(e[0],e[1])};e()}window.addOverlayListener=d,window.removeOverlayListener=u,window.callOverlayHandler=f,window.dispatchOverlayEvent=c}e=!0}};export{d as a,f as c,u as r};
