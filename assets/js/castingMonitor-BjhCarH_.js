import"./index-D2SqoTp7.js";/* empty css                  *//* empty css                  *//* empty css                  *//* empty css                */import{U as a}from"./util-DL4pAhxD.js";import{d as t,s as e,p as s,b as r,h as o,e as i}from"./xivapi-BtnvNd5O.js";import{au as n,t as l,v as c,x as d,K as h,a9 as p,F as u,u as g,S as m,A as y,b as f,I,J as b,H as D,f as j,L as w,D as _}from"./vue-vendor-Bbuz3Kwb.js";import{c as T,a as P}from"./overlay_plugin_api-C1Kk3pZW.js";import{_ as v}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{l as C,j as k,d as x,B as $}from"./element-plus-QcyfhpSy.js";const A=new URLSearchParams(window.location.href.split("?")[1]),L=["tank","healer","dps","crafter","gatherer","none"],M=[34563,34564,34565,34566,34567,34568,34569,34570,34571,34572,34573,34574,34575,34576,34577,34578,34579,34580,34581,34582],N=n("castingMonitor",{state:()=>({castData:[],playerId:"",focusTargetId:"",partyData:[],config:{duration:Number(A.get("duration")||15)}}),getters:{partyDataFormatted:t=>t.partyData.sort(((t,e)=>L.indexOf(a.jobToRole(a.jobEnumToJob(t.job)))-L.indexOf(a.jobToRole(a.jobEnumToJob(e.job))))),focusTargetCastArr:a=>a.castData.filter((t=>t.casterId===a.focusTargetId))},actions:{testAction(){const a=M[Math.floor(Math.random()*M.length)];this.pushAction(Date.now(),15,"青魔技能随机",this.focusTargetId,a)},testParty(a){this.handlePartyChanged({party:a?[{id:"10000001",name:"测试张三",job:24,inParty:!0,worldId:0},{id:"10000002",name:"测试李四",job:25,inParty:!0,worldId:0},{id:"10000004",name:"测试王五",job:19,inParty:!0,worldId:0},{id:"10000005",name:"测试赵六",job:23,inParty:!0,worldId:0},{id:"10000006",name:"测试孙七",job:39,inParty:!0,worldId:0},{id:"10000007",name:"测试周八",job:40,inParty:!0,worldId:0},{id:"10000008",name:"测试吴九",job:37,inParty:!0,worldId:0},{id:"10000009",name:"测试郑十",job:38,inParty:!0,worldId:0}]:[]})},async pushAction(a,o,i,n,l,c){if(0===this.partyData.length&&n===this.playerId||this.partyData.length>0&&n===this.focusTargetId){let d=l,h="action",p=!1;if(i.startsWith("item_"))return;i.startsWith("mount_")&&(d=Number.parseInt(i.replace(/^.+_/,""),16),d>983040&&(d=Number.parseInt(d.toString().slice(-5),10),p=!0),h=i.replace(/_.+$/,""));const u=`${a}-${o}-${n}-${l}`,g={casterId:n,time:a,expirationTime:Date.now()+1e3*this.config.duration,logLine:o,src:"",class:"",key:u},m=t.get(d);if(m&&(g.src=`//${m.Host}${m.Icon}`),this.castData.push(g),14===o&&c&&setTimeout((()=>{this.castData=this.castData.filter((a=>(null==a?void 0:a.key)!==u))}),1e3*c-500),i.startsWith("unknown_"))g.src=`${e.first}/i/000000/000405.png`,g.class="action action-category-0";else if(d<1e5){const a=m||await s(h,d,["ID","Icon","ActionCategoryTargetID"]);3===a.ID&&(a.Icon="/i/000000/000104.png"),m||(g.src=await r((null==a?void 0:a.Icon)??"",p)),"action"===h?g.class=`action action-category-${null==a?void 0:a.ActionCategoryTargetID}`:"mount"===h&&(g.class="mount")}}},handleChangePrimaryPlayer(a){this.playerId=a.charID.toString(16).toUpperCase(),this.focusTargetId=this.playerId},handleLogLine(a){"20"===a.line[0]?this.pushAction(Date.now(),14,a.line[5],a.line[2],Number.parseInt(a.line[4],16),Number(a.line[8])):("21"===a.line[0]||"22"===a.line[0]&&"0"===a.line[45])&&this.pushAction(Date.now(),15,a.line[5],a.line[2],Number.parseInt(a.line[4],16))},handlePartyChanged(a){if(a.party.length>0){this.partyData=a.party.filter((a=>a.inParty)).map((a=>({...a,src:""})));for(const a in this.castData)Object.prototype.hasOwnProperty.call(this.castData,a)&&(this.partyData.find((t=>t.id===a))||Reflect.deleteProperty(this.castData,a));Object.keys(this.partyData).includes(this.focusTargetId)||(this.focusTargetId=this.playerId)}else this.focusTargetId=this.playerId,this.partyData.length=0},handleClickChangeTarget(a){a===this.focusTargetId?this.focusTargetId=this.playerId:this.focusTargetId=a,/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(A.get("syncFocusWS")||"")&&T({call:"broadcast",source:"castMonitorOverlay",msg:{targetId:this.focusTargetId}})},cleanUpExpired(){this.castData=this.castData.filter((a=>a.expirationTime>Date.now()))}}}),E={"w-100vw":"",flex:"~ nowrap",class:"main","m-t-1":""},O=["data-casterId"],S=["src"],U=v(l({__name:"Main",setup(a){const t=new URLSearchParams(window.location.href.split("?")[1]),e=N(),s=Number(/^(?:1|true|yes|on|open|enabled)$/i.test(t.get("displayAA")??""));return(a,t)=>(c(),d("div",E,[(c(!0),d(h,null,p(g(e).castData.filter((a=>a.key)),(a=>(c(),d("div",{key:a.key,"data-casterId":a.casterId,class:u(`images ${a.class} logLine${a.logLine} displayAA${g(s)}`),style:m(`--animeDuration: ${g(e).config.duration}s;`)},[y("img",{src:a.src,class:"action-icon",height:"40",loading:"lazy",onError:t[0]||(t[0]=(...a)=>g(o)&&g(o)(...a))},null,40,S),t[1]||(t[1]=y("img",{class:"frame",loading:"lazy"},null,-1))],14,O)))),128))]))}}),[["__scopeId","data-v-67c0fa3f"]]),R={key:0,"z-100":"",flex:"~ gap0 wrap",class:"header-layout"},F=["onClick"],J={flex:"~ nowrap items-end",style:{"align-items":"flex-end",gap:"0.1rem"}},z=["src","onerror"],H=v(l({__name:"Header",setup(t){const e=new URLSearchParams(window.location.href.split("?")[1]),s=N();f((()=>{for(const a of s.partyData)a.src=i(a.job)}));const r=/^(?:1|true|yes|on|open|enabled|undefined)$/i.test(e.get("showHeader")||"true");return(t,e)=>g(r)&&g(s).partyData.length>1?(c(),d("div",R,[(c(!0),d(h,null,p(g(s).partyDataFormatted,((t,e)=>(c(),d("button",{key:e,class:u(["job-lists",g(s).focusTargetId===t.id?"job-lists-focus":""]),"m-0":"","p-0":"",onClick:a=>g(s).handleClickChangeTarget(t.id)},[y("div",J,[y("img",{src:t.src,style:{height:"1.25em"},loading:"lazy",onerror:g(o)},null,8,z),I(" "+b(g(a).nameToFullName(g(a).jobEnumToJob(t.job)).simple2),1)])],10,F)))),128))])):D("",!0)}}),[["__scopeId","data-v-427ac828"]]),W={class:"common-layout"},B={key:0},K=v(l({__name:"castingMonitor",setup(a){const t=N(),e=location.href.includes("localhost");return j((()=>{P("ChangePrimaryPlayer",t.handleChangePrimaryPlayer),P("LogLine",t.handleLogLine),P("PartyChanged",t.handlePartyChanged),P("BroadcastMessage",(a=>{"castMonitorOverlay"===a.source&&(t.focusTargetId=a.msg.targetId)}))})),setInterval((()=>{t.cleanUpExpired()}),1e3),(a,s)=>{const r=H,o=x,i=U,n=$,l=C,h=k;return c(),d("div",W,[w(l,{"items-center":""},{default:_((()=>[w(o,{class:"header-layout"},{default:_((()=>[w(r)])),_:1}),w(n,null,{default:_((()=>[w(i)])),_:1})])),_:1}),g(e)?(c(),d("footer",B,[w(h,{onClick:s[0]||(s[0]=a=>g(t).testParty(!0))},{default:_((()=>s[3]||(s[3]=[I(" 虚假小队 ")]))),_:1}),w(h,{onClick:s[1]||(s[1]=a=>g(t).testParty(!1))},{default:_((()=>s[4]||(s[4]=[I(" 单人 ")]))),_:1}),w(h,{onClick:s[2]||(s[2]=a=>g(t).testAction())},{default:_((()=>s[5]||(s[5]=[I(" Action ")]))),_:1})])):D("",!0)])}}}),[["__scopeId","data-v-bdd5a33a"]]);export{K as default};
