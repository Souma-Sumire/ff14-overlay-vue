import{u as e,p as t,_ as n}from"./TimelineShow-CSvXEVgt.js";import{a as o,c as i}from"./overlay_plugin_api-C1Kk3pZW.js";/* empty css                    */import{u as l}from"./index-bbahPALZ.js";import{b as a,k as s}from"./element-plus-QcyfhpSy.js";import{t as c,V as m,r as u,c as r,f as d,v as f,x as g,u as p,K as v,a9 as y,H as T,L as h,J as b}from"./vue-vendor-Bbuz3Kwb.js";import{_ as C}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./util-DL4pAhxD.js";import"./xivapi-BtnvNd5O.js";const j={id:"wrapper"},w={key:0,class:"optionalTimelines"},k=["onClick"],A={key:6,style:{color:"white","background-color":"black"}},S=C(c({__name:"timeline",setup(c){const C=e(),S=m({loadedTimeline:[],optionalTimeline:[]}),_=u(0),x=u(0-C.configValues.preBattle),B=u(0);let L=!1;const V=l("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),E=new URLSearchParams(location.hash.split("?")[1]),I=u(window.location.href.match(/localhost/)||"1"===E.get("dev")),$=r((()=>S.loadedTimeline.filter((e=>e.sync)))),D=r((()=>S.loadedTimeline.filter((e=>e.tts))));function O(){z(),S.loadedTimeline.length=0,S.optionalTimeline.length=0;const e=C.getTimeline(V.value);1===e.length?N(e[0]):e.length>1&&(S.optionalTimeline=e)}async function N(e,n=!0){n&&z(),L=!1,(null==e?void 0:e.timeline)&&(S.loadedTimeline=await t(e.timeline),S.loadedTimeline.sort(((e,t)=>e.time-t.time)),a.success(`加载了${e.name}`)),setTimeout((()=>{L=!0}),1e3)}function z(){_.value=0,x.value=0-C.configValues.preBattle,B.value=0;for(const e of S.loadedTimeline)e.alertAlready=!1;for(const e of $.value)e.syncAlready=!1}function P(e,t=!0){t&&(L=!1,setTimeout((()=>{L=!0}),1e3)),x.value=0,B.value=0,_.value=(new Date).getTime()+1e3*e,D.value.forEach((e=>{e.alertAlready=!1})),F()}function F(){if(0===_.value)return;x.value=((new Date).getTime()-_.value+B.value)/1e3;const e=D.value.find((e=>!e.alertAlready&&e.time-C.configValues.ttsAdvance<=x.value));e&&(e.alertAlready=!0,e.tts&&q(e.tts)),requestAnimationFrame(F)}function G(e){var t,n,o;for(const i of e.detail.logs){const e=i.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)P(Number.parseInt((null==(t=null==e?void 0:e.groups)?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(i)||/^.{14} ChatLog 00:0038::end$/.test(i)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(i))z();else{const e=$.value.find((e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&x.value>=e.time-e.windowBefore&&x.value<=e.time+Number(e.windowAfter)&&e.sync.test(i)));e&&(e.syncAlready=!0,M(e.jump||e.time))}if(/^.{14} ChatLog 00:0038::/.test(i)){const e=null==(o=null==(n=i.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))?void 0:n.groups)?void 0:o.name;if(e){const t=C.getTimeline(V.value).find((t=>t.name===e));t&&N(t,!1)}}}}function M(e){0===_.value&&P(0,!1),B.value+=1e3*(e-x.value),D.value.forEach((t=>{t.time<e&&(t.alertAlready=!0)}))}d((()=>{o("onLogEvent",G),o("onPlayerChangedEvent",R),o("ChangeZone",Z),o("BroadcastMessage",H),o("onInCombatChangedEvent",J),C.loadTimelineSettings(),a({message:`${C.allTimelines.length}条时间轴已就绪`,type:"info",duration:1500,showClose:!0}),O()}));const R=e=>{V.value.jobs[0]!==e.detail.job&&(V.value.jobs[0]=e.detail.job,O())},Z=e=>{V.value.zoneId=String(e.zoneID),O()};function q(e,t=!1){e&&(L||t)&&i({call:"cactbotSay",text:e})}const H=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){let t=function(){for(const e of n.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort(((e,t)=>C.jobList.indexOf(e)-C.jobList.indexOf(t))),Reflect.deleteProperty(e.condition,"job");C.allTimelines=n.allTimelines,C.configValues=n.configValues,C.showStyle=n.showStyle,C.saveTimelineSettings(),a.closeAll(),a({message:"已更新数据",type:"success",duration:5e3,showClose:!1}),O()};const n=e.msg.data;n.allTimelines.length<C.allTimelines.length-1?s.confirm(0===n.allTimelines.length?"传入数据为空. 确定要清空数据吗?":"你删除了2条以上的时间轴. 确定吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{t()})).catch((()=>{a({type:"info",message:"操作已取消"})})):t()}"get"===e.msg.type&&function(e,t={}){i({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}("post",C.$state)}};function J(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===_.value?P(0):e.detail.inGameCombat||e.detail.inACTCombat||z()}return(e,t)=>{const o=n;return f(),g("div",j,[p(S).optionalTimeline.length&&p(x)<=-p(C).configValues.preBattle?(f(),g("ul",w,[(f(!0),g(v,null,y(p(S).optionalTimeline,((e,t)=>(f(),g("li",{key:t,onClick:t=>{N(e)}},b(e.name),9,k)))),128))])):T("",!0),h(o,{config:p(C).configValues,lines:p(S).loadedTimeline,runtime:p(x),"show-style":p(C).showStyle},null,8,["config","lines","runtime","show-style"]),p(I)?(f(),g("button",{key:1,onClick:t[0]||(t[0]=e=>P(30))}," 开始从-30 ")):T("",!0),p(I)?(f(),g("button",{key:2,onClick:t[1]||(t[1]=e=>P(0))}," 开始从0 ")):T("",!0),p(I)?(f(),g("button",{key:3,onClick:t[2]||(t[2]=e=>z())}," 团灭 ")):T("",!0),p(I)?(f(),g("button",{key:4,onClick:t[3]||(t[3]=e=>{M(1e3)})}," 跳转1000测试 ")):T("",!0),p(I)?(f(),g("button",{key:5,onClick:t[4]||(t[4]=e=>q("今天天气真不错",!0))}," TTS测试 ")):T("",!0),p(I)?(f(),g("span",A,b(p(x)),1)):T("",!0)])}}}),[["__scopeId","data-v-850148a9"]]);export{S as default};
