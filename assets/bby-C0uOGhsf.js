import{_ as e}from"./ActWrapper-DCJHy4g0.js";import{d as a,c as s,o as l,s as t,a as o,t as n,F as r,G as i,r as u,h as d,i as m,aI as c,y as v,aG as p,k as y,w as h,u as b,e as g,m as f,P as k,aP as w}from"./index-B7NsSc6e.js";import{_ as j}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as x}from"./useIndexedDB-BFQzRBFl.js";import{u as I}from"./useWebSocket-C9GlRwtA.js";import{U as C}from"./util-BSI8OlRX.js";import{a as $,r as T,c as A}from"./overlay_plugin_api-DHbPkDtN.js";import{u as D}from"./useDev-D6Xildmb.js";import{E}from"./index-BjVl1nVW.js";import"./useDemo-MIPwthTT.js";import"./index-CGoJNA9G.js";import"./index-DOBpyki-.js";import"./index-B5nQdTIF.js";import"./index-D-si_ViN.js";import"./use-form-common-props-CjZLsMwk.js";import"./validator-BVXu1ySb.js";import"./index-9JEBcZRo.js";import"./index-pDW25uQT.js";import"./index-BMqIVNFc.js";import"./focus-trap-CYFT68r7.js";import"./index-CDalVLll.js";import"./vnode-EM14ti1e.js";const L={class:"user-header"},B={class:"user-info"},_={class:"user-name"},M={key:0,class:"status-badge pre",title:"尚未查询"},S={key:0,class:"status-badge",title:"正在使用 BBY"},F={key:1,class:"status-badge unused",title:"未使用 BBY"},N={class:"user-meta"},P={key:0,class:"user-job"},W={key:1,class:"user-world"},q=j(a({__name:"UserCard",props:{user:{},blurMode:{type:Boolean}},setup:e=>(a,u)=>(l(),s("div",{class:t(["user-card",{"not-responded":e.user.isQueried&&!e.user.hasResponded,"pre-query":!e.user.isQueried,"blur-mode":e.blurMode}])},[o("div",L,[o("div",B,[o("div",_,[o("span",{class:t({"blurred-text":e.blurMode})},n(e.user.name),3),e.user.isQueried?(l(),s(r,{key:1},[e.user.hasResponded?(l(),s("span",S,"BBY")):(l(),s("span",F,"未使用"))],64)):(l(),s("span",M,"尚未查询"))]),o("div",N,[e.user.job?(l(),s("span",P,n(e.user.job),1)):i("",!0),e.user.world?(l(),s("span",W,n(e.user.world),1)):i("",!0)])])])],2))}),[["__scopeId","data-v-80c67691"]]),z={class:"advwm-container"},U={class:"header"},Y={class:"query-methods"},J={class:"query-item"},O=["disabled"],Q={class:"users-section"},R={class:"users-header-row"},H={key:0,class:"status-hint"},X={class:"using-count"},Z={class:"last-query-time"},G={class:"users-list"},K={key:0,class:"empty-state"},V={key:1,class:"debug-section"},ee={style:{"margin-bottom":"16px"}},ae={key:2,class:"history-section"},se={class:"history-header"},le={class:"history-list"},te={class:"snapshot-header"},oe={class:"snapshot-time"},ne={key:0,class:"snapshot-query-time"},re={class:"snapshot-members"},ie={class:"member-name"},ue={key:0,class:"member-world"},de={class:"member-job"},me=j(a({__name:"bby",setup(a){const j=D();I({addWsParam:!0,allowClose:!1});const L={1040:"地平关",1041:"迷雾湿地",1042:"拉诺西亚",1043:"紫水栈桥",1044:"幻影群岛",1045:"摩杜纳",1046:"魔兽领域",1047:"封魔洞",1048:"太阳海岸",1049:"小麦酒港",1050:"银泪湖",1051:"盛夏滩",1052:"葡萄酒港",1053:"黑衣森林",1054:"青磷泉",1055:"金锤台地",1056:"红茶川",1057:"伊修加德",1058:"雪松原",1059:"妖精领",1060:"萌芽池",1061:"执掌峡谷",1062:"密约之塔",1063:"莫拉比湾",1064:"月牙湾",1065:"摇篮树",1066:"樵鸣洞",1067:"尼姆河",1068:"黄金谷",1069:"百灵啼",1070:"天狼星灯塔",1071:"灼热走廊",1072:"私语巨木",1073:"月影岛",1074:"水晶塔",1075:"梦想宫",1076:"白金幻象",1077:"黑金湖",1078:"龙息瀑布",1079:"石卫塔",1080:"铜铃铜山",1081:"神意之地",1082:"狮鹫大桥",1083:"永恒川",1084:"海雾沙滩",1085:"和风流地",1086:"泽梅尔要塞",1087:"巨石丘",1088:"剑斗领域",1089:"黑尘驿站",1090:"睡莲岩",1091:"领航明灯",1092:"海词石窟",1093:"翡翠湖",1094:"雄心广场",1095:"库尔札斯",1096:"流沙迷宫",1097:"芳香堂",1098:"花蜜栈桥",1099:"蓝雾涌泉",1100:"神灵圣域",1101:"白云崖",1102:"海将水渠",1103:"元灵幼树",1104:"沙钟旅亭",1105:"姐妹丘",1106:"静语庄园",1107:"足迹谷",1108:"珊瑚塔",1109:"横断崖",1110:"水上庭院",1111:"无限回廊",1112:"金锭池",1113:"旅人栈桥",1114:"龙纹岩",1115:"海鳗桥廊",1116:"源泉之梯",1117:"秘石塔",1118:"日升门",1119:"西风岬",1120:"审理之门",1121:"拂晓之间",1122:"海狼洞",1123:"橡树原",1124:"魔女咖啡馆",1125:"巨龙首营地",1126:"低语河谷",1127:"芙蓉圆桌",1128:"神握角",1129:"黄金广场",1130:"弯枝牧场",1131:"桤木泉",1132:"镜池栈桥",1133:"白鸥塔",1134:"消逝王都",1135:"跨天桥",1136:"圣人泪",1137:"剑峰",1138:"后桅塔",1139:"白银集市",1140:"来生回廊",1141:"暴风陆门",1142:"幽灵湖",1143:"石绿湖",1144:"黄昏湾",1145:"小阿拉米格",1146:"放浪神礼堂",1147:"荆棘森",1148:"狼烟丘",1149:"圣人旅道",1150:"不悔战泉",1151:"九藤",1152:"荣耀溪",1153:"境树",1154:"狱门蚁穴",1155:"遗忘绿洲",1156:"炎帝陵",1157:"歌咏裂谷",1158:"流沙屋",1159:"八剑士前庭",1160:"巴哈姆特",1161:"诸神黄昏",1162:"王者之剑",1163:"陆行鸟",1164:"神圣裁判所",1165:"冰天宫",1166:"龙巢神殿",1167:"红玉海",1168:"クガネ",1169:"延夏",1170:"潮风亭",1171:"神拳痕",1172:"白银乡",1173:"宇宙和音",1174:"沃仙曦染",1175:"晨曦王座",1176:"梦羽宝境",1177:"海猫茶屋",1178:"柔风海湾",1179:"琥珀原",1180:"太阳海岸",1181:"永恒川",1182:"魔兽领域",1183:"银泪湖",1184:"和风流地",1185:"妖精领",1186:"伊修加德",1188:"小麦酒港",1189:"月影岛",1190:"葡萄酒港",1191:"神灵圣域",1192:"水晶塔",1194:"翡翠湖",1195:"地平关",1196:"迷雾湿地",1197:"库尔札斯",1198:"执掌峡谷",1199:"珊瑚塔",1200:"亚马乌罗提",1201:"红茶川",1202:"萨雷安",1203:"加雷马"},B=["A","B","C","D","One","Two","Three","Four"],_={floorMarker:/^(?<timestamp>^.{14}) WaymarkMarker (?<type>1C):(?<operation>[^:]*):(?<waymark>[^:]*):(?<id>[^:]*):(?<name>[^:]*):(?<x>[^:]*):(?<y>[^:]*):(?<z>[^:]*)(?:$|:)/},M=u([]),S=u(""),F=u(!1),N=u({}),P=u({}),W=u(null),me=d(()=>ge.value.filter(e=>e).length),ce=u(!1),ve=()=>{ce.value=!ce.value},pe=x("bby"),ye=u([]);async function he(){const e=ye.value.map(e=>w(e));await pe.replaceAll(e)}async function be(){ye.value=[],await pe.clear()}const ge=u([]),fe=u(null),ke=d(()=>ge.value.map(e=>{if(!e)return null;const a=M.value.find(a=>a.id===e.id),s=C.jobToFullName(C.jobEnumToJob(e.job)).cn||"",l=!!W.value;return a?{...a,hasResponded:!0,isQueried:l}:{id:e.id,name:e.name,job:s,world:e.world,flags:0,waymarkIndex:-1,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!1,isInitiator:!1,hasResponded:!1,isQueried:l}}).filter(e=>null!==e));function we(e){const a=e-Math.floor(e);return Math.round(100*(a-.01))}const je=(...e)=>F.value&&void 0,xe=(...e)=>F.value&&void 0,Ie=(...e)=>F.value&&void 0;function Ce(e){return e.endsWith("1")}const $e=e=>{for(const a of e.detail.logs){const e=_.floorMarker.exec(a);if(e?.groups){const{operation:a,waymark:s,id:l,x:t,y:o,z:n}=e.groups,r=parseInt(s||"0");if(xe(`[LogEvent] 捕获标点变更: ${a} waymarkIdx:${r} waymarkName:${B[r]} (x:${t}, y:${o}, z:${n})`),!isNaN(r)&&r>=0&&r<=7&&("Add"===a||"Change"===a?P.value[r]={x:parseFloat(t||"0"),y:parseFloat(o||"0"),z:parseFloat(n||"0"),active:!0}:"Delete"===a&&P.value[r]&&(P.value[r].active=!1)),!a||"Add"!==a&&"Change"!==a)continue;if(!(s&&l&&t&&o&&n)){Ie("[LogEvent] 标点数据缺失:",{operation:a,waymark:s,id:l,x:t,y:o,z:n});continue}const i=parseFloat(t||"0"),u=parseFloat(o||"0"),d=parseFloat(n||"0");if(isNaN(r)||r<0||r>7)continue;if(Math.abs(i)>1e4||Math.abs(u)>1e4)continue;const m=we(d),c=Ce(t),v=Ce(o);if(c&&v){xe(`[LogEvent] 检测到特征信号 (WaymarkIdx: ${r}, Flags: 0x${m.toString(16)})`);if(!!(8&m)&&0===r){xe("[LogEvent] 忽略匿名查询广播");continue}const e=ge.value[r];if(!e){Ie(`[LogEvent] 索引 ${r} 对应的是空槽位`);continue}const a=C.jobToFullName(C.jobEnumToJob(e.job)).cn||"";xe(`[LogEvent] 解析成员: ${e.name} (${a})`);Te({id:e.id,name:e.name||"未知",job:a,flags:m,waymarkIndex:r,isAnonymous:!!(1&m),isIdHidden:!!(2&m),isWaymarkEnabled:!!(4&m),isInitiator:!!(8&m),world:e.world})}else je(`[LogEvent] 坐标特征不符 (X:${t}, Y:${o})`)}}};function Te(e){if(e.id===S.value&&e.isInitiator)return;const a=M.value.findIndex(a=>a.id===e.id);a>=0?(xe(`[User] 更新用户信息: ${e.name}`),M.value[a]=e):e.isInitiator&&e.id!==S.value?(xe(`[User] 检测到来自 ${e.name} 的被动查询，清空当前列表`),M.value.length>0&&(xe("[User] 存档当前列表到历史记录"),ye.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:W.value,members:[...M.value]}),he()),W.value=(new Date).toLocaleTimeString(),M.value=[e]):(xe(`[User] 新增响应者: ${e.name}`),M.value.push(e)),xe("当前响应者列表:",M.value)}const Ae=e=>{const a=[];if(e.party&&Array.isArray(e.party))for(const t of e.party)t.id&&t.inParty&&a.push({id:t.id.toUpperCase(),hexId:parseInt(t.id,16),name:t.name||"",job:t.job||0,level:t.level||0,world:L[t.worldId]||""});const s=[...a].sort((e,a)=>e.hexId-a.hexId),l=new Array(8).fill(null);for(let t=0;t<8;t++){const e=(t+3)%8;e<s.length&&(l[t]=s[e]||null)}ge.value=l,xe(l)},De=()=>{const e="A",a=P.value[0]||{x:0,y:0,z:0},s=0===a.x&&0===a.y&&0===a.z;let l=Math.round(10*a.x)/10;l+=l>=0?.01:-.01;let t=Math.round(10*a.y)/10;t+=t>=0?.01:-.01;let o=Math.floor(a.z+.01);o+=.16;const n={Local:!1,[e]:{X:l,Y:o,Z:t,Active:!0}};xe(`[Ask] 计算坐标(索引 0): X=${l}, Y=${o}, Z=${t}`),(e=>{xe("调用鲶鱼精邮差:",JSON.stringify(e)),A({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({...e,LocalOnly:!1})})})(n),M.value.length>0&&(ye.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:W.value,members:[...M.value]}),he()),W.value=(new Date).toLocaleTimeString(),M.value=[],E.closeAll(),E.info({message:"正在获取信号...",position:"top-left",customClass:"bby-mini-notify",showClose:!1}),fe.value&&clearTimeout(fe.value),fe.value=setTimeout(()=>{s&&(xe("清理所有标点"),A({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({LocalOnly:!1,A:{},B:{},C:{},D:{},One:{},Two:{},Three:{},Four:{}})})),fe.value=null,E.closeAll(),M.value.length>0?E.success({message:`发现 ${M.value.length} 名 BBY 成员`,position:"top-left",customClass:"bby-mini-notify",showClose:!1}):E.warning({message:"未发现 BBY 成员",position:"top-left",customClass:"bby-mini-notify",showClose:!1})},1e3)},Ee=e=>{const a=e.charID.toString(16).toUpperCase();S.value!==a&&(S.value=a,xe(`我的 ID 已更新: ${a}`))},Le=()=>{const e=["地平关","迷雾湿地","拉诺西亚","紫水栈桥","幻影群岛"],a=["鸣神小吉","猫三水","苏摩","艾露恩","莉莉丝","阿尔法","欧米茄","泰坦","利维亚桑","希瓦"],s=[];for(let t=0;t<8;t++)s.push({id:(1e3+t).toString(16).toUpperCase(),hexId:1e3+t,name:a[t%a.length],job:1+t%38,level:100,world:e[t%e.length]});ge.value=s;const l=[];s.forEach((e,a)=>{Math.random()>.4&&l.push({id:e.id,name:e.name,job:C.jobToFullName(C.jobEnumToJob(e.job)).cn||"冒险者",flags:0,waymarkIndex:a,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!0,isInitiator:!1,world:e.world})}),W.value=(new Date).toLocaleTimeString(),M.value=l};return m(()=>{!async function(){try{const e=await pe.getAll();e&&e.length>0&&(ye.value=e.sort((e,a)=>a.key.localeCompare(e.key)))}catch(e){}}(),$("onLogEvent",$e),$("PartyChanged",Ae),$("ChangePrimaryPlayer",Ee);const e=c({storageKey:"bby-theme"}),a=v(e);!1===e.value&&a()}),p(()=>{T("onLogEvent",$e),T("PartyChanged",Ae),T("ChangePrimaryPlayer",Ee)}),(a,u)=>{const d=e;return l(),y(d,null,{default:h(()=>[o("div",z,[o("div",U,[u[2]||(u[2]=o("h2",null,"小队里谁在使用BBY",-1)),o("div",Y,[o("div",J,[o("button",{class:t(["ask-btn",{searching:!!fe.value}]),onClick:De,disabled:!!fe.value},n(fe.value?"正在查询...":"主动查询"),11,O),b(j)?(l(),s("button",{key:0,class:"ask-btn fake-test-btn",onClick:Le}," 生成测试数据 ")):i("",!0),u[0]||(u[0]=o("span",{class:"item-desc"},[g(" 通过场地标点通信，需要使用鲶鱼精邮差（你和对方都要）并处于可以标点的同一地图中"),o("br")],-1))]),u[1]||(u[1]=o("div",{class:"query-item passive"},[o("span",{class:"passive-title"},"被动接收"),o("span",{class:"item-desc"},"当队伍内其他玩家发起查询时，此处也会同步显示结果。")],-1))])]),o("div",Q,[o("div",R,[o("h3",null,"当前小队 ("+n(ke.value.length)+")",1),W.value?(l(),s(r,{key:1},[o("span",X,"发现使用中: "+n(M.value.length),1),o("span",Z,"最后查询: "+n(W.value),1)],64)):(l(),s("span",H,"尚未进行查询"))]),o("div",G,[(l(!0),s(r,null,f(ke.value,e=>(l(),y(q,{key:e.id,user:e,"blur-mode":ce.value,onContextmenu:k(ve,["prevent"])},null,8,["user","blur-mode"]))),128))])]),0===ke.value.length?(l(),s("div",K,[...u[3]||(u[3]=[o("p",null,"等待小队数据...",-1)])])):i("",!0),F.value?(l(),s("div",V,[u[11]||(u[11]=o("h3",null,"调试信息",-1)),o("div",ee,[u[4]||(u[4]=o("strong",null,"用户总数:",-1)),g(" "+n(M.value.length),1),u[5]||(u[5]=o("br",null,null,-1)),u[6]||(u[6]=o("strong",null,"应答者数:",-1)),g(" "+n(ke.value.length),1),u[7]||(u[7]=o("br",null,null,-1)),u[8]||(u[8]=o("strong",null,"小队成员数:",-1)),g(" "+n(me.value),1)]),o("details",null,[u[9]||(u[9]=o("summary",null,"用户列表详情",-1)),o("pre",null,n(M.value),1)]),o("details",null,[u[10]||(u[10]=o("summary",null,"标点解析详情",-1)),o("pre",null,n(N.value),1)])])):i("",!0),ye.value.length>0?(l(),s("div",ae,[o("div",se,[o("h3",null,"历史记录 ("+n(ye.value.length)+")",1),o("button",{class:"clear-history-btn",onClick:be},"清空历史")]),o("div",le,[(l(!0),s(r,null,f(ye.value,(e,a)=>(l(),s("div",{key:a,class:"history-item"},[o("div",te,[o("div",oe,"存档时间: "+n(e.timestamp),1),e.queryTime?(l(),s("div",ne,"查询时间: "+n(e.queryTime),1)):i("",!0)]),o("div",re,[(l(!0),s(r,null,f(e.members,e=>(l(),s("div",{key:e.id,class:"history-member-tag"},[o("span",ie,n(e.name),1),e.world?(l(),s("span",ue,n(e.world),1)):i("",!0),o("span",de,n(e.job),1)]))),128))])]))),128))])])):i("",!0)])]),_:1})}}}),[["__scopeId","data-v-45e8a533"]]);export{me as default};
