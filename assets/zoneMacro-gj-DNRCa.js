import{M as e,_ as a}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-C_6lqM5Y.js";import{e as l,f as t,h as o,i as n,j as i,p as s,M as r,k as c,Z as d,l as u,n as m}from"./shared-core-BmMhxsPZ.js";import{d as p,G as b,h as y,a as f,f as k,E as z,u as w,x as h,o as g,w as M,bP as _,p as v,v as C,g as $,e as D,b as x,c as V,F as E,r as Z,y as I,t as P,n as U,s as A,i as T}from"./vendor-vue-lrbWrvEl.js";import{a as N,b as j,_ as S}from"./shared-common-Cq8ZvUJj.js";import{o as L,p as O,q as H,n as W,r as X,t as B,u as Y,v as F,w as J,c as q,j as G,x as K,y as R,A as Q,B as ee,C as ae,D as le,F as te,G as oe,k as ne,h as ie,H as se,I as re,d as ce,J as de,K as ue,g as me}from"./vendor-element-plus-BMs_zvkp.js";import{_ as pe}from"./zoneSelecter-JwVQGo5c.js";import{a as be}from"./cactbot-CmNinDrW.js";import"./map-DW4z5uTS.js";const ye=p({__name:"MarksDiv",props:{macro:{type:Object,required:!0},size:{type:Number,default:180}},setup(a){const t=a,o=l(),n=["A","B","C","D","1","2","3","4"],i=b(()=>{if(!t.macro?.Place)return[];const e=t.macro.Place;return Object.keys(e).map((a,l)=>{const t=e[a];return{key:a,label:n[l]??a,x:Number(t.X),z:Number(t.Z),active:t.Active}})});return(l,t)=>(f(),y(e,{"map-id":Number(k(o).selectZone),"force-territory-type":Number(k(o).selectZone),markers:i.value,size:a.size},null,8,["map-id","force-territory-type","markers","size"]))}}),fe={class:"header-row"},ke={class:"fast-entrance-group"},ze={class:"header-row"},we={class:"badge-group"},he={key:0,class:"subtle-badge from-user"},ge={key:1,class:"subtle-badge from-native"},Me=["innerHTML"],_e={key:0},ve={key:0,class:"macro-content"},Ce={key:1},$e={style:{"margin-bottom":"10px"}},De={class:"dialog-footer"},xe=S(p({__name:"zoneMacro",setup(e){const{t:p}=z(),S=t(),xe=l();w("zoneMacroHideOnStartup",h(!1)).value&&(xe.show=!1),S.value||o({allowClose:!0,addWsParam:!0});const Ve=b(()=>xe.fastEntrance.map(e=>({text:n(e.text),value:e.value}))),Ee=h(null),Ze=h(null),Ie=h(!1),Pe=h(!0),Ue=h([]),Ae=b(()=>i(Number(xe.selectZone))),Te=b(()=>{if(!Ze.value)return[];let e=Ze.value.wayMarks.map((e,a)=>({mark:e,index:a})).filter(e=>0!==e.mark.regionID);return Pe.value&&(e=e.filter(e=>e.mark.regionID===Ae.value)),e});async function Ne(e){const a=e.target,l=a.files?.[0];if(l)try{Ze.value=await s(await l.arrayBuffer()),Ie.value=!0,Pe.value=!1}catch(t){me.error(`Parse failed: ${t}`)}finally{a.value=""}}function je(e){Ue.value=e}function Se(){Ue.value.forEach(({mark:e})=>{const a={};r.forEach(l=>{const t=e[l.key];t&&(a[l.key]={X:t.x/1e3,Y:t.y/1e3,Z:t.z/1e3,Active:(e.enableFlag&l.bit)>0})}),xe.newPlace({...a,Name:`Imported ${new Date(1e3*e.timestamp).toLocaleString()}`,MapID:e.regionID,Editable:!1})}),Ie.value=!1,me.success(p("zoneMacro.importSelected",[Ue.value.length]))}function Le(e){const a=c(e);if(!a)return"Unknown";const l=d[a];return l?u(l.name):"Unknown"}function Oe(e,a){return Le(e.mark.regionID).localeCompare(Le(a.mark.regionID))}return g(()=>{be("ChangeZone",xe.handleChangeZone),M(_(xe,"selectZone"),()=>{const e=(xe.data.zoneId[xe.selectZone]?.map(e=>{const{Editable:a,...l}=e;return l})||m.zoneId[xe.selectZone]||[]).filter(e=>e.Deletability),a=m.zoneId[xe.selectZone]??[];xe.data.zoneId[xe.selectZone]=[...a,...e]},{immediate:!0})}),(e,l)=>{const t=W,o=H,n=B,i=N,s=j,r=O,c=J,d=G,u=K,m=ne,p=oe,b=ie,z=te,w=F,h=ye,g=q,M=Y,_=ce,S=de,me=re,be=L;return v((f(),y(be,{class:"elcontainer"},{default:$(()=>[D(r,{height:"auto",class:"elheader"},{default:$(()=>[x("div",fe,[D(o,{content:"定位到当前区域",placement:"bottom"},{default:$(()=>[D(t,{type:"primary",size:"small",icon:k(X),circle:"",onClick:l[0]||(l[0]=e=>k(xe).positioning())},null,8,["icon"])]),_:1}),D(pe,{"select-zone":k(xe).selectZone,"onUpdate:selectZone":l[1]||(l[1]=e=>k(xe).selectZone=e)},null,8,["select-zone"]),x("div",ke,[(f(!0),V(E,null,Z(k(Ve),(e,a)=>(f(),y(t,{key:a,plain:"",size:"small",onClick:a=>k(xe).selectZone=e.value},{default:$(()=>[I(P(e.text),1)]),_:2},1032,["onClick"]))),128))])]),x("div",ze,[D(t,{type:"success",size:"small",onClick:l[2]||(l[2]=e=>k(xe).newMacro())},{default:$(()=>[I(P(e.$t("zoneMacro.newMacro")),1)]),_:1}),D(t,{type:"primary",size:"small",onClick:l[3]||(l[3]=e=>k(xe).newPlace())},{default:$(()=>[I(P(e.$t("zoneMacro.newWaymark")),1)]),_:1}),D(n,{direction:"vertical",class:"toolbar-divider"}),D(t,{size:"small",color:"#BA5783",onClick:l[4]||(l[4]=e=>k(xe).importPPJSON())},{default:$(()=>[I(P(e.$t("zoneMacro.importPP")),1)]),_:1}),D(t,{size:"small",color:"#9D5C63",onClick:l[5]||(l[5]=e=>k(Ee)?.click())},{default:$(()=>[I(P(e.$t("zoneMacro.importUISAVE")),1)]),_:1}),D(n,{direction:"vertical",class:"toolbar-divider"}),D(t,{type:"warning",size:"small",onClick:l[6]||(l[6]=e=>k(xe).resetZone())},{default:$(()=>[I(P(e.$t("zoneMacro.resetZone")),1)]),_:1}),D(t,{type:"danger",size:"small",onClick:l[7]||(l[7]=e=>k(xe).resetAllData())},{default:$(()=>[I(P(e.$t("zoneMacro.resetAll")),1)]),_:1}),D(n,{direction:"vertical",class:"toolbar-divider"}),D(i,{"storage-key":"zone-macro-theme"}),D(s)])]),_:1}),D(M,{class:"main-content"},{default:$(()=>[D(w,{wrap:"",alignment:"flex-start",class:"macro-grid"},{default:$(()=>[void 0===k(xe).data.zoneId[k(xe).selectZone]||0===k(xe).data.zoneId[k(xe).selectZone].length?(f(),y(c,{key:0,"w-100":"","image-size":150,description:e.$t("zoneMacro.noDataTip")},null,8,["description"])):(f(!0),V(E,{key:1},Z(k(xe).data.zoneId[k(xe).selectZone],(a,l)=>(f(),y(g,{key:l,shadow:"hover",class:"main-box-card"},{default:$(()=>[x("div",we,[a.Deletability?(f(),V("span",he,P(e.$t("zoneMacro.badgeUser")),1)):(f(),V("span",ge,P(e.$t("zoneMacro.badgeNative")),1))]),v(x("p",{class:"macro-title",innerHTML:a.Name},null,8,Me),[[C,!a.Editable]]),v(D(d,{modelValue:a.Name,"onUpdate:modelValue":e=>a.Name=e,size:"small",placeholder:e.$t("zoneMacro.placeholderMacroTitle"),style:{width:"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[C,a.Editable]]),"Text"in a?(f(),V("div",_e,[a.Editable?U("",!0):(f(),V("article",ve,[(f(!0),V(E,null,Z(a.Text?.split("\n"),(e,a)=>(f(),V("div",{key:a,class:"macroText"},P(e),1))),128))])),v(D(d,{modelValue:a.Text,"onUpdate:modelValue":e=>a.Text=e,type:"textarea",size:"small",placeholder:e.$t("zoneMacro.placeholderMacroText"),wrap:"off",autosize:{minRows:3},style:{width:"450px","max-width":"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[C,a.Editable]]),a.Editable?U("",!0):(f(),y(u,{key:1,class:"buttonArea",style:A({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:$(()=>[a.Deletability?(f(),y(t,{key:0,icon:k(R),size:"small",onClick:e=>k(xe).editMacroMacro(a)},null,8,["icon","onClick"])):U("",!0),D(t,{icon:k(Q),type:"info",size:"small",onClick:e=>k(xe).sendMacroEcho(a.Text)},{default:$(()=>[I(P(e.$t("zoneMacro.sendEcho")),1)]),_:1},8,["icon","onClick"]),D(t,{icon:k(ee),type:"primary",size:"small",onClick:e=>k(xe).sendMacroParty(a.Text)},{default:$(()=>[I(P(e.$t("zoneMacro.sendParty")),1)]),_:1},8,["icon","onClick"])]),_:2},1032,["style"])),a.Editable?(f(),y(u,{key:2,class:"buttonAreaEditing"},{default:$(()=>[D(t,{type:"success",size:"small",icon:k(ae),onClick:e=>k(xe).submitMacroMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(f(),y(t,{key:0,type:"danger",size:"small",icon:k(le),onClick:e=>k(xe).deleteMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):U("",!0)]),_:2},1024)):U("",!0)])):U("",!0),"Place"in a?(f(),V("div",Ce,[v(D(w,null,{default:$(()=>[D(z,{data:Object.entries(a.Place).filter(e=>["A","B","C","D","One","Two","Three","Four"].includes(e[0])),border:"",size:"small"},{default:$(()=>[D(p,{align:"center",label:e.$t("zoneMacro.tableActive"),width:"50"},{default:$(e=>[D(m,{modelValue:e.row[1].Active,"onUpdate:modelValue":a=>e.row[1].Active=a,size:"small",style:{"--el-switch-on-color":"#13ce66"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableMark"),width:"50"},{default:$(e=>[x("span",null,P(e.row[0]),1)]),_:1},8,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableX"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.X),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].X,"onUpdate:modelValue":a=>e.row[1].X=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableZ"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.Z),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].Z,"onUpdate:modelValue":a=>e.row[1].Z=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableY"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.Y),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].Y,"onUpdate:modelValue":a=>e.row[1].Y=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"])]),_:2},1032,["data"])]),_:2},1536),[[C,a.Editable]]),D(w,null,{default:$(()=>[(f(),y(h,{key:JSON.stringify(a.Place)+a.Name+l,macro:a,"zone-id":k(xe).selectZone},null,8,["macro","zone-id"]))]),_:2},1024),a.Editable?U("",!0):(f(),y(u,{key:0,class:"buttonArea",style:A({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:$(()=>[D(t,{type:"primary",size:"small",onClick:e=>k(xe).doLocalWayMark(a.Place)},{default:$(()=>[I(P(e.$t("zoneMacro.doLocal")),1)]),_:1},8,["onClick"]),D(t,{type:"primary",size:"small",onClick:e=>k(xe).doPartyWayMark(a.Place)},{default:$(()=>[I(P(e.$t("zoneMacro.doPublic")),1)]),_:1},8,["onClick"]),D(t,{icon:k(se),size:"small",class:"export",onClick:e=>k(xe).exportWaymarksJson(a)},null,8,["icon","onClick"]),a.Deletability?(f(),y(t,{key:0,icon:k(R),size:"small",onClick:e=>k(xe).editMacroPlace(a)},null,8,["icon","onClick"])):U("",!0)]),_:2},1032,["style"])),a.Editable?(f(),y(u,{key:1,class:"buttonAreaEditing"},{default:$(()=>[D(t,{type:"success",size:"small",icon:k(ae),onClick:e=>k(xe).submitMacroPlace(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(f(),y(t,{key:0,type:"danger",size:"small",icon:k(le),onClick:e=>k(xe).deleteMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):U("",!0)]),_:2},1024)):U("",!0)])):U("",!0)]),_:2},1024))),128))]),_:1})]),_:1}),x("input",{ref_key:"fileInput",ref:Ee,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:Ne},null,544),D(me,{modelValue:k(Ie),"onUpdate:modelValue":l[10]||(l[10]=e=>T(Ie)?Ie.value=e:null),title:e.$t("zoneMacro.uisaveDialogTitle"),width:"800px"},{footer:$(()=>[x("div",De,[D(t,{onClick:l[9]||(l[9]=e=>Ie.value=!1)},{default:$(()=>[I(P(e.$t("zoneMacro.cancel")),1)]),_:1}),D(t,{type:"primary",disabled:0===k(Ue).length,onClick:Se},{default:$(()=>[I(P(e.$t("zoneMacro.importSelected",[k(Ue).length])),1)]),_:1},8,["disabled"])])]),default:$(()=>[x("div",$e,[D(_,{modelValue:k(Pe),"onUpdate:modelValue":l[8]||(l[8]=e=>T(Pe)?Pe.value=e:null)},{default:$(()=>[I(P(e.$t("zoneMacro.onlyCurrentZone",[k(Ae),Le(k(Ae))])),1)]),_:1},8,["modelValue"])]),D(z,{data:k(Te),style:{width:"100%"},height:"400",onSelectionChange:je},{default:$(()=>[D(p,{type:"selection",width:"40"}),D(p,{label:e.$t("zoneMacro.slot"),width:"80",align:"center",sortable:"","sort-by":"index"},{default:$(({row:e})=>[I(P(e.index+1),1)]),_:1},8,["label"]),D(p,{prop:"mark.regionID",label:e.$t("zoneMacro.mapID"),width:"100",sortable:"","sort-by":"mark.regionID"},{default:$(({row:e})=>[I(P(e.mark.regionID),1)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.mapName"),sortable:"","sort-method":Oe,"min-width":"150"},{default:$(({row:e})=>[I(P(Le(e.mark.regionID)),1)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.preview"),width:"70",align:"center"},{default:$(({row:e})=>[D(S,{placement:"left",width:280,trigger:"hover"},{reference:$(()=>[D(t,{icon:k(ue),circle:"",size:"small"},null,8,["icon"])]),default:$(()=>[D(a,{waymark:e.mark,size:250},null,8,["waymark"])]),_:2},1024)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.timestamp"),width:"160",sortable:"","sort-by":"mark.timestamp"},{default:$(({row:e})=>[I(P(new Date(1e3*e.mark.timestamp).toLocaleString()),1)]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"])]),_:1},512)),[[C,k(xe).show]])}}}),[["__scopeId","data-v-c8a97a78"]]);export{xe as default};
