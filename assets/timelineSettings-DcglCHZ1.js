import"./index-DXq5ouWs.js";/* empty css                  *//* empty css                */import{u as e,_ as t,p as l}from"./TimelineShow-BY5_iFfi.js";import{l as n}from"./lz-string-uL7b9dJQ.js";/* empty css                 *//* empty css                        *//* empty css                   *//* empty css                  *//* empty css               *//* empty css                  *//* empty css               *//* empty css                *//* empty css                *//* empty css                        *//* empty css                  *//* empty css                  */import{h as a,C as i,D as o,r as s,F as c,e as r,G as d,f as u,H as p,I as m,J as f,z as w,y,m as g,j as b,n as h,K as v,s as _,L as T,M as V,d as x,k as F,l as $,o as k,q as j,N as S,O as C,b as I,P as B,B as A}from"./element-plus-BPeHK5i2.js";import{g as N}from"./actionChinese-BSDFMVcH.js";import{U as z}from"./util-u6u0BslC.js";import{h as E,g as U}from"./xivapi-CDkmt4QZ.js";import{t as P,r as O,V as M,v as J,x as L,M as D,D as H,H as R,A as K,E as q,J as W,S as G,u as Q,h as X,K as Y,L as Z,a9 as ee,d as te,c as le,aq as ne,C as ae,f as ie,w as oe}from"./vue-vendor-Bp7_Yb1I.js";import{_ as se}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as ce}from"./useWebSocket-Dkn8N2er.js";import{c as re}from"./el-space-C6hHzNgb.js";import{h as de}from"./utils-CBOc1lqT.js";import{z as ue}from"./zoneInfo-CyhIZ0MY.js";import{a as pe,c as me}from"./overlay_plugin_api-DHbPkDtN.js";/* empty css                */import{b as fe}from"./index-CPPE20Uu.js";import"./zone_info-CC6h72pn.js";const we=new Map;we.set(26155,{type:"cast",window:[999,999]}),we.set(28027,{type:"cast",window:[999,999]}),we.set(26340,{type:"cast",window:[999,999]}),we.set(25533,{type:"begincast",window:[60,60]}),we.set(26376,{type:"cast",window:[999,999]}),we.set(26814,{type:"begincast",window:[999,999]}),we.set(25313,{type:"begincast",window:[200,200]}),we.set(27526,{type:"begincast",window:[999,999]}),we.set(26215,{type:"cast",window:[500,30]}),we.set(29050,{type:"begincast",window:[200,30]}),we.set(29156,{type:"cast",window:[20,20]}),we.set(27973,{type:"cast",window:[20,20]}),we.set(27937,{type:"begincast",window:[20,20]}),we.set(28059,{type:"begincast",window:[20,20]}),we.set(28060,{type:"begincast",window:[20,20]}),we.set(28061,{type:"begincast",window:[20,20]}),we.set(27956,{type:"begincast",window:[20,20]}),we.set(27957,{type:"begincast",window:[20,20]}),we.set(27952,{type:"begincast",window:[30,30]}),we.set(27969,{type:"begincast",window:[20,20]}),we.set(27971,{type:"begincast",window:[20,20]}),we.set(27939,{type:"begincast",window:[20,20]}),we.set(27966,{type:"begincast",window:[20,20]}),we.set(25316,{type:"begincast",window:[999,999]}),we.set(25544,{type:"begincast",window:[10,10]}),we.set(26379,{type:"begincast",window:[10,10]}),we.set(31552,{type:"begincast",window:[30,30]}),we.set(31573,{type:"begincast",window:[30,30]}),we.set(31573,{type:"begincast",window:[30,30]}),we.set(31617,{type:"begincast",window:[8,8]}),we.set(31624,{type:"begincast",window:[30,30]}),we.set(31649,{type:"begincast",window:[30,30]}),we.set(18864,{type:"cast",window:[10,2.5],once:!0}),we.set(18480,{type:"cast",window:[200,60],once:!0}),we.set(18516,{type:"cast",window:[250,65],once:!0}),we.set(18522,{type:"begincast",window:[500,500],once:!0}),we.set(18552,{type:"begincast",window:[67,67],once:!0}),we.set(18553,{type:"cast",window:[67,67],once:!0}),we.set(19083,{type:"cast",window:[900,0],once:!0}),we.set(40191,{type:"begincast",window:[200,20],once:!0}),we.set(40265,{type:"begincast",window:[500,20],once:!0}),we.set(40246,{type:"begincast",window:[999,30],once:!0}),we.set(40306,{type:"begincast",window:[30,30],once:!0}),we.set(11103,{type:"begincast",window:[310,30],once:!0}),we.set(11517,{type:"begincast",window:[600,30],once:!0}),we.set(11122,{type:"begincast",window:[100,30],once:!0}),we.set(11143,{type:"begincast",window:[60,60],once:!0}),we.set(11126,{type:"begincast",window:[100,100],once:!0}),we.set(11596,{type:"begincast",window:[100,100],once:!0}),we.set(11597,{type:"begincast",window:[100,100],once:!0}),we.set(42785,{type:"begincast",window:[9.6,2],once:!0}),we.set(42838,{type:"cast",window:[77.2,30],once:!0}),we.set(42863,{type:"cast",window:[30,30],once:!0}),we.set(42787,{type:"cast",window:[30,30],once:!0}),we.set(42864,{type:"cast",window:[30,30],once:!0}),we.set(42786,{type:"cast",window:[30,30],once:!0}),we.set(42831,{type:"cast",window:[10,10],once:!0}),we.set(41936,{type:"begincast",window:[10,10],once:!0}),we.set(41939,{type:"begincast",window:[10,10],once:!0}),we.set(42825,{type:"cast",window:[400,10],once:!0}),we.set(41969,{type:"begincast",window:[10,10],once:!0}),we.set(41871,{type:"cast",window:[140,0],once:!0}),we.set(43053,{type:"cast",window:[610,0],once:!0});const ye={class:"query-results"},ge={class:"ability-filter-container"},be={key:0,class:"loading-abilities"},he=["src","alt","onerror"],ve=se(P({__name:"FflogsImport",props:{filters:{}},emits:["showFFlogsToggle","editTimeline"],setup(t,{emit:l}){const n=t,v=l,_=new RegExp("(?<=^|\\/)(?<code>\\w{16,})[#?]fight=(?<fight>\\d+|last)"),T={begincast:"14",cast:"1[56]"},V=O("查询"),x=O(""),F=O(!1),$=O(!1),k=O(0),j=O(!1),S=M({});A();const C=e();async function I(e){$.value=!0,k.value=2,S.player=e;try{await async function(){j.value=!1;const e=[];async function t(l){try{const n=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${S.code}?start=${l}&end=${S.end}&hostility=0&sourceid=${S.player?.id}&api_key=${C.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()});e.push(...n.events),n.nextPageTimestamp&&n.nextPageTimestamp>0&&n.nextPageTimestamp<S.end&&await t(n.nextPageTimestamp)}catch(n){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${n}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function l(t,n){if(n>=0)try{const a=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${S.code}?start=${t}&end=${S.end}&hostility=1&sourceid=${S.bossIDs[n]}&api_key=${C.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()});e.push(...a.events),a.nextPageTimestamp&&a.nextPageTimestamp>0&&a.nextPageTimestamp<S.end&&await l(a.nextPageTimestamp,n),n<S.bossIDs.length-1&&await l(t,n+1)}catch(a){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${a}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}S.abilityFilterEvents.length=0,await Promise.all([t(S.start),l(S.start,0)]);for(const n of e)"begincast"===n.type&&n.sourceIsFriendly||S.abilityFilterEvents.push({time:Number(((n.timestamp-S.start)/1e3).toFixed(1)),type:n.type,actionName:N(n.ability.guid)??n.ability.name,actionId:n.ability.guid,sourceIsFriendly:n.sourceIsFriendly,url:n?.ability?.abilityIcon.replace("-","/").replace(".png","")??"000000/000405",window:void 0});S.player?.icon&&n.filters[S.player.icon]&&(S.abilityFilterSelected=n.filters[S.player.icon]);j.value=!0}(),S.abilityFilterCandidate=S.abilityFilterEvents.reduce((e,t)=>(t.sourceIsFriendly&&!e.find(e=>e.actionId===t.actionId)&&e.push(t),e),[]),$.value=!1}catch(t){b.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${t}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),$.value=!1}}function B(){$.value=!0,k.value=3,S.player?.icon&&C.updateFilters(S.player?.icon,JSON.parse(JSON.stringify(S.abilityFilterSelected))),S.abilityFilterEvents=S.abilityFilterEvents.filter(e=>e.sourceIsFriendly&&S.abilityFilterSelected.includes(e.actionId)||!e.sourceIsFriendly).sort((e,t)=>e.time-t.time),S.abilityFilterEvents=function(e){for(const t of e){const e=we.get(t.actionId);e?.type===t.type&&(t.window=e?.window),t.syncOnce=Boolean(e?.once)}return e}(S.abilityFilterEvents),S.abilityFilterEventsAfterFilterRawTimeline=S.abilityFilterEvents.map(e=>e.sourceIsFriendly?`${e.time} "<${e.actionName}>~"${F.value?` tts "${e.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(e.actionName)||"cast"===e.type&&void 0===e.window?`# ${e.time} "${e.actionName}"`:`${e.time} "${e.actionName}" sync /^.{14} \\w+ ${T[e.type]}:4.{7}:[^:]+:${e.actionId.toString(16).toUpperCase()}:/${e.window?` window ${e.window.join(",")}`:""}`).join("\n");const e=C.newTimeline(`导入${S.player?.name}`,{zoneId:S.zoneID.toString(),jobs:[S.player?.icon??"NONE"]},S.abilityFilterEventsAfterFilterRawTimeline,`${S.code}#fight=${S.fightIndex+1}`);A(),v("showFFlogsToggle"),v("editTimeline",C.allTimelines[e]),setTimeout(()=>{k.value=0},500),$.value=!1}function A(){S.code="",S.fightIndex=0,S.start=0,S.end=0,S.friendlies=[],S.abilityFilterEvents=[],S.abilityFilterCandidate=[],S.abilityFilterSelected=[],S.abilityFilterEventsAfterFilterRawTimeline="",S.player=void 0,S.zoneID=0,S.bossIDs=[]}function P(){window.open("https://cn.fflogs.com/profile","_blank")}return(e,t)=>{const l=a,n=i,v=o,T=r,N=c,O=d,M=u,te=p,le=f,ne=s,ae=w,ie=y,oe=h,se=g;return L(),J(Z,null,[D(l,{style:G(Q(k)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"","position-absolute":"","z-999":"",class:"guide",onClick:t[0]||(t[0]=e=>k.value--)},{default:q(()=>t[6]||(t[6]=[W(" 上一步 ")])),_:1,__:[6]},8,["style"]),D(v,{active:Q(k),class:"steps-guide","align-center":""},{default:q(()=>[D(n,{title:"输入链接"}),D(n,{title:"选择玩家"}),D(n,{title:"过滤技能"})]),_:1},8,["active"]),0===Q(k)?(L(),H(ne,{key:0,class:"input-section"},{default:q(()=>[D(le,{"label-width":"150px",class:"fflogs-form"},{default:q(()=>[D(N,{label:"FF Logs 战斗链接"},{default:q(()=>[D(T,{modelValue:Q(x),"onUpdate:modelValue":t[1]||(t[1]=e=>X(x)?x.value=e:null),placeholder:"https://www.fflogs.com/reports/AAAaAaAAaa1aA1aA?fight=1",autocomplete:"on"},null,8,["modelValue"])]),_:1}),D(N,{label:"FF logs V1 Key"},{default:q(()=>[D(T,{modelValue:Q(C).settings.api,"onUpdate:modelValue":t[2]||(t[2]=e=>Q(C).settings.api=e),placeholder:"在 FF Logs 个人设置页面获取 V1 API Key",type:"password","show-password":""},{append:q(()=>[D(O,{content:"点击前往 FF Logs 个人设置页面，在最下方填写 V1客户名称 并点击确认后，再获取你的 V1 客户端密钥",placement:"top",effect:"light"},{default:q(()=>[D(l,{type:"primary",link:"",onClick:P},{default:q(()=>t[7]||(t[7]=[W(" 如何获取 ")])),_:1,__:[7]})]),_:1})]),_:1},8,["modelValue"])]),_:1}),D(N,{label:"使用 TTS"},{default:q(()=>[D(M,{modelValue:Q(F),"onUpdate:modelValue":t[3]||(t[3]=e=>X(F)?F.value=e:null)},null,8,["modelValue"])]),_:1}),D(N,null,{default:q(()=>[D(l,{disabled:"正在查询..."===Q(V),type:"primary",onClick:t[4]||(t[4]=e=>async function(e){$.value=!0,A(),V.value="正在查询...";const t=e.match(_);if(!C.settings.api)return b.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方<strong>填写 V1 客户名称并点击确认</strong>后，获取你的 V1 客户端密钥</a>'}),V.value="查询",void($.value=!1);if(!t)return b.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),V.value="查询",void($.value=!1);S.code=t.groups?.code??"";try{const e=await fetch(`https://cn.fflogs.com/v1/report/fights/${S.code}?api_key=${C.settings.api}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()});S.bossIDs=e.enemies.filter(e=>"Boss"===e.type).map(e=>e.id),S.fightIndex=("last"===t?.groups?.fight?e.fights.length:Number.parseInt(t?.groups?.fight??"0"))-1;const l=e.fights[S.fightIndex];S.zoneID=l.zoneID,S.start=l.start_time,S.end=l.end_time,S.friendlies=e.friendlies.filter(e=>"LimitBreak"!==e.icon&&e.fights.find(e=>e.id===S.fightIndex+1)),V.value="查询",S.abilityFilterEvents.length=0,S.abilityFilterCandidate.length=0,$.value=!1,k.value=1}catch(l){b.alert(`\n  <h3 style="margin-bottom: 10px;">可能的原因：</h3>\n  <ul style="padding-left: 20px; margin-bottom: 10px;">\n    <li> <strong>90%概率</strong>：你没有<strong style="color: red;">先起名</strong>再获取 V1 客户端密钥</li>\n    <li> <strong>5%概率</strong>：该战斗记录是私人或匿名模式</li>\n    <li> <strong>5%概率</strong>：网络异常</li>\n  </ul>\n<p class="error-details"><strong>错误：</strong>${l}</p>\n`,"请求失败",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),V.value="查询",$.value=!1}}(Q(x)))},{default:q(()=>[Q($)?(L(),H(te,{key:0,class:"is-loading"},{default:q(()=>[D(Q(m))]),_:1})):R("",!0),W(" "+Y(Q(V)),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):R("",!0),K("div",ye,[1===Q(k)?(L(),H(ne,{key:0,class:"player-selection"},{default:q(()=>[D(ie,{data:Q(S).friendlies.filter(e=>!["NPC"].includes(e.icon)),stripe:"",border:"",class:"friendlies-table"},{default:q(()=>[D(ae,{prop:"name",label:"玩家名称"}),D(ae,{label:"职业"},{default:q(({row:e})=>[W(Y(Q(z).nameToFullName(Q(z).jobEnumToJob(Q(z).iconToJobEnum(e.icon))).cn),1)]),_:1}),D(ae,{label:"选定",width:"100",align:"center"},{default:q(e=>[D(l,{type:"primary",size:"small",onClick:t=>I(e.row)},{default:q(()=>t[8]||(t[8]=[W(" 选择 ")])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):R("",!0),2===Q(k)?(L(),H(ne,{key:1,class:"ability-filter"},{default:q(()=>[K("div",ge,[Q(j)?R("",!0):(L(),J("div",be,[D(te,{class:"is-loading"},{default:q(()=>[D(Q(m))]),_:1}),t[9]||(t[9]=K("span",null,"正在加载技能列表...",-1))])),Q(j)?(L(),H(se,{key:1,modelValue:Q(S).abilityFilterSelected,"onUpdate:modelValue":t[5]||(t[5]=e=>Q(S).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:q(()=>[(L(!0),J(Z,null,ee(Q(S).abilityFilterCandidate,e=>(L(),H(oe,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:q(()=>[K("img",{src:Q(U)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:Q(E)},null,8,he),K("span",null,Y(e.actionName),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue"])):R("",!0),Q(j)?(L(),H(l,{key:2,type:"success",class:"filter-confirm-btn",disabled:!Q(j),onClick:B},{default:q(()=>t[10]||(t[10]=[W(Y("生成时间轴"))])),_:1,__:[10]},8,["disabled"])):R("",!0)])]),_:1})):R("",!0)])],64)}}}),[["__scopeId","data-v-000105b1"]]),_e=se(P({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(l,{emit:n}){const a=l,i=n,o=e();te(()=>{o.saveTimelineSettings()});const s=le({get:()=>a.modelValue,set:e=>i("update:modelValue",e)}),r=O(-15),d=O([{time:-15,action:"<圣光幕帘>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:-2,action:"<圣灵>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:0,action:"战斗开始！",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:3,action:"<挑衅>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:5,action:"<神圣领域>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1}]);return(e,l)=>{const n=x,a=c,i=V,u=_,p=T,m=t,w=f,y=v;return L(),H(y,{modelValue:Q(s),"onUpdate:modelValue":l[1]||(l[1]=e=>X(s)?s.value=e:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:q(()=>l[2]||(l[2]=[K("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)])),default:q(()=>[D(w,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:q(()=>[l[3]||(l[3]=K("h3",{class:"form-section-title"}," 参数 ",-1)),D(u,{gutter:20},{default:q(()=>[(L(!0),J(Z,null,ee(Q(o).configValues,(e,t,l)=>(L(),H(i,{key:l,span:12},{default:q(()=>[D(a,{label:Q(o).configTranslate[t]},{default:q(()=>[D(n,{modelValue:Q(o).configValues[t],"onUpdate:modelValue":e=>Q(o).configValues[t]=e,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),l[4]||(l[4]=K("h3",{class:"form-section-title"}," 样式 ",-1)),D(u,{gutter:20},{default:q(()=>[(L(!0),J(Z,null,ee(Q(o).showStyle,(e,t,l)=>(L(),H(i,{key:l,span:12},{default:q(()=>[D(a,{label:Q(o).showStyleTranslate[t]},{default:q(()=>[D(n,{modelValue:Q(o).showStyle[t],"onUpdate:modelValue":e=>Q(o).showStyle[t]=e,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1}),l[5]||(l[5]=K("h3",{class:"form-section-title"}," 测试用例 ",-1)),D(u,{gutter:20},{default:q(()=>[D(p,{modelValue:Q(r),"onUpdate:modelValue":l[0]||(l[0]=e=>X(r)?r.value=e:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),D(m,{config:Q(o).configValues,lines:Q(d),runtime:Q(r),"show-style":Q(o).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1})]),_:1,__:[3,4,5]})]),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-6104eb5f"]]),Te={key:0,class:"alerts-container"},Ve={class:"batch-operations",style:{"margin-bottom":"15px",display:"flex","justify-content":"space-between"}},xe={class:"editor-dialog-content"},Fe={class:"slider-demo-block"},$e={class:"time-display",style:{width:"80px","text-align":"center"}},ke={class:"time-display-text"},je={class:"time-display-text"},Se={style:{"margin-top":"1em"}},Ce=se(P({__name:"timelineSettings",setup(i){const o=ne(),{wsConnected:d}=ce({allowClose:!0,addWsParam:!0}),u=e(),p=ae(u,"allTimelines"),m=ae(u,"filters"),f=O(0),x=fe("realtimeMode",!1),N=O([]),E=O(!1),U=O(!1),P=O(!1),M=O(!1),te=O({name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}),se=O([]),we=[{id:"0",name:"任意"}];let ye=null,ge=!1;const be=le(()=>{const e=f.value,t=e<0,l=Math.abs(Math.floor(e)),n=Math.floor(l/60),a=l%60;return`${t?"-":""}${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")}`}),he=le(()=>{l(te.value.timeline);return(Math.max(...se.value.map(e=>e.time))||550)+30});function Ce(e){te.value=e,U.value=!0,Ae()}function Ie(){U.value=!1}function Be(){te.value=u.allTimelines[u.newTimeline()],Ae()}function Ae(){se.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],l(te.value.timeline).then(e=>{se.value=e}),f.value=-u.configValues.preBattle}function Ne(){if(0===N.value.length)return void I.warning("请选择要删除的时间轴");const e=N.value.map(e=>`「${e.name}」`).join("<br/>");b.confirm(`确定要删除选中的 ${N.value.length} 个时间轴吗？<br>${e}`,"批量删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",dangerouslyUseHTMLString:!0,type:"warning"}).then(()=>{p.value=p.value.filter(e=>!N.value.includes(e)),N.value=[],E.value=!1,I.success(`成功删除 ${N.value.length} 个时间轴`)}).catch(()=>{})}function ze(){E.value=!E.value,N.value=E.value?[...p.value]:[]}function Ee(){x.value?x.value=!1:b.confirm("开启实时更新模式后，你不再需要手动点击'应用'按钮了，所有改动将立即生效。","提示",{confirmButtonText:"开启实时更新模式",cancelButtonText:"再想想",type:"warning"}).then(()=>{x.value=!0,Je("post",u.$state)}).catch(()=>{})}function Ue(){0!==N.value.length?Pe(N.value):I.warning("请选择要导出的时间轴")}function Pe(e){const t=JSON.stringify(e),l=JSON.parse(t);for(const n of l)n.timeline=n.timeline.replace(/^#.*\n/gm,"");const a=JSON.stringify(l),i=n.compressToBase64(t),o=n.compressToBase64(a),s=i.length,c=o.length;if(s===c)return void Qe(i,"数据复制成功，已写入剪切板。","复制失败，请手动复制！");const r=((s-c)/s*100).toFixed(2);b.confirm(`\n     1. 完整版本（包含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${s} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>\n     2. 优化版本（不含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${c} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 节省 ${r}% 的空间<br>\n     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:e=>{if("cancel"===e||"confirm"===e){Qe("confirm"===e?o:i,"数据复制成功，已写入剪切板。","复制失败，请手动复制！")}}})}function Oe(){b.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:e=>{if(!e)return"请输入导出的字符串";const t=e.split("\n").filter(e=>""!==e.trim());let l=[];for(const a of t){let e;try{e=JSON.parse(a)}catch{try{const t=n.decompressFromBase64(a);e=JSON.parse(t)}catch{return`无法解析输入的数据：${a}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(e))return`导入的数据格式不正确：${a}`;l=l.concat(e)}return 0!==l.length||"导入的数据不包含任何时间轴。"},inputErrorMessage:"无效的输入"}).then(({value:e})=>{const t=e.split("\n").filter(e=>""!==e.trim());let l=[];for(const o of t){let e;try{e=JSON.parse(o)}catch{const t=n.decompressFromBase64(o);e=JSON.parse(t)}l=l.concat(e)}const a=l.length,i=l.map(e=>`「${e.name}」`).join(", ");b({title:"确认",message:`导入 ${a} 个时间轴：\n${i}\n？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:e=>{"cancel"===e?b.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then(({value:e})=>{"我确认"===e&&Me(l,!0)}).catch(()=>{}):"confirm"===e&&Me(l,!1)}})}).catch(()=>{})}function Me(e,t){t&&(u.allTimelines.length=0),u.allTimelines.push(...e),u.sortTimelines();for(const i of u.allTimelines)void 0===i.condition.jobs&&(i.condition.jobs=[i.condition.job]);if(t)return void I({type:"success",message:"覆盖成功！",duration:2e3});const l=[],n=new Set;for(const i of u.allTimelines){const e=JSON.stringify({name:i.name,condition:i.condition,timeline:i.timeline,codeFight:i.codeFight,create:i.create});n.has(e)||(n.add(e),l.push(i))}const a=u.allTimelines.length-l.length;u.allTimelines=l,I({message:`追加成功！共导入 ${e.length} 个时间轴${a>0?`，但其中 ${a} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}function Je(e,t={}){me({call:"broadcast",source:"soumaTimelineSettings",msg:{type:e,data:t}})}function Le(){b.confirm("要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Je("post",u.$state)}).catch(()=>{})}function De(){b.confirm("要读取 ACT 悬浮窗数据吗？你将丢失所有未应用的修改！","读取悬浮窗数据",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{He()}).catch(()=>{})}function He(){const e=o.resolve({path:"/timeline"}),t=`${window.location.protocol}//${window.location.host}/ff14-overlay-vue/${e.href}`;ge=!0,ye=B.service({lock:!0,text:`正在请求数据，请确保 ACT 中已添加并启用此悬浮窗：${t}`,background:"rgba(0, 0, 0, 0.7)"}),Je("get"),setTimeout(()=>{ge&&(I.info("重新尝试获取数据..."),He())},5e3)}const Re=e=>{if("soumaTimeline"===e.source&&"post"===e.msg.type){ge=!1,ye.close();const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>u.jobList.indexOf(e)-u.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");u.allTimelines=t.allTimelines,u.configValues=t.configValues,u.showStyle=t.showStyle,I.closeAll(),I({message:"数据获取成功",type:"success",duration:3e3})}};function Ke(){window.open("https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8","_blank")}function qe(){const e=o.resolve({path:"/timelineHelp"}).href;window.open(e,"_blank")}function We(){P.value=!0}function Ge(e){u.configValues=e.configValues,u.showStyle=e.showStyle}function Qe(e,t="复制成功",l="复制失败"){re(e).then(()=>I.success(t)).catch(()=>I.error(l))}return ie(()=>{pe("BroadcastMessage",Re);const e=oe(d,t=>{t&&(0===u.allTimelines.length&&He(),e())});oe(()=>u.$state,()=>{d.value&&x.value&&Je("post",u.$state)},{deep:!0})}),function(){for(const e in ue)if(Object.prototype.hasOwnProperty.call(ue,e)){const t=ue[e];switch(t.contentType){case 4:case 5:case 28:we.push({id:e,name:t.name?.cn??t.name?.ja??e})}}u.loadTimelineSettings(),u.sortTimelines()}(),(e,l)=>{const n=_e,i=a,o=k,d=$,I=_,B=F,O=ve,le=v,ne=S,ae=w,ie=y,oe=s,ce=C,re=j,ue=r,pe=c,me=V,fe=h,ye=g,ge=T,Me=t,Je=A;return L(),H(Je,{class:"container"},{default:q(()=>[D(n,{modelValue:Q(M),"onUpdate:modelValue":l[0]||(l[0]=e=>X(M)?M.value=e:null),onSave:Ge},null,8,["modelValue"]),D(B,{class:"flex-header"},{default:q(()=>[D(I,{justify:"space-between",align:"middle","m-b-2":""},{default:q(()=>[D(d,{wrap:"",size:10},{default:q(()=>[D(o,null,{default:q(()=>[D(i,{type:"primary",size:"small",onClick:We},{default:q(()=>l[17]||(l[17]=[W(" 从 FFlogs 生成 ")])),_:1,__:[17]}),D(i,{type:"primary",size:"small",onClick:Ke},{default:q(()=>l[18]||(l[18]=[W(" 从 在线文档 获取 ")])),_:1,__:[18]}),D(i,{type:"primary",size:"small",onClick:Be},{default:q(()=>l[19]||(l[19]=[W(" 手动编写 ")])),_:1,__:[19]})]),_:1}),D(o,null,{default:q(()=>[D(i,{size:"small",onClick:Oe},{default:q(()=>l[20]||(l[20]=[W(" 导入字符串 ")])),_:1,__:[20]}),D(i,{size:"small",class:"export",onClick:l[1]||(l[1]=e=>Pe(Q(p)))},{default:q(()=>l[21]||(l[21]=[W(" 导出全部 ")])),_:1,__:[21]})]),_:1}),D(i,{size:"small",onClick:qe},{default:q(()=>l[22]||(l[22]=[W(" 时间轴语法 ")])),_:1,__:[22]}),D(o,null,{default:q(()=>[D(i,{size:"small",type:Q(x)?"success":"default",onClick:Ee},{default:q(()=>[W(Y(Q(x)?"实时更新模式：开启中":"实时更新模式：关闭中"),1)]),_:1},8,["type"])]),_:1})]),_:1}),D(d,null,{default:q(()=>[Q(x)?R("",!0):(L(),H(i,{key:0,color:"#a0d911",style:{color:"white"},size:"small",onClick:De},{default:q(()=>l[23]||(l[23]=[W(" 读取来自悬浮窗的数据 ")])),_:1,__:[23]})),D(i,{color:"#626aef",style:{color:"white"},size:"small",onClick:l[2]||(l[2]=e=>M.value=!0)},{default:q(()=>l[24]||(l[24]=[W(" 设置 ")])),_:1,__:[24]})]),_:1})]),_:1}),Q(x)?R("",!0):(L(),J("div",Te,[D(i,{type:"success",size:"default",onClick:Le},{default:q(()=>l[25]||(l[25]=[W(" 编辑完毕后，点击这里应用，将编辑器数据发送至悬浮窗 ")])),_:1,__:[25]})]))]),_:1}),D(re,null,{default:q(()=>[D(le,{modelValue:Q(P),"onUpdate:modelValue":l[4]||(l[4]=e=>X(P)?P.value=e:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>P.value=!1},{default:q(()=>[D(O,{filters:Q(m),onShowFFlogsToggle:l[3]||(l[3]=()=>P.value=!1),onEditTimeline:Ce},null,8,["filters"])]),_:1},8,["modelValue","before-close"]),Q(p).length>0?(L(),H(oe,{key:0},{default:q(()=>[K("div",Ve,[K("div",null,[D(i,{type:"primary",size:"small",disabled:0===Q(N).length,onClick:Ue},{default:q(()=>[W(" 批量导出 ("+Y(Q(N).length)+") ",1)]),_:1},8,["disabled"]),D(i,{type:"danger",size:"small",disabled:0===Q(N).length,style:{"margin-right":"10px"},onClick:Ne},{default:q(()=>[W(" 批量删除 ("+Y(Q(N).length)+") ",1)]),_:1},8,["disabled"])])]),D(ie,{data:Q(p),style:{width:"100%"},stripe:"",onSelectionChange:l[6]||(l[6]=e=>{N.value=e,E.value=e.length===Q(p).length})},{default:q(()=>[D(ae,{type:"selection",width:"55",align:"center",selectable:()=>!0},{header:q(()=>[D(ne,{modelValue:Q(E),"onUpdate:modelValue":l[5]||(l[5]=e=>X(E)?E.value=e:null),onChange:ze},null,8,["modelValue"])]),_:1}),D(ae,{prop:"name",label:"名称"}),D(ae,{prop:"condition",label:"地图",sortable:""},{default:q(e=>[W(Y(we.find(t=>t.id===e.row.condition.zoneId)?.name),1)]),_:1}),D(ae,{prop:"condition",label:"职业"},{default:q(e=>[W(Y(e.row.condition.jobs.map(e=>Q(z).nameToFullName(e.toUpperCase())?.cn??e).join("、").replace("冒险者","全部职业")),1)]),_:1}),D(ae,{fixed:"right",label:"操作",width:"150"},{default:q(e=>[D(i,{type:"primary",size:"small",onClick:t=>Ce(e.row)},{default:q(()=>l[26]||(l[26]=[W(" 编辑 ")])),_:2,__:[26]},1032,["onClick"]),D(i,{type:"danger",size:"small",onClick:t=>{return l=e.row,void b.confirm(`确定要删除「${l.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then(()=>{p.value.splice(p.value.findIndex(e=>e===l),1)}).catch(()=>{});var l}},{default:q(()=>l[27]||(l[27]=[W(" 删除 ")])),_:2,__:[27]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})):R("",!0),0===Q(p).length?(L(),H(oe,{key:1},{default:q(()=>[D(ce,{description:"点击上方新建或导入一个时间轴吧~"})]),_:1})):R("",!0)]),_:1}),D(le,{modelValue:Q(U),"onUpdate:modelValue":l[16]||(l[16]=e=>X(U)?U.value=e:null),title:"编辑时间轴",top:"5vh","before-close":Ie,class:"timeline-dialog",width:"65%",style:{"min-width":"550px","max-width":"1000px"},"close-on-click-modal":!1},{default:q(()=>[K("div",xe,[D(I,{class:"timeline-header",gutter:10},{default:q(()=>[D(me,{span:14},{default:q(()=>[D(pe,{label:"名称"},{default:q(()=>[D(ue,{modelValue:Q(te).name,"onUpdate:modelValue":l[7]||(l[7]=e=>Q(te).name=e)},null,8,["modelValue"])]),_:1})]),_:1}),D(me,{span:8},{default:q(()=>[D(pe,{label:"来源"},{default:q(()=>[D(ue,{modelValue:Q(te).codeFight,"onUpdate:modelValue":l[8]||(l[8]=e=>Q(te).codeFight=e),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),D(me,{span:22},{default:q(()=>[D(pe,{label:"地图"},{default:q(()=>[D(ye,{modelValue:Q(te).condition.zoneId,"onUpdate:modelValue":l[9]||(l[9]=e=>Q(te).condition.zoneId=e),filterable:"",style:{width:"100%"}},{default:q(()=>[(L(),J(Z,null,ee(we,e=>D(fe,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1}),D(me,{span:22},{default:q(()=>[D(pe,{label:"职业"},{default:q(()=>[D(ye,{modelValue:Q(te).condition.jobs,"onUpdate:modelValue":l[10]||(l[10]=e=>Q(te).condition.jobs=e),multiple:""},{default:q(()=>[(L(!0),J(Z,null,ee(Q(u).jobList,e=>(L(),H(fe,{key:e,label:(Q(z).nameToFullName(e)?.cn??e).replace("冒险者","全部职业"),value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),K("div",Fe,[D(ge,{modelValue:Q(f),"onUpdate:modelValue":l[11]||(l[11]=e=>X(f)?f.value=e:null),min:-Q(u).configValues.preBattle,max:Q(he),step:.1},null,8,["modelValue","min","max"]),K("div",$e,[K("p",ke,Y(Q(be)),1),K("p",je," ("+Y(Q(f))+"s) ",1)])]),D(I,{class:"timeline-editor-body",gutter:10},{default:q(()=>[D(me,null,{default:q(()=>[D(ue,{modelValue:Q(te).timeline,"onUpdate:modelValue":l[12]||(l[12]=e=>Q(te).timeline=e),style:G({width:`calc(100% - ${Q(u).showStyle["--timeline-width"]}px)`}),type:"textarea",autosize:{minRows:10,maxRows:20},wrap:"off",placeholder:"请键入时间轴文本",onChange:l[13]||(l[13]=e=>Ae())},null,8,["modelValue","style"])]),_:1}),D(Me,{style:{position:"absolute",right:0,top:0},config:Q(u).configValues,lines:Q(se),runtime:Q(f),"show-style":Q(u).showStyle},null,8,["config","lines","runtime","show-style"])]),_:1}),K("div",Se,[D(d,null,{default:q(()=>[D(i,{onClick:l[14]||(l[14]=e=>Pe([Q(te)]))},{default:q(()=>l[28]||(l[28]=[W(" 导出 ")])),_:1,__:[28]}),D(i,{type:"primary",onClick:l[15]||(l[15]=e=>{te.value.timeline=te.value.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),(e,t)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(e.toString())?de.duration(`00:${e.toString()}`).as("seconds").toString():de.utc(1e3*Number.parseFloat(e.toString())).format("mm:ss.S"))})},{default:q(()=>l[29]||(l[29]=[W(" 切换时间格式 ")])),_:1,__:[29]})]),_:1})])])]),_:1},8,["modelValue"])]),_:1})}}}),[["__scopeId","data-v-f857d97c"]]);export{Ce as default};
