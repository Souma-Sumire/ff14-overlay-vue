import"./index-9124d3bf.js";/* empty css                *//* empty css                 */import{t as e,r as a,ay as t,c as l,f as n,P as o,v as i,x as s,D as r,H as u,F as v,u as c,E as d,A as h,O as f,K as m,S as g}from"./vue-vendor-80a2ed00.js";import{z as p}from"./zoneInfo-40d5d60a.js";import{d as y}from"./content_type-e6dd7239.js";import{N as w}from"./netregexes-ed180b06.js";import{a as P,r as b,c as T}from"./overlay_plugin_api-974cdd44.js";import{r as k,b as x,T as M}from"./element-plus-22d49fc5.js";import{_}from"./_plugin-vue_export-helper-6a8c15be.js";import"./zone_info-e69ac441.js";import"./regexes-da03e94d.js";const j={class:"radar-container"},I={class:"radar-wrapper"},L=["disabled"],S=["disabled"],C={class:"target-header"},z={class:"target-name"},E={class:"radar-canvas-container"},N=["width","height"],W=_(e({__name:"radar",setup(e){const _=a(!1),W=a(""),H=a([]),O=a(0),R=a(""),A=a([]),U={echo:w.echo({line:"find\\s*(?<target>.+)"})},$=a(!1),q=t("canvas");let D=null;const F=a(window.devicePixelRatio||1),X=a(Math.min(window.innerWidth,window.innerHeight)-80),Y=l(()=>X.value/2-20),Z=a("flex"===document.getElementById("unlocked")?.style?.display),B="#0f0",G="#060",K="#0f0",J="#ff0",Q="#f00",V="#fff",ee=18,ae=3,te=2,le=6,ne="10px Arial",oe=l(()=>X.value/2),ie=l(()=>X.value/2);async function se(){const e=await T({call:"getCombatants"});A.value=e.combatants??[]}async function re(){await se(),!$.value&&W.value&&R.value&&_.value?(!function(){if(!D)return;const e=H.value[O.value],a=A.value.find(e=>e.Name===R.value);if(!e)return W.value="",void x("找不到目标");if(!a)return;D.clearRect(0,0,X.value,X.value),D.strokeStyle=B,D.lineWidth=1,D.beginPath(),D.arc(oe.value,ie.value,Y.value,0,2*Math.PI),D.stroke(),D.strokeStyle=G,D.beginPath(),D.moveTo(oe.value-Y.value,ie.value),D.lineTo(oe.value+Y.value,ie.value),D.moveTo(oe.value,ie.value-Y.value),D.lineTo(oe.value,ie.value+Y.value),D.stroke();const t=e.PosX-a.PosX,l=e.PosY-a.PosY,n=Math.sqrt(t*t+l*l);let o=oe.value+t/.1,i=ie.value+l/.1;const s=Math.hypot(o-oe.value,i-ie.value);if(s>Y.value){const e=Y.value/s;o=oe.value+(o-oe.value)*e,i=ie.value+(i-ie.value)*e}D.strokeStyle=Q,D.lineWidth=te,D.beginPath(),D.moveTo(oe.value,ie.value),D.lineTo(o,i),D.stroke(),D.fillStyle=J,D.beginPath(),D.arc(o,i,ae,0,2*Math.PI),D.fill();const r=-(a.Heading??0)+Math.PI;D.save(),D.translate(oe.value,ie.value),D.rotate(r),D.fillStyle=K;const u=ee,v=u/3,c=-.2*u;D.beginPath(),D.moveTo(0,-u/2+c),D.lineTo(-v,u/2+c),D.lineTo(v,u/2+c),D.closePath(),D.fill(),D.restore();const d=Math.atan2(i-ie.value,o-oe.value);D.fillStyle=Q,D.beginPath(),D.moveTo(o,i),D.lineTo(o-le*Math.cos(d-Math.PI/6),i-le*Math.sin(d-Math.PI/6)),D.lineTo(o-le*Math.cos(d+Math.PI/6),i-le*Math.sin(d+Math.PI/6)),D.closePath(),D.fill(),D.fillStyle=V,D.font=ne,D.fillText(`${n.toFixed(1)}y`,o+5,i-5)}(),setTimeout(re,100)):W.value=""}function ue(){return new Promise(e=>{T({call:"cactbotRequestState"}).then(()=>{_.value=!0,e()}),setTimeout(()=>{_.value||ue()},3e3)})}const ve=e=>{if("00"===e.line[0]){const a=U.echo.exec(e.rawLine);a?.groups?.target&&(W.value=a.groups.target,se().then(()=>{!function(){if(!W.value)return H.value=[],void(O.value=0);const e=A.value.filter(e=>e.Name&&e.Name.includes(W.value));H.value=e,O.value=0}(),re()}))}},ce=e=>{R.value=e.charName},de=e=>{$.value=p[e.zoneID]?.contentType===y.Pvp};function he(){X.value=Math.min(window.innerWidth,window.innerHeight)-80,F.value=window.devicePixelRatio||1,D&&(D.setTransform(1,0,0,1,0,0),D.scale(F.value,F.value))}function fe(e){Z.value=!1===e?.detail?.isLocked}return n(()=>{D=q.value?.getContext("2d")??null,D&&D.scale(F.value,F.value),ue(),P("LogLine",ve),P("ChangePrimaryPlayer",ce),P("ChangeZone",de),window.addEventListener("resize",he),document.addEventListener("onOverlayStateUpdate",fe)}),o(()=>{b("LogLine",ve),b("ChangePrimaryPlayer",ce),b("ChangeZone",de),window.removeEventListener("resize",he),document.removeEventListener("onOverlayStateUpdate",fe)}),(e,a)=>{const t=M,l=k;return s(),i("div",j,[c(Z)?(s(),r(t,{key:0,class:"el-alert-info",type:"info",closable:!1,"show-icon":"",title:"宏命令：/e find 目标名称",description:"名称允许部分匹配"})):u("",!0),c(_)?u("",!0):(s(),r(l,{key:1,class:"activation-prompt"},{default:d(()=>a[3]||(a[3]=[h("h1",null,"在 ACT 中添加本页面作为数据统计悬浮窗",-1)])),_:1,__:[3]})),v(h("div",I,[c(H).length>1?(s(),i("button",{key:0,class:"nav-arrow left-arrow",disabled:c(H).length<=1,"aria-label":"上一目标",onClick:a[0]||(a[0]=e=>O.value=(c(O)-1+c(H).length)%c(H).length)}," ← ",8,L)):u("",!0),c(H).length>1?(s(),i("button",{key:1,class:"nav-arrow right-arrow",disabled:c(H).length<=1,"aria-label":"下一目标",onClick:a[1]||(a[1]=e=>O.value=(c(O)+1)%c(H).length)}," → ",8,S)):u("",!0),h("div",C,[h("span",z,m(c(H)[c(O)]?.Name??""),1),h("button",{class:"cancel-btn",onClick:a[2]||(a[2]=e=>{W.value="",H.value=[]})}," 取消 ")]),h("div",E,[h("canvas",{ref_key:"canvas",ref:q,class:"radar-canvas",width:c(X)*c(F),height:c(X)*c(F),style:g({width:`${c(X)}px`,height:`${c(X)}px`})},null,12,N)])],512),[[f,c(_)&&c(W)]])])}}}),[["__scopeId","data-v-d391a6f9"]]);export{W as default};
