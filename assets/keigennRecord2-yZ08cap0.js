import{_ as e,e as t}from"./shared-common-1fsdULpF.js";import{d as s,c as a,aI as i,aJ as n,x as o,K as r,a as l,e as c,aK as d,aL as u,aM as m,n as p}from"./vendor-element-plus-Crd81rYT.js";import{o as f,t as h,H as v,I as g,J as b,R as y,am as k,v as w,u as I,L as j,A as R,B as C,aa as N,dA as T,K as L,dy as S,Z as x,X as E,a as D,Y as A,M as _,r as $,c as M,O as P,aH as O,bH as H,V as G,_ as F,a9 as J,av as z,bz as V,a3 as K,aI as W,bD as B,D as U}from"./vendor-vue-iK2zA9mI.js";import{u as Z,ai as Y,s as q,z as X,U as Q,ag as ee,q as te,h as se,a6 as ae,Z as ie,j as ne,ah as oe,aj as re,ak as le,v as ce,al as de,am as ue,an as me,ao as pe,D as fe,ap as he,ab as ve,aq as ge,ar as be,t as ye,as as ke}from"./shared-core-DqyA8e41.js";import{l as we,N as Ie,a as je}from"./cactbot-Bq2Gp82n.js";const Re={class:"header-filter"},Ce=f({__name:"FilterHeader",props:{modelValue:{},options:{},placeholder:{},width:{}},emits:["update"],setup(e,{emit:t}){const i=t;function n(e){i("update",e)}return(t,i)=>(h(),v("div",Re,[g(I(a),{"model-value":e.modelValue,placeholder:e.placeholder,size:"small",clearable:!1,style:j(`width:${e.width}`),teleported:!0,"popper-class":"keigenn-header-select-popper",onChange:n},{default:b(()=>[(h(!0),v(y,null,k(e.options,e=>(h(),w(I(s),{key:e.value,label:e.fullLabel||e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["model-value","placeholder","style"])]))}}),Ne={class:"table-wrapper"},Te={key:0,class:"row-info"},Le={class:"info-line"},Se={class:"info-line"},xe={class:"info-line"},Ee={class:"info-line"},De={class:"info-line"},Ae={key:1,class:"skill-popover-content"},_e={key:0,class:"skill-grid"},$e=["title"],Me=["src"],Pe={key:0,class:"skill-overlay"},Oe={key:1,class:"skill-text"},He={key:2,class:"skill-charges"},Ge={key:4,class:"skill-extra-text"},Fe={key:5,class:"skill-job-name"},Je={key:1,class:"no-data"},ze={key:2,class:"death-recap-popover"},Ve={class:"recap-header"},Ke={class:"align-right"},We={class:"time"},Be={class:"ability-cell"},Ue={class:"ability-content"},Ze=["src"],Ye=["title"],qe={class:"status-cell"},Xe={class:"status-content"},Qe=["title","data-duration"],et=["src"],tt=e(f({__name:"Table",props:{rows:{},actionKey:{}},setup(e,{expose:t}){const s=e,{t:a}=Z(),u=Y(),m=u.userOptions,p=S("contextMenu"),f=$(""),w=$("");R(()=>s.rows,e=>{0===e.length&&(f.value="",w.value="")},{immediate:!0});const H=$(!1),G=$(0),F=$(0),J=$(null),z=$(null),V=$({getBoundingClientRect:()=>({top:0,left:0,bottom:0,right:0,width:0,height:0})}),K=$(null),W=$(!1),B=$("top"),U=a("keigennRecord.cancelFilter"),ee=M(()=>{const e=s.rows.filter(e=>u.debugShowHeals||"heal"!==e.effect);return f.value&&f.value!==U||w.value&&w.value!==U?e.filter(e=>{const t=!f.value||f.value===U||e[s.actionKey]===f.value,a=!w.value||w.value===U||e.targetId===w.value;return t&&a}):e}),te=P([]);function se(e,t,a){W.value&&z.value?.key===e.key&&K.value===t||(K.value=t,"skills"===t?B.value="left":"death-recap"===t?(B.value="auto",function(e){const t=e.targetId,a=e.timestamp,i=a-2e4,n=[],o=s.rows.indexOf(e);if(-1===o)return;for(let l=o;l>=0;l--){const e=s.rows[l];if(e)if(e.timestamp<=a&&e.timestamp>=i)e.targetId===t&&n.push(e);else if(e.timestamp<i&&"push"===u.userOptions.order)break}for(let l=o+1;l<s.rows.length;l++){const e=s.rows[l];if(e)if(e.timestamp<=a&&e.timestamp>=i)e.targetId===t&&n.push(e);else if(e.timestamp<i&&"unshift"===u.userOptions.order)break}const r=Array.from(new Set(n)).sort((e,t)=>t.timestamp-e.timestamp);te.value=r.map(e=>{const t="heal"===e.effect,s="death"===e.type,i=!t&&e.amount>0&&!s;let n="",o="";t?(n="+",o="is-heal"):i&&(n="-",o="is-damage");const r=e.amount>0||t?n+e.preCalculated.amountDisplay:e.preCalculated.amountDisplay;return{key:e.key,timeStr:`${((e.timestamp-a)/1e3).toFixed(1).replace("-0.0","0.0")}s`,amountStr:r,amountClass:o,actionCN:e.actionCN,isDeath:s,iconSrc:"",keigenns:e.preCalculated.keigenns}})}(e)):B.value="right",z.value=e,V.value=a.currentTarget,W.value=!0)}const ae={x:0,y:0};function ie(e){ae.x=e.clientX,ae.y=e.clientY}let ne=0;function oe(e){H.value&&(H.value=!1);const t=e.target;t?.closest(".keigenn-global-popover")||(cancelAnimationFrame(ne),ne=requestAnimationFrame(()=>{!function(e,t){const s=document.elementFromPoint(e,t),a=s?.closest("[data-row-key][data-hover-mode]");if(a){const e=a.dataset.rowKey,t=a.dataset.hoverMode,s=ee.value.find(t=>t.key===e);if(s)return void se(s,t,{currentTarget:a})}W.value=!1}(ae.x,ae.y)}))}const re=S("tableContainer");C(()=>{re.value?.addEventListener("wheel",oe,{passive:!0}),window.addEventListener("mousemove",ie,{passive:!0})}),N(()=>{re.value?.removeEventListener("wheel",oe),window.removeEventListener("mousemove",ie)}),T(p,()=>{H.value=!1});const le=M(()=>{const e=s.rows.filter(e=>u.debugShowHeals||"heal"!==e.effect),t=Array.from(new Set(e.map(e=>e[s.actionKey]))).filter(e=>null!=e);return[{label:U,value:""},...t.map(e=>({label:e,value:e}))]}),ce=M(()=>{const e=s.rows.filter(e=>u.debugShowHeals||"heal"!==e.effect),t=Array.from(new Map(e.filter(e=>e.targetId).map(e=>[e.targetId,e])).values());return[{label:U,value:"",job:-1},...t.map(e=>({label:e.job,fullLabel:`${e.job}(${e.target})`,value:e.targetId,job:e.jobEnum}))].sort((e,t)=>Q.enumSortMethod(e.job,t.job))});function de(){if(J.value){const e=J.value[s.actionKey];f.value===e?f.value="":f.value=e,H.value=!1}}function ue(){if(J.value){const e=J.value.targetId;w.value===e?w.value="":w.value=e,H.value=!1}}const me=(e,t="")=>O("div",{class:["header-static",t]},e),pe=()=>O("div");function fe({rowData:e}){return"death"===e.type?"row-death":""}const he=M(()=>[{key:"time",title:a("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>me(a("keigennRecord.time"),"header-time")},{key:"action",title:a("keigennRecord.action"),dataKey:s.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>O(Ce,{modelValue:f.value,options:le.value,placeholder:a("keigennRecord.action"),width:"4.5em",onUpdate:e=>f.value=e===U?"":e}),cellRenderer:({rowData:e})=>{if("death"===e.type){const t="åœ°å½¢æ€"===e.source;return O("div",{class:"death-message-left"},[O("span","ðŸ’€ "),O("span",{class:"death-target-name"},e.target),O("span",t?[O("span"," å›  "),O("span",{class:"death-terrain"},"åœ°å½¢æ€"),O("span"," å€’ä¸‹äº†ï¼")]:[O("span"," è¢« "),O("span",{class:"death-source-name"},e.source),O("span"," åšæŽ‰äº†ï¼")]),O("span",{class:"death-recap-inline","data-row-key":e.key,"data-hover-mode":"death-recap",onMouseenter:t=>{se(e,"death-recap",t)}}," [æ­»äº¡å›žæ”¾]")])}return O("span",e[s.actionKey]??"")}},{key:"target",title:a("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>O(Ce,{modelValue:w.value,options:ce.value,placeholder:a("keigennRecord.target"),width:"4.7em",onUpdate:e=>w.value=e===U?"":e}),cellRenderer:({rowData:e})=>"death"===e.type?pe():O("div",{class:"target"},[e.preCalculated.jobIconSrc?O("img",{class:[u.isBrowser?"browser":"act","jobIcon",`cj${u.userOptions.iconType}`],src:e.preCalculated.jobIconSrc,alt:e.jobIcon,onError:e=>{e.target.style.display="none"}}):O("span",{class:"alt-text"},e.job),e.hasDuplicate?O("span",{class:"has-duplicate"},u.formatterName(e.target)):void 0])},{key:"amount",title:a("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",headerCellRenderer:()=>me(a("keigennRecord.amount")),cellRenderer:({rowData:e})=>"death"===e.type?pe():O("span",{class:"amount","data-row-key":e.key,"data-hover-mode":"amount",onMouseenter:t=>se(e,"amount",t)},[O("span",{class:e.preCalculated.damageTypeClass},e.preCalculated.amountDisplay)])},{key:"reduction",title:a("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>me(a("keigennRecord.reduction"),"header-reduction"),cellRenderer:({rowData:e})=>"death"===e.type?pe():O("span",{class:"col-reduction-number",style:{color:e.preCalculated.reductionColor}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:a("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",headerCellRenderer:()=>me(a("keigennRecord.keigenns")),cellRenderer:({rowData:e})=>"death"===e.type?pe():O("div",{class:"status-container"},[...e.preCalculated.keigenns.map(e=>O("span",{class:"status-wrapper"},[O("span",{class:"status",title:e.title,"data-duration":e.duration,"data-sourcePov":e.isPov},[O("img",{class:["statusIcon",e.usefulClass],src:e.src,alt:e.effect,onError:q})])])),O("span",{class:"flags"},"damage done"===e.effect||"heal"===e.type?"":a(`keigennRecord.${e.effect}`))])},{key:"skills",title:"",dataKey:"skills",width:24,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>O("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:10}},"death"===e.type?void 0:O("div",{class:"view-icon","data-row-key":e.key,"data-hover-mode":"skills",onMouseenter:t=>se(e,"skills",t)},[O(c,{size:12,color:"inherit",style:{opacity:.5}},{default:()=>O(d)})]))}]);let ve=null;const ge={onClick:({rowData:e})=>{if("death"===e.type)return;const{actionCN:t,amount:s,job:i,keigenns:n,time:o,type:r,effect:c,currentHp:d,maxHp:u,shield:p,reduction:f}=e,h="damage done"===c?"":`,${a(`keigennRecord.${c}`)}`,v=`${o} ${i} ${t} ${s.toLocaleString()}(${a(`keigennRecord.${r}`)}) ${a("keigennRecord.reduction")}(${(100*f).toFixed(0)}%):${0===n.length&&""===h?a("keigennRecord.none"):n.map(e=>m.statusCN?e.name:e.effect).join(",")+h} ${a("keigennRecord.hp")}:${d}(${Math.round(d/u*100)}%)+${a("keigennRecord.shield")}:${Math.round(u*+p/100)}(${p}%)`;X(v).then(()=>{ve?.close(),ve=l.success({message:a("keigennRecord.copySuccess"),duration:800})}).catch(()=>l.error(a("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{if("death"===e.type)return;const s=t;J.value=e,G.value=s.clientX,F.value=s.clientY,H.value=!0}},be=$(null);function ye(e,t){let s=0;for(const a of e)if(a.id===t&&(s++,s>1))return!0;return!1}function ke(e){return e.preCalculated.sortedSkills||[]}return t({scrollToBottom:function(){be.value&&be.value.scrollToRow(ee.value.length-1)}}),(t,s)=>{const l=o,c=n,d=r,m=i;return h(),v("div",{ref_key:"tableContainer",ref:re,class:"table-container"},[L("div",Ne,[g(m,{style:{height:"100%",width:"100%"}},{default:b(({height:i,width:n})=>[g(c,{ref_key:"tableV2Ref",ref:be,"header-class":"keigenn-table-header",class:"keigenn-table performance-table",columns:he.value,data:ee.value,width:n,height:i,"row-height":28,"header-height":24,"row-key":"key","row-event-handlers":ge,"row-class":fe,"overscan-row-count":2},{empty:b(()=>[g(l,{description:I(u).isBrowser?t.$t("keigennRecord.actTip"):void 0},null,8,["description"])]),_:1},8,["columns","data","width","height"]),I(H)?(h(),v("div",{key:0,ref_key:"contextMenu",ref:p,class:"context-menu",style:j({top:`${I(F)}px`,left:`${I(G)}px`})},[L("ul",null,[L("li",{onClick:de},x(I(f)===(I(J)?.[e.actionKey]??"")?I(a)("keigennRecord.filter.action_cancel",{actionName:I(J)?.[e.actionKey]??I(a)("keigennRecord.this_skill")}):I(a)("keigennRecord.filter.action_only",{actionName:I(J)?.[e.actionKey]??I(a)("keigennRecord.this_skill")})),1),L("li",{onClick:ue},x(I(w)===I(J)?.targetId?I(a)("keigennRecord.filter.target_cancel",{jobName:I(J)?.job??I(a)("keigennRecord.this_job")}):I(a)("keigennRecord.filter.target_only",{jobName:I(J)?.job??I(a)("keigennRecord.this_job")})),1)])],4)):E("",!0),g(d,{visible:I(W),"onUpdate:visible":s[3]||(s[3]=e=>D(W)?W.value=e:null),"virtual-ref":I(V),"virtual-triggering":"","popper-class":"keigenn-global-popover",transition:"none","show-after":0,"hide-after":0,offset:2,enterable:!0,teleported:!0,placement:I(B),width:"auto","fallback-placements":["top-end","top-start","bottom","bottom-end","bottom-start","left"]},{default:b(()=>[I(z)&&"amount"===I(K)?(h(),v("div",Te,[L("div",Le,x(I(a)("keigennRecord.source"))+": "+x(I(z).source),1),L("div",Se,x(I(a)("keigennRecord.playerShield"))+": "+x(I(z).shield)+"% ",1),L("div",xe,x(I(a)("keigennRecord.playerHp"))+": "+x(I(z).currentHp.toLocaleString())+"("+x(I(z).preCalculated.hpPercent)+"%) ",1),I(z).reduction<1&&"dot"!==I(z).type?(h(),v(y,{key:0},[s[4]||(s[4]=L("div",{class:"info-divider"},null,-1)),L("div",Ee,x(I(a)("keigennRecord.reductionRate"))+": "+x((100*I(z).reduction).toFixed(2))+"% ",1),L("div",De,[A(x(I(a)("keigennRecord.originalDamage"))+": ",1),L("span",{class:_(I(z).preCalculated.damageTypeClass)},x(I(z).preCalculated.originalDamageDisplay),3)])],64)):E("",!0)])):I(z)&&"skills"===I(K)?(h(),v("div",Ae,[ke(I(z)).length>0?(h(),v("div",_e,[(h(!0),v(y,null,k(ke(I(z)),e=>{return h(),v("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[L("div",{class:"skill-icon-container",title:`${e.ownerName} (${e.ownerJobName})`},[L("img",{src:e.icon,class:"skill-icon",onError:s[0]||(s[0]=(...e)=>I(q)&&I(q)(...e))},null,40,Me),e.ready?E("",!0):(h(),v("div",Pe)),e.recastLeft>0?(h(),v("span",Oe,x(e.recastLeft),1)):E("",!0),e.maxCharges&&e.maxCharges>1?(h(),v("span",He,x(e.chargesReady),1)):E("",!0),void 0!==e.jobResource?(h(),v("span",{key:3,class:"skill-resource",style:j({fontSize:e.jobResource.toString().length>2?"9px":"11px"})},x(e.jobResource),5)):E("",!0),e.extraText?(h(),v("span",Ge,x(e.extraText),1)):E("",!0),ye(ke(I(z)),e.id)?(h(),v("span",Fe,x((t=e.ownerJob,Q.jobToFullName(Q.jobEnumToJob(t))?.simple1??"")),1)):E("",!0)],8,$e)]);var t}),128))])):E("",!0),0===ke(I(z)).length?(h(),v("div",Je,x(I(a)("keigennRecord.noData")),1)):E("",!0)])):I(z)&&"death-recap"===I(K)?(h(),v("div",ze,[L("div",Ve,[L("span",null,x(I(a)("keigennRecord.time")),1),L("span",Ke,x(I(a)("keigennRecord.amount")),1),L("span",null,x(I(a)("keigennRecord.action")),1),L("span",null,x(I(a)("keigennRecord.keigenns")),1)]),(h(!0),v(y,null,k(I(te),e=>(h(),v("div",{key:e.key,class:_(["recap-row",{"is-death":e.isDeath}])},[L("span",We,x(e.timeStr),1),L("span",{class:_(["amount-cell align-right",e.amountClass])},x(e.amountStr),3),L("div",Be,[L("div",Ue,[e.iconSrc?(h(),v("img",{key:0,src:e.iconSrc,class:"ability-icon",onError:s[1]||(s[1]=(...e)=>I(q)&&I(q)(...e))},null,40,Ze)):E("",!0),L("span",{class:"ability-name",title:e.actionCN},x(e.actionCN),9,Ye)])]),L("div",qe,[L("div",Xe,[(h(!0),v(y,null,k(e.keigenns,(e,t)=>(h(),v("div",{key:t,class:"status-wrapper"},[L("div",{class:_(["status",{"is-pov":e.isPov}]),title:e.title,"data-duration":e.duration},[L("img",{src:e.src,class:_(["status-icon",e.usefulClass]),onError:s[2]||(s[2]=(...e)=>I(q)&&I(q)(...e))},null,42,et)],10,Qe)]))),128))])])],2))),128))])):E("",!0)]),_:1},8,["visible","virtual-ref","placement"])]),_:1})])],512)}}}),[["__scopeId","data-v-9f13c5e5"]]);class st{playerIds=new Set;updateTrackedPlayers(e){this.playerIds=new Set(e),this.cleanupRedundantPlayers()}}class at extends st{mp={};cleanupRedundantPlayers(){for(const e in this.mp)this.playerIds.has(e)||delete this.mp[e]}reset(){this.mp={}}getResource(e){return this.mp[e]??1e4}processLine(e,t,s={}){switch(e){case"21":case"22":{const e=t[we.Ability.fields.sourceId];if(!this.playerIds.has(e))return;const s=Number.parseInt(t[we.Ability.fields.currentMp]);Number.isNaN(s)||(this.mp[e]=s)}break;case"24":{const e=t[we.NetworkDoT.fields.sourceId];if(this.playerIds.has(e)){const s=Number.parseInt(t[we.NetworkDoT.fields.sourceCurrentMp]);Number.isNaN(s)||(this.mp[e]=s)}const s=t[we.NetworkDoT.fields.id];if(this.playerIds.has(s)){const e=Number.parseInt(t[we.NetworkDoT.fields.currentMp]);Number.isNaN(e)||(this.mp[s]=e)}}break;case"25":{const e=t[we.WasDefeated.fields.targetId];this.mp[e]=0}}}}const it=7,nt=3542,ot=25746,rt=7382,lt=27;class ct extends st{gauge={};cleanupRedundantPlayers(){for(const e in this.gauge)this.playerIds.has(e)||delete this.gauge[e]}reset(){this.gauge={}}getResource(e){return this.gauge[e]??100}processLine(e,t){switch(e){case"21":case"22":{const e=t[we.Ability.fields.sourceId];if(!this.playerIds.has(e))return;const s=Number.parseInt(t[we.Ability.fields.id],16);s===it?this.addGauge(e,5):s!==nt&&s!==ot&&s!==rt&&s!==lt||this.consumeGauge(e,50)}break;case"25":{const e=t[we.WasDefeated.fields.targetId];this.playerIds.has(e)&&(this.gauge[e]=0)}}}consumeGauge(e,t){const s=this.getResource(e);this.gauge[e]=Math.max(0,s-t)}addGauge(e,t){const s=this.getResource(e);this.gauge[e]=Math.min(100,s+t)}}const dt=34685,ut=3686,mt=3687;class pt extends st{activeShields={};pendingTransitions={};cleanupRedundantPlayers(){for(const e in this.activeShields)this.playerIds.has(e)||delete this.activeShields[e];for(const e in this.pendingTransitions)this.playerIds.has(e)||delete this.pendingTransitions[e]}reset(){this.activeShields={},this.pendingTransitions={}}getResource(e){}checkPending(e,t){for(const[s,a]of Object.entries(this.pendingTransitions))e-a>=300&&(this.reduceCooldown(s,6e4,t),delete this.pendingTransitions[s])}processLine(e,t,s={}){const a=t[we.GainsEffect?.fields?.timestamp??1],i=a?new Date(a).getTime():0;if(!(i<=0))switch(this.checkPending(i,s),e){case"26":{const e=t[we.GainsEffect.fields.targetId];if(!this.playerIds.has(e))return;const s=Number.parseInt(t[we.GainsEffect.fields.effectId],16),a=t[we.GainsEffect.fields.duration],n=a?Number.parseFloat(a):0;s===ut?this.activeShields[e]={type:"coat",expiresAt:i+1e3*n}:s===mt&&(this.activeShields[e]={type:"grassa",expiresAt:i+1e3*n},delete this.pendingTransitions[e])}break;case"30":{const e=t[we.LosesEffect.fields.targetId];if(!this.playerIds.has(e))return;const a=Number.parseInt(t[we.LosesEffect.fields.effectId],16);if(a===ut){const t=this.activeShields[e];"coat"===t?.type&&(t.expiresAt-i>500&&(this.pendingTransitions[e]=i),delete this.activeShields[e])}else if(a===mt){const t=this.activeShields[e];"grassa"===t?.type&&(t.expiresAt-i>500&&this.reduceCooldown(e,3e4,s),delete this.activeShields[e])}}}}reduceCooldown(e,t,s){const a=s[e];if(a){const e=a[dt];if(e&&e.length>0){const s=e.length-1;e[s]=(e[s]??0)-t}}}}const ft=24296,ht=24298,vt=24299,gt=24303,bt=24309;class yt extends st{stacks={};lastGenTime={};cleanupRedundantPlayers(){for(const e in this.stacks)this.playerIds.has(e)||(delete this.stacks[e],delete this.lastGenTime[e])}reset(){this.stacks={},this.lastGenTime={}}getResource(e){return this.stacks[e]??3}processLine(e,t){if("21"!==e&&"22"!==e&&"25"!==e)return;const s=t[1];if(!s)return;const a=new Date(s).getTime();switch(e){case"21":case"22":{const e=t[we.Ability.fields.sourceId];if(!this.playerIds.has(e))return;this.updateStacks(e,a);const s=Number.parseInt(t[we.Ability.fields.id],16);s===ft||s===ht||s===vt||s===gt?this.consumeStack(e):s===bt&&this.addStack(e)}break;case"25":{const e=t[we.WasDefeated.fields.targetId];this.playerIds.has(e)&&(this.stacks[e]=0,delete this.lastGenTime[e])}}}updateStacks(e,t){if(!this.lastGenTime[e])return this.lastGenTime[e]=t,void(void 0===this.stacks[e]&&(this.stacks[e]=3));const s=t-this.lastGenTime[e],a=Math.floor(s/2e4);if(a>0){const t=this.stacks[e]??0;this.stacks[e]=Math.min(3,t+a),this.lastGenTime[e]+=2e4*a}}consumeStack(e){const t=this.stacks[e]||0;t>0&&(this.stacks[e]=t-1)}addStack(e){const t=this.stacks[e]||0;this.stacks[e]=Math.min(3,t+1)}}const kt=166,wt=3587,It=167,jt=3583,Rt=188,Ct=7434,Nt=16542,Tt=1896;class Lt extends st{stacks={};recitation={};lastRecitationUsed={};cleanupRedundantPlayers(){for(const e in this.stacks)this.playerIds.has(e)||(delete this.stacks[e],delete this.recitation[e],delete this.lastRecitationUsed[e])}reset(){this.stacks={},this.recitation={},this.lastRecitationUsed={}}getResource(e){return this.stacks[e]??0}isReady(e,t,s){return!(!this.recitation[e]||t!==jt&&t!==Ct)||(this.stacks[e]??0)>=s}getExtraText(e,t,s,a){if(t===jt||t===Ct){const t=this.lastRecitationUsed[e]??0;if(t>0){const e=t+9e4;if(s<e)return Math.ceil((e-s)/1e3).toString()}}return""}processLine(e,t){switch(e){case"21":case"22":{const e=t[we.Ability.fields.sourceId];if(!this.playerIds.has(e))return;const s=Number.parseInt(t[we.Ability.fields.id],16),a=new Date(t[we.Ability.fields.timestamp]).getTime();if(s===Nt&&(this.lastRecitationUsed[e]=a),s===kt||s===wt)return void(this.stacks[e]=3);const i=this.recitation[e];s===jt||s===Ct?i||this.consumeStack(e):s!==It&&s!==Rt||this.consumeStack(e)}break;case"26":{const e=t[we.GainsEffect.fields.targetId];if(!this.playerIds.has(e))return;Number.parseInt(t[we.GainsEffect.fields.effectId],16)===Tt&&(this.recitation[e]=!0)}break;case"30":{const e=t[we.LosesEffect.fields.targetId];if(!this.playerIds.has(e))return;Number.parseInt(t[we.LosesEffect.fields.effectId],16)===Tt&&delete this.recitation[e]}break;case"25":{const e=t[we.WasDefeated.fields.targetId];this.playerIds.has(e)&&(this.stacks[e]=0)}}}consumeStack(e){const t=this.stacks[e]||0;t>0&&(this.stacks[e]=t-1)}}class St{allTrackers=new Map;activeTrackers=new Map;constructor(){this.allTrackers.set(28,Lt),this.allTrackers.set(19,ct),this.allTrackers.set(40,yt),this.allTrackers.set(32,at),this.allTrackers.set(42,pt)}updateParty(e){for(const[t,s]of e.entries()){const e=this.allTrackers.get(t);if(e){this.activeTrackers.has(t)||this.activeTrackers.set(t,new e);this.activeTrackers.get(t).updateTrackedPlayers(s)}}}clear(){this.activeTrackers.clear()}reset(){for(const e of this.activeTrackers.values())e.reset()}processLine(e,t,s){for(const a of this.activeTrackers.values())a.processLine(e,t,s)}getResource(e,t){const s=this.activeTrackers.get(e);if(s)return s.getResource(t)}isResourceReady(e,t,s,a){const i=this.activeTrackers.get(e);if(i&&i.isReady)return i.isReady(t,s,a);return(this.getResource(e,t)??0)>=a}getExtraText(e,t,s,a,i){const n=this.activeTrackers.get(e);return n&&n.getExtraText?n.getExtraText(t,s,a,i):""}}const xt="self",Et="other",Dt="party",At=[...ee.filter(e=>1===e.line||2===e.line).map(({tts:e,duration:t,key:s,line:a,...i})=>({...i,duration:t,scope:Dt})),{id:7531,recast1000ms:90,job:[1,3,19,21,32,37],minLevel:1,scope:xt,duration:20},{id:7561,recast1000ms:"(lv) => lv>=94 ? 40 : 60",job:[6,24,27,28,33,40],minLevel:18,scope:Dt},{id:7542,recast1000ms:90,job:[2,4,20,22,29,30,34,39,41],minLevel:1,scope:xt,duration:20},{id:7541,recast1000ms:120,job:[2,4,5,20,22,23,29,30,31,34,38,39,41],minLevel:1,scope:xt},{id:7548,recast1000ms:120,job:[1,2,3,4,5,19,20,21,22,23,29,30,31,32,34,37,38,39,41],minLevel:1,scope:xt,duration:6},{id:7559,recast1000ms:"120",job:[6,7,8,24,25,26,27,28,33,35,36,40,42],minLevel:1,scope:xt,duration:6},{id:17,recast1000ms:120,job:[1],minLevel:38,scope:xt,duration:15},{id:"(lv) => lv>=92 ? 36920 : 17",recast1000ms:120,job:[19],minLevel:38,scope:xt,duration:15},{id:22,recast1000ms:90,job:[19],minLevel:52,scope:xt,duration:10},{id:"(lv) => lv>=82 ? 25746 : 3542",recast1000ms:5,job:[19],minLevel:35,scope:xt,showResource:!0,resourceCost:50,duration:8},{id:7382,recast1000ms:10,job:[19],minLevel:62,scope:Et,showResource:!0,resourceCost:50,duration:8},{id:44,recast1000ms:120,job:[3],minLevel:38,scope:xt,duration:15},{id:"(lv) => lv>=92 ? 36923 : 44",recast1000ms:120,job:[21],minLevel:38,scope:xt,duration:15},{id:40,recast1000ms:90,job:[3,21],minLevel:30,scope:xt,duration:10},{id:3552,recast1000ms:60,job:[21],minLevel:58,scope:xt},{id:"(lv) => lv>=82 ? 25751 : 3551",recast1000ms:25,job:[21],minLevel:56,scope:xt,duration:8},{id:16464,recast1000ms:25,job:[21],minLevel:76,scope:Et,duration:8},{id:"(lv) => lv>=92 ? 36927 : 3636",recast1000ms:120,job:[32],minLevel:38,scope:xt,duration:15},{id:3634,recast1000ms:60,job:[32],minLevel:45,scope:xt,duration:10},{id:7393,recast1000ms:15,job:[32],minLevel:70,scope:Dt,showResource:!0,resourceCost:3e3,duration:7},{id:25754,recast1000ms:60,job:[32],minLevel:82,scope:Dt,maxCharges:2,duration:7},{id:"(lv) => lv>=92 ? 36935 : 16148",recast1000ms:120,job:[37],minLevel:38,scope:xt,duration:15},{id:16140,recast1000ms:90,job:[37],minLevel:6,scope:xt,duration:10},{id:"(lv) => lv>=82 ? 25758 : 16161",recast1000ms:25,job:[37],minLevel:68,scope:Dt,duration:8},{id:16151,recast1000ms:60,job:[37],minLevel:45,scope:Dt,maxCharges:"(lv) => lv>=84 ? 2 : 1"},{id:3570,recast1000ms:60,job:[24],minLevel:60,scope:Dt,maxCharges:"(lv) => lv>=98 ? 2 : 1"},{id:7432,recast1000ms:30,job:[24],minLevel:66,scope:Dt,maxCharges:"(lv) => lv>=98 ? 2 : 1"},{id:25861,recast1000ms:60,job:[24],minLevel:86,scope:Dt},{id:16542,recast1000ms:90,job:[28],minLevel:70,scope:Dt},{id:3585,recast1000ms:90,job:[28],minLevel:56,scope:Dt},{id:16538,recast1000ms:120,job:[28],minLevel:40,scope:Dt},{id:188,recast1000ms:30,job:[28],minLevel:50,scope:Dt,showResource:!0,resourceCost:1},{id:3583,recast1000ms:30,job:[28],minLevel:52,scope:Dt,showResource:!0,resourceCost:1},{id:7434,recast1000ms:45,job:[28],minLevel:62,scope:Dt,showResource:!0,resourceCost:1},{id:16545,recast1000ms:120,job:[28],minLevel:80,scope:Dt},{id:25867,recast1000ms:60,job:[28],minLevel:86,scope:Dt},{id:37014,recast1000ms:180,job:[28],minLevel:100,scope:Dt},{id:3614,recast1000ms:40,job:[33],minLevel:15,scope:Dt,maxCharges:"(lv) => lv>=78 ? (lv>=98 ? 3 : 2) : 1"},{id:3613,recast1000ms:60,job:[33],minLevel:58,scope:Dt},{id:16553,recast1000ms:60,job:[33],minLevel:60,scope:Dt},{id:7439,recast1000ms:60,job:[33],minLevel:62,scope:Dt},{id:16556,recast1000ms:30,job:[33],minLevel:74,scope:Dt,maxCharges:"(lv) => lv>=88 ? 2 : 1"},{id:16557,recast1000ms:60,job:[33],minLevel:76,scope:Dt},{id:16559,recast1000ms:120,job:[33],minLevel:80,scope:Dt},{id:25873,recast1000ms:60,job:[33],minLevel:86,scope:Dt},{id:24298,recast1000ms:30,job:[40],minLevel:50,scope:Dt,showResource:!0,resourceCost:1},{id:24299,recast1000ms:30,job:[40],minLevel:52,scope:Dt,showResource:!0,resourceCost:1},{id:24303,recast1000ms:45,job:[40],minLevel:62,scope:Dt,showResource:!0,resourceCost:1},{id:24305,recast1000ms:120,job:[40],minLevel:70,scope:Dt},{id:24311,recast1000ms:120,job:[40],minLevel:80,scope:Dt},{id:24310,recast1000ms:120,job:[40],minLevel:76,scope:Dt},{id:24300,recast1000ms:"(lv) => lv>=88 ? 90 : 120",job:[40],minLevel:56,scope:Dt},{id:24318,recast1000ms:120,job:[40],minLevel:90,scope:Dt},{id:37035,recast1000ms:180,job:[40],minLevel:100,scope:Dt},{id:7394,recast1000ms:120,job:[20],minLevel:64,scope:xt},{id:7394,overrideIconId:36944,recast1000ms:120,job:[20],minLevel:64,scope:Et},{id:65,recast1000ms:90,job:[2,20],minLevel:42,scope:Dt},{id:2241,recast1000ms:120,job:[29,30],minLevel:2,scope:xt},{id:"(lv) => lv>=82 ? 36962 : 7498",recast1000ms:15,job:[34],minLevel:6,scope:xt},{id:24404,recast1000ms:30,job:[39],minLevel:40,scope:xt},{id:7408,recast1000ms:120,job:[23],minLevel:66,scope:Dt},{id:16015,recast1000ms:60,job:[38],minLevel:52,scope:Dt},{id:16014,recast1000ms:120,job:[38],minLevel:80,scope:Dt},{id:157,recast1000ms:120,job:[7,25],minLevel:40,scope:xt},{id:155,recast1000ms:10,job:[25],minLevel:50,scope:xt},{id:25799,recast1000ms:60,job:[26,27],minLevel:2,scope:xt,maxCharges:"(lv) => lv>=88 ? 2 : 1"},{id:34685,recast1000ms:120,job:[42],minLevel:10,scope:Dt}],_t={class:"header-select"},$t={style:{height:"100%"}},Mt={key:0,class:"testLog"},Pt="v20260131",Ot=e(f({__name:"keigennRecord2",setup(e){const i=se(),n=Y(),o=n.userOptions;n.checkIsBrowser();const r="push"===o.order,l=$(o.minimize),c=o.actionCN?"actionCN":"action",d=$(!1),f={POV_ID:"keigenn-record-2-pov-id",PARTY_LIST:"keigenn-record-2-party-list",ENTITIES_MAP:"keigenn-record-2-job-map",PARTY_EVENT:"keigenn-record-2-party-event-party",RSV_DATA:"souma-keigenn-record-2-rsv-data",ZONE_NAME:"souma-keigenn-record-2-zone-name",VERSION:"keigenn-record-2-data-version"};let R=!1;const T=$(null);let S="",x=[],D={},M=[],O={},Z=0,q="",X=0,ee=[],Re=null;const Ce=new Map;const Ne=$(0),Te=P([{zoneName:"",duration:"00:00",table:V([]),key:"init",timestamp:-1}]),Le={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:Ie.ability(),statusEffectExplicit:Ie.statusEffectExplicit(),gainsEffect:Ie.gainsEffect(),losesEffect:Ie.losesEffect(),death:Ie.wasDefeated(),changeZone:Ie.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,addCombatant:Ie.addedCombatant(),removingCombatant:Ie.removingCombatant(),networkDoT:Ie.networkDoT(),wipe:Ie.network6d({command:["40000010","4000000F"]})};let Se={},xe={friendly:{},enemy:{}},Ee={};const De=new Map,Ae=At,_e=new St,$e=ae("keigenn-record-2");function Me(){d.value=!0,Z=0,Ee={},Ne.value=0,Te.value.length=0,Te.value.push({zoneName:"",duration:"00:00",table:V([]),key:"init",timestamp:-1}),Se={},xe={friendly:{},enemy:{}},D={},M=[],x=[],S="",X=0,Ce.clear(),De.clear(),O={},_e.clear(),ze()}async function Pe(){d.value=!1,null!==Re&&(cancelAnimationFrame(Re),Re=null,ee.length>0&&(r?(Te.value[0].table.push(...ee),U(()=>T.value?.scrollToBottom())):Te.value[0].table.unshift(...ee.reverse()),ee=[])),await Ue(),W(Te)}const Oe=n.icon4k;function He(e){const t=function(e){const t=Math.round(100*e)/100;if(Ce.has(t))return Ce.get(t);const s=[88,88,88],a=[50,250,200],i=Math.min(1,t/.5),n=(Math.min(9,Math.floor(10*i))/9)**.8,o=s[0]+(a[0]-s[0])*n,r=s[1]+(a[1]-s[1])*n,l=s[2]+(a[2]-s[2])*n,c=`rgba(${Math.round(o)}, ${Math.round(r)}, ${Math.round(l)}, 1)`;return Ce.set(t,c),c}(e.reduction),s=e.amount>999999?`${(e.amount/1e4).toFixed(0)}ä¸‡`:e.amount.toLocaleString(),a=function(e,t){return`https://souma.diemoe.net/resources/img/cj${t}/${e.replaceAll(/([A-Z])/g," $1").trim()}.png`}(e.jobIcon,o.iconType),{amount:i,maxHp:n,currentHp:r,shield:l,type:c,reduction:d}=e,u=Math.round(n*+l/100),m=Math.round(r/n*100),p=(i&&Math.round((i+u)/(1-d))||0).toLocaleString();return{...e,preCalculated:{reductionColor:t,amountDisplay:s,damageTypeClass:"heal"===e.effect?"is-heal":c,jobIconSrc:a,keigenns:e.keigenns.map(e=>({src:ye(`/i/${e.fullIcon}${Oe}.png`),usefulClass:be(e,c),title:`${o.statusCN?e.name:e.effect}(${e.source})`,duration:e.remainingDuration??"",isPov:e.isPov,effect:e.effect})),originalDamageDisplay:p,hpPercent:m,sortedSkills:(e.keySkills??[]).sort((e,t)=>{const s={party:0,other:1,self:2};return e.scope!==t.scope?s[e.scope]-s[t.scope]:e.ownerJob!==t.ownerJob?ke.indexOf(e.ownerJob)-ke.indexOf(t.ownerJob):e.recast1000ms!==t.recast1000ms?t.recast1000ms-e.recast1000ms:e.id-t.id})}}}function Ge(e){const t=e.substring(0,e.indexOf("|"));if(!t)return;const s=e.split("|");switch(_e.processLine(t,s,Ee),t){case"26":{if(!Le.gainsEffect.exec(e))return;const t=s[we.GainsEffect.fields.effectId],a=s[we.GainsEffect.fields.effect],i=s[we.GainsEffect.fields.target],n=s[we.GainsEffect.fields.targetId],o=Number.parseInt(s[we.GainsEffect.fields.count],16);let r=ue(t);if(!r){const e=n.startsWith("1")&&me.get(Number.parseInt(t,16).toString())||n.startsWith("4")&&pe.get(Number.parseInt(t,16).toString());if(!e)return;const s=fe(e.icon),a=o>1?he(s,o):s;r={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(t,16),fullIcon:a,name:e.name,isFriendly:e.isFriendly}}const l=s[we.GainsEffect.fields.duration],c=s[we.GainsEffect.fields.source],d=s[we.GainsEffect.fields.sourceId],u=new Date(s[we.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),m={name:r.name,type:r.type,count:o,effect:a,effectId:t,source:c,sourceId:d,target:i,targetId:n,expirationTimestamp:u,performance:r.performance,fullIcon:r.fullIcon,isPov:S===d};n.startsWith("1")&&r.isFriendly?(void 0===xe.friendly[n]&&(xe.friendly[n]={}),xe.friendly[n][t]=m):n.startsWith("4")&&!r.isFriendly&&(void 0===xe.enemy[i]&&(xe.enemy[i]={}),xe.enemy[i][t]=m)}break;case"30":{const e=s[we.LosesEffect.fields.target],t=s[we.LosesEffect.fields.targetId],a=s[we.LosesEffect.fields.effectId];t.startsWith("1")?xe.friendly[t]&&Reflect.deleteProperty(xe.friendly[t],a):xe.enemy[e]&&Reflect.deleteProperty(xe.enemy[e],a)}break;case"21":case"22":{if(0===Z)return;const e=s[we.Ability.fields.sourceId]??"???",t=s[we.Ability.fields.id]??"???",a=new Date(s[we.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const s=Number.parseInt(t,16),i=D[e]?.level??999,n=function(e){let t=De.get(e);if(!t){t=new Map;for(const s of Ae){if(s.minLevel>e)continue;const a=re(s.id,e);t.set(a,s);const i=oe(a);i!==a&&t.set(i,s)}De.set(e,t)}return t}(i),o=oe(s),r=n.get(s)||n.get(o);if(r){Ee[e]||(Ee[e]={}),Ee[e][o]||(Ee[e][o]=[]);const t=Ee[e][o];t.push(a);const s=re(r.maxCharges||1,i);t.length>s&&t.shift()}}const i=le(s),n=s[we.Ability.fields.targetId]??"???",r=i.isHeal&&i.amount>0&&n.startsWith("1"),l=i.isAttack&&i.amount>=0&&e.startsWith("4")&&n.startsWith("1");if(r||l){if(n!==S&&!x.includes(n)&&!M.find(e=>e.id===n))return;const e=s[we.Ability.fields.ability],l=e.match(/^_rsv_(?<id>\d+)_/);let c=e;if(l){const t=Number(l.groups?.id);c=O[t]??e.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===o.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=ce(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(s[we.Ability.fields.targetCurrentHp]),p=Number(s[we.Ability.fields.targetMaxHp]),f=s[we.Ability.fields.source]??"???",h=s[we.Ability.fields.target]??"???",{effect:v,type:g}=de(i.flags),b=Ze(0===Z?0:a-Z),{jobEnum:y,job:k,jobIcon:w,hasDuplicate:I}=Ve(n),j=Object.values(xe.friendly[n]??[]).concat(Object.values(xe.enemy[f]??[])).map(e=>{const t=Math.max(0,(e.expirationTimestamp-a)/1e3);return{...e,remainingDuration:t>=999?"":t.toFixed(t>.05&&t<.95?1:0)}}).filter(e=>Number(e.remainingDuration)>-3),R=Se[n]??"0",C=i.amount;let N=0;if(!r&&"instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const s of j)"absorbed"!==s.type&&(t*=s.performance[g]??1);N=1-t*e}Ke(He({key:(X++).toString(),time:b,timestamp:a,id:t,action:c,actionCN:u,source:f,target:h,targetId:n,job:k,jobIcon:w,jobEnum:y,hasDuplicate:I,amount:C,keigenns:j,currentHp:m,maxHp:p,effect:v,type:g,shield:R,povId:S,reduction:N,keySkills:Be(a,n)})),Te.value[0].duration=Ze(new Date(s[we.Ability.fields.timestamp]).getTime()-Z)}}break;case"25":{const t=Le.death.exec(e);if(!t||!t.groups)return;const s=t.groups.targetId,a=t.groups.target,i=t.groups.sourceId,n="E0000000"===i?"åœ°å½¢æ€":t.groups.source,o=t.groups.timestamp;if(0===Z)return;if(s!==S&&!x.includes(s)&&!M.find(e=>e.id===s))return;const r=new Date(o).getTime(),l=Ze(r-Z),{jobEnum:c,job:d,jobIcon:u,hasDuplicate:m}=Ve(s);Ke(He({key:(X++).toString(),time:l,timestamp:r,id:"",action:"Death",actionCN:"E0000000"===i?"åœ°å½¢æ€":"æ­»äº¡",source:n,target:a,targetId:s,job:d,jobIcon:u,jobEnum:c,hasDuplicate:m,amount:0,keigenns:[],currentHp:0,maxHp:0,effect:"death",type:"death",shield:"0",povId:S,reduction:0,keySkills:Be(r,s)}))}break;case"38":{const t=Le.statusEffectExplicit.exec(e);t&&t.groups?.targetId.startsWith("1")&&(Se[t.groups.targetId]=t.groups.currentShield)}break;case"260":{const e="1"===s[we.InCombat.fields.inACTCombat],t="1"===s[we.InCombat.fields.inGameCombat],a=new Date(s[we.InCombat.fields.timestamp]).getTime();if(e||t){const e=s[we.InCombat.fields.timestamp];if(Z>0)return;return 0===Te.value[0].table.length&&0===ee.length||(null!==Re&&(cancelAnimationFrame(Re),Re=null),ee.length>0&&(r?Te.value[0].table.push(...ee):Te.value[0].table.unshift(...ee.reverse()),ee=[]),Te.value.unshift({zoneName:"",duration:"00:00",table:V([]),key:e,timestamp:a}),W(Te)),Z=a,Te.value[0].zoneName=q,Te.value[0].timestamp=a,Te.value[0].key=e,void(Ne.value=0)}e||t||We(a)}break;case"01":{const e=Number.parseInt(s[we.ChangeZone.fields.id],16);if(q=s[we.ChangeZone.fields.name],ie[e]?.name){const t=ne(ie[e]?.name);t&&"Unknown"!==t&&(q=t)}Ee={},_e.clear(),We(new Date(s[we.ChangeZone.fields.timestamp]).getTime())}break;case"11":{const t=Le.partyList.exec(e);t&&(x=(t.groups?.list?.split("|")??[]).filter(Boolean),ze())}break;case"02":S=s[we.ChangedPlayer.fields.id],ze();break;case"03":if("00"!==s[we.AddedCombatant.fields.job]){const e=s[we.AddedCombatant.fields.job],t=s[we.AddedCombatant.fields.name],a=new Date(s[we.AddedCombatant.fields.timestamp]).getTime(),i=Number.parseInt(s[we.AddedCombatant.fields.level],16);D[s[we.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a,name:t,level:i},ze()}break;case"04":Reflect.deleteProperty(D,s[we.RemovedCombatant.fields.id]),Reflect.deleteProperty(xe.friendly,s[we.RemovedCombatant.fields.id]),Reflect.deleteProperty(xe.enemy,s[we.RemovedCombatant.fields.id]),ze();break;case"262":{const t=Le.rsv.exec(e);if(t){const e=Number(t.groups?.id),a=s[we.RSVData.fields.value];e&&a&&(O[Number(e)]=a)}}break;case"24":{const e=s[we.NetworkDoT.fields.which],t=s[we.NetworkDoT.fields.effectId],a=Number.parseInt(t,16),i="HoT"===e&&2718===a;if(!i&&!o.parseDoT)return;const n=s[we.NetworkDoT.fields.id];if("DoT"!==e&&"HoT"!==e||n.startsWith("4")||n!==S&&!x.includes(n)&&!M.find(e=>e.id===n))return;const r=s[we.NetworkDoT.fields.name],l=s[we.NetworkDoT.fields.damage],c=Number.parseInt(l,16);let d=e;i&&(d=o.actionCN?"å°å®‡å®™":"Microcosmos");const u=new Date(s[we.Ability.fields.timestamp]??"???").getTime(),m=Number(s[we.NetworkDoT.fields.currentHp]),p=Number(s[we.NetworkDoT.fields.maxHp]),f=Ze(0===Z?0:u-Z),{jobEnum:h,job:v,jobIcon:g,hasDuplicate:b}=Ve(n);Ke(He({key:(X++).toString(),time:f,timestamp:u,id:"",action:d,actionCN:d,source:"",target:r,targetId:n,job:v,jobIcon:g,jobEnum:h,hasDuplicate:b,amount:c,keigenns:[],currentHp:m,maxHp:p,effect:i?"heal":"damage done",type:i?"heal":"dot",shield:Se[n]??"0",povId:S,reduction:0,keySkills:[]}))}break;case"33":Le.wipe.exec(e)&&(_e.reset(),Ee={},Se={},xe.friendly={},xe.enemy={})}}const Fe=new Map;let Je=null;function ze(){Fe.clear(),Je=null,function(){const e=new Map,t=(t,s)=>{t&&s&&(e.has(t)||e.set(t,[]),e.get(t).push(s))};if(M.forEach(e=>t(e.job,e.id)),S){const e=M.find(e=>e.id===S)||D[S];e&&t(e.job,S)}x.forEach(e=>{const s=D[e];s&&t(s.job,e)}),_e.updateParty(e)}()}function Ve(e){const t=Fe.get(e);if(t)return t;const{job:s,hasDuplicate:a}=function(e){const t=D[e],s=M.find(t=>t.id===e)??{job:0,timestamp:0},a=(t?.timestamp??0)>s.timestamp?t:s,i=a===t?Object.entries(D).some(([t,s])=>t!==e&&s.job===a?.job&&x.includes(t)):M.some(t=>t.id!==e&&t.job===a?.job);return{job:a?.job??0,hasDuplicate:i}}(e),i=s,n={jobEnum:i,job:Q.jobToFullName(Q.jobEnumToJob(i)).simple2,jobIcon:Q.jobEnumToIcon(i),hasDuplicate:a};return Fe.set(e,n),n}function Ke(e){ee.push(K(e)),null===Re&&(Re=requestAnimationFrame(()=>{r?(Te.value[0].table.push(...ee),d.value||U(()=>T.value?.scrollToBottom())):Te.value[0].table.unshift(...ee.reverse()),ee=[],Re=null}))}function We(e){0!==Z&&(Te.value[0].duration=Ze(e-Z),Te.value[0]=K(Te.value[0]),Z=0,xe.friendly={},xe.enemy={},Se={},ze(),Ue())}function Be(e,t){if(!Je){const e=new Set;M.forEach(t=>e.add(t.id)),x.forEach(t=>e.add(t)),S&&e.add(S);const t=[];for(const s of e){const e=M.find(e=>e.id===s);if(e){t.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const a=D[s];a&&t.push({id:s,job:a.job,name:a.name??"Unknown",level:a.level})}Je=t.flatMap(e=>{const t=e.level||999;return Ae.filter(s=>s.job.includes(e.job)&&s.minLevel<=t).map(s=>{const a=re(s.id,t),i=re(s.recast1000ms,t);return{id:a,name:ce(a)||"Unknown",icon:ve(s.overrideIconId??a),recast1000ms:i,ownerId:e.id,ownerName:e.name,ownerJob:e.job,ownerJobName:Q.jobToFullName(Q.jobEnumToJob(e.job)).simple2,maxCharges:re(s.maxCharges||1,t),scope:s.scope,showResource:s.showResource,resourceCost:s.resourceCost}})})}return Je?Je.filter(e=>"party"===e.scope||("self"===e.scope?e.ownerId===t:"other"===e.scope&&e.ownerId!==t)).map(t=>{const s=Ee[t.ownerId]?.[oe(t.id)]??[],{charges:a,recastLeft:i}=ge(s,e,t.maxCharges||1,1e3*t.recast1000ms),n=Math.ceil(i/1e3),o=t.showResource?_e.getResource(t.ownerJob,t.ownerId):void 0,r=void 0===t.resourceCost||_e.isResourceReady(t.ownerJob,t.ownerId,t.id,t.resourceCost),l=a>0&&r,c=_e.getExtraText(t.ownerJob,t.ownerId,t.id,e,Ee[t.ownerId]||{});return{...t,jobResource:o,recastLeft:n,ready:l,chargesReady:a,extraText:c}}):[]}async function Ue(){if(d.value)return;const e=Te.value.filter(e=>"init"!==e.key&&e.timestamp>0&&e.table.length>0).map(e=>{const t=Array.isArray(e.table)?z(e.table):[];return{...z(e),table:t}});await $e.replaceAll(e)}function Ze(e){const t=Math.max(Math.floor(e/6e4),0),s=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${s<10?"0":""}${s}`}function Ye(){l.value=!l.value}function qe(){"init"!==Te.value[0]?.key&&void 0!==Te.value[0]||(Te.value.unshift({zoneName:"",duration:"00:00",table:V([]),key:"test",timestamp:Date.now()}),W(Te),Ne.value=0),Ke(He({key:(X++).toString(),time:Ze(Date.now()-(Z||Date.now())),timestamp:Date.now(),id:"unknown",action:"test",actionCN:"æµ‹è¯•æŠ€èƒ½",source:"çŽ¯å¢ƒä¼¤å®³",target:"æµ‹è¯•è§’è‰²",targetId:"test-id",job:"æµ‹è¯•èŒä¸š",jobIcon:Q.jobEnumToIcon(19),jobEnum:19,hasDuplicate:!1,amount:12345,keigenns:[],currentHp:5e4,maxHp:1e5,effect:"damage done",type:"physics",shield:"10",povId:"test-id",reduction:.1,keySkills:[]}))}function Xe(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return C(()=>{te(),function(){try{if(localStorage.getItem(f.VERSION)!==Pt)return Object.values(f).forEach(e=>{e!==f.VERSION&&localStorage.removeItem(e)}),localStorage.setItem(f.VERSION,Pt),void(R=!0);const e=localStorage.getItem(f.POV_ID);e&&(S=e);const t=localStorage.getItem(f.PARTY_LIST);t&&(x=JSON.parse(t));const s=localStorage.getItem(f.ENTITIES_MAP);s&&(D=JSON.parse(s));const a=localStorage.getItem(f.PARTY_EVENT);a&&(M=JSON.parse(a));const i=localStorage.getItem(f.RSV_DATA);i&&(O=JSON.parse(i));const n=localStorage.getItem(f.ZONE_NAME);n&&(q=n)}catch(e){}}();const e=H({storageKey:"keigenn-record-2-theme"}),t=B(e);!1===e.value&&t();for(const s in D){const e=D[s];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(D,s)}!async function(){Ne.value=0;try{if(R)await $e.replaceAll([]),Te.value.length=0;else{const e=await $e.getAll();if(e.length){Te.value.length=0;let t=e.filter(e=>n.isBrowser||e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp);r||(t=t.reverse());const s=t.map(e=>({...e,table:V(Array.isArray(e.table)?e.table.map(e=>K(e)):[])}));Te.value.push(...s)}}0===Te.value.length&&Te.value.push({zoneName:"",duration:"00:00",table:V([]),key:"init",timestamp:-1}),W(Te)}catch(e){throw Te.value.length=0,e}}(),je("LogLine",e=>{Ge(e.rawLine)}),je("PartyChanged",e=>{M=e.party.map(e=>({...e,timestamp:Date.now()})),ze()}),je("ChangePrimaryPlayer",e=>{S=Number(e.charID).toString(16).toUpperCase(),ze()}),je("CombatData",e=>{if(!(Z>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(q=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let s=0;3===t.length?s=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(s=1e3*(60*t[0]+t[1]));const a=Date.now()-s;0!==Te.value[0].table.length&&(Te.value.unshift({zoneName:"",duration:"00:00",table:V([]),key:String(a),timestamp:a}),W(Te)),Te.value[0].zoneName=q,Z=a,Te.value[0].timestamp=a,Te.value[0].key=String(a),Ne.value=0}})}),N(()=>{!function(){try{localStorage.setItem(f.POV_ID,S),localStorage.setItem(f.PARTY_LIST,JSON.stringify(x)),localStorage.setItem(f.ENTITIES_MAP,JSON.stringify(D)),localStorage.setItem(f.PARTY_EVENT,JSON.stringify(M)),localStorage.setItem(f.RSV_DATA,JSON.stringify(O)),localStorage.setItem(f.ZONE_NAME,q)}catch(e){}}(),Ue()}),(e,r)=>{const d=s,f=a,R=p,C=tt,N=t;return h(),v(y,null,[L("div",{class:"wrapper",style:j({"--scale":I(o).scale,"--opacity":I(o).opacity}),onContextmenu:r[1]||(r[1]=J(()=>{},["prevent"]))},[L("header",null,[L("div",_t,[G(g(f,{modelValue:Ne.value,"onUpdate:modelValue":r[0]||(r[0]=e=>Ne.value=e),size:"small",class:_(["combat-select",I(n).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:b(()=>[(h(!0),v(y,null,k(Te.value.length,e=>(h(),w(d,{key:`${Te.value[e-1].key}-${Te.value[e-1].duration}-${Te.value[e-1].zoneName}`,value:e-1,label:`${Te.value[e-1].zoneName}${""===Te.value[e-1].zoneName?"":` - [${Te.value[e-1].duration}] ${Xe(Te.value[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[F,!l.value]])]),I(n).isBrowser?E("",!0):(h(),w(R,{key:0,class:_(["minimize",l.value?"in-minimize":"not-minimize"]),icon:l.value?I(u):I(m),circle:"",style:j({opacity:l.value?.5:1}),onClick:Ye},null,8,["class","icon","style"]))]),G(L("main",$t,[g(C,{ref_key:"tableRef",ref:T,rows:Te.value[Ne.value].table,"action-key":I(c)},null,8,["rows","action-key"])],512),[[F,!l.value]])],36),I(n).isBrowser||I(i)?(h(),v("div",Mt,[I(i)?(h(),w(R,{key:0,onClick:qe},{default:b(()=>[...r[2]||(r[2]=[A(" æµ‹è¯• ",-1)])]),_:1})):E("",!0),g(N,{onBeforeHandle:Me,onAfterHandle:Pe,onHandleLine:Ge})])):E("",!0)],64)}}}),[["__scopeId","data-v-c998fb6a"]]);export{Ot as default};
