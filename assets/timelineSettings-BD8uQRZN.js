import{r as e}from"./index-Xobdadb3.js";/* empty css                  *//* empty css                *//* empty css                        *//* empty css                   *//* empty css                  *//* empty css                  *//* empty css                */import{u as t,_ as l,p as i}from"./TimelineShow-CO0mGvHK.js";/* empty css                 */import{l as n}from"./lz-string-CVcEDcxI.js";/* empty css                        *//* empty css                     *//* empty css                  *//* empty css                  */import{h as a,C as o,D as s,r,F as c,e as d,G as u,f as m,H as p,I as f,J as y,z as g,y as w,m as b,j as h,n as v,K as _,s as T,L as F,M as V,d as x,k as j,l as k,o as $,N as C,q as S,O as I,b as A,B,P as N}from"./element-plus-ISrjp7mH.js";import{g as z}from"./actionChinese-Bq9yRWQ5.js";import{U as E}from"./util-DL4pAhxD.js";import{h as U,g as O}from"./xivapi-BtnvNd5O.js";/* empty css                    */import{t as P,r as J,V as L,v as D,x as M,L as H,C as K,G as R,A as q,D as W,I as G,S as X,u as Y,h as Z,J as Q,K as ee,a9 as te,d as le,c as ie,O as ne,f as ae,w as oe,E as se,M as re}from"./vue-vendor-Bz5Jh0Fv.js";import{_ as ce}from"./_plugin-vue_export-helper-BCo6x5W8.js";/* empty css                 */import"./actWS-BO427Mkt.js";import{u as de,c as ue}from"./useWebSocket-DlbwIyTa.js";import{h as me}from"./utils-f4tm6vQK.js";import{z as pe}from"./zoneInfo-DYXq9BIn.js";import{a as fe,c as ye}from"./overlay_plugin_api-DU1DlPio.js";/* empty css                */const ge=new Map;ge.set(26155,{type:"cast",window:[999,999]}),ge.set(28027,{type:"cast",window:[999,999]}),ge.set(26340,{type:"cast",window:[999,999]}),ge.set(25533,{type:"begincast",window:[60,60]}),ge.set(26376,{type:"cast",window:[999,999]}),ge.set(26814,{type:"begincast",window:[999,999]}),ge.set(25313,{type:"begincast",window:[200,200]}),ge.set(27526,{type:"begincast",window:[999,999]}),ge.set(26215,{type:"cast",window:[500,30]}),ge.set(29050,{type:"begincast",window:[200,30]}),ge.set(29156,{type:"cast",window:[20,20]}),ge.set(27973,{type:"cast",window:[20,20]}),ge.set(27937,{type:"begincast",window:[20,20]}),ge.set(28059,{type:"begincast",window:[20,20]}),ge.set(28060,{type:"begincast",window:[20,20]}),ge.set(28061,{type:"begincast",window:[20,20]}),ge.set(27956,{type:"begincast",window:[20,20]}),ge.set(27957,{type:"begincast",window:[20,20]}),ge.set(27952,{type:"begincast",window:[30,30]}),ge.set(27969,{type:"begincast",window:[20,20]}),ge.set(27971,{type:"begincast",window:[20,20]}),ge.set(27939,{type:"begincast",window:[20,20]}),ge.set(27966,{type:"begincast",window:[20,20]}),ge.set(25316,{type:"begincast",window:[999,999]}),ge.set(25544,{type:"begincast",window:[10,10]}),ge.set(26379,{type:"begincast",window:[10,10]}),ge.set(31552,{type:"begincast",window:[30,30]}),ge.set(31573,{type:"begincast",window:[30,30]}),ge.set(31573,{type:"begincast",window:[30,30]}),ge.set(31617,{type:"begincast",window:[8,8]}),ge.set(31624,{type:"begincast",window:[30,30]}),ge.set(31649,{type:"begincast",window:[30,30]}),ge.set(18864,{type:"cast",window:[10,2.5],once:!0}),ge.set(18480,{type:"cast",window:[200,60],once:!0}),ge.set(18516,{type:"cast",window:[250,65],once:!0}),ge.set(18522,{type:"begincast",window:[500,500],once:!0}),ge.set(18552,{type:"begincast",window:[67,67],once:!0}),ge.set(18553,{type:"cast",window:[67,67],once:!0}),ge.set(19083,{type:"cast",window:[900,0],once:!0}),ge.set(40191,{type:"begincast",window:[200,20],once:!0}),ge.set(40265,{type:"begincast",window:[500,20],once:!0}),ge.set(40246,{type:"begincast",window:[999,30],once:!0}),ge.set(40306,{type:"begincast",window:[30,30],once:!0});const we={class:"query-results"},be={class:"ability-filter-container"},he={key:0,class:"loading-abilities"},ve=["src","alt","onerror"],_e=ce(P({__name:"FflogsImport",props:{filters:{}},emits:["newTimeline","showFFlogsToggle","clearCurrentlyTimeline","updateFilters"],setup(e,{emit:l}){const i=e,n=l,_=new RegExp("(?<=^|\\/)(?<code>\\w{16,})[#?]fight=(?<fight>\\d+|last)"),T={begincast:"14",cast:"1[56]"},F=J("查询"),V=J(""),x=J(!1),j=J(!1),k=J(0),$=J(!1),C=L({});B();const S=t();async function I(e){j.value=!0,k.value=2,C.player=e;try{await async function(){var e,t;$.value=!1;const l=[];async function n(e){var t;try{const i=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${C.code}?start=${e}&end=${C.end}&hostility=0&sourceid=${null==(t=C.player)?void 0:t.id}&api_key=${S.settings.api}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}));l.push(...i.events),i.nextPageTimestamp&&i.nextPageTimestamp>0&&i.nextPageTimestamp<C.end&&await n(i.nextPageTimestamp)}catch(i){h.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${i}`,"获取友方技能数据失败",{confirmButtonText:"确定",type:"error"})}}async function a(e,t){if(t>=0)try{const i=await fetch(`https://cn.fflogs.com/v1/report/events/casts/${C.code}?start=${e}&end=${C.end}&hostility=1&sourceid=${C.bossIDs[t]}&api_key=${S.settings.api}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}));l.push(...i.events),i.nextPageTimestamp&&i.nextPageTimestamp>0&&i.nextPageTimestamp<C.end&&await a(i.nextPageTimestamp,t),t<C.bossIDs.length-1&&await a(e,t+1)}catch(i){h.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${i}`,"获取敌方技能数据失败",{confirmButtonText:"确定",type:"error"})}}C.abilityFilterEvents.length=0,await Promise.all([n(C.start),a(C.start,0)]);for(const i of l)"begincast"===i.type&&i.sourceIsFriendly||C.abilityFilterEvents.push({time:Number(((i.timestamp-C.start)/1e3).toFixed(1)),type:i.type,actionName:z(i.ability.guid)??i.ability.name,actionId:i.ability.guid,sourceIsFriendly:i.sourceIsFriendly,url:(null==(e=null==i?void 0:i.ability)?void 0:e.abilityIcon.replace("-","/").replace(".png",""))??"000000/000405",window:void 0});(null==(t=C.player)?void 0:t.icon)&&i.filters[C.player.icon]&&(C.abilityFilterSelected=i.filters[C.player.icon]);$.value=!0}(),C.abilityFilterCandidate=C.abilityFilterEvents.reduce(((e,t)=>(t.sourceIsFriendly&&!e.find((e=>e.actionId===t.actionId))&&e.push(t),e)),[]),j.value=!1}catch(t){h.alert(`请稍后重试。如果问题持续存在,请检查您的网络连接。错误详情: ${t}`,"获取玩家技能数据失败",{confirmButtonText:"确定",type:"error"}),j.value=!1}}function A(){var e,t,l,i;j.value=!0,k.value=3,(null==(e=C.player)?void 0:e.icon)&&n("updateFilters",null==(t=C.player)?void 0:t.icon,JSON.parse(JSON.stringify(C.abilityFilterSelected))),C.abilityFilterEvents=C.abilityFilterEvents.filter((e=>e.sourceIsFriendly&&C.abilityFilterSelected.includes(e.actionId)||!e.sourceIsFriendly)).sort(((e,t)=>e.time-t.time)),C.abilityFilterEvents=function(e){for(const t of e){const e=ge.get(t.actionId);(null==e?void 0:e.type)===t.type&&(t.window=null==e?void 0:e.window),t.syncOnce=Boolean(null==e?void 0:e.once)}return e}(C.abilityFilterEvents),C.abilityFilterEventsAfterFilterRawTimeline=C.abilityFilterEvents.map((e=>e.sourceIsFriendly?`${e.time} "<${e.actionName}>~"${x.value?` tts "${e.actionName}"`:""}`:/^(?:攻击|attack|攻撃)$|^unknown/i.test(e.actionName)||"cast"===e.type&&void 0===e.window?`# ${e.time} "${e.actionName}"`:`${e.time} "${e.actionName}" sync /^.{14} \\w+ ${T[e.type]}:4.{7}:[^:]+:${e.actionId.toString(16).toUpperCase()}:/${e.window?` window ${e.window.join(",")}`:""}`)).join("\n"),n("newTimeline",`导入${null==(l=C.player)?void 0:l.name}`,{zoneId:C.zoneID.toString(),jobs:[(null==(i=C.player)?void 0:i.icon)??"NONE"]},C.abilityFilterEventsAfterFilterRawTimeline,`${C.code}#fight=${C.fightIndex+1}`),B(),n("showFFlogsToggle"),setTimeout((()=>{k.value=0}),500),j.value=!1}function B(){C.code="",C.fightIndex=0,C.start=0,C.end=0,C.friendlies=[],C.abilityFilterEvents=[],C.abilityFilterCandidate=[],C.abilityFilterSelected=[],C.abilityFilterEventsAfterFilterRawTimeline="",C.player=void 0,C.zoneID=0,C.bossIDs=[]}function N(){window.open("https://cn.fflogs.com/profile","_blank")}return(e,t)=>{const l=a,i=o,n=s,T=d,z=c,P=u,J=m,L=p,le=y,ie=r,ne=g,ae=w,oe=v,se=b;return M(),D(ee,null,[H(l,{style:X(Y(k)>0?{}:{visibility:"hidden",pointerEvent:"none"}),type:"primary",text:"","position-absolute":"","z-999":"",class:"guide",onClick:t[0]||(t[0]=e=>k.value--)},{default:W((()=>t[6]||(t[6]=[G(" 上一步 ")]))),_:1,__:[6]},8,["style"]),H(n,{active:Y(k),class:"steps-guide","align-center":""},{default:W((()=>[H(i,{title:"输入链接"}),H(i,{title:"选择玩家"}),H(i,{title:"过滤技能"}),H(i,{title:"生成时间轴"})])),_:1},8,["active"]),0===Y(k)?(M(),K(ie,{key:0,class:"input-section"},{default:W((()=>[H(le,{"label-width":"150px",class:"fflogs-form"},{default:W((()=>[H(z,{label:"FF Logs 战斗链接"},{default:W((()=>[H(T,{modelValue:Y(V),"onUpdate:modelValue":t[1]||(t[1]=e=>Z(V)?V.value=e:null),placeholder:"https://www.fflogs.com/reports/AAAaAaAAaa1aA1aA?fight=1",autocomplete:"on"},null,8,["modelValue"])])),_:1}),H(z,{label:"FF logs V1 Key"},{default:W((()=>[H(T,{modelValue:Y(S).settings.api,"onUpdate:modelValue":t[2]||(t[2]=e=>Y(S).settings.api=e),placeholder:"在 FF Logs 个人设置页面获取 V1 API Key",type:"password"},{append:W((()=>[H(P,{content:"点击前往 FF Logs 个人设置页面，在最下方填写 V1客户名称 并点击确认后，再获取你的 V1 客户端密钥",placement:"top",effect:"light"},{default:W((()=>[H(l,{type:"primary",link:"",onClick:N},{default:W((()=>t[7]||(t[7]=[G(" 如何获取 ")]))),_:1,__:[7]})])),_:1})])),_:1},8,["modelValue"])])),_:1}),H(z,{label:"使用 TTS"},{default:W((()=>[H(J,{modelValue:Y(x),"onUpdate:modelValue":t[3]||(t[3]=e=>Z(x)?x.value=e:null)},null,8,["modelValue"])])),_:1}),H(z,null,{default:W((()=>[H(l,{disabled:"正在查询..."===Y(F),type:"primary",onClick:t[4]||(t[4]=e=>async function(e){var t,l,i;j.value=!0,B(),F.value="正在查询...";const n=e.match(_);if(!S.settings.api)return h.alert("请在FF Logs个人设置页面获取V1 API Key","FF logs API Key 未填写",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0,message:'<a href="https://cn.fflogs.com/profile">点击这里，在最下方<strong>填写 V1 客户名称并点击确认</strong>后，获取你的 V1 客户端密钥</a>'}),F.value="查询",void(j.value=!1);if(!n)return h.alert("请正确填写FF Logs链接","FF Logs链接格式错误",{confirmButtonText:"确定",type:"error"}),F.value="查询",void(j.value=!1);C.code=(null==(t=n.groups)?void 0:t.code)??"";try{const e=await fetch(`https://cn.fflogs.com/v1/report/fights/${C.code}?api_key=${S.settings.api}`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}));C.bossIDs=e.enemies.filter((e=>"Boss"===e.type)).map((e=>e.id)),C.fightIndex=("last"===(null==(l=null==n?void 0:n.groups)?void 0:l.fight)?e.fights.length:Number.parseInt((null==(i=null==n?void 0:n.groups)?void 0:i.fight)??"0"))-1;const t=e.fights[C.fightIndex];C.zoneID=t.zoneID,C.start=t.start_time,C.end=t.end_time,C.friendlies=e.friendlies.filter((e=>"LimitBreak"!==e.icon&&e.fights.find((e=>e.id===C.fightIndex+1)))),F.value="查询",C.abilityFilterEvents.length=0,C.abilityFilterCandidate.length=0,j.value=!1,k.value=1}catch(a){h.alert(`\n  <h3 style="margin-bottom: 10px;">可能的原因：</h3>\n  <ul style="padding-left: 20px; margin-bottom: 10px;">\n    <li> <strong>90%概率</strong>：你没有<strong style="color: red;">先起名</strong>再获取 V1 客户端密钥</li>\n    <li> <strong>5%概率</strong>：该战斗记录是私人或匿名模式</li>\n    <li> <strong>5%概率</strong>：网络异常</li>\n  </ul>\n<p class="error-details"><strong>错误：</strong>${a}</p>\n`,"请求失败",{confirmButtonText:"确定",type:"error",dangerouslyUseHTMLString:!0}),F.value="查询",j.value=!1}}(Y(V)))},{default:W((()=>[Y(j)?(M(),K(L,{key:0,class:"is-loading"},{default:W((()=>[H(Y(f))])),_:1})):R("",!0),G(" "+Q(Y(F)),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):R("",!0),q("div",we,[1===Y(k)?(M(),K(ie,{key:0,class:"player-selection"},{default:W((()=>[H(ae,{data:Y(C).friendlies.filter((e=>!["NPC"].includes(e.icon))),stripe:"",border:"",class:"friendlies-table"},{default:W((()=>[H(ne,{prop:"name",label:"玩家名称"}),H(ne,{label:"职业"},{default:W((({row:e})=>[G(Q(Y(E).nameToFullName(Y(E).jobEnumToJob(Y(E).iconToJobEnum(e.icon))).cn),1)])),_:1}),H(ne,{label:"选定",width:"100",align:"center"},{default:W((e=>[H(l,{type:"primary",size:"small",onClick:t=>I(e.row)},{default:W((()=>t[8]||(t[8]=[G(" 选择 ")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1})):R("",!0),2===Y(k)?(M(),K(ie,{key:1,class:"ability-filter"},{default:W((()=>[q("div",be,[Y($)?R("",!0):(M(),D("div",he,[H(L,{class:"is-loading"},{default:W((()=>[H(Y(f))])),_:1}),t[9]||(t[9]=q("span",null,"正在加载技能列表...",-1))])),Y($)?(M(),K(se,{key:1,modelValue:Y(C).abilityFilterSelected,"onUpdate:modelValue":t[5]||(t[5]=e=>Y(C).abilityFilterSelected=e),multiple:"",placeholder:"选择需要导入的技能","fit-input-width":!0,class:"ability-filter-select"},{default:W((()=>[(M(!0),D(ee,null,te(Y(C).abilityFilterCandidate,(e=>(M(),K(oe,{key:e.actionId,value:e.actionId,label:e.actionName,class:"ability-filter-option"},{default:W((()=>[q("img",{src:Y(O)(`/i/${e.url}.png`),class:"ability-filter-icon",alt:e.actionName,onerror:Y(U)},null,8,ve),q("span",null,Q(e.actionName),1)])),_:2},1032,["value","label"])))),128))])),_:1},8,["modelValue"])):R("",!0),Y($)?(M(),K(l,{key:2,type:"success",class:"filter-confirm-btn",disabled:!Y($),onClick:A},{default:W((()=>t[10]||(t[10]=[G(Q("生成时间轴"))]))),_:1,__:[10]},8,["disabled"])):R("",!0)])])),_:1})):R("",!0)])],64)}}}),[["__scopeId","data-v-abe873c0"]]),Te=ce(P({__name:"SettingsDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:i}){const n=e,a=i,o=t();le((()=>{o.saveTimelineSettings()}));const s=ie({get:()=>n.modelValue,set:e=>a("update:modelValue",e)}),r=J(-15),d=J([{time:-15,action:"<圣光幕帘>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:-2,action:"<圣灵>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:0,action:"战斗开始！",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:3,action:"<挑衅>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1},{time:5,action:"<神圣领域>~",show:!0,windowBefore:0,windowAfter:0,alertAlready:!1}]);return(e,t)=>{const i=x,n=c,a=V,u=T,m=F,p=l,f=y,g=_;return M(),K(g,{modelValue:Y(s),"onUpdate:modelValue":t[1]||(t[1]=e=>Z(s)?s.value=e:null),modal:!0,overflow:"","close-on-click-modal":!1,"custom-class":"timeline-dialog",width:"600px","append-to-body":!0,draggable:!0},{header:W((()=>t[2]||(t[2]=[q("h3",{style:{margin:"0",padding:"10px","background-color":"#f5f7fa",cursor:"move"}}," 设置 ",-1)]))),default:W((()=>[H(f,{"label-position":"right","label-width":"120px",class:"timeline-form"},{default:W((()=>[t[3]||(t[3]=q("h3",{class:"form-section-title"}," 参数 ",-1)),H(u,{gutter:20},{default:W((()=>[(M(!0),D(ee,null,te(Y(o).configValues,((e,t,l)=>(M(),K(a,{key:l,span:12},{default:W((()=>[H(n,{label:Y(o).configTranslate[t]},{default:W((()=>[H(i,{modelValue:Y(o).configValues[t],"onUpdate:modelValue":e=>Y(o).configValues[t]=e,min:0,step:.1,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label"])])),_:2},1024)))),128))])),_:1}),t[4]||(t[4]=q("h3",{class:"form-section-title"}," 样式 ",-1)),H(u,{gutter:20},{default:W((()=>[(M(!0),D(ee,null,te(Y(o).showStyle,((e,t,l)=>(M(),K(a,{key:l,span:12},{default:W((()=>[H(n,{label:Y(o).showStyleTranslate[t]},{default:W((()=>[H(i,{modelValue:Y(o).showStyle[t],"onUpdate:modelValue":e=>Y(o).showStyle[t]=e,min:0,step:.01,class:"custom-input"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label"])])),_:2},1024)))),128))])),_:1}),t[5]||(t[5]=q("h3",{class:"form-section-title"}," 测试用例 ",-1)),H(u,{gutter:20},{default:W((()=>[H(m,{modelValue:Y(r),"onUpdate:modelValue":t[0]||(t[0]=e=>Z(r)?r.value=e:null),min:-15,max:5,step:.1,"show-input":""},null,8,["modelValue"]),H(p,{config:Y(o).configValues,lines:Y(d),runtime:Y(r),"show-style":Y(o).showStyle},null,8,["config","lines","runtime","show-style"])])),_:1})])),_:1,__:[3,4,5]})])),_:1},8,["modelValue"])}}}),[["__scopeId","data-v-6104eb5f"]]),Fe={class:"alerts-container"},Ve={class:"slider-demo-block"},xe={class:"timeline-info-config"},je={class:"timeline-info-config"},ke={class:"timeline-info-config"},$e={class:"timeline-info-config"},Ce={class:"timeline-info-config"},Se={style:{flex:"1"}},Ie={style:{"max-height":"353px"}},Ae={class:"timeline-timeline-view"},Be=ce(P({__name:"timelineSettings",setup(o){const{wsConnected:s}=de({allowClose:!0,addWsParam:!0}),c=J(0),u=t(),m=ne(u,"allTimelines"),p=ne(u,"filters"),f=[{id:"0",name:"任意"}],y=J(!1),V=J(!1),x=L({timeline:{name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}),z=J([]);let U=null,O=!1;async function P(){z.value=[{time:0,action:"正在加载...",show:!0,windowBefore:0,windowAfter:0,alertAlready:!0}],z.value=await i(x.timeline.timeline)}function X(e,t={}){ye({call:"broadcast",source:"soumaTimelineSettings",msg:{type:e,data:t}})}function le(){y.value=!0,ge()}function ce(){window.open("https://docs.qq.com/sheet/DTWxKT3lFbmpDV3Fm?tab=5ovrc8","_blank")}function ge(){c.value=-30,x.timeline={name:"空",condition:{zoneId:"0",jobs:["NONE"]},timeline:"空",codeFight:"空",create:"空"}}function we(){x.timeline=u.allTimelines[u.newTimeline()],P()}function be(e){const t=JSON.stringify(e),l=JSON.parse(t);for(const n of l)n.timeline=n.timeline.replace(/^#.*\n/gm,"");const i=JSON.stringify(l),a=n.compressToBase64(t),o=n.compressToBase64(i),s=a.length,r=o.length;if(s===r)return void ue(a).then((()=>{A({message:"数据复制成功，已写入剪切板。",type:"success",duration:2e3})})).catch((()=>{A({message:"复制失败，请手动复制！",type:"error",duration:3e3})}));const c=((s-r)/s*100).toFixed(2);h.confirm(`\n     1. 完整版本（包含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${s} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 包含所有时间轴信息和注释<br><br>\n     2. 优化版本（不含注释）<br>\n     &nbsp;&nbsp;&nbsp;- 大小：${r} 字节<br>\n     &nbsp;&nbsp;&nbsp;- 节省 ${c}% 的空间<br>\n     &nbsp;&nbsp;&nbsp;- 仅包含必要的时间轴数据`,"请选择导出版本：",{confirmButtonText:"导出优化版本",cancelButtonText:"导出完整版本",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnPressEscape:!1,dangerouslyUseHTMLString:!0,showClose:!0,type:"info",callback:e=>{if("cancel"===e||"confirm"===e){ue("confirm"===e?o:a).then((()=>{A({message:"压缩数据复制成功，已写入剪切板。",type:"success",duration:2e3})})).catch((()=>{A({message:"复制失败，请手动复制！",type:"error",duration:3e3})}))}}})}function he(){h.prompt("请输入导出的字符串（支持多行导入）","导入时间轴",{confirmButtonText:"解析",cancelButtonText:"取消",inputType:"textarea",inputValidator:e=>{if(!e)return"请输入导出的字符串";const t=e.split("\n").filter((e=>""!==e.trim()));let l=[];for(const i of t){let e;try{e=JSON.parse(i)}catch{try{const t=n.decompressFromBase64(i);e=JSON.parse(t)}catch{return`无法解析输入的数据：${i}，请确保每行都是正确的JSON或压缩后的字符串。`}}if(!Array.isArray(e))return`导入的数据格式不正确：${i}`;l=l.concat(e)}return 0!==l.length||"导入的数据不包含任何时间轴。"},inputErrorMessage:"无效的输入"}).then((({value:e})=>{const t=e.split("\n").filter((e=>""!==e.trim()));let l=[];for(const o of t){let e;try{e=JSON.parse(o)}catch{const t=n.decompressFromBase64(o);e=JSON.parse(t)}l=l.concat(e)}const i=l.length,a=l.map((e=>`「${e.name}」`)).join(", ");h({title:"确认",message:`导入 ${i} 个时间轴：\n${a}\n？`,showCancelButton:!0,showConfirmButton:!0,confirmButtonText:"追加",cancelButtonText:"覆盖",distinguishCancelAndClose:!0,type:"warning",callback:e=>{"cancel"===e?h.prompt('覆盖操作将删除所有现有的时间轴。请输入"我确认"以继续。',"二次确认",{confirmButtonText:"确定覆盖",cancelButtonText:"取消",inputPattern:/^我确认$/,inputErrorMessage:'请输入"我确认"以确认覆盖操作',type:"warning"}).then((({value:e})=>{"我确认"===e&&ve(l,!0)})).catch((()=>{})):"confirm"===e&&ve(l,!1)}})})).catch((()=>{}))}function ve(e,t){t&&(u.allTimelines.length=0),u.allTimelines.push(...e),u.sortTimelines();for(const a of u.allTimelines)void 0===a.condition.jobs&&(a.condition.jobs=[a.condition.job]);if(ge(),t)return void A({type:"success",message:"覆盖成功！",duration:2e3});const l=[],i=new Set;for(const a of u.allTimelines){const e=JSON.stringify({name:a.name,condition:a.condition,timeline:a.timeline,codeFight:a.codeFight,create:a.create});i.has(e)||(i.add(e),l.push(a))}const n=u.allTimelines.length-l.length;u.allTimelines=l,A({message:`追加成功！共导入 ${e.length} 个时间轴${n>0?`，但其中 ${n} 个重复，已自动移除。`:""}`,type:"success",duration:3e3})}ge(),function(){var e,t,l;for(const i in pe)if(Object.prototype.hasOwnProperty.call(pe,i)){const n=pe[i];switch(n.contentType){case 4:case 5:case 28:f.push({id:i,name:(null==(e=n.name)?void 0:e.cn)??(null==(t=n.name)?void 0:t.ja)??(null==(l=n.name)?void 0:l.ja)??i})}}u.loadTimelineSettings(),u.sortTimelines()}();const Be=ie((()=>`${(c.value<0?"-":"")+(Array.from({length:2}).join("0")+(Math.floor(c.value/60)+(c.value<0?1:0))).slice(-2)}:${(Array.from({length:2}).join("0")+Math.floor(c.value%60)).slice(-2)}`));function Ne(){const t=e.resolve({path:"/timelineHelp"}).href;window.open(t,"_blank")}function ze(e){u.configValues=e.configValues,u.showStyle=e.showStyle}const Ee=e=>{if("soumaTimeline"===e.source&&"post"===e.msg.type){O=!1,U.close();const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort(((e,t)=>u.jobList.indexOf(e)-u.jobList.indexOf(t))),Reflect.deleteProperty(e.condition,"job");u.allTimelines=t.allTimelines,u.configValues=t.configValues,u.showStyle=t.showStyle,A.closeAll(),A({message:"数据获取成功",type:"success",duration:3e3})}};function Ue(){O=!0,U=N.service({lock:!0,text:"正在请求数据，请确保 ACT 与悬浮窗已开启...，若 10 秒内仍未获取到数据，请检查 ACT 状态，且确认 timeline 悬浮窗已开启，或刷新页面重连。",background:"rgba(0, 0, 0, 0.7)"}),X("get"),setTimeout((()=>{O&&(A.info("重新尝试获取数据..."),Ue())}),5e3)}function Oe(){h.confirm("你确定要将当前数据发送至 ACT 悬浮窗吗？悬浮窗中的内容将会被覆盖！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{X("post",u.$state)}))}function Pe(){ge(),Ue()}return ae((()=>{fe("BroadcastMessage",Ee);const e=oe(s,(t=>{t&&(0===u.allTimelines.length&&Ue(),e())}))})),(e,t)=>{const i=Te,n=a,o=$,s=k,A=T,N=C,U=j,O=_e,J=_,L=F,X=d,ie=v,ne=b,ae=l,oe=r,de=g,ue=w,pe=I,fe=S,ye=B;return M(),K(ye,{class:"container"},{default:W((()=>[H(i,{modelValue:Y(V),"onUpdate:modelValue":t[0]||(t[0]=e=>Z(V)?V.value=e:null),onSave:ze},null,8,["modelValue"]),H(U,{class:"flex-header"},{default:W((()=>[H(A,{justify:"space-between",align:"middle","m-b-2":""},{default:W((()=>[H(s,{wrap:"",size:10},{default:W((()=>[H(o,null,{default:W((()=>[H(n,{type:"primary",size:"small",onClick:le},{default:W((()=>t[16]||(t[16]=[G(" 从 FFlogs 生成 ")]))),_:1,__:[16]}),H(n,{type:"primary",size:"small",onClick:ce},{default:W((()=>t[17]||(t[17]=[G(" 从 在线文档 获取 ")]))),_:1,__:[17]}),H(n,{type:"primary",size:"small",onClick:we},{default:W((()=>t[18]||(t[18]=[G(" 手动编写 ")]))),_:1,__:[18]})])),_:1}),H(o,null,{default:W((()=>[H(n,{size:"small",onClick:he},{default:W((()=>t[19]||(t[19]=[G(" 导入字符串 ")]))),_:1,__:[19]}),H(n,{size:"small",class:"export",onClick:t[1]||(t[1]=e=>be(Y(m)))},{default:W((()=>t[20]||(t[20]=[G(" 导出全部 ")]))),_:1,__:[20]})])),_:1}),H(n,{size:"small",onClick:Ne},{default:W((()=>t[21]||(t[21]=[G(" 时间轴语法 ")]))),_:1,__:[21]}),H(n,{type:"success",size:"small",onClick:Oe},{default:W((()=>t[22]||(t[22]=[G(" 应用 ")]))),_:1,__:[22]})])),_:1}),H(s,null,{default:W((()=>[H(n,{color:"#a0d911",style:{color:"white"},size:"small",onClick:Pe},{default:W((()=>t[23]||(t[23]=[G(" 恢复至之前的时间轴 ")]))),_:1,__:[23]}),H(n,{color:"#626aef",style:{color:"white"},size:"small",onClick:t[2]||(t[2]=e=>V.value=!0)},{default:W((()=>t[24]||(t[24]=[G(" 设置 ")]))),_:1,__:[24]})])),_:1})])),_:1}),q("div",Fe,[H(N,{title:"编辑完成后，需手动点击「应用」按钮","show-icon":"",type:"info",closable:!1,class:"alert-item"}),H(N,{title:"当你误操作或数据与 ACT 悬浮窗中的数据不符，且尚未点击「应用」时，可点击「恢复至之前的时间轴」，则会恢复到当前 ACT 悬浮窗中保存的数据","show-icon":"",type:"warning",closable:!1,class:"alert-item"})])])),_:1}),H(fe,null,{default:W((()=>[H(J,{modelValue:Y(y),"onUpdate:modelValue":t[4]||(t[4]=e=>Z(y)?y.value=e:null),title:"从 FFlogs 生成时间轴",width:"80%","before-close":()=>y.value=!1},{default:W((()=>[H(O,{filters:Y(p),onClearCurrentlyTimeline:ge,onShowFFlogsToggle:t[3]||(t[3]=()=>y.value=!1),onNewTimeline:Y(u).newTimeline,onUpdateFilters:Y(u).updateFilters},null,8,["filters","onNewTimeline","onUpdateFilters"])])),_:1},8,["modelValue","before-close"]),se(H(oe,null,{default:W((()=>[q("div",Ve,[t[25]||(t[25]=q("span",null,"模拟时间：",-1)),H(L,{modelValue:Y(c),"onUpdate:modelValue":t[5]||(t[5]=e=>Z(c)?c.value=e:null),min:-30,max:1500,step:.1,"show-input":""},null,8,["modelValue"]),q("div",null,Q(Y(Be)),1)]),H(A,{class:"timeline-info"},{default:W((()=>[q("div",null,[q("p",xe,[t[26]||(t[26]=q("span",null,"显示名称：",-1)),H(X,{modelValue:Y(x).timeline.name,"onUpdate:modelValue":t[6]||(t[6]=e=>Y(x).timeline.name=e),class:"timeline-info-name"},null,8,["modelValue"])]),q("p",je,[t[27]||(t[27]=q("span",null,"限定地图：",-1)),H(ne,{modelValue:Y(x).timeline.condition.zoneId,"onUpdate:modelValue":t[7]||(t[7]=e=>Y(x).timeline.condition.zoneId=e),filterable:""},{default:W((()=>[(M(),D(ee,null,te(f,(e=>H(ie,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),64))])),_:1},8,["modelValue"])]),q("p",ke,[t[28]||(t[28]=q("span",null,"限定职业：",-1)),H(ne,{modelValue:Y(x).timeline.condition.jobs,"onUpdate:modelValue":t[8]||(t[8]=e=>Y(x).timeline.condition.jobs=e),multiple:"",required:"",placeholder:"职业","collapse-tags":"","collapse-tags-tooltip":""},{default:W((()=>[(M(!0),D(ee,null,te(Y(u).jobList,(e=>{var t;return M(),K(ie,{key:e,label:((null==(t=Y(E).nameToFullName(e))?void 0:t.cn)??e).replace("冒险者","全部职业"),value:e},null,8,["label","value"])})),128))])),_:1},8,["modelValue"])]),q("p",$e,[t[29]||(t[29]=q("span",null,"战斗来源：",-1)),H(X,{modelValue:Y(x).timeline.codeFight,"onUpdate:modelValue":t[9]||(t[9]=e=>Y(x).timeline.codeFight=e),disabled:""},null,8,["modelValue"])]),q("p",Ce,[t[30]||(t[30]=q("span",null,"创建时间：",-1)),H(X,{modelValue:Y(x).timeline.create,"onUpdate:modelValue":t[10]||(t[10]=e=>Y(x).timeline.create=e),disabled:""},null,8,["modelValue"])]),H(A,{"m-b-10px":""},{default:W((()=>[H(n,{span:12,class:"export",onClick:t[11]||(t[11]=e=>be([Y(x).timeline]))},{default:W((()=>t[31]||(t[31]=[G(" 单独导出 ")]))),_:1,__:[31]}),H(n,{type:"primary",span:12,onClick:t[12]||(t[12]=e=>{x.timeline.timeline=x.timeline.timeline.replaceAll(new RegExp("(?<=^|#\\s*)(?<time>[:：\\d.]+)","gm"),((e,t)=>/^\d+:\d+(?:\.\d{1,2})?$/.test(e.toString())?me.duration(`00:${e.toString()}`).as("seconds").toString():me.utc(1e3*Number.parseFloat(e.toString())).format("mm:ss.S")))})},{default:W((()=>t[32]||(t[32]=[G(" 切换时间 ")]))),_:1,__:[32]})])),_:1}),H(A,null,{default:W((()=>[H(n,{span:24,onClick:t[13]||(t[13]=e=>ge())},{default:W((()=>t[33]||(t[33]=[G(" 隐藏编辑界面 ")]))),_:1,__:[33]})])),_:1})]),q("div",Se,[H(X,{modelValue:Y(x).timeline.timeline,"onUpdate:modelValue":t[14]||(t[14]=e=>Y(x).timeline.timeline=e),class:"timeline-timeline-raw",type:"textarea",rows:12,wrap:"off",placeholder:"请键入时间轴文本",style:{"max-width":"569px"},onChange:t[15]||(t[15]=e=>P())},null,8,["modelValue"])]),q("div",Ie,[q("div",Ae,[H(ae,{config:Y(u).configValues,lines:Y(z),runtime:Y(c),"show-style":Y(u).showStyle},null,8,["config","lines","runtime","show-style"])])])])),_:1}),t[34]||(t[34]=q("br",null,null,-1))])),_:1,__:[34]},512),[[re,"空"!==Y(x).timeline.create]]),t[37]||(t[37]=q("br",null,null,-1)),Y(m).length>0?(M(),K(oe,{key:0},{default:W((()=>[H(ue,{data:Y(m),style:{width:"100%"},stripe:""},{default:W((()=>[H(de,{prop:"name",label:"名称"}),H(de,{prop:"conditon",label:"地图",sortable:""},{default:W((e=>{var t;return[G(Q(null==(t=f.find((t=>t.id===e.row.condition.zoneId)))?void 0:t.name),1)]})),_:1}),H(de,{prop:"conditon",label:"职业"},{default:W((e=>[G(Q(e.row.condition.jobs.map((e=>{var t;return(null==(t=Y(E).nameToFullName(e.toUpperCase()))?void 0:t.cn)??e})).join("、").replace("冒险者","全部职业")),1)])),_:1}),H(de,{fixed:"right",label:"操作",width:"150"},{default:W((e=>[H(n,{type:"primary",size:"small",onClick:t=>{return l=e.row,window.scrollTo({top:0,behavior:"smooth"}),x.timeline=l,void P();var l}},{default:W((()=>t[35]||(t[35]=[G(" 编辑 ")]))),_:2,__:[35]},1032,["onClick"]),H(n,{type:"danger",size:"small",onClick:t=>{return l=e.row,void h.confirm(`确定要删除「${l.name}」吗？`,"删除时间轴",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning"}).then((()=>{ge(),m.value.splice(m.value.findIndex((e=>e===l)),1)})).catch((()=>{}));var l}},{default:W((()=>t[36]||(t[36]=[G(" 删除 ")]))),_:2,__:[36]},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1})):R("",!0),0===Y(m).length?(M(),K(oe,{key:1},{default:W((()=>[H(pe,{description:"点击上方新建或导入一个时间轴吧~"})])),_:1})):R("",!0)])),_:1,__:[37]})])),_:1})}}}),[["__scopeId","data-v-3b5e3e96"]]);export{Be as default};
