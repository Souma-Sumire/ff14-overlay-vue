import{c as e,a as t,b as a,_ as o}from"./shared-common-9tgN7nPx.js";import{d as s,u as n,x as l,o as c,B as r,G as i,h as d,g as u,dy as p,K as m,a as b,c as h,f as w,b as f,F as g,z as v,t as y,e as C,y as S,n as P}from"./vendor-vue-MSvGQJWD.js";import{u as V,F as _,H as E,f as R}from"./shared-core-Do8QyWoI.js";import{N as k,a as U,r as N,k as D,l as O}from"./cactbot-DtpbXwrG.js";import{g as z,n as T,a2 as x,c as B,u as A,U as L,S as F,j as W,t as M,a3 as j,a4 as q,k as G,F as I,G as Y,h as Z,d as $}from"./vendor-element-plus-CsMNiL2J.js";const K={key:0,class:"mini-mode"},H={class:"zone-info"},J={class:"zone-name-wrapper"},Q={class:"zone-name"},X={class:"rules-status"},ee=["title"],te=["title"],ae=["title"],oe=["title"],se=["title"],ne={key:1,class:"obs-status-text"},le={class:"mode-switch-container"},ce={class:"mini-mode-placeholder",style:{visibility:"hidden","pointer-events":"none"}},re={class:"zone-info"},ie={class:"zone-name-wrapper"},de={class:"zone-name"},ue={class:"zone-type"},pe={class:"rules-status"},me={class:"rule-item"},be={class:"rule-item"},he={class:"rule-item"},we={class:"rule-item"},fe={class:"rule-item"},ge={key:1,class:"obs-status-text"},ve={class:"card-header"},ye={class:"header-actions"},Ce={key:1},Se={class:"card-header"},Pe={class:"status-info"},Ve={class:"button-container"},_e={class:"card-header"},Ee={class:"header-actions"},Re={class:"profile-info"},ke={class:"append-content-toggle"},Ue={class:"card-header"},Ne={class:"header-actions"},De={key:0,class:"current-type"},Oe=o(s({__name:"obs2",setup(o){const{t:s}=V(),{zoneType:Oe}=_(),ze=n("obs-zone-name",""),Te=n("obs-user-config",{host:4455,password:"",path:"",fileName:"%CCYY-%MM-%DD %hh-%mm-%ss",appendContentName:!0},localStorage,{mergeDefaults:!0}),xe=n("obs-user-content-setting",[]),Be=R(),Ae=l(1),Le=n("obs-has-used-before",!1),Fe=l(Le.value),We={inCombat:k.inCombat(),countdown:k.countdown(),countdownCancel:k.countdownCancel(),wipe:D.wipe},Me={enter:!1,countdown:!0,countdownCancel:!0,combatStart:!0,combatEnd:!0,wipe:!0,partyLength:1,customPath:""},je={enter:!1,countdown:!1,countdownCancel:!1,combatStart:!1,combatEnd:!1,wipe:!1,partyLength:1,customPath:""};const qe=new class{ws;status;connectingPromise=null;handleConnectionError=()=>{Ye("OBS connection error"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleConnectionClosed=()=>{Ye("OBS connection closed"),this.status.connecting=!1,this.status.connected=!1,this.status.recording=!1,this.status.outputActive=!1,this.status.outputPath=""};handleRecordStateChanged=e=>{this.status.connected=!0,this.status.recording="OBS_WEBSOCKET_OUTPUT_STARTED"===e.outputState,this.status.outputActive=e.outputActive,this.status.outputPath=e.outputPath||""};constructor(){this.ws=new p,this.status=m({connecting:!1,connected:!1,recording:!1,outputActive:!1,outputPath:""}),this.ws.on("ConnectionClosed",this.handleConnectionClosed),this.ws.on("ConnectionError",this.handleConnectionError),this.ws.on("RecordStateChanged",this.handleRecordStateChanged)}async connect(){return this.status.connected?Promise.resolve():(this.connectingPromise||(this.connectingPromise=(async()=>{if(Ye("Connecting to OBS"),Te.value.host){this.status.connecting=!0;try{await this.ws.connect(`ws://127.0.0.1:${Te.value.host}`,Te.value.password),Ye("Connected to OBS");const e=await this.ws.call("GetRecordStatus");if(this.status.recording=e.outputActive,this.status.outputActive=e.outputActive,this.status.connected=!0,!Te.value.path){const e=await this.ws.call("GetRecordDirectory");e.recordDirectory&&(Te.value.path=e.recordDirectory,xe.value.forEach(t=>{""===t.customPath&&(t.customPath=e.recordDirectory)}))}Te.value.fileName||(Te.value.fileName="%CCYY-%MM-%DD %hh-%mm-%ss"),Le.value=!0}catch(e){Ye("OBS connection failed",e),z({type:"error",message:s("obs2.connection failed"),duration:1e3})}finally{this.status.connecting=!1,this.connectingPromise=null}}else z({type:"error",message:s("obs2.host required"),duration:1e3})})()),this.connectingPromise)}disconnect(){Ye("Disconnecting from OBS"),this.ws.disconnect()}async startRecord(){Ye("Starting recording"),await this.setProfileParameter("start"),this.ws.call("StartRecord")}async stopRecord(){return Ye("Stopping recording"),await this.setProfileParameter("stop"),this.ws.call("StopRecord")}async splitRecord(){Ye("Splitting recording"),await this.setProfileParameter("split"),await this.ws.call("StopRecord"),setTimeout(()=>{this.startRecord()},1e3)}async setProfileParameter(e){const t=[{requestType:"SetProfileParameter",requestData:{parameterCategory:"AdvOut",parameterName:"RecFilePath",parameterValue:"stop"===e?Te.value.path:xe.value.find(e=>e.type===Oe.value)?.customPath||Te.value.path}},{requestType:"SetProfileParameter",requestData:{parameterCategory:"Output",parameterName:"FilenameFormatting",parameterValue:"stop"===e?Te.value.fileName:Te.value.fileName+(Te.value.appendContentName?` - ${ze.value}`:"")}}];return this.ws.callBatch(t)}},Ge=e=>{Ye("ChangeZone:",e),ze.value=e.zoneName,Ze("enter")},Ie=e=>{const t=e.rawLine;for(const a in We){if(We[a].exec(t)){const e=t.split("|");switch(a){case"inCombat":{const t="1"===e[O.InCombat.fields.inACTCombat],a="1"===e[O.InCombat.fields.inGameCombat];if(t&&a)return void Ze("combatStart");if(!t&&!a)return void Ze("combatEnd");break}case"countdown":Ze("countdown");break;case"countdownCancel":Ze("countdownCancel");break;case"wipe":Ze("wipe")}}}};function Ye(...e){Be.value}function Ze(e){Ye();const t=xe.value.find(e=>e.type===Oe.value);if(!t)throw new Error("Rule not found for zone type:"+Oe.value);if(!1===t.enter&&"enter"===e&&qe.status.recording)qe.stopRecord();else if(t[e])switch(Ye(Oe.value),e){case"enter":case"countdown":case"combatStart":if(Ae.value<t.partyLength)return;if(!qe.status.connected)return void qe.connect()?.then(()=>{qe.status.connected&&qe.startRecord()});if(!1===qe.status.recording)return void qe.startRecord();if(!0===qe.status.recording&&"combatStart"!==e)return void qe.splitRecord();break;case"countdownCancel":case"combatEnd":case"wipe":qe.status.recording&&qe.stopRecord()}else Ye()}const $e=e=>{Ye(),Ae.value=e.party.length||1};c(()=>{qe.connect(),U("ChangeZone",Ge),U("LogLine",Ie),U("PartyChanged",$e),function(){const e=["Savage","Extreme","Ultimate","Chaotic","OccultCrescent","DeepDungeonExtras","Default"];if(0===xe.value.length){xe.value=[...e.map(e=>({type:e,...Me})),...E.filter(t=>!e.includes(t)).map(e=>({type:e,...je}))];const t=xe.value.find(e=>"OccultCrescent"===e.type);t&&(t.partyLength=40)}else{xe.value=xe.value.filter(e=>E.includes(e.type));const t=E.filter(e=>!xe.value.some(t=>t.type===e)&&"Default"!==e).map(t=>e.includes(t)?{type:t,...Me}:{type:t,...je});xe.value.push(...t)}xe.value.sort((e,t)=>E.indexOf(e.type)-E.indexOf(t.type)),xe.value=xe.value.map(t=>({...e.includes(t.type)?Me:je,...t})),Te.value.path&&xe.value.forEach(e=>{""===e.customPath&&(e.customPath=Te.value.path)})}()}),r(()=>{qe.disconnect(),N("ChangeZone",Ge),N("LogLine",Ie)});const Ke=i(()=>xe.value.find(e=>e.type===Oe.value)),He=({row:e})=>e.type===Oe.value?"current-zone-row":"";return(o,n)=>{const l=T,c=x,r=t,i=a,p=W,m=F,V=L,_=M,E=B,R=q,k=j,U=G,N=Y,D=Z,O=$,z=I,Ae=A,Le=e;return b(),d(Le,null,{default:u(()=>[w(Fe)?(b(),h("div",K,[w(qe).status.connected?(b(),h(g,{key:0},[f("div",{class:v(["recording-dot",{"is-recording":w(qe).status.recording}])},null,2),f("div",H,[f("div",J,[f("div",Q,y(w(ze)||w(s)("obs2.Unknown")),1)])]),f("div",X,[f("span",{class:v(["rule-item",{active:w(Ke)?.enter}]),title:w(s)("obs2.Enter Zone")},y(w(s)("obs2.EnterShort")),11,ee),f("span",{class:v(["rule-item",{active:w(Ke)?.countdown}]),title:w(s)("obs2.CountDown")},y(w(s)("obs2.CountdownShort")),11,te),f("span",{class:v(["rule-item",{active:w(Ke)?.combatStart}]),title:w(s)("obs2.CombatStart")},y(w(s)("obs2.CombatStartShort")),11,ae),f("span",{class:v(["rule-item",{active:w(Ke)?.combatEnd}]),title:w(s)("obs2.CombatEnd")},y(w(s)("obs2.CombatEndShort")),11,oe),f("span",{class:v(["rule-item",{active:w(Ke)?.wipe}]),title:w(s)("obs2.Wipe")},y(w(s)("obs2.WipeShort")),11,se)])],64)):(b(),h("div",ne,y(w(s)("obs2.OBS Not Connected")),1)),f("button",{class:"settings-btn",onClick:n[0]||(n[0]=e=>Fe.value=!1),title:"展开详情"}," ⚙ ")])):(b(),h(g,{key:1},[f("div",le,[f("div",ce,[w(qe).status.connected?(b(),h(g,{key:0},[n[13]||(n[13]=f("div",{class:"recording-dot"},null,-1)),f("div",re,[f("div",ie,[f("div",de,y(w(ze)||w(s)("obs2.Unknown")),1)]),f("div",ue,y(w(Oe)?`（${w(s)(`obs2.${w(Oe)}`)}）`:""),1)]),f("div",pe,[f("span",me,y(w(s)("obs2.EnterShort")),1),f("span",be,y(w(s)("obs2.CountdownShort")),1),f("span",he,y(w(s)("obs2.CombatStartShort")),1),f("span",we,y(w(s)("obs2.CombatEndShort")),1),f("span",fe,y(w(s)("obs2.WipeShort")),1)])],64)):(b(),h("div",ge,y(w(s)("obs2.OBS Not Connected")),1))]),C(l,{size:"small",onClick:n[1]||(n[1]=e=>Fe.value=!0),class:"mini-toggle-btn"},{default:u(()=>[S(y(w(s)("obs2.Mini Mode")),1)]),_:1})]),C(c,{title:w(s)("obs2.size warning"),type:"warning",center:"","show-icon":"",closable:!1,class:"window-size-warning"},null,8,["title"]),C(E,{class:"obs-container"},{default:u(()=>[C(Ae,null,{default:u(()=>[w(qe).status.connected?(b(),h("div",Ce,[w(Be)?(b(),d(E,{key:0,class:"status-card"},{header:u(()=>[f("div",Se,[f("span",null,y(w(s)("obs2.Connection Status")),1),C(l,{type:"danger",size:"small",class:"disconnect-button",onClick:n[5]||(n[5]=e=>w(qe).disconnect())},{default:u(()=>[S(y(w(s)("obs2.Disconnect")),1)]),_:1})])]),default:u(()=>[f("div",Pe,[C(k,{direction:"vertical",column:1,border:""},{default:u(()=>[C(R,{label:w(s)("obs2.Recording")},{default:u(()=>[S(y(w(qe).status.recording?w(s)("obs2.Yes"):w(s)("obs2.No")),1)]),_:1},8,["label"]),C(R,{label:w(s)("obs2.Output Path")},{default:u(()=>[S(y(w(qe).status.outputPath||w(s)("obs2.None")),1)]),_:1},8,["label"])]),_:1})]),f("div",Ve,[C(l,{disabled:!w(qe).status.connected||w(qe).status.recording,type:"primary",onClick:n[6]||(n[6]=e=>w(qe).startRecord())},{default:u(()=>[S(y(w(s)("obs2.Start Record")),1)]),_:1},8,["disabled"]),C(l,{disabled:!w(qe).status.connected||!w(qe).status.recording,type:"danger",onClick:n[7]||(n[7]=e=>w(qe).stopRecord())},{default:u(()=>[S(y(w(s)("obs2.Stop Record")),1)]),_:1},8,["disabled"]),C(l,{disabled:!w(qe).status.connected||!w(qe).status.recording,type:"warning",onClick:n[8]||(n[8]=e=>w(qe).splitRecord())},{default:u(()=>[S(y(w(s)("obs2.Split Record")),1)]),_:1},8,["disabled"]),C(l,{type:"primary",onClick:n[9]||(n[9]=e=>w(qe).setProfileParameter("stop"))},{default:u(()=>[S(y(w(s)("obs2.Set Recording Name")),1)]),_:1})])]),_:1})):P("",!0),C(E,{class:"profile-card"},{header:u(()=>[f("div",_e,[f("span",null,y(w(s)("obs2.Recording Profile")),1),f("div",Ee,[C(r,{"storage-key":"obs-2-theme"}),C(i)])])]),default:u(()=>[f("div",Re,[C(V,{"label-position":"top",class:"content-form"},{default:u(()=>[C(m,{label:w(s)("obs2.Record Default Path")},{default:u(()=>[C(p,{modelValue:w(Te).path,"onUpdate:modelValue":n[10]||(n[10]=e=>w(Te).path=e),placeholder:w(s)("obs2.recordPathPlaceholder")},null,8,["modelValue","placeholder"]),C(c,{description:w(s)("obs2.filePathExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),C(m,{label:w(s)("obs2.Record File Name")},{default:u(()=>[C(p,{modelValue:w(Te).fileName,"onUpdate:modelValue":n[11]||(n[11]=e=>w(Te).fileName=e),placeholder:w(s)("obs2.recordFileNamePlaceholder")},null,8,["modelValue","placeholder"]),C(c,{description:w(s)("obs2.fileNameExplanation"),type:"info","show-icon":"",closable:!1},null,8,["description"])]),_:1},8,["label"]),C(m,null,{default:u(()=>[f("div",ke,[f("span",null,y(w(s)("obs2.Append Content Name")),1),C(U,{modelValue:w(Te).appendContentName,"onUpdate:modelValue":n[12]||(n[12]=e=>w(Te).appendContentName=e)},null,8,["modelValue"])])]),_:1})]),_:1})])]),_:1}),C(c,{class:"instruction-alert",type:"info",description:w(s)("obs2.IMETutorial"),closable:!1,"show-icon":""},null,8,["description"]),C(E,{class:"table-card"},{header:u(()=>[f("div",Ue,[f("span",null,y(w(s)("obs2.User Content Settings")),1),f("div",Ne,[C(r,{"storage-key":"obs-2-theme"}),C(i)])])]),default:u(()=>[C(z,{data:w(xe),border:!0,stripe:"","row-class-name":He},{default:u(()=>[C(N,{prop:"type",label:w(s)("obs2.Type"),width:"100",fixed:"",align:"center"},{default:u(e=>[w(Oe)===e.row.type?(b(),h("span",De,[S(y(w(s)("obs2.Current")),1),n[14]||(n[14]=f("br",null,null,-1))])):P("",!0),f("span",null,y(e.row.type?w(s)(`obs2.${e.row.type}`):""),1)]),_:1},8,["label"]),C(N,{label:w(s)("obs2.Start When"),align:"center"},{default:u(()=>[C(N,{label:w(s)("obs2.When Party"),align:"center",width:"70"},{default:u(e=>[C(D,{modelValue:e.row.partyLength,"onUpdate:modelValue":t=>e.row.partyLength=t,min:1,max:48,style:{width:"40px"},size:"small",controls:!1},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),C(N,{prop:"enter",label:w(s)("obs2.Enter Zone"),align:"center",width:"50"},{default:u(e=>[C(O,{modelValue:e.row.enter,"onUpdate:modelValue":t=>e.row.enter=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),C(N,{prop:"countdown",label:w(s)("obs2.CountDown"),align:"center",width:"55"},{default:u(e=>[C(O,{modelValue:e.row.countdown,"onUpdate:modelValue":t=>e.row.countdown=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),C(N,{prop:"combatStart",label:w(s)("obs2.CombatStart"),align:"center",width:"55"},{default:u(e=>[C(O,{modelValue:e.row.combatStart,"onUpdate:modelValue":t=>e.row.combatStart=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),C(N,{label:w(s)("obs2.End When"),align:"center"},{default:u(()=>[C(N,{prop:"combatEnd",label:w(s)("obs2.CombatEnd"),align:"center",width:"55"},{default:u(e=>[C(O,{modelValue:e.row.combatEnd,"onUpdate:modelValue":t=>e.row.combatEnd=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),C(N,{prop:"wipe",label:w(s)("obs2.Wipe"),align:"center",width:"50"},{default:u(e=>[C(O,{modelValue:e.row.wipe,"onUpdate:modelValue":t=>e.row.wipe=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),C(N,{prop:"countdown",label:w(s)("obs2.CountDownCancel"),align:"center",width:"60"},{default:u(e=>[C(O,{modelValue:e.row.countdownCancel,"onUpdate:modelValue":t=>e.row.countdownCancel=t},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["label"]),C(N,{label:w(s)("obs2.Custom Path"),align:"left","min-width":"200"},{default:u(e=>[C(p,{modelValue:e.row.customPath,"onUpdate:modelValue":t=>e.row.customPath=t,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1})])):(b(),d(E,{key:0,class:"connection-card"},{header:u(()=>[f("div",ve,[f("span",null,y(w(s)("obs2.Connect to OBS")),1),f("div",ye,[C(r,{"storage-key":"obs-2-theme"}),C(i)])])]),default:u(()=>[C(V,{"label-position":"top",class:"connection-form"},{default:u(()=>[C(m,{label:w(s)("obs2.Port")},{default:u(()=>[C(p,{modelValue:w(Te).host,"onUpdate:modelValue":n[2]||(n[2]=e=>w(Te).host=e),placeholder:w(s)("obs2.portPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),C(m,{label:w(s)("obs2.Password")},{default:u(()=>[C(p,{modelValue:w(Te).password,"onUpdate:modelValue":n[3]||(n[3]=e=>w(Te).password=e),placeholder:w(s)("obs2.passwordPlaceholder"),type:"password"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),C(m,null,{default:u(()=>[C(l,{type:"primary",class:"connect-button",loading:w(qe).status.connecting,disabled:w(qe).status.connecting||!w(Te).host,onClick:n[4]||(n[4]=e=>w(qe).connect())},{default:u(()=>[S(y(w(qe).status.connecting?w(s)("obs2.Connecting"):w(s)("obs2.Connect")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1}),C(_,null,{default:u(()=>[S(y(w(s)("obs2.Instructions")),1)]),_:1}),C(c,{class:"instruction-alert",type:"info",description:w(s)("obs2.obsTutorial"),closable:!1,"show-icon":""},null,8,["description"]),C(c,{class:"instruction-alert",type:"info",description:w(s)("obs2.inputTutorial"),closable:!1,"show-icon":""},null,8,["description"]),C(c,{class:"instruction-alert",type:"info",description:w(s)("obs2.firewallTutorial"),closable:!1,"show-icon":""},null,8,["description"])]),_:1}))]),_:1})]),_:1})],64))]),_:1})}}}),[["__scopeId","data-v-6f40bc18"]]);export{Oe as default};
