import{e,f as a,h as l,i as t,j as o,p as n,M as i,k as s,Z as r,l as c,n as d}from"./shared-core-3WpGeK2J.js";import{M as u,_ as m}from"./WaymarkDisplay.vue_vue_type_script_setup_true_lang-CrGbkmQi.js";import{h as p,G as b,g as y,a as f,f as k,E as z,u as w,x as h,o as g,w as M,bP as _,p as v,v as C,e as $,d as D,b as x,c as V,F as E,r as Z,y as I,t as P,n as U,s as A,i as T}from"./vendor-vue-i6lpFrx4.js";import{a as N,b as j,_ as S}from"./shared-common-BTkSSeU7.js";import{o as O,p as H,q as L,n as W,r as X,t as B,u as J,v as Y,w as F,c as q,j as G,x as K,y as R,A as Q,B as ee,C as ae,D as le,F as te,G as oe,k as ne,h as ie,H as se,I as re,d as ce,J as de,K as ue,g as me}from"./vendor-element-plus-C8e3lHeC.js";import{a as pe}from"./cactbot-DtpbXwrG.js";import{_ as be}from"./zoneSelecter-DMFUDvnD.js";import"./map-DW4z5uTS.js";const ye=p({__name:"MarksDiv",props:{macro:{type:Object,required:!0},size:{type:Number,default:180}},setup(a){const l=a,t=e(),o=["A","B","C","D","1","2","3","4"],n=b(()=>{if(!l.macro?.Place)return[];const e=l.macro.Place;return Object.keys(e).map((a,l)=>{const t=e[a];return{key:a,label:o[l]??a,x:Number(t.X),z:Number(t.Z),active:t.Active}})});return(e,l)=>(f(),y(u,{"map-id":Number(k(t).selectZone),"force-territory-type":Number(k(t).selectZone),markers:n.value,size:a.size},null,8,["map-id","force-territory-type","markers","size"]))}}),fe={class:"header-row"},ke={class:"fast-entrance-group"},ze={class:"header-row"},we={class:"badge-group"},he={key:0,class:"subtle-badge from-user"},ge={key:1,class:"subtle-badge from-native"},Me=["innerHTML"],_e={key:0},ve={key:0,class:"macro-content"},Ce={key:1},$e={style:{"margin-bottom":"10px"}},De={class:"dialog-footer"},xe=S(p({__name:"zoneMacro",setup(u){const{t:p}=z(),S=a(),xe=e();w("zoneMacroHideOnStartup",h(!1)).value&&(xe.show=!1),S.value||l({allowClose:!0,addWsParam:!0});const Ve=b(()=>xe.fastEntrance.map(e=>({text:t(e.text),value:e.value}))),Ee=h(null),Ze=h(null),Ie=h(!1),Pe=h(!0),Ue=h([]),Ae=b(()=>o(Number(xe.selectZone))),Te=b(()=>{if(!Ze.value)return[];let e=Ze.value.wayMarks.map((e,a)=>({mark:e,index:a})).filter(e=>0!==e.mark.regionID);return Pe.value&&(e=e.filter(e=>e.mark.regionID===Ae.value)),e});async function Ne(e){const a=e.target,l=a.files?.[0];if(l)try{Ze.value=await n(await l.arrayBuffer()),Ie.value=!0,Pe.value=!1}catch(t){me.error("Parse failed: "+t)}finally{a.value=""}}function je(e){Ue.value=e}function Se(){Ue.value.forEach(({mark:e})=>{const a={};i.forEach(l=>{const t=e[l.key];t&&(a[l.key]={X:t.x/1e3,Y:t.y/1e3,Z:t.z/1e3,Active:(e.enableFlag&l.bit)>0})}),xe.newPlace({...a,Name:`Imported ${new Date(1e3*e.timestamp).toLocaleString()}`,MapID:e.regionID,Editable:!1})}),Ie.value=!1,me.success(p("zoneMacro.importSelected",[Ue.value.length]))}function Oe(e){const a=s(e);if(!a)return"Unknown";const l=r[a];return l?c(l.name):"Unknown"}function He(e,a){return Oe(e.mark.regionID).localeCompare(Oe(a.mark.regionID))}return g(()=>{pe("ChangeZone",xe.handleChangeZone),M(_(xe,"selectZone"),()=>{const e=(xe.data.zoneId[xe.selectZone]?.map(e=>{const{Editable:a,...l}=e;return l})||d.zoneId[xe.selectZone]||[]).filter(e=>e.Deletability),a=d.zoneId[xe.selectZone]??[];xe.data.zoneId[xe.selectZone]=[...a,...e]},{immediate:!0})}),(e,a)=>{const l=W,t=L,o=B,n=N,i=j,s=H,r=F,c=G,d=K,u=ne,p=oe,b=ie,z=te,w=Y,h=ye,g=q,M=J,_=ce,S=de,me=re,pe=O;return v((f(),y(pe,{class:"elcontainer"},{default:$(()=>[D(s,{height:"auto",class:"elheader"},{default:$(()=>[x("div",fe,[D(t,{content:"定位到当前区域",placement:"bottom"},{default:$(()=>[D(l,{type:"primary",size:"small",icon:k(X),circle:"",onClick:a[0]||(a[0]=e=>k(xe).positioning())},null,8,["icon"])]),_:1}),D(be,{selectZone:k(xe).selectZone,"onUpdate:selectZone":a[1]||(a[1]=e=>k(xe).selectZone=e)},null,8,["selectZone"]),x("div",ke,[(f(!0),V(E,null,Z(k(Ve),(e,a)=>(f(),y(l,{key:a,plain:"",size:"small",onClick:a=>k(xe).selectZone=e.value},{default:$(()=>[I(P(e.text),1)]),_:2},1032,["onClick"]))),128))])]),x("div",ze,[D(l,{type:"success",size:"small",onClick:a[2]||(a[2]=e=>k(xe).newMacro())},{default:$(()=>[I(P(e.$t("zoneMacro.newMacro")),1)]),_:1}),D(l,{type:"primary",size:"small",onClick:a[3]||(a[3]=e=>k(xe).newPlace())},{default:$(()=>[I(P(e.$t("zoneMacro.newWaymark")),1)]),_:1}),D(o,{direction:"vertical",class:"toolbar-divider"}),D(l,{size:"small",color:"#BA5783",onClick:a[4]||(a[4]=e=>k(xe).importPPJSON())},{default:$(()=>[I(P(e.$t("zoneMacro.importPP")),1)]),_:1}),D(l,{size:"small",color:"#9D5C63",onClick:a[5]||(a[5]=e=>k(Ee)?.click())},{default:$(()=>[I(P(e.$t("zoneMacro.importUISAVE")),1)]),_:1}),D(o,{direction:"vertical",class:"toolbar-divider"}),D(l,{type:"warning",size:"small",onClick:a[6]||(a[6]=e=>k(xe).resetZone())},{default:$(()=>[I(P(e.$t("zoneMacro.resetZone")),1)]),_:1}),D(l,{type:"danger",size:"small",onClick:a[7]||(a[7]=e=>k(xe).resetAllData())},{default:$(()=>[I(P(e.$t("zoneMacro.resetAll")),1)]),_:1}),D(o,{direction:"vertical",class:"toolbar-divider"}),D(n,{"storage-key":"zone-macro-theme"}),D(i)])]),_:1}),D(M,{class:"main-content"},{default:$(()=>[D(w,{wrap:"",alignment:"flex-start",class:"macro-grid"},{default:$(()=>[void 0===k(xe).data.zoneId[k(xe).selectZone]||0===k(xe).data.zoneId[k(xe).selectZone].length?(f(),y(r,{key:0,"w-100":"","image-size":150,description:e.$t("zoneMacro.noDataTip")},null,8,["description"])):(f(!0),V(E,{key:1},Z(k(xe).data.zoneId[k(xe).selectZone],(a,t)=>(f(),y(g,{key:t,shadow:"hover",class:"main-box-card"},{default:$(()=>[x("div",we,[a.Deletability?(f(),V("span",he,P(e.$t("zoneMacro.badgeUser")),1)):(f(),V("span",ge,P(e.$t("zoneMacro.badgeNative")),1))]),v(x("p",{class:"macro-title",innerHTML:a.Name},null,8,Me),[[C,!a.Editable]]),v(D(c,{modelValue:a.Name,"onUpdate:modelValue":e=>a.Name=e,size:"small",placeholder:e.$t("zoneMacro.placeholderMacroTitle"),style:{width:"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[C,a.Editable]]),"Text"in a?(f(),V("div",_e,[a.Editable?U("",!0):(f(),V("article",ve,[(f(!0),V(E,null,Z(a.Text?.split("\n"),(e,a)=>(f(),V("div",{key:a,class:"macroText"},P(e),1))),128))])),v(D(c,{modelValue:a.Text,"onUpdate:modelValue":e=>a.Text=e,type:"textarea",size:"small",placeholder:e.$t("zoneMacro.placeholderMacroText"),wrap:"off",autosize:{minRows:3},style:{width:"450px","max-width":"calc(100% - 2em)"}},null,8,["modelValue","onUpdate:modelValue","placeholder"]),[[C,a.Editable]]),a.Editable?U("",!0):(f(),y(d,{key:1,class:"buttonArea",style:A({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:$(()=>[a.Deletability?(f(),y(l,{key:0,icon:k(R),size:"small",onClick:e=>k(xe).editMacroMacro(a)},null,8,["icon","onClick"])):U("",!0),D(l,{icon:k(Q),type:"info",size:"small",onClick:e=>k(xe).sendMacroEcho(a.Text)},{default:$(()=>[I(P(e.$t("zoneMacro.sendEcho")),1)]),_:1},8,["icon","onClick"]),D(l,{icon:k(ee),type:"primary",size:"small",onClick:e=>k(xe).sendMacroParty(a.Text)},{default:$(()=>[I(P(e.$t("zoneMacro.sendParty")),1)]),_:1},8,["icon","onClick"])]),_:2},1032,["style"])),a.Editable?(f(),y(d,{key:2,class:"buttonAreaEditing"},{default:$(()=>[D(l,{type:"success",size:"small",icon:k(ae),onClick:e=>k(xe).submitMacroMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(f(),y(l,{key:0,type:"danger",size:"small",icon:k(le),onClick:e=>k(xe).deleteMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):U("",!0)]),_:2},1024)):U("",!0)])):U("",!0),"Place"in a?(f(),V("div",Ce,[v(D(w,null,{default:$(()=>[D(z,{data:Object.entries(a.Place).filter(e=>["A","B","C","D","One","Two","Three","Four"].includes(e[0])),border:"",size:"small"},{default:$(()=>[D(p,{align:"center",label:e.$t("zoneMacro.tableActive"),width:"50"},{default:$(e=>[D(u,{modelValue:e.row[1].Active,"onUpdate:modelValue":a=>e.row[1].Active=a,size:"small",style:{"--el-switch-on-color":"#13ce66"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableMark"),width:"50"},{default:$(e=>[x("span",null,P(e.row[0]),1)]),_:1},8,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableX"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.X),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].X,"onUpdate:modelValue":a=>e.row[1].X=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableZ"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.Z),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].Z,"onUpdate:modelValue":a=>e.row[1].Z=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"]),D(p,{align:"center",label:e.$t("zoneMacro.tableY"),width:"120"},{default:$(e=>[v(x("span",null,P(e.row.Y),513),[[C,!a.Editable]]),v(D(b,{modelValue:e.row[1].Y,"onUpdate:modelValue":a=>e.row[1].Y=a,step:.1,precision:2,"controls-position":"right",size:"small",style:{width:"8.5em"}},null,8,["modelValue","onUpdate:modelValue"]),[[C,a.Editable]])]),_:2},1032,["label"])]),_:2},1032,["data"])]),_:2},1536),[[C,a.Editable]]),D(w,null,{default:$(()=>[(f(),y(h,{key:JSON.stringify(a.Place)+a.Name+t,macro:a,"zone-id":k(xe).selectZone},null,8,["macro","zone-id"]))]),_:2},1024),a.Editable?U("",!0):(f(),y(d,{key:0,class:"buttonArea",style:A({maxHeight:a.Editable?"100px":null,opacity:a.Editable?1:null})},{default:$(()=>[D(l,{type:"primary",size:"small",onClick:e=>k(xe).doLocalWayMark(a.Place)},{default:$(()=>[I(P(e.$t("zoneMacro.doLocal")),1)]),_:1},8,["onClick"]),D(l,{type:"primary",size:"small",onClick:e=>k(xe).doPartyWayMark(a.Place)},{default:$(()=>[I(P(e.$t("zoneMacro.doPublic")),1)]),_:1},8,["onClick"]),D(l,{icon:k(se),size:"small",class:"export",onClick:e=>k(xe).exportWaymarksJson(a)},null,8,["icon","onClick"]),a.Deletability?(f(),y(l,{key:0,icon:k(R),size:"small",onClick:e=>k(xe).editMacroPlace(a)},null,8,["icon","onClick"])):U("",!0)]),_:2},1032,["style"])),a.Editable?(f(),y(d,{key:1,class:"buttonAreaEditing"},{default:$(()=>[D(l,{type:"success",size:"small",icon:k(ae),onClick:e=>k(xe).submitMacroPlace(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDone")),1)]),_:1},8,["icon","onClick"]),a.Deletability?(f(),y(l,{key:0,type:"danger",size:"small",icon:k(le),onClick:e=>k(xe).deleteMacro(a)},{default:$(()=>[I(P(e.$t("zoneMacro.buttonDelete")),1)]),_:1},8,["icon","onClick"])):U("",!0)]),_:2},1024)):U("",!0)])):U("",!0)]),_:2},1024))),128))]),_:1})]),_:1}),x("input",{ref_key:"fileInput",ref:Ee,type:"file",accept:".DAT,.dat",style:{display:"none"},onChange:Ne},null,544),D(me,{modelValue:k(Ie),"onUpdate:modelValue":a[10]||(a[10]=e=>T(Ie)?Ie.value=e:null),title:e.$t("zoneMacro.uisaveDialogTitle"),width:"800px"},{footer:$(()=>[x("div",De,[D(l,{onClick:a[9]||(a[9]=e=>Ie.value=!1)},{default:$(()=>[I(P(e.$t("zoneMacro.cancel")),1)]),_:1}),D(l,{type:"primary",onClick:Se,disabled:0===k(Ue).length},{default:$(()=>[I(P(e.$t("zoneMacro.importSelected",[k(Ue).length])),1)]),_:1},8,["disabled"])])]),default:$(()=>[x("div",$e,[D(_,{modelValue:k(Pe),"onUpdate:modelValue":a[8]||(a[8]=e=>T(Pe)?Pe.value=e:null)},{default:$(()=>[I(P(e.$t("zoneMacro.onlyCurrentZone",[k(Ae),Oe(k(Ae))])),1)]),_:1},8,["modelValue"])]),D(z,{data:k(Te),style:{width:"100%"},height:"400",onSelectionChange:je},{default:$(()=>[D(p,{type:"selection",width:"40"}),D(p,{label:e.$t("zoneMacro.slot"),width:"80",align:"center",sortable:"","sort-by":"index"},{default:$(({row:e})=>[I(P(e.index+1),1)]),_:1},8,["label"]),D(p,{prop:"mark.regionID",label:e.$t("zoneMacro.mapID"),width:"100",sortable:"","sort-by":"mark.regionID"},{default:$(({row:e})=>[I(P(e.mark.regionID),1)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.mapName"),sortable:"","sort-method":He,"min-width":"150"},{default:$(({row:e})=>[I(P(Oe(e.mark.regionID)),1)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.preview"),width:"70",align:"center"},{default:$(({row:e})=>[D(S,{placement:"left",width:280,trigger:"hover"},{reference:$(()=>[D(l,{icon:k(ue),circle:"",size:"small"},null,8,["icon"])]),default:$(()=>[D(m,{waymark:e.mark,size:250},null,8,["waymark"])]),_:2},1024)]),_:1},8,["label"]),D(p,{label:e.$t("zoneMacro.timestamp"),width:"160",sortable:"","sort-by":"mark.timestamp"},{default:$(({row:e})=>[I(P(new Date(1e3*e.mark.timestamp).toLocaleString()),1)]),_:1},8,["label"])]),_:1},8,["data"])]),_:1},8,["modelValue","title"])]),_:1},512)),[[C,k(xe).show]])}}}),[["__scopeId","data-v-5efc08e1"]]);export{xe as default};
