import{_ as e}from"./ActWrapper-CbcL5jAX.js";import{u as t,p as i,_ as o}from"./TimelineShow-CwrmSBsO.js";import{d as n,f as l,r as a,g as s,h as c,i as m,E as r,k as u,w as d,o as p,a as f,c as g,G as y,b as v,u as T,F as b,m as h,s as j,e as k,t as C,Q as w,K as x}from"./index-BbxLgENd.js";import{u as A}from"./useDev-D9oVSqhX.js";import{t as _}from"./tts-BkZGqxam.js";import{c as O,a as S}from"./overlay_plugin_api-DHbPkDtN.js";import{_ as I}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./el-card-ueHS-Ymd.js";import"./useDemo-DNfUh66e.js";import"./status-DO8_dJa3.js";import"./regexes-Blkj7yOl.js";import"./util-BSI8OlRX.js";import"./chineseToIcon-xFdmTerz.js";import"./xivapi-a6oZXlzI.js";const V={id:"wrapper"},B={key:0,class:"optionalTimelines"},E=["onClick"],D={key:7,style:{color:"white","background-color":"black"}},L=I(n({__name:"timeline",setup(n){const I=t(),L=l({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),N=a(0),$=a(0-I.configValues.preBattle),z=a(0);let F=!1;const G=s("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),J=A(),K=c(()=>L.loadedTimeline.filter(e=>e.sync)),P=c(()=>L.loadedTimeline.filter(e=>e.tts));function W(){q(),L.loadedTimeline.length=0,L.optionalTimeline.length=0;const e=I.getTimeline(G.value);1===e.length?Z(e[0]):e.length>1&&(L.optionalTimeline=e,Z(e[0]))}async function Z(e,t=!0){L.selectedOptionalTimeline=e,t&&q(),F=!1,e?.timeline&&(L.loadedTimeline=await i(e.timeline),L.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{F=!0},1e3)}function q(){N.value=0,$.value=0-I.configValues.preBattle,z.value=0;for(const e of L.loadedTimeline)e.alertAlready=!1;for(const e of K.value)e.syncAlready=!1}function M(e,t=!0){t&&(F=!1,setTimeout(()=>{F=!0},1e3)),$.value=0,z.value=0,N.value=(new Date).getTime()+1e3*e,P.value.forEach(e=>{e.alertAlready=!1}),Q()}function Q(){if(0===N.value)return;$.value=((new Date).getTime()-N.value+z.value)/1e3;const e=P.value.find(e=>!e.alertAlready&&e.time-I.configValues.ttsAdvance<=$.value);e&&(e.alertAlready=!0,e.tts&&function(e,t=!1){if(!e)return;(F||t)&&_(e)}(e.tts)),requestAnimationFrame(Q)}function R(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)M(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:400000(?:0F|10|03)/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))q();else{const e=K.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&$.value>=e.time-e.windowBefore&&$.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,U(e.jump||e.time))}}}function U(e){0===N.value&&M(0,!1),z.value+=1e3*(e-$.value),P.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}m(()=>{S("onLogEvent",R),S("onPlayerChangedEvent",Y),S("ChangeZone",H),S("BroadcastMessage",te),S("onInCombatChangedEvent",ie),I.loadTimelineSettings(),r({message:`${I.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),W(),ee("hello")});const Y=e=>{G.value.jobs[0]!==e.detail.job&&(G.value.jobs[0]=e.detail.job,W())},H=e=>{G.value.zoneId=String(e.zoneID),W()};function X(){r.closeAll(),r({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){O({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>I.jobList.indexOf(e)-I.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");I.allTimelines=t.allTimelines,I.configValues=t.configValues,I.showStyle=t.showStyle,I.saveTimelineSettings(),r.closeAll(),r({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),W(),ee("success")}"get"===e.msg.type&&ee("post",I.$state)}};function ie(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===N.value?M(0):e.detail.inGameCombat||e.detail.inACTCombat||q()}return(t,i)=>{const n=w,l=o,a=e;return p(),u(a,null,{default:d(()=>[f("div",V,[T(L).optionalTimeline.length&&T($)<=-T(I).configValues.preBattle?(p(),g("ul",B,[i[5]||(i[5]=f("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(p(!0),g(b,null,h(T(L).optionalTimeline,(e,t)=>(p(),g("li",{key:t,class:j(T(L).selectedOptionalTimeline===e?"active":""),onClick:t=>{Z(e)}},[k(C(e.name)+" ",1),T(L).selectedOptionalTimeline===e?(p(),u(n,{key:0},{default:d(()=>[v(T(x))]),_:1})):y("",!0)],10,E))),128))])):y("",!0),v(l,{config:T(I).configValues,lines:T(L).loadedTimeline,runtime:T($),"show-style":T(I).showStyle},null,8,["config","lines","runtime","show-style"]),T(J)?(p(),g("button",{key:1,onClick:i[0]||(i[0]=e=>M(30))}," 开始从-30 ")):y("",!0),T(J)?(p(),g("button",{key:2,onClick:i[1]||(i[1]=e=>M(0))}," 开始从0 ")):y("",!0),T(J)?(p(),g("button",{key:3,onClick:i[2]||(i[2]=e=>q())}," 团灭 ")):y("",!0),T(J)?(p(),g("button",{key:4,onClick:i[3]||(i[3]=e=>{U(1e3)})}," 跳转1000测试 ")):y("",!0),T(J)?(p(),g("button",{key:5,onClick:i[4]||(i[4]=e=>T(_)("今天天气真不错"))}," TTS测试 ")):y("",!0),T(J)?(p(),g("button",{key:6,onClick:X}," 弹窗测试 ")):y("",!0),T(J)?(p(),g("span",D,C(T($)),1)):y("",!0)])]),_:1})}}}),[["__scopeId","data-v-68379865"]]);export{L as default};
