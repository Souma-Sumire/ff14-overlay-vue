import{_ as e}from"./ActWrapper-2ilnQFnh.js";import{d as a,r as l,bb as t,g as o,h as n,bc as s,j as i,w as r,o as u,a as v,k as c,c as f,z as h,u as d,t as g,p as m,v as p,b as w}from"./index-D4X-GpI9.js";import{E as P}from"./el-alert-C4fBsPyN.js";import{u as y}from"./useZone-C3KBZTjG.js";import{N as b}from"./netregexes-RPvCCaeG.js";import{a as T,r as x,c as M}from"./overlay_plugin_api-DHbPkDtN.js";import{_ as k}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./el-card-DN1RRSQa.js";import"./useDev-C0UWoi_C.js";import"./index-BnW4b3jw.js";import"./useDemo-_p00ZrPO.js";import"./index-7GiecrC5.js";import"./zoneInfo-7Z04Y0Eq.js";import"./zone_info-BK1oa_54.js";import"./content_type-uhloenTS.js";import"./regexes-BKeG-dSP.js";const I={class:"radar-container"},j={class:"radar-wrapper"},S={key:0},_=["disabled"],C=["disabled"],N={class:"target-header"},z={key:0,class:"target-name"},D={class:"radar-canvas-container"},L=["width","height"],W=k(a({__name:"radar",setup(a){const k=l(""),W=l([]),Y=l(0),H=l(""),X=l([]),E={echo:b.echo({line:"find\\s*(?<target>.+)"})},R=t("canvas");let $=null;const O=l(window.devicePixelRatio||1),A=l(Math.min(window.innerWidth,window.innerHeight)-80),B=o(()=>A.value/2-20),{zoneType:F}=y(),q=l("single"),J="#0f0",Z="#060",G="#0f0",K="#ff0",Q="#f00",U="#fff",V="#fff",ee=18,ae=3,le=2,te=6,oe=o(()=>A.value/2),ne=o(()=>A.value/2);function se(e,a,l){const t=e.PosX-a.PosX,o=e.PosY-a.PosY;let n=oe.value+t/l,s=ne.value+o/l;const i=Math.hypot(n-oe.value,s-ne.value);if(i>B.value){const e=B.value/i;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}return{px:n,py:s}}async function ie(){const e=await M({call:"getCombatants"});X.value=e.combatants??[]}async function re(){await ie(),function(){if(!k.value)return W.value=[],void(Y.value=0);const e=X.value.filter(e=>e.Name&&e.Name.includes(k.value));W.value=e,Y.value=0}(),"Pvp"!==F.value&&k.value&&H.value?("*"===k.value?function(){if(q.value="all",!$)throw new Error("canvas context is null");const e=X.value.find(e=>e.Name===H.value),a=X.value.filter(e=>e.Name!==H.value&&e.ID);if(!e)return;$.clearRect(0,0,A.value,A.value),$.strokeStyle=J,$.lineWidth=1,$.beginPath(),$.arc(oe.value,ne.value,B.value,0,2*Math.PI),$.stroke(),$.strokeStyle=Z,$.beginPath(),$.moveTo(oe.value-B.value,ne.value),$.lineTo(oe.value+B.value,ne.value),$.moveTo(oe.value,ne.value-B.value),$.lineTo(oe.value,ne.value+B.value),$.stroke();const l=new Map;for(const i of a)l.set(i.ID.toString(),se(i,e,1));for(const i of a){const e=l.get(i.ID.toString());e&&($.strokeStyle=Q,$.lineWidth=le,$.beginPath(),$.moveTo(oe.value,ne.value),$.lineTo(e.px,e.py),$.stroke())}for(const i of a){const e=l.get(i.ID.toString());e&&($.fillStyle=K,$.beginPath(),$.arc(e.px,e.py,ae,0,2*Math.PI),$.fill())}for(const i of a){const e=l.get(i.ID.toString());if(!e)continue;const a=i.Name??"",t=$.measureText(a).width;$.shadowColor="black",$.shadowBlur=1,$.shadowOffsetX=1,$.shadowOffsetY=1,$.fillStyle=V,$.font="8px Arial",$.fillText(a,e.px-t/2,e.py-ae-3),$.shadowColor="transparent",$.shadowBlur=0,$.shadowOffsetX=0,$.shadowOffsetY=0}const t=-(e.Heading??0)+Math.PI;$.save(),$.translate(oe.value,ne.value),$.rotate(t),$.fillStyle=G;const o=ee,n=o/3,s=-.2*o;$.beginPath(),$.moveTo(0,-o/2+s),$.lineTo(-n,o/2+s),$.lineTo(n,o/2+s),$.closePath(),$.fill(),$.restore()}():function(){if(q.value="single",!$)throw new Error("canvas context is null");const e=W.value[Y.value],a=X.value.find(e=>e.Name===H.value);if(!e)return void $.clearRect(0,0,A.value,A.value);if(!a)return;$.clearRect(0,0,A.value,A.value),$.strokeStyle=J,$.lineWidth=1,$.beginPath(),$.arc(oe.value,ne.value,B.value,0,2*Math.PI),$.stroke(),$.strokeStyle=Z,$.beginPath(),$.moveTo(oe.value-B.value,ne.value),$.lineTo(oe.value+B.value,ne.value),$.moveTo(oe.value,ne.value-B.value),$.lineTo(oe.value,ne.value+B.value),$.stroke();const l=e.PosX-a.PosX,t=e.PosY-a.PosY,o=Math.sqrt(l*l+t*t);let n=oe.value+l/.5,s=ne.value+t/.5;const i=Math.hypot(n-oe.value,s-ne.value);if(i>B.value){const e=B.value/i;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}$.strokeStyle=Q,$.lineWidth=le,$.beginPath(),$.moveTo(oe.value,ne.value),$.lineTo(n,s),$.stroke(),$.fillStyle=K,$.beginPath(),$.arc(n,s,ae,0,2*Math.PI),$.fill();const r=-(a.Heading??0)+Math.PI;$.save(),$.translate(oe.value,ne.value),$.rotate(r),$.fillStyle=G;const u=ee,v=u/3,c=-.2*u;$.beginPath(),$.moveTo(0,-u/2+c),$.lineTo(-v,u/2+c),$.lineTo(v,u/2+c),$.closePath(),$.fill(),$.restore();const f=Math.atan2(s-ne.value,n-oe.value);$.fillStyle=Q,$.beginPath(),$.moveTo(n,s),$.lineTo(n-te*Math.cos(f-Math.PI/6),s-te*Math.sin(f-Math.PI/6)),$.lineTo(n-te*Math.cos(f+Math.PI/6),s-te*Math.sin(f+Math.PI/6)),$.closePath(),$.fill(),$.fillStyle=U,$.font="10px Arial",$.fillText(`${o.toFixed(1)}y`,n+5,s-5)}(),setTimeout(re,100)):k.value=""}const ue=e=>{if("00"===e.line[0]){const a=E.echo.exec(e.rawLine);a?.groups?.target&&(k.value=a.groups.target,ie().then(()=>{re()}))}},ve=e=>{H.value=e.charName};function ce(){A.value=Math.min(window.innerWidth,window.innerHeight)-80,O.value=window.devicePixelRatio||1,$&&($.setTransform(1,0,0,1,0,0),$.scale(O.value,O.value))}return n(()=>{$=R.value?.getContext("2d")??null,$&&$.scale(O.value,O.value),T("LogLine",ue),T("ChangePrimaryPlayer",ve),window.addEventListener("resize",ce)}),s(()=>{x("LogLine",ue),x("ChangePrimaryPlayer",ve),window.removeEventListener("resize",ce)}),(a,l)=>{const t=P,o=e;return u(),i(o,null,{readme:r(()=>[w(t,{class:"el-alert-info",type:"info",closable:!1,"show-icon":"",title:"宏命令：/e find 目标名称",description:"名称允许部分匹配。若输入*可查看所有目标"})]),default:r(()=>[v("div",I,[c(v("div",j,[d(W).length>1?(u(),f("div",S,[v("button",{class:"nav-arrow left-arrow",disabled:d(W).length<=1,"aria-label":"上一目标",onClick:l[0]||(l[0]=e=>Y.value=(d(Y)-1+d(W).length)%d(W).length)}," ← ",8,_),v("span",null," （"+g(d(Y)+1)+" / "+g(d(W).length)+"） ",1),v("button",{class:"nav-arrow right-arrow",disabled:d(W).length<=1,"aria-label":"下一目标",onClick:l[1]||(l[1]=e=>Y.value=(d(Y)+1)%d(W).length)}," → ",8,C)])):h("",!0),v("div",N,["single"===d(q)?(u(),f("span",z,g(d(W)[d(Y)]?.Name??`【未找到${d(k)}】`),1)):h("",!0),v("button",{class:"cancel-btn",onClick:l[2]||(l[2]=e=>{k.value="",W.value=[]})}," 取消 ")]),v("div",D,[v("canvas",{ref_key:"canvas",ref:R,class:"radar-canvas",width:d(A)*d(O),height:d(A)*d(O),style:m({width:`${d(A)}px`,height:`${d(A)}px`})},null,12,L)])],512),[[p,d(k)]])])]),_:1})}}}),[["__scopeId","data-v-782e3590"]]);export{W as default};
