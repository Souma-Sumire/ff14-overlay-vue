import{_ as e}from"./ActWrapper-9IDiLVAi.js";import{d as t,r as n,h as a,bd as o,j as r,w as i,o as s,k as m,v as u,u as l,a as c}from"./index-Dv6uazMJ.js";import{t as d}from"./tts-BkZGqxam.js";import{U as p}from"./util-BOtaAWHW.js";import{N as f}from"./netregexes-RPvCCaeG.js";import{a as w,r as b,c as v}from"./overlay_plugin_api-DHbPkDtN.js";import{d as h}from"./index-B8ZiaNRg.js";import{_ as g}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./el-card-CAWIQgvX.js";import"./useDev-ROusmI0_.js";import"./useDemo-BR9rtmHI.js";import"./regexes-BKeG-dSP.js";const T=g(t({__name:"enmity",setup(t){let g=0;const T=n([]),y=h("hash"),C=n(!1),j=[p.iconToJobEnum("Paladin"),p.iconToJobEnum("Warrior"),p.iconToJobEnum("DarkKnight"),p.iconToJobEnum("Gunbreaker")],I=[2843,3124,743,1833];let _,P;const k={countdown:f.countdown(),countdownCancel:f.countdownCancel(),wipe:f.network6d({command:["40000010","4000000F"]}),inCombat:f.inCombat()};async function D(){const e=(await v({call:"getCombatants"})).combatants.filter(e=>T.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===g)?.Job;if(void 0===t)return L(),C.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!j.includes(t))return L(),C.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>I.includes(e.BuffID))),partyCombatState:e}}function J(){L(),_=window.setInterval(()=>{D().then(({enmityTanks:e})=>{0!==e.length?C.value=!1:C.value=!0}).catch(()=>{C.value=!1})},500)}function L(){P&&clearTimeout(P),_&&clearInterval(_)}const x=e=>{const t=k.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)J(),P=window.setTimeout(()=>{D().then(({enmityTanks:e})=>{2===e.length&&d("双T都开盾了"),0===e.length&&d("没人开盾")}).catch(()=>{C.value=!1})},1e3*(Number.parseInt(t)-10));else if(k.countdownCancel.test(e.rawLine))L(),C.value=!1;else if(k.wipe.test(e.rawLine))L(),C.value=!1;else if(k.inCombat.test(e.rawLine)){if("false"===y.stRemind)return;const{inACTCombat:t,inGameCombat:n}=k.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===n&&(J(),P=window.setTimeout(()=>{D().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>p.isTankJob(p.jobEnumToJob(e.Job))).length&&1===e.length&&e[0]?.ID!==g&&d("ST开盾")}).catch(()=>{C.value=!1})},2e4))}},E=e=>{T.value=e.party},G=e=>{g=e.charID};return a(()=>{w("LogLine",x),w("PartyChanged",E),w("ChangePrimaryPlayer",G)}),o(()=>{_&&clearInterval(_),P&&clearTimeout(P),b("LogLine",x),b("PartyChanged",E),b("ChangePrimaryPlayer",G)}),(t,n)=>{const a=e;return s(),r(a,null,{default:i(()=>[m(c("strong",null,"没人开盾",512),[[u,l(C)]])]),_:1})}}}),[["__scopeId","data-v-55dd9f0d"]]);export{T as default};
