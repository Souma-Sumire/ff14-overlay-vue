import{_ as e}from"./ActWrapper-DEv5PPmG.js";import{d as s,c as a,o as l,s as t,a as o,t as n,F as r,G as i,r as u,h as d,i as m,aI as c,y as v,aG as p,k as y,w as h,u as b,e as g,m as f,P as k,bd as w}from"./index-rExSYECU.js";import{_ as j}from"./_plugin-vue_export-helper-BCo6x5W8.js";import{u as x}from"./useIndexedDB-BFQzRBFl.js";import{u as I}from"./useWebSocket-NiIzIScq.js";import{U as C}from"./util-BSI8OlRX.js";import{a as $,r as T,c as A}from"./overlay_plugin_api-DHbPkDtN.js";import{u as D}from"./useDev-A4IWb35a.js";import{a as E}from"./worlds-CtvzlGyX.js";import{E as L}from"./index-B3TcV9_h.js";import"./useDemo-CcVX6BuP.js";import"./index-BYnZpkxX.js";import"./index-ZQZu3B4f.js";import"./index-D6R6CBTt.js";import"./index-DsYbmNez.js";import"./use-form-common-props-BLbb-UNH.js";import"./validator-Ky0MT829.js";import"./index-JxEOfCWG.js";import"./index-DGWc4u_v.js";import"./index-DeA2G1sq.js";import"./focus-trap-BwEOvUTS.js";import"./index-CLg7KbH6.js";import"./vnode-BM_cplcr.js";const B={class:"user-header"},_={class:"user-info"},M={class:"user-name"},S={key:0,class:"status-badge pre",title:"尚未查询"},N={key:0,class:"status-badge",title:"正在使用 BBY"},F={key:1,class:"status-badge unused",title:"未使用 BBY"},W={class:"user-meta"},q={key:0,class:"user-job"},z={key:1,class:"user-world"},P=j(s({__name:"UserCard",props:{user:{},blurMode:{type:Boolean}},setup:e=>(s,u)=>(l(),a("div",{class:t(["user-card",{"not-responded":e.user.isQueried&&!e.user.hasResponded,"pre-query":!e.user.isQueried,"blur-mode":e.blurMode}])},[o("div",B,[o("div",_,[o("div",M,[o("span",{class:t({"blurred-text":e.blurMode})},n(e.user.name),3),e.user.isQueried?(l(),a(r,{key:1},[e.user.hasResponded?(l(),a("span",N,"BBY")):(l(),a("span",F,"未使用"))],64)):(l(),a("span",S,"尚未查询"))]),o("div",W,[e.user.job?(l(),a("span",q,n(e.user.job),1)):i("",!0),e.user.world?(l(),a("span",z,n(e.user.world),1)):i("",!0)])])])],2))}),[["__scopeId","data-v-80c67691"]]),U={class:"advwm-container"},Y={class:"header"},O={class:"query-methods"},J={class:"query-item"},Q=["disabled"],R={class:"users-section"},H={class:"users-header-row"},G={key:0,class:"status-hint"},X={class:"using-count"},K={class:"last-query-time"},Z={class:"users-list"},V={key:0,class:"empty-state"},ee={key:1,class:"debug-section"},se={style:{"margin-bottom":"16px"}},ae={key:2,class:"history-section"},le={class:"history-header"},te={class:"history-list"},oe={class:"snapshot-header"},ne={class:"snapshot-time"},re={key:0,class:"snapshot-query-time"},ie={class:"snapshot-members"},ue={class:"member-name"},de={key:0,class:"member-world"},me={class:"member-job"},ce=j(s({__name:"bby",setup(s){const j=D();I({addWsParam:!0,allowClose:!1});const B=["A","B","C","D","One","Two","Three","Four"],_={floorMarker:/^(?<timestamp>^.{14}) WaymarkMarker (?<type>1C):(?<operation>[^:]*):(?<waymark>[^:]*):(?<id>[^:]*):(?<name>[^:]*):(?<x>[^:]*):(?<y>[^:]*):(?<z>[^:]*)(?:$|:)/},M=u([]),S=u(""),N=u(!1),F=u({}),W=u({}),q=u(null),z=d(()=>ge.value.filter(e=>e).length),ce=u(!1),ve=()=>{ce.value=!ce.value},pe=x("bby"),ye=u([]);async function he(){const e=ye.value.map(e=>w(e));await pe.replaceAll(e)}async function be(){ye.value=[],await pe.clear()}const ge=u([]),fe=u(null),ke=d(()=>ge.value.map(e=>{if(!e)return null;const s=M.value.find(s=>s.id===e.id),a=C.jobToFullName(C.jobEnumToJob(e.job)).cn||"",l=!!q.value;return s?{...s,hasResponded:!0,isQueried:l}:{id:e.id,name:e.name,job:a,world:e.world,flags:0,waymarkIndex:-1,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!1,isInitiator:!1,hasResponded:!1,isQueried:l}}).filter(e=>null!==e));function we(e){const s=e-Math.floor(e);return Math.round(100*(s-.01))}const je=(...e)=>N.value&&void 0,xe=(...e)=>N.value&&void 0,Ie=(...e)=>N.value&&void 0;function Ce(e){return e.endsWith("1")}const $e=e=>{for(const s of e.detail.logs){const e=_.floorMarker.exec(s);if(e?.groups){const{operation:s,waymark:a,id:l,x:t,y:o,z:n}=e.groups,r=parseInt(a||"0");if(xe(`[LogEvent] 捕获标点变更: ${s} waymarkIdx:${r} waymarkName:${B[r]} (x:${t}, y:${o}, z:${n})`),!isNaN(r)&&r>=0&&r<=7&&("Add"===s||"Change"===s?W.value[r]={x:parseFloat(t||"0"),y:parseFloat(o||"0"),z:parseFloat(n||"0"),active:!0}:"Delete"===s&&W.value[r]&&(W.value[r].active=!1)),!s||"Add"!==s&&"Change"!==s)continue;if(!(a&&l&&t&&o&&n)){Ie("[LogEvent] 标点数据缺失:",{operation:s,waymark:a,id:l,x:t,y:o,z:n});continue}const i=parseFloat(t||"0"),u=parseFloat(o||"0"),d=parseFloat(n||"0");if(isNaN(r)||r<0||r>7)continue;if(Math.abs(i)>1e4||Math.abs(u)>1e4)continue;const m=we(d),c=Ce(t),v=Ce(o);if(c&&v){xe(`[LogEvent] 检测到特征信号 (WaymarkIdx: ${r}, Flags: 0x${m.toString(16)})`);if(!!(8&m)&&0===r){xe("[LogEvent] 忽略匿名查询广播");continue}const e=ge.value[r];if(!e){Ie(`[LogEvent] 索引 ${r} 对应的是空槽位`);continue}const s=C.jobToFullName(C.jobEnumToJob(e.job)).cn||"";xe(`[LogEvent] 解析成员: ${e.name} (${s})`);Te({id:e.id,name:e.name||"未知",job:s,flags:m,waymarkIndex:r,isAnonymous:!!(1&m),isIdHidden:!!(2&m),isWaymarkEnabled:!!(4&m),isInitiator:!!(8&m),world:e.world})}else je(`[LogEvent] 坐标特征不符 (X:${t}, Y:${o})`)}}};function Te(e){if(e.id===S.value&&e.isInitiator)return;const s=M.value.findIndex(s=>s.id===e.id);s>=0?(xe(`[User] 更新用户信息: ${e.name}`),M.value[s]=e):e.isInitiator&&e.id!==S.value?(xe(`[User] 检测到来自 ${e.name} 的被动查询，清空当前列表`),M.value.length>0&&(xe("[User] 存档当前列表到历史记录"),ye.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:q.value,members:[...M.value]}),he()),q.value=(new Date).toLocaleTimeString(),M.value=[e]):(xe(`[User] 新增响应者: ${e.name}`),M.value.push(e)),xe("当前响应者列表:",M.value)}const Ae=e=>{const s=[];if(e.party&&Array.isArray(e.party))for(const t of e.party)t.id&&t.inParty&&s.push({id:t.id.toUpperCase(),hexId:parseInt(t.id,16),name:t.name||"",job:t.job||0,level:t.level||0,world:E[t.worldId]||""});const a=[...s].sort((e,s)=>e.hexId-s.hexId),l=new Array(8).fill(null);for(let t=0;t<8;t++){const e=(t+3)%8;e<a.length&&(l[t]=a[e]||null)}ge.value=l,xe(l)},De=()=>{const e="A",s=W.value[0]||{x:0,y:0,z:0},a=0===s.x&&0===s.y&&0===s.z;let l=Math.round(10*s.x)/10;l+=l>=0?.01:-.01;let t=Math.round(10*s.y)/10;t+=t>=0?.01:-.01;let o=Math.floor(s.z+.01);o+=.16;const n={Local:!1,[e]:{X:l,Y:o,Z:t,Active:!0}};xe(`[Ask] 计算坐标(索引 0): X=${l}, Y=${o}, Z=${t}`),(e=>{xe("调用鲶鱼精邮差:",JSON.stringify(e)),A({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({...e,LocalOnly:!1})})})(n),M.value.length>0&&(ye.value.unshift({key:Date.now().toString(),timestamp:(new Date).toLocaleTimeString(),queryTime:q.value,members:[...M.value]}),he()),q.value=(new Date).toLocaleTimeString(),M.value=[],L.closeAll(),L.info({message:"正在获取信号...",position:"top-left",customClass:"bby-mini-notify",showClose:!1}),fe.value&&clearTimeout(fe.value),fe.value=setTimeout(()=>{a&&(xe("清理所有标点"),A({call:"PostNamazu",c:"DoWaymarks",p:JSON.stringify({LocalOnly:!1,A:{},B:{},C:{},D:{},One:{},Two:{},Three:{},Four:{}})})),fe.value=null,L.closeAll(),M.value.length>0?L.success({message:`发现 ${M.value.length} 名 BBY 成员`,position:"top-left",customClass:"bby-mini-notify",showClose:!1}):L.warning({message:"未发现 BBY 成员",position:"top-left",customClass:"bby-mini-notify",showClose:!1})},1e3)},Ee=e=>{const s=e.charID.toString(16).toUpperCase();S.value!==s&&(S.value=s,xe(`我的 ID 已更新: ${s}`))},Le=()=>{const e=["地平关","迷雾湿地","拉诺西亚","紫水栈桥","幻影群岛"],s=["鸣神小吉","猫三水","苏摩","艾露恩","莉莉丝","阿尔法","欧米茄","泰坦","利维亚桑","希瓦"],a=[];for(let t=0;t<8;t++)a.push({id:(1e3+t).toString(16).toUpperCase(),hexId:1e3+t,name:s[t%s.length],job:1+t%38,level:100,world:e[t%e.length]});ge.value=a;const l=[];a.forEach((e,s)=>{Math.random()>.4&&l.push({id:e.id,name:e.name,job:C.jobToFullName(C.jobEnumToJob(e.job)).cn||"冒险者",flags:0,waymarkIndex:s,isAnonymous:!1,isIdHidden:!1,isWaymarkEnabled:!0,isInitiator:!1,world:e.world})}),q.value=(new Date).toLocaleTimeString(),M.value=l};return m(()=>{!async function(){try{const e=await pe.getAll();e&&e.length>0&&(ye.value=e.sort((e,s)=>s.key.localeCompare(e.key)))}catch(e){}}(),$("onLogEvent",$e),$("PartyChanged",Ae),$("ChangePrimaryPlayer",Ee);const e=c({storageKey:"bby-theme"}),s=v(e);!1===e.value&&s()}),p(()=>{T("onLogEvent",$e),T("PartyChanged",Ae),T("ChangePrimaryPlayer",Ee)}),(s,u)=>{const d=e;return l(),y(d,null,{default:h(()=>[o("div",U,[o("div",Y,[u[2]||(u[2]=o("h2",null,"小队里谁在使用BBY",-1)),o("div",O,[o("div",J,[o("button",{class:t(["ask-btn",{searching:!!fe.value}]),onClick:De,disabled:!!fe.value},n(fe.value?"正在查询...":"主动查询"),11,Q),b(j)?(l(),a("button",{key:0,class:"ask-btn fake-test-btn",onClick:Le}," 生成测试数据 ")):i("",!0),u[0]||(u[0]=o("span",{class:"item-desc"},[g(" 通过场地标点通信，需要使用鲶鱼精邮差（你和对方都要）并处于可以标点的同一地图中"),o("br")],-1))]),u[1]||(u[1]=o("div",{class:"query-item passive"},[o("span",{class:"passive-title"},"被动接收"),o("span",{class:"item-desc"},"当队伍内其他玩家发起查询时，此处也会同步显示结果。")],-1))])]),o("div",R,[o("div",H,[o("h3",null,"当前小队 ("+n(ke.value.length)+")",1),q.value?(l(),a(r,{key:1},[o("span",X,"发现使用中: "+n(M.value.length),1),o("span",K,"最后查询: "+n(q.value),1)],64)):(l(),a("span",G,"尚未进行查询"))]),o("div",Z,[(l(!0),a(r,null,f(ke.value,e=>(l(),y(P,{key:e.id,user:e,"blur-mode":ce.value,onContextmenu:k(ve,["prevent"])},null,8,["user","blur-mode"]))),128))])]),0===ke.value.length?(l(),a("div",V,[...u[3]||(u[3]=[o("p",null,"等待小队数据...",-1)])])):i("",!0),N.value?(l(),a("div",ee,[u[11]||(u[11]=o("h3",null,"调试信息",-1)),o("div",se,[u[4]||(u[4]=o("strong",null,"用户总数:",-1)),g(" "+n(M.value.length),1),u[5]||(u[5]=o("br",null,null,-1)),u[6]||(u[6]=o("strong",null,"应答者数:",-1)),g(" "+n(ke.value.length),1),u[7]||(u[7]=o("br",null,null,-1)),u[8]||(u[8]=o("strong",null,"小队成员数:",-1)),g(" "+n(z.value),1)]),o("details",null,[u[9]||(u[9]=o("summary",null,"用户列表详情",-1)),o("pre",null,n(M.value),1)]),o("details",null,[u[10]||(u[10]=o("summary",null,"标点解析详情",-1)),o("pre",null,n(F.value),1)])])):i("",!0),ye.value.length>0?(l(),a("div",ae,[o("div",le,[o("h3",null,"历史记录 ("+n(ye.value.length)+")",1),o("button",{class:"clear-history-btn",onClick:be},"清空历史")]),o("div",te,[(l(!0),a(r,null,f(ye.value,(e,s)=>(l(),a("div",{key:s,class:"history-item"},[o("div",oe,[o("div",ne,"存档时间: "+n(e.timestamp),1),e.queryTime?(l(),a("div",re,"查询时间: "+n(e.queryTime),1)):i("",!0)]),o("div",ie,[(l(!0),a(r,null,f(e.members,e=>(l(),a("div",{key:e.id,class:"history-member-tag"},[o("span",ue,n(e.name),1),e.world?(l(),a("span",de,n(e.world),1)):i("",!0),o("span",me,n(e.job),1)]))),128))])]))),128))])])):i("",!0)])]),_:1})}}}),[["__scopeId","data-v-c566704b"]]);export{ce as default};
