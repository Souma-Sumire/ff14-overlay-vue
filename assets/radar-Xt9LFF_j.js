import{c as e,_ as a}from"./shared-common-CRNvULZF.js";import{o as l,B as t,a5 as o,v as n,J as s,dy as r,r as i,t as u,K as v,V as c,u as h,H as d,Z as f,X as g,L as m,_ as w,I as P,c as p}from"./vendor-vue-GqahCgpc.js";import{F as y}from"./shared-core-fba2-cgd.js";import{N as T,a as b,r as M,c as x}from"./cactbot-CmNinDrW.js";import{a2 as k}from"./vendor-element-plus-DIlhOlLn.js";const I={class:"radar-container"},S={class:"radar-wrapper"},N={key:0},C=["disabled","aria-label"],$=["disabled","aria-label"],L={class:"target-header"},_={key:0,class:"target-name"},X={class:"radar-canvas-container"},D=["width","height"],W=a(l({__name:"radar",setup(a){const l=i(""),W=i([]),Y=i(0),j=i(""),H=i([]),R={echo:T.echo({line:"find\\s*(?<target>.+)"})},B=r("canvas");let E=null;const O=i(window.devicePixelRatio||1),z=i(Math.min(window.innerWidth,window.innerHeight)-80),F=p(()=>z.value/2-20),{zoneType:A}=y(),q=i("single"),J="#0f0",K="#060",V="#0f0",Z="#ff0",G="#f00",Q="#fff",U="#fff",ee=18,ae=3,le=2,te=6,oe=p(()=>z.value/2),ne=p(()=>z.value/2);function se(e,a,l){const t=e.PosX-a.PosX,o=e.PosY-a.PosY;let n=oe.value+t/l,s=ne.value+o/l;const r=Math.hypot(n-oe.value,s-ne.value);if(r>F.value){const e=F.value/r;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}return{px:n,py:s}}async function re(){const e=await x({call:"getCombatants"});H.value=e.combatants??[]}async function ie(){await re(),function(){if(!l.value)return W.value=[],void(Y.value=0);const e=H.value.filter(e=>e.Name&&e.Name.includes(l.value));W.value=e}(),"Pvp"!==A.value&&l.value&&j.value?("*"===l.value?function(){if(q.value="all",!E)throw new Error("canvas context is null");const e=H.value.find(e=>e.Name===j.value),a=H.value.filter(e=>e.Name!==j.value&&e.ID);if(!e)return;E.clearRect(0,0,z.value,z.value),E.strokeStyle=J,E.lineWidth=1,E.beginPath(),E.arc(oe.value,ne.value,F.value,0,2*Math.PI),E.stroke(),E.strokeStyle=K,E.beginPath(),E.moveTo(oe.value-F.value,ne.value),E.lineTo(oe.value+F.value,ne.value),E.moveTo(oe.value,ne.value-F.value),E.lineTo(oe.value,ne.value+F.value),E.stroke();const l=new Map;for(const r of a)l.set(r.ID.toString(),se(r,e,1));for(const r of a){const e=l.get(r.ID.toString());e&&(E.strokeStyle=G,E.lineWidth=le,E.beginPath(),E.moveTo(oe.value,ne.value),E.lineTo(e.px,e.py),E.stroke())}for(const r of a){const e=l.get(r.ID.toString());e&&(E.fillStyle=Z,E.beginPath(),E.arc(e.px,e.py,ae,0,2*Math.PI),E.fill())}for(const r of a){const e=l.get(r.ID.toString());if(!e)continue;const a=r.Name??"",t=E.measureText(a).width;E.shadowColor="black",E.shadowBlur=1,E.shadowOffsetX=1,E.shadowOffsetY=1,E.fillStyle=U,E.font="8px Arial",E.fillText(a,e.px-t/2,e.py-ae-3),E.shadowColor="transparent",E.shadowBlur=0,E.shadowOffsetX=0,E.shadowOffsetY=0}const t=-(e.Heading??0)+Math.PI;E.save(),E.translate(oe.value,ne.value),E.rotate(t),E.fillStyle=V;const o=ee,n=o/3,s=-.2*o;E.beginPath(),E.moveTo(0,-o/2+s),E.lineTo(-n,o/2+s),E.lineTo(n,o/2+s),E.closePath(),E.fill(),E.restore()}():function(){if(q.value="single",!E)throw new Error("canvas context is null");const e=W.value[Y.value],a=H.value.find(e=>e.Name===j.value);if(!e)return void E.clearRect(0,0,z.value,z.value);if(!a)return;E.clearRect(0,0,z.value,z.value),E.strokeStyle=J,E.lineWidth=1,E.beginPath(),E.arc(oe.value,ne.value,F.value,0,2*Math.PI),E.stroke(),E.strokeStyle=K,E.beginPath(),E.moveTo(oe.value-F.value,ne.value),E.lineTo(oe.value+F.value,ne.value),E.moveTo(oe.value,ne.value-F.value),E.lineTo(oe.value,ne.value+F.value),E.stroke();const l=e.PosX-a.PosX,t=e.PosY-a.PosY,o=Math.sqrt(l*l+t*t);let n=oe.value+l/.5,s=ne.value+t/.5;const r=Math.hypot(n-oe.value,s-ne.value);if(r>F.value){const e=F.value/r;n=oe.value+(n-oe.value)*e,s=ne.value+(s-ne.value)*e}E.strokeStyle=G,E.lineWidth=le,E.beginPath(),E.moveTo(oe.value,ne.value),E.lineTo(n,s),E.stroke(),E.fillStyle=Z,E.beginPath(),E.arc(n,s,ae,0,2*Math.PI),E.fill();const i=-(a.Heading??0)+Math.PI;E.save(),E.translate(oe.value,ne.value),E.rotate(i),E.fillStyle=V;const u=ee,v=u/3,c=-.2*u;E.beginPath(),E.moveTo(0,-u/2+c),E.lineTo(-v,u/2+c),E.lineTo(v,u/2+c),E.closePath(),E.fill(),E.restore();const h=Math.atan2(s-ne.value,n-oe.value);E.fillStyle=G,E.beginPath(),E.moveTo(n,s),E.lineTo(n-te*Math.cos(h-Math.PI/6),s-te*Math.sin(h-Math.PI/6)),E.lineTo(n-te*Math.cos(h+Math.PI/6),s-te*Math.sin(h+Math.PI/6)),E.closePath(),E.fill(),E.fillStyle=Q,E.font="10px Arial",E.fillText(`${o.toFixed(1)}y`,n+5,s-5)}(),setTimeout(ie,100)):l.value=""}const ue=e=>{if("00"===e.line[0]){const a=R.echo.exec(e.rawLine);a?.groups?.target&&(l.value=a.groups.target,Y.value=0,re().then(()=>{ie()}))}},ve=e=>{j.value=e.charName};function ce(){z.value=Math.min(window.innerWidth,window.innerHeight)-80,O.value=window.devicePixelRatio||1,E&&(E.setTransform(1,0,0,1,0,0),E.scale(O.value,O.value))}return t(()=>{E=B.value?.getContext("2d")??null,E&&E.scale(O.value,O.value),b("LogLine",ue),b("ChangePrimaryPlayer",ve),window.addEventListener("resize",ce)}),o(()=>{M("LogLine",ue),M("ChangePrimaryPlayer",ve),window.removeEventListener("resize",ce)}),(a,t)=>{const o=k,r=e;return u(),n(r,null,{readme:s(()=>[P(o,{class:"el-alert-info",type:"info",closable:!1,"show-icon":"",title:a.$t("radar.radarTitle"),description:a.$t("radar.radarDesc")},null,8,["title","description"])]),default:s(()=>[v("div",I,[c(v("div",S,[h(W).length>1?(u(),d("div",N,[v("button",{class:"nav-arrow left-arrow",disabled:h(W).length<=1,"aria-label":a.$t("radar.prevTarget"),onClick:t[0]||(t[0]=e=>Y.value=(h(Y)-1+h(W).length)%h(W).length)}," ← ",8,C),v("span",null," （"+f(h(Y)+1)+" / "+f(h(W).length)+"） ",1),v("button",{class:"nav-arrow right-arrow",disabled:h(W).length<=1,"aria-label":a.$t("radar.nextTarget"),onClick:t[1]||(t[1]=e=>Y.value=(h(Y)+1)%h(W).length)}," → ",8,$)])):g("",!0),v("div",L,["single"===h(q)?(u(),d("span",_,f(h(W)[h(Y)]?.Name??a.$t("radar.targetNotFound",{targetName:h(l)})),1)):g("",!0),v("button",{class:"cancel-btn",onClick:t[2]||(t[2]=()=>{l.value="",W.value=[]})},f(a.$t("radar.cancelBtn")),1)]),v("div",X,[v("canvas",{ref_key:"canvas",ref:B,class:"radar-canvas",width:h(z)*h(O),height:h(z)*h(O),style:m({width:`${h(z)}px`,height:`${h(z)}px`})},null,12,D)])],512),[[w,h(l)]])])]),_:1})}}}),[["__scopeId","data-v-b3f8c52d"]]);export{W as default};
