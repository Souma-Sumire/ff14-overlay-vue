import{_ as e,e as t}from"./shared-common-D0LVCzpB.js";import{h as a,G as n,g as o,a as i,e as s,b as l,c as r,n as c,t as u,f as d,F as m,d as f,y as p,z as g,cO as v,r as b,x as y,dx as h,w as k,dz as w,s as j,D as $,u as C,b9 as N,o as I,j as R,l as D,p as _,v as E,i as x,bW as T,cj as A}from"./vendor-vue-i6lpFrx4.js";import{ac as S,U as M,ad as z,r as K,s as L,ae as F,u as H,w as G,a9 as O,f as P,$ as W,af as Z,ag as J,t as B,ah as U,ai as V,Z as q,l as X,aj as Y,ak as Q,al as ee,A as te,am as ae,a7 as ne}from"./shared-core-DW4-bD-R.js";import{t as oe,J as ie,b as se,aC as le,aD as re,aE as ce,g as ue,a as de,E as me,aF as fe,aG as pe,n as ge}from"./vendor-element-plus-DxZgBX3C.js";import{N as ve,a as be,l as ye}from"./cactbot-CO6bDcKj.js";const he={class:"amount"},ke={class:"row-info"},we=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:b,shield:y,source:h,type:k}=t.row,w=Math.round(v*+y/100),j=Math.round(b/v*100),$=t.row.reduction,C=(a&&Math.round((a+w)/(1-$))||0).toLocaleString(),N=n(()=>a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString()),I=k,R=S(t.row);return(e,t)=>{const a=oe,n=ie;return i(),o(n,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:s(()=>[l("span",he,[l("span",{class:g(d(I))},[l("span",{class:g({lethal:d(R)})},u(d(N)),3)],2)])]),default:s(()=>[l("ul",ke,[l("li",null,u(e.$t("keigennRecord.source"))+": "+u(d(h)),1),l("li",null,u(e.$t("keigennRecord.playerShield"))+": "+u(d(y))+"%",1),l("li",null,u(e.$t("keigennRecord.playerHp"))+": "+u(d(j))+"%",1),d($)<1&&"dot"!==d(k)?(i(),r(m,{key:0},[f(a),l("li",null,u(e.$t("keigennRecord.reductionRate"))+": "+u((100*d($)).toFixed(3))+"% ",1),l("li",null,[p(u(e.$t("keigennRecord.originalDamage"))+": ",1),l("span",{class:g(d(I))},u(d(C)),3)])],64)):c("",!0)])]),_:1})}}}),[["__scopeId","data-v-43628410"]]),je={class:"subtitle"},$e={class:"skill-grid"},Ce=["title"],Ne=["src"],Ie={class:"skill-text"},Re={class:"subtitle"},De={class:"skill-grid"},_e=["title"],Ee=["src"],xe={key:2,class:"no-data"},Te=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=n(()=>v(t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[])),p=n(()=>v(t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>M.enumSortMethod(e.ownerJob,t.ownerJob))??[]));function g(e){const t=M.jobEnumToJob(e);return M.jobToFullName(t).simple2||""}const y={modifiers:[{name:"preventOverflow",options:{padding:24}}]};return(e,t)=>{const n=se,v=oe,h=ie;return i(),o(h,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover",transition:"none","show-after":0,"hide-after":0,"popper-options":y},{reference:s(()=>[f(n,{class:"view-icon"},{default:s(()=>[f(d(le))]),_:1})]),default:s(()=>[d(a).length>0?(i(),r(m,{key:0},[l("div",je,u(e.$t("keigennRecord.coolingDown")),1),l("div",$e,[(i(!0),r(m,null,b(d(a),e=>(i(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[l("div",{class:"skill-icon-container",title:`${e.ownerName} (${g(e.ownerJob)})`},[l("img",{src:e.icon,class:"skill-icon"},null,8,Ne),t[0]||(t[0]=l("div",{class:"skill-overlay"},null,-1)),l("span",Ie,u(e.recastLeft),1)],8,Ce)]))),128))])],64)):c("",!0),d(p).length>0?(i(),r(m,{key:1},[d(a).length>0?(i(),o(v,{key:0})):c("",!0),l("div",Re,u(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),l("div",De,[(i(!0),r(m,null,b(d(p),e=>(i(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[l("div",{class:"skill-icon-container",title:`${e.ownerName} (${g(e.ownerJob)})`},[l("img",{src:e.icon,class:"skill-icon"},null,8,Ee)],8,_e)]))),128))])],64)):c("",!0),0===d(a).length&&0===d(p).length?(i(),r("div",xe,u(e.$t("keigennRecord.noData")),1)):c("",!0)]),_:1})}}}),[["__scopeId","data-v-d1f9fd8f"]]),Ae={key:0},Se={key:1,class:"status-container"},Me=["title","data-duration","data-sourcePov"],ze=["src","alt"],Ke={class:"flags"},Le=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=z(),n=a.userOptions,o=a.icon4k;return(e,a)=>"dot"===t.row.type?(i(),r("div",Ae,u(e.$t("keigennRecord.noSupport")),1)):(i(),r("div",Se,[(i(!0),r(m,null,b(t.row.keigenns,(e,s)=>(i(),r("span",{key:s},[l("span",{class:"status",title:`${d(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[l("img",{class:g(`statusIcon ${d(F)(e,t.row.type)}`),src:d(L)(`/i/${e.fullIcon}${d(o)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>d(K)&&d(K)(...e))},null,42,ze)],8,Me)]))),128)),l("span",Ke,u("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),Fe={class:"target"},He=["src","alt"],Ge={key:1,class:"alt-text"},Oe={key:3,class:"has-duplicate"},Pe=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=z(),o=y(!1);function s(e){o.value=!0;e.target.style.display="none"}const l=n(()=>!o.value&&"icon"===(a.userOptions.targetType??"icon")),m=n(()=>S(t.row));return(e,n)=>{return i(),r("div",Fe,[d(l)?(i(),r("img",{key:0,class:g(`${d(a).isBrowser?"browser":"act"} jobIcon cj${d(a).userOptions.iconType} ${d(m)?"lethal-icon":""}`),src:(o=t.row.jobIcon,f=d(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${f}/${o.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:s},null,42,He)):(i(),r("span",Ge,u(t.row.job),1)),d(m)?(i(),r("span",{key:2,class:g(`lethal-emoji ${d(a).isBrowser?"browser":"act"} emoji-cj${d(a).userOptions.iconType}`)}," ðŸ’€ ",2)):c("",!0),t.row.hasDuplicate?(i(),r("span",Oe,u(d(a).formatterName(t.row.target)),1)):c("",!0)]);var o,f}}}),[["__scopeId","data-v-8cdea5a4"]]),We=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=H(),a=e,m=z().userOptions,p=h("contextMenu"),g=y(""),v=y("");k(()=>a.rows,e=>{0===e.length&&(g.value="",v.value="")},{immediate:!0});const b=y(!1),C=y(0),N=y(0),I=y(null);w(p,()=>{b.value=!1});const R=t("keigennRecord.cancelFilter"),D=n(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey])));return[{label:R,value:""},...e.map(e=>({label:e,value:e}))]}),_=n(()=>{const e=Array.from(new Map(a.rows.map(e=>[e.target,e])).values());return[{label:R,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,t)=>M.enumSortMethod(e.job,t.job))});function E(){if(I.value){const e=I.value[a.actionKey];g.value===e?g.value="":g.value=e,b.value=!1}}function x(){if(I.value){const e=I.value.target;v.value===e?v.value="":v.value=e,b.value=!1}}const T=n(()=>a.rows.filter(e=>{const t=!g.value||g.value===R||e[a.actionKey]===g.value,n=!v.value||v.value===R||e.target===v.value;return t&&n}));function A(e){const t=[88,88,88],a=[50,250,200],n=Math.min(1,e/.5),o=Math.min(9,Math.floor(10*n))/9,i=Math.pow(o,.8),s=t[0]+(a[0]-t[0])*i,l=t[1]+(a[1]-t[1])*i,r=t[2]+(a[2]-t[2])*i;return`rgba(${Math.round(s)}, ${Math.round(l)}, ${Math.round(r)}, 1)`}const S=n(()=>[{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>$("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(de,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>g.value=e===R?"":e},()=>D.value.map(e=>$(me,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$("span",e[a.actionKey]??"")},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>$("div",{class:"header-filter"},[$(de,{size:"small",modelValue:v.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{v.value=e===R?"":e}},()=>_.value.map(e=>$(me,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>$(Pe,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>$(we,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>$("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>$("span",{class:"col-reduction-number",style:{color:A(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:100,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>$(Le,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>$("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},$("div",{style:{position:"absolute",right:"0px",zIndex:5}},$(Te,{row:e})))}]);let K=null;const L=n(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:n,job:o,keigenns:i,time:s,type:l,effect:r,currentHp:c,maxHp:u,shield:d,reduction:f}=e,p="damage done"===r?"":`,${t(`keigennRecord.${r}`)}`,g=`${s} ${o} ${a} ${n.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*f).toFixed(0)}%):${0===i.length&&""===p?t("keigennRecord.none"):i.map(e=>m.statusCN?e.name:e.effect).join(",")+p} ${t("keigennRecord.hp")}}:${c}(${Math.round(c/u*100)}%)+${t("keigennRecord.shield")}:${Math.round(u*+d/100)}(${d}%)`;G(g).then(()=>{K?.close(),K=ue.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>ue.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{const a=t;I.value=e,C.value=a.clientX,N.value=a.clientY,b.value=!0}}));return(a,n)=>{const m=ce,y=re;return i(),o(y,{style:{height:"100%",width:"100%"}},{default:s(({height:a,width:n})=>[f(m,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:S.value,data:T.value,width:n,height:a,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":L.value},null,8,["columns","data","width","height","row-event-handlers"]),d(b)?(i(),r("div",{key:0,ref_key:"contextMenu",ref:p,class:"context-menu",style:j({top:`${d(N)}px`,left:`${d(C)}px`})},[l("ul",null,[l("li",{onClick:E},u(d(g)===(d(I)?.[e.actionKey]??"")?d(t)("keigennRecord.filter.action_cancel",{actionName:d(I)?.[e.actionKey]??d(t)("keigennRecord.this_skill")}):d(t)("keigennRecord.filter.action_only",{actionName:d(I)?.[e.actionKey]??d(t)("keigennRecord.this_skill")})),1),l("li",{onClick:x},u(d(v)===d(I)?.target?d(t)("keigennRecord.filter.target_cancel",{jobName:d(I)?.job??d(t)("keigennRecord.this_job")}):d(t)("keigennRecord.filter.target_only",{jobName:d(I)?.job??d(t)("keigennRecord.this_job")})),1)])],4)):c("",!0)]),_:1})}}}),[["__scopeId","data-v-bbc4ccf6"]]),Ze={class:"header-select"},Je={style:{height:"100%"}},Be={key:0,class:"testLog"},Ue=e(a({__name:"keigennRecord2",setup(e){const a=P();H();const u=z(),h=u.userOptions;u.checkIsBrowser();const k=y(h.minimize),w=n(()=>h.actionCN?"actionCN":"action"),$=y(!1),S=C("keigenn-record-2-pov-id",""),K=C("keigenn-record-2-party-list",[]),L=C("keigenn-record-2-job-map",{}),F=C("keigenn-record-2-party-event-party",[]),G=y(0),oe=y([{zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1}]),ie={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ve.ability(),statusEffectExplicit:ve.statusEffectExplicit(),gainsEffect:ve.gainsEffect(),losesEffect:ve.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:ve.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:ve.addedCombatant(),removingCombatant:ve.removingCombatant(),networkDoT:ve.networkDoT()},se=y(0),le=C("souma-keigenn-record-2-zone-name",""),re=C("souma-keigenn-record-2-rsv-data",{}),ce={},ue={friendly:{},enemy:{}},he=O.filter(e=>1===e.line||2===e.line);let ke={};const we=W("keigenn-record-2");function je(){$.value=!0,se.value=0,ke={},G.value=0,oe.value.length=0,oe.value.push({zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1})}function $e(){$.value=!1,_e()}function Ce(e){for(const t in ie){const a=ie[t].exec(e);if(a){const n=e.split("|");switch(t){case"statusEffectExplicit":a.groups?.targetId.startsWith("1")&&(ce[a.groups.targetId]=a.groups.currentShield);break;case"gainsEffect":{const e=n[ye.GainsEffect.fields.effectId],t=n[ye.GainsEffect.fields.effect],a=n[ye.GainsEffect.fields.target],o=n[ye.GainsEffect.fields.targetId],i=Number.parseInt(n[ye.GainsEffect.fields.count],16);let s=Y(e);if(!s){const t=o.startsWith("1")&&Q.get(Number.parseInt(e,16).toString())||o.startsWith("4")&&ee.get(Number.parseInt(e,16).toString());if(!t)return;const a=te(t.icon),n=i>1?ae(a,i):a;s={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(e,16),fullIcon:n,name:t.name,isFriendly:t.isFriendly}}const l=n[ye.GainsEffect.fields.duration],r=n[ye.GainsEffect.fields.source],c=n[ye.GainsEffect.fields.sourceId],u=new Date(n[ye.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),d={name:s.name,type:s.type,count:i,effect:t,effectId:e,source:r,sourceId:c,target:a,targetId:o,expirationTimestamp:u,performance:s.performance,fullIcon:s.fullIcon,isPov:S.value===c};o.startsWith("1")&&s.isFriendly?(void 0===ue.friendly[o]&&(ue.friendly[o]={}),ue.friendly[o][e]=d):o.startsWith("4")&&!s.isFriendly&&(void 0===ue.enemy[a]&&(ue.enemy[a]={}),ue.enemy[a][e]=d)}break;case"losesEffect":{const e=n[ye.LosesEffect.fields.target],t=n[ye.LosesEffect.fields.targetId],a=n[ye.LosesEffect.fields.effectId];t.startsWith("1")?ue.friendly[t]&&Reflect.deleteProperty(ue.friendly[t],a):ue.enemy[e]&&Reflect.deleteProperty(ue.enemy[e],a)}break;case"addCombatant":if("00"!==n[ye.AddedCombatant.fields.job]){const e=n[ye.AddedCombatant.fields.job],t=n[ye.AddedCombatant.fields.name],a=new Date(n[ye.AddedCombatant.fields.timestamp]).getTime();L.value[n[ye.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a,name:t}}break;case"removingCombatant":Reflect.deleteProperty(L.value,n[ye.RemovedCombatant.fields.id]);break;case"primaryPlayer":S.value=n[ye.ChangedPlayer.fields.id];break;case"partyList":K.value=(a.groups?.list?.split("|")??[]).filter(Boolean);break;case"changeZone":{const e=parseInt(n[ye.ChangeZone.fields.id],16);if(le.value=n[ye.ChangeZone.fields.name],q[e]?.name){const t=X(q[e]?.name);t&&"Unknown"!==t&&(le.value=t)}Re(new Date(n[ye.ChangeZone.fields.timestamp]).getTime());break}case"inCombat":{const e="1"===n[ye.InCombat.fields.inACTCombat],t="1"===n[ye.InCombat.fields.inGameCombat],a=new Date(n[ye.InCombat.fields.timestamp]).getTime();if(e||t){const e=n[ye.InCombat.fields.timestamp];if(se.value>0)return;return 0!==oe.value[0].table.length&&oe.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:e,timestamp:a}),se.value=a,oe.value[0].zoneName=le.value,oe.value[0].timestamp=a,oe.value[0].key=e,void(G.value=0)}if(!e&&!t)return void Re(a)}break;case"rsv":{const e=Number(a.groups?.id),t=n[ye.RSVData.fields.value];e&&t&&(re.value[Number(e)]=t)}break;case"networkDoT":if(!h.parseDoT)return;{const e=n[ye.NetworkDoT.fields.which],t=n[ye.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==S.value&&!K.value.includes(t)&&!F.value.find(e=>e.id===t))return;const a=n[ye.NetworkDoT.fields.name],o=n[ye.NetworkDoT.fields.damage],i=Number.parseInt(o,16),s=new Date(n[ye.Ability.fields.timestamp]??"???").getTime(),l=Number(n[ye.NetworkDoT.fields.currentHp]),r=Number(n[ye.NetworkDoT.fields.maxHp]),c=Ee(0===se.value?0:s-se.value),{job:u,hasDuplicate:d}=Ne(t),m=M.jobToFullName(M.jobEnumToJob(u)).simple2,f=u,p=M.jobEnumToIcon(f);Ie({key:oe.value[0].table.length.toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:a,targetId:t,job:m,jobIcon:p,jobEnum:f,hasDuplicate:d,amount:i,keigenns:[],currentHp:l,maxHp:r,effect:"damage done",type:"dot",shield:ce[t]??"0",povId:S.value,reduction:0,keySkills:[]})}break;case"ability":if(0===se.value)return;{const e=n[ye.Ability.fields.sourceId]??"???",t=n[ye.Ability.fields.id]??"???",o=new Date(n[ye.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16);he.find(e=>Z(e.id,999)===a)&&(ke[e]||(ke[e]={}),ke[e][a]=o)}const i=J(n);if(i.isAttack&&i.amount>=0){const o=n[ye.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!o.startsWith("1"))return;if(o!==S.value&&!K.value.includes(o)&&!F.value.find(e=>e.id===o))return;const s=new Date(n[ye.Ability.fields.timestamp]??"???").getTime(),l=n[ye.Ability.fields.ability],r=l.match(/^_rsv_(?<id>\d+)_/);let c=l;if(r){const e=Number(r.groups?.id);c=re.value[e]??l.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===h.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const u=B(Number.parseInt(t,16)),d=u&&""!==u?u:c,m=Number(n[ye.Ability.fields.targetCurrentHp]),f=Number(n[ye.Ability.fields.targetMaxHp]),p=n[ye.Ability.fields.source]??"???",g=n[ye.Ability.fields.target]??"???",{effect:v,type:b}=U(i.flags),y=Ee(0===se.value?0:s-se.value),{job:k,hasDuplicate:w}=Ne(o),j=M.jobToFullName(M.jobEnumToJob(k)).simple2,$=k,C=M.jobEnumToIcon($),N=V(Object.values(ue.friendly[o]??[]).concat(Object.values(ue.enemy[p]??[])).filter(e=>{const t=Math.max(0,(e.expirationTimestamp-s)/1e3);return e.remainingDuration=t>=999?"":t.toFixed(t>.05&&t<.95?1:0),Number(e.remainingDuration)>-3})),I=ce[a.groups.targetId]??"0",R=i.amount;let D=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of N)"absorbed"!==a.type&&(t*=a.performance[b]??1);D=1-t*e}Ie({key:oe.value[0].table.length.toString(),time:y,id:t,action:c,actionCN:d,source:p,target:g,targetId:o,job:j,jobIcon:C,jobEnum:$,hasDuplicate:w,amount:R,keigenns:N,currentHp:m,maxHp:f,effect:v,type:b,shield:I,povId:S.value,reduction:D,keySkills:De(s)}),oe.value[0].duration=Ee(new Date(n[ye.Ability.fields.timestamp]).getTime()-se.value)}}}}}}function Ne(e){const t=L.value[e],a=F.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,o=n===t?Object.entries(L.value).some(([t,a])=>t!==e&&a.job===n?.job&&K.value.includes(t)):F.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:o}}function Ie(e){oe.value[0].table.unshift(e)}function Re(e){0!==se.value&&(oe.value[0].duration=Ee(e-se.value),oe.value[0]=v(oe.value[0]),se.value=0,ue.friendly={},ue.enemy={},ke={},_e())}function De(e){const t=[],a=new Set;F.value.forEach(e=>a.add(e.id)),K.value.forEach(e=>a.add(e)),S.value&&a.add(S.value);const n=[];for(const i of a){const e=F.value.find(e=>e.id===i);if(e){n.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const t=L.value[i];t&&n.push({id:i,job:t.job,name:t.name??"Unknown",level:999})}const o=new Map;n.forEach(e=>{o.set(e.job,(o.get(e.job)||0)+1)});for(const i of n){const a=i.level||999,n=(o.get(i.job)||0)>1;for(const o of he)if(o.job.includes(i.job)&&o.minLevel<=a){const s=Z(o.id,a),l=Z(o.recast1000ms,a),r=ke[i.id]?.[s]??0;let c=!0,u=0;if(r>0){const t=e-r,a=1e3*l;t<a&&(c=!1,u=Math.ceil((a-t)/1e3))}t.push({id:s,name:B(s)||"Unknown",icon:ne(s),recast1000ms:l,recastLeft:u,ready:c,ownerId:i.id,ownerName:i.name,ownerJob:i.job,hasDuplicate:n})}}return t}async function _e(){if($.value)return;const e=oe.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?A(e.table):[];return{...A(e),table:t}});await we.replaceAll(e)}function Ee(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function xe(){k.value=!k.value}function Te(){oe.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:"test",timestamp:Date.now()}),G.value=0}function Ae(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`}return I(()=>{const e=R({storageKey:"keigenn-record-2-theme"}),t=D(e);!1===e.value&&t();for(const a in L.value){const e=L.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(L.value,a)}!async function(){G.value=0;try{const e=await we.getAll();e.length&&(oe.value.length=0,oe.value.push(...e.filter(e=>e.timestamp>Date.now()-2592e5).sort((e,t)=>e.timestamp-t.timestamp).reverse()),0===oe.value.length&&oe.value.push({zoneName:"",duration:"00:00",table:N([]),key:"init",timestamp:-1}))}catch(e){throw oe.value.length=0,e}}(),be("LogLine",e=>{Ce(e.rawLine)}),be("PartyChanged",e=>{F.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),be("ChangePrimaryPlayer",e=>{S.value=Number(e.charID).toString(16).toUpperCase()}),be("CombatData",e=>{if(!(se.value>0)&&"true"===e.isActive){e.Encounter?.CurrentZoneName&&(le.value=e.Encounter.CurrentZoneName);const t=(e.Encounter?.duration||"00:00").split(":").map(Number);let a=0;3===t.length?a=1e3*(3600*t[0]+60*t[1]+t[2]):2===t.length&&(a=1e3*(60*t[0]+t[1]));const n=Date.now()-a;0!==oe.value[0].table.length&&oe.value.unshift({zoneName:"",duration:"00:00",table:N([]),key:String(n),timestamp:n}),oe.value[0].zoneName=le.value,se.value=n,oe.value[0].timestamp=n,oe.value[0].key=String(n),G.value=0}})}),(e,n)=>{const v=me,y=de,$=ge,C=We,N=t;return i(),r(m,null,[l("div",{class:"wrapper",style:j({"--scale":d(h).scale,"--opacity":d(h).opacity}),onContextmenu:n[1]||(n[1]=T(()=>{},["prevent"]))},[l("header",null,[l("div",Ze,[_(f(y,{modelValue:d(G),"onUpdate:modelValue":n[0]||(n[0]=e=>x(G)?G.value=e:null),size:"small",class:g(["combat-select",d(u).isBrowser?"browser":"act"]),"popper-class":"combat-select-popup",offset:0,"show-arrow":!1},{default:s(()=>[(i(!0),r(m,null,b(d(oe).length,e=>(i(),o(v,{key:`${d(oe)[e-1].key}-${d(oe)[e-1].duration}-${d(oe)[e-1].zoneName}`,value:e-1,label:`${d(oe)[e-1].zoneName}${""===d(oe)[e-1].zoneName?"":` - [${d(oe)[e-1].duration}] ${Ae(d(oe)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[E,!d(k)]])]),d(u).isBrowser?c("",!0):(i(),o($,{key:0,class:g(["minimize",d(k)?"in-minimize":"not-minimize"]),icon:d(k)?d(fe):d(pe),circle:"",style:j({opacity:d(k)?.5:1}),onClick:xe},null,8,["class","icon","style"]))]),_(l("main",Je,[f(C,{rows:d(oe)[d(G)].table,"action-key":d(w)},null,8,["rows","action-key"])],512),[[E,!d(k)]])],36),d(u).isBrowser||d(a)?(i(),r("div",Be,[d(a)?(i(),o($,{key:0,onClick:Te},{default:s(()=>[...n[2]||(n[2]=[p(" æµ‹è¯• ",-1)])]),_:1})):c("",!0),f(N,{"m-1":"",onBeforeHandle:je,onAfterHandle:$e,onHandleLine:Ce})])):c("",!0)],64)}}}),[["__scopeId","data-v-1a694622"]]);export{Ue as default};
