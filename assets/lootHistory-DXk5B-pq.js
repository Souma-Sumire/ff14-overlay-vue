import{_ as e,a as l}from"./shared-common-CeUyZiRZ.js";import{o as a,t,H as s,L as n,M as o,Z as i,X as r,c as u,i as c,I as d,u as v,A as p,K as m,J as y,R as f,am as g,a9 as h,Y as w,v as b,r as k,bH as _,G as V,bA as S,B as C,D as x,a5 as M,$,V as E,_ as O,O as B,ba as D,W as R,p as T}from"./vendor-vue-iK2zA9mI.js";import{e as P,a9 as z,n as U,A as L,aa as A,ab as j,K as I,I as N,ac as W,F,q as Y,ad as H,ae as J,b as K,af as q,ag as G,ah as X,ai as Q,aj as Z,ak as ee,Y as le,J as ae,al as te,j as se,a as ne,E as oe,am as ie,k as re,an as ue,D as ce,ao as de,u as ve,ap as pe,N as me,O as ye,aq as fe,c as ge,d as he,M as we,ar as be,L as ke,as as _e,g as Ve,at as Se,au as Ce,G as xe,H as Me,av as $e,l as Ee,aw as Oe,ax as Be,ay as De,az as Re,aA as Te,aB as Pe,aC as ze,V as Ue,T as Le,aD as Ae}from"./vendor-element-plus-ICQGukrc.js";import{J as je,K as Ie,L as Ne,N as We,O as Fe,R as Ye,P as He,Q as Je,S as Ke,T as qe,W as Ge,X as Xe,Y as Qe,$ as Ze,a0 as el,a1 as ll,a2 as al,a3 as tl,a4 as sl,a5 as nl,a6 as ol,a7 as il,a8 as rl}from"./shared-core-w2Ysp_jo.js";import{u as ul,s as cl,i as dl,a as vl,b as pl,c as ml,d as yl,e as fl,f as gl,g as hl,h as wl,j as bl}from"./vendor-echarts-Clei42CN.js";import"./cactbot-Bq2Gp82n.js";const kl=e(a({__name:"RoleBadge",props:{role:{},large:{type:Boolean}},setup(e){const l=e,a=u(()=>je(l.role)),c=u(()=>l.role?Ie(l.role):"");return(l,u)=>e.role?(t(),s("span",{key:0,class:o(["role-badge",{"badge-large":e.large}]),style:n({backgroundColor:a.value})},i(c.value),7)):r("",!0)}}),[["__scopeId","data-v-c41a273e"]]),_l=e(a({__name:"PlayerDisplay",props:{name:{},role:{},showOnlyRole:{type:Boolean},nameClass:{}},setup(e){const l=c("getDisplayName",e=>e);return(a,n)=>(t(),s("div",{class:o(["player-display",{"is-large":e.showOnlyRole}])},[d(kl,{role:e.role,large:e.showOnlyRole,class:"role-icon"},null,8,["role","large"]),e.showOnlyRole&&e.role?r("",!0):(t(),s("span",{key:0,class:o(["player-name-text",e.nameClass])},i(v(l)(e.name)),3))],2))}}),[["__scopeId","data-v-6da251ba"]]),Vl={class:"bis-allocator"},Sl={class:"bis-toolbar"},Cl={key:0,class:"dot-warn"},xl={key:0,class:"bis-view-panel"},Ml={class:"table-container"},$l={class:"bis-table"},El={class:"premium-header-player"},Ol=["onClick"],Bl={key:0},Dl={class:"col-macro"},Rl={class:"macro-header-content"},Tl={class:"header-left"},Pl=["rowspan"],zl={class:"sticky-col col-item row-header"},Ul={class:"equip-cell-content"},Ll={class:"tooltip-title"},Al={class:"tooltip-player-list"},jl=["onClick"],Il={class:"player-option-item"},Nl={key:0,class:"tooltip-divider"},Wl=["onClick"],Fl={class:"cell-status-container"},Yl={class:"status-text-wrapper"},Hl={class:"status-main"},Jl={key:0,class:"status-meta"},Kl={class:"popover-content"},ql={class:"reason-section"},Gl={class:"obtained-list"},Xl={class:"item-name"},Ql={class:"item-count"},Zl={key:1,class:"obtained-empty"},ea=["rowspan"],la={class:"macro-preview-box"},aa={class:"macro-preview-content"},ta=["innerHTML"],sa=["onClick"],na={key:1,class:"bis-onboarding"},oa={class:"onboarding-card"},ia={class:"icon-circle"},ra={class:"bis-config-panel-container"},ua={class:"bis-config-header-row"},ca={class:"bis-storage-info"},da={class:"planned-weeks-config"},va={key:0,class:"validation-alerts"},pa={class:"alert-msg"},ma={class:"table-scroll-wrapper"},ya={class:"bis-table config-table"},fa={class:"vert-header"},ga={class:"header-action-area"},ha={key:0,class:"incomplete-label"},wa={class:"preset-apply-zone"},ba=["title"],ka={key:2},_a={class:"preset-item-content"},Va={class:"preset-item-content"},Sa=["onClick"],Ca={class:"expand-action"},xa={class:"preset-item-content"},Ma={key:0,class:"split-cell"},$a=["onClick"],Ea=["onClick"],Oa={key:1,class:"count-cell"},Ba={class:"count-wrapper"},Da={class:"dialog-footer"},Ra={class:"footer-left"},Ta={class:"footer-right"},Pa={class:"config-status-msg"},za={key:0},Ua={key:0,class:"import-empty-msg"},La={key:1,class:"import-diff-container"},Aa={class:"import-summary"},ja={class:"diff-header"},Ia={key:0,class:"diff-tag"},Na={key:1,class:"diff-tag update"},Wa={class:"diff-items"},Fa={class:"diff-label"},Ya={class:"diff-values"},Ha={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},Ja={key:0,class:"import-diff-container"},Ka={class:"import-summary"},qa={class:"diff-card"},Ga={class:"diff-header"},Xa={key:0,class:"diff-tag"},Qa={key:1,class:"diff-tag update"},Za={class:"diff-items"},et={class:"diff-label"},lt={class:"diff-values"},at={class:"dialog-footer",style:{"justify-content":"flex-end",gap:"12px"}},tt={class:"bis-config-panel-container"},st={class:"bis-storage-info"},nt={class:"table-scroll-wrapper"},ot={class:"bis-table config-table"},it={class:"correction-input-wrapper"},rt={class:"dialog-footer",style:{"justify-content":"flex-end"}},ut=e(a({__name:"BisAllocator",props:{players:{},records:{},modelValue:{},getPlayerRole:{type:Function},getActualPlayer:{type:Function},showOnlyRole:{type:Boolean},getItemSlot:{type:Function}},emits:["update:modelValue"],setup(e,{emit:l}){const a=e,n=l,c=k({}),_=k(!1),V=k(new Set),S=k({}),C=k({playerBis:{},plannedWeeks:8,manualObtained:{}}),x=k(!1),M=k(!1),$=k(!1),E=k([]),O=k(null),B=k(void 0),D={pass:{text:"放弃",class:"status-pass"},need:{text:"需求",class:"status-need"},greed:{text:"贪婪",class:"status-greed-tome"},assigned:{text:"分配",class:"status-assigned"}},R=u(()=>Ke.map(e=>{const l=e.items.map(e=>He.find(l=>l.id===e)).filter(e=>!!e);return{name:e.name,rows:l}})),T=u(()=>{const e=qe;return[...He].filter(e=>"random_weapon"!==e.id).sort((l,a)=>{const t=e.indexOf(l.keywords),s=e.indexOf(a.keywords);return-1===t&&-1===s?0:-1===t?1:-1===s?-1:t-s})}),ie=u(()=>a.players.filter(ze)),re=k(new Set),ue=u(()=>{for(const e of Ye)if(!Ne(C.value,e))return!1;return!0}),ce=u(()=>Ye.filter(e=>!Ne(C.value,e)).length),de=u(()=>{const e=[],l=C.value.plannedWeeks||8;return[{id:"coating",name:"硬化药"},{id:"twine",name:"强化纤维"},{id:"tome",name:"神典石"},{id:"solvent",name:"强化药"}].forEach(a=>{let t=0;ie.value.forEach(e=>{t+=Ie(e,a.id)}),t>l&&e.push({id:a.id,type:"warning",message:`${a.name}: 总需求(${t}) 大于 计划周数(${l})，这是不可能的分配。`})}),e});function ve(){const e=new Date;return{weekNum:ge(),dateStr:`${e.getMonth()+1}月${e.getDate()}日`}}function pe(){const{weekNum:e,dateStr:l}=ve(),a=[`/p <${l} 第${e}周分配优先级>`];R.value.forEach(e=>{a.push(...me(e.rows))});const t=a.join("\n");t&&navigator.clipboard.writeText(t).then(()=>{ne.success(`已复制全层宏 (共${a.length}行)`)}).catch(()=>{ne.error("复制失败")})}function me(e){const l=[];return e.forEach(e=>{if("random_weapon"===e.id)return;const t=[],s=[];if(S.value[e.id]){const t=S.value[e.id];let s=a.getPlayerRole?.(t)||t;return s=s.replace(/^LEFT:/,"").trim(),void l.push(`/p ${e.name}：${s} (队长分配)`)}ie.value.forEach(l=>{if(V.value.has(l))return;let n=a.getPlayerRole?.(l)||l;n=n.replace(/^LEFT:/,"").trim();const o=Be(l,e);"need"===o?t.push(n):"greed"===o&&s.push(n)});let n="";n=t.length>0?t.join("、"):s.length>0?s.join("、"):"随便ROLL",l.push(`/p ${e.name}：${n}`)}),l}function ye(e){let l=e.replace(/^(\/p)\s+/,'<span class="macro-cmd">$1</span> ').replace(/^(.+?)：/,'<span class="macro-item">$1</span>：');return l=l.replace(/\b(MT|ST)\b/g,'<span class="role-tank">$1</span>'),l=l.replace(/\b(H1|H2)\b/g,'<span class="role-healer">$1</span>'),l=l.replace(/\b(D[1-4])\b/g,'<span class="role-dps">$1</span>'),l}function fe(e){const{weekNum:l,dateStr:a}=ve();return[`/p <${a} 第${l}周 ${e.name}分配>`,...me(e.rows)]}function ge(){return a.records&&0!==a.records.length?Je(a.records.map(e=>e.timestamp)):1}function he(e){return Object.values(S.value).includes(e)}function we(e){if(!a.getPlayerRole)return e;const l=a.getPlayerRole(e);return!l||l.startsWith("LEFT:")||l.startsWith("SUB:")?e:l}function be(){const e=Ye.filter(e=>!!C.value.playerBis[e]).map(e=>{const l=He.map(l=>{const a=C.value.playerBis[e]?.[l.id];return"toggle"===l.type?"raid"===a?"1":"0":"number"==typeof a&&a>0?"1":"0"}).join(""),a=Number.parseInt(l,2).toString(36);return`${e}:${a}`}).join(";");navigator.clipboard.writeText(e).then(()=>{ne.success("BIS 设置已复制到剪贴板")})}function ke(){oe.prompt("请粘贴 BIS 设置字符串","导入 BIS 设置",{confirmButtonText:"下一步",cancelButtonText:"取消",inputType:"textarea",inputPlaceholder:"在此粘贴...",customClass:"bis-import-message-box",inputValidator:e=>{if(!e)return"内容不能为空";const l=e.trim().split(";").filter(e=>e.trim());if(0===l.length)return"格式错误：无法识别有效的分隔符";let a=0;for(const t of l){if(t.startsWith("weeks:"))continue;const e=t.split(":");if(2!==e.length)return`数据格式错误："${t.slice(0,10)}..."`;const[l,s]=e;if(!s||!/^[0-9a-z]+$/i.test(s))return`数据校验失败：职位 "${l||"未知"}" 的设置已损坏`;Ye.includes(l)&&a++}return 0!==a||"未找到匹配当前团队的有效设置数据"}}).then(e=>{const{value:l}=e;l&&function(e){try{const l=e.trim();if(!l)throw new Error("输入内容为空");const t=l.split(";").filter(e=>e.trim());if(0===t.length)throw new Error("无效的格式");const s=[];if(B.value=void 0,t.forEach(e=>{if(e.startsWith("weeks:")){const l=Number.parseInt(e.split(":")[1]||"0");return void(Number.isNaN(l)||(B.value=l))}const l=e.split(":");if(2!==l.length)return;const t=l[0],n=l[1];if(!t||!n||!Ye.includes(t))return;const o=ie.value.filter(e=>a.getPlayerRole?.(e)===t)[0]||t,i=Number.parseInt(n,36).toString(2).padStart(He.length,"0"),r={};He.forEach((e,l)=>{const a=i[l];"toggle"===e.type?r[e.id]="1"===a?"raid":"tome":r[e.id]="1"===a?1:0});const u=C.value.playerBis[t]||{},c=[];let d=!1;He.forEach(e=>{const l=u[e.id],a=r[e.id],t=_e(e,l),s=_e(e,a);t!==s&&(d=!0,c.push({label:e.name,oldVal:t,newVal:s}))}),d&&s.push({name:o,role:t,isNew:0===Object.keys(u).length,changes:c,newConfig:r})}),0===s.length)return void ne.info("未检测到有效的设置变更。");E.value=s,M.value=!0}catch(l){ne.error(l.message||"解析失败")}}(l)}).catch(()=>{})}function _e(e,l){if("toggle"===e.type)return"raid"===l?"零式":"tome"===l?"点数":"未设置";if("number"!=typeof l)throw new Error(`[BisAllocator] 数据异常: ${e.name} 应为数字，实际为 ${l}`);return l.toString()}function Ve(e){return"零式"===e?"is-raid":"点数"===e?"is-tome":""}function Se(){!function(){const e={...C.value.playerBis};E.value.forEach(l=>{e[l.role]={...e[l.role],...l.newConfig}}),C.value.playerBis=e,void 0!==B.value&&(C.value.plannedWeeks=B.value);M.value=!1,ne.success(`成功更新 ${E.value.length} 个职位的配置`)}()}function Ce(e,l,a){const t=we(e);C.value.playerBis[t]||(C.value.playerBis[t]={});C.value.playerBis[t][l]===a?delete C.value.playerBis[t][l]:C.value.playerBis[t][l]=a}function xe(){if(!O.value?.diff)return;const{player:e,preset:l,diff:a}=O.value,t=we(e);C.value.playerBis[t]||(C.value.playerBis[t]={}),Object.assign(C.value.playerBis[t],a.newConfig),$.value=!1,O.value=null,ne.success(`已应用预设: ${l.name} (${e})`)}function Me(e,l){if(!a.records)return 0;const t=l.keywords.replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);if(0===t.length)return 0;const s=a.records.filter(s=>(a.getActualPlayer?a.getActualPlayer(s.player):s.player)===e&&("random_weapon"===l.id&&a.getItemSlot?"随武"===a.getItemSlot(s.item):t.some(e=>s.item.includes(e)))).length,n=we(e),o=C.value.manualObtained?.[n]?.[l.id]||0;return Math.max(0,s+o)}function $e(e,l){if(!a.records)return[];const t={};if("random_weapon"===l.id&&a.getItemSlot)a.records.forEach(l=>{(a.getActualPlayer?a.getActualPlayer(l.player):l.player)===e&&"随武"===a.getItemSlot(l.item)&&(t[l.item]=(t[l.item]||0)+1)});else{const s=l.keywords.replace(/，/g,",").split(",").map(e=>e.trim()).filter(Boolean);a.records.forEach(l=>{(a.getActualPlayer?a.getActualPlayer(l.player):l.player)===e&&s.some(e=>l.item.includes(e))&&(t[l.item]=(t[l.item]||0)+1)})}return Object.entries(t).map(([e,l])=>({name:e,count:l}))}function Ee(e,l){const a=we(e);return C.value.manualObtained?.[a]?.[l]||0}function Oe(e,l){if("random_weapon"===l.id){return`累计获得 ${Me(e,l)} 个随武`}return De(e,l).reason}function Be(e,l){return De(e,l).status}function De(e,l){const a=S.value[l.id];if(a)return a===e?{status:"assigned",reason:"队长指定分配 (最高优先级)"}:{status:"pass",reason:"队长已指定给他人"};if(V.value.has(e))return{status:"pass",reason:"玩家已请假/被排除"};if(["coating","twine","tome","solvent"].includes(l.id)&&"count"===l.type){const a=ie.value.map(e=>{if(V.value.has(e))return{p:e,status:"pass",obtained:1/0};const a=Ie(e,l.id),t=Me(e,l);return{p:e,status:t>=a?"pass":"need",obtained:t}}).filter(e=>!V.value.has(e.p));if(0===a.length)return Re(e,l);if(a.every(e=>"pass"===e.status)){const l=Math.min(...a.map(e=>e.obtained)),t=a.find(l=>l.p===e);return t?t.obtained===l?{status:"greed",reason:`全员需求满足，作为获得最少者 (${t.obtained}个) 兜底贪婪`}:{status:"pass",reason:`全员需求满足，但不是获得最少者 (${t.obtained} > ${l})`}:{status:"pass",reason:"未知错误/无效玩家"}}return Re(e,l)}return Re(e,l)}function Re(e,l){const a=Me(e,l);if("count"===l.type){const t=Ie(e,l.id);return a>=t?{status:"pass",reason:`已获得 ${a} 个 (需求 ${t} 个)`}:{status:"need",reason:`需求 ${t} 个，当前 ${a} 个`}}if(function(e,l){return Me(e,l)>0}(e,l))return{status:"pass",reason:"已获得该装备"};return"raid"===Ae(e,l.id)?{status:"need",reason:"BIS 设为“零式” (需求，未获得)"}:{status:"greed",reason:"BIS 设为“点数” (贪婪，未获得)"}}function Te(e,l){return function(e,l){return Re(e,l).status}(e,l)}function Pe(e,l){const a=Be(e,l);return D[a]?.text||""}function ze(e){if(!a.getPlayerRole)return!1;const l=a.getPlayerRole(e);return!!l&&(!l.startsWith("LEFT:")&&!l.startsWith("SUB:"))}function Ue(e){const l=a.getPlayerRole?.(e);if(!l)return null;const t=we(e),s=C.value.playerBis[t];if(!s||0===Object.keys(s).length)return null;const{recommended:n,others:o}=Fe(l),i=[...n,...o];for(const a of i){let e=!0;for(const l of Object.keys(a.config))if(s[l]!==a.config[l]){e=!1;break}if(e)return a.name}return null}function Le(e){const l=a.getPlayerRole?.(e),t=Fe(l);return t.recommended.length>0||t.others.length>0}function Ae(e,l){return C.value.playerBis[we(e)]?.[l]}function je(e,l){return"tome"===Ae(e,l)}function Ie(e,l){if("random_weapon"===l)return 0;const a=Ae(e,l);if("number"!=typeof a)throw new Error(`[BisAllocator] 数据异常: ${e} 在 ${l} 的值应为数字，实际为 ${a}`);return a}function Ge(e,l){if("random_weapon"===l.id){const a=0===Me(e,l)?"status-need":"status-rw-obtained";return V.value.has(e)?`${a} is-excluded`:a}const a=Be(e,l),t=D[a]?.class||"";return V.value.has(e)?`${t} is-excluded`:t}p(()=>a.modelValue,e=>{if(!e)return;let l;if(function(e){if(!e||"object"!=typeof e||!e.playerBis)return!1;const l=Object.keys(e.playerBis)[0];return!!l&&Array.isArray(e.playerBis[l])}(e)){const a={playerBis:{},plannedWeeks:8,manualObtained:{}},t=JSON.parse(JSON.stringify(e));Object.keys(t.playerBis).forEach(e=>{a.playerBis[e]={};const l=t.playerBis[e];l&&l.forEach(l=>{a.playerBis[e]&&(a.playerBis[e][l]="raid")})}),l=a}else{const a=e;l={...a,plannedWeeks:a.plannedWeeks??8,manualObtained:a.manualObtained??{},playerBis:JSON.parse(JSON.stringify(a.playerBis||{}))}}ie.value.forEach(e=>{const a=we(e);l.playerBis[a]||(l.playerBis[a]={});const t=l.playerBis[a];He.filter(e=>"count"===e.type).forEach(e=>{"number"!=typeof t[e.id]&&(t[e.id]=1)})}),JSON.stringify(l)!==JSON.stringify(C.value)&&(C.value=l)},{immediate:!0,deep:!0}),p(ie,e=>{e.forEach(e=>{const l=we(e);C.value.playerBis[l]||(C.value.playerBis[l]={});const a=C.value.playerBis[l];He.filter(e=>"count"===e.type).forEach(e=>{"number"!=typeof a[e.id]&&(a[e.id]=1)})})},{deep:!0,immediate:!0}),p(C,e=>{JSON.stringify(e)!==JSON.stringify(a.modelValue)&&n("update:modelValue",e)},{deep:!0});const Xe=We;return(l,n)=>{const u=P,p=U,k=I,B=Y,oe=K,ge=Z,Be=Q,De=G,Re=le,ze=ae,We=se;return t(),s("div",Vl,[m("div",Sl,[d(p,{size:"small",type:"primary",plain:"",class:"setup-trigger-btn",onClick:n[0]||(n[0]=e=>_.value=!0)},{default:y(()=>[d(u,{style:{"margin-right":"4px"}},{default:y(()=>[d(v(z))]),_:1}),n[12]||(n[12]=m("span",null,"设置 BIS",-1)),ue.value?r("",!0):(t(),s("span",Cl))]),_:1}),d(p,{size:"small",plain:"",class:"setup-trigger-btn",onClick:n[1]||(n[1]=e=>x.value=!0)},{default:y(()=>[d(u,{style:{"margin-right":"4px"}},{default:y(()=>[d(v(L))]),_:1}),n[13]||(n[13]=m("span",null,"野队获取修正",-1))]),_:1})]),ue.value?(t(),s("div",xl,[m("div",Ml,[m("table",$l,[m("colgroup",null,[n[14]||(n[14]=m("col",{style:{width:"32px !important","min-width":"32px !important"}},null,-1)),n[15]||(n[15]=m("col",{style:{width:"110px !important","min-width":"110px !important"}},null,-1)),(t(!0),s(f,null,g(ie.value,e=>(t(),s("col",{key:e}))),128)),n[16]||(n[16]=m("col",{style:{width:"250px !important","min-width":"250px !important"}},null,-1))]),m("thead",null,[m("tr",null,[n[21]||(n[21]=m("th",{class:"sticky-col col-combined-header",style:{"z-index":"30"},colspan:"2"}," 装备 \\ 玩家 ",-1)),(t(!0),s(f,null,g(ie.value,l=>(t(),s("th",{key:l,class:o({"is-excluded":V.value.has(l)})},[m("div",El,[d(_l,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),m("div",{class:o(["leave-tag-trigger",{"is-away":V.value.has(l),"is-disabled":he(l)}]),onClick:h(e=>{return he(l)?null:(a=l,void(V.value.has(a)?V.value.delete(a):V.value.add(a)));var a},["stop"])},[V.value.has(l)?(t(),s("span",Bl,"已请假")):(t(),s(f,{key:1},[d(u,{style:{"margin-right":"2px"}},{default:y(()=>[d(v(A))]),_:1}),n[17]||(n[17]=m("span",null,"请假",-1))],64))],10,Ol)])],2))),128)),m("th",Dl,[m("div",Rl,[m("div",Tl,[n[19]||(n[19]=m("div",{class:"title-with-icon"},[m("span",null,"分配宏")],-1)),d(k,{placement:"top",title:"分配宏生成规则",width:320,trigger:"hover"},{reference:y(()=>[d(u,{class:"macro-help-icon",style:{margin:"0"}},{default:y(()=>[d(v(j))]),_:1})]),default:y(()=>[n[18]||(n[18]=m("div",{class:"macro-help-content"},[m("div",{class:"intro"}," 生成可以直接在游戏内发送的分配宏（/p）。 "),m("div",{class:"rule-item"},[m("strong",null,"1. 优先需求"),m("span",null,"仅显示BIS设为“零式”且尚未获得的玩家。")]),m("div",{class:"rule-item"},[m("strong",null,"2. 次选贪婪"),m("span",null,"若无需求者，显示其余尚未获得的玩家。")]),m("div",{class:"rule-item"},[m("strong",null,"3. 兜底机制"),m("span",null,"若全员不需要，显示“随便ROLL”。")])],-1))]),_:1})]),d(p,{link:"",type:"primary",size:"small",class:"copy-full-text-btn",onClick:pe},{default:y(()=>[d(u,null,{default:y(()=>[d(v(N))]),_:1}),n[20]||(n[20]=m("span",null,"复制全部",-1))]),_:1})])])])]),m("tbody",null,[(t(!0),s(f,null,g(R.value,(l,p)=>(t(),s(f,{key:l.name},[(t(!0),s(f,null,g(l.rows,(b,_)=>(t(),s("tr",{key:b.id,class:o({"is-layer-end":_===l.rows.length-1})},[0===_?(t(),s("td",{key:0,rowspan:l.rows.length,class:o(["sticky-col col-layer layer-cell",{"is-last-layer-cell":p===R.value.length-1}])},i(l.name),11,Pl)):r("",!0),m("td",zl,[m("div",Ul,[m("span",null,i(b.name),1),d(B,{visible:c.value[b.id],"onUpdate:visible":e=>c.value[b.id]=e,placement:"right",trigger:"click","popper-class":"captain-player-tooltip-new",effect:"dark",offset:15,"hide-after":0},{content:y(()=>[m("div",Ll,[n[22]||(n[22]=w(" 将 ",-1)),m("span",null,i(b.name),1),n[23]||(n[23]=w(" 分配给 ",-1))]),m("div",Al,[(t(!0),s(f,null,g(ie.value,l=>(t(),s("div",{key:l,class:o(["tooltip-player-item",{"is-disabled":V.value.has(l),"is-active":S.value[b.id]===l}]),onClick:e=>!V.value.has(l)&&(S.value[b.id]=l)},[m("div",Il,[d(_l,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),m("span",{class:o(["mini-status-tag",[Te(l,b)]])},i(D[Te(l,b)].text),3)])],10,jl))),128)),S.value[b.id]?(t(),s("div",Nl)):r("",!0),S.value[b.id]?(t(),s("div",{key:1,class:"tooltip-player-item clear-btn",onClick:e=>S.value[b.id]=""},[d(u,null,{default:y(()=>[d(v(F))]),_:1}),n[24]||(n[24]=m("span",null,"取消分配",-1))],8,Wl)):r("",!0)])]),default:y(()=>[m("div",{class:o(["assign-tag-trigger",{"is-active":S.value[b.id],"is-open":c.value[b.id]}])},[S.value[b.id]?(t(),s(f,{key:0},[d(_l,{name:S.value[b.id],role:a.getPlayerRole?.(S.value[b.id]),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),n[25]||(n[25]=m("span",{class:"p-status"},"已分配",-1))],64)):(t(),s(f,{key:1},[d(u,{style:{"margin-right":"2px"}},{default:y(()=>[d(v(W))]),_:1}),n[26]||(n[26]=m("span",null,"分配",-1))],64))],2)]),_:2},1032,["visible","onUpdate:visible"])])]),(t(!0),s(f,null,g(ie.value,e=>(t(),s("td",{key:e,class:o(Ge(e,b))},[m("div",Fl,[d(k,{placement:"auto",trigger:"hover","popper-class":"bis-common-popover",width:"auto","show-after":0,"hide-after":0,transition:"none"},{reference:y(()=>[m("div",Yl,["random_weapon"===b.id?(t(),s("span",{key:0,class:o([Me(e,b)>0?"rw-simple-count-active":"rw-simple-count-none",{"is-many":Me(e,b)>=2}])},i(Me(e,b)),3)):(t(),s(f,{key:1},[m("span",Hl,i(Pe(e,b)),1),"count"===b.type&&Ie(e,b.id)>1?(t(),s("span",Jl," ("+i(Me(e,b))+"/"+i(Ie(e,b.id))+") ",1)):r("",!0)],64))])]),default:y(()=>[m("div",Kl,[m("div",ql,i(Oe(e,b)),1),$e(e,b).length>0?(t(),s(f,{key:0},[n[27]||(n[27]=m("div",{class:"popover-divider"},null,-1)),m("div",Gl,[(t(!0),s(f,null,g($e(e,b),(e,l)=>(t(),s("div",{key:l,class:"obtained-row"},[m("span",Xl,i(e.name),1),m("span",Ql,"x"+i(e.count),1)]))),128))])],64)):"random_weapon"===b.id?(t(),s("div",Zl," 未获得过 ")):r("",!0)])]),_:2},1024)])],2))),128)),0===_?(t(),s("td",{key:1,rowspan:l.rows.length,class:o(["col-macro macro-cell",{"is-last-layer-cell":p===R.value.length-1}])},[m("div",la,[m("div",aa,[(t(!0),s(f,null,g(fe(l).slice(1),(e,l)=>(t(),s("div",{key:l,class:"macro-preview-line",innerHTML:ye(e)},null,8,ta))),128))]),m("div",{class:"macro-copy-action",onClick:h(e=>function(e){if("all"===e)return void pe();const{weekNum:l,dateStr:a}=ve(),t=[`/p <${a} 第${l}周 ${e.name}分配优先级>`];t.push(...me(e.rows));const s=t.join("\n"),n=`已复制 ${e.name} 分配宏`;s&&navigator.clipboard.writeText(s).then(()=>{ne.success(n)}).catch(()=>{ne.error("复制失败")})}(l),["stop"])},[d(u,null,{default:y(()=>[d(v(N))]),_:1})],8,sa)])],10,ea)):r("",!0)],2))),128))],64))),128))])])]),n[28]||(n[28]=m("div",{class:"logic-note"}," * 注：当某物品所有有效玩家都判定为放弃时，系统会自动找出“已获得数量最少”的玩家（可能有多人），将其状态改为贪婪 (Greed)。 ",-1))])):(t(),s("div",na,[m("div",oa,[m("div",ia,[d(u,null,{default:y(()=>[d(v(H))]),_:1})]),n[30]||(n[30]=m("h3",null,"开启 BIS 分配",-1)),n[31]||(n[31]=m("p",null,"尚未设置团队成员的 BIS，无法生成分配推荐。",-1)),d(p,{type:"primary",size:"large",onClick:n[2]||(n[2]=e=>_.value=!0)},{default:y(()=>[...n[29]||(n[29]=[w(" 立即开始设置 ",-1)])]),_:1})])])),d(ze,{modelValue:_.value,"onUpdate:modelValue":n[5]||(n[5]=e=>_.value=e),width:"auto","append-to-body":"",class:"bis-config-dialog","destroy-on-close":"","align-center":""},{footer:y(()=>[m("div",Da,[m("div",Ra,[d(Re,null,{default:y(()=>[d(p,{size:"small",onClick:be},{default:y(()=>[...n[38]||(n[38]=[w(" 导出 BIS 设置 ",-1)])]),_:1}),d(p,{size:"small",onClick:ke},{default:y(()=>[...n[39]||(n[39]=[w(" 导入 BIS 设置 ",-1)])]),_:1})]),_:1})]),m("div",Ta,[m("div",Pa,[ce.value>0?(t(),s("span",za," 还剩 "+i(ce.value)+" 个职位的 BIS 尚未填完 ",1)):r("",!0)]),d(p,{type:"primary",size:"small",onClick:n[4]||(n[4]=e=>_.value=!1)},{default:y(()=>[...n[40]||(n[40]=[w(" 完成并关闭 ",-1)])]),_:1})])])]),default:y(()=>[m("div",ra,[m("div",ua,[m("div",ca,[d(u,null,{default:y(()=>[d(v(J))]),_:1}),n[32]||(n[32]=m("span",null,"提示：此 BIS 设置跟随职位（MT/ST等），不跟随具体玩家。",-1))]),m("div",da,[n[33]||(n[33]=m("span",{class:"label"},"你们计划清几周CD：",-1)),d(oe,{modelValue:C.value.plannedWeeks,"onUpdate:modelValue":n[3]||(n[3]=e=>C.value.plannedWeeks=e),min:1,max:16,size:"small","controls-position":"right",class:"weeks-stepper"},null,8,["modelValue"])])]),de.value.length>0?(t(),s("div",va,[(t(!0),s(f,null,g(de.value,e=>(t(),s("div",{key:e.id,class:o(["validation-alert",[e.type]])},[d(u,{class:"alert-icon"},{default:y(()=>["info"===e.type?(t(),b(v(J),{key:0})):(t(),b(v(q),{key:1}))]),_:2},1024),m("span",pa,i(e.message),1)],2))),128))])):r("",!0),m("div",ma,[m("table",ya,[m("thead",null,[m("tr",null,[n[37]||(n[37]=m("th",{class:"sticky-col"}," 装备 \\ 玩家 ",-1)),(t(!0),s(f,null,g(ie.value,l=>(t(),s("th",{key:l,class:o([{"header-incomplete":!v(Ne)(C.value,we(l))},{"is-excluded":V.value.has(l)},v(Xe)(e.getPlayerRole?.(l))])},[m("div",fa,[d(_l,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),m("div",ga,[v(Ne)(C.value,we(l))?r("",!0):(t(),s("span",ha,"未填写")),m("div",wa,[Le(l)?(t(),b(De,{key:0,trigger:"click","popper-class":"bis-preset-popper",onCommand:e=>function(e,l){const t=we(e),s=C.value.playerBis[t]||{},n={...l.config},o=[];if(He.forEach(e=>{if("random_weapon"===e.id)return;const l=s[e.id],a=n[e.id],t=_e(e,l),i=_e(e,a);t!==i&&o.push({label:e.name,oldVal:t,newVal:i})}),0===o.length)return void ne.info("当前设置与预设相同，无需更改");const i={name:e,role:a.getPlayerRole?.(e)||"Unknown",isNew:0===Object.keys(s).length,changes:o,newConfig:n};O.value={player:e,preset:l,diff:i},$.value=!0}(l,e),onVisibleChange:e=>!e&&re.value.delete(l)},{dropdown:y(()=>[d(Be,{class:"bis-preset-dropdown"},{default:y(()=>[(t(!0),s(f,null,g(v(Fe)(e.getPlayerRole?.(l)).recommended,e=>(t(),b(ge,{key:e.name,command:e},{default:y(()=>[m("div",_a,[d(u,null,{default:y(()=>[d(v(X))]),_:1}),m("span",null,i(e.name),1)])]),_:2},1032,["command"]))),128)),0===v(Fe)(e.getPlayerRole?.(l)).recommended.length?(t(!0),s(f,{key:0},g(v(Fe)(e.getPlayerRole?.(l)).others,e=>(t(),b(ge,{key:e.name,command:e},{default:y(()=>[m("div",Va,[d(u,null,{default:y(()=>[d(v(X))]),_:1}),m("span",null,i(e.name),1)])]),_:2},1032,["command"]))),128)):v(Fe)(e.getPlayerRole?.(l)).others.length>0?(t(),s(f,{key:1},[re.value.has(l)?(t(!0),s(f,{key:1},g(v(Fe)(e.getPlayerRole?.(l)).others,(e,l)=>(t(),b(ge,{key:e.name,command:e,divided:0===l},{default:y(()=>[m("div",xa,[d(u,null,{default:y(()=>[d(v(X))]),_:1}),m("span",null,i(e.name),1)])]),_:2},1032,["command","divided"]))),128)):(t(),s("div",{key:0,class:"preset-expand-divider",onClick:h(e=>re.value.add(l),["stop"])},[n[35]||(n[35]=m("div",{class:"divider-line"},null,-1)),m("div",Ca,[n[34]||(n[34]=m("span",null,"更多同职能预设",-1)),d(u,null,{default:y(()=>[d(v(ee))]),_:1})]),n[36]||(n[36]=m("div",{class:"divider-line"},null,-1))],8,Sa))],64)):r("",!0)]),_:2},1024)]),default:y(()=>[d(p,{size:"small",class:o(["preset-btn",{"is-matched":Ue(l)}])},{default:y(()=>[Ue(l)?r("",!0):(t(),b(u,{key:0,class:"magic-icon"},{default:y(()=>[d(v(X))]),_:1})),Ue(l)?(t(),s("span",{key:1,class:"matched-name-inline",title:Ue(l)??""},i(Ue(l)),9,ba)):(t(),s("span",ka,"一键预设"))]),_:2},1032,["class"])]),_:2},1032,["onCommand","onVisibleChange"])):r("",!0)])])])],2))),128))])]),m("tbody",null,[(t(!0),s(f,null,g(T.value,e=>(t(),s("tr",{key:e.id},[m("td",{class:o(["sticky-col row-header",[{"is-group-end":"weapon"===e.id||"feet"===e.id||"ring"===e.id}]])},i(e.name),3),(t(!0),s(f,null,g(ie.value,l=>{return t(),s("td",{key:l,class:o(["split-cell-container",[{"is-group-end":"weapon"===e.id||"feet"===e.id||"ring"===e.id}]])},["toggle"===e.type?(t(),s("div",Ma,[m("div",{class:o(["half-cell left-raid",{active:(a=l,n=e.id,"raid"===Ae(a,n))}]),onClick:a=>Ce(l,e.id,"raid")}," 零式 ",10,$a),m("div",{class:o(["half-cell right-tome",{active:je(l,e.id)}]),onClick:a=>Ce(l,e.id,"tome")}," 点数 ",10,Ea)])):(t(),s("div",Oa,[m("div",Ba,[d(oe,{"model-value":Ie(l,e.id),min:0,max:8,size:"small","controls-position":"right",class:"mini-stepper","onUpdate:modelValue":a=>function(e,l,a){const t=we(e);C.value.playerBis[t]||(C.value.playerBis[t]={}),C.value.playerBis[t][l]=a}(l,e.id,a||0)},null,8,["model-value","onUpdate:modelValue"])])]))],2);var a,n}),128))]))),128))])])])])]),_:1},8,["modelValue"]),d(ze,{modelValue:M.value,"onUpdate:modelValue":n[7]||(n[7]=e=>M.value=e),title:"确认导入 BIS 设置",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:y(()=>[m("div",Ha,[d(p,{onClick:n[6]||(n[6]=e=>M.value=!1)},{default:y(()=>[...n[41]||(n[41]=[w(" 取消 ",-1)])]),_:1}),d(p,{type:"primary",disabled:0===E.value.length,onClick:Se},{default:y(()=>[...n[42]||(n[42]=[w(" 确认应用 ",-1)])]),_:1},8,["disabled"])])]),default:y(()=>[0===E.value.length?(t(),s("div",Ua," 没有检测到有效的变更数据。 ")):(t(),s("div",La,[m("p",Aa," 检测到 "+i(E.value.length)+" 位玩家的设置变更。 ",1),(t(!0),s(f,null,g(E.value,l=>(t(),s("div",{key:l.name,class:"diff-card"},[m("div",ja,[d(_l,{name:l.name,role:l.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),l.isNew?(t(),s("span",Ia,"新设置")):(t(),s("span",Na,"更新"))]),m("div",Wa,[(t(!0),s(f,null,g(l.changes,(e,l)=>(t(),s("div",{key:l,class:"diff-row"},[m("span",Fa,i(e.label),1),m("div",Ya,[m("span",{class:o(["val old",Ve(e.oldVal)])},i(e.oldVal),3),d(u,null,{default:y(()=>[d(v(te))]),_:1}),m("span",{class:o(["val new",Ve(e.newVal)])},i(e.newVal),3)])]))),128))])]))),128))]))]),_:1},8,["modelValue"]),d(ze,{modelValue:$.value,"onUpdate:modelValue":n[9]||(n[9]=e=>$.value=e),title:"确认预设变更",width:"600px","append-to-body":"","destroy-on-close":"","align-center":""},{footer:y(()=>[m("div",at,[d(p,{onClick:n[8]||(n[8]=e=>$.value=!1)},{default:y(()=>[...n[43]||(n[43]=[w(" 取消 ",-1)])]),_:1}),d(p,{type:"primary",onClick:xe},{default:y(()=>[...n[44]||(n[44]=[w(" 确认应用 ",-1)])]),_:1})])]),default:y(()=>[O.value?.diff?(t(),s("div",Ja,[m("p",Ka," 应用 ["+i(O.value.preset.name)+"] 将会产生以下变更： ",1),m("div",qa,[m("div",Ga,[d(_l,{name:O.value.diff.name,role:O.value.diff.role,"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"]),O.value.diff.isNew?(t(),s("span",Xa,"新设置")):(t(),s("span",Qa,"更新"))]),m("div",Za,[(t(!0),s(f,null,g(O.value.diff.changes,(e,l)=>(t(),s("div",{key:l,class:"diff-row"},[m("span",et,i(e.label),1),m("div",lt,[m("span",{class:o(["val old",Ve(e.oldVal)])},i(e.oldVal),3),d(u,null,{default:y(()=>[d(v(te))]),_:1}),m("span",{class:o(["val new",Ve(e.newVal)])},i(e.newVal),3)])]))),128))])])])):r("",!0)]),_:1},8,["modelValue"]),d(ze,{modelValue:x.value,"onUpdate:modelValue":n[11]||(n[11]=e=>x.value=e),title:"野队已获得数修正",width:"auto","append-to-body":"","destroy-on-close":"","align-center":""},{footer:y(()=>[m("div",rt,[d(p,{type:"primary",size:"small",onClick:n[10]||(n[10]=e=>x.value=!1)},{default:y(()=>[...n[47]||(n[47]=[w(" 完成 ",-1)])]),_:1})])]),default:y(()=>[m("div",tt,[m("div",st,[d(u,null,{default:y(()=>[d(v(J))]),_:1}),n[45]||(n[45]=m("span",null,"此处记录玩家在固定队记录之外（如野队）获得的装备。最终统计 = 掉落记录数 + 野队修正数。",-1))]),m("div",nt,[m("table",ot,[m("thead",null,[m("tr",null,[n[46]||(n[46]=m("th",{class:"sticky-col"}," 装备 \\ 玩家 ",-1)),(t(!0),s(f,null,g(ie.value,l=>(t(),s("th",{key:l,class:o([{"is-header-away":V.value.has(l)},v(Xe)(e.getPlayerRole?.(l))])},[d(_l,{name:l,role:e.getPlayerRole?.(l),"show-only-role":e.showOnlyRole},null,8,["name","role","show-only-role"])],2))),128))])]),m("tbody",null,[(t(!0),s(f,null,g(T.value,e=>(t(),s("tr",{key:e.id},[m("td",{class:o(["sticky-col row-header",[{"is-group-end":"weapon"===e.id||"feet"===e.id||"ring"===e.id}]])},i(e.name),3),(t(!0),s(f,null,g(ie.value,l=>(t(),s("td",{key:l,class:o(["count-cell",[{"is-group-end":"weapon"===e.id||"feet"===e.id||"ring"===e.id}]])},[m("div",it,[d(We,{"model-value":Ee(l,e.id)||0,size:"small",class:o(["mini-input correction-input",{"is-nonzero":0!==Ee(l,e.id)}]),onInput:a=>function(e,l,a){const t=we(e);C.value.manualObtained||(C.value.manualObtained={}),C.value.manualObtained[t]||(C.value.manualObtained[t]={}),C.value.manualObtained[t][l]=a}(l,e.id,parseInt(a)||0)},null,8,["model-value","class","onInput"])])],2))),128))]))),128))])])])])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-1c86f80f"]]),ct={class:"chart-container"},dt={class:"chart-body"},vt=e(a({__name:"ChartPlayerDistribution",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=e,a=_({storageKey:"loot-history-theme"}),n=c("getDisplayName",e=>e);ul([dl,vl,pl,ml,yl,fl]);const o=u(()=>{const e=l.playerVisibility,t=new Map;l.players.forEach(e=>t.set(e,0)),l.records.forEach(e=>{const a=l.getActualPlayer?l.getActualPlayer(e.player):e.player;t.has(a)&&t.set(a,(t.get(a)||0)+1)});const s=l.players.map(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0,s=t.get(e)||0;return{name:n(e),value:s,role:a?Ie(a):""}}),o=s.map(e=>e.name),i=s.map(e=>e.value),r=new Map;return l.players.forEach(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;a&&r.set(e,a)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0],a=l.name,t=r.get(a);return`${t?`[${t}] `:""}${a}<br/>获取数量: <b>${l.value}</b>`}},grid:{left:"2%",right:"2%",bottom:"10%",top:"10%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=l.players.find(l=>n(l)===e),t=a?r.get(a):void 0;return Xe(e,t,l.playerVisibility)},rich:Ge(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",minInterval:1,splitLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"获取数量",type:"bar",barWidth:"50%",data:i,itemStyle:{color:e=>{const l=e.name,a=r.get(l);return je(a)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",color:a.value?"#f1f5f9":"#1e293b"}}]}});return(e,l)=>(t(),s("div",ct,[l[0]||(l[0]=m("div",{class:"chart-header"},[m("div",{class:"chart-title"}," 获取数量统计 ")],-1)),m("div",dt,[d(v(cl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:v(a)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),[["__scopeId","data-v-29ada4cb"]]),pt={class:"chart-container"},mt={class:"chart-body"},yt=e(a({__name:"ChartRollLuck",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},playerVisibility:{}},setup(e){const l=e,a=_({storageKey:"loot-history-theme"}),n=c("getDisplayName",e=>e);ul([dl,vl,gl,pl,ml,yl,fl,hl]);const o=u(()=>{const e=l.playerVisibility,t=new Map;l.players.forEach(e=>t.set(e,[])),l.records.forEach(e=>{e.rolls.forEach(e=>{if(("need"===e.type||"greed"===e.type)&&null!==e.value){const a=l.getActualPlayer?l.getActualPlayer(e.player):e.player;t.has(a)&&t.get(a).push(e.value)}})});const s=l.players.map(e=>{const a=t.get(e)||[],s=a.length,o=a.reduce((e,l)=>e+l,0),i=s>0?o/s:0,r=s>0?Math.max(...a):0,u=s>0?Math.min(...a):0,c=l.getPlayerRole?l.getPlayerRole(e):void 0;return{name:n(e),value:i,min:u,max:r,count:s,role:c||"",formattedRole:c?Ie(c):""}}),o=s.map(e=>e.name),i=s.map(e=>e.value),r=new Map,u=new Map;return s.forEach(e=>{r.set(e.name,e.formattedRole),u.set(e.name,e)}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:e=>{const l=e[0].name,a=u.get(l);if(!a)return"";let t=`${a.formattedRole?`[${a.formattedRole}] `:""}<b>${l}</b><br/>`;return 0===a.count?t+='<span style="color:#999">无数据</span>':(t+=`平均点数: <b>${a.value.toFixed(1)}</b><br/>`,t+=`最高点数: ${a.max}<br/>`,t+=`最低点数: ${a.min}<br/>`,t+=`Roll点次数: ${a.count}`),t}},grid:{left:"5%",right:"2%",bottom:"10%",top:"10%"},xAxis:{type:"category",data:o,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=l.players.find(l=>n(l)===e),t=a?u.get(n(a))?.role:void 0;return Xe(e,t,l.playerVisibility)},rich:Ge(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"},axisLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.1)":"#e2e8f0"}}},yAxis:{type:"value",min:0,max:100,name:"平均点数",splitLine:{lineStyle:{color:a.value?"rgba(255,255,255,0.06)":"#f1f5f9"}},axisLabel:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"平均Roll点",type:"bar",barWidth:"50%",data:i,itemStyle:{color:e=>{const l=u.get(e.name);return je(l?.role)},borderRadius:[4,4,0,0]},label:{show:!0,position:"top",formatter:e=>e.value>0?e.value.toFixed(1):"",color:a.value?"#f1f5f9":"#1e293b"},markLine:{silent:!0,data:[{type:"average",name:"平均"}],symbol:"none",lineStyle:{color:a.value?"rgba(255,255,255,0.4)":"#999",type:"dashed"},label:{position:"start",formatter:"{b}",color:a.value?"#94a3b8":"#64748b",padding:[0,4,0,4],backgroundColor:"transparent"}}}]}});return(e,l)=>(t(),s("div",pt,[l[0]||(l[0]=m("div",{class:"chart-header"},[m("div",{class:"chart-title"}," Roll 点运气统计 ")],-1)),m("div",mt,[d(v(cl),{class:"echarts-instance",option:o.value,"update-options":{notMerge:!0},theme:v(a)?"dark":"",autoresize:""},null,8,["option","theme"])])]))}}),[["__scopeId","data-v-7bd64de0"]]),ft={class:"chart-container"},gt=e(a({__name:"ChartWeeklyTrend",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup(e){const l=e,a=_({storageKey:"loot-history-theme"}),o=c("getDisplayName",e=>e);ul([dl,wl,pl,ml,bl,fl]);const i=u(()=>l.syncStartDate?el(new Date(l.syncStartDate)):null);const r=k(400),p=u(()=>{const e=new Map,a=new Map;l.records.forEach(t=>{const{label:s,sortKey:n}=function(e){const a=l.recordWeekCorrections?.[e.key]||0,{label:t}=Qe(e.timestamp,a),{label:s,index:n}=Ze(t,i.value);return{label:l.syncStartDate?`第 ${n} 周`:t,fullLabel:s,sortKey:n}}(t);e.set(s,n);const o=l.getActualPlayer?l.getActualPlayer(t.player):t.player;if(!l.players.includes(o))return;a.has(s)||a.set(s,new Map);const r=a.get(s);r.has(o)||r.set(o,{count:0,items:[]});const u=r.get(o);u.count++,u.items.push(t.item)});const t=Array.from(e.entries()).sort((e,l)=>e[1]-l[1]).map(e=>e[0]),s=l.players.map(e=>o(e)),n=[];t.forEach((e,t)=>{s.forEach((s,o)=>{const i=l.players[o],r=a.get(e)?.get(i),u=r?r.count:0;n.push({value:[o,t,u],items:r?r.items:[]})})});const r=40*t.length+120,u=Math.max(300,r);return{xData:s,sortedWeeks:t,seriesData:n,height:u}});V(()=>{r.value=p.value.height});const y=u(()=>{const e=l.playerVisibility,{xData:t,sortedWeeks:s,seriesData:n}=p.value,o=new Map;return l.players.forEach(e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;a&&o.set(e,Ie(a))}),{backgroundColor:"transparent",animation:!1,title:{show:!1,text:e},tooltip:{position:"top",formatter:e=>{const l=e.data,a=l.value[2],n=t[l.value[0]],i=s[l.value[1]],r=n?o.get(n):void 0;return`<b>${i}</b><br/>\n                <b>${r?`[${r}]`:""} ${n}</b><br/>\n                获取数量: ${a}<br/>\n                <hr style="margin:4px 0;opacity:0.3"/>\n                ${l.items&&l.items.length>0?l.items.map(e=>`• ${e}`).join("<br/>"):'<span style="color:#94a3b8;font-style:italic">无掉落</span>'}`}},grid:{top:40,bottom:"2%",left:"2%",right:"2%"},xAxis:{position:"bottom",type:"category",data:t,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{interval:0,rotate:0,formatter:e=>{const a=l.getPlayerRole?l.getPlayerRole(e):void 0;return Xe(e,a,l.playerVisibility)},rich:Ge(l.playerVisibility),color:a.value?"#e2e8f0":"#64748b"}},yAxis:{type:"category",data:s,inverse:!1,splitArea:{show:!0},axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:12,color:a.value?"#e2e8f0":"#64748b"}},visualMap:{min:0,max:8,calculable:!1,orient:"horizontal",right:0,top:0,itemWidth:15,itemHeight:15,type:"piecewise",pieces:[{value:0,color:a.value?"#1b1c26":"#f8fafc",label:"无"},{value:1,color:a.value?"#450a0a":"#fff7ed",label:"1"},{value:2,color:a.value?"#7f1d1d":"#ffedd5",label:"2"},{value:3,color:a.value?"#b91c1c":"#fed7aa",label:"3"},{value:4,color:a.value?"#c2410c":"#fdba74",label:"4"},{value:5,color:a.value?"#ea580c":"#f97316",label:"5"},{value:6,color:a.value?"#f97316":"#ea580c",label:"6"},{value:7,color:a.value?"#facc15":"#c2410c",label:"7"},{min:8,color:a.value?"#fef08a":"#9a3412",label:"8+"}],textStyle:{color:a.value?"#94a3b8":"#64748b"}},series:[{name:"每周获取",type:"heatmap",data:n,label:{show:!0,formatter:e=>e.value[2]>0?e.value[2]:"",color:"inherit"},itemStyle:{borderRadius:4,borderColor:a.value?"#252632":"#fff",borderWidth:2},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.4)"}}}]}});return(e,l)=>(t(),s("div",ft,[l[0]||(l[0]=m("div",{class:"chart-header"},[m("div",{class:"chart-title"}," 每周获取热力图 ")],-1)),m("div",{class:"chart-body",style:n({height:`${r.value}px`})},[d(v(cl),{class:"echarts-instance",option:y.value,"update-options":{notMerge:!0},theme:v(a)?"dark":"",autoresize:""},null,8,["option","theme"])],4)]))}}),[["__scopeId","data-v-9bb906ba"]]),ht={class:"stats-panel"},wt={class:"charts-grid"},bt=e(a({__name:"LootStatisticsPanel",props:{records:{},players:{},getActualPlayer:{type:Function},getPlayerRole:{type:Function},recordWeekCorrections:{},syncStartDate:{},playerVisibility:{}},setup:e=>(l,a)=>(t(),s("div",ht,[m("div",wt,[d(vt,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),d(yt,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","player-visibility"]),d(gt,{records:e.records,players:e.players,"get-actual-player":e.getActualPlayer,"get-player-role":e.getPlayerRole,"record-week-corrections":e.recordWeekCorrections,"sync-start-date":e.syncStartDate,"player-visibility":e.playerVisibility},null,8,["records","players","get-actual-player","get-player-role","record-week-corrections","sync-start-date","player-visibility"])])]))}),[["__scopeId","data-v-4166085a"]]),kt={class:"filter-segmented"},_t=e(a({__name:"LootDisplayFilterSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function n(e){a("update:modelValue",e)}return(l,a)=>(t(),s("div",kt,[m("div",{class:o(["segment-item",{"is-active":"obtained"===e.modelValue}]),onClick:a[0]||(a[0]=e=>n("obtained"))}," 已获得 ",2),m("div",{class:o(["segment-item",{"is-active":"needed"===e.modelValue}]),onClick:a[1]||(a[1]=e=>n("needed"))}," 尚未获得 ",2),m("div",{class:o(["segment-item",{"is-active":"all"===e.modelValue}]),onClick:a[2]||(a[2]=e=>n("all"))}," 全部显示 ",2)]))}}),[["__scopeId","data-v-349b7683"]]),Vt={class:"mr-content"},St={key:0,class:"mr-val"},Ct=e(a({__name:"LootPlayerRoll",props:{roll:{},isWinner:{type:Boolean},showOnlyRole:{type:Boolean},getPlayerRole:{type:Function}},setup(e){const l=e,a=u(()=>l.getPlayerRole(l.roll.player)),n=u(()=>`type-${l.roll.type}`),c=u(()=>ll(l.roll.type)),v=u(()=>"assign"!==l.roll.type&&"direct"!==l.roll.type),p=u(()=>"assign"===l.roll.type||"direct"===l.roll.type||"replace"===l.roll.type);return(l,u)=>(t(),s("div",{class:o(["mini-roll",[n.value,{"winner-badge":e.isWinner}]])},[d(_l,{name:e.roll.player,role:a.value,"show-only-role":e.showOnlyRole,class:"mr-display"},null,8,["name","role","show-only-role"]),m("div",Vt,[m("span",{class:o(["mr-type",[n.value,{"type-full-width":p.value}]])},i(c.value),3),v.value&&"replace"!==e.roll.type?(t(),s("span",St,i(null!==e.roll.value?e.roll.value:"-"),1)):r("",!0)])],2))}}),[["__scopeId","data-v-a077e4c2"]]),xt={class:"sort-segmented"},Mt=e(a({__name:"LootSortSegmented",props:{modelValue:{}},emits:["update:modelValue"],setup(e,{emit:l}){const a=l;function n(e){a("update:modelValue",e)}return(l,a)=>(t(),s("div",xt,[m("div",{class:o(["segment-item",{"is-active":"part"===e.modelValue}]),onClick:a[0]||(a[0]=e=>n("part"))}," 按装备部位顺序 ",2),m("div",{class:o(["segment-item",{"is-active":"drop"===e.modelValue}]),onClick:a[1]||(a[1]=e=>n("drop"))}," 按零式掉落顺序 ",2)]))}}),[["__scopeId","data-v-65a13aa0"]]),$t={class:"summary-item-right"},Et={key:0,class:"random-weapon-tag"},Ot={key:0,class:"bis-tag"},Bt={key:1,class:"non-bis-tag"},Dt={key:2,class:"layer-tag"},Rt={class:"rw-tooltip-list"},Tt={class:"rw-tip-name"},Pt={class:"rw-tip-count"},zt=e(a({__name:"SummaryItemTags",props:{item:{}},setup:e=>(l,a)=>{const n=Y;return t(),s("div",$t,[e.item.isRandomWeapon?(t(),s("span",Et,"随武")):(t(),s(f,{key:1},[e.item.isBis?(t(),s("span",Ot,"毕业")):!1===e.item.isBis?(t(),s("span",Bt,"副职")):r("",!0)],64)),e.item.layerName?(t(),s("span",Dt,i(e.item.layerName),1)):r("",!0),e.item.isRandomWeapon&&e.item.details&&e.item.details.length?(t(),b(n,{key:3,effect:"dark",placement:"top","show-after":200,"popper-class":"rw-tooltip-popper"},{content:y(()=>[m("div",Rt,[(t(!0),s(f,null,g(e.item.details,(e,l)=>(t(),s("div",{key:l,class:"rw-tip-row"},[m("span",Tt,i(e.name),1),m("span",Pt,"x"+i(e.count),1)]))),128))])]),default:y(()=>[m("span",{class:o(["count-badge cursor-help",[e.item.count>1?"count-many":0===e.item.count?"count-none":"count-single"]])}," x"+i(e.item.count),3)]),_:1})):(t(),s("span",{key:4,class:o(["count-badge",[e.item.count>1?"count-many":0===e.item.count?"count-none":"count-single"]])}," x"+i(e.item.count),3))])}}),[["__scopeId","data-v-4ccde0c7"]]);function Ut(e){return new Worker("/ff14-overlay-vue/assets/logParser-L30y0Ugj.js",{name:e?.name})}const Lt={key:0,class:"initial-loading"},At={class:"skeleton-layout"},jt={class:"skeleton-page-main"},It={class:"skeleton-content-grid"},Nt={key:0,class:"loading-overlay"},Wt={class:"loading-card-wide"},Ft={class:"loading-header"},Yt={class:"loading-title"},Ht={class:"parsing-lists"},Jt={class:"list-col"},Kt={class:"list-head"},qt={class:"list-body"},Gt={class:"file-info-left"},Xt=["title"],Qt={class:"file-size"},Zt={class:"list-col"},es={class:"list-head"},ls={class:"list-body"},as={class:"file-info-left"},ts=["title"],ss={class:"file-size"},ns={key:0,class:"more-hint"},os={key:0,class:"app-main",style:{"padding-top":"10px"}},is={class:"control-bar",style:{position:"relative"}},rs={class:"path-toolbar"},us={class:"sync-btn-group"},cs={key:0,class:"dot-warn"},ds={class:"sync-status-container"},vs={class:"sync-hint-text is-success success-hint"},ps={class:"header-right"},ms={class:"guide-content-popover"},ys={class:"guide-section"},fs={class:"guide-section"},gs={class:"guide-section"},hs={class:"guide-section"},ws={class:"filter-panel"},bs={class:"filter-section"},ks={class:"sec-header"},_s={class:"sec-title-group"},Vs={class:"title-main"},Ss={key:0,class:"dot-warn"},Cs={class:"role-settings-content-popover"},xs={class:"role-grid"},Ms={class:"role-setup-label"},$s={class:"special-role-section"},Es={class:"special-role-group"},Os={class:"special-list"},Bs={key:0,class:"special-item"},Ds={class:"special-role-group"},Rs={class:"special-list"},Ts={key:0,class:"special-item"},Ps={class:"switch-box"},zs={class:"switch-container",style:{display:"inline-flex","align-items":"center",gap:"6px"}},Us={key:0,class:"header-sep"},Ls={class:"acts"},As={class:"popover-form"},js={class:"merge-selector-box"},Is={class:"merge-guide-desc"},Ns={class:"procedure-steps-compact"},Ws={class:"selector-tags"},Fs={key:0,class:"selection-badge hide"},Ys={key:1,class:"selection-badge show"},Hs={key:0,class:"merge-actions"},Js={key:0,class:"suggestion-box"},Ks={class:"suggest-items"},qs={class:"conf-text"},Gs={key:1,class:"mapping-box"},Xs={class:"mapping-list"},Qs={class:"map-from"},Zs={class:"map-to"},en={class:"sec-body",style:{position:"relative"}},ln={key:0,class:"section-mask"},an={class:"filter-section"},tn={class:"sec-header"},sn={class:"sec-title-group"},nn={class:"title-main"},on={class:"switch-box"},rn={class:"filter-popover"},un={class:"sec-body",style:{position:"relative"}},cn={key:0,class:"section-mask"},dn={class:"main-viewport",style:{position:"relative"}},vn={class:"list-container-el"},pn=["onClick","onContextmenu"],mn={key:0,class:"week-correction-display"},yn={class:"original-week"},fn={class:"corrected-week"},gn={key:1,class:"col-week"},hn={class:"col-time"},wn={key:1,class:"time-date"},bn={class:"col-item"},kn={class:"item-text"},_n=["onClick"],Vn={key:0,class:"correction-winner-display"},Sn={class:"original-row",title:"原始记录获得者"},Cn={class:"corrected-row"},xn={key:1,class:"no-winner"},Mn={class:"col-rolls"},$n={class:"pagination-box"},En={class:"tabs-sort-control"},On={class:"summary-grid has-sort-control"},Bn={class:"summary-header"},Dn=["title"],Rn={class:"tabs-sort-control"},Tn={class:"summary-grid slot-grid has-sort-control"},Pn={class:"summary-header"},zn={class:"s-right-group"},Un={class:"tabs-sort-control"},Ln={class:"week-content-wrapper"},An={class:"summary-header"},jn={class:"week-list-body"},In=["onContextmenu","onClick","onMouseenter"],Nn={class:"week-row-aside"},Wn={class:"week-row-main"},Fn={class:"week-item-name"},Yn={key:0,class:"week-list-divider"},Hn={style:{display:"flex","align-items":"center",gap:"4px"}},Jn={key:0,class:"dot-warn",style:{margin:"0"}},Kn={class:"bis-allocator-wrapper"},qn={class:"bis-lock-mask"},Gn={class:"lock-card"},Xn={class:"lock-header"},Qn={class:"lock-icon-wrapper"},Zn={class:"status-list"},eo={class:"item-icon"},lo={class:"item-icon"},ao={key:1,class:"empty-placeholder"},to={class:"empty-icon"},so={class:"empty-hint"},no={key:0,class:"winner-change-popover"},oo={class:"popover-header"},io={class:"select-player-row"},ro={key:0,class:"custom-context-menu"},uo={class:"menu-info-header"},co={class:"action-label"},vo={key:1,class:"empty-container"},po={class:"empty-placeholder compact-guide"},mo={key:0,class:"empty-guide-main",style:{position:"relative"}},yo={class:"empty-info-side"},fo={class:"empty-hint"},go={class:"empty-desc"},ho={class:"empty-highlight"},wo={class:"setup-form"},bo={class:"setup-row"},ko={class:"setup-row"},_o={class:"empty-hint",style:{"margin-top":"24px"}},Vo={key:2,class:"ready-state-container",style:{position:"relative",width:"100%",display:"flex","flex-direction":"column","align-items":"center"}},So={class:"empty-title"},Co={class:"empty-desc"},xo={class:"empty-hint"},Mo={key:0,class:"import-preview-box"},$o={class:"import-selection-list"},Eo={key:0,class:"import-not-found-hint"},Oo={key:0,class:"import-not-found-hint"},Bo={key:0,class:"import-not-found-hint"},Do={key:0,class:"import-not-found-hint"},Ro={class:"dialog-footer"},To={key:0,class:"clear-selection-list"},Po={class:"clear-selection-header"},zo={class:"clear-quick-actions"},Uo={class:"clear-danger-hint"},Lo={class:"dialog-footer"},Ao={class:"dialog-footer"},jo={key:0,class:"premium-correction-layout"},Io={class:"correction-sidebar"},No={class:"nav-icon"},Wo={class:"nav-content"},Fo={class:"nav-status"},Yo={class:"nav-icon"},Ho={class:"nav-content"},Jo={class:"nav-status"},Ko={class:"nav-icon"},qo={class:"nav-content"},Go={class:"nav-status"},Xo={class:"correction-main"},Qo={class:"main-header"},Zo={class:"correction-grid-wrapper scroll-thin"},ei={class:"card-main-row"},li={class:"item-primary-info"},ai=["title"],ti={class:"item-time"},si={class:"card-comparison-inline"},ni={class:"comp-box old"},oi={class:"value"},ii={key:1,class:"week-text"},ri={class:"comp-arrow"},ui={class:"comp-box new"},ci={class:"value"},di={key:1,class:"week-text"},vi={class:"card-actions"},pi={class:"card-main-row"},mi={class:"item-primary-info"},yi=["title"],fi={class:"item-time"},gi={class:"card-comparison-inline"},hi={class:"comp-box new"},wi={class:"value"},bi={class:"card-actions"},ki={key:2,class:"premium-empty"},_i={class:"early-access-disclaimer"},Vi="需在左上方“固定队 - 职位设置”中完成所有职位后方可开启",Si=e(a({__name:"lootHistory",setup(e){const a="2026-01-06T16:00",c="总冠军",_="装备掉落/拿装备记录",V="固定队职位设置",N="毕业装备需求 (BIS)",H="角色合并映射",K="手动修改过的CD周数",X="手动修改过的装备获得者",le="元数据（BIS/职位/合并映射）",se="修正项（周/获得者）",je="视图与过滤设置",Ie=sl("loot-history-records"),We=sl("loot-history-config"),Fe=sl("loot-history-handle"),Je=k(!0),Ge=k(!1),Xe=k(!1),ll=k(!1);p(Xe,e=>{!e&&ll.value&&(Xe.value=!0)});const ul=k(!1),cl=k(0),dl=k([]),vl=k([]),pl=B([]),ml=k(new Set),yl=k(new Set),fl=k({}),gl=k("summary"),hl=k(null),wl=k(!1),bl=k(!1),Vl=k({loot:!0,meta:!0,corrections:!0,view:!0}),Sl=k(null),Cl=k({timestamp:"",item:"",player:""}),xl=k(!1),Ml=k({loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0}),$l=k(!1),El=k({}),Ol=k({}),Bl=k({}),Dl=k(null),Rl=k(),Tl=k({}),Pl=k(null),zl=k(""),Ul=k(!1),Ll=k(!1),Al=k("player"),jl=k({playerBis:{}}),Il=u(()=>{if(!Ll.value)return[];const e=[],l=new Map(pl.value.map(e=>[e.key,e]));return Object.entries(Bl.value).forEach(([a,t])=>{const s=l.get(a);s&&e.push({key:a,type:"player",itemName:s.item,oldVal:s.player,newVal:t,record:s})}),e}),Nl=u(()=>{const e=new Map;return pl.value.forEach(l=>e.set(l.key,l)),e}),Wl=u(()=>{if(!Ll.value)return[];const e=[];return Object.entries(Ol.value).forEach(([l,t])=>{const s=Nl.value.get(l);if(!s)return;const n=nl(s.timestamp,a),o=n+t;e.push({key:l,type:"week",itemName:s.item,oldVal:`第 ${n} 周`,newVal:`第 ${o} 周`,record:s})}),e}),Fl=u(()=>Ll.value?pl.value.filter(e=>e.isManual):[]);const Yl=k("part"),Hl=k("part"),Jl=k("drop"),Kl=k("part"),ql=k({});function Gl(e){return ql.value&&ql.value[e]||e}function Xl(e){return Bl.value[e.key]||e.player}const Ql=k([]);function Zl(){2===Ql.value.length&&(aa(Ql.value[0],Ql.value[1]),Ql.value=[])}const ea=k("obtained"),la=k("obtained");function aa(e,l){e&&l&&(ql.value={...ql.value,[e]:l})}const ta=k(1),sa=k(""),na=k(""),oa=k(!1),ia=k({}),ra=k(a),ua=k(null),ca=k(!0),da=k(!1),va=k(!1),pa=["御敌","制敌","精准","治愈","强攻","强袭","游击","咏咒"].join("|"),ma=new RegExp(`${c}武器箱|${c}(?!${pa})|规格神典石|强化药|硬化药|强化纤维|神典石`),ya=new RegExp(`(?<series>.+)(${pa}).+`),fa=k(!1),ga=k(!1),ha=k({cards:!0,materia:!0,music:!0,book:!0,totem:!0,other:!0,maskedSeries:[]}),wa=k({});let ba=!1;const ka="1"===S("hash").demo,_a=k({}),Va=new Set,Sa=["阿尔菲诺","阿莉塞","桑克瑞德","雅修特拉","于里昂热","埃斯蒂尼安","琳","盖亚","芝诺斯","奥尔什方","艾默里克","塔塔露","可露儿","维涅斯","爱梅特赛尔克","希斯拉德","赫尔墨斯","法丹尼尔","嘉恩·艾","梅尔维布","劳班","比格斯","威奇","娜娜莫","莉瑟","飞燕","夕雾","豪雪","玛托雅","零","阿伦瓦尔德","露西亚","希尔达","克劳德","蒂法","爱丽丝","扎克斯","萨富罗斯","斯考尔","莉诺雅","吉坦","嘉妮特","提达","尤娜","梵","巴尔弗雷","芙兰","诺克提斯","露娜弗蕾亚","克莱夫","吉尔"];function Ca(e){if(!e)return"";if(!ka)return e;if(_a.value[e])return _a.value[e];const l=Sa.filter(e=>!Va.has(e));let a;return a=l.length>0?l[Math.floor(Math.random()*l.length)]:`匿名玩家 ${Object.keys(_a.value).length+1}`,_a.value[e]=a,Va.add(a),a}T("getDisplayName",Ca);const xa=(()=>{let e=null;return l=>{e&&clearTimeout(e),e=setTimeout(()=>{We.bulkSet(l)},500)}})(),Ma=new Map;p([fl,El,sa,ia,ra,ua,gl,ca,jl,ql,wa,fa,ga,ha,va,Ol,Bl,Yl,Hl,Jl,Kl,yl,ea,la],()=>{const e=[{key:"itemVisibility",value:fl.value},{key:"playerVisibility",value:El.value},{key:"weekCorrections",value:Ol.value},{key:"playerCorrections",value:Bl.value},{key:"logPath",value:sa.value},{key:"processedFiles",value:ia.value},{key:"syncStartDate",value:ra.value},{key:"syncEndDate",value:ua.value},{key:"viewMode",value:gl.value},{key:"isRaidFilterActive",value:ca.value},{key:"bisConfig",value:jl.value},{key:"hideUnselectedItems",value:ga.value},{key:"playerMapping",value:ql.value},{key:"playerRoles",value:wa.value},{key:"showOnlyRole",value:fa.value},{key:"isOnlyRaidMembersActive",value:va.value},{key:"systemFilterSettings",value:ha.value},{key:"summarySortMode",value:Yl.value},{key:"slotSortMode",value:Hl.value},{key:"weekSortMode",value:Jl.value},{key:"bisSortMode",value:Kl.value},{key:"playerSummaryFilterMode",value:ea.value},{key:"slotSummaryFilterMode",value:la.value},{key:"blacklistedKeys",value:Array.from(yl.value)}],l=[];for(const{key:a,value:t}of e){const e="object"==typeof t?JSON.stringify(t):String(t);Ma.get(a)!==e&&(l.push({key:a,value:"object"==typeof t?JSON.parse(e):t}),Ma.set(a,e))}l.length>0&&xa(l)},{deep:!0}),p([ra,ua],()=>{Je.value||(da.value=!0,Oi())});const $a=k(!1),Ea=u(()=>{if(Je.value)return{counts:{},sortedPlayers:[]};const e={},l=new Set;pl.value.forEach(a=>{const t=Gl(Xl(a));e[t]=(e[t]||0)+1,l.add(t),a.rolls.forEach(e=>l.add(Gl(e.player)))}),Object.values(wa.value).forEach(e=>{e&&l.add(Gl(e))});const a=Array.from(l).sort((l,a)=>Ui(l,a,e));return{counts:e,sortedPlayers:a}}),Oa=u(()=>Ea.value.counts),Ba=u(()=>Ea.value.sortedPlayers);p(va,e=>{if(e){const e={...El.value};Ba.value.forEach(l=>{Ii(l)?e[l]=!0:e[l]=!1}),El.value=e}});const Da=u(()=>{if(Je.value)return[];const e=new Date(ra.value).getTime(),l=ua.value?new Date(ua.value).getTime():1/0,a=fl.value;return pl.value.filter(t=>{if(Di(t.item))return!1;if(!1===a[t.item])return!1;const s=t.timestamp.getTime();return!(s<e||s>l)})}),Ra=u(()=>{const e="list"===gl.value;return Da.value.filter(l=>{const a=Gl(Xl(l));return!(!e&&!Ii(a))&&Ti(a)}).sort((e,l)=>l.timestamp.getTime()-e.timestamp.getTime())}),Ta=u(()=>{if(Je.value)return{};const e={};return Ra.value.forEach(l=>{const a=Gl(Xl(l)),t=l.item;e[a]||(e[a]={}),e[a][t]||(e[a][t]=0),e[a][t]++}),e}),Pa=u(()=>{if(Je.value)return[];const e=new Set(pl.value.filter(e=>!Di(e.item)).map(e=>e.item));return Array.from(e).sort((e,l)=>{const a=dt(e),t=dt(l);return a!==t?a-t:e.localeCompare(l)})}),za=u(()=>{const e=new Set,l={};Ra.value.forEach(e=>{const{label:a}=Qe(e.timestamp);l[a]||(l[a]=[]),l[a].push(e)});for(const a in l){const t=l[a],s={};t.forEach(e=>{s[e.item]||(s[e.item]=[]),s[e.item].push(e)});const n=[];for(const e in s){const l=s[e];if(l.length>1){l.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime());for(let e=0;e<l.length-1;e++){const a=l[e];l[e+1].timestamp.getTime()-a.timestamp.getTime()>3e5&&n.push(a.timestamp.getTime())}}}t.forEach(l=>{if(!ma.test(l.item))return;const a=l.timestamp,t=a.getDay(),s=a.getHours();if(2!==t)return;if(s<16||s>=19)return;const o=l.timestamp.getTime();n.some(e=>Math.abs(o-e)<=3e5)&&e.add(l.key)})}return e}),Ua=u(()=>Ye.every(e=>!!wa.value[e])),La=u(()=>va.value?Ba.value.filter(e=>!!Ii(e)):Ba.value);function Aa(){"visible"===document.visibilityState&&pl.value.length>0&&Oi()}C(async()=>{Je.value=!0;try{const[e,l,a]=await Promise.all([Ie.getAll(),We.getAll(),Fe.get("current-log-dir")]);let t=!1;const s=e.map(e=>{const l=al(e.item),a=tl(e.player),s=e.rolls.map(e=>({...e,player:tl(e.player)}));return(l!==e.item||a!==e.player||JSON.stringify(s)!==JSON.stringify(e.rolls))&&(t=!0),{...e,item:l,player:a,rolls:s,timestamp:new Date(e.timestamp)}});t&&await Ie.bulkSet(JSON.parse(JSON.stringify(s))),l.forEach(e=>{"itemVisibility"===e.key&&(fl.value=e.value),"playerVisibility"===e.key&&(El.value=e.value),"logPath"===e.key&&(sa.value=e.value),"processedFiles"===e.key&&(ia.value=e.value||{}),"weekCorrections"===e.key&&(Ol.value=e.value||{}),"playerCorrections"===e.key&&(Bl.value=e.value||{}),"syncStartDate"===e.key&&e.value&&(ra.value=e.value),"syncEndDate"===e.key&&(ua.value=e.value||null),"viewMode"===e.key&&(gl.value=e.value),"hideUnselectedItems"===e.key&&(ga.value=!!e.value),"playerMapping"===e.key&&(ql.value=e.value||{}),"playerRoles"===e.key&&(wa.value=e.value||{}),"showOnlyRole"===e.key&&(fa.value=!!e.value),"systemFilterSettings"===e.key&&e.value&&(ha.value={...ha.value,...e.value}),"isRaidFilterActive"===e.key&&(ca.value=!!e.value),"isOnlyRaidMembersActive"===e.key&&(va.value=!!e.value),"summarySortMode"===e.key&&(Yl.value=e.value||"part"),"slotSortMode"===e.key&&(Hl.value=e.value||"part"),"weekSortMode"===e.key&&(Jl.value=e.value||"drop"),"bisSortMode"===e.key&&(Kl.value=e.value||"part"),"blacklistedKeys"===e.key&&(yl.value=new Set(e.value||[])),"bisConfig"===e.key&&(jl.value=e.value||{playerBis:{}}),"playerSummaryFilterMode"===e.key&&(ea.value=e.value||"obtained"),"slotSummaryFilterMode"===e.key&&(la.value=e.value||"obtained")});if(l.some(e=>"syncInProgress"===e.key)){ia.value={};try{await We.remove("syncInProgress")}catch{}}if(a&&a.handle){hl.value=a.handle,na.value=a.handle.name;"granted"===await a.handle.queryPermission({mode:"read"})?ba=!0:sa.value="未授权，请点击同步按钮"}pl.value=s,ml.value=new Set(s.map(e=>e.key)),Ua.value||"list"===gl.value||(gl.value="list"),window.addEventListener("paste",Qa),document.body.addEventListener("dragover",Ka),document.body.addEventListener("dragleave",qa),document.body.addEventListener("drop",Ga),window.addEventListener("click",Za),window.addEventListener("keydown",nt),window.addEventListener("click",Ja),window.addEventListener("visibilitychange",Aa),pl.value.length>0&&setTimeout(()=>{Oi()},300),await x(),setTimeout(()=>{Je.value=!1},50)}catch(e){Je.value=!1}p([ca,Pa],([e])=>{e?(!function(){const e={};Pa.value.forEach(l=>{e[l]=ma.test(l)}),fl.value=e,0===pt.value&&(l=!0,Ba.value.forEach(e=>El.value[e]=l));var l}(),ga.value=!0):ga.value=!1},{immediate:!0}),p(Ua,e=>{!e&&va.value&&(va.value=!1),e||(gl.value="list")})});const ja=k(!1),Ia=k(!1);let Na=null;const Wa=k(!1),Fa=k(),Ya=k("");function Ha(){Wa.value=!1}function Ja(e){if(Dl.value){const l=document.querySelector(".winner-change-popper"),a=l?.contains(e.target),t=e.target.closest(".winner-selector-trigger");a||t||(Dl.value=null)}}function Ka(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer?.types.includes("Files")&&(ja.value=!0,Na&&(clearTimeout(Na),Na=null))}function qa(e){e.preventDefault(),Na&&clearTimeout(Na),Na=setTimeout(()=>{ja.value=!1,Ia.value=!1},100)}function Ga(e){if(e.preventDefault(),e.stopPropagation(),ja.value=!1,Ia.value=!1,Na&&(clearTimeout(Na),Na=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Zi(l)}}function Xa(e){if(e.preventDefault(),e.stopPropagation(),ja.value=!1,Ia.value=!1,Na&&(clearTimeout(Na),Na=null),e.dataTransfer&&e.dataTransfer.files.length>0){const l=e.dataTransfer.files[0];l&&l.name.endsWith(".json")&&Zi(l)}}async function Qa(e){const l=e.clipboardData?.getData("text");if(l)try{if(!l.trim().startsWith("{"))return;const a=JSON.parse(l);a.r&&Array.isArray(a.r)&&(e.preventDefault(),await Xi(a))}catch{}}function Za(){$a.value=!1}M(()=>{window.removeEventListener("paste",Qa),document.body.removeEventListener("dragover",Ka),document.body.removeEventListener("dragleave",qa),document.body.removeEventListener("drop",Ga),window.removeEventListener("click",Za),window.removeEventListener("keydown",nt),window.removeEventListener("visibilitychange",Aa),window.removeEventListener("click",Ja)});const et=u(()=>{if(Je.value||!Ge.value||0===pl.value.length)return new Map;const e=new Map;return pl.value.forEach(l=>{const a=new Set([l.player,...l.rolls.map(e=>e.player)]);a.forEach(l=>{e.has(l)||e.set(l,new Set);const t=e.get(l);a.forEach(e=>{e!==l&&t.add(e)})})}),e}),lt=u(()=>{if(Je.value||!Ge.value||0===et.value.size)return[];const e=[],l=Array.from(et.value.keys());for(let a=0;a<l.length;a++)for(let t=a+1;t<l.length;t++){const s=l[a],n=l[t];if(Gl(s)===Gl(n))continue;const o=et.value.get(s),i=et.value.get(n);if(o.size<3||i.size<3)continue;const r=new Set([...o].filter(e=>i.has(e))),u=new Set([...o,...i]),c=r.size/u.size;c>.9&&e.push({from:s,to:n,confidence:Math.round(100*c)})}return e.sort((e,l)=>l.confidence-e.confidence).slice(0,5)}),at=u(()=>{const e=new Set;return pl.value.forEach(l=>{if(ma.test(l.item))return;const a=l.item.match(ya);a?.groups?.series&&e.add(a.groups.series)}),Array.from(e).sort()}),tt=u(()=>new Set(Object.values(wa.value))),st=u(()=>!!Ua.value&&Ye.every(e=>Ne(jl.value,e)));function nt(e){const l=e.target,a=["INPUT","TEXTAREA"].includes(l.tagName)||l.isContentEditable;if("Escape"===e.key){if(Dl.value)return void(Dl.value=null);if($a.value)return void($a.value=!1);if(wl.value)return void(wl.value=!1);if(bl.value)return void(bl.value=!1);if(xl.value)return void(xl.value=!1);if($l.value)return void($l.value=!1)}a||e.ctrlKey||e.altKey||e.metaKey||e.shiftKey||("1"===e.key?gl.value="list":Ua.value&&("2"===e.key&&(gl.value="summary"),"3"===e.key&&(gl.value="slot"),"4"===e.key&&(gl.value="week"),"5"===e.key&&(gl.value="chart"),"6"===e.key&&(gl.value="bis")))}const ot=u(()=>{const e=new Set;pl.value.forEach(l=>{e.add(Gl(l.player))});const l=new Set;pl.value.forEach(e=>{l.add(e.player),e.rolls.forEach(e=>l.add(e.player))});const a=new Set(Object.keys(ql.value));return Array.from(l).filter(e=>{if(a.has(e))return!1;return Ti(Gl(e))}).sort((e,l)=>Ui(e,l,Oa.value))}),it=u(()=>{let e=La.value.filter(Ti);"needed"===ea.value&&(e=e.filter(e=>{const l=Ii(e);return l&&!l.startsWith("LEFT:")&&!l.startsWith("SUB:")}));const l=Ta.value,a={};return e.forEach(e=>{a[e]=Object.values(l[e]||{}).reduce((e,l)=>e+l,0)}),[...e].sort((e,l)=>Ui(e,l,a))}),rt=u(()=>ga.value?Pa.value.filter(Ri):Pa.value),ct=qe;function dt(e,l="part"){const a=("part"===l?qe:il).findIndex(l=>e.includes(l)||l.includes(e));return-1!==a?a:ma.test(e)?50:100}const vt=u(()=>rt.value.length),pt=u(()=>La.value.length),mt=u(()=>Da.value.map(e=>({...e,player:Xl(e)})));async function yt(e,l,a){if(e)if(Ba.value.includes(e))a();else{ll.value=!0;try{await oe.confirm(`玩家「${e}」在当前掉落记录中从未出现过。是否将其添加为${l}？`,"添加新玩家确认",{confirmButtonText:"确定添加",cancelButtonText:"取消",type:"warning",autofocus:!1,lockScroll:!1}),a()}catch{}finally{setTimeout(()=>{ll.value=!1},200)}}}async function ft(e,l){const a="SUB"===l?"替补成员":"离队成员";Object.entries(wa.value).some(([a,t])=>a.startsWith(`${l}:`)&&t===e)?ne.warning(`玩家「${e}」已经在${a}列表中了`):yt(e,a,()=>{const a=`${l}:${Date.now()}`;wa.value[a]=e})}function gt(e){const l=ct.find(l=>e.includes(l));return l||(e.includes(c)?"随武":"其他")}const ht=u(()=>{if(Je.value)return{};const e={};return ct.forEach(l=>{e[l]={}}),Ra.value.forEach(l=>{let a=gt(l.item);"其他"===a&&(a=l.item),e[a]||(e[a]={});const t=e[a],s=Gl(Xl(l));t[s]||(t[s]=0),t[s]++}),e}),wt=u(()=>{const e={};Ra.value.forEach(l=>{if("随武"===gt(l.item)){const a=Gl(Xl(l));e[a]||(e[a]={}),e[a][l.item]=(e[a][l.item]||0)+1}});const l={};for(const a in e)l[a]=Object.entries(e[a]).map(([e,l])=>({name:e,count:l}));return l}),kt=u(()=>{const e=la.value;return[...("part"===Hl.value?qe:il).filter(l=>{if("all"===e)return!0;if(ht.value[l]&&Object.keys(ht.value[l]).length>0)return!0;if("needed"===e){const e=He.find(e=>e.name===l||e.keywords===l);if(!e)return!1;return Object.keys(wa.value).filter(e=>!e.startsWith("LEFT:")&&!e.startsWith("SUB:")).some(l=>{const a=wa.value[l];if(!a)return!1;const t=Ta.value[a]||{},s=rl(e,t);return s<zi(e,a)||0===s})}return!1}),...Object.keys(ht.value).filter(e=>!qe.includes(e)&&!il.includes(e)).filter(e=>Object.keys(ht.value[e]||{}).length>0).sort((e,l)=>{const a=e=>Object.values(ht.value[e]||{}).reduce((e,l)=>e+l,0),t=a(e),s=a(l);return t!==s?s-t:e.localeCompare(l)})]});const Vt=u(()=>el(new Date(a)));function St(e){const{label:l}=Ze(e,Vt.value);return l}const xt=u(()=>{const e={};Ra.value.forEach(l=>{const t=function(e){const l=Ol.value[e.key]||0;return Qe(e.timestamp,l,a).label}(l);e[t]||(e[t]={});const s=Gl(Xl(l));e[t][s]||(e[t][s]=[]),e[t][s].push(l)});for(const l in e)for(const a in e[l]){const t=e[l][a];t&&t.sort((e,l)=>e.timestamp.getTime()-l.timestamp.getTime())}return e}),$t=u(()=>Object.keys(xt.value).sort().reverse());function Et(e){const l=xt.value[e];if(!l)return[];const a=[];return Object.values(l).forEach(e=>{a.push(...e)}),a.sort((e,l)=>{const a=dt(e.item,Jl.value),t=dt(l.item,Jl.value);if(a!==t)return a-t;const s=Ui(e.player,l.player);return 0!==s?s:e.timestamp.getTime()-l.timestamp.getTime()})}function Ot(e){const l=dt(e,Jl.value);return"drop"===Jl.value?l<=3?1:l<=8?2:l<=12?3:4:0===l?1:l<=5?2:l<=9?3:4}function Bt(e,l){if(l>=e.length-1)return!1;const a=e[l],t=e[l+1];if(!a||!t)return!1;return Ot(a.item)!==Ot(t.item)}const Dt=k(null),Rt=k({x:0,y:0}),Tt={getBoundingClientRect:()=>({width:0,height:0,top:Rt.value.y,bottom:Rt.value.y,left:Rt.value.x,right:Rt.value.x})};function Pt(e,l){e.preventDefault(),e.stopPropagation(),Dt.value=l,Rt.value={x:e.clientX,y:e.clientY},$a.value=!0}function Si(){Dt.value&&function(e){const l=Ol.value[e.key]||0,a={...Ol.value};l<0?delete a[e.key]:a[e.key]=-1,Ol.value=a}(Dt.value),$a.value=!1}p(()=>Dl.value,e=>{e||(Rl.value=null)});const Ci=u(()=>{const e=50*(ta.value-1);return Ra.value.slice(e,e+50)});function xi(){fl.value={},El.value={},ca.value=!1,ra.value=a,ua.value=null}async function Mi(){try{const e=window.showDirectoryPicker;if(!e)return void oe.alert("你的浏览器不支持此功能","错误",{confirmButtonText:"确定",type:"error"});const l=await e();l&&(await Ie.clear(),await We.set({key:"processedFiles",value:{}}),ia.value={},Ol.value={},pl.value=[],ml.value.clear(),fl.value={},El.value={},await Fe.set({key:"current-log-dir",handle:l}),hl.value=l,sa.value=l.name,na.value=l.name,$l.value=!0)}catch(e){e.name}}async function $i(e,l=!1){try{const a=pl.value.findIndex(l=>l.key===e.key);-1!==a&&pl.value.splice(a,1),await Ie.remove(e.key),ml.value.delete(e.key),yl.value.add(e.key),l||ne.success("记录已永久删除")}catch(a){l||ne.error("删除失败")}}async function Ei(){$l.value=!1,await Oi(!0)}async function Oi(e=!1){if(oa.value||!hl.value)return;da.value=!1;const l=hl.value;if(!ba){if("granted"!==await l.queryPermission({mode:"read"})){if(!e)return void(da.value=!0);if("granted"!==await l.requestPermission({mode:"read"}))return}ba=!0}oa.value=!0;const a=0===ml.value.size;a&&(ul.value=!0),cl.value=0;try{try{await We.bulkSet([{key:"syncInProgress",value:!0}])}catch(t){}const s=new Date(ra.value).getTime(),n=ua.value?new Date(ua.value).getTime():1/0,o=[],i=new Set(ml.value),r=[],u=new Set,c=new Set;for await(const e of l.values())if("file"===e.kind&&e.name.toLowerCase().endsWith(".log")){const l=e.name,a=l.match(/_(\d{8})(?:\.|_)/);if(a&&a[1]){const e=`${a[1].slice(0,4)}-${a[1].slice(4,6)}-${a[1].slice(6,8)} 00:00:00`,l=new Date(e).getTime();if(l+864e5<s||l>n)continue}const t=await e.getFile();if(t.size<10)continue;if(!a&&(t.lastModified<s||t.lastModified>n))continue;const i=ia.value[l];let r=0;if(i){if(t.size===i.size&&t.lastModified<=i.mtime)continue;t.size>i.size&&(r=i.size)}o.push({handle:e,name:l,size:t.size,startByte:r})}if(0===o.length)return oa.value=!1,ul.value=!1,zl.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),void(e&&(Ul.value=!0,setTimeout(()=>{Ul.value=!1},800)));o.sort((e,l)=>e.name.localeCompare(l.name));const d=10;dl.value=[],vl.value=o.map(e=>({name:e.name,size:e.size-e.startByte}));let v=0;for(let e=0;e<o.length;e+=d){const l=o.slice(e,e+d).map(async e=>{const l=await e.handle.getFile(),a=await l.slice(e.startByte).text(),{records:t,players:s,items:n}=await Bi(a);for(const o of t)i.has(o.key)||yl.value.has(o.key)||(i.add(o.key),r.push(o));s.forEach(e=>u.add(e)),n.forEach(e=>c.add(e)),ia.value[e.name]={size:l.size,mtime:l.lastModified},v++,cl.value=Math.round(v/o.length*100),dl.value.push({name:e.name,size:e.size}),dl.value.sort((e,l)=>e.name.localeCompare(l.name)),vl.value=vl.value.filter(l=>l.name!==e.name)});await Promise.all(l),await new Promise(e=>setTimeout(e,0))}if(r.length>0){await Ie.bulkSet(JSON.parse(JSON.stringify(r))),pl.value=[...pl.value,...r],ml.value=i,Wi(r,"sync");let e=!1;const l={...fl.value},t={...El.value};if(c.forEach(a=>{void 0===l[a]&&(l[a]=!0,e=!0)}),u.forEach(l=>{void 0===t[l]&&(t[l]=!0,e=!0)}),e&&(fl.value=l,El.value=t),a||ne.success({message:`同步完成，新增 ${r.length} 条记录`,showClose:!0}),a){new Set(pl.value.filter(e=>ma.test(e.item)).map(e=>e.item)).size>=12&&(ca.value=!0),Ua.value||ne.warning({message:"解析成功，请先在「固定队 - 职位设置」中完成所有职位的设置，以开启更多功能。",duration:1e4,showClose:!0})}}zl.value=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e&&(Ul.value=!0,setTimeout(()=>{Ul.value=!1},800)),sa.value=hl.value.name}catch(s){}finally{try{await We.remove("syncInProgress")}catch{}oa.value=!1,ul.value=!1,cl.value=0}}function Bi(e){return new Promise((l,a)=>{const t=new Ut;t.onmessage=e=>{l(e.data),t.terminate()},t.onerror=e=>{a(e),t.terminate()},t.postMessage(e)})}function Di(e){if(ha.value.cards&&e.startsWith("九宫幻卡"))return!0;if(ha.value.materia&&e.includes("魔晶石"))return!0;if(ha.value.music&&(e.startsWith("管弦乐琴乐谱")||e.startsWith("陈旧的乐谱")))return!0;if(ha.value.book&&e.endsWith("断章"))return!0;if(ha.value.totem&&e.endsWith("图腾"))return!0;if(ha.value.other&&e.includes("经验值"))return!0;if(!ma.test(e)){const l=e.match(ya);if(l?.groups?.series&&ha.value.maskedSeries?.includes(l.groups.series))return!0}return!1}function Ri(e){return ca.value?ma.test(e):!1!==fl.value[e]}function Ti(e){return!1!==El.value[e]}function Pi(e,l){e.ctrlKey?Fi(l):e.altKey?ar("item",l):ca.value||function(e){const l=!1!==fl.value[e];fl.value[e]=!l}(l)}function zi(e,l){const a=Ii(l);if(!a)return 0;const t=(jl.value.playerBis||{})[a]||{};if("random_weapon"===e.id)return 0;if("count"===e.type&&0===t[e.id])return 0;if(ol(e,t))return"count"===e.type?t[e.id]||0:1;const s="toggle"===e.type&&"weapon"!==e.id,n="twine"===e.id||"coating"===e.id||"solvent"===e.id||"tome"===e.id;return s||n?1:0}function Ui(e,l,a){const t=Ii(e),s=Ii(l),n=e=>e?Ye.includes(e)?Ye.indexOf(e):e.startsWith("SUB:")?100:e.startsWith("LEFT:")?200:500:999,o=n(t),i=n(s);if(o!==i)return o-i;const r=a||Oa.value,u=r[e]||0,c=r[l]||0;return u!==c?c-u:e.localeCompare(l)}function Li(e,l){const a=la.value,t=He.find(e=>e.name===l||e.keywords===l);if(!t)return Object.keys(e||{}).sort((l,a)=>Ui(l,a,e||{}));const s=Object.entries(wa.value).filter(([e,l])=>l&&!e.startsWith("LEFT:")).map(([e,l])=>l),n=Array.from(new Set([...Object.keys(e||{}),...s])),o=[];return n.forEach(l=>{if(!Ti(l))return;const n=Ii(l),i=n?.startsWith("LEFT:")||n?.startsWith("SUB:");if("needed"===a&&i)return;const r=e?.[l]||0,u=zi(t,l);"all"===a?(r>0||s.includes(l))&&o.push(l):"obtained"===a?r>0&&o.push(l):"needed"===a&&!i&&(r<u||0===r)&&o.push(l)}),o.sort((l,a)=>Ui(l,a,e||{}))}function Ai(e,l,a){const t=He.find(e=>e.name===l||e.keywords===l||e.id===l);if("random_weapon"===t?.id||"随武"===l)return{count:a,isRandomWeapon:!0,layerName:"4层",details:wt.value[e]};if(!t){const t="随武"===l||l.startsWith(c)&&ma.test(l);return{count:a,isRandomWeapon:t,layerName:t?"4层":void 0,details:t?wt.value[e]:void 0}}const s=Ii(e);if(!(s&&Ye.includes(s)))return{count:a,layerName:Ke.find(e=>e.items.includes(t.id))?.name};const n=(jl.value.playerBis||{})[s]||{},o=void 0!==n[t.id],i=zi(t,e),r=ol(t,n),u=Ke.find(e=>e.items.includes(t.id));return{count:a,isBis:o?r:void 0,isBisFalse:!r&&i>0,layerName:u?.name}}function ji(e){const l=Ta.value[e]||{},a={},t=new Set;He.forEach(e=>{a[e.id]=0,Object.entries(l).forEach(([l,s])=>{const n=s||0;l.includes(e.keywords)&&(a[e.id]=(a[e.id]||0)+n,t.add(l))})});const s=[],n=Ii(e),o=!(!n||!Ye.includes(n)),i=(jl.value?.playerBis||{})[n||""]||{};He.forEach(l=>{const t=a[l.id],n=zi(l,e);let r=!1;const u=t||0;if(("all"===ea.value||u>0||"needed"===ea.value&&(u<n||0===u))&&(r=!0),r){const a=Ke.find(e=>e.items.includes(l.id));s.push({name:l.keywords||l.name,count:u,isBis:"random_weapon"===l.id?void 0:o&&void 0!==i[l.id]?n>0:void 0,isRandomWeapon:"random_weapon"===l.id,details:"random_weapon"===l.id?wt.value[e]:void 0,id:l.id,layerName:a?a.name:void 0})}});const r=[];if(Object.entries(l).forEach(([e,l])=>{t.has(e)||e.startsWith(c)&&ma.test(e)&&(r.push({name:e,count:l}),t.add(e))}),r.length>0){const e=r.reduce((e,l)=>e+l.count,0);s.push({name:"随武",count:e,isRandomWeapon:!0,layerName:"4层",details:r})}Object.entries(l).forEach(([e,l])=>{t.has(e)||s.push({name:e,count:l,isBis:void 0,layerName:void 0})});const u=Yl.value;return s.sort((e,l)=>{const a=dt(e.id&&He.find(l=>l.id===e.id)?.keywords||e.name,u),t=dt(l.id&&He.find(e=>e.id===l.id)?.keywords||l.name,u);return a!==t?a-t:e.name.localeCompare(l.name)}),"obtained"===ea.value?s.filter(e=>e.count>0):"needed"===ea.value?s.filter(e=>0===e.count):s}function Ii(e){for(const[l,a]of Object.entries(wa.value))if(a===e)return l}function Ni(e,l){var a;e.ctrlKey?Fi(l):e.altKey?ar("player",l):va.value||(a=l,El.value[a]=!(!1!==El.value[a]))}async function Wi(e,l){const a=function(e){const l=pl.value.filter(e=>e.isManual);if(0===l.length)return[];const a=[],t=new Map;return e.forEach(e=>{if(e.isManual)return;const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`;t.has(l)||t.set(l,new Set),t.get(l).add(Gl(e.player))}),l.forEach(e=>{const l=`${new Date(e.timestamp).toLocaleDateString()}|${e.item}`,s=t.get(l);s&&s.has(Gl(e.player))&&a.push(e)}),a}(e);if(0===a.length)return;const t="sync"===l?"同步的日志":"导入的数据";try{await oe.confirm(`在${t}中发现了 ${a.length} 条与现有手动记录重合的数据（同日期、同玩家、同物品）。<br/><br/>是否删除这些手动记录，以真实的解析数据为准？`,"发现重复记录",{confirmButtonText:"删除手动记录",cancelButtonText:"全部保留",type:"info",dangerouslyUseHTMLString:!0});for(const e of a)await $i(e,!0);ne.success(`已清理 ${a.length} 条手动记录`)}catch{}}async function Fi(e){try{await navigator.clipboard.writeText(e),ne.success({message:`已复制: ${e}`,duration:1500,showClose:!0})}catch(l){ne.error({message:"复制失败",showClose:!0})}}function Yi(){const e=new Date;e.setHours(18,0,0,0),Cl.value={timestamp:e.toISOString(),item:"",player:""},wl.value=!0}function Hi(e,l){l(Array.from(Pa.value).filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}function Ji(e,l){l(Ba.value.filter(l=>l.toLowerCase().includes(e.toLowerCase())).map(e=>({value:e})))}async function Ki(){const e=Cl.value.item.trim(),l=Cl.value.player.trim();if(!Cl.value.timestamp||!e||!l)return void ne.error("请填写完整信息");const a=!Pa.value.includes(e),t=!Ba.value.includes(l);if(a||t){let s="";s=a&&t?`物品 "<b>${e}</b>" 和 玩家 "<b>${l}</b>" 都是第一次出现。`:a?`物品 "<b>${e}</b>" 是第一次出现。`:`玩家 "<b>${l}</b>" 是第一次出现。`;try{await oe.confirm(`${s}<br/><br/>确定要以此名称创建记录吗？请检查是否有错别字。`,"发现新条目",{confirmButtonText:"确定创建",cancelButtonText:"返回修改",type:"warning",dangerouslyUseHTMLString:!0})}catch{return}}const s=new Date(Cl.value.timestamp);s.setHours(18,0,0,0);const n={key:`manual-${s.getTime()}-${Math.random().toString(36).slice(2)}`,timestamp:s,item:e,player:l,rolls:[],isManual:!0};await Ie.set(JSON.parse(JSON.stringify(n))),void 0===fl.value[n.item]&&(fl.value[n.item]=!0),void 0===El.value[Gl(n.player)]&&(El.value[Gl(n.player)]=!0),pl.value=[...pl.value,n],wl.value=!1,ne.success({message:`已添加: ${n.item} - ${n.player}`,showClose:!0})}const qi=k(null);function Gi(e){"clear"===e?(Ml.value={loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0},xl.value=!0):"export"===e?async function(){try{const e=new Set,l=new Set;let a=Date.now();pl.value.forEach(t=>{e.add(t.item),l.add(t.player);const s=t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp;s<a&&(a=s),t.rolls&&t.rolls.forEach(e=>l.add(e.player))});const t=Array.from(e),s=Array.from(l),n=new Map(t.map((e,l)=>[e,l])),o=new Map(s.map((e,l)=>[e,l])),i=new Map(["need","greed","assign","direct","manual"].map((e,l)=>[e,l])),r={v:4,base:a,dicts:{i:t,p:s},r:pl.value.map(e=>{const l=[(e.timestamp instanceof Date?e.timestamp.getTime():e.timestamp)-a,n.get(e.item),o.get(e.player),e.key];return e.rolls&&e.rolls.length>0?(l.push(e.rolls.length),e.rolls.forEach(e=>{l.push(o.get(e.player)),l.push(e.value),l.push(i.get(e.type)??0)})):l.push(0),l})},u={map:ql.value,roles:wa.value,bisConfig:jl.value,weekCorrections:Ol.value,playerCorrections:Bl.value,itemVisibility:fl.value,playerVisibility:El.value,processedFiles:ia.value,systemFilterSettings:ha.value,logPath:sa.value,viewMode:gl.value,hideUnselectedItems:ga.value,showOnlyRole:fa.value,isOnlyRaidMembersActive:va.value,summarySortMode:Yl.value,slotSortMode:Hl.value,weekSortMode:Jl.value,bisSortMode:Kl.value,playerSummaryFilterMode:ea.value,slotSummaryFilterMode:la.value,blacklistedKeys:Array.from(yl.value),syncStartDate:ra.value,syncEndDate:ua.value};r.c=u;const c=new Blob([JSON.stringify(r)],{type:"application/json"}),d=URL.createObjectURL(c),v=document.createElement("a");v.href=d,v.download=`ff14_loot_backup_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(v),v.click(),document.body.removeChild(v),URL.revokeObjectURL(d),ne.success({message:"数据已导出",showClose:!0})}catch(e){ne.error({message:"导出失败",showClose:!0})}}():"import"===e?qi.value?.click():"manual"===e&&Yi()}async function Xi(e){try{if(!e.r||!Array.isArray(e.r))return void ne.error({message:"无效的备份文件格式",showClose:!0});Vl.value={loot:!0,meta:!0,corrections:!0,view:!0},Sl.value=e,bl.value=!0}catch(l){ne.error({message:"解析出错",showClose:!0})}}async function Qi(){const e=Sl.value;if(!e)return;let l;try{if(l=ne({message:"正在导入数据...",duration:0,type:"info",showClose:!0}),e.c){if(Vl.value.meta){if(e.c.map&&(ql.value={...ql.value,...e.c.map}),e.c.roles){const l={...wa.value};for(const[a,t]of Object.entries(e.c.roles)){const e=t;if(a.startsWith("SUB:")||a.startsWith("LEFT:")){const t=a.split(":")[0];Object.entries(l).some(([l,a])=>l.startsWith(`${t}:`)&&a===e)||(l[a]=e)}else l[a]=e}wa.value=l}const l=e.c.bisConfig||e.bisConfig||e.c.bis;l&&(jl.value=l)}if(Vl.value.view){const l=e.c.systemFilterSettings||e.c.filter||{};Object.keys(l).length>0&&(ha.value={...ha.value,...l}),e.c.itemVisibility&&(fl.value={...fl.value,...e.c.itemVisibility}),e.c.playerVisibility&&(El.value={...El.value,...e.c.playerVisibility}),e.c.processedFiles&&(ia.value={...ia.value,...e.c.processedFiles}),e.c.logPath&&(sa.value=e.c.logPath),e.c.viewMode&&(gl.value=e.c.viewMode),void 0!==e.c.hideUnselectedItems&&(ga.value=e.c.hideUnselectedItems),void 0!==e.c.showOnlyRole&&(fa.value=e.c.showOnlyRole),void 0!==e.c.isOnlyRaidMembersActive&&(va.value=e.c.isOnlyRaidMembersActive),e.c.summarySortMode&&(Yl.value=e.c.summarySortMode),e.c.slotSortMode&&(Hl.value=e.c.slotSortMode),e.c.weekSortMode&&(Jl.value=e.c.weekSortMode),e.c.bisSortMode&&(Kl.value=e.c.bisSortMode),e.c.playerSummaryFilterMode&&(ea.value=e.c.playerSummaryFilterMode),e.c.slotSummaryFilterMode&&(la.value=e.c.slotSummaryFilterMode),e.c.blacklistedKeys&&(yl.value=new Set(e.c.blacklistedKeys)),e.c.syncStartDate&&(ra.value=e.c.syncStartDate),e.c.syncEndDate&&(ua.value=e.c.syncEndDate)}Vl.value.corrections&&(e.c.weekCorrections&&(Ol.value={...Ol.value,...e.c.weekCorrections}),e.c.playerCorrections&&(Bl.value={...Bl.value,...e.c.playerCorrections}))}if(Vl.value.loot&&e.r&&e.r.length>0){const l=new Set(pl.value.map(e=>`${new Date(e.timestamp).getTime()}|${e.item}|${e.player}`)),a=new Set(pl.value.map(e=>e.key)),t=[],s=e.base||0,n=e.dicts?.i||[],o=e.dicts?.p||[],i=["need","greed","assign","direct","manual"];for(const r of e.r){const e=s+r[0],u=n[r[1]],c=o[r[2]],d=r[3],v=r[4],p=[];if(v>0){let e=5;for(let l=0;l<v&&!(e+2>=r.length);l++)p.push({player:o[r[e]],value:r[e+1],type:i[r[e+2]]||"need"}),e+=3}if(!u||!c)continue;const m=d&&"string"==typeof d?d:`${e}_${u}_${c}_${Math.random().toString(36).slice(2)}`;if(a.has(m)||yl.value.has(m))continue;const y=`${e}|${u}|${c}`;l.has(y)||(t.push({key:m,timestamp:new Date(e),item:u,player:c,rolls:p,source:"import",id:""}),l.add(y),a.add(m))}t.length>0&&(await Ie.bulkSet(JSON.parse(JSON.stringify(t))),pl.value=[...pl.value,...t].sort((e,l)=>new Date(l.timestamp).getTime()-new Date(e.timestamp).getTime()),ml.value=new Set(pl.value.map(e=>e.key)),Wi(t,"import"))}ne.success({message:"数据导入已完成",showClose:!0}),bl.value=!1,Sl.value=null}catch(a){ne.error({message:"导入失败",showClose:!0})}finally{l?.close()}}function Zi(e){const l=new FileReader;l.onload=async e=>{try{const l=JSON.parse(e.target?.result);await Xi(l)}catch(l){ne.error({message:"文件解析失败",showClose:!0})}},l.readAsText(e)}function er(e){const l=e.target;l.files&&0!==l.files.length&&(Zi(l.files[0]),l.value="")}const lr=k(null);function ar(e,l){const a="item"===e,t=a?fl:El,s=a?Pa:Ba;if(lr.value?.type===e&&lr.value.key===l)return t.value={...lr.value.snapshot},lr.value=null,void ne.info({message:"已恢复到独显前的状态",duration:2e3,showClose:!0});let n=t.value;lr.value?.type===e&&(n=lr.value.snapshot),lr.value={type:e,key:l,snapshot:JSON.parse(JSON.stringify(n))};const o={};s.value.forEach(e=>{o[e]=e===l}),t.value=o,ne.success({message:`仅显示: ${l} (再次 Alt+点击 恢复)`,duration:2e3})}function tr(e){const l=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${e.getFullYear()}/${l}/${a} ${t}:${s}`}function sr(e){return 0===e?"0 MB":`${(e/1048576).toFixed(2)} MB`}function nr(e){const l=e.rolls.find(l=>l.player===e.player);if(l)return l;if(e.player){const l=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:e.player,type:l,value:null}}return null}function or(e){const l=Xl(e);if(!!Bl.value[e.key])return{player:l,type:"replace",value:null};const a=e.rolls.find(e=>e.player===l);if(a)return a;if(l){const a=e.isManual?"manual":e.isAssign?"assign":"direct";return{player:l,type:a,value:null}}return null}async function ir(){if(0===Object.values(Ml.value).filter(Boolean).length)return void(xl.value=!1);xl.value=!1;const e=[];if(Ml.value.loot){e.push(Ie.clear()),pl.value=[],ml.value=new Set,ia.value={},fl.value={},El.value={},_a.value={},Va.clear(),dl.value=[],vl.value=[],hl.value=null,na.value="",zl.value="",ra.value=a,ua.value=null,e.push(We.remove("processedFiles")),e.push(We.remove("itemVisibility")),e.push(We.remove("playerVisibility")),e.push(We.remove("logPath")),e.push(We.remove("viewMode")),e.push(We.remove("hideUnselectedItems")),e.push(We.remove("showOnlyRole")),e.push(We.remove("isOnlyRaidMembersActive")),e.push(We.remove("systemFilterSettings")),e.push(We.remove("summarySortMode")),e.push(We.remove("slotSortMode")),e.push(We.remove("weekSortMode")),e.push(We.remove("bisSortMode")),e.push(We.remove("playerSummaryFilterMode")),e.push(We.remove("slotSummaryFilterMode")),e.push(We.remove("blacklistedKeys")),e.push(We.remove("syncStartDate")),e.push(We.remove("syncEndDate"));try{e.push(Fe.remove("current-log-dir"))}catch{}}Ml.value.weekCorrection&&(Ol.value={},e.push(We.remove("weekCorrections"))),Ml.value.playerCorrection&&(Bl.value={},e.push(We.remove("playerCorrections"))),Ml.value.bis&&(jl.value={playerBis:{}},e.push(We.remove("bisConfig"))),Ml.value.roles&&(wa.value={},e.push(We.remove("playerRoles"))),Ml.value.mapping&&(ql.value={},e.push(We.remove("playerMapping"))),await Promise.all(e),ne.success({message:"所选数据已清空",showClose:!0})}async function rr(e,l){l&&(Pl.value={record:e,newPlayer:l},Dl.value=null,setTimeout(()=>{Pl.value&&async function(){if(!Pl.value)return;const{record:e,newPlayer:l}=Pl.value,a={...Bl.value};l===e.player?delete a[e.key]:a[e.key]=l;Bl.value=a,ne.success({message:l===e.player?"已恢复原始获得者":`已将物品重新分配给 ${l}`,showClose:!0}),Pl.value=null}()},75))}return(e,u)=>{const c=P,p=U,k=Z,S=Q,C=G,x=l,M=I,B=Y,T=be,Ne=Se,We=Me,Fe=Ee,He=xe,Ke=Oe,qe=Ce,Qe=ue;return t(),s("div",{class:o(["app-container",{"is-onboarding":0===pl.value.length&&(!hl.value||$l.value)}])},[d($,{name:"fade"},{default:y(()=>[Je.value?(t(),s("div",Lt,[m("div",At,[u[77]||(u[77]=m("div",{class:"skeleton-header"},[m("div",{class:"skeleton-item brand"}),m("div",{class:"skeleton-item toolbar"})],-1)),m("div",jt,[u[75]||(u[75]=m("div",{class:"skeleton-item control"},null,-1)),u[76]||(u[76]=m("div",{class:"skeleton-filters"},[m("div",{class:"skeleton-item filter-box"}),m("div",{class:"skeleton-item filter-box"})],-1)),m("div",It,[(t(),s(f,null,g(8,e=>m("div",{key:e,class:"skeleton-item card"})),64))])])])])):r("",!0)]),_:1}),Je.value?r("",!0):(t(),s(f,{key:0},[d($,{name:"fade"},{default:y(()=>[ul.value?(t(),s("div",Nt,[m("div",Wt,[m("div",Ft,[u[78]||(u[78]=m("div",{class:"spinner-small"},null,-1)),m("span",Yt,"解析中... "+i(cl.value)+"%",1)]),m("div",Ht,[m("div",Jt,[m("div",Kt," 已完成 ("+i(dl.value.length)+") ",1),m("div",qt,[d(D,{name:"list"},{default:y(()=>[(t(!0),s(f,null,g(dl.value,e=>(t(),s("div",{key:e.name,class:"file-item done"},[m("div",Gt,[d(c,null,{default:y(()=>[d(v(ce))]),_:1}),m("span",{class:"file-name",title:e.name},i(e.name),9,Xt)]),m("span",Qt,i(sr(e.size)),1)]))),128))]),_:1})])]),u[79]||(u[79]=m("div",{class:"list-divider"},null,-1)),m("div",Zt,[m("div",es," 待处理 ("+i(vl.value.length)+") ",1),m("div",ls,[(t(!0),s(f,null,g(vl.value.slice(0,50),e=>(t(),s("div",{key:e.name,class:"file-item pending"},[m("div",as,[d(c,null,{default:y(()=>[d(v(de))]),_:1}),m("span",{class:"file-name",title:e.name},i(e.name),9,ts)]),m("span",ss,i(sr(e.size)),1)]))),128)),vl.value.length>50?(t(),s("div",ns," ...还有 "+i(vl.value.length-50)+" 个文件 ",1)):r("",!0)])])])])])):r("",!0)]),_:1}),pl.value.length>0?(t(),s("main",os,[m("div",is,[ja.value?(t(),s("div",{key:0,class:o(["drag-guide-zone",{"is-active":Ia.value}]),onDrop:h(Xa,["stop","prevent"]),onDragover:u[0]||(u[0]=h(()=>{},["prevent"])),onDragenter:u[1]||(u[1]=e=>Ia.value=!0),onDragleave:u[2]||(u[2]=e=>Ia.value=!1)},[d(c,{class:"guide-icon"},{default:y(()=>[d(v(ve))]),_:1}),u[80]||(u[80]=m("span",null,"释放文件以导入备份",-1))],34)):r("",!0),m("div",rs,[m("div",us,[d(p,{type:da.value?"warning":"primary",size:"small",loading:oa.value,class:"sync-btn-fixed",onClick:u[3]||(u[3]=e=>Oi(!0))},{default:y(()=>[w(i(oa.value?"同步中":da.value?"需要同步":"立即同步")+" ",1),da.value?(t(),s("span",cs)):r("",!0)]),_:1},8,["type","loading"]),m("div",ds,[E(m("div",{class:"sync-hint-text time-hint"}," 上次同步: "+i(zl.value),513),[[O,!Ul.value&&zl.value]]),E(m("div",vs," 同步成功 ",512),[[O,Ul.value]])])]),d(v(ie),{modelValue:ra.value,"onUpdate:modelValue":u[4]||(u[4]=e=>ra.value=e),type:"datetime",size:"small",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1,class:"date-picker-el"},null,8,["modelValue"]),u[97]||(u[97]=m("span",{class:"range-sep"},"-",-1)),d(v(ie),{modelValue:ua.value,"onUpdate:modelValue":u[5]||(u[5]=e=>ua.value=e),type:"datetime",size:"small",placeholder:"截止 (可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:"",class:"date-picker-el"},null,8,["modelValue"]),d(p,{plain:"",class:"tool-btn",onClick:Mi},{default:y(()=>[d(c,null,{default:y(()=>[d(v(pe))]),_:1}),u[81]||(u[81]=m("span",null,"日志目录",-1))]),_:1}),u[98]||(u[98]=m("div",{class:"v-divider"},null,-1)),d(p,{plain:"",class:"tool-btn",onClick:Yi},{default:y(()=>[d(c,null,{default:y(()=>[d(v(W))]),_:1}),u[82]||(u[82]=m("span",null,"手动添加",-1))]),_:1}),d(C,{trigger:"click",onCommand:Gi},{dropdown:y(()=>[d(S,null,{default:y(()=>[d(k,{command:"import"},{default:y(()=>[d(c,null,{default:y(()=>[d(v(me))]),_:1}),u[84]||(u[84]=w("导入备份 (JSON) ",-1))]),_:1}),d(k,{command:"export"},{default:y(()=>[d(c,null,{default:y(()=>[d(v(ye))]),_:1}),u[85]||(u[85]=w("导出备份 (JSON) ",-1))]),_:1}),d(k,{command:"clear",divided:"",style:{color:"#f56c6c"}},{default:y(()=>[d(c,null,{default:y(()=>[d(v(F))]),_:1}),u[86]||(u[86]=w("清空数据库 ",-1))]),_:1})]),_:1})]),default:y(()=>[d(p,{plain:"",class:"tool-btn"},{default:y(()=>[d(c,null,{default:y(()=>[d(v(z))]),_:1}),u[83]||(u[83]=m("span",null,"数据管理",-1)),d(c,{class:"el-icon--right"},{default:y(()=>[d(v(ee))]),_:1})]),_:1})]),_:1}),d(p,{plain:"",class:"tool-btn",onClick:u[6]||(u[6]=e=>Ll.value=!0)},{default:y(()=>[d(c,null,{default:y(()=>[d(v(fe))]),_:1}),u[87]||(u[87]=m("span",null,"自定义修正管理",-1))]),_:1}),u[99]||(u[99]=m("div",{class:"v-divider"},null,-1)),m("div",ps,[d(x,{"storage-key":"loot-history-theme"}),d(M,{placement:"bottom-end",width:480,trigger:"click","popper-class":"guide-popover-popper"},{reference:y(()=>[d(p,{plain:"",class:"tool-btn"},{default:y(()=>[d(c,null,{default:y(()=>[d(v(j))]),_:1}),u[88]||(u[88]=m("span",null,"使用指南",-1))]),_:1})]),default:y(()=>[m("div",ms,[m("section",ys,[m("h4",null,[d(c,null,{default:y(()=>[d(v(J))]),_:1}),u[89]||(u[89]=w(" 这是什么？ ",-1))]),u[90]||(u[90]=m("p",null,[w(" 这是一个专门为 FFXIV 固定队设计的"),m("strong",null,"掉落历史统计"),w("与 "),m("strong",null,"BIS 分配管理"),w("工具。它能自动从你的 ACT 日志中记录战利品信息，并以此为基础提供自动化的分配建议与数据分析。 ")],-1))]),m("section",fs,[m("h4",null,[d(c,null,{default:y(()=>[d(v(J))]),_:1}),u[91]||(u[91]=w(" 注意事项 ",-1))]),u[92]||(u[92]=m("div",{class:"warning-box"},[m("ul",null,[m("li",null,[m("strong",null,"保持 ACT 运行："),w("且未勾选“隐藏聊天日志(隐私保护)”。 ")]),m("li",null,[m("strong",null,"请勿提前退本："),w(" 一定要等装备分完了再退本！以保证日志完整。 ")])])],-1))]),m("section",gs,[m("h4",null,[d(c,null,{default:y(()=>[d(v(J))]),_:1}),u[93]||(u[93]=w(" 快速上手 ",-1))]),u[94]||(u[94]=m("ol",null,[m("li",null,[m("strong",null,"配置人员："),w(" 在左上方“固定队 - 职位设置”中绑定队员 ID。 ")]),m("li",null,[m("strong",null,"BIS 规划："),w(" 切换至“BIS分配”页签，录入全队成员的毕业装备需求。 ")]),m("li",null,[m("strong",null,"一键分配："),w(" 副本结束后，可参考“BIS分配”页签的建议进行分配。 ")])],-1))]),m("section",hs,[m("h4",null,[d(c,null,{default:y(()=>[d(v(J))]),_:1}),u[95]||(u[95]=w(" 漏了记录怎么办？ ",-1))]),u[96]||(u[96]=m("p",null,[w(" 如果因意外（如掉线、忘开 ACT 等）漏掉记录，请点击顶部栏中间的“"),m("strong",null,"手动添加"),w("”补全。 ")],-1))])])]),_:1})])])]),m("div",ws,[m("div",bs,[m("div",ks,[m("div",_s,[m("span",Vs,"👥 玩家 ("+i(pt.value)+")",1),u[104]||(u[104]=m("div",{class:"header-sep"},null,-1)),d(M,{visible:Xe.value,"onUpdate:visible":u[9]||(u[9]=e=>Xe.value=e),placement:"bottom",width:360,trigger:"click","popper-class":"role-settings-popper"},{reference:y(()=>[d(p,{size:"small",class:"soft-action-btn primary"},{default:y(()=>[d(c,null,{default:y(()=>[d(v(A))]),_:1}),u[100]||(u[100]=m("span",null,"固定队 - 职位设置",-1)),Ua.value?r("",!0):(t(),s("span",Ss))]),_:1})]),default:y(()=>[m("div",Cs,[m("div",xs,[(t(!0),s(f,null,g(v(Ye),e=>(t(),s("div",{key:e,class:"role-setup-item"},[m("div",Ms,[d(kl,{role:e},null,8,["role"])]),d(v(ge),{"model-value":wa.value[e],placeholder:"选择/输入玩家",filterable:"","allow-create":"","default-first-option":"",clearable:"",size:"small",style:{flex:"1"},teleported:!1,onChange:l=>async function(e,l){e?yt(e,"固定队成员",()=>{wa.value[l]=e}):wa.value[l]=""}(l,e)},{label:y(({label:e,value:l})=>[w(i(Ca(l||e)),1)]),default:y(()=>[(t(!0),s(f,null,g(Ba.value.filter(l=>l===wa.value[e]||!tt.value.has(l)),e=>(t(),b(v(he),{key:e,label:Ca(e),value:e},null,8,["label","value"]))),128))]),_:2},1032,["model-value","onChange"])]))),128))]),u[103]||(u[103]=m("div",{class:"role-divider"}," 特殊分组 ",-1)),m("div",$s,[m("div",Es,[u[101]||(u[101]=m("div",{class:"group-title"}," 临时替补 ",-1)),m("div",Os,[(t(!0),s(f,null,g(wa.value,(e,l)=>(t(),s(f,{key:l},[l.startsWith("SUB:")?(t(),s("div",Bs,[d(v(we),{closable:"",onClose:e=>delete wa.value[l]},{default:y(()=>[w(i(Ca(e)),1)]),_:2},1032,["onClose"])])):r("",!0)],64))),128)),d(v(ge),{placeholder:"添加/输入替补",filterable:"","allow-create":"","default-first-option":"",size:"small",value:"",style:{width:"120px"},teleported:!1,onChange:u[7]||(u[7]=e=>ft(e,"SUB"))},{default:y(()=>[(t(!0),s(f,null,g(Ba.value.filter(e=>!tt.value.has(e)),e=>(t(),b(v(he),{key:e,label:Ca(e),value:e},null,8,["label","value"]))),128))]),_:1})])]),m("div",Ds,[u[102]||(u[102]=m("div",{class:"group-title"}," 已离队 ",-1)),m("div",Rs,[(t(!0),s(f,null,g(wa.value,(e,l)=>(t(),s(f,{key:l},[l.startsWith("LEFT:")?(t(),s("div",Ts,[d(v(we),{closable:"",onClose:e=>delete wa.value[l]},{default:y(()=>[w(i(Ca(e)),1)]),_:2},1032,["onClose"])])):r("",!0)],64))),128)),d(v(ge),{placeholder:"添加/输入离队",filterable:"","allow-create":"","default-first-option":"",size:"small",value:"",style:{width:"120px"},teleported:!1,onChange:u[8]||(u[8]=e=>ft(e,"LEFT"))},{default:y(()=>[(t(!0),s(f,null,g(Ba.value.filter(e=>!tt.value.has(e)),e=>(t(),b(v(he),{key:e,label:Ca(e),value:e},null,8,["label","value"]))),128))]),_:1})])])])])]),_:1},8,["visible"]),u[105]||(u[105]=m("div",{class:"header-sep"},null,-1)),d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[m("label",Ps,[d(v(re),{modelValue:fa.value,"onUpdate:modelValue":u[10]||(u[10]=e=>fa.value=e),disabled:!Ua.value,size:"small",style:{"--el-switch-on-color":"#3b82f6","--el-switch-off-color":"#cbd5e1"}},null,8,["modelValue","disabled"]),m("span",{class:"switch-label",style:n({opacity:Ua.value?1:.5})},"只显示职位",4)])]),_:1},8,["disabled"]),u[106]||(u[106]=m("div",{class:"header-sep"},null,-1)),d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[m("div",zs,[d(v(re),{modelValue:va.value,"onUpdate:modelValue":u[11]||(u[11]=e=>va.value=e),disabled:!Ua.value,size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue","disabled"]),m("span",{class:"switch-label",style:n({opacity:Ua.value?1:.5,fontSize:"12px"})}," 只看固定队 ",4)])]),_:1},8,["disabled"]),va.value?r("",!0):(t(),s("div",Us))]),m("div",Ls,[d(M,{visible:Ge.value,"onUpdate:visible":u[12]||(u[12]=e=>Ge.value=e),placement:"bottom",width:320,trigger:"click"},{reference:y(()=>[d(p,{size:"small",class:"soft-action-btn"},{default:y(()=>[...u[107]||(u[107]=[w(" 合并大小号 ",-1)])]),_:1})]),default:y(()=>[m("div",As,[m("div",js,[m("div",Is,[d(c,null,{default:y(()=>[d(v(J))]),_:1}),u[108]||(u[108]=m("div",{class:"guide-content"},[m("p",null,[w(" 合并角色将"),m("strong",null,"永久归并"),w("两者的所有历史记录。 ")]),m("p",null," 若仅需修正单次分配错误，请直接在“详情记录”中点击姓名进行修改。 ")],-1))]),m("div",Ns,[m("div",{class:o(["step-dot hide",{"is-active":0===Ql.value.length}])},[...u[109]||(u[109]=[m("span",{class:"step-num"},"1",-1),m("span",{class:"step-label"},"被合角色",-1)])],2),d(c,{class:"step-arrow"},{default:y(()=>[d(v(te))]),_:1}),m("div",{class:o(["step-dot show",{"is-active":1===Ql.value.length}])},[...u[110]||(u[110]=[m("span",{class:"step-num"},"2",-1),m("span",{class:"step-label"},"目标角色",-1)])],2)]),m("div",Ws,[(t(!0),s(f,null,g(ot.value,e=>(t(),b(T,{key:e,checked:Ql.value.includes(e),class:o(["merge-check-tag",[Ql.value[0]===e?"is-hiding":"",Ql.value[1]===e?"is-showing":""]]),onChange:l=>function(e){Ql.value.includes(e)?Ql.value=Ql.value.filter(l=>l!==e):(Ql.value.length>=2&&Ql.value.shift(),Ql.value.push(e))}(e)},{default:y(()=>[d(_l,{name:e,role:Ii(e),"show-only-role":fa.value,class:"tag-label-name"},null,8,["name","role","show-only-role"]),Ql.value[0]===e?(t(),s("div",Fs,[d(c,null,{default:y(()=>[d(v(ke))]),_:1}),u[111]||(u[111]=m("span",null,"隐身角色",-1))])):r("",!0),Ql.value[1]===e?(t(),s("div",Ys,[d(c,null,{default:y(()=>[d(v(_e))]),_:1}),u[112]||(u[112]=m("span",null,"主角色",-1))])):r("",!0)]),_:2},1032,["checked","class","onChange"]))),128))]),2===Ql.value.length?(t(),s("div",Hs,[d(p,{type:"primary",size:"default",class:"confirm-merge-btn-new",onClick:Zl},{default:y(()=>[...u[113]||(u[113]=[w(" 确认将数据合并 ",-1)])]),_:1})])):r("",!0)]),lt.value.length>0?(t(),s("div",Js,[u[114]||(u[114]=m("div",{class:"suggest-title"}," 💡 发现疑似换号 (>90% 重合)： ",-1)),m("div",Ks,[(t(!0),s(f,null,g(lt.value,e=>(t(),b(p,{key:e.from+e.to,size:"small",plain:"",class:"suggest-btn",onClick:l=>aa(e.from,e.to)},{default:y(()=>[d(_l,{name:e.from,role:Ii(e.from),"show-only-role":fa.value},null,8,["name","role","show-only-role"]),d(c,{style:{margin:"0 4px"}},{default:y(()=>[d(v(te))]),_:1}),d(_l,{name:e.to,role:Ii(e.to),"show-only-role":fa.value},null,8,["name","role","show-only-role"]),m("span",qs,"("+i(e.confidence)+"%)",1)]),_:2},1032,["onClick"]))),128))])])):r("",!0),Object.keys(ql.value).length>0?(t(),s("div",Gs,[u[117]||(u[117]=m("div",{class:"selector-title"}," 当前合并映射: ",-1)),m("div",Xs,[(t(!0),s(f,null,g(ql.value,(e,l)=>(t(),s("div",{key:l,class:"mapping-item-row"},[m("div",Qs,[u[115]||(u[115]=m("span",{class:"map-tag-hint"},"隐身",-1)),d(_l,{name:l,role:Ii(l),"show-only-role":fa.value},null,8,["name","role","show-only-role"])]),d(c,{class:"map-arrow"},{default:y(()=>[d(v(te))]),_:1}),m("div",Zs,[u[116]||(u[116]=m("span",{class:"map-tag-hint"},"显示",-1)),d(_l,{name:e,role:Ii(e),"show-only-role":fa.value},null,8,["name","role","show-only-role"])]),d(p,{link:"",type:"danger",icon:v(F),class:"map-remove",onClick:e=>function(e){const l={...ql.value};delete l[e],ql.value=l}(l)},null,8,["icon","onClick"])]))),128))])])):r("",!0)])]),_:1},8,["visible"]),u[118]||(u[118]=m("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示",-1))])]),m("div",en,[va.value?(t(),s("div",ln)):r("",!0),(t(!0),s(f,null,g(La.value,e=>(t(),b(T,{key:e,checked:Ti(e),class:o([{"readonly-tag":va.value},"mini-tag-el player-tag"]),onClick:h(l=>Ni(l,e),["stop"])},{default:y(()=>[d(_l,{name:e,role:Ii(e),"show-only-role":fa.value},null,8,["name","role","show-only-role"])]),_:2},1032,["checked","class","onClick"]))),128))])]),m("div",an,[m("div",tn,[m("div",sn,[m("span",nn,"📦 物品 ("+i(vt.value)+")",1),m("label",on,[d(v(re),{modelValue:ca.value,"onUpdate:modelValue":u[13]||(u[13]=e=>ca.value=e),size:"small",style:{"--el-switch-on-color":"#3b82f6"}},null,8,["modelValue"]),u[119]||(u[119]=m("span",{class:"switch-label"},"只看零式掉落",-1))]),u[129]||(u[129]=m("div",{class:"header-sep"},null,-1)),d(M,{placement:"bottom-start",width:220,trigger:"click"},{reference:y(()=>[d(p,{size:"small",class:"soft-action-btn primary"},{default:y(()=>[d(c,{style:{"margin-right":"4px"}},{default:y(()=>[d(v(z))]),_:1}),u[120]||(u[120]=w(" 杂物屏蔽设置 ",-1))]),_:1})]),default:y(()=>[m("div",rn,[u[128]||(u[128]=m("div",{class:"pop-title"}," 屏蔽杂物 (非零式模式下生效) ",-1)),m("div",{class:"filter-list",style:n({opacity:ca.value?.5:1,pointerEvents:ca.value?"none":"auto"})},[d(v(Ve),{modelValue:ha.value.cards,"onUpdate:modelValue":u[14]||(u[14]=e=>ha.value.cards=e),size:"small"},{default:y(()=>[...u[121]||(u[121]=[w(" 九宫幻卡 ",-1)])]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:ha.value.materia,"onUpdate:modelValue":u[15]||(u[15]=e=>ha.value.materia=e),size:"small"},{default:y(()=>[...u[122]||(u[122]=[w(" 魔晶石 ",-1)])]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:ha.value.music,"onUpdate:modelValue":u[16]||(u[16]=e=>ha.value.music=e),size:"small"},{default:y(()=>[...u[123]||(u[123]=[w(" 乐谱 ",-1)])]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:ha.value.book,"onUpdate:modelValue":u[17]||(u[17]=e=>ha.value.book=e),size:"small"},{default:y(()=>[...u[124]||(u[124]=[w(" 零式断章 ",-1)])]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:ha.value.totem,"onUpdate:modelValue":u[18]||(u[18]=e=>ha.value.totem=e),size:"small"},{default:y(()=>[...u[125]||(u[125]=[w(" 极神图腾 ",-1)])]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:ha.value.other,"onUpdate:modelValue":u[19]||(u[19]=e=>ha.value.other=e),size:"small"},{default:y(()=>[...u[126]||(u[126]=[w(" 经验值/金币 ",-1)])]),_:1},8,["modelValue"]),at.value.length>0?(t(),s(f,{key:0},[u[127]||(u[127]=m("div",{class:"pop-title",style:{margin:"8px 0 4px","padding-top":"8px"}}," 屏蔽装备系列 ",-1)),d(Ne,{modelValue:ha.value.maskedSeries,"onUpdate:modelValue":u[20]||(u[20]=e=>ha.value.maskedSeries=e),style:{display:"flex","flex-direction":"column",gap:"4px"}},{default:y(()=>[(t(!0),s(f,null,g(at.value,e=>(t(),b(v(Ve),{key:e,value:e,size:"small"},{default:y(()=>[w(i(e)+"系列 ",1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])],64)):r("",!0)],4)])]),_:1})]),u[130]||(u[130]=m("div",{class:"acts"},[m("span",{class:"hint-small"},"Ctrl + 鼠标左键 = 复制，Alt + 鼠标左键 = 单独显示")],-1))]),m("div",un,[ca.value?(t(),s("div",cn)):r("",!0),(t(!0),s(f,null,g(rt.value,e=>(t(),b(T,{key:e,checked:Ri(e),class:o([{"readonly-tag":ca.value},"mini-tag-el item-tag"]),onClick:h(l=>Pi(l,e),["stop"])},{default:y(()=>[w(i(e),1)]),_:2},1032,["checked","class","onClick"]))),128))])])]),m("div",dn,[Ra.value.length>0?(t(),b(Qe,{key:0,modelValue:gl.value,"onUpdate:modelValue":u[33]||(u[33]=e=>gl.value=e),class:"mode-tabs-el",type:"card"},{default:y(()=>[d(qe,{label:"详细记录",name:"list"},{default:y(()=>[m("div",vn,[d(He,{data:Ci.value,style:{width:"100%"},class:"loot-record-table","cell-class-name":"loot-cell"},{default:y(()=>[d(We,{label:"周",width:"60",align:"center"},{default:y(e=>[m("div",{class:"col-week-interactive",onClick:h(l=>Pt(l,e.row),["stop"]),onContextmenu:h(l=>Pt(l,e.row),["prevent"])},[Ol.value[e.row.key]?(t(),s("div",mn,[m("div",yn," W"+i(v(nl)(e.row.timestamp,a)),1),d(c,{class:"week-arrow"},{default:y(()=>[d(v(ee))]),_:1}),m("div",fn," W"+i(v(nl)(e.row.timestamp,a)+(Ol.value[e.row.key]||0)),1)])):(t(),s("div",gn,[w(" W"+i(v(nl)(e.row.timestamp,a))+" ",1),za.value.has(e.row.key)&&!Ol.value[e.row.key]?(t(),b(B,{key:0,placement:"top",enterable:!1},{content:y(()=>[...u[131]||(u[131]=[w(" 可能归属周错误（通常发生在周二压线进本）。",-1),m("br",null,null,-1),w("点击可选择将其归入上一周。 ",-1)])]),default:y(()=>[d(c,{class:"week-warning-icon"},{default:y(()=>[d(v(q))]),_:1})]),_:1})):r("",!0)]))],40,pn)]),_:1}),d(We,{label:"时间",width:"140"},{default:y(e=>[m("div",hn,[e.row.isManual?(t(),b(v(we),{key:0,size:"small",type:"info",effect:"plain",class:"manual-tag"},{default:y(()=>[...u[132]||(u[132]=[w(" 手动添加 ",-1)])]),_:1})):(t(),s("span",wn,i(tr(e.row.timestamp)),1))])]),_:1}),d(We,{label:"物品",width:"220"},{default:y(e=>[m("div",bn,[m("span",kn,i(e.row.item),1)])]),_:1}),d(We,{label:"获得者",width:"260"},{default:y(e=>[m("div",{class:"winner-selector-trigger",onClick:h(l=>{return a=l,t=e.row,void(Dl.value?.key!==t.key?(Rl.value=a.currentTarget,Dl.value=t,Tl.value[t.key]=!!Bl.value[t.key]):Dl.value=null);var a,t},["stop"])},[Bl.value[e.row.key]?(t(),s("div",Vn,[m("div",Sn,[u[133]||(u[133]=m("span",{class:"correction-label"},"原始记录:",-1)),nr(e.row)?(t(),b(Ct,{key:0,roll:nr(e.row),"show-only-role":fa.value,"get-player-role":Ii,class:"original-display"},null,8,["roll","show-only-role"])):(t(),b(_l,{key:1,name:e.row.player,role:Ii(e.row.player),"show-only-role":fa.value,class:"original-display"},null,8,["name","role","show-only-role"]))]),m("div",Cn,[d(c,{class:"correction-arrow"},{default:y(()=>[d(v($e))]),_:1}),or(e.row)?(t(),b(Ct,{key:0,roll:or(e.row),"is-winner":"","show-only-role":fa.value,"get-player-role":Ii},null,8,["roll","show-only-role"])):r("",!0)])])):(t(),s(f,{key:1},[or(e.row)?(t(),b(Ct,{key:0,roll:or(e.row),"is-winner":"","show-only-role":fa.value,"get-player-role":Ii},null,8,["roll","show-only-role"])):(t(),s("div",xn," 未分配 "))],64)),d(c,{class:"winner-edit-icon"},{default:y(()=>[d(v(L))]),_:1})],8,_n)]),_:1}),d(We,{label:"其他 Roll 点记录"},{default:y(e=>{return[m("div",Mn,[(t(!0),s(f,null,g((l=e.row,l.rolls.filter(e=>e.player!==l.player).sort((e,l)=>{const a={need:0,greed:1},t=a[e.type]??3,s=a[l.type]??3;return t!==s?t-s:(l.value||0)-(e.value||0)})),e=>(t(),b(Ct,{key:e.player,roll:e,"show-only-role":fa.value,"get-player-role":Ii},null,8,["roll","show-only-role"]))),128))])];var l}),_:1}),d(We,{label:"操作",width:"60",align:"center"},{default:y(e=>[d(Fe,{title:"确定永久删除吗？","confirm-button-text":"删除","cancel-button-text":"取消",onConfirm:l=>$i(e.row)},{reference:y(()=>[d(p,{type:"danger",icon:v(F),size:"small",circle:"",plain:""},null,8,["icon"])]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"]),m("div",$n,[d(Ke,{"current-page":ta.value,"onUpdate:currentPage":u[21]||(u[21]=e=>ta.value=e),"page-size":50,layout:"total, prev, pager, next",total:Ra.value.length,size:"small"},null,8,["current-page","total"])])])]),_:1}),d(qe,{name:"summary",disabled:!Ua.value,lazy:""},{label:y(()=>[d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[...u[134]||(u[134]=[m("span",null,"按玩家",-1)])]),_:1},8,["disabled"])]),default:y(()=>[m("div",En,[d(Mt,{modelValue:Yl.value,"onUpdate:modelValue":u[22]||(u[22]=e=>Yl.value=e)},null,8,["modelValue"]),u[135]||(u[135]=m("div",{class:"v-divider-mini"},null,-1)),d(_t,{modelValue:ea.value,"onUpdate:modelValue":u[23]||(u[23]=e=>ea.value=e)},null,8,["modelValue"])]),m("div",On,[(t(!0),s(f,null,g(it.value,e=>(t(),s("div",{key:e,class:"summary-card"},[m("div",Bn,[d(_l,{name:e,role:Ii(e),"show-only-role":fa.value},null,8,["name","role","show-only-role"])]),m("div",null,[(t(!0),s(f,null,g(ji(e),e=>(t(),s("div",{key:e.name,class:o(["summary-item",{"is-not-obtained":0===e.count}])},[m("span",{class:"s-name",title:e.name},i(e.name),9,Dn),d(zt,{item:e},null,8,["item"])],2))),128))])]))),128))])]),_:1},8,["disabled"]),d(qe,{name:"slot",disabled:!Ua.value,lazy:""},{label:y(()=>[d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[...u[136]||(u[136]=[m("span",null,"按部位",-1)])]),_:1},8,["disabled"])]),default:y(()=>[m("div",Rn,[d(Mt,{modelValue:Hl.value,"onUpdate:modelValue":u[24]||(u[24]=e=>Hl.value=e)},null,8,["modelValue"]),u[137]||(u[137]=m("div",{class:"v-divider-mini"},null,-1)),d(_t,{modelValue:la.value,"onUpdate:modelValue":u[25]||(u[25]=e=>la.value=e)},null,8,["modelValue"])]),m("div",Tn,[(t(!0),s(f,null,g(kt.value,e=>(t(),s("div",{key:e,class:"summary-card"},[m("div",Pn,i(e),1),m("div",null,[(t(!0),s(f,null,g(Li(ht.value[e]||{},e),l=>(t(),s("div",{key:l,class:o(["summary-item",{"is-not-obtained":0===(ht.value[e]?.[l]||0)}])},[d(_l,{class:"s-name",name:l,role:Ii(l),"show-only-role":fa.value},null,8,["name","role","show-only-role"]),m("div",zn,[d(zt,{item:Ai(l,e,ht.value[e]?.[l]||0)},null,8,["item"])])],2))),128))])]))),128))])]),_:1},8,["disabled"]),d(qe,{name:"week",disabled:!Ua.value,lazy:""},{label:y(()=>[d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[...u[138]||(u[138]=[m("span",null,"按CD周",-1)])]),_:1},8,["disabled"])]),default:y(()=>[m("div",Un,[d(Mt,{modelValue:Jl.value,"onUpdate:modelValue":u[26]||(u[26]=e=>Jl.value=e)},null,8,["modelValue"])]),m("div",Ln,[m("div",{class:o(["summary-grid has-sort-control",{"is-compact-role":fa.value}])},[(t(!0),s(f,null,g($t.value,e=>(t(),s("div",{key:e,class:"summary-card",onContextmenu:u[27]||(u[27]=h(()=>{},["prevent"]))},[m("div",An,i(St(e)),1),m("div",jn,[(t(!0),s(f,null,g([Et(e)],l=>(t(),s("div",{key:l.length+e},[(t(!0),s(f,null,g(l,(e,a)=>(t(),s(f,{key:e.key},[m("div",{class:o(["summary-item week-record-row",{"is-corrected":Ol.value[e.key],"is-suspicious":za.value.has(e.key)&&!Ol.value[e.key]}]),onContextmenu:h(l=>Pt(l,e),["prevent"]),onClick:h(l=>Pt(l,e),["stop"]),onMouseenter:l=>function(e,l){za.value.has(l.key)&&void 0===Ol.value[l.key]&&(Fa.value=e.currentTarget,Ya.value="可能归属周错误（通常发生在周二压线进本）。点击可选择将其归入上一周。",Wa.value=!0)}(l,e),onMouseleave:Ha},[m("div",Nn,[d(_l,{name:e.player,role:Ii(e.player),"show-only-role":fa.value,"name-class":"week-player-name"},null,8,["name","role","show-only-role"])]),m("div",Wn,[m("span",Fn,i(e.item),1),za.value.has(e.key)&&!Ol.value[e.key]?(t(),b(c,{key:0,class:"row-status-icon is-warning"},{default:y(()=>[d(v(q))]),_:1})):r("",!0),Ol.value[e.key]?(t(),b(c,{key:1,class:"row-status-icon is-info"},{default:y(()=>[d(v(de))]),_:1})):r("",!0)])],42,In),Bt(l,a)?(t(),s("div",Yn)):r("",!0)],64))),128))]))),128))])],32))),128))],2)]),d(B,{visible:Wa.value,"onUpdate:visible":u[28]||(u[28]=e=>Wa.value=e),"virtual-ref":Fa.value,"virtual-triggering":"",placement:"top",content:Ya.value,"popper-class":"week-suspicious-tooltip"},null,8,["visible","virtual-ref","content"])]),_:1},8,["disabled"]),d(qe,{name:"chart",disabled:!Ua.value,lazy:""},{label:y(()=>[d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[...u[139]||(u[139]=[m("span",null,"图表分析",-1)])]),_:1},8,["disabled"])]),default:y(()=>[d(bt,{records:mt.value,players:La.value.filter(Ti),"get-actual-player":Gl,"get-player-role":Ii,"record-week-corrections":Ol.value,"sync-start-date":ra.value,"player-visibility":fa.value?"role":"all"},null,8,["records","players","record-week-corrections","sync-start-date","player-visibility"])]),_:1},8,["disabled"]),d(qe,{name:"bis",disabled:!Ua.value,lazy:""},{label:y(()=>[d(B,{disabled:Ua.value,content:Vi,placement:"top"},{default:y(()=>[m("div",Hn,[u[140]||(u[140]=m("span",null,"BIS分配",-1)),Ua.value&&!st.value?(t(),s("span",Jn)):r("",!0)])]),_:1},8,["disabled"])]),default:y(()=>[m("div",Kn,[d(ut,{modelValue:jl.value,"onUpdate:modelValue":u[29]||(u[29]=e=>jl.value=e),"sort-mode":Kl.value,"onUpdate:sortMode":u[30]||(u[30]=e=>Kl.value=e),players:La.value,records:mt.value,"get-player-role":Ii,"get-actual-player":Gl,"show-only-role":fa.value,"get-item-slot":gt},null,8,["modelValue","sort-mode","players","records","show-only-role"]),d($,{name:"fade"},{default:y(()=>[E(m("div",qn,[m("div",Gn,[m("div",Xn,[m("div",Qn,[d(c,null,{default:y(()=>[d(v(Be))]),_:1})]),u[141]||(u[141]=m("h3",null,"BIS 分配功能已锁定",-1)),u[142]||(u[142]=m("p",null,"为确保数据分析的准确性，需激活以下过滤模式：",-1))]),m("div",Zn,[m("div",{class:o(["status-item",{"is-ready":va.value}])},[m("div",eo,[va.value?(t(),b(c,{key:0},{default:y(()=>[d(v(De))]),_:1})):(t(),b(c,{key:1},{default:y(()=>[d(v(Re))]),_:1}))]),u[143]||(u[143]=m("div",{class:"item-label"}," 只看固定队 ",-1)),d(v(re),{modelValue:va.value,"onUpdate:modelValue":u[31]||(u[31]=e=>va.value=e)},null,8,["modelValue"])],2),m("div",{class:o(["status-item",{"is-ready":ca.value}])},[m("div",lo,[ca.value?(t(),b(c,{key:0},{default:y(()=>[d(v(De))]),_:1})):(t(),b(c,{key:1},{default:y(()=>[d(v(Re))]),_:1}))]),u[144]||(u[144]=m("div",{class:"item-label"}," 只看零式掉落 ",-1)),d(v(re),{modelValue:ca.value,"onUpdate:modelValue":u[32]||(u[32]=e=>ca.value=e)},null,8,["modelValue"])],2)])])],512),[[O,!va.value||!ca.value]])]),_:1})])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):(t(),s("div",ao,[m("div",to,[d(c,null,{default:y(()=>[d(v(Te))]),_:1})]),u[146]||(u[146]=m("div",{class:"empty-title"}," 未发现匹配记录 ",-1)),u[147]||(u[147]=m("p",{class:"empty-desc"},[w(" 当前筛选条件过于严格，数据库中有数据但未能匹配。"),m("br"),w(" 请尝试"),m("span",{class:"empty-highlight"},"清除筛选条件"),w("或调整时间范围。 ")],-1)),m("div",so,[d(p,{type:"info",plain:"",onClick:xi},{default:y(()=>[...u[145]||(u[145]=[w(" 显示所有掉落 ",-1)])]),_:1})])])),d(M,{visible:!!Dl.value,"virtual-ref":Rl.value,"virtual-triggering":"",persistent:!1,"hide-after":0,placement:"bottom",width:240,"popper-class":"winner-change-popper"},{default:y(()=>[Dl.value?(t(),s("div",no,[m("div",oo,[u[149]||(u[149]=m("div",{class:"popover-title"}," 变更获得者 ",-1)),Tl.value[Dl.value.key]?(t(),b(p,{key:0,type:"primary",link:"",size:"small",class:"restore-btn",onClick:u[34]||(u[34]=e=>rr(Dl.value,Dl.value.player))},{default:y(()=>[...u[148]||(u[148]=[w(" 恢复原始记录 ",-1)])]),_:1})):r("",!0)]),u[150]||(u[150]=m("div",{class:"popover-desc"}," 将掉落记录手动转移至其他玩家名下 ",-1)),d(v(ge),{"model-value":Xl(Dl.value),placeholder:"选择新获得者",filterable:"",size:"small",class:"winner-select-bar",onChange:u[35]||(u[35]=e=>rr(Dl.value,e))},{default:y(()=>[(t(!0),s(f,null,g(La.value,e=>(t(),b(v(he),{key:e,label:fa.value&&Ii(e)||Ca(e),value:e},{default:y(()=>[m("div",io,[d(_l,{name:e,role:Ii(e),"show-only-role":fa.value},null,8,["name","role","show-only-role"])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["model-value"])])):r("",!0)]),_:1},8,["visible","virtual-ref"]),d(M,{visible:$a.value,"onUpdate:visible":u[36]||(u[36]=e=>$a.value=e),"virtual-ref":Tt,"virtual-triggering":"",persistent:!1,"hide-after":0,"popper-class":"context-menu-popper",width:180,"show-arrow":!1,placement:"bottom-start"},{default:y(()=>[Dt.value?(t(),s("div",ro,[m("div",uo,[d(c,null,{default:y(()=>[d(v(Pe))]),_:1}),m("span",null,i(tr(Dt.value.timestamp)),1)]),u[151]||(u[151]=m("div",{class:"menu-divider"},null,-1)),m("div",{class:"menu-action-item",onClick:Si},[d(c,{class:"action-arrow"},{default:y(()=>[(t(),b(R(Ol.value[Dt.value.key]?v(fe):v(ze))))]),_:1}),m("span",co,i(Ol.value[Dt.value.key]?"归回原始周":"归入上一周"),1)])])):r("",!0)]),_:1},8,["visible"])])])):(t(),s("div",vo,[m("div",po,[hl.value?$l.value?(t(),s(f,{key:1},[u[165]||(u[165]=m("div",{class:"empty-title"}," 设置同步范围 ",-1)),m("p",go,[u[158]||(u[158]=w(" 已关联目录：",-1)),m("span",ho,i(hl.value.name),1),u[159]||(u[159]=m("br",null,null,-1)),u[160]||(u[160]=w(" 请指定你想要同步的历史记录起始时间。 ",-1))]),m("div",wo,[m("div",bo,[u[161]||(u[161]=m("span",{class:"setup-label"},"起始时间:",-1)),d(v(ie),{modelValue:ra.value,"onUpdate:modelValue":u[41]||(u[41]=e=>ra.value=e),type:"datetime",placeholder:"起始时间",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm",clearable:!1},null,8,["modelValue"])]),m("div",ko,[u[162]||(u[162]=m("span",{class:"setup-label"},"截止时间:",-1)),d(v(ie),{modelValue:ua.value,"onUpdate:modelValue":u[42]||(u[42]=e=>ua.value=e),type:"datetime",placeholder:"现在 (可选)",format:"YYYY/MM/DD HH:mm","value-format":"YYYY-MM-DDTHH:mm"},null,8,["modelValue"])])]),m("div",_o,[d(p,{plain:"",size:"large",onClick:u[43]||(u[43]=e=>hl.value=null)},{default:y(()=>[...u[163]||(u[163]=[w(" 返回重选 ",-1)])]),_:1}),d(p,{type:"primary",size:"large",onClick:Ei},{default:y(()=>[...u[164]||(u[164]=[w(" 开始解析并导入 ",-1)])]),_:1})])],64)):(t(),s("div",Vo,[ja.value?(t(),s("div",{key:0,class:o(["setup-drag-zone",{"is-active":Ia.value}]),onDrop:h(Xa,["stop","prevent"]),onDragover:u[44]||(u[44]=h(()=>{},["prevent"])),onDragenter:u[45]||(u[45]=e=>Ia.value=!0),onDragleave:u[46]||(u[46]=e=>Ia.value=!1)},[d(c,{class:"guide-icon"},{default:y(()=>[d(v(ve))]),_:1}),u[166]||(u[166]=m("span",null,"释放文件以导入备份",-1))],34)):r("",!0),m("div",So,i(oa.value?"正在同步数据":"准备就绪"),1),m("p",Co,i(oa.value?"正在处理日志文件，请稍候。":"数据库当前为空。你可以开始解析数据，或从备份文件恢复。"),1),m("div",xo,[oa.value?r("",!0):(t(),b(p,{key:0,type:"primary",size:"large",onClick:u[47]||(u[47]=e=>Oi(!0))},{default:y(()=>[...u[167]||(u[167]=[w(" 开始解析数据 ",-1)])]),_:1})),oa.value?r("",!0):(t(),b(p,{key:1,plain:"",size:"large",onClick:u[48]||(u[48]=e=>qi.value?.click())},{default:y(()=>[...u[168]||(u[168]=[w(" 导入备份数据 ",-1)])]),_:1})),oa.value?r("",!0):(t(),b(p,{key:2,plain:"",size:"large",onClick:u[49]||(u[49]=e=>$l.value=!0)},{default:y(()=>[...u[169]||(u[169]=[w(" 调整时间范围 ",-1)])]),_:1})),oa.value?r("",!0):(t(),b(p,{key:3,plain:"",size:"large",onClick:Mi},{default:y(()=>[...u[170]||(u[170]=[w(" 修改日志目录 ",-1)])]),_:1}))])])):(t(),s("div",mo,[ja.value?(t(),s("div",{key:0,class:o(["setup-drag-zone",{"is-active":Ia.value}]),onDrop:h(Xa,["stop","prevent"]),onDragover:u[37]||(u[37]=h(()=>{},["prevent"])),onDragenter:u[38]||(u[38]=e=>Ia.value=!0),onDragleave:u[39]||(u[39]=e=>Ia.value=!1)},[d(c,{class:"guide-icon"},{default:y(()=>[d(v(ve))]),_:1}),u[152]||(u[152]=m("span",null,"释放文件以导入备份",-1))],34)):r("",!0),m("div",yo,[u[155]||(u[155]=m("div",{class:"empty-title"}," 欢迎使用 Loot History ",-1)),u[156]||(u[156]=m("p",{class:"empty-desc"},[w(" 选择你的"),m("span",{class:"empty-highlight"},"FFXIV 日志文件夹"),w("，开始记录掉落。 ")],-1)),m("div",fo,[d(p,{type:"primary",size:"large",onClick:Mi},{default:y(()=>[...u[153]||(u[153]=[w(" 选择日志目录 ",-1)])]),_:1}),d(p,{type:"info",plain:"",size:"large",onClick:u[40]||(u[40]=e=>qi.value?.click())},{default:y(()=>[...u[154]||(u[154]=[w(" 导入备份数据 ",-1)])]),_:1})])]),u[157]||(u[157]=m("div",{class:"guide-img-box"},[m("img",{src:"/ff14-overlay-vue/assets/lootHistoryGuide-CNWHhK0O.jpg",alt:"Guide",class:"guide-img"})],-1))]))])])),d(v(ae),{modelValue:bl.value,"onUpdate:modelValue":u[55]||(u[55]=e=>bl.value=e),title:"选择导入内容",width:"400px","append-to-body":"","destroy-on-close":""},{footer:y(()=>[m("span",Ro,[d(p,{onClick:u[54]||(u[54]=e=>bl.value=!1)},{default:y(()=>[...u[172]||(u[172]=[w("取消",-1)])]),_:1}),d(p,{type:"primary",onClick:Qi},{default:y(()=>[...u[173]||(u[173]=[w("确认导入",-1)])]),_:1})])]),default:y(()=>[bl.value&&Sl.value?(t(),s("div",Mo,[u[171]||(u[171]=m("p",{class:"import-hint-text"}," 发现备份文件，请选择要导入的部分： ",-1)),m("div",$o,[d(v(Ve),{modelValue:Vl.value.loot,"onUpdate:modelValue":u[50]||(u[50]=e=>Vl.value.loot=e),disabled:!Sl.value.r?.length},{default:y(()=>[w(i(_)+" ("+i(Sl.value.r?.length||0)+" 条) ",1),Sl.value.r?.length?r("",!0):(t(),s("span",Eo,"- 备份文件中未发现记录"))]),_:1},8,["modelValue","disabled"]),d(v(Ve),{modelValue:Vl.value.meta,"onUpdate:modelValue":u[51]||(u[51]=e=>Vl.value.meta=e),disabled:!(Sl.value.c?.map||Sl.value.c?.roles||Sl.value.c?.bisConfig||Sl.value.bisConfig)},{default:y(()=>[w(i(le)+" ",1),Sl.value.c?.map||Sl.value.c?.roles||Sl.value.c?.bisConfig||Sl.value.bisConfig?r("",!0):(t(),s("span",Oo,"- 备份文件中未发现元数据"))]),_:1},8,["modelValue","disabled"]),d(v(Ve),{modelValue:Vl.value.corrections,"onUpdate:modelValue":u[52]||(u[52]=e=>Vl.value.corrections=e),disabled:!(Sl.value.c?.weekCorrections||Sl.value.c?.playerCorrections)},{default:y(()=>[w(i(se)+" ",1),Sl.value.c?.weekCorrections||Sl.value.c?.playerCorrections?r("",!0):(t(),s("span",Bo,"- 备份文件中未发现修正项"))]),_:1},8,["modelValue","disabled"]),d(v(Ve),{modelValue:Vl.value.view,"onUpdate:modelValue":u[53]||(u[53]=e=>Vl.value.view=e),disabled:!(Sl.value.c?.filter||Sl.value.c?.itemVisibility||Sl.value.c?.playerVisibility||Sl.value.c?.processedFiles)},{default:y(()=>[w(i(je)+" ",1),Sl.value.c?.filter||Sl.value.c?.itemVisibility||Sl.value.c?.playerVisibility||Sl.value.c?.processedFiles?r("",!0):(t(),s("span",Do,"- 备份文件中未发现视图/过滤配置"))]),_:1},8,["modelValue","disabled"])])])):r("",!0)]),_:1},8,["modelValue"]),d(v(ae),{modelValue:xl.value,"onUpdate:modelValue":u[65]||(u[65]=e=>xl.value=e),title:"清空数据选项",width:"400px","append-to-body":"","destroy-on-close":""},{footer:y(()=>[m("span",Lo,[d(p,{onClick:u[64]||(u[64]=e=>xl.value=!1)},{default:y(()=>[...u[178]||(u[178]=[w("取消",-1)])]),_:1}),d(p,{type:"danger",onClick:ir},{default:y(()=>[...u[179]||(u[179]=[w("确定清空",-1)])]),_:1})])]),default:y(()=>[xl.value?(t(),s("div",To,[m("div",Po,[u[176]||(u[176]=m("p",{class:"clear-warning-text"}," 请选择要彻底删除的数据项： ",-1)),m("div",zo,[d(p,{link:"",type:"primary",size:"small",onClick:u[56]||(u[56]=e=>Ml.value={loot:!0,bis:!0,roles:!0,mapping:!0,weekCorrection:!0,playerCorrection:!0})},{default:y(()=>[...u[174]||(u[174]=[w(" 全选 ",-1)])]),_:1}),d(p,{link:"",size:"small",onClick:u[57]||(u[57]=e=>Ml.value={loot:!Ml.value.loot,bis:!Ml.value.bis,roles:!Ml.value.roles,mapping:!Ml.value.mapping,weekCorrection:!Ml.value.weekCorrection,playerCorrection:!Ml.value.playerCorrection})},{default:y(()=>[...u[175]||(u[175]=[w(" 反选 ",-1)])]),_:1})])]),d(v(Ve),{modelValue:Ml.value.loot,"onUpdate:modelValue":u[58]||(u[58]=e=>Ml.value.loot=e)},{default:y(()=>[w(i(_)+" ("+i(pl.value.length)+") ",1)]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:Ml.value.roles,"onUpdate:modelValue":u[59]||(u[59]=e=>Ml.value.roles=e)},{default:y(()=>[w(i(V),1)]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:Ml.value.bis,"onUpdate:modelValue":u[60]||(u[60]=e=>Ml.value.bis=e)},{default:y(()=>[w(i(N),1)]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:Ml.value.mapping,"onUpdate:modelValue":u[61]||(u[61]=e=>Ml.value.mapping=e)},{default:y(()=>[w(i(H),1)]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:Ml.value.weekCorrection,"onUpdate:modelValue":u[62]||(u[62]=e=>Ml.value.weekCorrection=e)},{default:y(()=>[w(i(K),1)]),_:1},8,["modelValue"]),d(v(Ve),{modelValue:Ml.value.playerCorrection,"onUpdate:modelValue":u[63]||(u[63]=e=>Ml.value.playerCorrection=e)},{default:y(()=>[w(i(X),1)]),_:1},8,["modelValue"])])):r("",!0),m("div",Uo,[d(c,null,{default:y(()=>[d(v(q))]),_:1}),u[177]||(u[177]=m("span",null,"选中的数据将被永久删除，无法撤销。",-1))])]),_:1},8,["modelValue"]),d(v(ae),{modelValue:wl.value,"onUpdate:modelValue":u[70]||(u[70]=e=>wl.value=e),title:"手动添加记录",width:"400px","append-to-body":"","destroy-on-close":""},{footer:y(()=>[m("span",Ao,[d(p,{onClick:u[69]||(u[69]=e=>wl.value=!1)},{default:y(()=>[...u[180]||(u[180]=[w("取消",-1)])]),_:1}),d(p,{type:"primary",onClick:Ki},{default:y(()=>[...u[181]||(u[181]=[w("确定添加",-1)])]),_:1})])]),default:y(()=>[wl.value?(t(),b(v(Ue),{key:0,"label-width":"80px"},{default:y(()=>[d(v(Le),{label:"日期"},{default:y(()=>[d(v(ie),{modelValue:Cl.value.timestamp,"onUpdate:modelValue":u[66]||(u[66]=e=>Cl.value.timestamp=e),type:"date",placeholder:"选择获得日期",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),d(v(Le),{label:"物品"},{default:y(()=>[d(v(Ae),{modelValue:Cl.value.item,"onUpdate:modelValue":u[67]||(u[67]=e=>Cl.value.item=e),"fetch-suggestions":Hi,placeholder:"请输入物品名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),d(v(Le),{label:"获得者"},{default:y(()=>[d(v(Ae),{modelValue:Cl.value.player,"onUpdate:modelValue":u[68]||(u[68]=e=>Cl.value.player=e),"fetch-suggestions":Ji,placeholder:"请输入玩家名称",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})):r("",!0)]),_:1},8,["modelValue"]),d(v(ae),{modelValue:Ll.value,"onUpdate:modelValue":u[74]||(u[74]=e=>Ll.value=e),title:"自定义修正管理",width:"850px","append-to-body":"","destroy-on-close":"",class:"premium-correction-dialog"},{default:y(()=>[Ll.value?(t(),s("div",jo,[m("div",Io,[m("div",{class:o(["nav-item",{active:"player"===Al.value}]),onClick:u[71]||(u[71]=e=>Al.value="player")},[m("div",No,[d(c,null,{default:y(()=>[d(v(A))]),_:1})]),m("div",Wo,[u[182]||(u[182]=m("div",{class:"nav-title"}," 获得者修正 ",-1)),m("div",Fo,i(Il.value.length)+" 个条目 ",1)])],2),m("div",{class:o(["nav-item",{active:"week"===Al.value}]),onClick:u[72]||(u[72]=e=>Al.value="week")},[m("div",Yo,[d(c,null,{default:y(()=>[d(v(Pe))]),_:1})]),m("div",Ho,[u[183]||(u[183]=m("div",{class:"nav-title"}," CD周数修正 ",-1)),m("div",Jo,i(Wl.value.length)+" 个条目 ",1)])],2),m("div",{class:o(["nav-item",{active:"manual"===Al.value}]),onClick:u[73]||(u[73]=e=>Al.value="manual")},[m("div",Ko,[d(c,null,{default:y(()=>[d(v(W))]),_:1})]),m("div",qo,[u[184]||(u[184]=m("div",{class:"nav-title"}," 手动添加记录 ",-1)),m("div",Go,i(Fl.value.length)+" 个条目 ",1)])],2)]),m("div",Xo,[m("div",Qo,[m("h3",null,i("player"===Al.value?"获得者修正管理":"week"===Al.value?"CD周数修正管理":"手动添加记录管理"),1),m("p",null,i("manual"===Al.value?"管理手动添加的装备掉落记录，删除后将永久移除。":"可以撤销手动进行的改动，恢复最原始的系统记录。"),1)]),m("div",Zo,["player"===Al.value||"week"===Al.value?(t(!0),s(f,{key:0},g("player"===Al.value?Il.value:Wl.value,e=>(t(),s("div",{key:e.key,class:"correction-card-compact"},[m("div",ei,[m("div",li,[m("div",{class:"item-name",title:e.itemName},i(e.itemName),9,ai),m("div",ti,i(tr(e.record.timestamp)),1)]),m("div",si,[m("div",ni,[m("div",oi,["player"===Al.value?(t(),b(_l,{key:0,name:e.oldVal,role:Ii(e.oldVal),"show-only-role":!1},null,8,["name","role"])):(t(),s("span",ii,i(e.oldVal),1))])]),m("div",ri,[d(c,null,{default:y(()=>[d(v(te))]),_:1})]),m("div",ui,[m("div",ci,["player"===Al.value?(t(),b(_l,{key:0,name:e.newVal,role:Ii(e.newVal),"show-only-role":!1},null,8,["name","role"])):(t(),s("span",di,i(e.newVal),1))])])]),m("div",vi,[d(p,{type:"primary",link:"",size:"small",onClick:l=>function(e){if("player"===e.type){const l={...Bl.value};delete l[e.key],Bl.value=l}else{const l={...Ol.value};delete l[e.key],Ol.value=l}ne.success("已还原该条修正项")}(e)},{default:y(()=>[d(c,null,{default:y(()=>[d(v(fe))]),_:1}),u[185]||(u[185]=w(" 还原 ",-1))]),_:1},8,["onClick"])])])]))),128)):"manual"===Al.value?(t(!0),s(f,{key:1},g(Fl.value,e=>(t(),s("div",{key:e.key,class:"correction-card-compact"},[m("div",pi,[m("div",mi,[m("div",{class:"item-name",title:e.item},i(e.item),9,yi),m("div",fi,[d(v(ie),{"model-value":e.timestamp,type:"date",size:"small",placeholder:"选择日期",clearable:!1,style:{width:"140px"},"onUpdate:modelValue":l=>async function(e,l){if(!l||Number.isNaN(l.getTime()))return;const a=new Date(l);a.setHours(18,0,0,0);try{const l={...e,timestamp:a};await Ie.set(JSON.parse(JSON.stringify(l)));const t=pl.value.findIndex(l=>l.key===e.key);if(-1!==t){const e=[...pl.value];e[t]={...l,timestamp:new Date(a)},pl.value=e}ne.success("已更新记录时间")}catch(t){ne.error("更新时间失败")}}(e,l)},null,8,["model-value","onUpdate:modelValue"])])]),m("div",gi,[m("div",hi,[m("div",wi,[d(_l,{name:e.player,role:Ii(e.player),"show-only-role":!1},null,8,["name","role"])])])]),m("div",bi,[d(p,{type:"danger",link:"",size:"small",onClick:l=>async function(e){try{await oe.confirm(`确定要删除这条手动添加的记录吗？<br/><br/><b>${e.item}</b> - <b>${e.player}</b>`,"确认删除",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0}),await Ie.remove(e.key),pl.value=pl.value.filter(l=>l.key!==e.key),ne.success("已删除手动记录")}catch{}}(e)},{default:y(()=>[d(c,null,{default:y(()=>[d(v(F))]),_:1}),u[186]||(u[186]=w(" 删除 ",-1))]),_:1},8,["onClick"])])])]))),128)):r("",!0),0===("player"===Al.value?Il.value:"week"===Al.value?Wl.value:Fl.value).length?(t(),s("div",ki,[d(c,{class:"empty-icon"},{default:y(()=>[d(v(De))]),_:1}),u[187]||(u[187]=m("p",null,"暂无符合条件的修正项",-1))])):r("",!0)])])])):r("",!0)]),_:1},8,["modelValue"])],64)),m("input",{ref_key:"importInputRef",ref:qi,type:"file",accept:".json",style:{display:"none"},onChange:er},null,544),m("div",_i,[d(c,null,{default:y(()=>[d(v(q))]),_:1}),u[188]||(u[188]=m("span",null,"项目处于早期开发阶段，功能可能存在BUG。",-1))])],2)}}}),[["__scopeId","data-v-bd61e89d"]]);export{Si as default};
