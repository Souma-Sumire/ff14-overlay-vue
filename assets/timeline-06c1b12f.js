import{d as Z,K as H,p as k,s as J,q as M,b as K,n as b,o as u,e as m,u as a,F as W,M as Y,$ as g,a as Q,A as V,U as X}from"./vendor-2a442634.js";import{u as ee,p as te,_ as ne}from"./TimelineShow-be73e25e.js";import{a as C,c as x}from"./overlay_plugin_api-409cb9ea.js";import{_ as oe}from"./_plugin-vue_export-helper-c27b6911.js";import"./util-831b56e7.js";import"./xivapi-a5c0f7f0.js";const ie={id:"wrapper"},ae={key:0,class:"optionalTimelines"},le=["onClick"],se={key:6,style:{color:"white","background-color":"black"}},ce=Z({__name:"timeline",setup(re){const n=ee(),s=H({loadedTimeline:[],optionalTimeline:[]}),p=k(0),r=k(0-n.configValues.preBattle),w=k(0);let v=!1;const T=J("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),O=new URLSearchParams(location.hash.split("?")[1]),y=k(window.location.href.match(/localhost/)||O.get("dev")==="1"),j=M(()=>s.loadedTimeline.filter(e=>e.sync)),A=M(()=>s.loadedTimeline.filter(e=>e.tts));K(()=>{G()});function S(){h(),s.loadedTimeline.length=0,s.optionalTimeline.length=0;const e=n.getTimeline(T.value);e.length===1?B(e[0]):e.length>1&&(s.optionalTimeline=e)}function D(e){B(e)}async function B(e,t=!0){t&&h(),v=!1,e!=null&&e.timeline&&(s.loadedTimeline=await te(e.timeline),s.loadedTimeline.sort((i,o)=>i.time-o.time),b.success(`加载了${e.name}`)),setTimeout(()=>{v=!0},1e3)}function h(){p.value=0,r.value=0-n.configValues.preBattle,w.value=0;for(const e of s.loadedTimeline)e.alertAlready=!1;for(const e of j.value)e.syncAlready=!1}function _(e,t=!0){t&&(v=!1,setTimeout(()=>{v=!0},1e3)),r.value=0,w.value=0,p.value=new Date().getTime()+e*1e3,A.value.forEach(i=>{i.alertAlready=!1}),L()}function L(){if(p.value===0)return;r.value=(new Date().getTime()-p.value+w.value)/1e3;const e=A.value.find(t=>!t.alertAlready&&t.time-n.configValues.ttsAdvance<=r.value);e&&(e.alertAlready=!0,e.tts&&$(e.tts)),requestAnimationFrame(L)}function I(e){var t,i,o;for(const c of e.detail.logs){const d=c.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(d)_(Number.parseInt(((t=d==null?void 0:d.groups)==null?void 0:t.cd)||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(c)||/^.{14} ChatLog 00:0038::end$/.test(c)||/^.{14} SystemLogMessage 29:.{8}:B1C:/.test(c))h();else{const f=j.value.find(l=>l.sync&&(l.syncOnce&&!l.syncAlready||!l.syncOnce)&&r.value>=l.time-l.windowBefore&&r.value<=l.time+Number(l.windowAfter)&&l.sync.test(c));f&&(f.syncAlready=!0,E(f.jump||f.time))}if(/^.{14} ChatLog 00:0038::/.test(c)){const f=(o=(i=c.match(/^.{14} ChatLog 00:0038::(?<name>.+)$/))==null?void 0:i.groups)==null?void 0:o.name;if(f){const l=n.getTimeline(T.value).find(U=>U.name===f);l&&B(l,!1)}}}}function N(e){E(e)}function E(e){p.value===0&&_(0,!1),w.value+=(e-r.value)*1e3,A.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}const P=e=>{T.value.jobs[0]!==e.detail.job&&(T.value.jobs[0]=e.detail.job,S())},F=e=>{T.value.zoneId=String(e.zoneID),S()};function $(e,t=!1){e&&(v||t)&&x({call:"cactbotSay",text:e})}function z(e,t={}){x({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const R=e=>{if(e.source==="soumaTimelineSettings"){if(e.msg.type==="post"){let t=function(){for(const o of i.allTimelines)o.condition.jobs===void 0&&(o.condition.jobs=[o.condition.job]),o.condition.jobs.sort((c,d)=>n.jobList.indexOf(c)-n.jobList.indexOf(d)),Reflect.deleteProperty(o.condition,"job");n.allTimelines=i.allTimelines,n.configValues=i.configValues,n.showStyle=i.showStyle,n.saveTimelineSettings(),b.closeAll(),b({message:"已更新数据",type:"success",duration:5e3,showClose:!1}),S()};const i=e.msg.data;i.allTimelines.length<n.allTimelines.length-1?X.confirm(i.allTimelines.length===0?"传入数据为空. 确定要清空数据吗?":"你删除了2条以上的时间轴. 确定吗?","警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{t()}).catch(()=>{b({type:"info",message:"操作已取消"})}):t()}e.msg.type==="get"&&z("post",n.$state)}};function q(e){e.detail.inGameCombat&&e.detail.inACTCombat&&p.value===0?_(0):!e.detail.inGameCombat&&!e.detail.inACTCombat&&h()}function G(){C("onLogEvent",I),C("onPlayerChangedEvent",P),C("ChangeZone",F),C("BroadcastMessage",R),C("onInCombatChangedEvent",q),n.loadTimelineSettings(),b({message:`${n.allTimelines.length}条时间轴已就绪`,type:"info",duration:1500,showClose:!0}),S()}return console.log("使用souma时间轴的小朋友们，你们好。我不是雷军。通知一下，现在没有小齿轮了，请用你的浏览器打开：https://souma.diemoe.net/ff14-overlay-vue/#/timelineSettings?OVERLAY_WS=ws://127.0.0.1:10501/ws"),(e,t)=>{const i=ne;return u(),m("div",ie,[a(s).optionalTimeline.length&&a(r)<=-a(n).configValues.preBattle?(u(),m("ul",ae,[(u(!0),m(W,null,Y(a(s).optionalTimeline,(o,c)=>(u(),m("li",{key:c,onClick:d=>D(o)},V(o.name),9,le))),128))])):g("",!0),Q(i,{config:a(n).configValues,lines:a(s).loadedTimeline,runtime:a(r),"show-style":a(n).showStyle},null,8,["config","lines","runtime","show-style"]),a(y)?(u(),m("button",{key:1,onClick:t[0]||(t[0]=o=>_(30))}," 开始从-30 ")):g("",!0),a(y)?(u(),m("button",{key:2,onClick:t[1]||(t[1]=o=>_(0))}," 开始从0 ")):g("",!0),a(y)?(u(),m("button",{key:3,onClick:t[2]||(t[2]=o=>h())}," 团灭 ")):g("",!0),a(y)?(u(),m("button",{key:4,onClick:t[3]||(t[3]=o=>N(1e3))}," 跳转1000测试 ")):g("",!0),a(y)?(u(),m("button",{key:5,onClick:t[4]||(t[4]=o=>$("今天天气真不错",!0))}," TTS测试 ")):g("",!0),a(y)?(u(),m("span",se,V(a(r)),1)):g("",!0)])}}});const ye=oe(ce,[["__scopeId","data-v-6a682bc8"]]);export{ye as default};
