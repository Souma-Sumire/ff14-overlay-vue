import"./index-21d13668.js";/* empty css                */import{t as e,r as t,f as a,P as n,v as r,x as o,D as s,H as i,F as l,u,E as c,A as m,K as f,O as d,L as p}from"./vue-vendor-80a2ed00.js";import{U as v,i as h}from"./util-c5e2dd68.js";import{N as b}from"./netregexes-ed180b06.js";import{a as g,r as w,c as y}from"./overlay_plugin_api-974cdd44.js";import{c as C}from"./index-b29bea73.js";import{r as T}from"./element-plus-22d49fc5.js";import{_ as j}from"./_plugin-vue_export-helper-6a8c15be.js";import"./regexes-da03e94d.js";const P=j(e({__name:"enmity",setup(e){let j=0;const P=t([]),I=t(!1),_=C("hash"),L="1"===_.dev,x=t(!1),k=[h.Paladin,h.Warrior,h.DarkKnight,h.Gunbreaker],D=[2843,3124,743,1833];function E(){return L?Promise.resolve():new Promise(e=>{y({call:"cactbotRequestState"}).then(()=>{I.value=!0,e()}),setTimeout(()=>{I.value||E()},3e3)})}let S,J;const A={countdown:b.countdown(),countdownCancel:b.countdownCancel(),wipe:b.network6d({command:["40000010","4000000F"]}),inCombat:b.inCombat()};async function G(){const e=(await y({call:"getCombatants"})).combatants.filter(e=>P.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===j)?.Job;if(void 0===t)return F(),x.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!k.includes(t))return F(),x.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>D.includes(e.BuffID))),partyCombatState:e}}function N(){F(),S=setInterval(()=>{G().then(({enmityTanks:e})=>{0!==e.length?x.value=!1:x.value=!0}).catch(()=>{x.value=!1})},500)}function F(){J&&clearTimeout(J),S&&clearInterval(S)}function H(e){y({call:"cactbotSay",text:e})}const K=e=>{const t=A.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)N(),J=setTimeout(()=>{G().then(({enmityTanks:e})=>{2===e.length&&H("双T都开盾了"),0===e.length&&H("没人开盾")}).catch(()=>{x.value=!1})},1e3*(Number.parseInt(t)-10));else if(A.countdownCancel.test(e.rawLine))F(),x.value=!1;else if(A.wipe.test(e.rawLine))F(),x.value=!1;else if(A.inCombat.test(e.rawLine)){if("false"===_.stRemind)return;const{inACTCombat:t,inGameCombat:a}=A.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===a&&(N(),J=setTimeout(()=>{G().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>v.isTankJob(v.jobEnumToJob(e.Job))).length&&1===e.length&&e[0].ID!==j&&H("ST开盾")}).catch(()=>{x.value=!1})},2e4))}},R=e=>{P.value=e.party},q=e=>{j=e.charID};return a(()=>{E(),g("LogLine",K),g("PartyChanged",R),g("ChangePrimaryPlayer",q)}),n(()=>{S&&clearInterval(S),J&&clearTimeout(J),w("LogLine",K),w("PartyChanged",R),w("ChangePrimaryPlayer",q)}),(e,t)=>{const a=T;return o(),r(p,null,[u(I)||L?i("",!0):(o(),s(a,{key:0},{default:c(()=>t[0]||(t[0]=[m("h1",null,f("在 ACT 中添加本页面作为数据统计悬浮窗"),-1)])),_:1,__:[0]})),l(m("strong",null,"没人开盾",512),[[d,u(x)]])],64)}}}),[["__scopeId","data-v-37dd023f"]]);export{P as default};
