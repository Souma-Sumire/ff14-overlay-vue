import{_ as e,e as t}from"./shared-common-CqUC5OgC.js";import{h as a,G as n,g as o,a as s,e as i,b as l,c as r,n as c,t as d,f as u,F as m,d as f,y as p,z as g,r as v,x as b,dx as y,w as h,dz as k,s as w,D as j,u as $,b9 as C,o as I,j as R,l as N,p as _,v as D,i as E,bW as T,cO as x,cj as A}from"./vendor-vue-i6lpFrx4.js";import{ac as S,U as M,ad as z,r as K,s as L,ae as F,u as H,w as P,a9 as J,f as O,$ as G,af as W,ag as B,t as Z,ah as U,ai as V,Z as q,l as X,aj as Y,ak as Q,al as ee,A as te,am as ae,a7 as ne}from"./shared-core-Cj7nKZdJ.js";import{t as oe,J as se,b as ie,K as le,aC as re,aD as ce,g as de,a as ue,E as me,aE as fe,aF as pe,n as ge}from"./vendor-element-plus-C8e3lHeC.js";import{N as ve,a as be,l as ye}from"./cactbot-CO6bDcKj.js";const he={class:"amount"},ke={class:"row-info"},we=e(a({__name:"Amount",props:{row:{}},setup(e){const t=e,{amount:a,maxHp:v,currentHp:b,shield:y,source:h,type:k}=t.row,w=Math.round(v*+y/100),j=Math.round(b/v*100),$=t.row.reduction,C=(a&&Math.round((a+w)/(1-$))||0).toLocaleString(),I=n(()=>a>999999?`${(a/1e4).toFixed(0)}ä¸‡`:a.toLocaleString()),R=k,N=S(t.row);return(e,t)=>{const a=oe,n=se;return s(),o(n,{"append-to":".wrapper",trigger:"hover",enterable:!1,"hide-after":0,width:180},{reference:i(()=>[l("span",he,[l("span",{class:g(u(R))},[l("span",{class:g({lethal:u(N)})},d(u(I)),3)],2)])]),default:i(()=>[l("ul",ke,[l("li",null,d(e.$t("keigennRecord.source"))+": "+d(u(h)),1),l("li",null,d(e.$t("keigennRecord.playerShield"))+": "+d(u(y))+"%",1),l("li",null,d(e.$t("keigennRecord.playerHp"))+": "+d(u(j))+"%",1),u($)<1&&"dot"!==u(k)?(s(),r(m,{key:0},[f(a),l("li",null,d(e.$t("keigennRecord.reductionRate"))+": "+d((100*u($)).toFixed(3))+"% ",1),l("li",null,[p(d(e.$t("keigennRecord.originalDamage"))+": ",1),l("span",{class:g(u(R))},d(u(C)),3)])],64)):c("",!0)])]),_:1})}}}),[["__scopeId","data-v-43628410"]]),je={class:"subtitle"},$e={class:"skill-grid"},Ce=["title"],Ie=["src"],Re={class:"skill-text"},Ne={class:"subtitle"},_e={class:"skill-grid"},De=["title"],Ee=["src"],Te={key:2,class:"no-data"},xe=e(a({__name:"KeySkillsCell",props:{row:{}},setup(e){const t=e,a=n(()=>t.row.keySkills?.filter(e=>!e.ready).sort((e,t)=>e.recastLeft-t.recastLeft)??[]),p=n(()=>t.row.keySkills?.filter(e=>e.ready).sort((e,t)=>M.enumSortMethod(e.ownerJob,t.ownerJob))??[]);function b(e){const t=M.jobEnumToJob(e),a=M.jobToFullName(t);return a.en?.toLowerCase()||""}function y(e){const t=M.jobEnumToJob(e);return M.jobToFullName(t).simple2||""}return(e,t)=>{const n=ie,h=oe,k=se;return s(),o(k,{placement:"left",width:"auto",trigger:"hover","popper-class":"skill-popover"},{reference:i(()=>[f(n,{class:"view-icon"},{default:i(()=>[f(u(le))]),_:1})]),default:i(()=>[u(a).length>0?(s(),r(m,{key:0},[l("div",je,d(e.$t("keigennRecord.coolingDown")),1),l("div",$e,[(s(!0),r(m,null,v(u(a),e=>(s(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[l("div",{class:"skill-icon-container",title:`${e.ownerName} (${y(e.ownerJob)})`},[l("img",{src:e.icon,class:"skill-icon"},null,8,Ie),t[0]||(t[0]=l("div",{class:"skill-overlay"},null,-1)),l("span",Re,d(e.recastLeft),1)],8,Ce),l("span",{class:g(["skill-source job",b(e.ownerJob)])},d(y(e.ownerJob)),3)]))),128))])],64)):c("",!0),u(p).length>0?(s(),r(m,{key:1},[u(a).length>0?(s(),o(h,{key:0})):c("",!0),l("div",Ne,d(e.$t("keigennRecord.ready")||"å¯ç”¨"),1),l("div",_e,[(s(!0),r(m,null,v(u(p),e=>(s(),r("div",{key:`${e.id}-${e.ownerId}`,class:"skill-wrapper"},[l("div",{class:"skill-icon-container",title:`${e.ownerName} (${y(e.ownerJob)})`},[l("img",{src:e.icon,class:"skill-icon"},null,8,Ee)],8,De),l("span",{class:g(["skill-source job",b(e.ownerJob)])},d(y(e.ownerJob)),3)]))),128))])],64)):c("",!0),0===u(a).length&&0===u(p).length?(s(),r("div",Te,d(e.$t("keigennRecord.noData")),1)):c("",!0)]),_:1})}}}),[["__scopeId","data-v-a66c0e07"]]),Ae={key:0},Se={key:1,class:"status-container"},Me=["title","data-duration","data-sourcePov"],ze=["src","alt"],Ke={class:"flags"},Le=e(a({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=z(),n=a.userOptions,o=a.icon4k;return(e,a)=>"dot"===t.row.type?(s(),r("div",Ae,d(e.$t("keigennRecord.noSupport")),1)):(s(),r("div",Se,[(s(!0),r(m,null,v(t.row.keigenns,(e,i)=>(s(),r("span",{key:i},[l("span",{class:"status",title:`${u(n).statusCN?e.name:e.effect}(${e.source})`,"data-duration":e.remainingDuration,"data-sourcePov":e.isPov},[l("img",{class:g(`statusIcon ${u(F)(e,t.row.type)}`),src:u(L)(`/i/${e.fullIcon}${u(o)}.png`),alt:e.effect,loading:"lazy",onError:a[0]||(a[0]=(...e)=>u(K)&&u(K)(...e))},null,42,ze)],8,Me)]))),128)),l("span",Ke,d("damage done"===t.row.effect?"":e.$t(`keigennRecord.${t.row.effect}`)),1)]))}}),[["__scopeId","data-v-e479f52a"]]),Fe={class:"target"},He=["src","alt"],Pe={key:1,class:"alt-text"},Je={key:3,class:"has-duplicate"},Oe=e(a({__name:"Target",props:{row:{type:Object,required:!0}},setup(e){const t=e,a=z(),o=b(!1);function i(e){o.value=!0;e.target.style.display="none"}const l=n(()=>!o.value&&"icon"===(a.userOptions.targetType??"icon")),m=n(()=>S(t.row));return(e,n)=>{return s(),r("div",Fe,[u(l)?(s(),r("img",{key:0,class:g(`${u(a).isBrowser?"browser":"act"} jobIcon cj${u(a).userOptions.iconType} ${u(m)?"lethal-icon":""}`),src:(o=t.row.jobIcon,f=u(a).userOptions.iconType,`https://souma.diemoe.net/resources/img/cj${f}/${o.replaceAll(/([A-Z])/g," $1").trim()}.png`),alt:t.row.jobIcon,onError:i},null,42,He)):(s(),r("span",Pe,d(t.row.job),1)),u(m)?(s(),r("span",{key:2,class:g(`lethal-emoji ${u(a).isBrowser?"browser":"act"} emoji-cj${u(a).userOptions.iconType}`)}," ðŸ’€ ",2)):c("",!0),t.row.hasDuplicate?(s(),r("span",Je,d(u(a).formatterName(t.row.target)),1)):c("",!0)]);var o,f}}}),[["__scopeId","data-v-8cdea5a4"]]),Ge=e(a({__name:"Table",props:{rows:{},actionKey:{}},setup(e){const{t:t}=H(),a=e,m=z().userOptions,p=y("contextMenu"),g=b(""),v=b("");h(()=>a.rows,e=>{0===e.length&&(g.value="",v.value="")},{immediate:!0});const $=b(!1),C=b(0),I=b(0),R=b(null);k(p,()=>{$.value=!1});const N=t("keigennRecord.cancelFilter"),_=n(()=>{const e=Array.from(new Set(a.rows.map(e=>e[a.actionKey])));return[{label:N,value:""},...e.map(e=>({label:e,value:e}))]}),D=n(()=>{const e=Array.from(new Map(a.rows.map(e=>[e.target,e])).values());return[{label:N,value:"",job:-1},...e.map(e=>({label:`${e.job}(${e.target})`,value:e.target,job:e.jobEnum}))].sort((e,t)=>M.enumSortMethod(e.job,t.job))});function E(){if(R.value){const e=R.value[a.actionKey];g.value===e?g.value="":g.value=e,$.value=!1}}function T(){if(R.value){const e=R.value.target;v.value===e?v.value="":v.value=e,$.value=!1}}const x=n(()=>a.rows.filter(e=>{const t=!g.value||g.value===N||e[a.actionKey]===g.value,n=!v.value||v.value===N||e.target===v.value;return t&&n}));function A(e){const t=[88,88,88],a=[50,250,200],n=Math.min(1,e/.5),o=Math.min(9,Math.floor(10*n))/9,s=Math.pow(o,.8),i=t[0]+(a[0]-t[0])*s,l=t[1]+(a[1]-t[1])*s,r=t[2]+(a[2]-t[2])*s;return`rgba(${Math.round(i)}, ${Math.round(l)}, ${Math.round(r)}, 1)`}const S=n(()=>[{key:"time",title:t("keigennRecord.time"),dataKey:"time",width:40,align:"center",class:"col-time",headerCellRenderer:()=>j("div",{class:"header-time"},t("keigennRecord.time"))},{key:"action",title:t("keigennRecord.action"),dataKey:a.actionKey,width:64,align:"center",class:"col-action",headerCellRenderer:()=>j("div",{class:"header-filter"},[j(ue,{size:"small",modelValue:g.value,placeholder:t("keigennRecord.action"),clearable:!1,style:"width:4.5em",teleported:!1,onChange:e=>g.value=e===N?"":e},()=>_.value.map(e=>j(me,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>j("span",e[a.actionKey]??"")},{key:"target",title:t("keigennRecord.target"),dataKey:"target",width:34,align:"center",class:"col-target",headerCellRenderer:()=>j("div",{class:"header-filter"},[j(ue,{size:"small",modelValue:v.value,placeholder:t("keigennRecord.target"),clearable:!1,style:"width:4.7em;text-overflow:clip;white-space:nowrap",class:"col-target-select",teleported:!1,onChange:e=>{v.value=e===N?"":e}},()=>D.value.map(e=>j(me,{key:e.value,label:e.label,value:e.value})))]),cellRenderer:({rowData:e})=>j(Oe,{row:e})},{key:"amount",title:t("keigennRecord.amount"),dataKey:"amount",width:52,align:"right",class:"col-amount",cellRenderer:({rowData:e})=>j(we,{row:e})},{key:"reduction",title:t("keigennRecord.reduction"),dataKey:"reduction",width:35,align:"right",class:"col-reduction",headerCellRenderer:()=>j("div",{class:"header-reduction"},t("keigennRecord.reduction")),cellRenderer:({rowData:e})=>j("span",{class:"col-reduction-number",style:{color:A(e.reduction)}},`${(100*e.reduction).toFixed(0)}`)},{key:"keigenns",title:t("keigennRecord.keigenns"),dataKey:"keigenns",flexGrow:1,width:200,align:"left",class:"col-keigenns",cellRenderer:({rowData:e})=>j(Le,{row:e})},{key:"skills",title:"",dataKey:"skills",width:0,align:"center",class:"col-skills",cellRenderer:({rowData:e})=>j("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"visible",display:"flex",alignItems:"center",justifyContent:"flex-end"}},j("div",{style:{position:"absolute",right:"8px",zIndex:5}},j(xe,{row:e})))}]);let K=null;const L=n(()=>({onClick:({rowData:e})=>{const{actionCN:a,amount:n,job:o,keigenns:s,time:i,type:l,effect:r,currentHp:c,maxHp:d,shield:u,reduction:f}=e,p="damage done"===r?"":`,${t(`keigennRecord.${r}`)}`,g=`${i} ${o} ${a} ${n.toLocaleString()}(${t(`keigennRecord.${l}`)}) ${t("keigennRecord.reduction")}(${(100*f).toFixed(0)}%):${0===s.length&&""===p?t("keigennRecord.none"):s.map(e=>m.statusCN?e.name:e.effect).join(",")+p} ${t("keigennRecord.hp")}}:${c}(${Math.round(c/d*100)}%)+${t("keigennRecord.shield")}:${Math.round(d*+u/100)}(${u}%)`;P(g).then(()=>{K?.close(),K=de.success({message:t("keigennRecord.copySuccess"),duration:800})}).catch(()=>de.error(t("keigennRecord.copyFailed")))},onContextmenu:({rowData:e,event:t})=>{const a=t;R.value=e,C.value=a.clientX,I.value=a.clientY,$.value=!0}}));return(a,n)=>{const m=ce,b=re;return s(),o(b,{style:{height:"100%",width:"100%"}},{default:i(({height:a,width:n})=>[f(m,{"header-class":"keigenn-table-header",class:"keigenn-table",columns:S.value,data:x.value,width:n,height:a,"row-height":28,"header-height":24,"row-key":"key","scrollbar-always-on":"","row-event-handlers":L.value},null,8,["columns","data","width","height","row-event-handlers"]),u($)?(s(),r("div",{key:0,ref_key:"contextMenu",ref:p,class:"context-menu",style:w({top:`${u(I)}px`,left:`${u(C)}px`})},[l("ul",null,[l("li",{onClick:E},d(u(g)===(u(R)?.[e.actionKey]??"")?u(t)("keigennRecord.filter.action_cancel",{actionName:u(R)?.[e.actionKey]??u(t)("keigennRecord.this_skill")}):u(t)("keigennRecord.filter.action_only",{actionName:u(R)?.[e.actionKey]??u(t)("keigennRecord.this_skill")})),1),l("li",{onClick:T},d(u(v)===u(R)?.target?u(t)("keigennRecord.filter.target_cancel",{jobName:u(R)?.job??u(t)("keigennRecord.this_job")}):u(t)("keigennRecord.filter.target_only",{jobName:u(R)?.job??u(t)("keigennRecord.this_job")})),1)])],4)):c("",!0)]),_:1})}}}),[["__scopeId","data-v-4dfd4486"]]),We={class:"header-select"},Be={style:{height:"100%"}},Ze={key:0,class:"testLog"},Ue=e(a({__name:"keigennRecord2",setup(e){const a=O();H();const d=z(),y=d.userOptions;d.checkIsBrowser();const h=b(y.minimize),k=n(()=>y.actionCN?"actionCN":"action"),j=b(!1),S=$("keigenn-record-2-pov-id",""),K=$("keigenn-record-2-party-list",[]),L=$("keigenn-record-2-job-map",{}),F=$("keigenn-record-2-party-event-party",[]),P=b(0),oe=b([{zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}]),se={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:ve.ability(),statusEffectExplicit:ve.statusEffectExplicit(),gainsEffect:ve.gainsEffect(),losesEffect:ve.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:ve.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:ve.addedCombatant(),removingCombatant:ve.removingCombatant(),networkDoT:ve.networkDoT()},ie=b(0),le=$("souma-keigenn-record-2-zone-name",""),re=$("souma-keigenn-record-2-rsv-data",{}),ce={},de={friendly:{},enemy:{}},he=J.filter(e=>1===e.line||2===e.line);let ke={};const we=G("keigenn-record-2");function je(){j.value=!0,ie.value=0,ke={},P.value=0,oe.value.length=0,oe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1})}function $e(){j.value=!1,De()}function Ce(e){for(const t in se){const a=se[t].exec(e);if(a){const n=e.split("|");switch(t){case"statusEffectExplicit":a.groups?.targetId.startsWith("1")&&(ce[a.groups.targetId]=a.groups.currentShield);break;case"gainsEffect":{const e=n[ye.GainsEffect.fields.effectId],t=n[ye.GainsEffect.fields.effect],a=n[ye.GainsEffect.fields.target],o=n[ye.GainsEffect.fields.targetId],s=Number.parseInt(n[ye.GainsEffect.fields.count],16);let i=Y(e);if(!i){const t=o.startsWith("1")&&Q.get(Number.parseInt(e,16).toString())||o.startsWith("4")&&ee.get(Number.parseInt(e,16).toString());if(!t)return;const a=te(t.icon),n=s>1?ae(a,s):a;i={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(e,16),fullIcon:n,name:t.name,isFriendly:t.isFriendly}}const l=n[ye.GainsEffect.fields.duration],r=n[ye.GainsEffect.fields.source],c=n[ye.GainsEffect.fields.sourceId],d=new Date(n[ye.GainsEffect.fields.timestamp]).getTime()+1e3*Number.parseFloat(l),u={name:i.name,type:i.type,count:s,effect:t,effectId:e,source:r,sourceId:c,target:a,targetId:o,expirationTimestamp:d,performance:i.performance,fullIcon:i.fullIcon,isPov:S.value===c};o.startsWith("1")&&i.isFriendly?(void 0===de.friendly[o]&&(de.friendly[o]={}),de.friendly[o][e]=u):o.startsWith("4")&&!i.isFriendly&&(void 0===de.enemy[a]&&(de.enemy[a]={}),de.enemy[a][e]=u)}break;case"losesEffect":{const e=n[ye.LosesEffect.fields.target],t=n[ye.LosesEffect.fields.targetId],a=n[ye.LosesEffect.fields.effectId];t.startsWith("1")?de.friendly[t]&&Reflect.deleteProperty(de.friendly[t],a):de.enemy[e]&&Reflect.deleteProperty(de.enemy[e],a)}break;case"addCombatant":if("00"!==n[ye.AddedCombatant.fields.job]){const e=n[ye.AddedCombatant.fields.job],t=n[ye.AddedCombatant.fields.name],a=new Date(n[ye.AddedCombatant.fields.timestamp]).getTime();L.value[n[ye.AddedCombatant.fields.id]]={job:Number.parseInt(e,16),timestamp:a,name:t}}break;case"removingCombatant":Reflect.deleteProperty(L.value,n[ye.RemovedCombatant.fields.id]);break;case"primaryPlayer":S.value=n[ye.ChangedPlayer.fields.id];break;case"partyList":K.value=(a.groups?.list?.split("|")??[]).filter(Boolean);break;case"changeZone":{const e=parseInt(n[ye.ChangeZone.fields.id],16);if(le.value=n[ye.ChangeZone.fields.name],q[e]?.name){const t=X(q[e]?.name);t&&"Unknown"!==t&&(le.value=t)}Ne(new Date(n[ye.ChangeZone.fields.timestamp]).getTime());break}case"inCombat":{const e="1"===n[ye.InCombat.fields.inACTCombat],t="1"===n[ye.InCombat.fields.inGameCombat],a=new Date(n[ye.InCombat.fields.timestamp]).getTime();if(e||t){const e=n[ye.InCombat.fields.timestamp];if(ie.value>0)return;return 0!==oe.value[0].table.length&&oe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:e,timestamp:a}),ie.value=a,oe.value[0].zoneName=le.value,oe.value[0].timestamp=a,oe.value[0].key=e,void(P.value=0)}if(!e&&!t)return void Ne(a)}break;case"rsv":{const e=Number(a.groups?.id),t=n[ye.RSVData.fields.value];e&&t&&(re.value[Number(e)]=t)}break;case"networkDoT":if(!y.parseDoT)return;{const e=n[ye.NetworkDoT.fields.which],t=n[ye.NetworkDoT.fields.id];if("DoT"!==e||t.startsWith("4")||t!==S.value&&!K.value.includes(t)&&!F.value.find(e=>e.id===t))return;const a=n[ye.NetworkDoT.fields.name],o=n[ye.NetworkDoT.fields.damage],s=Number.parseInt(o,16),i=new Date(n[ye.Ability.fields.timestamp]??"???").getTime(),l=Number(n[ye.NetworkDoT.fields.currentHp]),r=Number(n[ye.NetworkDoT.fields.maxHp]),c=Ee(0===ie.value?0:i-ie.value),{job:d,hasDuplicate:u}=Ie(t),m=M.jobToFullName(M.jobEnumToJob(d)).simple2,f=d,p=M.jobEnumToIcon(f);Re({key:oe.value[0].table.length.toString(),time:c,id:void 0,action:e,actionCN:e,source:"",target:a,targetId:t,job:m,jobIcon:p,jobEnum:f,hasDuplicate:u,amount:s,keigenns:[],currentHp:l,maxHp:r,effect:"damage done",type:"dot",shield:ce[t]??"0",povId:S.value,reduction:0,keySkills:[]})}break;case"ability":if(0===ie.value)return;{const e=n[ye.Ability.fields.sourceId]??"???",t=n[ye.Ability.fields.id]??"???",o=new Date(n[ye.Ability.fields.timestamp]??"???").getTime();if(e.startsWith("1")){const a=Number.parseInt(t,16);he.find(e=>W(e.id,999)===a)&&(ke[e]||(ke[e]={}),ke[e][a]=o)}const s=B(n);if(s.isAttack&&s.amount>=0){const o=n[ye.Ability.fields.targetId]??"???";if(!e.startsWith("4")||!o.startsWith("1"))return;if(o!==S.value&&!K.value.includes(o)&&!F.value.find(e=>e.id===o))return;const i=new Date(n[ye.Ability.fields.timestamp]??"???").getTime(),l=n[ye.Ability.fields.ability],r=l.match(/^_rsv_(?<id>\d+)_/);let c=l;if(r){const e=Number(r.groups?.id);c=re.value[e]??l.match(/^_(?<id>rsv_\d+)_/)?.groups?.id}else if(c=c.replace(/unknown_.*/,"æ”»å‡»"),!1===y.parseAA&&/^æ”»å‡»|æ”»æ’ƒ|[Aa]ttack$/.test(c))return;const d=Z(Number.parseInt(t,16)),u=d&&""!==d?d:c,m=Number(n[ye.Ability.fields.targetCurrentHp]),f=Number(n[ye.Ability.fields.targetMaxHp]),p=n[ye.Ability.fields.source]??"???",g=n[ye.Ability.fields.target]??"???",{effect:v,type:b}=U(s.flags),h=Ee(0===ie.value?0:i-ie.value),{job:k,hasDuplicate:w}=Ie(o),j=M.jobToFullName(M.jobEnumToJob(k)).simple2,$=k,C=M.jobEnumToIcon($),I=V(Object.values(de.friendly[o]??[]).concat(Object.values(de.enemy[p]??[])).filter(e=>{const t=Math.max(0,(e.expirationTimestamp-i)/1e3);return e.remainingDuration=t>=999?"":t.toFixed(t>.05&&t<.95?1:0),Number(e.remainingDuration)>-3})),R=ce[a.groups.targetId]??"0",N=s.amount;let _=0;if("instant death"!==v&&"dodge"!==v){let e=1;"blocked damage"===v?e=.8:"parried damage"===v&&(e=.85);let t=1;for(const a of I)"absorbed"!==a.type&&(t*=a.performance[b]??1);_=1-t*e}Re({key:oe.value[0].table.length.toString(),time:h,id:t,action:c,actionCN:u,source:p,target:g,targetId:o,job:j,jobIcon:C,jobEnum:$,hasDuplicate:w,amount:N,keigenns:I,currentHp:m,maxHp:f,effect:v,type:b,shield:R,povId:S.value,reduction:_,keySkills:_e(i)}),oe.value[0].duration=Ee(new Date(n[ye.Ability.fields.timestamp]).getTime()-ie.value)}}}}}}function Ie(e){const t=L.value[e],a=F.value.find(t=>t.id===e)??{job:0,timestamp:0},n=(t?.timestamp??0)>a.timestamp?t:a,o=n===t?Object.entries(L.value).some(([t,a])=>t!==e&&a.job===n?.job&&K.value.includes(t)):F.value.some(t=>t.id!==e&&t.job===n?.job);return{job:n?.job??0,hasDuplicate:o}}function Re(e){oe.value[0].table.unshift(e)}function Ne(e){0!==ie.value&&(oe.value[0].duration=Ee(e-ie.value),oe.value[0]=x(oe.value[0]),ie.value=0,de.friendly={},de.enemy={},ke={},De())}function _e(e){const t=[],a=new Set;F.value.forEach(e=>a.add(e.id)),K.value.forEach(e=>a.add(e)),Object.keys(ke).forEach(e=>a.add(e)),S.value&&a.add(S.value);const n=[];for(const s of a){const e=F.value.find(e=>e.id===s);if(e){n.push({id:e.id,job:e.job,name:e.name,level:e.level});continue}const t=L.value[s];t&&n.push({id:s,job:t.job,name:t.name??"Unknown",level:999})}const o=new Map;n.forEach(e=>{o.set(e.job,(o.get(e.job)||0)+1)});for(const s of n){const a=s.level||999,n=(o.get(s.job)||0)>1;for(const o of he)if(o.job.includes(s.job)&&o.minLevel<=a){const i=W(o.id,a),l=W(o.recast1000ms,a),r=ke[s.id]?.[i]??0;let c=!0,d=0;if(r>0){const t=e-r,a=1e3*l;t<a&&(c=!1,d=Math.ceil((a-t)/1e3))}t.push({id:i,name:Z(i)||"Unknown",icon:ne(i),recast1000ms:l,recastLeft:d,ready:c,ownerId:s.id,ownerName:s.name,ownerJob:s.job,hasDuplicate:n})}}return t}async function De(){if(j.value)return;const e=oe.value.filter(e=>"init"!==e.key&&e.timestamp>0).map(e=>{const t=Array.isArray(e.table)?A(e.table):[];return{...A(e),table:t}});await we.replaceAll(e)}function Ee(e){const t=Math.max(Math.floor(e/6e4),0),a=Math.max(Math.floor((e-6e4*t)/1e3),0);return`${t<10?"0":""}${t}:${a<10?"0":""}${a}`}function Te(){h.value=!h.value}function xe(){oe.value.unshift({zoneName:"",duration:"00:00",table:C([]),key:"test",timestamp:Date.now()}),P.value=0}function Ae(e){const t=new Date(e),a=t.getHours();return`${(a%12||12).toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")} ${a>=12?"PM":"AM"}`}return I(()=>{const e=R({storageKey:"keigenn-record-2-theme"}),t=N(e);!1===e.value&&t();for(const a in L.value){const e=L.value[a];Date.now()-e.timestamp>864e5&&Reflect.deleteProperty(L.value,a)}!async function(){P.value=0;try{const e=await we.getAll();e.length&&(oe.value.length=0,oe.value.push(...e.filter(e=>e.timestamp>Date.now()-2592e5).reverse()),0===oe.value.length&&oe.value.push({zoneName:"",duration:"00:00",table:C([]),key:"init",timestamp:-1}))}catch(e){throw oe.value.length=0,e}}(),be("LogLine",e=>{Ce(e.rawLine)}),be("PartyChanged",e=>{F.value=e.party.map(e=>({...e,timestamp:Date.now()}))}),be("ChangePrimaryPlayer",e=>{S.value=Number(e.charID).toString(16).toUpperCase()})}),(e,n)=>{const b=me,j=ue,$=ge,C=Ge,I=t;return s(),r(m,null,[l("div",{class:"wrapper",style:w({"--scale":u(y).scale,"--opacity":u(y).opacity}),onContextmenu:n[1]||(n[1]=T(()=>{},["prevent"]))},[l("header",null,[l("div",We,[_(f(j,{modelValue:u(P),"onUpdate:modelValue":n[0]||(n[0]=e=>E(P)?P.value=e:null),size:"small",class:g(["combat-select",u(d).isBrowser?"browser":"act"]),"popup-class-name":"combat-select-popup",offset:0,"show-arrow":!1},{default:i(()=>[(s(!0),r(m,null,v(u(oe).length,e=>(s(),o(b,{key:`${u(oe)[e-1].key}-${u(oe)[e-1].duration}-${u(oe)[e-1].zoneName}`,value:e-1,label:`${u(oe)[e-1].zoneName}${""===u(oe)[e-1].zoneName?"":` - [${u(oe)[e-1].duration}] ${Ae(u(oe)[e-1].timestamp)}`}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue","class"]),[[D,!u(h)]])]),u(d).isBrowser?c("",!0):(s(),o($,{key:0,class:g(["minimize",u(h)?"in-minimize":"not-minimize"]),icon:u(h)?u(fe):u(pe),circle:"",style:w({opacity:u(h)?.5:1}),onClick:Te},null,8,["class","icon","style"]))]),_(l("main",Be,[f(C,{rows:u(oe)[u(P)].table,"action-key":u(k)},null,8,["rows","action-key"])],512),[[D,!u(h)]])],36),u(d).isBrowser||u(a)?(s(),r("div",Ze,[u(a)?(s(),o($,{key:0,onClick:xe},{default:i(()=>[...n[2]||(n[2]=[p(" æµ‹è¯• ",-1)])]),_:1})):c("",!0),f(I,{"m-1":"",onBeforeHandle:je,onAfterHandle:$e,onHandleLine:Ce})])):c("",!0)],64)}}}),[["__scopeId","data-v-a098bda5"]]);export{Ue as default};
