import{_ as e}from"./ActWrapper-7141acc0.js";import{u as t,p as o,_ as i}from"./TimelineShow-f961b5ff.js";import"./index-a135a9d0.js";import{b as l,I as n,y as a}from"./element-plus-3b00acc6.js";import{u as s}from"./useDevMode-55881ae6.js";import{c,a as m}from"./overlay_plugin_api-974cdd44.js";import{u}from"./index-9c6472dd.js";import{t as r,V as d,r as p,c as f,e as y,D as g,E as v,x as b,A as T,v as h,H as j,M as k,u as x,L as C,aa as w,G as A,J as _,K as S}from"./vue-vendor-37eb8ba2.js";import{_ as O}from"./_plugin-vue_export-helper-6a8c15be.js";/* empty css                */import"./regexes-da03e94d.js";import"./util-c5e2dd68.js";import"./status-9bc9036c.js";import"./xivapi-72ab0990.js";const I={id:"wrapper"},V={key:0,class:"optionalTimelines"},E=["onClick"],B={key:7,style:{color:"white","background-color":"black"}},D=O(r({__name:"timeline",setup(r){const O=t(),D=d({loadedTimeline:[],optionalTimeline:[],selectedOptionalTimeline:null}),L=p(0),G=p(0-O.configValues.preBattle),M=p(0);let N=!1;const $=u("timeline-condition-2",{zoneId:"0",jobs:["NONE"]}),z=s(),F=f(()=>D.loadedTimeline.filter(e=>e.sync)),H=f(()=>D.loadedTimeline.filter(e=>e.tts));function P(){J(),D.loadedTimeline.length=0,D.optionalTimeline.length=0;const e=O.getTimeline($.value);1===e.length?q(e[0]):e.length>1&&(D.optionalTimeline=e,q(e[0]))}async function q(e,t=!0){D.selectedOptionalTimeline=e,t&&J(),N=!1,e?.timeline&&(D.loadedTimeline=await o(e.timeline),D.loadedTimeline.sort((e,t)=>e.time-t.time)),setTimeout(()=>{N=!0},1e3)}function J(){L.value=0,G.value=0-O.configValues.preBattle,M.value=0;for(const e of D.loadedTimeline)e.alertAlready=!1;for(const e of F.value)e.syncAlready=!1}function K(e,t=!0){t&&(N=!1,setTimeout(()=>{N=!0},1e3)),G.value=0,M.value=0,L.value=(new Date).getTime()+1e3*e,H.value.forEach(e=>{e.alertAlready=!1}),R()}function R(){if(0===L.value)return;G.value=((new Date).getTime()-L.value+M.value)/1e3;const e=H.value.find(e=>!e.alertAlready&&e.time-O.configValues.ttsAdvance<=G.value);e&&(e.alertAlready=!0,e.tts&&X(e.tts)),requestAnimationFrame(R)}function W(e){for(const t of e.detail.logs){const e=t.match(/^.{14} \w+ 00:(?:00b9|0[12]39)::?(?:距离战斗开始还有|Battle commencing in |戦闘開始まで)(?<cd>\d+)[^（(\d]+[（(]/i);if(e)K(Number.parseInt(e?.groups?.cd||"0"));else if(/^.{14} Director 21:.{8}:4000000F/.test(t)||/^.{14} ChatLog 00:0038::end$/.test(t))J();else{const e=F.value.find(e=>e.sync&&(e.syncOnce&&!e.syncAlready||!e.syncOnce)&&G.value>=e.time-e.windowBefore&&G.value<=e.time+Number(e.windowAfter)&&e.sync.test(t));e&&(e.syncAlready=!0,Z(e.jump||e.time))}}}function Z(e){0===L.value&&K(0,!1),M.value+=1e3*(e-G.value),H.value.forEach(t=>{t.time<e&&(t.alertAlready=!0)})}y(()=>{m("onLogEvent",W),m("onPlayerChangedEvent",Q),m("ChangeZone",U),m("BroadcastMessage",te),m("onInCombatChangedEvent",oe),O.loadTimelineSettings(),l({message:`${O.allTimelines.length}条时间轴已就绪`,type:"info",duration:1e3,showClose:!1}),P(),ee("hello")});const Q=e=>{$.value.jobs[0]!==e.detail.job&&($.value.jobs[0]=e.detail.job,P())},U=e=>{$.value.zoneId=String(e.zoneID),P()};function X(e,t=!1){e&&(N||t)&&c({call:"cactbotSay",text:e})}function Y(){l.closeAll(),l({message:"弹窗测试",type:"success",duration:0,showClose:!0})}function ee(e,t={}){c({call:"broadcast",source:"soumaTimeline",msg:{type:e,data:t}})}const te=e=>{if("soumaTimelineSettings"===e.source){if("post"===e.msg.type){const t=e.msg.data;for(const e of t.allTimelines)void 0===e.condition.jobs&&(e.condition.jobs=[e.condition.job]),e.condition.jobs.sort((e,t)=>O.jobList.indexOf(e)-O.jobList.indexOf(t)),Reflect.deleteProperty(e.condition,"job");O.allTimelines=t.allTimelines,O.configValues=t.configValues,O.showStyle=t.showStyle,O.saveTimelineSettings(),l.closeAll(),l({message:"已更新数据",type:"success",duration:3e3,showClose:!1}),P(),ee("success")}"get"===e.msg.type&&ee("post",O.$state)}};function oe(e){e.detail.inGameCombat&&e.detail.inACTCombat&&0===L.value?K(0):e.detail.inGameCombat||e.detail.inACTCombat||J()}return(t,o)=>{const l=n,s=i,c=e;return b(),g(c,null,{default:v(()=>[T("div",I,[x(D).optionalTimeline.length&&x(G)<=-x(O).configValues.preBattle?(b(),h("ul",V,[o[5]||(o[5]=T("span",{style:{color:"white","text-shadow":"1px 1px 1px black, -1px -1px 1px black, 1px -1px 1px black, -1px 1px 1px black"}},"选择一个时间轴",-1)),(b(!0),h(C,null,w(x(D).optionalTimeline,(e,t)=>(b(),h("li",{key:t,class:A(x(D).selectedOptionalTimeline===e?"active":""),onClick:t=>{q(e)}},[_(S(e.name)+" ",1),x(D).selectedOptionalTimeline===e?(b(),g(l,{key:0},{default:v(()=>[k(x(a))]),_:1})):j("",!0)],10,E))),128))])):j("",!0),k(s,{config:x(O).configValues,lines:x(D).loadedTimeline,runtime:x(G),"show-style":x(O).showStyle},null,8,["config","lines","runtime","show-style"]),x(z)?(b(),h("button",{key:1,onClick:o[0]||(o[0]=e=>K(30))}," 开始从-30 ")):j("",!0),x(z)?(b(),h("button",{key:2,onClick:o[1]||(o[1]=e=>K(0))}," 开始从0 ")):j("",!0),x(z)?(b(),h("button",{key:3,onClick:o[2]||(o[2]=e=>J())}," 团灭 ")):j("",!0),x(z)?(b(),h("button",{key:4,onClick:o[3]||(o[3]=e=>{Z(1e3)})}," 跳转1000测试 ")):j("",!0),x(z)?(b(),h("button",{key:5,onClick:o[4]||(o[4]=e=>X("今天天气真不错",!0))}," TTS测试 ")):j("",!0),x(z)?(b(),h("button",{key:6,onClick:Y}," 弹窗测试 ")):j("",!0),x(z)?(b(),h("span",B,S(x(G)),1)):j("",!0)])]),_:1})}}}),[["__scopeId","data-v-28410a74"]]);export{D as default};
