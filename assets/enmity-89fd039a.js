import"./index-ee1b8a05.js";/* empty css                */import{t as e,r as t,f as a,P as n,v as r,x as o,D as s,H as i,F as l,u,E as c,A as m,K as f,O as d,L as p}from"./vue-vendor-db4de8ea.js";import{U as v,i as h}from"./util-c5e2dd68.js";import{N as b}from"./netregexes-ed180b06.js";import{a as g,r as w,c as y}from"./overlay_plugin_api-974cdd44.js";import{c as C}from"./index-de57c9c1.js";import{r as T}from"./element-plus-ad97716d.js";import{_ as j}from"./_plugin-vue_export-helper-6a8c15be.js";import"./regexes-da03e94d.js";const P=j(e({__name:"enmity",setup(e){let j=0;const P=t([]),_=t(!1),I=C("hash"),x="1"===I.dev,L=t(!1),k=[h.Paladin,h.Warrior,h.DarkKnight,h.Gunbreaker],D=[2843,3124,743,1833];function E(){return x?Promise.resolve():new Promise(e=>{y({call:"cactbotRequestState"}).then(()=>{_.value=!0,e()}),setTimeout(()=>{_.value||E()},3e3)})}let S,J;const A={countdown:b.countdown(),countdownCancel:b.countdownCancel(),wipe:b.network6d({command:["40000010","4000000F"]}),inCombat:b.inCombat()};async function F(){const e=(await y({call:"getCombatants"})).combatants.filter(e=>P.value.some(t=>Number.parseInt(t.id,16)===e.ID&&t.inParty)),t=e.find(e=>e.ID===j)?.Job;if(void 0===t)return K(),L.value=!1,Promise.reject(new Error("未找到玩家职业"));if(!k.includes(t))return K(),L.value=!1,Promise.reject(new Error("玩家不是坦克职业"));return{enmityTanks:e.filter(e=>e.Effects.some(e=>D.includes(e.BuffID))),partyCombatState:e}}function G(){K(),S=setInterval(()=>{F().then(({enmityTanks:e})=>{0!==e.length?L.value=!1:L.value=!0}).catch(()=>{L.value=!1})},500)}function K(){J&&clearTimeout(J),S&&clearInterval(S)}function N(e){y({call:"cactbotSay",text:e})}const H=e=>{const t=A.countdown.exec(e.rawLine)?.groups?.countdownTime;if(void 0!==t)G(),J=setTimeout(()=>{F().then(({enmityTanks:e})=>{2===e.length&&N("双T都开盾了"),0===e.length&&N("没人开盾")}).catch(()=>{L.value=!1})},1e3*(Number.parseInt(t)-10));else if(A.countdownCancel.test(e.rawLine))K(),L.value=!1;else if(A.wipe.test(e.rawLine))K(),L.value=!1;else if(A.inCombat.test(e.rawLine)){if("false"===I.stRemind)return;const{inACTCombat:t,inGameCombat:a}=A.inCombat.exec(e.rawLine).groups||{};"1"===t&&"1"===a&&(G(),J=setTimeout(()=>{F().then(({enmityTanks:e,partyCombatState:t})=>{2===t.filter(e=>v.isTankJob(v.jobEnumToJob(e.Job))).length&&1===e.length&&e[0].ID!==j&&N("ST开盾")}).catch(()=>{L.value=!1})},2e4))}},R=e=>{P.value=e.party},q=e=>{j=e.charID};return a(()=>{E(),g("LogLine",H),g("PartyChanged",R),g("ChangePrimaryPlayer",q)}),n(()=>{S&&clearInterval(S),J&&clearTimeout(J),w("LogLine",H),w("PartyChanged",R),w("ChangePrimaryPlayer",q)}),(e,t)=>{const a=T;return o(),r(p,null,[u(_)||x?i("",!0):(o(),s(a,{key:0},{default:c(()=>t[0]||(t[0]=[m("h1",null,f("在 ACT 中添加本页面作为数据统计悬浮窗"),-1)])),_:1,__:[0]})),l(m("strong",null,"没人开盾",512),[[d,u(L)]])],64)}}}),[["__scopeId","data-v-37dd023f"]]);export{P as default};
